<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>src API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>


            <h2>Contents</h2>
            <ul>
  <li><a href="#ψπ-psipy-symbolic-numerical-toolkit-for-pdes-and-hamiltonian-mechanics">Ψπ (psipy): Symbolic-Numerical Toolkit for PDEs and Hamiltonian Mechanics</a>
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#core-components">Core Components</a></li>
    <li><a href="#typical-workflow">Typical Workflow</a></li>
    <li><a href="#example-solving-a-pseudo-differential-pde">Example: Solving a Pseudo-Differential PDE</a></li>
  </ul></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#PseudoDifferentialOperator">PseudoDifferentialOperator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.__init__">PseudoDifferentialOperator</a>
                        </li>
                        <li>
                                <a class="variable" href="#PseudoDifferentialOperator.dim">dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#PseudoDifferentialOperator.mode">mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#PseudoDifferentialOperator.symbol_cached">symbol_cached</a>
                        </li>
                        <li>
                                <a class="variable" href="#PseudoDifferentialOperator.expr">expr</a>
                        </li>
                        <li>
                                <a class="variable" href="#PseudoDifferentialOperator.vars_x">vars_x</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.evaluate">evaluate</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.clear_cache">clear_cache</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.apply">apply</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.principal_symbol">principal_symbol</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.is_homogeneous">is_homogeneous</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.symbol_order">symbol_order</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.asymptotic_expansion">asymptotic_expansion</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.compose_asymptotic">compose_asymptotic</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.commutator_symbolic">commutator_symbolic</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.right_inverse_asymptotic">right_inverse_asymptotic</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.left_inverse_asymptotic">left_inverse_asymptotic</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.formal_adjoint">formal_adjoint</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.exponential_symbol">exponential_symbol</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.trace_formula">trace_formula</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.pseudospectrum_analysis">pseudospectrum_analysis</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.symplectic_flow">symplectic_flow</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.is_elliptic_numerically">is_elliptic_numerically</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.is_self_adjoint">is_self_adjoint</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.visualize_fiber">visualize_fiber</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.visualize_symbol_amplitude">visualize_symbol_amplitude</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.visualize_phase">visualize_phase</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.visualize_characteristic_set">visualize_characteristic_set</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.visualize_characteristic_gradient">visualize_characteristic_gradient</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.plot_hamiltonian_flow">plot_hamiltonian_flow</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.plot_symplectic_vector_field">plot_symplectic_vector_field</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.visualize_micro_support">visualize_micro_support</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.group_velocity_field">group_velocity_field</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.animate_singularity">animate_singularity</a>
                        </li>
                        <li>
                                <a class="function" href="#PseudoDifferentialOperator.interactive_symbol_analysis">interactive_symbol_analysis</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PDESolver">PDESolver</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PDESolver.__init__">PDESolver</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.time_scheme">time_scheme</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.dealiasing_ratio">dealiasing_ratio</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.is_stationary">is_stationary</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.u">u</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.u_eq">u_eq</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.dim">dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.linear_terms">linear_terms</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.nonlinear_terms">nonlinear_terms</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.symbol_terms">symbol_terms</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.source_terms">source_terms</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.pseudo_terms">pseudo_terms</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.temporal_order">temporal_order</a>
                        </li>
                        <li>
                                <a class="variable" href="#PDESolver.has_psi">has_psi</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.setup">setup</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.solve">solve</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.solve_stationary_psiOp">solve_stationary_psiOp</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.plot_energy">plot_energy</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.show_stationary_solution">show_stationary_solution</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.animate">animate</a>
                        </li>
                        <li>
                                <a class="function" href="#PDESolver.test">test</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LagrangianHamiltonianConverter">LagrangianHamiltonianConverter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LagrangianHamiltonianConverter.L_to_H">L_to_H</a>
                        </li>
                        <li>
                                <a class="function" href="#LagrangianHamiltonianConverter.H_to_L">H_to_L</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HamiltonianSymbolicConverter">HamiltonianSymbolicConverter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HamiltonianSymbolicConverter.decompose_hamiltonian">decompose_hamiltonian</a>
                        </li>
                        <li>
                                <a class="function" href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde">hamiltonian_to_symbolic_pde</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SymbolGeometry">SymbolGeometry</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SymbolGeometry.__init__">SymbolGeometry</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry.H">H</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry.x_sym">x_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry.xi_sym">xi_sym</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry.compute_geodesic">compute_geodesic</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry.find_periodic_orbits">find_periodic_orbits</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry.gutzwiller_trace_formula">gutzwiller_trace_formula</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry.semiclassical_spectrum">semiclassical_spectrum</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SymbolVisualizer">SymbolVisualizer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SymbolVisualizer.__init__">SymbolVisualizer</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolVisualizer.geo">geo</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolVisualizer.visualize_complete">visualize_complete</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SpectralAnalysis">SpectralAnalysis</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SpectralAnalysis.weyl_law">weyl_law</a>
                        </li>
                        <li>
                                <a class="function" href="#SpectralAnalysis.analyze_integrability">analyze_integrability</a>
                        </li>
                        <li>
                                <a class="function" href="#SpectralAnalysis.berry_tabor_formula">berry_tabor_formula</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SymbolGeometry2D">SymbolGeometry2D</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SymbolGeometry2D.__init__">SymbolGeometry2D</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.H_sym">H_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.x_sym">x_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.y_sym">y_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.xi_sym">xi_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.eta_sym">eta_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.hbar">hbar</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.dH_dx_sym">dH_dx_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.dH_dy_sym">dH_dy_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.dH_dxi_sym">dH_dxi_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.dH_deta_sym">dH_deta_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dx2_sym">d2H_dx2_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dy2_sym">d2H_dy2_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dxi2_sym">d2H_dxi2_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_deta2_sym">d2H_deta2_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dxdy_sym">d2H_dxdy_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dxdxi_sym">d2H_dxdxi_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dxdeta_sym">d2H_dxdeta_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dydxi_sym">d2H_dydxi_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dyeta_sym">d2H_dyeta_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.d2H_dxideta_sym">d2H_dxideta_sym</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolGeometry2D.Hessian">Hessian</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry2D.compute_geodesic">compute_geodesic</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry2D.find_periodic_orbits_2d">find_periodic_orbits_2d</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry2D.detect_caustic_structures">detect_caustic_structures</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolGeometry2D.compute_phase_space_volume">compute_phase_space_volume</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SymbolVisualizer2D">SymbolVisualizer2D</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SymbolVisualizer2D.__init__">SymbolVisualizer2D</a>
                        </li>
                        <li>
                                <a class="variable" href="#SymbolVisualizer2D.geo">geo</a>
                        </li>
                        <li>
                                <a class="function" href="#SymbolVisualizer2D.visualize_complete">visualize_complete</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Utilities2D">Utilities2D</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Utilities2D.compute_winding_number">compute_winding_number</a>
                        </li>
                        <li>
                                <a class="function" href="#Utilities2D.compute_rotation_numbers">compute_rotation_numbers</a>
                        </li>
                        <li>
                                <a class="function" href="#Utilities2D.detect_kam_tori">detect_kam_tori</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
src    </h1>

                        <div class="docstring"><h1 id="ψπ-psipy-symbolic-numerical-toolkit-for-pdes-and-hamiltonian-mechanics">Ψπ (psipy): Symbolic-Numerical Toolkit for PDEs and Hamiltonian Mechanics</h1>

<h2 id="overview">Overview</h2>

<p>Welcome to <code>psipy</code>, a comprehensive Python ecosystem designed to bridge the gap
between formal symbolic mathematics (via SymPy) and high-performance numerical
simulation (via NumPy/SciPy). This library provides a unified framework for
defining, analyzing, solving, and visualizing complex problems in:</p>

<ul>
<li>Partial Differential Equations (PDEs)</li>
<li>Pseudo-Differential Operators (ΨDOs)</li>
<li>Hamiltonian and Lagrangian Mechanics</li>
<li>Semiclassical and Microlocal Analysis</li>
</ul>

<p>The core philosophy is to allow users to move seamlessly from a formal symbolic
definition—such as a Lagrangian, a Hamiltonian from the included catalog, or a
PDE written in SymPy—to a robust numerical analysis, such as solving the PDE's
evolution, visualizing its phase-space geometry, or computing its semiclassical
spectrum.</p>

<h2 id="core-components">Core Components</h2>

<p>The <code>psipy</code> ecosystem is composed of several powerful, interoperable modules:</p>

<ul>
<li><p><strong><code><a href="#PDESolver">PDESolver</a></code></strong>: The main numerical engine. It parses symbolic PDEs and solves
1D/2D, linear/nonlinear, time-dependent or stationary equations. It uses spectral
(FFT) methods with high-order exponential integrators (like ETD-RK4) for robust
time evolution.</p></li>
<li><p><strong><code><a href="#PseudoDifferentialOperator">PseudoDifferentialOperator</a></code></strong>: A complete symbolic and numerical framework for Pseudo-Differential
Operators (ΨDOs). It supports symbolic calculus (composition, commutators, adjoints)
and microlocal analysis (ellipticity, characteristic sets), bridging formal definitions
with numerical evaluation on grids.</p></li>
<li><p><strong><code><a href="#LagrangianHamiltonianConverter">LagrangianHamiltonianConverter</a></code> &amp; <code><a href="#HamiltonianSymbolicConverter">HamiltonianSymbolicConverter</a></code></strong>: A symbolic toolkit for analytical mechanics. It performs purely
symbolic Legendre transforms (L ↔ H) and can automatically generate formal symbolic
PDEs (e.g., Schrödinger, Wave) from any given Hamiltonian symbol.</p></li>
<li><p><strong><code>HamiltonianCatalog</code></strong>: A vast, curated, and searchable symbolic database of
<strong>over 500</strong> Hamiltonian systems. It spans classical mechanics, quantum chaos,
biophysics, and more, providing a rich testbed for research and education.</p></li>
<li><p><strong><code><a href="#SymbolGeometry">SymbolGeometry</a></code></strong>: A comprehensive analysis and visualization suite for 1D
Hamiltonian systems. It connects classical geometry to quantum spectra by computing
classical trajectories, periodic orbits, and the semiclassical energy spectrum via
the <strong>Gutzwiller trace formula</strong> and <strong>EBK quantization</strong>.</p></li>
<li><p><strong><code><a href="#SymbolGeometry2D">SymbolGeometry2D</a></code></strong>: An advanced 2D analysis toolkit for visualizing dynamical
systems. It performs rigorous <strong>caustic detection</strong> by tracking the full 4x4 Jacobian,
generates <strong>Poincaré sections</strong>, and analyzes <strong>KAM tori</strong>, providing a deep dive
into 2D phase space geometry.</p></li>
</ul>

<h2 id="typical-workflow">Typical Workflow</h2>

<p>A common use case involves combining all modules:</p>

<ol>
<li><p><strong>Select a System</strong>: Fetch a complex Hamiltonian (e.g., "henon_heiles")
from the <code>HamiltonianCatalog</code>.</p></li>
<li><p><strong>Formulate the PDE</strong>: Use <code>SymPhysics</code> to automatically generate the
corresponding symbolic Schrödinger equation.</p></li>
<li><p><strong>Analyze Geometry</strong>: Pass the Hamiltonian symbol to <code><a href="#SymbolGeometry2D">SymbolGeometry2D</a></code>
to visualize its classical trajectories, Poincaré sections, and chaotic regions.</p></li>
<li><p><strong>Solve Dynamics</strong>: Pass the symbolic PDE to the <code><a href="#PDESolver">PDESolver</a></code> to
simulate the quantum wave function's evolution in time.</p></li>
</ol>

<h2 id="example-solving-a-pseudo-differential-pde">Example: Solving a Pseudo-Differential PDE</h2>

<p>This example defines a 1D Schrödinger-type equation with a non-local,
relativistic kinetic term, i ∂ₜ u = √(1 - ∂ₓ²) u.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">solver</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># 1. Define symbolic variables</span>
<span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;t x xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>

<span class="c1"># 2. Define the PDE symbolically</span>
<span class="c1"># The symbol for the operator √(1 - ∂ₓ²) is p(ξ) = √(1 + ξ²)</span>
<span class="c1"># (using the Fourier convention p(ξ) → op(ξ) → -∂ₓ²)</span>
<span class="n">p_symbol</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># The equation is: i * ∂ₜ u = psiOp(p_symbol) * u</span>
<span class="n">equation</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">t</span><span class="p">),</span> <span class="n">psiOp</span><span class="p">(</span><span class="n">p_symbol</span><span class="p">,</span> <span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>

<span class="c1"># 3. Create the solver</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">PDESolver</span><span class="p">(</span><span class="n">equation</span><span class="p">)</span>

<span class="c1"># 4. Setup the simulation domain and initial condition</span>
<span class="n">initial_packet</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span>
    <span class="n">Lx</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">Lt</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">initial_condition</span><span class="o">=</span><span class="n">initial_packet</span><span class="p">,</span>
    <span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span>
<span class="p">)</span>

<span class="c1"># 5. Solve the PDE</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># 6. Animate the solution</span>
<span class="n">ani</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">animate</span><span class="p">()</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span>
</code></pre>
</div>
</div>

                        <input id="mod-src-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-src-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Ψπ (psipy): Symbolic-Numerical Toolkit for PDEs and Hamiltonian Mechanics</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">========================================================================</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">## Overview</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">Welcome to `psipy`, a comprehensive Python ecosystem designed to bridge the gap</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">between formal symbolic mathematics (via SymPy) and high-performance numerical</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">simulation (via NumPy/SciPy). This library provides a unified framework for</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">defining, analyzing, solving, and visualizing complex problems in:</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">- Partial Differential Equations (PDEs)</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">- Pseudo-Differential Operators (ΨDOs)</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">- Hamiltonian and Lagrangian Mechanics</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">- Semiclassical and Microlocal Analysis</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">The core philosophy is to allow users to move seamlessly from a formal symbolic</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">definition—such as a Lagrangian, a Hamiltonian from the included catalog, or a</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">PDE written in SymPy—to a robust numerical analysis, such as solving the PDE&#39;s</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">evolution, visualizing its phase-space geometry, or computing its semiclassical</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">spectrum.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">## Core Components</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">The `psipy` ecosystem is composed of several powerful, interoperable modules:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">- **`PDESolver`**: The main numerical engine. It parses symbolic PDEs and solves</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">  1D/2D, linear/nonlinear, time-dependent or stationary equations. It uses spectral</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">  (FFT) methods with high-order exponential integrators (like ETD-RK4) for robust</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">  time evolution.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">- **`PseudoDifferentialOperator`**: A complete symbolic and numerical framework for Pseudo-Differential</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">  Operators (ΨDOs). It supports symbolic calculus (composition, commutators, adjoints)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">  and microlocal analysis (ellipticity, characteristic sets), bridging formal definitions</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">  with numerical evaluation on grids.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">- **`LagrangianHamiltonianConverter` &amp; `HamiltonianSymbolicConverter`**: A symbolic toolkit for analytical mechanics. It performs purely</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">  symbolic Legendre transforms (L ↔ H) and can automatically generate formal symbolic</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">  PDEs (e.g., Schrödinger, Wave) from any given Hamiltonian symbol.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">- **`HamiltonianCatalog`**: A vast, curated, and searchable symbolic database of</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">  **over 500** Hamiltonian systems. It spans classical mechanics, quantum chaos,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">  biophysics, and more, providing a rich testbed for research and education.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">- **`SymbolGeometry`**: A comprehensive analysis and visualization suite for 1D</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">  Hamiltonian systems. It connects classical geometry to quantum spectra by computing</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">  classical trajectories, periodic orbits, and the semiclassical energy spectrum via</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">  the **Gutzwiller trace formula** and **EBK quantization**.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">- **`SymbolGeometry2D`**: An advanced 2D analysis toolkit for visualizing dynamical</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">  systems. It performs rigorous **caustic detection** by tracking the full 4x4 Jacobian,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">  generates **Poincaré sections**, and analyzes **KAM tori**, providing a deep dive</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">  into 2D phase space geometry.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">## Typical Workflow</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">A common use case involves combining all modules:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">1. **Select a System**: Fetch a complex Hamiltonian (e.g., &quot;henon_heiles&quot;)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">   from the `HamiltonianCatalog`.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">2. **Formulate the PDE**: Use `SymPhysics` to automatically generate the</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">   corresponding symbolic Schrödinger equation.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">3. **Analyze Geometry**: Pass the Hamiltonian symbol to `SymbolGeometry2D`</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">   to visualize its classical trajectories, Poincaré sections, and chaotic regions.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">4. **Solve Dynamics**: Pass the symbolic PDE to the `PDESolver` to</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">   simulate the quantum wave function&#39;s evolution in time.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">## Example: Solving a Pseudo-Differential PDE</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">This example defines a 1D Schrödinger-type equation with a non-local,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">relativistic kinetic term, i ∂ₜ u = √(1 - ∂ₓ²) u.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">```python</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">from solver import *</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd"># 1. Define symbolic variables</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">t, x, xi = symbols(&#39;t x xi&#39;, real=True)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">u = Function(&#39;u&#39;)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd"># 2. Define the PDE symbolically</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd"># The symbol for the operator √(1 - ∂ₓ²) is p(ξ) = √(1 + ξ²)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd"># (using the Fourier convention p(ξ) → op(ξ) → -∂ₓ²)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">p_symbol = (1 + xi**2)**(1/2)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd"># The equation is: i * ∂ₜ u = psiOp(p_symbol) * u</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">equation = Eq(I * diff(u(t, x), t), psiOp(p_symbol, u(t, x)))</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd"># 3. Create the solver</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">solver = PDESolver(equation)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd"># 4. Setup the simulation domain and initial condition</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">initial_packet = lambda x: np.exp(-(x - np.pi)**2 / 0.5) * np.exp(1j * 5.0 * x)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">solver.setup(</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">    Lx=2 * np.pi, Nx=256,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    Lt=4.0, Nt=1000,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">    initial_condition=initial_packet,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    boundary_condition=&#39;periodic&#39;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd"># 5. Solve the PDE</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">solver.solve()</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd"># 6. Animate the solution</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">ani = solver.animate()</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">HTML(ani.to_jshtml())</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">```</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="c1"># Imports publics</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.psiop</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.solver</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.physics</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.geometry_1d</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.geometry_2d</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.hamiltonian_catalog</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="c1"># Version du package</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="n">__version__</span> <span class="o">=</span> <span class="n">version</span><span class="p">(</span><span class="s2">&quot;psipy&quot;</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="c1"># Liste des noms exposés par `from psipy import *`</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="s2">&quot;PseudoDifferentialOperator&quot;</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="s2">&quot;PDESolver&quot;</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="s2">&quot;LagrangianHamiltonianConverter&quot;</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="s2">&quot;HamiltonianSymbolicConverter&quot;</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="s2">&quot;SymbolGeometry&quot;</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="s2">&quot;SymbolVisualizer&quot;</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="s2">&quot;SpectralAnalysis&quot;</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="s2">&quot;SymbolGeometry2D&quot;</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="s2">&quot;SymbolVisualizer2D&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="s2">&quot;Utilities2D&quot;</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="PseudoDifferentialOperator">
                            <input id="PseudoDifferentialOperator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PseudoDifferentialOperator</span>:

                <label class="view-source-button" for="PseudoDifferentialOperator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator-25"><a href="#PseudoDifferentialOperator-25"><span class="linenos">  25</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PseudoDifferentialOperator</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-26"><a href="#PseudoDifferentialOperator-26"><span class="linenos">  26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-27"><a href="#PseudoDifferentialOperator-27"><span class="linenos">  27</span></a><span class="sd">    Pseudo-differential operator with dynamic symbol evaluation on spatial grids.</span>
</span><span id="PseudoDifferentialOperator-28"><a href="#PseudoDifferentialOperator-28"><span class="linenos">  28</span></a><span class="sd">    Supports both 1D and 2D operators, and can be defined explicitly (symbol mode)</span>
</span><span id="PseudoDifferentialOperator-29"><a href="#PseudoDifferentialOperator-29"><span class="linenos">  29</span></a><span class="sd">    or extracted automatically from symbolic equations (auto mode).</span>
</span><span id="PseudoDifferentialOperator-30"><a href="#PseudoDifferentialOperator-30"><span class="linenos">  30</span></a>
</span><span id="PseudoDifferentialOperator-31"><a href="#PseudoDifferentialOperator-31"><span class="linenos">  31</span></a><span class="sd">    Parameters</span>
</span><span id="PseudoDifferentialOperator-32"><a href="#PseudoDifferentialOperator-32"><span class="linenos">  32</span></a><span class="sd">    ----------</span>
</span><span id="PseudoDifferentialOperator-33"><a href="#PseudoDifferentialOperator-33"><span class="linenos">  33</span></a><span class="sd">    expr : sympy expression</span>
</span><span id="PseudoDifferentialOperator-34"><a href="#PseudoDifferentialOperator-34"><span class="linenos">  34</span></a><span class="sd">        Symbolic expression representing the pseudo-differential symbol.</span>
</span><span id="PseudoDifferentialOperator-35"><a href="#PseudoDifferentialOperator-35"><span class="linenos">  35</span></a><span class="sd">    vars_x : list of sympy symbols</span>
</span><span id="PseudoDifferentialOperator-36"><a href="#PseudoDifferentialOperator-36"><span class="linenos">  36</span></a><span class="sd">        Spatial variables (e.g., [x] for 1D, [x, y] for 2D).</span>
</span><span id="PseudoDifferentialOperator-37"><a href="#PseudoDifferentialOperator-37"><span class="linenos">  37</span></a><span class="sd">    var_u : sympy function, optional</span>
</span><span id="PseudoDifferentialOperator-38"><a href="#PseudoDifferentialOperator-38"><span class="linenos">  38</span></a><span class="sd">        Function u(x, t) used in auto mode to extract the operator symbol.</span>
</span><span id="PseudoDifferentialOperator-39"><a href="#PseudoDifferentialOperator-39"><span class="linenos">  39</span></a><span class="sd">    mode : str, {&#39;symbol&#39;, &#39;auto&#39;}</span>
</span><span id="PseudoDifferentialOperator-40"><a href="#PseudoDifferentialOperator-40"><span class="linenos">  40</span></a><span class="sd">        - &#39;symbol&#39;: directly uses expr as the operator symbol.</span>
</span><span id="PseudoDifferentialOperator-41"><a href="#PseudoDifferentialOperator-41"><span class="linenos">  41</span></a><span class="sd">        - &#39;auto&#39;: computes the symbol automatically by applying expr to exp(i x ξ).</span>
</span><span id="PseudoDifferentialOperator-42"><a href="#PseudoDifferentialOperator-42"><span class="linenos">  42</span></a>
</span><span id="PseudoDifferentialOperator-43"><a href="#PseudoDifferentialOperator-43"><span class="linenos">  43</span></a><span class="sd">    Attributes</span>
</span><span id="PseudoDifferentialOperator-44"><a href="#PseudoDifferentialOperator-44"><span class="linenos">  44</span></a><span class="sd">    ----------</span>
</span><span id="PseudoDifferentialOperator-45"><a href="#PseudoDifferentialOperator-45"><span class="linenos">  45</span></a><span class="sd">    dim : int</span>
</span><span id="PseudoDifferentialOperator-46"><a href="#PseudoDifferentialOperator-46"><span class="linenos">  46</span></a><span class="sd">        Spatial dimension (1 or 2).</span>
</span><span id="PseudoDifferentialOperator-47"><a href="#PseudoDifferentialOperator-47"><span class="linenos">  47</span></a><span class="sd">    fft, ifft : callable</span>
</span><span id="PseudoDifferentialOperator-48"><a href="#PseudoDifferentialOperator-48"><span class="linenos">  48</span></a><span class="sd">        Fast Fourier transform and inverse (scipy.fft or scipy.fft2).</span>
</span><span id="PseudoDifferentialOperator-49"><a href="#PseudoDifferentialOperator-49"><span class="linenos">  49</span></a><span class="sd">    p_func : callable</span>
</span><span id="PseudoDifferentialOperator-50"><a href="#PseudoDifferentialOperator-50"><span class="linenos">  50</span></a><span class="sd">        Evaluated symbol function ready for numerical use.</span>
</span><span id="PseudoDifferentialOperator-51"><a href="#PseudoDifferentialOperator-51"><span class="linenos">  51</span></a>
</span><span id="PseudoDifferentialOperator-52"><a href="#PseudoDifferentialOperator-52"><span class="linenos">  52</span></a><span class="sd">    Notes</span>
</span><span id="PseudoDifferentialOperator-53"><a href="#PseudoDifferentialOperator-53"><span class="linenos">  53</span></a><span class="sd">    -----</span>
</span><span id="PseudoDifferentialOperator-54"><a href="#PseudoDifferentialOperator-54"><span class="linenos">  54</span></a><span class="sd">    - In &#39;symbol&#39; mode, `expr` should be expressed in terms of spatial variables and frequency variables (ξ, η).</span>
</span><span id="PseudoDifferentialOperator-55"><a href="#PseudoDifferentialOperator-55"><span class="linenos">  55</span></a><span class="sd">    - In &#39;auto&#39; mode, the symbol is derived by applying the differential expression to a complex exponential.</span>
</span><span id="PseudoDifferentialOperator-56"><a href="#PseudoDifferentialOperator-56"><span class="linenos">  56</span></a><span class="sd">    - Frequency variables are internally named &#39;xi&#39; and &#39;eta&#39; for consistency.</span>
</span><span id="PseudoDifferentialOperator-57"><a href="#PseudoDifferentialOperator-57"><span class="linenos">  57</span></a><span class="sd">    - Uses numpy for numerical evaluation and scipy.fft for FFT operations.</span>
</span><span id="PseudoDifferentialOperator-58"><a href="#PseudoDifferentialOperator-58"><span class="linenos">  58</span></a>
</span><span id="PseudoDifferentialOperator-59"><a href="#PseudoDifferentialOperator-59"><span class="linenos">  59</span></a><span class="sd">    Examples</span>
</span><span id="PseudoDifferentialOperator-60"><a href="#PseudoDifferentialOperator-60"><span class="linenos">  60</span></a><span class="sd">    --------</span>
</span><span id="PseudoDifferentialOperator-61"><a href="#PseudoDifferentialOperator-61"><span class="linenos">  61</span></a><span class="sd">    &gt;&gt;&gt; # Example 1: 1D Laplacian operator (symbol mode)</span>
</span><span id="PseudoDifferentialOperator-62"><a href="#PseudoDifferentialOperator-62"><span class="linenos">  62</span></a><span class="sd">    &gt;&gt;&gt; from sympy import symbols</span>
</span><span id="PseudoDifferentialOperator-63"><a href="#PseudoDifferentialOperator-63"><span class="linenos">  63</span></a><span class="sd">    &gt;&gt;&gt; x, xi = symbols(&#39;x xi&#39;, real=True)</span>
</span><span id="PseudoDifferentialOperator-64"><a href="#PseudoDifferentialOperator-64"><span class="linenos">  64</span></a><span class="sd">    &gt;&gt;&gt; op = PseudoDifferentialOperator(expr=xi**2, vars_x=[x], mode=&#39;symbol&#39;)</span>
</span><span id="PseudoDifferentialOperator-65"><a href="#PseudoDifferentialOperator-65"><span class="linenos">  65</span></a>
</span><span id="PseudoDifferentialOperator-66"><a href="#PseudoDifferentialOperator-66"><span class="linenos">  66</span></a><span class="sd">    &gt;&gt;&gt; # Example 2: 1D transport operator (auto mode)</span>
</span><span id="PseudoDifferentialOperator-67"><a href="#PseudoDifferentialOperator-67"><span class="linenos">  67</span></a><span class="sd">    &gt;&gt;&gt; from sympy import Function</span>
</span><span id="PseudoDifferentialOperator-68"><a href="#PseudoDifferentialOperator-68"><span class="linenos">  68</span></a><span class="sd">    &gt;&gt;&gt; u = Function(&#39;u&#39;)</span>
</span><span id="PseudoDifferentialOperator-69"><a href="#PseudoDifferentialOperator-69"><span class="linenos">  69</span></a><span class="sd">    &gt;&gt;&gt; expr = u(x).diff(x)</span>
</span><span id="PseudoDifferentialOperator-70"><a href="#PseudoDifferentialOperator-70"><span class="linenos">  70</span></a><span class="sd">    &gt;&gt;&gt; op = PseudoDifferentialOperator(expr=expr, vars_x=[x], var_u=u(x), mode=&#39;auto&#39;)</span>
</span><span id="PseudoDifferentialOperator-71"><a href="#PseudoDifferentialOperator-71"><span class="linenos">  71</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-72"><a href="#PseudoDifferentialOperator-72"><span class="linenos">  72</span></a>
</span><span id="PseudoDifferentialOperator-73"><a href="#PseudoDifferentialOperator-73"><span class="linenos">  73</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">vars_x</span><span class="p">,</span> <span class="n">var_u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-74"><a href="#PseudoDifferentialOperator-74"><span class="linenos">  74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-75"><a href="#PseudoDifferentialOperator-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
</span><span id="PseudoDifferentialOperator-76"><a href="#PseudoDifferentialOperator-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-77"><a href="#PseudoDifferentialOperator-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
</span><span id="PseudoDifferentialOperator-78"><a href="#PseudoDifferentialOperator-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-79"><a href="#PseudoDifferentialOperator-79"><span class="linenos">  79</span></a>
</span><span id="PseudoDifferentialOperator-80"><a href="#PseudoDifferentialOperator-80"><span class="linenos">  80</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-81"><a href="#PseudoDifferentialOperator-81"><span class="linenos">  81</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-82"><a href="#PseudoDifferentialOperator-82"><span class="linenos">  82</span></a>            <span class="n">xi_internal</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-83"><a href="#PseudoDifferentialOperator-83"><span class="linenos">  83</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">xi_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-84"><a href="#PseudoDifferentialOperator-84"><span class="linenos">  84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-85"><a href="#PseudoDifferentialOperator-85"><span class="linenos">  85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-86"><a href="#PseudoDifferentialOperator-86"><span class="linenos">  86</span></a>
</span><span id="PseudoDifferentialOperator-87"><a href="#PseudoDifferentialOperator-87"><span class="linenos">  87</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-88"><a href="#PseudoDifferentialOperator-88"><span class="linenos">  88</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-89"><a href="#PseudoDifferentialOperator-89"><span class="linenos">  89</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span>
</span><span id="PseudoDifferentialOperator-90"><a href="#PseudoDifferentialOperator-90"><span class="linenos">  90</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-91"><a href="#PseudoDifferentialOperator-91"><span class="linenos">  91</span></a>                <span class="k">if</span> <span class="n">var_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-92"><a href="#PseudoDifferentialOperator-92"><span class="linenos">  92</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var_u must be provided in mode=&#39;auto&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-93"><a href="#PseudoDifferentialOperator-93"><span class="linenos">  93</span></a>                <span class="n">exp_i</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">xi_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-94"><a href="#PseudoDifferentialOperator-94"><span class="linenos">  94</span></a>                <span class="n">P_ei</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">var_u</span><span class="p">,</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-95"><a href="#PseudoDifferentialOperator-95"><span class="linenos">  95</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">P_ei</span> <span class="o">/</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-96"><a href="#PseudoDifferentialOperator-96"><span class="linenos">  96</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-97"><a href="#PseudoDifferentialOperator-97"><span class="linenos">  97</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-98"><a href="#PseudoDifferentialOperator-98"><span class="linenos">  98</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">),</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-99"><a href="#PseudoDifferentialOperator-99"><span class="linenos">  99</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-100"><a href="#PseudoDifferentialOperator-100"><span class="linenos"> 100</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;auto&#39; or &#39;symbol&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-101"><a href="#PseudoDifferentialOperator-101"><span class="linenos"> 101</span></a>
</span><span id="PseudoDifferentialOperator-102"><a href="#PseudoDifferentialOperator-102"><span class="linenos"> 102</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-103"><a href="#PseudoDifferentialOperator-103"><span class="linenos"> 103</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-104"><a href="#PseudoDifferentialOperator-104"><span class="linenos"> 104</span></a>            <span class="n">xi_internal</span><span class="p">,</span> <span class="n">eta_internal</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-105"><a href="#PseudoDifferentialOperator-105"><span class="linenos"> 105</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">xi_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-106"><a href="#PseudoDifferentialOperator-106"><span class="linenos"> 106</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">eta_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-107"><a href="#PseudoDifferentialOperator-107"><span class="linenos"> 107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-108"><a href="#PseudoDifferentialOperator-108"><span class="linenos"> 108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-109"><a href="#PseudoDifferentialOperator-109"><span class="linenos"> 109</span></a>
</span><span id="PseudoDifferentialOperator-110"><a href="#PseudoDifferentialOperator-110"><span class="linenos"> 110</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-111"><a href="#PseudoDifferentialOperator-111"><span class="linenos"> 111</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span>
</span><span id="PseudoDifferentialOperator-112"><a href="#PseudoDifferentialOperator-112"><span class="linenos"> 112</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">,</span> <span class="n">eta_internal</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-113"><a href="#PseudoDifferentialOperator-113"><span class="linenos"> 113</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-114"><a href="#PseudoDifferentialOperator-114"><span class="linenos"> 114</span></a>                <span class="k">if</span> <span class="n">var_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-115"><a href="#PseudoDifferentialOperator-115"><span class="linenos"> 115</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var_u must be provided in mode=&#39;auto&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-116"><a href="#PseudoDifferentialOperator-116"><span class="linenos"> 116</span></a>                <span class="n">exp_i</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">xi_internal</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">eta_internal</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-117"><a href="#PseudoDifferentialOperator-117"><span class="linenos"> 117</span></a>                <span class="n">P_ei</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">var_u</span><span class="p">,</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-118"><a href="#PseudoDifferentialOperator-118"><span class="linenos"> 118</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">P_ei</span> <span class="o">/</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-119"><a href="#PseudoDifferentialOperator-119"><span class="linenos"> 119</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-120"><a href="#PseudoDifferentialOperator-120"><span class="linenos"> 120</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-121"><a href="#PseudoDifferentialOperator-121"><span class="linenos"> 121</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">,</span> <span class="n">eta_internal</span><span class="p">),</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-122"><a href="#PseudoDifferentialOperator-122"><span class="linenos"> 122</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-123"><a href="#PseudoDifferentialOperator-123"><span class="linenos"> 123</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;auto&#39; or &#39;symbol&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-124"><a href="#PseudoDifferentialOperator-124"><span class="linenos"> 124</span></a>
</span><span id="PseudoDifferentialOperator-125"><a href="#PseudoDifferentialOperator-125"><span class="linenos"> 125</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-126"><a href="#PseudoDifferentialOperator-126"><span class="linenos"> 126</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-127"><a href="#PseudoDifferentialOperator-127"><span class="linenos"> 127</span></a>
</span><span id="PseudoDifferentialOperator-128"><a href="#PseudoDifferentialOperator-128"><span class="linenos"> 128</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-129"><a href="#PseudoDifferentialOperator-129"><span class="linenos"> 129</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">symbol = &quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-130"><a href="#PseudoDifferentialOperator-130"><span class="linenos"> 130</span></a>            <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-131"><a href="#PseudoDifferentialOperator-131"><span class="linenos"> 131</span></a>        
</span><span id="PseudoDifferentialOperator-132"><a href="#PseudoDifferentialOperator-132"><span class="linenos"> 132</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-133"><a href="#PseudoDifferentialOperator-133"><span class="linenos"> 133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-134"><a href="#PseudoDifferentialOperator-134"><span class="linenos"> 134</span></a><span class="sd">        Evaluate the pseudo-differential operator&#39;s symbol on a grid of spatial and frequency coordinates.</span>
</span><span id="PseudoDifferentialOperator-135"><a href="#PseudoDifferentialOperator-135"><span class="linenos"> 135</span></a>
</span><span id="PseudoDifferentialOperator-136"><a href="#PseudoDifferentialOperator-136"><span class="linenos"> 136</span></a><span class="sd">        The method dynamically selects between 1D and 2D evaluation based on the spatial dimension.</span>
</span><span id="PseudoDifferentialOperator-137"><a href="#PseudoDifferentialOperator-137"><span class="linenos"> 137</span></a><span class="sd">        If caching is enabled and a cached symbol exists, it returns the cached result to avoid recomputation.</span>
</span><span id="PseudoDifferentialOperator-138"><a href="#PseudoDifferentialOperator-138"><span class="linenos"> 138</span></a>
</span><span id="PseudoDifferentialOperator-139"><a href="#PseudoDifferentialOperator-139"><span class="linenos"> 139</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-140"><a href="#PseudoDifferentialOperator-140"><span class="linenos"> 140</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-141"><a href="#PseudoDifferentialOperator-141"><span class="linenos"> 141</span></a><span class="sd">        X, Y : ndarray</span>
</span><span id="PseudoDifferentialOperator-142"><a href="#PseudoDifferentialOperator-142"><span class="linenos"> 142</span></a><span class="sd">            Spatial grid coordinates. In 1D, Y is ignored.</span>
</span><span id="PseudoDifferentialOperator-143"><a href="#PseudoDifferentialOperator-143"><span class="linenos"> 143</span></a><span class="sd">        KX, KY : ndarray</span>
</span><span id="PseudoDifferentialOperator-144"><a href="#PseudoDifferentialOperator-144"><span class="linenos"> 144</span></a><span class="sd">            Frequency grid coordinates. In 1D, KY is ignored.</span>
</span><span id="PseudoDifferentialOperator-145"><a href="#PseudoDifferentialOperator-145"><span class="linenos"> 145</span></a><span class="sd">        cache : bool, default=True</span>
</span><span id="PseudoDifferentialOperator-146"><a href="#PseudoDifferentialOperator-146"><span class="linenos"> 146</span></a><span class="sd">            If True, stores the computed symbol for reuse in subsequent calls to avoid redundant computation.</span>
</span><span id="PseudoDifferentialOperator-147"><a href="#PseudoDifferentialOperator-147"><span class="linenos"> 147</span></a>
</span><span id="PseudoDifferentialOperator-148"><a href="#PseudoDifferentialOperator-148"><span class="linenos"> 148</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-149"><a href="#PseudoDifferentialOperator-149"><span class="linenos"> 149</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-150"><a href="#PseudoDifferentialOperator-150"><span class="linenos"> 150</span></a><span class="sd">        ndarray</span>
</span><span id="PseudoDifferentialOperator-151"><a href="#PseudoDifferentialOperator-151"><span class="linenos"> 151</span></a><span class="sd">            Evaluated symbol values over the input grid. Shape matches the input spatial/frequency grids.</span>
</span><span id="PseudoDifferentialOperator-152"><a href="#PseudoDifferentialOperator-152"><span class="linenos"> 152</span></a>
</span><span id="PseudoDifferentialOperator-153"><a href="#PseudoDifferentialOperator-153"><span class="linenos"> 153</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-154"><a href="#PseudoDifferentialOperator-154"><span class="linenos"> 154</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-155"><a href="#PseudoDifferentialOperator-155"><span class="linenos"> 155</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-156"><a href="#PseudoDifferentialOperator-156"><span class="linenos"> 156</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator-157"><a href="#PseudoDifferentialOperator-157"><span class="linenos"> 157</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-158"><a href="#PseudoDifferentialOperator-158"><span class="linenos"> 158</span></a>        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-159"><a href="#PseudoDifferentialOperator-159"><span class="linenos"> 159</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span>
</span><span id="PseudoDifferentialOperator-160"><a href="#PseudoDifferentialOperator-160"><span class="linenos"> 160</span></a>
</span><span id="PseudoDifferentialOperator-161"><a href="#PseudoDifferentialOperator-161"><span class="linenos"> 161</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-162"><a href="#PseudoDifferentialOperator-162"><span class="linenos"> 162</span></a>            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">KX</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-163"><a href="#PseudoDifferentialOperator-163"><span class="linenos"> 163</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-164"><a href="#PseudoDifferentialOperator-164"><span class="linenos"> 164</span></a>            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-165"><a href="#PseudoDifferentialOperator-165"><span class="linenos"> 165</span></a>
</span><span id="PseudoDifferentialOperator-166"><a href="#PseudoDifferentialOperator-166"><span class="linenos"> 166</span></a>        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-167"><a href="#PseudoDifferentialOperator-167"><span class="linenos"> 167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-168"><a href="#PseudoDifferentialOperator-168"><span class="linenos"> 168</span></a>
</span><span id="PseudoDifferentialOperator-169"><a href="#PseudoDifferentialOperator-169"><span class="linenos"> 169</span></a>        <span class="k">return</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-170"><a href="#PseudoDifferentialOperator-170"><span class="linenos"> 170</span></a>
</span><span id="PseudoDifferentialOperator-171"><a href="#PseudoDifferentialOperator-171"><span class="linenos"> 171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-172"><a href="#PseudoDifferentialOperator-172"><span class="linenos"> 172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-173"><a href="#PseudoDifferentialOperator-173"><span class="linenos"> 173</span></a><span class="sd">        Clear cached symbol evaluations.</span>
</span><span id="PseudoDifferentialOperator-174"><a href="#PseudoDifferentialOperator-174"><span class="linenos"> 174</span></a><span class="sd">        &quot;&quot;&quot;</span>        
</span><span id="PseudoDifferentialOperator-175"><a href="#PseudoDifferentialOperator-175"><span class="linenos"> 175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-176"><a href="#PseudoDifferentialOperator-176"><span class="linenos"> 176</span></a>
</span><span id="PseudoDifferentialOperator-177"><a href="#PseudoDifferentialOperator-177"><span class="linenos"> 177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator-178"><a href="#PseudoDifferentialOperator-178"><span class="linenos"> 178</span></a>              <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dealiasing_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-179"><a href="#PseudoDifferentialOperator-179"><span class="linenos"> 179</span></a>              <span class="n">freq_window</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">space_window</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-180"><a href="#PseudoDifferentialOperator-180"><span class="linenos"> 180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-181"><a href="#PseudoDifferentialOperator-181"><span class="linenos"> 181</span></a><span class="sd">        Apply the pseudo-differential operator to the input field u.</span>
</span><span id="PseudoDifferentialOperator-182"><a href="#PseudoDifferentialOperator-182"><span class="linenos"> 182</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-183"><a href="#PseudoDifferentialOperator-183"><span class="linenos"> 183</span></a><span class="sd">        This method dispatches the application of the pseudo-differential operator based on:</span>
</span><span id="PseudoDifferentialOperator-184"><a href="#PseudoDifferentialOperator-184"><span class="linenos"> 184</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-185"><a href="#PseudoDifferentialOperator-185"><span class="linenos"> 185</span></a><span class="sd">        - Whether the symbol is spatially dependent (x/y)</span>
</span><span id="PseudoDifferentialOperator-186"><a href="#PseudoDifferentialOperator-186"><span class="linenos"> 186</span></a><span class="sd">        - The boundary condition in use (periodic or dirichlet)</span>
</span><span id="PseudoDifferentialOperator-187"><a href="#PseudoDifferentialOperator-187"><span class="linenos"> 187</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-188"><a href="#PseudoDifferentialOperator-188"><span class="linenos"> 188</span></a><span class="sd">        Supported operations:</span>
</span><span id="PseudoDifferentialOperator-189"><a href="#PseudoDifferentialOperator-189"><span class="linenos"> 189</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-190"><a href="#PseudoDifferentialOperator-190"><span class="linenos"> 190</span></a><span class="sd">        - Constant-coefficient symbols: applied via Fourier multiplication.</span>
</span><span id="PseudoDifferentialOperator-191"><a href="#PseudoDifferentialOperator-191"><span class="linenos"> 191</span></a><span class="sd">        - Spatially varying symbols: applied via Kohn–Nirenberg quantization.</span>
</span><span id="PseudoDifferentialOperator-192"><a href="#PseudoDifferentialOperator-192"><span class="linenos"> 192</span></a><span class="sd">        - Dirichlet boundary conditions: handled with non-periodic convolution-like quantization.</span>
</span><span id="PseudoDifferentialOperator-193"><a href="#PseudoDifferentialOperator-193"><span class="linenos"> 193</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-194"><a href="#PseudoDifferentialOperator-194"><span class="linenos"> 194</span></a><span class="sd">        Dispatch Logic:\n</span>
</span><span id="PseudoDifferentialOperator-195"><a href="#PseudoDifferentialOperator-195"><span class="linenos"> 195</span></a><span class="sd">        if not self.is_spatial: u ↦ Op(p)(D) ⋅ u = 𝓕⁻¹[ p(ξ) ⋅ 𝓕(u) ]\n</span>
</span><span id="PseudoDifferentialOperator-196"><a href="#PseudoDifferentialOperator-196"><span class="linenos"> 196</span></a><span class="sd">        elif periodic: u ↦ Op(p)(x,D) ⋅ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ based of FFT (quicker)\n</span>
</span><span id="PseudoDifferentialOperator-197"><a href="#PseudoDifferentialOperator-197"><span class="linenos"> 197</span></a><span class="sd">        elif dirichlet: u ↦ Op(p)(x,D) ⋅ u ≈ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ (slower)\n</span>
</span><span id="PseudoDifferentialOperator-198"><a href="#PseudoDifferentialOperator-198"><span class="linenos"> 198</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-199"><a href="#PseudoDifferentialOperator-199"><span class="linenos"> 199</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-200"><a href="#PseudoDifferentialOperator-200"><span class="linenos"> 200</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-201"><a href="#PseudoDifferentialOperator-201"><span class="linenos"> 201</span></a><span class="sd">        u : ndarray</span>
</span><span id="PseudoDifferentialOperator-202"><a href="#PseudoDifferentialOperator-202"><span class="linenos"> 202</span></a><span class="sd">            Function to which the operator is applied</span>
</span><span id="PseudoDifferentialOperator-203"><a href="#PseudoDifferentialOperator-203"><span class="linenos"> 203</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-204"><a href="#PseudoDifferentialOperator-204"><span class="linenos"> 204</span></a><span class="sd">            Spatial grid in x direction</span>
</span><span id="PseudoDifferentialOperator-205"><a href="#PseudoDifferentialOperator-205"><span class="linenos"> 205</span></a><span class="sd">        kx : ndarray</span>
</span><span id="PseudoDifferentialOperator-206"><a href="#PseudoDifferentialOperator-206"><span class="linenos"> 206</span></a><span class="sd">            Frequency grid in x direction</span>
</span><span id="PseudoDifferentialOperator-207"><a href="#PseudoDifferentialOperator-207"><span class="linenos"> 207</span></a><span class="sd">        boundary_condition : str</span>
</span><span id="PseudoDifferentialOperator-208"><a href="#PseudoDifferentialOperator-208"><span class="linenos"> 208</span></a><span class="sd">            &#39;periodic&#39; or &#39;dirichlet&#39;</span>
</span><span id="PseudoDifferentialOperator-209"><a href="#PseudoDifferentialOperator-209"><span class="linenos"> 209</span></a><span class="sd">        y_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-210"><a href="#PseudoDifferentialOperator-210"><span class="linenos"> 210</span></a><span class="sd">            Spatial grid in y direction (for 2D)</span>
</span><span id="PseudoDifferentialOperator-211"><a href="#PseudoDifferentialOperator-211"><span class="linenos"> 211</span></a><span class="sd">        ky : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-212"><a href="#PseudoDifferentialOperator-212"><span class="linenos"> 212</span></a><span class="sd">            Frequency grid in y direction (for 2D)</span>
</span><span id="PseudoDifferentialOperator-213"><a href="#PseudoDifferentialOperator-213"><span class="linenos"> 213</span></a><span class="sd">        dealiasing_mask : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-214"><a href="#PseudoDifferentialOperator-214"><span class="linenos"> 214</span></a><span class="sd">            Dealiasing mask</span>
</span><span id="PseudoDifferentialOperator-215"><a href="#PseudoDifferentialOperator-215"><span class="linenos"> 215</span></a><span class="sd">        freq_window : str</span>
</span><span id="PseudoDifferentialOperator-216"><a href="#PseudoDifferentialOperator-216"><span class="linenos"> 216</span></a><span class="sd">            Frequency windowing (&#39;gaussian&#39; or &#39;hann&#39;)</span>
</span><span id="PseudoDifferentialOperator-217"><a href="#PseudoDifferentialOperator-217"><span class="linenos"> 217</span></a><span class="sd">        clamp : float</span>
</span><span id="PseudoDifferentialOperator-218"><a href="#PseudoDifferentialOperator-218"><span class="linenos"> 218</span></a><span class="sd">            Clamp symbol values to [-clamp, clamp]</span>
</span><span id="PseudoDifferentialOperator-219"><a href="#PseudoDifferentialOperator-219"><span class="linenos"> 219</span></a><span class="sd">        space_window : bool</span>
</span><span id="PseudoDifferentialOperator-220"><a href="#PseudoDifferentialOperator-220"><span class="linenos"> 220</span></a><span class="sd">            Apply spatial windowing</span>
</span><span id="PseudoDifferentialOperator-221"><a href="#PseudoDifferentialOperator-221"><span class="linenos"> 221</span></a><span class="sd">            </span>
</span><span id="PseudoDifferentialOperator-222"><a href="#PseudoDifferentialOperator-222"><span class="linenos"> 222</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-223"><a href="#PseudoDifferentialOperator-223"><span class="linenos"> 223</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-224"><a href="#PseudoDifferentialOperator-224"><span class="linenos"> 224</span></a><span class="sd">        ndarray</span>
</span><span id="PseudoDifferentialOperator-225"><a href="#PseudoDifferentialOperator-225"><span class="linenos"> 225</span></a><span class="sd">            Result of applying the operator</span>
</span><span id="PseudoDifferentialOperator-226"><a href="#PseudoDifferentialOperator-226"><span class="linenos"> 226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-227"><a href="#PseudoDifferentialOperator-227"><span class="linenos"> 227</span></a>        <span class="c1"># Check if symbol depends on spatial variables</span>
</span><span id="PseudoDifferentialOperator-228"><a href="#PseudoDifferentialOperator-228"><span class="linenos"> 228</span></a>        <span class="n">is_spatial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_spatial_dependent</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-229"><a href="#PseudoDifferentialOperator-229"><span class="linenos"> 229</span></a>        
</span><span id="PseudoDifferentialOperator-230"><a href="#PseudoDifferentialOperator-230"><span class="linenos"> 230</span></a>        <span class="c1"># Case 1: Constant symbol with periodic BC (fast path)</span>
</span><span id="PseudoDifferentialOperator-231"><a href="#PseudoDifferentialOperator-231"><span class="linenos"> 231</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_spatial</span> <span class="ow">and</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-232"><a href="#PseudoDifferentialOperator-232"><span class="linenos"> 232</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_constant_fft</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">dealiasing_mask</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-233"><a href="#PseudoDifferentialOperator-233"><span class="linenos"> 233</span></a>        
</span><span id="PseudoDifferentialOperator-234"><a href="#PseudoDifferentialOperator-234"><span class="linenos"> 234</span></a>        <span class="c1"># Case 2: Spatial symbol with periodic BC</span>
</span><span id="PseudoDifferentialOperator-235"><a href="#PseudoDifferentialOperator-235"><span class="linenos"> 235</span></a>        <span class="k">elif</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-236"><a href="#PseudoDifferentialOperator-236"><span class="linenos"> 236</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol_func</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-237"><a href="#PseudoDifferentialOperator-237"><span class="linenos"> 237</span></a>            <span class="k">return</span> <span class="n">kohn_nirenberg_fft</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-238"><a href="#PseudoDifferentialOperator-238"><span class="linenos"> 238</span></a>                <span class="n">u_vals</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-239"><a href="#PseudoDifferentialOperator-239"><span class="linenos"> 239</span></a>                <span class="n">symbol_func</span><span class="o">=</span><span class="n">symbol_func</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-240"><a href="#PseudoDifferentialOperator-240"><span class="linenos"> 240</span></a>                <span class="n">x_grid</span><span class="o">=</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-241"><a href="#PseudoDifferentialOperator-241"><span class="linenos"> 241</span></a>                <span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-242"><a href="#PseudoDifferentialOperator-242"><span class="linenos"> 242</span></a>                <span class="n">fft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-243"><a href="#PseudoDifferentialOperator-243"><span class="linenos"> 243</span></a>                <span class="n">ifft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-244"><a href="#PseudoDifferentialOperator-244"><span class="linenos"> 244</span></a>                <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-245"><a href="#PseudoDifferentialOperator-245"><span class="linenos"> 245</span></a>                <span class="n">y_grid</span><span class="o">=</span><span class="n">y_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-246"><a href="#PseudoDifferentialOperator-246"><span class="linenos"> 246</span></a>                <span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-247"><a href="#PseudoDifferentialOperator-247"><span class="linenos"> 247</span></a>                <span class="n">freq_window</span><span class="o">=</span><span class="n">freq_window</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-248"><a href="#PseudoDifferentialOperator-248"><span class="linenos"> 248</span></a>                <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-249"><a href="#PseudoDifferentialOperator-249"><span class="linenos"> 249</span></a>                <span class="n">space_window</span><span class="o">=</span><span class="n">space_window</span>
</span><span id="PseudoDifferentialOperator-250"><a href="#PseudoDifferentialOperator-250"><span class="linenos"> 250</span></a>            <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-251"><a href="#PseudoDifferentialOperator-251"><span class="linenos"> 251</span></a>        
</span><span id="PseudoDifferentialOperator-252"><a href="#PseudoDifferentialOperator-252"><span class="linenos"> 252</span></a>        <span class="c1"># Case 3: Dirichlet BC (non-periodic)</span>
</span><span id="PseudoDifferentialOperator-253"><a href="#PseudoDifferentialOperator-253"><span class="linenos"> 253</span></a>        <span class="k">elif</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-254"><a href="#PseudoDifferentialOperator-254"><span class="linenos"> 254</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol_func</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-255"><a href="#PseudoDifferentialOperator-255"><span class="linenos"> 255</span></a>            
</span><span id="PseudoDifferentialOperator-256"><a href="#PseudoDifferentialOperator-256"><span class="linenos"> 256</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-257"><a href="#PseudoDifferentialOperator-257"><span class="linenos"> 257</span></a>                <span class="k">return</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-258"><a href="#PseudoDifferentialOperator-258"><span class="linenos"> 258</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-259"><a href="#PseudoDifferentialOperator-259"><span class="linenos"> 259</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-260"><a href="#PseudoDifferentialOperator-260"><span class="linenos"> 260</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-261"><a href="#PseudoDifferentialOperator-261"><span class="linenos"> 261</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">symbol_func</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-262"><a href="#PseudoDifferentialOperator-262"><span class="linenos"> 262</span></a>                    <span class="n">freq_window</span><span class="o">=</span><span class="n">freq_window</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-263"><a href="#PseudoDifferentialOperator-263"><span class="linenos"> 263</span></a>                    <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-264"><a href="#PseudoDifferentialOperator-264"><span class="linenos"> 264</span></a>                    <span class="n">space_window</span><span class="o">=</span><span class="n">space_window</span>
</span><span id="PseudoDifferentialOperator-265"><a href="#PseudoDifferentialOperator-265"><span class="linenos"> 265</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-266"><a href="#PseudoDifferentialOperator-266"><span class="linenos"> 266</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-267"><a href="#PseudoDifferentialOperator-267"><span class="linenos"> 267</span></a>                <span class="k">return</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-268"><a href="#PseudoDifferentialOperator-268"><span class="linenos"> 268</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-269"><a href="#PseudoDifferentialOperator-269"><span class="linenos"> 269</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-270"><a href="#PseudoDifferentialOperator-270"><span class="linenos"> 270</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-271"><a href="#PseudoDifferentialOperator-271"><span class="linenos"> 271</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">symbol_func</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-272"><a href="#PseudoDifferentialOperator-272"><span class="linenos"> 272</span></a>                    <span class="n">freq_window</span><span class="o">=</span><span class="n">freq_window</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-273"><a href="#PseudoDifferentialOperator-273"><span class="linenos"> 273</span></a>                    <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-274"><a href="#PseudoDifferentialOperator-274"><span class="linenos"> 274</span></a>                    <span class="n">space_window</span><span class="o">=</span><span class="n">space_window</span>
</span><span id="PseudoDifferentialOperator-275"><a href="#PseudoDifferentialOperator-275"><span class="linenos"> 275</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-276"><a href="#PseudoDifferentialOperator-276"><span class="linenos"> 276</span></a>        
</span><span id="PseudoDifferentialOperator-277"><a href="#PseudoDifferentialOperator-277"><span class="linenos"> 277</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-278"><a href="#PseudoDifferentialOperator-278"><span class="linenos"> 278</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid boundary condition &#39;</span><span class="si">{</span><span class="n">boundary_condition</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-279"><a href="#PseudoDifferentialOperator-279"><span class="linenos"> 279</span></a>    
</span><span id="PseudoDifferentialOperator-280"><a href="#PseudoDifferentialOperator-280"><span class="linenos"> 280</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_spatial_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-281"><a href="#PseudoDifferentialOperator-281"><span class="linenos"> 281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-282"><a href="#PseudoDifferentialOperator-282"><span class="linenos"> 282</span></a><span class="sd">        Check if the symbol depends on spatial variables.</span>
</span><span id="PseudoDifferentialOperator-283"><a href="#PseudoDifferentialOperator-283"><span class="linenos"> 283</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-284"><a href="#PseudoDifferentialOperator-284"><span class="linenos"> 284</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-285"><a href="#PseudoDifferentialOperator-285"><span class="linenos"> 285</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-286"><a href="#PseudoDifferentialOperator-286"><span class="linenos"> 286</span></a><span class="sd">        bool</span>
</span><span id="PseudoDifferentialOperator-287"><a href="#PseudoDifferentialOperator-287"><span class="linenos"> 287</span></a><span class="sd">            True if symbol depends on x (or x, y)</span>
</span><span id="PseudoDifferentialOperator-288"><a href="#PseudoDifferentialOperator-288"><span class="linenos"> 288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-289"><a href="#PseudoDifferentialOperator-289"><span class="linenos"> 289</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-290"><a href="#PseudoDifferentialOperator-290"><span class="linenos"> 290</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-291"><a href="#PseudoDifferentialOperator-291"><span class="linenos"> 291</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-292"><a href="#PseudoDifferentialOperator-292"><span class="linenos"> 292</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-293"><a href="#PseudoDifferentialOperator-293"><span class="linenos"> 293</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-294"><a href="#PseudoDifferentialOperator-294"><span class="linenos"> 294</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-295"><a href="#PseudoDifferentialOperator-295"><span class="linenos"> 295</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="PseudoDifferentialOperator-296"><a href="#PseudoDifferentialOperator-296"><span class="linenos"> 296</span></a>    
</span><span id="PseudoDifferentialOperator-297"><a href="#PseudoDifferentialOperator-297"><span class="linenos"> 297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_symbol_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-298"><a href="#PseudoDifferentialOperator-298"><span class="linenos"> 298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-299"><a href="#PseudoDifferentialOperator-299"><span class="linenos"> 299</span></a><span class="sd">        Get a lambdified version of the symbol.</span>
</span><span id="PseudoDifferentialOperator-300"><a href="#PseudoDifferentialOperator-300"><span class="linenos"> 300</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-301"><a href="#PseudoDifferentialOperator-301"><span class="linenos"> 301</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-302"><a href="#PseudoDifferentialOperator-302"><span class="linenos"> 302</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-303"><a href="#PseudoDifferentialOperator-303"><span class="linenos"> 303</span></a><span class="sd">        callable</span>
</span><span id="PseudoDifferentialOperator-304"><a href="#PseudoDifferentialOperator-304"><span class="linenos"> 304</span></a><span class="sd">            Lambdified symbol function</span>
</span><span id="PseudoDifferentialOperator-305"><a href="#PseudoDifferentialOperator-305"><span class="linenos"> 305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-306"><a href="#PseudoDifferentialOperator-306"><span class="linenos"> 306</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-307"><a href="#PseudoDifferentialOperator-307"><span class="linenos"> 307</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-308"><a href="#PseudoDifferentialOperator-308"><span class="linenos"> 308</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-309"><a href="#PseudoDifferentialOperator-309"><span class="linenos"> 309</span></a>            <span class="k">return</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-310"><a href="#PseudoDifferentialOperator-310"><span class="linenos"> 310</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-311"><a href="#PseudoDifferentialOperator-311"><span class="linenos"> 311</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-312"><a href="#PseudoDifferentialOperator-312"><span class="linenos"> 312</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-313"><a href="#PseudoDifferentialOperator-313"><span class="linenos"> 313</span></a>            <span class="k">return</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-314"><a href="#PseudoDifferentialOperator-314"><span class="linenos"> 314</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-315"><a href="#PseudoDifferentialOperator-315"><span class="linenos"> 315</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-316"><a href="#PseudoDifferentialOperator-316"><span class="linenos"> 316</span></a>    
</span><span id="PseudoDifferentialOperator-317"><a href="#PseudoDifferentialOperator-317"><span class="linenos"> 317</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_constant_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">dealiasing_mask</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-318"><a href="#PseudoDifferentialOperator-318"><span class="linenos"> 318</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-319"><a href="#PseudoDifferentialOperator-319"><span class="linenos"> 319</span></a><span class="sd">        Apply a constant-coefficient pseudo-differential operator in Fourier space.</span>
</span><span id="PseudoDifferentialOperator-320"><a href="#PseudoDifferentialOperator-320"><span class="linenos"> 320</span></a>
</span><span id="PseudoDifferentialOperator-321"><a href="#PseudoDifferentialOperator-321"><span class="linenos"> 321</span></a><span class="sd">        This method assumes the symbol is diagonal in the Fourier basis and acts as a </span>
</span><span id="PseudoDifferentialOperator-322"><a href="#PseudoDifferentialOperator-322"><span class="linenos"> 322</span></a><span class="sd">        multiplication operator. It performs the operation:</span>
</span><span id="PseudoDifferentialOperator-323"><a href="#PseudoDifferentialOperator-323"><span class="linenos"> 323</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-324"><a href="#PseudoDifferentialOperator-324"><span class="linenos"> 324</span></a><span class="sd">            (ψu)(x) = 𝓕⁻¹[ -σ(k) · 𝓕[u](k) ]</span>
</span><span id="PseudoDifferentialOperator-325"><a href="#PseudoDifferentialOperator-325"><span class="linenos"> 325</span></a>
</span><span id="PseudoDifferentialOperator-326"><a href="#PseudoDifferentialOperator-326"><span class="linenos"> 326</span></a><span class="sd">        where:</span>
</span><span id="PseudoDifferentialOperator-327"><a href="#PseudoDifferentialOperator-327"><span class="linenos"> 327</span></a><span class="sd">        - σ(k) is the combined pseudo-differential operator symbol</span>
</span><span id="PseudoDifferentialOperator-328"><a href="#PseudoDifferentialOperator-328"><span class="linenos"> 328</span></a><span class="sd">        - 𝓕 denotes the forward Fourier transform</span>
</span><span id="PseudoDifferentialOperator-329"><a href="#PseudoDifferentialOperator-329"><span class="linenos"> 329</span></a><span class="sd">        - 𝓕⁻¹ denotes the inverse Fourier transform</span>
</span><span id="PseudoDifferentialOperator-330"><a href="#PseudoDifferentialOperator-330"><span class="linenos"> 330</span></a>
</span><span id="PseudoDifferentialOperator-331"><a href="#PseudoDifferentialOperator-331"><span class="linenos"> 331</span></a><span class="sd">        The dealiasing mask is applied before returning to physical space.</span>
</span><span id="PseudoDifferentialOperator-332"><a href="#PseudoDifferentialOperator-332"><span class="linenos"> 332</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-333"><a href="#PseudoDifferentialOperator-333"><span class="linenos"> 333</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-334"><a href="#PseudoDifferentialOperator-334"><span class="linenos"> 334</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-335"><a href="#PseudoDifferentialOperator-335"><span class="linenos"> 335</span></a><span class="sd">        u : ndarray</span>
</span><span id="PseudoDifferentialOperator-336"><a href="#PseudoDifferentialOperator-336"><span class="linenos"> 336</span></a><span class="sd">            Input function</span>
</span><span id="PseudoDifferentialOperator-337"><a href="#PseudoDifferentialOperator-337"><span class="linenos"> 337</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-338"><a href="#PseudoDifferentialOperator-338"><span class="linenos"> 338</span></a><span class="sd">            Spatial grid (x)</span>
</span><span id="PseudoDifferentialOperator-339"><a href="#PseudoDifferentialOperator-339"><span class="linenos"> 339</span></a><span class="sd">        kx : ndarray</span>
</span><span id="PseudoDifferentialOperator-340"><a href="#PseudoDifferentialOperator-340"><span class="linenos"> 340</span></a><span class="sd">            Frequency grid (x)</span>
</span><span id="PseudoDifferentialOperator-341"><a href="#PseudoDifferentialOperator-341"><span class="linenos"> 341</span></a><span class="sd">        y_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-342"><a href="#PseudoDifferentialOperator-342"><span class="linenos"> 342</span></a><span class="sd">            Spatial grid (y, for 2D)</span>
</span><span id="PseudoDifferentialOperator-343"><a href="#PseudoDifferentialOperator-343"><span class="linenos"> 343</span></a><span class="sd">        ky : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-344"><a href="#PseudoDifferentialOperator-344"><span class="linenos"> 344</span></a><span class="sd">            Frequency grid (y, for 2D)</span>
</span><span id="PseudoDifferentialOperator-345"><a href="#PseudoDifferentialOperator-345"><span class="linenos"> 345</span></a><span class="sd">        dealiasing_mask : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-346"><a href="#PseudoDifferentialOperator-346"><span class="linenos"> 346</span></a><span class="sd">            Dealiasing mask</span>
</span><span id="PseudoDifferentialOperator-347"><a href="#PseudoDifferentialOperator-347"><span class="linenos"> 347</span></a><span class="sd">            </span>
</span><span id="PseudoDifferentialOperator-348"><a href="#PseudoDifferentialOperator-348"><span class="linenos"> 348</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-349"><a href="#PseudoDifferentialOperator-349"><span class="linenos"> 349</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-350"><a href="#PseudoDifferentialOperator-350"><span class="linenos"> 350</span></a><span class="sd">        ndarray</span>
</span><span id="PseudoDifferentialOperator-351"><a href="#PseudoDifferentialOperator-351"><span class="linenos"> 351</span></a><span class="sd">            Result</span>
</span><span id="PseudoDifferentialOperator-352"><a href="#PseudoDifferentialOperator-352"><span class="linenos"> 352</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-353"><a href="#PseudoDifferentialOperator-353"><span class="linenos"> 353</span></a>        <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-354"><a href="#PseudoDifferentialOperator-354"><span class="linenos"> 354</span></a>        
</span><span id="PseudoDifferentialOperator-355"><a href="#PseudoDifferentialOperator-355"><span class="linenos"> 355</span></a>        <span class="c1"># Evaluate symbol at grid points</span>
</span><span id="PseudoDifferentialOperator-356"><a href="#PseudoDifferentialOperator-356"><span class="linenos"> 356</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-357"><a href="#PseudoDifferentialOperator-357"><span class="linenos"> 357</span></a>            <span class="n">X_dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">kx</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-358"><a href="#PseudoDifferentialOperator-358"><span class="linenos"> 358</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X_dummy</span><span class="p">,</span> <span class="n">kx</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-359"><a href="#PseudoDifferentialOperator-359"><span class="linenos"> 359</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-360"><a href="#PseudoDifferentialOperator-360"><span class="linenos"> 360</span></a>            <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-361"><a href="#PseudoDifferentialOperator-361"><span class="linenos"> 361</span></a>            <span class="n">X_dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">KX</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-362"><a href="#PseudoDifferentialOperator-362"><span class="linenos"> 362</span></a>            <span class="n">Y_dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-363"><a href="#PseudoDifferentialOperator-363"><span class="linenos"> 363</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X_dummy</span><span class="p">,</span> <span class="n">Y_dummy</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-364"><a href="#PseudoDifferentialOperator-364"><span class="linenos"> 364</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-365"><a href="#PseudoDifferentialOperator-365"><span class="linenos"> 365</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-366"><a href="#PseudoDifferentialOperator-366"><span class="linenos"> 366</span></a>        
</span><span id="PseudoDifferentialOperator-367"><a href="#PseudoDifferentialOperator-367"><span class="linenos"> 367</span></a>        <span class="c1"># Apply symbol</span>
</span><span id="PseudoDifferentialOperator-368"><a href="#PseudoDifferentialOperator-368"><span class="linenos"> 368</span></a>        <span class="n">u_hat</span> <span class="o">*=</span> <span class="n">symbol_vals</span>
</span><span id="PseudoDifferentialOperator-369"><a href="#PseudoDifferentialOperator-369"><span class="linenos"> 369</span></a>        
</span><span id="PseudoDifferentialOperator-370"><a href="#PseudoDifferentialOperator-370"><span class="linenos"> 370</span></a>        <span class="c1"># Apply dealiasing</span>
</span><span id="PseudoDifferentialOperator-371"><a href="#PseudoDifferentialOperator-371"><span class="linenos"> 371</span></a>        <span class="k">if</span> <span class="n">dealiasing_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-372"><a href="#PseudoDifferentialOperator-372"><span class="linenos"> 372</span></a>            <span class="n">u_hat</span> <span class="o">*=</span> <span class="n">dealiasing_mask</span>
</span><span id="PseudoDifferentialOperator-373"><a href="#PseudoDifferentialOperator-373"><span class="linenos"> 373</span></a>        
</span><span id="PseudoDifferentialOperator-374"><a href="#PseudoDifferentialOperator-374"><span class="linenos"> 374</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-375"><a href="#PseudoDifferentialOperator-375"><span class="linenos"> 375</span></a>
</span><span id="PseudoDifferentialOperator-376"><a href="#PseudoDifferentialOperator-376"><span class="linenos"> 376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">principal_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-377"><a href="#PseudoDifferentialOperator-377"><span class="linenos"> 377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-378"><a href="#PseudoDifferentialOperator-378"><span class="linenos"> 378</span></a><span class="sd">        Compute the leading homogeneous component of the pseudo-differential symbol.</span>
</span><span id="PseudoDifferentialOperator-379"><a href="#PseudoDifferentialOperator-379"><span class="linenos"> 379</span></a>
</span><span id="PseudoDifferentialOperator-380"><a href="#PseudoDifferentialOperator-380"><span class="linenos"> 380</span></a><span class="sd">        This method extracts the principal part of the symbol, which is the dominant </span>
</span><span id="PseudoDifferentialOperator-381"><a href="#PseudoDifferentialOperator-381"><span class="linenos"> 381</span></a><span class="sd">        term under high-frequency asymptotics (|ξ| → ∞). The expansion is performed </span>
</span><span id="PseudoDifferentialOperator-382"><a href="#PseudoDifferentialOperator-382"><span class="linenos"> 382</span></a><span class="sd">        in polar coordinates for 2D symbols to maintain rotational symmetry, then </span>
</span><span id="PseudoDifferentialOperator-383"><a href="#PseudoDifferentialOperator-383"><span class="linenos"> 383</span></a><span class="sd">        converted back to Cartesian form.</span>
</span><span id="PseudoDifferentialOperator-384"><a href="#PseudoDifferentialOperator-384"><span class="linenos"> 384</span></a>
</span><span id="PseudoDifferentialOperator-385"><a href="#PseudoDifferentialOperator-385"><span class="linenos"> 385</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-386"><a href="#PseudoDifferentialOperator-386"><span class="linenos"> 386</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-387"><a href="#PseudoDifferentialOperator-387"><span class="linenos"> 387</span></a><span class="sd">        order : int</span>
</span><span id="PseudoDifferentialOperator-388"><a href="#PseudoDifferentialOperator-388"><span class="linenos"> 388</span></a><span class="sd">            Order of the asymptotic expansion in powers of 1/ρ, where ρ = |ξ| in 1D </span>
</span><span id="PseudoDifferentialOperator-389"><a href="#PseudoDifferentialOperator-389"><span class="linenos"> 389</span></a><span class="sd">            or ρ = sqrt(ξ² + η²) in 2D. Only the leading-order term is returned.</span>
</span><span id="PseudoDifferentialOperator-390"><a href="#PseudoDifferentialOperator-390"><span class="linenos"> 390</span></a>
</span><span id="PseudoDifferentialOperator-391"><a href="#PseudoDifferentialOperator-391"><span class="linenos"> 391</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-392"><a href="#PseudoDifferentialOperator-392"><span class="linenos"> 392</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-393"><a href="#PseudoDifferentialOperator-393"><span class="linenos"> 393</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-394"><a href="#PseudoDifferentialOperator-394"><span class="linenos"> 394</span></a><span class="sd">            The principal symbol component, homogeneous of degree `m - order`, where </span>
</span><span id="PseudoDifferentialOperator-395"><a href="#PseudoDifferentialOperator-395"><span class="linenos"> 395</span></a><span class="sd">            `m` is the original symbol&#39;s order.</span>
</span><span id="PseudoDifferentialOperator-396"><a href="#PseudoDifferentialOperator-396"><span class="linenos"> 396</span></a>
</span><span id="PseudoDifferentialOperator-397"><a href="#PseudoDifferentialOperator-397"><span class="linenos"> 397</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator-398"><a href="#PseudoDifferentialOperator-398"><span class="linenos"> 398</span></a><span class="sd">        - In 1D, uses direct series expansion in ξ.</span>
</span><span id="PseudoDifferentialOperator-399"><a href="#PseudoDifferentialOperator-399"><span class="linenos"> 399</span></a><span class="sd">        - In 2D, expands in radial variable ρ while preserving angular dependence.</span>
</span><span id="PseudoDifferentialOperator-400"><a href="#PseudoDifferentialOperator-400"><span class="linenos"> 400</span></a><span class="sd">        - Useful for microlocal analysis and constructing parametrices.</span>
</span><span id="PseudoDifferentialOperator-401"><a href="#PseudoDifferentialOperator-401"><span class="linenos"> 401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-402"><a href="#PseudoDifferentialOperator-402"><span class="linenos"> 402</span></a>
</span><span id="PseudoDifferentialOperator-403"><a href="#PseudoDifferentialOperator-403"><span class="linenos"> 403</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-404"><a href="#PseudoDifferentialOperator-404"><span class="linenos"> 404</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-405"><a href="#PseudoDifferentialOperator-405"><span class="linenos"> 405</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-406"><a href="#PseudoDifferentialOperator-406"><span class="linenos"> 406</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">series</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">())</span>
</span><span id="PseudoDifferentialOperator-407"><a href="#PseudoDifferentialOperator-407"><span class="linenos"> 407</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-408"><a href="#PseudoDifferentialOperator-408"><span class="linenos"> 408</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-409"><a href="#PseudoDifferentialOperator-409"><span class="linenos"> 409</span></a>            <span class="c1"># Homogeneous radial expansion: we set (ξ, η) = ρ (cosθ, sinθ)</span>
</span><span id="PseudoDifferentialOperator-410"><a href="#PseudoDifferentialOperator-410"><span class="linenos"> 410</span></a>            <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;rho theta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-411"><a href="#PseudoDifferentialOperator-411"><span class="linenos"> 411</span></a>            <span class="n">p_rho</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">eta</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)})</span>
</span><span id="PseudoDifferentialOperator-412"><a href="#PseudoDifferentialOperator-412"><span class="linenos"> 412</span></a>            <span class="n">expansion</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">p_rho</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-413"><a href="#PseudoDifferentialOperator-413"><span class="linenos"> 413</span></a>            <span class="c1"># Revert back to (ξ, η)</span>
</span><span id="PseudoDifferentialOperator-414"><a href="#PseudoDifferentialOperator-414"><span class="linenos"> 414</span></a>            <span class="n">expansion_cart</span> <span class="o">=</span> <span class="n">expansion</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">rho</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-415"><a href="#PseudoDifferentialOperator-415"><span class="linenos"> 415</span></a>                                             <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">xi</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-416"><a href="#PseudoDifferentialOperator-416"><span class="linenos"> 416</span></a>                                             <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">)})</span>
</span><span id="PseudoDifferentialOperator-417"><a href="#PseudoDifferentialOperator-417"><span class="linenos"> 417</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expansion_cart</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-418"><a href="#PseudoDifferentialOperator-418"><span class="linenos"> 418</span></a>                       
</span><span id="PseudoDifferentialOperator-419"><a href="#PseudoDifferentialOperator-419"><span class="linenos"> 419</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_homogeneous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-420"><a href="#PseudoDifferentialOperator-420"><span class="linenos"> 420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-421"><a href="#PseudoDifferentialOperator-421"><span class="linenos"> 421</span></a><span class="sd">        Check whether the symbol is homogeneous in the frequency variables.</span>
</span><span id="PseudoDifferentialOperator-422"><a href="#PseudoDifferentialOperator-422"><span class="linenos"> 422</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-423"><a href="#PseudoDifferentialOperator-423"><span class="linenos"> 423</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-424"><a href="#PseudoDifferentialOperator-424"><span class="linenos"> 424</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-425"><a href="#PseudoDifferentialOperator-425"><span class="linenos"> 425</span></a><span class="sd">        (bool, Rational or float or None)</span>
</span><span id="PseudoDifferentialOperator-426"><a href="#PseudoDifferentialOperator-426"><span class="linenos"> 426</span></a><span class="sd">            Tuple (is_homogeneous, degree) where:</span>
</span><span id="PseudoDifferentialOperator-427"><a href="#PseudoDifferentialOperator-427"><span class="linenos"> 427</span></a><span class="sd">            - is_homogeneous: True if the symbol satisfies p(λξ, λη) = λ^m * p(ξ, η)</span>
</span><span id="PseudoDifferentialOperator-428"><a href="#PseudoDifferentialOperator-428"><span class="linenos"> 428</span></a><span class="sd">            - degree: the detected degree m if homogeneous, or None</span>
</span><span id="PseudoDifferentialOperator-429"><a href="#PseudoDifferentialOperator-429"><span class="linenos"> 429</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-430"><a href="#PseudoDifferentialOperator-430"><span class="linenos"> 430</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">expand</span><span class="p">,</span> <span class="n">Eq</span>
</span><span id="PseudoDifferentialOperator-431"><a href="#PseudoDifferentialOperator-431"><span class="linenos"> 431</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator-432"><a href="#PseudoDifferentialOperator-432"><span class="linenos"> 432</span></a>    
</span><span id="PseudoDifferentialOperator-433"><a href="#PseudoDifferentialOperator-433"><span class="linenos"> 433</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-434"><a href="#PseudoDifferentialOperator-434"><span class="linenos"> 434</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-435"><a href="#PseudoDifferentialOperator-435"><span class="linenos"> 435</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-436"><a href="#PseudoDifferentialOperator-436"><span class="linenos"> 436</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-437"><a href="#PseudoDifferentialOperator-437"><span class="linenos"> 437</span></a>            <span class="n">p_scaled</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-438"><a href="#PseudoDifferentialOperator-438"><span class="linenos"> 438</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p_scaled</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-439"><a href="#PseudoDifferentialOperator-439"><span class="linenos"> 439</span></a>            <span class="k">if</span> <span class="n">ratio</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-440"><a href="#PseudoDifferentialOperator-440"><span class="linenos"> 440</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-441"><a href="#PseudoDifferentialOperator-441"><span class="linenos"> 441</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-442"><a href="#PseudoDifferentialOperator-442"><span class="linenos"> 442</span></a>                <span class="n">deg</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-443"><a href="#PseudoDifferentialOperator-443"><span class="linenos"> 443</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">deg</span>
</span><span id="PseudoDifferentialOperator-444"><a href="#PseudoDifferentialOperator-444"><span class="linenos"> 444</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-445"><a href="#PseudoDifferentialOperator-445"><span class="linenos"> 445</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-446"><a href="#PseudoDifferentialOperator-446"><span class="linenos"> 446</span></a>    
</span><span id="PseudoDifferentialOperator-447"><a href="#PseudoDifferentialOperator-447"><span class="linenos"> 447</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-448"><a href="#PseudoDifferentialOperator-448"><span class="linenos"> 448</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-449"><a href="#PseudoDifferentialOperator-449"><span class="linenos"> 449</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-450"><a href="#PseudoDifferentialOperator-450"><span class="linenos"> 450</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-451"><a href="#PseudoDifferentialOperator-451"><span class="linenos"> 451</span></a>            <span class="n">p_scaled</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">l</span> <span class="o">*</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">l</span> <span class="o">*</span> <span class="n">eta</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator-452"><a href="#PseudoDifferentialOperator-452"><span class="linenos"> 452</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p_scaled</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-453"><a href="#PseudoDifferentialOperator-453"><span class="linenos"> 453</span></a>            <span class="c1"># If ratio == l**m with no (xi, eta) left, it&#39;s homogeneous</span>
</span><span id="PseudoDifferentialOperator-454"><a href="#PseudoDifferentialOperator-454"><span class="linenos"> 454</span></a>            <span class="k">if</span> <span class="n">ratio</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-455"><a href="#PseudoDifferentialOperator-455"><span class="linenos"> 455</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-456"><a href="#PseudoDifferentialOperator-456"><span class="linenos"> 456</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-457"><a href="#PseudoDifferentialOperator-457"><span class="linenos"> 457</span></a>                <span class="n">base</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-458"><a href="#PseudoDifferentialOperator-458"><span class="linenos"> 458</span></a>                <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-459"><a href="#PseudoDifferentialOperator-459"><span class="linenos"> 459</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exp</span>
</span><span id="PseudoDifferentialOperator-460"><a href="#PseudoDifferentialOperator-460"><span class="linenos"> 460</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-461"><a href="#PseudoDifferentialOperator-461"><span class="linenos"> 461</span></a>                <span class="k">pass</span>
</span><span id="PseudoDifferentialOperator-462"><a href="#PseudoDifferentialOperator-462"><span class="linenos"> 462</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-463"><a href="#PseudoDifferentialOperator-463"><span class="linenos"> 463</span></a>
</span><span id="PseudoDifferentialOperator-464"><a href="#PseudoDifferentialOperator-464"><span class="linenos"> 464</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symbol_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-465"><a href="#PseudoDifferentialOperator-465"><span class="linenos"> 465</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-466"><a href="#PseudoDifferentialOperator-466"><span class="linenos"> 466</span></a><span class="sd">        Estimate the homogeneity order of the pseudo-differential symbol in high-frequency asymptotics.</span>
</span><span id="PseudoDifferentialOperator-467"><a href="#PseudoDifferentialOperator-467"><span class="linenos"> 467</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-468"><a href="#PseudoDifferentialOperator-468"><span class="linenos"> 468</span></a><span class="sd">        This method attempts to determine the leading-order behavior of the symbol p(x, ξ) or p(x, y, ξ, η)</span>
</span><span id="PseudoDifferentialOperator-469"><a href="#PseudoDifferentialOperator-469"><span class="linenos"> 469</span></a><span class="sd">        as |ξ| → ∞ (in 1D) or |(ξ, η)| → ∞ (in 2D). The returned value represents the asymptotic growth or decay rate,</span>
</span><span id="PseudoDifferentialOperator-470"><a href="#PseudoDifferentialOperator-470"><span class="linenos"> 470</span></a><span class="sd">        which is essential for understanding the regularity and mapping properties of the corresponding operator.</span>
</span><span id="PseudoDifferentialOperator-471"><a href="#PseudoDifferentialOperator-471"><span class="linenos"> 471</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-472"><a href="#PseudoDifferentialOperator-472"><span class="linenos"> 472</span></a><span class="sd">        The function uses symbolic preprocessing to ensure proper factorization of frequency variables,</span>
</span><span id="PseudoDifferentialOperator-473"><a href="#PseudoDifferentialOperator-473"><span class="linenos"> 473</span></a><span class="sd">        especially in sqrt and power expressions, to avoid erroneous order detection (e.g., due to hidden scaling).</span>
</span><span id="PseudoDifferentialOperator-474"><a href="#PseudoDifferentialOperator-474"><span class="linenos"> 474</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-475"><a href="#PseudoDifferentialOperator-475"><span class="linenos"> 475</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-476"><a href="#PseudoDifferentialOperator-476"><span class="linenos"> 476</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-477"><a href="#PseudoDifferentialOperator-477"><span class="linenos"> 477</span></a><span class="sd">        max_order : int, optional</span>
</span><span id="PseudoDifferentialOperator-478"><a href="#PseudoDifferentialOperator-478"><span class="linenos"> 478</span></a><span class="sd">            Maximum number of terms to consider in the series expansion. Default is 10.</span>
</span><span id="PseudoDifferentialOperator-479"><a href="#PseudoDifferentialOperator-479"><span class="linenos"> 479</span></a><span class="sd">        tol : float, optional</span>
</span><span id="PseudoDifferentialOperator-480"><a href="#PseudoDifferentialOperator-480"><span class="linenos"> 480</span></a><span class="sd">            Tolerance threshold for evaluating the coefficient magnitude. If the coefficient is too small,</span>
</span><span id="PseudoDifferentialOperator-481"><a href="#PseudoDifferentialOperator-481"><span class="linenos"> 481</span></a><span class="sd">            the detected order may be discarded. Default is 1e-3.</span>
</span><span id="PseudoDifferentialOperator-482"><a href="#PseudoDifferentialOperator-482"><span class="linenos"> 482</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-483"><a href="#PseudoDifferentialOperator-483"><span class="linenos"> 483</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-484"><a href="#PseudoDifferentialOperator-484"><span class="linenos"> 484</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-485"><a href="#PseudoDifferentialOperator-485"><span class="linenos"> 485</span></a><span class="sd">        float or None</span>
</span><span id="PseudoDifferentialOperator-486"><a href="#PseudoDifferentialOperator-486"><span class="linenos"> 486</span></a><span class="sd">            - If the symbol is homogeneous, returns its exact homogeneity degree as a float.</span>
</span><span id="PseudoDifferentialOperator-487"><a href="#PseudoDifferentialOperator-487"><span class="linenos"> 487</span></a><span class="sd">            - Otherwise, estimates the dominant asymptotic order from leading terms in the expansion.</span>
</span><span id="PseudoDifferentialOperator-488"><a href="#PseudoDifferentialOperator-488"><span class="linenos"> 488</span></a><span class="sd">            - Returns None if no valid order could be determined.</span>
</span><span id="PseudoDifferentialOperator-489"><a href="#PseudoDifferentialOperator-489"><span class="linenos"> 489</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-490"><a href="#PseudoDifferentialOperator-490"><span class="linenos"> 490</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-491"><a href="#PseudoDifferentialOperator-491"><span class="linenos"> 491</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-492"><a href="#PseudoDifferentialOperator-492"><span class="linenos"> 492</span></a><span class="sd">        - In 1D:</span>
</span><span id="PseudoDifferentialOperator-493"><a href="#PseudoDifferentialOperator-493"><span class="linenos"> 493</span></a><span class="sd">            Two strategies are used:</span>
</span><span id="PseudoDifferentialOperator-494"><a href="#PseudoDifferentialOperator-494"><span class="linenos"> 494</span></a><span class="sd">                1. Expand directly in xi at infinity.</span>
</span><span id="PseudoDifferentialOperator-495"><a href="#PseudoDifferentialOperator-495"><span class="linenos"> 495</span></a><span class="sd">                2. Substitute xi = 1/z and expand around z = 0.</span>
</span><span id="PseudoDifferentialOperator-496"><a href="#PseudoDifferentialOperator-496"><span class="linenos"> 496</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-497"><a href="#PseudoDifferentialOperator-497"><span class="linenos"> 497</span></a><span class="sd">        - In 2D:</span>
</span><span id="PseudoDifferentialOperator-498"><a href="#PseudoDifferentialOperator-498"><span class="linenos"> 498</span></a><span class="sd">            - Transform the symbol into polar coordinates: (xi, eta) = rho*(cos(theta), sin(theta)).</span>
</span><span id="PseudoDifferentialOperator-499"><a href="#PseudoDifferentialOperator-499"><span class="linenos"> 499</span></a><span class="sd">            - Expand in rho at infinity, then extract the leading term&#39;s power.</span>
</span><span id="PseudoDifferentialOperator-500"><a href="#PseudoDifferentialOperator-500"><span class="linenos"> 500</span></a><span class="sd">            - An alternative substitution using 1/z is also tried if the first method fails.</span>
</span><span id="PseudoDifferentialOperator-501"><a href="#PseudoDifferentialOperator-501"><span class="linenos"> 501</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-502"><a href="#PseudoDifferentialOperator-502"><span class="linenos"> 502</span></a><span class="sd">        - Preprocessing steps:</span>
</span><span id="PseudoDifferentialOperator-503"><a href="#PseudoDifferentialOperator-503"><span class="linenos"> 503</span></a><span class="sd">            - Sqrt expressions involving frequencies are rewritten to isolate the leading variable.</span>
</span><span id="PseudoDifferentialOperator-504"><a href="#PseudoDifferentialOperator-504"><span class="linenos"> 504</span></a><span class="sd">            - Power expressions are factored explicitly to ensure correct symbolic scaling.</span>
</span><span id="PseudoDifferentialOperator-505"><a href="#PseudoDifferentialOperator-505"><span class="linenos"> 505</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-506"><a href="#PseudoDifferentialOperator-506"><span class="linenos"> 506</span></a><span class="sd">        - If the symbol is not homogeneous, a warning is issued, and the result should be interpreted with care.</span>
</span><span id="PseudoDifferentialOperator-507"><a href="#PseudoDifferentialOperator-507"><span class="linenos"> 507</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-508"><a href="#PseudoDifferentialOperator-508"><span class="linenos"> 508</span></a><span class="sd">        - For non-homogeneous symbols, only the principal asymptotic term is considered.</span>
</span><span id="PseudoDifferentialOperator-509"><a href="#PseudoDifferentialOperator-509"><span class="linenos"> 509</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-510"><a href="#PseudoDifferentialOperator-510"><span class="linenos"> 510</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-511"><a href="#PseudoDifferentialOperator-511"><span class="linenos"> 511</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-512"><a href="#PseudoDifferentialOperator-512"><span class="linenos"> 512</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-513"><a href="#PseudoDifferentialOperator-513"><span class="linenos"> 513</span></a><span class="sd">            If the spatial dimension is neither 1 nor 2.</span>
</span><span id="PseudoDifferentialOperator-514"><a href="#PseudoDifferentialOperator-514"><span class="linenos"> 514</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-515"><a href="#PseudoDifferentialOperator-515"><span class="linenos"> 515</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="PseudoDifferentialOperator-516"><a href="#PseudoDifferentialOperator-516"><span class="linenos"> 516</span></a>            <span class="n">symbols</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">powdenest</span><span class="p">,</span> <span class="n">radsimp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-517"><a href="#PseudoDifferentialOperator-517"><span class="linenos"> 517</span></a>            <span class="n">expand</span><span class="p">,</span> <span class="n">expand_power_base</span>
</span><span id="PseudoDifferentialOperator-518"><a href="#PseudoDifferentialOperator-518"><span class="linenos"> 518</span></a>        <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-519"><a href="#PseudoDifferentialOperator-519"><span class="linenos"> 519</span></a>    
</span><span id="PseudoDifferentialOperator-520"><a href="#PseudoDifferentialOperator-520"><span class="linenos"> 520</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_sqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-521"><a href="#PseudoDifferentialOperator-521"><span class="linenos"> 521</span></a>            <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-522"><a href="#PseudoDifferentialOperator-522"><span class="linenos"> 522</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">sqrt</span> <span class="ow">and</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-523"><a href="#PseudoDifferentialOperator-523"><span class="linenos"> 523</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">freq</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">freq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-524"><a href="#PseudoDifferentialOperator-524"><span class="linenos"> 524</span></a>            <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-525"><a href="#PseudoDifferentialOperator-525"><span class="linenos"> 525</span></a>    
</span><span id="PseudoDifferentialOperator-526"><a href="#PseudoDifferentialOperator-526"><span class="linenos"> 526</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_power</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-527"><a href="#PseudoDifferentialOperator-527"><span class="linenos"> 527</span></a>            <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-528"><a href="#PseudoDifferentialOperator-528"><span class="linenos"> 528</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-529"><a href="#PseudoDifferentialOperator-529"><span class="linenos"> 529</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">freq</span><span class="o">**</span><span class="n">e</span><span class="o">.</span><span class="n">exp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">base</span> <span class="o">/</span> <span class="n">freq</span><span class="o">**</span><span class="n">e</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="n">e</span><span class="o">.</span><span class="n">exp</span>
</span><span id="PseudoDifferentialOperator-530"><a href="#PseudoDifferentialOperator-530"><span class="linenos"> 530</span></a>            <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-531"><a href="#PseudoDifferentialOperator-531"><span class="linenos"> 531</span></a>    
</span><span id="PseudoDifferentialOperator-532"><a href="#PseudoDifferentialOperator-532"><span class="linenos"> 532</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">vars_x</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-533"><a href="#PseudoDifferentialOperator-533"><span class="linenos"> 533</span></a>            <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-534"><a href="#PseudoDifferentialOperator-534"><span class="linenos"> 534</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-535"><a href="#PseudoDifferentialOperator-535"><span class="linenos"> 535</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">coeff</span><span class="o">.</span><span class="n">free_symbols</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_x</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-536"><a href="#PseudoDifferentialOperator-536"><span class="linenos"> 536</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Coefficient depends on spatial variables; ignoring&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-537"><a href="#PseudoDifferentialOperator-537"><span class="linenos"> 537</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-538"><a href="#PseudoDifferentialOperator-538"><span class="linenos"> 538</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-539"><a href="#PseudoDifferentialOperator-539"><span class="linenos"> 539</span></a>                <span class="n">coeff_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="o">.</span><span class="n">evalf</span><span class="p">()))</span>
</span><span id="PseudoDifferentialOperator-540"><a href="#PseudoDifferentialOperator-540"><span class="linenos"> 540</span></a>                <span class="k">if</span> <span class="n">coeff_val</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-541"><a href="#PseudoDifferentialOperator-541"><span class="linenos"> 541</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Coefficient too small (</span><span class="si">{</span><span class="n">coeff_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">tol</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-542"><a href="#PseudoDifferentialOperator-542"><span class="linenos"> 542</span></a>                    <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-543"><a href="#PseudoDifferentialOperator-543"><span class="linenos"> 543</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-544"><a href="#PseudoDifferentialOperator-544"><span class="linenos"> 544</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Coefficient evaluation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-545"><a href="#PseudoDifferentialOperator-545"><span class="linenos"> 545</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-546"><a href="#PseudoDifferentialOperator-546"><span class="linenos"> 546</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="k">if</span> <span class="n">power</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-547"><a href="#PseudoDifferentialOperator-547"><span class="linenos"> 547</span></a>    
</span><span id="PseudoDifferentialOperator-548"><a href="#PseudoDifferentialOperator-548"><span class="linenos"> 548</span></a>        <span class="c1"># Homogeneity check</span>
</span><span id="PseudoDifferentialOperator-549"><a href="#PseudoDifferentialOperator-549"><span class="linenos"> 549</span></a>        <span class="n">is_homog</span><span class="p">,</span> <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-550"><a href="#PseudoDifferentialOperator-550"><span class="linenos"> 550</span></a>        <span class="k">if</span> <span class="n">is_homog</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-551"><a href="#PseudoDifferentialOperator-551"><span class="linenos"> 551</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">degree</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-552"><a href="#PseudoDifferentialOperator-552"><span class="linenos"> 552</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-553"><a href="#PseudoDifferentialOperator-553"><span class="linenos"> 553</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ The symbol is not homogeneous. The asymptotic order is not well defined.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-554"><a href="#PseudoDifferentialOperator-554"><span class="linenos"> 554</span></a>    
</span><span id="PseudoDifferentialOperator-555"><a href="#PseudoDifferentialOperator-555"><span class="linenos"> 555</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-556"><a href="#PseudoDifferentialOperator-556"><span class="linenos"> 556</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-557"><a href="#PseudoDifferentialOperator-557"><span class="linenos"> 557</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-558"><a href="#PseudoDifferentialOperator-558"><span class="linenos"> 558</span></a>    
</span><span id="PseudoDifferentialOperator-559"><a href="#PseudoDifferentialOperator-559"><span class="linenos"> 559</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-560"><a href="#PseudoDifferentialOperator-560"><span class="linenos"> 560</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1D symbol_order - method 1&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-561"><a href="#PseudoDifferentialOperator-561"><span class="linenos"> 561</span></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">preprocess_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-562"><a href="#PseudoDifferentialOperator-562"><span class="linenos"> 562</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-563"><a href="#PseudoDifferentialOperator-563"><span class="linenos"> 563</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-564"><a href="#PseudoDifferentialOperator-564"><span class="linenos"> 564</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-565"><a href="#PseudoDifferentialOperator-565"><span class="linenos"> 565</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">xi</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-566"><a href="#PseudoDifferentialOperator-566"><span class="linenos"> 566</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-567"><a href="#PseudoDifferentialOperator-567"><span class="linenos"> 567</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-568"><a href="#PseudoDifferentialOperator-568"><span class="linenos"> 568</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-569"><a href="#PseudoDifferentialOperator-569"><span class="linenos"> 569</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-570"><a href="#PseudoDifferentialOperator-570"><span class="linenos"> 570</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-571"><a href="#PseudoDifferentialOperator-571"><span class="linenos"> 571</span></a>                    <span class="k">return</span> <span class="n">order</span>
</span><span id="PseudoDifferentialOperator-572"><a href="#PseudoDifferentialOperator-572"><span class="linenos"> 572</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-573"><a href="#PseudoDifferentialOperator-573"><span class="linenos"> 573</span></a>                <span class="k">pass</span>
</span><span id="PseudoDifferentialOperator-574"><a href="#PseudoDifferentialOperator-574"><span class="linenos"> 574</span></a>    
</span><span id="PseudoDifferentialOperator-575"><a href="#PseudoDifferentialOperator-575"><span class="linenos"> 575</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-576"><a href="#PseudoDifferentialOperator-576"><span class="linenos"> 576</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1D symbol_order - method 2&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-577"><a href="#PseudoDifferentialOperator-577"><span class="linenos"> 577</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-578"><a href="#PseudoDifferentialOperator-578"><span class="linenos"> 578</span></a>                <span class="n">expr_z</span> <span class="o">=</span> <span class="n">preprocess_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-579"><a href="#PseudoDifferentialOperator-579"><span class="linenos"> 579</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">expr_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-580"><a href="#PseudoDifferentialOperator-580"><span class="linenos"> 580</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-581"><a href="#PseudoDifferentialOperator-581"><span class="linenos"> 581</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-582"><a href="#PseudoDifferentialOperator-582"><span class="linenos"> 582</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">z</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-583"><a href="#PseudoDifferentialOperator-583"><span class="linenos"> 583</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-584"><a href="#PseudoDifferentialOperator-584"><span class="linenos"> 584</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-585"><a href="#PseudoDifferentialOperator-585"><span class="linenos"> 585</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-586"><a href="#PseudoDifferentialOperator-586"><span class="linenos"> 586</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-587"><a href="#PseudoDifferentialOperator-587"><span class="linenos"> 587</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-588"><a href="#PseudoDifferentialOperator-588"><span class="linenos"> 588</span></a>                    <span class="k">return</span> <span class="o">-</span><span class="n">order</span>
</span><span id="PseudoDifferentialOperator-589"><a href="#PseudoDifferentialOperator-589"><span class="linenos"> 589</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-590"><a href="#PseudoDifferentialOperator-590"><span class="linenos"> 590</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ fallback z failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-591"><a href="#PseudoDifferentialOperator-591"><span class="linenos"> 591</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-592"><a href="#PseudoDifferentialOperator-592"><span class="linenos"> 592</span></a>    
</span><span id="PseudoDifferentialOperator-593"><a href="#PseudoDifferentialOperator-593"><span class="linenos"> 593</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-594"><a href="#PseudoDifferentialOperator-594"><span class="linenos"> 594</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-595"><a href="#PseudoDifferentialOperator-595"><span class="linenos"> 595</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-596"><a href="#PseudoDifferentialOperator-596"><span class="linenos"> 596</span></a>            <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;rho theta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-597"><a href="#PseudoDifferentialOperator-597"><span class="linenos"> 597</span></a>    
</span><span id="PseudoDifferentialOperator-598"><a href="#PseudoDifferentialOperator-598"><span class="linenos"> 598</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-599"><a href="#PseudoDifferentialOperator-599"><span class="linenos"> 599</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D symbol_order - method 1&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-600"><a href="#PseudoDifferentialOperator-600"><span class="linenos"> 600</span></a>                <span class="n">p_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">eta</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)})</span>
</span><span id="PseudoDifferentialOperator-601"><a href="#PseudoDifferentialOperator-601"><span class="linenos"> 601</span></a>                <span class="n">p_rho</span> <span class="o">=</span> <span class="n">preprocess_power</span><span class="p">(</span><span class="n">preprocess_sqrt</span><span class="p">(</span><span class="n">p_rho</span><span class="p">,</span> <span class="n">rho</span><span class="p">),</span> <span class="n">rho</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-602"><a href="#PseudoDifferentialOperator-602"><span class="linenos"> 602</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">p_rho</span><span class="p">),</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-603"><a href="#PseudoDifferentialOperator-603"><span class="linenos"> 603</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">radsimp</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="PseudoDifferentialOperator-604"><a href="#PseudoDifferentialOperator-604"><span class="linenos"> 604</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-605"><a href="#PseudoDifferentialOperator-605"><span class="linenos"> 605</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">rho</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-606"><a href="#PseudoDifferentialOperator-606"><span class="linenos"> 606</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-607"><a href="#PseudoDifferentialOperator-607"><span class="linenos"> 607</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-608"><a href="#PseudoDifferentialOperator-608"><span class="linenos"> 608</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-609"><a href="#PseudoDifferentialOperator-609"><span class="linenos"> 609</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-610"><a href="#PseudoDifferentialOperator-610"><span class="linenos"> 610</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-611"><a href="#PseudoDifferentialOperator-611"><span class="linenos"> 611</span></a>                    <span class="k">return</span> <span class="n">order</span>
</span><span id="PseudoDifferentialOperator-612"><a href="#PseudoDifferentialOperator-612"><span class="linenos"> 612</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-613"><a href="#PseudoDifferentialOperator-613"><span class="linenos"> 613</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ polar expansion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-614"><a href="#PseudoDifferentialOperator-614"><span class="linenos"> 614</span></a>    
</span><span id="PseudoDifferentialOperator-615"><a href="#PseudoDifferentialOperator-615"><span class="linenos"> 615</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-616"><a href="#PseudoDifferentialOperator-616"><span class="linenos"> 616</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D symbol_order - method 2&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-617"><a href="#PseudoDifferentialOperator-617"><span class="linenos"> 617</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-618"><a href="#PseudoDifferentialOperator-618"><span class="linenos"> 618</span></a>                <span class="n">xi_eta</span> <span class="o">=</span> <span class="p">{</span><span class="n">xi</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">eta</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)}</span>
</span><span id="PseudoDifferentialOperator-619"><a href="#PseudoDifferentialOperator-619"><span class="linenos"> 619</span></a>                <span class="n">p_rho</span> <span class="o">=</span> <span class="n">preprocess_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi_eta</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-620"><a href="#PseudoDifferentialOperator-620"><span class="linenos"> 620</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">p_rho</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-621"><a href="#PseudoDifferentialOperator-621"><span class="linenos"> 621</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">radsimp</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="PseudoDifferentialOperator-622"><a href="#PseudoDifferentialOperator-622"><span class="linenos"> 622</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-623"><a href="#PseudoDifferentialOperator-623"><span class="linenos"> 623</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">z</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-624"><a href="#PseudoDifferentialOperator-624"><span class="linenos"> 624</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-625"><a href="#PseudoDifferentialOperator-625"><span class="linenos"> 625</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-626"><a href="#PseudoDifferentialOperator-626"><span class="linenos"> 626</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-627"><a href="#PseudoDifferentialOperator-627"><span class="linenos"> 627</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-628"><a href="#PseudoDifferentialOperator-628"><span class="linenos"> 628</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-629"><a href="#PseudoDifferentialOperator-629"><span class="linenos"> 629</span></a>                    <span class="k">return</span> <span class="o">-</span><span class="n">order</span>
</span><span id="PseudoDifferentialOperator-630"><a href="#PseudoDifferentialOperator-630"><span class="linenos"> 630</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-631"><a href="#PseudoDifferentialOperator-631"><span class="linenos"> 631</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ fallback z (2D) failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-632"><a href="#PseudoDifferentialOperator-632"><span class="linenos"> 632</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-633"><a href="#PseudoDifferentialOperator-633"><span class="linenos"> 633</span></a>    
</span><span id="PseudoDifferentialOperator-634"><a href="#PseudoDifferentialOperator-634"><span class="linenos"> 634</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-635"><a href="#PseudoDifferentialOperator-635"><span class="linenos"> 635</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-636"><a href="#PseudoDifferentialOperator-636"><span class="linenos"> 636</span></a>
</span><span id="PseudoDifferentialOperator-637"><a href="#PseudoDifferentialOperator-637"><span class="linenos"> 637</span></a>    
</span><span id="PseudoDifferentialOperator-638"><a href="#PseudoDifferentialOperator-638"><span class="linenos"> 638</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">asymptotic_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-639"><a href="#PseudoDifferentialOperator-639"><span class="linenos"> 639</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-640"><a href="#PseudoDifferentialOperator-640"><span class="linenos"> 640</span></a><span class="sd">        Compute the asymptotic expansion of the symbol as |ξ| → ∞ (high-frequency regime).</span>
</span><span id="PseudoDifferentialOperator-641"><a href="#PseudoDifferentialOperator-641"><span class="linenos"> 641</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-642"><a href="#PseudoDifferentialOperator-642"><span class="linenos"> 642</span></a><span class="sd">        This method expands the pseudo-differential symbol in inverse powers of the </span>
</span><span id="PseudoDifferentialOperator-643"><a href="#PseudoDifferentialOperator-643"><span class="linenos"> 643</span></a><span class="sd">        frequency variable(s), either in 1D or 2D. It handles both polynomial and </span>
</span><span id="PseudoDifferentialOperator-644"><a href="#PseudoDifferentialOperator-644"><span class="linenos"> 644</span></a><span class="sd">        exponential symbols by performing a series expansion in 1/|ξ| up to the specified order.</span>
</span><span id="PseudoDifferentialOperator-645"><a href="#PseudoDifferentialOperator-645"><span class="linenos"> 645</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-646"><a href="#PseudoDifferentialOperator-646"><span class="linenos"> 646</span></a><span class="sd">        The expansion is performed directly in Cartesian coordinates for 1D symbols.</span>
</span><span id="PseudoDifferentialOperator-647"><a href="#PseudoDifferentialOperator-647"><span class="linenos"> 647</span></a><span class="sd">        For 2D symbols, the method uses polar coordinates (ρ, θ) to perform the expansion </span>
</span><span id="PseudoDifferentialOperator-648"><a href="#PseudoDifferentialOperator-648"><span class="linenos"> 648</span></a><span class="sd">        at infinity in ρ, then converts the result back to Cartesian coordinates.</span>
</span><span id="PseudoDifferentialOperator-649"><a href="#PseudoDifferentialOperator-649"><span class="linenos"> 649</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-650"><a href="#PseudoDifferentialOperator-650"><span class="linenos"> 650</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-651"><a href="#PseudoDifferentialOperator-651"><span class="linenos"> 651</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-652"><a href="#PseudoDifferentialOperator-652"><span class="linenos"> 652</span></a><span class="sd">        order : int, optional</span>
</span><span id="PseudoDifferentialOperator-653"><a href="#PseudoDifferentialOperator-653"><span class="linenos"> 653</span></a><span class="sd">            Maximum order of the asymptotic expansion. Default is 3.</span>
</span><span id="PseudoDifferentialOperator-654"><a href="#PseudoDifferentialOperator-654"><span class="linenos"> 654</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-655"><a href="#PseudoDifferentialOperator-655"><span class="linenos"> 655</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-656"><a href="#PseudoDifferentialOperator-656"><span class="linenos"> 656</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-657"><a href="#PseudoDifferentialOperator-657"><span class="linenos"> 657</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-658"><a href="#PseudoDifferentialOperator-658"><span class="linenos"> 658</span></a><span class="sd">            The asymptotic expansion of the symbol up to the given order, expressed in Cartesian coordinates.</span>
</span><span id="PseudoDifferentialOperator-659"><a href="#PseudoDifferentialOperator-659"><span class="linenos"> 659</span></a><span class="sd">            If expansion fails, returns the original unexpanded symbol.</span>
</span><span id="PseudoDifferentialOperator-660"><a href="#PseudoDifferentialOperator-660"><span class="linenos"> 660</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-661"><a href="#PseudoDifferentialOperator-661"><span class="linenos"> 661</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator-662"><a href="#PseudoDifferentialOperator-662"><span class="linenos"> 662</span></a><span class="sd">        - In 1D: expansion is performed directly in terms of ξ.</span>
</span><span id="PseudoDifferentialOperator-663"><a href="#PseudoDifferentialOperator-663"><span class="linenos"> 663</span></a><span class="sd">        - In 2D: the symbol is first rewritten in polar coordinates (ρ,θ), expanded asymptotically </span>
</span><span id="PseudoDifferentialOperator-664"><a href="#PseudoDifferentialOperator-664"><span class="linenos"> 664</span></a><span class="sd">          in ρ → ∞, then converted back to Cartesian coordinates (ξ,η).</span>
</span><span id="PseudoDifferentialOperator-665"><a href="#PseudoDifferentialOperator-665"><span class="linenos"> 665</span></a><span class="sd">        - Handles special case when the symbol is an exponential function by expanding its argument.</span>
</span><span id="PseudoDifferentialOperator-666"><a href="#PseudoDifferentialOperator-666"><span class="linenos"> 666</span></a><span class="sd">        - Symbolic normalization is applied early (via `simplify`) for 2D expressions to improve convergence.</span>
</span><span id="PseudoDifferentialOperator-667"><a href="#PseudoDifferentialOperator-667"><span class="linenos"> 667</span></a><span class="sd">        - Robust to failures: catches exceptions and issues warnings instead of raising errors.</span>
</span><span id="PseudoDifferentialOperator-668"><a href="#PseudoDifferentialOperator-668"><span class="linenos"> 668</span></a><span class="sd">        - Final expression is simplified using `powdenest` and `expand` for improved readability.</span>
</span><span id="PseudoDifferentialOperator-669"><a href="#PseudoDifferentialOperator-669"><span class="linenos"> 669</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-670"><a href="#PseudoDifferentialOperator-670"><span class="linenos"> 670</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-671"><a href="#PseudoDifferentialOperator-671"><span class="linenos"> 671</span></a>    
</span><span id="PseudoDifferentialOperator-672"><a href="#PseudoDifferentialOperator-672"><span class="linenos"> 672</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-673"><a href="#PseudoDifferentialOperator-673"><span class="linenos"> 673</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-674"><a href="#PseudoDifferentialOperator-674"><span class="linenos"> 674</span></a>    
</span><span id="PseudoDifferentialOperator-675"><a href="#PseudoDifferentialOperator-675"><span class="linenos"> 675</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-676"><a href="#PseudoDifferentialOperator-676"><span class="linenos"> 676</span></a>                <span class="c1"># Case: exponential function</span>
</span><span id="PseudoDifferentialOperator-677"><a href="#PseudoDifferentialOperator-677"><span class="linenos"> 677</span></a>                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">exp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-678"><a href="#PseudoDifferentialOperator-678"><span class="linenos"> 678</span></a>                    <span class="n">arg</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-679"><a href="#PseudoDifferentialOperator-679"><span class="linenos"> 679</span></a>                    <span class="n">arg_series</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-680"><a href="#PseudoDifferentialOperator-680"><span class="linenos"> 680</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">arg_series</span><span class="p">)),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-681"><a href="#PseudoDifferentialOperator-681"><span class="linenos"> 681</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-682"><a href="#PseudoDifferentialOperator-682"><span class="linenos"> 682</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-683"><a href="#PseudoDifferentialOperator-683"><span class="linenos"> 683</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-684"><a href="#PseudoDifferentialOperator-684"><span class="linenos"> 684</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-685"><a href="#PseudoDifferentialOperator-685"><span class="linenos"> 685</span></a>    
</span><span id="PseudoDifferentialOperator-686"><a href="#PseudoDifferentialOperator-686"><span class="linenos"> 686</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-687"><a href="#PseudoDifferentialOperator-687"><span class="linenos"> 687</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: 1D expansion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-688"><a href="#PseudoDifferentialOperator-688"><span class="linenos"> 688</span></a>                <span class="k">return</span> <span class="n">p</span>
</span><span id="PseudoDifferentialOperator-689"><a href="#PseudoDifferentialOperator-689"><span class="linenos"> 689</span></a>    
</span><span id="PseudoDifferentialOperator-690"><a href="#PseudoDifferentialOperator-690"><span class="linenos"> 690</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-691"><a href="#PseudoDifferentialOperator-691"><span class="linenos"> 691</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-692"><a href="#PseudoDifferentialOperator-692"><span class="linenos"> 692</span></a>            <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;rho theta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-693"><a href="#PseudoDifferentialOperator-693"><span class="linenos"> 693</span></a>    
</span><span id="PseudoDifferentialOperator-694"><a href="#PseudoDifferentialOperator-694"><span class="linenos"> 694</span></a>            <span class="c1"># Normalize before substitution</span>
</span><span id="PseudoDifferentialOperator-695"><a href="#PseudoDifferentialOperator-695"><span class="linenos"> 695</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-696"><a href="#PseudoDifferentialOperator-696"><span class="linenos"> 696</span></a>    
</span><span id="PseudoDifferentialOperator-697"><a href="#PseudoDifferentialOperator-697"><span class="linenos"> 697</span></a>            <span class="c1"># Substitute polar coordinates</span>
</span><span id="PseudoDifferentialOperator-698"><a href="#PseudoDifferentialOperator-698"><span class="linenos"> 698</span></a>            <span class="n">p_polar</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span>
</span><span id="PseudoDifferentialOperator-699"><a href="#PseudoDifferentialOperator-699"><span class="linenos"> 699</span></a>                <span class="n">xi</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-700"><a href="#PseudoDifferentialOperator-700"><span class="linenos"> 700</span></a>                <span class="n">eta</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-701"><a href="#PseudoDifferentialOperator-701"><span class="linenos"> 701</span></a>            <span class="p">})</span>
</span><span id="PseudoDifferentialOperator-702"><a href="#PseudoDifferentialOperator-702"><span class="linenos"> 702</span></a>    
</span><span id="PseudoDifferentialOperator-703"><a href="#PseudoDifferentialOperator-703"><span class="linenos"> 703</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-704"><a href="#PseudoDifferentialOperator-704"><span class="linenos"> 704</span></a>                <span class="c1"># Handle exponentials</span>
</span><span id="PseudoDifferentialOperator-705"><a href="#PseudoDifferentialOperator-705"><span class="linenos"> 705</span></a>                <span class="k">if</span> <span class="n">p_polar</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">exp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_polar</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-706"><a href="#PseudoDifferentialOperator-706"><span class="linenos"> 706</span></a>                    <span class="n">arg</span> <span class="o">=</span> <span class="n">p_polar</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-707"><a href="#PseudoDifferentialOperator-707"><span class="linenos"> 707</span></a>                    <span class="n">arg_series</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-708"><a href="#PseudoDifferentialOperator-708"><span class="linenos"> 708</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">arg_series</span><span class="p">)),</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-709"><a href="#PseudoDifferentialOperator-709"><span class="linenos"> 709</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-710"><a href="#PseudoDifferentialOperator-710"><span class="linenos"> 710</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">p_polar</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-711"><a href="#PseudoDifferentialOperator-711"><span class="linenos"> 711</span></a>    
</span><span id="PseudoDifferentialOperator-712"><a href="#PseudoDifferentialOperator-712"><span class="linenos"> 712</span></a>                <span class="c1"># Convert back to Cartesian</span>
</span><span id="PseudoDifferentialOperator-713"><a href="#PseudoDifferentialOperator-713"><span class="linenos"> 713</span></a>                <span class="n">norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-714"><a href="#PseudoDifferentialOperator-714"><span class="linenos"> 714</span></a>                <span class="n">expansion_cart</span> <span class="o">=</span> <span class="n">expanded</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span>
</span><span id="PseudoDifferentialOperator-715"><a href="#PseudoDifferentialOperator-715"><span class="linenos"> 715</span></a>                    <span class="n">rho</span><span class="p">:</span> <span class="n">norm</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-716"><a href="#PseudoDifferentialOperator-716"><span class="linenos"> 716</span></a>                    <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">xi</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-717"><a href="#PseudoDifferentialOperator-717"><span class="linenos"> 717</span></a>                    <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">norm</span>
</span><span id="PseudoDifferentialOperator-718"><a href="#PseudoDifferentialOperator-718"><span class="linenos"> 718</span></a>                <span class="p">})</span>
</span><span id="PseudoDifferentialOperator-719"><a href="#PseudoDifferentialOperator-719"><span class="linenos"> 719</span></a>    
</span><span id="PseudoDifferentialOperator-720"><a href="#PseudoDifferentialOperator-720"><span class="linenos"> 720</span></a>                <span class="c1"># Final simplifications</span>
</span><span id="PseudoDifferentialOperator-721"><a href="#PseudoDifferentialOperator-721"><span class="linenos"> 721</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expansion_cart</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-722"><a href="#PseudoDifferentialOperator-722"><span class="linenos"> 722</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-723"><a href="#PseudoDifferentialOperator-723"><span class="linenos"> 723</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="PseudoDifferentialOperator-724"><a href="#PseudoDifferentialOperator-724"><span class="linenos"> 724</span></a>    
</span><span id="PseudoDifferentialOperator-725"><a href="#PseudoDifferentialOperator-725"><span class="linenos"> 725</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-726"><a href="#PseudoDifferentialOperator-726"><span class="linenos"> 726</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: 2D expansion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-727"><a href="#PseudoDifferentialOperator-727"><span class="linenos"> 727</span></a>                <span class="k">return</span> <span class="n">p</span>  
</span><span id="PseudoDifferentialOperator-728"><a href="#PseudoDifferentialOperator-728"><span class="linenos"> 728</span></a>            
</span><span id="PseudoDifferentialOperator-729"><a href="#PseudoDifferentialOperator-729"><span class="linenos"> 729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-730"><a href="#PseudoDifferentialOperator-730"><span class="linenos"> 730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-731"><a href="#PseudoDifferentialOperator-731"><span class="linenos"> 731</span></a><span class="sd">        Compose two pseudo-differential operators using an asymptotic expansion</span>
</span><span id="PseudoDifferentialOperator-732"><a href="#PseudoDifferentialOperator-732"><span class="linenos"> 732</span></a><span class="sd">        in the chosen quantization scheme (Kohn–Nirenberg or Weyl).</span>
</span><span id="PseudoDifferentialOperator-733"><a href="#PseudoDifferentialOperator-733"><span class="linenos"> 733</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-734"><a href="#PseudoDifferentialOperator-734"><span class="linenos"> 734</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-735"><a href="#PseudoDifferentialOperator-735"><span class="linenos"> 735</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-736"><a href="#PseudoDifferentialOperator-736"><span class="linenos"> 736</span></a><span class="sd">        other : PseudoDifferentialOperator</span>
</span><span id="PseudoDifferentialOperator-737"><a href="#PseudoDifferentialOperator-737"><span class="linenos"> 737</span></a><span class="sd">            The operator to compose with this one.</span>
</span><span id="PseudoDifferentialOperator-738"><a href="#PseudoDifferentialOperator-738"><span class="linenos"> 738</span></a><span class="sd">        order : int, default=1</span>
</span><span id="PseudoDifferentialOperator-739"><a href="#PseudoDifferentialOperator-739"><span class="linenos"> 739</span></a><span class="sd">            Maximum order of the asymptotic expansion.</span>
</span><span id="PseudoDifferentialOperator-740"><a href="#PseudoDifferentialOperator-740"><span class="linenos"> 740</span></a><span class="sd">        mode : {&#39;kn&#39;, &#39;weyl&#39;}, default=&#39;kn&#39;</span>
</span><span id="PseudoDifferentialOperator-741"><a href="#PseudoDifferentialOperator-741"><span class="linenos"> 741</span></a><span class="sd">            Quantization mode:</span>
</span><span id="PseudoDifferentialOperator-742"><a href="#PseudoDifferentialOperator-742"><span class="linenos"> 742</span></a><span class="sd">            - &#39;kn&#39; : Kohn–Nirenberg quantization (left-quantized)</span>
</span><span id="PseudoDifferentialOperator-743"><a href="#PseudoDifferentialOperator-743"><span class="linenos"> 743</span></a><span class="sd">            - &#39;weyl&#39; : Weyl symmetric quantization</span>
</span><span id="PseudoDifferentialOperator-744"><a href="#PseudoDifferentialOperator-744"><span class="linenos"> 744</span></a><span class="sd">        sign_convention : {&#39;standard&#39;, &#39;inverse&#39;}, optional</span>
</span><span id="PseudoDifferentialOperator-745"><a href="#PseudoDifferentialOperator-745"><span class="linenos"> 745</span></a><span class="sd">            Controls the phase factor convention for the KN case:</span>
</span><span id="PseudoDifferentialOperator-746"><a href="#PseudoDifferentialOperator-746"><span class="linenos"> 746</span></a><span class="sd">            - &#39;standard&#39; → (i)^(-n), gives [x, ξ] = +i (physics convention)</span>
</span><span id="PseudoDifferentialOperator-747"><a href="#PseudoDifferentialOperator-747"><span class="linenos"> 747</span></a><span class="sd">            - &#39;inverse&#39; → (i)^(+n), gives [x, ξ] = -i (mathematical adjoint convention)</span>
</span><span id="PseudoDifferentialOperator-748"><a href="#PseudoDifferentialOperator-748"><span class="linenos"> 748</span></a><span class="sd">            If None, defaults to &#39;standard&#39;.</span>
</span><span id="PseudoDifferentialOperator-749"><a href="#PseudoDifferentialOperator-749"><span class="linenos"> 749</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-750"><a href="#PseudoDifferentialOperator-750"><span class="linenos"> 750</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-751"><a href="#PseudoDifferentialOperator-751"><span class="linenos"> 751</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-752"><a href="#PseudoDifferentialOperator-752"><span class="linenos"> 752</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-753"><a href="#PseudoDifferentialOperator-753"><span class="linenos"> 753</span></a><span class="sd">            Symbolic expression for the composed symbol up to the given order.</span>
</span><span id="PseudoDifferentialOperator-754"><a href="#PseudoDifferentialOperator-754"><span class="linenos"> 754</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-755"><a href="#PseudoDifferentialOperator-755"><span class="linenos"> 755</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-756"><a href="#PseudoDifferentialOperator-756"><span class="linenos"> 756</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-757"><a href="#PseudoDifferentialOperator-757"><span class="linenos"> 757</span></a><span class="sd">        - In 1D (Kohn–Nirenberg):</span>
</span><span id="PseudoDifferentialOperator-758"><a href="#PseudoDifferentialOperator-758"><span class="linenos"> 758</span></a><span class="sd">            (p ∘ q)(x, ξ) ~ Σₙ (1/n!) (i sgn)^n ∂_ξⁿ p(x, ξ) ∂_xⁿ q(x, ξ)</span>
</span><span id="PseudoDifferentialOperator-759"><a href="#PseudoDifferentialOperator-759"><span class="linenos"> 759</span></a><span class="sd">        - In 1D (Weyl):</span>
</span><span id="PseudoDifferentialOperator-760"><a href="#PseudoDifferentialOperator-760"><span class="linenos"> 760</span></a><span class="sd">            (p # q)(x, ξ) = exp[(i/2)(∂_ξ^p ∂_x^q - ∂_x^p ∂_ξ^q)] p(x, ξ) q(x, ξ)</span>
</span><span id="PseudoDifferentialOperator-761"><a href="#PseudoDifferentialOperator-761"><span class="linenos"> 761</span></a><span class="sd">            truncated at given order.</span>
</span><span id="PseudoDifferentialOperator-762"><a href="#PseudoDifferentialOperator-762"><span class="linenos"> 762</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-763"><a href="#PseudoDifferentialOperator-763"><span class="linenos"> 763</span></a><span class="sd">        Examples</span>
</span><span id="PseudoDifferentialOperator-764"><a href="#PseudoDifferentialOperator-764"><span class="linenos"> 764</span></a><span class="sd">        --------</span>
</span><span id="PseudoDifferentialOperator-765"><a href="#PseudoDifferentialOperator-765"><span class="linenos"> 765</span></a><span class="sd">        X = a*x, Y = b*ξ</span>
</span><span id="PseudoDifferentialOperator-766"><a href="#PseudoDifferentialOperator-766"><span class="linenos"> 766</span></a><span class="sd">        X_op.compose_asymptotic(Y_op, order=3, mode=&#39;weyl&#39;)</span>
</span><span id="PseudoDifferentialOperator-767"><a href="#PseudoDifferentialOperator-767"><span class="linenos"> 767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-768"><a href="#PseudoDifferentialOperator-768"><span class="linenos"> 768</span></a>    
</span><span id="PseudoDifferentialOperator-769"><a href="#PseudoDifferentialOperator-769"><span class="linenos"> 769</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">diff</span><span class="p">,</span> <span class="n">factorial</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">symbols</span>
</span><span id="PseudoDifferentialOperator-770"><a href="#PseudoDifferentialOperator-770"><span class="linenos"> 770</span></a>    
</span><span id="PseudoDifferentialOperator-771"><a href="#PseudoDifferentialOperator-771"><span class="linenos"> 771</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;Operator dimensions must match&quot;</span>
</span><span id="PseudoDifferentialOperator-772"><a href="#PseudoDifferentialOperator-772"><span class="linenos"> 772</span></a>        <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-773"><a href="#PseudoDifferentialOperator-773"><span class="linenos"> 773</span></a>    
</span><span id="PseudoDifferentialOperator-774"><a href="#PseudoDifferentialOperator-774"><span class="linenos"> 774</span></a>        <span class="c1"># Default sign convention</span>
</span><span id="PseudoDifferentialOperator-775"><a href="#PseudoDifferentialOperator-775"><span class="linenos"> 775</span></a>        <span class="k">if</span> <span class="n">sign_convention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-776"><a href="#PseudoDifferentialOperator-776"><span class="linenos"> 776</span></a>            <span class="n">sign_convention</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
</span><span id="PseudoDifferentialOperator-777"><a href="#PseudoDifferentialOperator-777"><span class="linenos"> 777</span></a>        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sign_convention</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
</span><span id="PseudoDifferentialOperator-778"><a href="#PseudoDifferentialOperator-778"><span class="linenos"> 778</span></a>    
</span><span id="PseudoDifferentialOperator-779"><a href="#PseudoDifferentialOperator-779"><span class="linenos"> 779</span></a>        <span class="c1"># --- 1D case ---</span>
</span><span id="PseudoDifferentialOperator-780"><a href="#PseudoDifferentialOperator-780"><span class="linenos"> 780</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-781"><a href="#PseudoDifferentialOperator-781"><span class="linenos"> 781</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-782"><a href="#PseudoDifferentialOperator-782"><span class="linenos"> 782</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-783"><a href="#PseudoDifferentialOperator-783"><span class="linenos"> 783</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-784"><a href="#PseudoDifferentialOperator-784"><span class="linenos"> 784</span></a>    
</span><span id="PseudoDifferentialOperator-785"><a href="#PseudoDifferentialOperator-785"><span class="linenos"> 785</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kn&#39;</span><span class="p">:</span>  <span class="c1"># Kohn–Nirenberg</span>
</span><span id="PseudoDifferentialOperator-786"><a href="#PseudoDifferentialOperator-786"><span class="linenos"> 786</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-787"><a href="#PseudoDifferentialOperator-787"><span class="linenos"> 787</span></a>                    <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-788"><a href="#PseudoDifferentialOperator-788"><span class="linenos"> 788</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator-789"><a href="#PseudoDifferentialOperator-789"><span class="linenos"> 789</span></a>    
</span><span id="PseudoDifferentialOperator-790"><a href="#PseudoDifferentialOperator-790"><span class="linenos"> 790</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;weyl&#39;</span><span class="p">:</span>  <span class="c1"># Weyl symmetric composition</span>
</span><span id="PseudoDifferentialOperator-791"><a href="#PseudoDifferentialOperator-791"><span class="linenos"> 791</span></a>                <span class="c1"># Weyl star product: exp((i/2)(∂_ξ^p ∂_x^q - ∂_x^p ∂_ξ^q))</span>
</span><span id="PseudoDifferentialOperator-792"><a href="#PseudoDifferentialOperator-792"><span class="linenos"> 792</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-793"><a href="#PseudoDifferentialOperator-793"><span class="linenos"> 793</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-794"><a href="#PseudoDifferentialOperator-794"><span class="linenos"> 794</span></a>                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-795"><a href="#PseudoDifferentialOperator-795"><span class="linenos"> 795</span></a>                        <span class="c1"># k derivatives acting as (∂_ξ^k p)(∂_x^(n−k) q)</span>
</span><span id="PseudoDifferentialOperator-796"><a href="#PseudoDifferentialOperator-796"><span class="linenos"> 796</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-797"><a href="#PseudoDifferentialOperator-797"><span class="linenos"> 797</span></a>                        <span class="n">term</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-798"><a href="#PseudoDifferentialOperator-798"><span class="linenos"> 798</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator-799"><a href="#PseudoDifferentialOperator-799"><span class="linenos"> 799</span></a>    
</span><span id="PseudoDifferentialOperator-800"><a href="#PseudoDifferentialOperator-800"><span class="linenos"> 800</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-801"><a href="#PseudoDifferentialOperator-801"><span class="linenos"> 801</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be either &#39;kn&#39; or &#39;weyl&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-802"><a href="#PseudoDifferentialOperator-802"><span class="linenos"> 802</span></a>    
</span><span id="PseudoDifferentialOperator-803"><a href="#PseudoDifferentialOperator-803"><span class="linenos"> 803</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-804"><a href="#PseudoDifferentialOperator-804"><span class="linenos"> 804</span></a>    
</span><span id="PseudoDifferentialOperator-805"><a href="#PseudoDifferentialOperator-805"><span class="linenos"> 805</span></a>        <span class="c1"># --- 2D case ---</span>
</span><span id="PseudoDifferentialOperator-806"><a href="#PseudoDifferentialOperator-806"><span class="linenos"> 806</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-807"><a href="#PseudoDifferentialOperator-807"><span class="linenos"> 807</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-808"><a href="#PseudoDifferentialOperator-808"><span class="linenos"> 808</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-809"><a href="#PseudoDifferentialOperator-809"><span class="linenos"> 809</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-810"><a href="#PseudoDifferentialOperator-810"><span class="linenos"> 810</span></a>    
</span><span id="PseudoDifferentialOperator-811"><a href="#PseudoDifferentialOperator-811"><span class="linenos"> 811</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kn&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-812"><a href="#PseudoDifferentialOperator-812"><span class="linenos"> 812</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-813"><a href="#PseudoDifferentialOperator-813"><span class="linenos"> 813</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-814"><a href="#PseudoDifferentialOperator-814"><span class="linenos"> 814</span></a>                        <span class="n">j</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span>
</span><span id="PseudoDifferentialOperator-815"><a href="#PseudoDifferentialOperator-815"><span class="linenos"> 815</span></a>                        <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">*</span> \
</span><span id="PseudoDifferentialOperator-816"><a href="#PseudoDifferentialOperator-816"><span class="linenos"> 816</span></a>                               <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-817"><a href="#PseudoDifferentialOperator-817"><span class="linenos"> 817</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator-818"><a href="#PseudoDifferentialOperator-818"><span class="linenos"> 818</span></a>    
</span><span id="PseudoDifferentialOperator-819"><a href="#PseudoDifferentialOperator-819"><span class="linenos"> 819</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;weyl&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-820"><a href="#PseudoDifferentialOperator-820"><span class="linenos"> 820</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-821"><a href="#PseudoDifferentialOperator-821"><span class="linenos"> 821</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-822"><a href="#PseudoDifferentialOperator-822"><span class="linenos"> 822</span></a>                        <span class="n">j</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span>
</span><span id="PseudoDifferentialOperator-823"><a href="#PseudoDifferentialOperator-823"><span class="linenos"> 823</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-824"><a href="#PseudoDifferentialOperator-824"><span class="linenos"> 824</span></a>                        <span class="n">term</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-825"><a href="#PseudoDifferentialOperator-825"><span class="linenos"> 825</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator-826"><a href="#PseudoDifferentialOperator-826"><span class="linenos"> 826</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-827"><a href="#PseudoDifferentialOperator-827"><span class="linenos"> 827</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be either &#39;kn&#39; or &#39;weyl&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-828"><a href="#PseudoDifferentialOperator-828"><span class="linenos"> 828</span></a>    
</span><span id="PseudoDifferentialOperator-829"><a href="#PseudoDifferentialOperator-829"><span class="linenos"> 829</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-830"><a href="#PseudoDifferentialOperator-830"><span class="linenos"> 830</span></a>    
</span><span id="PseudoDifferentialOperator-831"><a href="#PseudoDifferentialOperator-831"><span class="linenos"> 831</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-832"><a href="#PseudoDifferentialOperator-832"><span class="linenos"> 832</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D cases are implemented&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-833"><a href="#PseudoDifferentialOperator-833"><span class="linenos"> 833</span></a>
</span><span id="PseudoDifferentialOperator-834"><a href="#PseudoDifferentialOperator-834"><span class="linenos"> 834</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">commutator_symbolic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-835"><a href="#PseudoDifferentialOperator-835"><span class="linenos"> 835</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-836"><a href="#PseudoDifferentialOperator-836"><span class="linenos"> 836</span></a><span class="sd">        Compute the symbolic commutator [A, B] = A∘B − B∘A of two pseudo-differential operators</span>
</span><span id="PseudoDifferentialOperator-837"><a href="#PseudoDifferentialOperator-837"><span class="linenos"> 837</span></a><span class="sd">        using formal asymptotic expansion of their composition symbols.</span>
</span><span id="PseudoDifferentialOperator-838"><a href="#PseudoDifferentialOperator-838"><span class="linenos"> 838</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-839"><a href="#PseudoDifferentialOperator-839"><span class="linenos"> 839</span></a><span class="sd">        This method computes the asymptotic expansion of the commutator&#39;s symbol up to a given </span>
</span><span id="PseudoDifferentialOperator-840"><a href="#PseudoDifferentialOperator-840"><span class="linenos"> 840</span></a><span class="sd">        order, based on the symbolic calculus of pseudo-differential operators in the </span>
</span><span id="PseudoDifferentialOperator-841"><a href="#PseudoDifferentialOperator-841"><span class="linenos"> 841</span></a><span class="sd">        Kohn–Nirenberg quantization. The result is a purely symbolic sympy expression that </span>
</span><span id="PseudoDifferentialOperator-842"><a href="#PseudoDifferentialOperator-842"><span class="linenos"> 842</span></a><span class="sd">        captures the leading-order noncommutativity of the operators.</span>
</span><span id="PseudoDifferentialOperator-843"><a href="#PseudoDifferentialOperator-843"><span class="linenos"> 843</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-844"><a href="#PseudoDifferentialOperator-844"><span class="linenos"> 844</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-845"><a href="#PseudoDifferentialOperator-845"><span class="linenos"> 845</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-846"><a href="#PseudoDifferentialOperator-846"><span class="linenos"> 846</span></a><span class="sd">        other : PseudoDifferentialOperator</span>
</span><span id="PseudoDifferentialOperator-847"><a href="#PseudoDifferentialOperator-847"><span class="linenos"> 847</span></a><span class="sd">            The pseudo-differential operator B to commute with this operator A.</span>
</span><span id="PseudoDifferentialOperator-848"><a href="#PseudoDifferentialOperator-848"><span class="linenos"> 848</span></a><span class="sd">        order : int, default=1</span>
</span><span id="PseudoDifferentialOperator-849"><a href="#PseudoDifferentialOperator-849"><span class="linenos"> 849</span></a><span class="sd">            Maximum order of the asymptotic expansion. </span>
</span><span id="PseudoDifferentialOperator-850"><a href="#PseudoDifferentialOperator-850"><span class="linenos"> 850</span></a><span class="sd">            - order=1 yields the leading term proportional to the Poisson bracket {p, q}.</span>
</span><span id="PseudoDifferentialOperator-851"><a href="#PseudoDifferentialOperator-851"><span class="linenos"> 851</span></a><span class="sd">            - Higher orders include correction terms involving higher mixed derivatives.</span>
</span><span id="PseudoDifferentialOperator-852"><a href="#PseudoDifferentialOperator-852"><span class="linenos"> 852</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-853"><a href="#PseudoDifferentialOperator-853"><span class="linenos"> 853</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-854"><a href="#PseudoDifferentialOperator-854"><span class="linenos"> 854</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-855"><a href="#PseudoDifferentialOperator-855"><span class="linenos"> 855</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-856"><a href="#PseudoDifferentialOperator-856"><span class="linenos"> 856</span></a><span class="sd">            Symbolic expression for the asymptotic expansion of the commutator symbol </span>
</span><span id="PseudoDifferentialOperator-857"><a href="#PseudoDifferentialOperator-857"><span class="linenos"> 857</span></a><span class="sd">            σ([A,B]) = σ(A∘B − B∘A).</span>
</span><span id="PseudoDifferentialOperator-858"><a href="#PseudoDifferentialOperator-858"><span class="linenos"> 858</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-859"><a href="#PseudoDifferentialOperator-859"><span class="linenos"> 859</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-860"><a href="#PseudoDifferentialOperator-860"><span class="linenos"> 860</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;Operator dimensions must match&quot;</span>
</span><span id="PseudoDifferentialOperator-861"><a href="#PseudoDifferentialOperator-861"><span class="linenos"> 861</span></a>        <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-862"><a href="#PseudoDifferentialOperator-862"><span class="linenos"> 862</span></a>    
</span><span id="PseudoDifferentialOperator-863"><a href="#PseudoDifferentialOperator-863"><span class="linenos"> 863</span></a>        <span class="n">pq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-864"><a href="#PseudoDifferentialOperator-864"><span class="linenos"> 864</span></a>        <span class="n">qp</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-865"><a href="#PseudoDifferentialOperator-865"><span class="linenos"> 865</span></a>        
</span><span id="PseudoDifferentialOperator-866"><a href="#PseudoDifferentialOperator-866"><span class="linenos"> 866</span></a>        <span class="n">comm_symbol</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">pq</span><span class="o">-</span><span class="n">qp</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-867"><a href="#PseudoDifferentialOperator-867"><span class="linenos"> 867</span></a>
</span><span id="PseudoDifferentialOperator-868"><a href="#PseudoDifferentialOperator-868"><span class="linenos"> 868</span></a>        <span class="k">return</span> <span class="n">comm_symbol</span>
</span><span id="PseudoDifferentialOperator-869"><a href="#PseudoDifferentialOperator-869"><span class="linenos"> 869</span></a>
</span><span id="PseudoDifferentialOperator-870"><a href="#PseudoDifferentialOperator-870"><span class="linenos"> 870</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">right_inverse_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-871"><a href="#PseudoDifferentialOperator-871"><span class="linenos"> 871</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-872"><a href="#PseudoDifferentialOperator-872"><span class="linenos"> 872</span></a><span class="sd">        Construct a formal right inverse R of the pseudo-differential operator P such that </span>
</span><span id="PseudoDifferentialOperator-873"><a href="#PseudoDifferentialOperator-873"><span class="linenos"> 873</span></a><span class="sd">        the composition P ∘ R equals the identity plus a smoothing operator of order -order.</span>
</span><span id="PseudoDifferentialOperator-874"><a href="#PseudoDifferentialOperator-874"><span class="linenos"> 874</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-875"><a href="#PseudoDifferentialOperator-875"><span class="linenos"> 875</span></a><span class="sd">        This method computes an asymptotic expansion for the right inverse using recursive </span>
</span><span id="PseudoDifferentialOperator-876"><a href="#PseudoDifferentialOperator-876"><span class="linenos"> 876</span></a><span class="sd">        corrections based on derivatives of the symbol p(x, ξ) and lower-order terms of R.</span>
</span><span id="PseudoDifferentialOperator-877"><a href="#PseudoDifferentialOperator-877"><span class="linenos"> 877</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-878"><a href="#PseudoDifferentialOperator-878"><span class="linenos"> 878</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-879"><a href="#PseudoDifferentialOperator-879"><span class="linenos"> 879</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-880"><a href="#PseudoDifferentialOperator-880"><span class="linenos"> 880</span></a><span class="sd">        order : int</span>
</span><span id="PseudoDifferentialOperator-881"><a href="#PseudoDifferentialOperator-881"><span class="linenos"> 881</span></a><span class="sd">            Number of terms to include in the asymptotic expansion. Higher values improve </span>
</span><span id="PseudoDifferentialOperator-882"><a href="#PseudoDifferentialOperator-882"><span class="linenos"> 882</span></a><span class="sd">            approximation at the cost of complexity and computational effort.</span>
</span><span id="PseudoDifferentialOperator-883"><a href="#PseudoDifferentialOperator-883"><span class="linenos"> 883</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-884"><a href="#PseudoDifferentialOperator-884"><span class="linenos"> 884</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-885"><a href="#PseudoDifferentialOperator-885"><span class="linenos"> 885</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-886"><a href="#PseudoDifferentialOperator-886"><span class="linenos"> 886</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-887"><a href="#PseudoDifferentialOperator-887"><span class="linenos"> 887</span></a><span class="sd">            The symbolic expression representing the formal right inverse R(x, ξ), which satisfies:</span>
</span><span id="PseudoDifferentialOperator-888"><a href="#PseudoDifferentialOperator-888"><span class="linenos"> 888</span></a><span class="sd">            P ∘ R = Id + O(⟨ξ⟩^{-order}), where ⟨ξ⟩ = (1 + |ξ|²)^{1/2}.</span>
</span><span id="PseudoDifferentialOperator-889"><a href="#PseudoDifferentialOperator-889"><span class="linenos"> 889</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-890"><a href="#PseudoDifferentialOperator-890"><span class="linenos"> 890</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-891"><a href="#PseudoDifferentialOperator-891"><span class="linenos"> 891</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-892"><a href="#PseudoDifferentialOperator-892"><span class="linenos"> 892</span></a><span class="sd">        - In 1D: The recursion involves spatial derivatives of R and derivatives of p with respect to ξ.</span>
</span><span id="PseudoDifferentialOperator-893"><a href="#PseudoDifferentialOperator-893"><span class="linenos"> 893</span></a><span class="sd">        - In 2D: The multi-index generalization is used with mixed derivatives in ξ and η.</span>
</span><span id="PseudoDifferentialOperator-894"><a href="#PseudoDifferentialOperator-894"><span class="linenos"> 894</span></a><span class="sd">        - The construction relies on the non-vanishing of the principal symbol p to ensure invertibility.</span>
</span><span id="PseudoDifferentialOperator-895"><a href="#PseudoDifferentialOperator-895"><span class="linenos"> 895</span></a><span class="sd">        - Each term in the expansion corresponds to higher-order corrections involving commutators </span>
</span><span id="PseudoDifferentialOperator-896"><a href="#PseudoDifferentialOperator-896"><span class="linenos"> 896</span></a><span class="sd">          between the operator P and the current approximation of R.</span>
</span><span id="PseudoDifferentialOperator-897"><a href="#PseudoDifferentialOperator-897"><span class="linenos"> 897</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-898"><a href="#PseudoDifferentialOperator-898"><span class="linenos"> 898</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-899"><a href="#PseudoDifferentialOperator-899"><span class="linenos"> 899</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-900"><a href="#PseudoDifferentialOperator-900"><span class="linenos"> 900</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-901"><a href="#PseudoDifferentialOperator-901"><span class="linenos"> 901</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-902"><a href="#PseudoDifferentialOperator-902"><span class="linenos"> 902</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>  <span class="c1"># r0</span>
</span><span id="PseudoDifferentialOperator-903"><a href="#PseudoDifferentialOperator-903"><span class="linenos"> 903</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="PseudoDifferentialOperator-904"><a href="#PseudoDifferentialOperator-904"><span class="linenos"> 904</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-905"><a href="#PseudoDifferentialOperator-905"><span class="linenos"> 905</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-906"><a href="#PseudoDifferentialOperator-906"><span class="linenos"> 906</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-907"><a href="#PseudoDifferentialOperator-907"><span class="linenos"> 907</span></a>                    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-908"><a href="#PseudoDifferentialOperator-908"><span class="linenos"> 908</span></a>                    <span class="n">inner</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-909"><a href="#PseudoDifferentialOperator-909"><span class="linenos"> 909</span></a>                    <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">inner</span>
</span><span id="PseudoDifferentialOperator-910"><a href="#PseudoDifferentialOperator-910"><span class="linenos"> 910</span></a>                <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">r</span> <span class="o">*</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator-911"><a href="#PseudoDifferentialOperator-911"><span class="linenos"> 911</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-912"><a href="#PseudoDifferentialOperator-912"><span class="linenos"> 912</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-913"><a href="#PseudoDifferentialOperator-913"><span class="linenos"> 913</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-914"><a href="#PseudoDifferentialOperator-914"><span class="linenos"> 914</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">eta</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator-915"><a href="#PseudoDifferentialOperator-915"><span class="linenos"> 915</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="PseudoDifferentialOperator-916"><a href="#PseudoDifferentialOperator-916"><span class="linenos"> 916</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-917"><a href="#PseudoDifferentialOperator-917"><span class="linenos"> 917</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-918"><a href="#PseudoDifferentialOperator-918"><span class="linenos"> 918</span></a>                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-919"><a href="#PseudoDifferentialOperator-919"><span class="linenos"> 919</span></a>                    <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-920"><a href="#PseudoDifferentialOperator-920"><span class="linenos"> 920</span></a>                        <span class="k">if</span> <span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="PseudoDifferentialOperator-921"><a href="#PseudoDifferentialOperator-921"><span class="linenos"> 921</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-922"><a href="#PseudoDifferentialOperator-922"><span class="linenos"> 922</span></a>                        <span class="n">dp</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-923"><a href="#PseudoDifferentialOperator-923"><span class="linenos"> 923</span></a>                        <span class="n">dR</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-924"><a href="#PseudoDifferentialOperator-924"><span class="linenos"> 924</span></a>                        <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">dR</span>
</span><span id="PseudoDifferentialOperator-925"><a href="#PseudoDifferentialOperator-925"><span class="linenos"> 925</span></a>                <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">r</span> <span class="o">*</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator-926"><a href="#PseudoDifferentialOperator-926"><span class="linenos"> 926</span></a>        <span class="k">return</span> <span class="n">R</span>
</span><span id="PseudoDifferentialOperator-927"><a href="#PseudoDifferentialOperator-927"><span class="linenos"> 927</span></a>
</span><span id="PseudoDifferentialOperator-928"><a href="#PseudoDifferentialOperator-928"><span class="linenos"> 928</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">left_inverse_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-929"><a href="#PseudoDifferentialOperator-929"><span class="linenos"> 929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-930"><a href="#PseudoDifferentialOperator-930"><span class="linenos"> 930</span></a><span class="sd">        Construct a formal left inverse L such that the composition L ∘ P equals the identity </span>
</span><span id="PseudoDifferentialOperator-931"><a href="#PseudoDifferentialOperator-931"><span class="linenos"> 931</span></a><span class="sd">        operator up to terms of order ξ^{-order}. This expansion is performed asymptotically </span>
</span><span id="PseudoDifferentialOperator-932"><a href="#PseudoDifferentialOperator-932"><span class="linenos"> 932</span></a><span class="sd">        at infinity in the frequency variable(s).</span>
</span><span id="PseudoDifferentialOperator-933"><a href="#PseudoDifferentialOperator-933"><span class="linenos"> 933</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-934"><a href="#PseudoDifferentialOperator-934"><span class="linenos"> 934</span></a><span class="sd">        The left inverse is built iteratively using symbolic differentiation and the </span>
</span><span id="PseudoDifferentialOperator-935"><a href="#PseudoDifferentialOperator-935"><span class="linenos"> 935</span></a><span class="sd">        method of asymptotic expansions for pseudo-differential operators. It ensures that:</span>
</span><span id="PseudoDifferentialOperator-936"><a href="#PseudoDifferentialOperator-936"><span class="linenos"> 936</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-937"><a href="#PseudoDifferentialOperator-937"><span class="linenos"> 937</span></a><span class="sd">            L(P(x,ξ),x,D) ∘ P(x,D) = Id + smoothing operator of order -order</span>
</span><span id="PseudoDifferentialOperator-938"><a href="#PseudoDifferentialOperator-938"><span class="linenos"> 938</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-939"><a href="#PseudoDifferentialOperator-939"><span class="linenos"> 939</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-940"><a href="#PseudoDifferentialOperator-940"><span class="linenos"> 940</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-941"><a href="#PseudoDifferentialOperator-941"><span class="linenos"> 941</span></a><span class="sd">        order : int, optional</span>
</span><span id="PseudoDifferentialOperator-942"><a href="#PseudoDifferentialOperator-942"><span class="linenos"> 942</span></a><span class="sd">            Maximum number of terms in the asymptotic expansion (default is 1). Higher values </span>
</span><span id="PseudoDifferentialOperator-943"><a href="#PseudoDifferentialOperator-943"><span class="linenos"> 943</span></a><span class="sd">            yield more accurate inverses at the cost of increased computational complexity.</span>
</span><span id="PseudoDifferentialOperator-944"><a href="#PseudoDifferentialOperator-944"><span class="linenos"> 944</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-945"><a href="#PseudoDifferentialOperator-945"><span class="linenos"> 945</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-946"><a href="#PseudoDifferentialOperator-946"><span class="linenos"> 946</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-947"><a href="#PseudoDifferentialOperator-947"><span class="linenos"> 947</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-948"><a href="#PseudoDifferentialOperator-948"><span class="linenos"> 948</span></a><span class="sd">            Symbolic expression representing the principal symbol of the formal left inverse </span>
</span><span id="PseudoDifferentialOperator-949"><a href="#PseudoDifferentialOperator-949"><span class="linenos"> 949</span></a><span class="sd">            operator L(x,ξ). This expression depends on spatial variables and frequencies, </span>
</span><span id="PseudoDifferentialOperator-950"><a href="#PseudoDifferentialOperator-950"><span class="linenos"> 950</span></a><span class="sd">            and includes correction terms up to the specified order.</span>
</span><span id="PseudoDifferentialOperator-951"><a href="#PseudoDifferentialOperator-951"><span class="linenos"> 951</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-952"><a href="#PseudoDifferentialOperator-952"><span class="linenos"> 952</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-953"><a href="#PseudoDifferentialOperator-953"><span class="linenos"> 953</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-954"><a href="#PseudoDifferentialOperator-954"><span class="linenos"> 954</span></a><span class="sd">        - In 1D: Uses recursive application of the Leibniz formula for symbols.</span>
</span><span id="PseudoDifferentialOperator-955"><a href="#PseudoDifferentialOperator-955"><span class="linenos"> 955</span></a><span class="sd">        - In 2D: Generalizes to multi-indices for mixed derivatives in (x,y) and (ξ,η).</span>
</span><span id="PseudoDifferentialOperator-956"><a href="#PseudoDifferentialOperator-956"><span class="linenos"> 956</span></a><span class="sd">        - Each term involves combinations of derivatives of the original symbol p(x,ξ) and </span>
</span><span id="PseudoDifferentialOperator-957"><a href="#PseudoDifferentialOperator-957"><span class="linenos"> 957</span></a><span class="sd">          previously computed terms of the inverse.</span>
</span><span id="PseudoDifferentialOperator-958"><a href="#PseudoDifferentialOperator-958"><span class="linenos"> 958</span></a><span class="sd">        - Coefficients include powers of 1j (i) and factorial normalization for derivative terms.</span>
</span><span id="PseudoDifferentialOperator-959"><a href="#PseudoDifferentialOperator-959"><span class="linenos"> 959</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-960"><a href="#PseudoDifferentialOperator-960"><span class="linenos"> 960</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-961"><a href="#PseudoDifferentialOperator-961"><span class="linenos"> 961</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-962"><a href="#PseudoDifferentialOperator-962"><span class="linenos"> 962</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-963"><a href="#PseudoDifferentialOperator-963"><span class="linenos"> 963</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-964"><a href="#PseudoDifferentialOperator-964"><span class="linenos"> 964</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-965"><a href="#PseudoDifferentialOperator-965"><span class="linenos"> 965</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator-966"><a href="#PseudoDifferentialOperator-966"><span class="linenos"> 966</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-967"><a href="#PseudoDifferentialOperator-967"><span class="linenos"> 967</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-968"><a href="#PseudoDifferentialOperator-968"><span class="linenos"> 968</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-969"><a href="#PseudoDifferentialOperator-969"><span class="linenos"> 969</span></a>                    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-970"><a href="#PseudoDifferentialOperator-970"><span class="linenos"> 970</span></a>                    <span class="n">inner</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-971"><a href="#PseudoDifferentialOperator-971"><span class="linenos"> 971</span></a>                    <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">inner</span>
</span><span id="PseudoDifferentialOperator-972"><a href="#PseudoDifferentialOperator-972"><span class="linenos"> 972</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="n">term</span> <span class="o">*</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator-973"><a href="#PseudoDifferentialOperator-973"><span class="linenos"> 973</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-974"><a href="#PseudoDifferentialOperator-974"><span class="linenos"> 974</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-975"><a href="#PseudoDifferentialOperator-975"><span class="linenos"> 975</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-976"><a href="#PseudoDifferentialOperator-976"><span class="linenos"> 976</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">eta</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator-977"><a href="#PseudoDifferentialOperator-977"><span class="linenos"> 977</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator-978"><a href="#PseudoDifferentialOperator-978"><span class="linenos"> 978</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-979"><a href="#PseudoDifferentialOperator-979"><span class="linenos"> 979</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator-980"><a href="#PseudoDifferentialOperator-980"><span class="linenos"> 980</span></a>                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-981"><a href="#PseudoDifferentialOperator-981"><span class="linenos"> 981</span></a>                    <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-982"><a href="#PseudoDifferentialOperator-982"><span class="linenos"> 982</span></a>                        <span class="k">if</span> <span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="PseudoDifferentialOperator-983"><a href="#PseudoDifferentialOperator-983"><span class="linenos"> 983</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-984"><a href="#PseudoDifferentialOperator-984"><span class="linenos"> 984</span></a>                        <span class="n">dp</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-985"><a href="#PseudoDifferentialOperator-985"><span class="linenos"> 985</span></a>                        <span class="n">dL</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-986"><a href="#PseudoDifferentialOperator-986"><span class="linenos"> 986</span></a>                        <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">dL</span> <span class="o">*</span> <span class="n">dp</span>
</span><span id="PseudoDifferentialOperator-987"><a href="#PseudoDifferentialOperator-987"><span class="linenos"> 987</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="n">term</span> <span class="o">*</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator-988"><a href="#PseudoDifferentialOperator-988"><span class="linenos"> 988</span></a>        <span class="k">return</span> <span class="n">L</span>
</span><span id="PseudoDifferentialOperator-989"><a href="#PseudoDifferentialOperator-989"><span class="linenos"> 989</span></a>
</span><span id="PseudoDifferentialOperator-990"><a href="#PseudoDifferentialOperator-990"><span class="linenos"> 990</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">formal_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-991"><a href="#PseudoDifferentialOperator-991"><span class="linenos"> 991</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-992"><a href="#PseudoDifferentialOperator-992"><span class="linenos"> 992</span></a><span class="sd">        Compute the formal adjoint symbol P* of the pseudo-differential operator.</span>
</span><span id="PseudoDifferentialOperator-993"><a href="#PseudoDifferentialOperator-993"><span class="linenos"> 993</span></a>
</span><span id="PseudoDifferentialOperator-994"><a href="#PseudoDifferentialOperator-994"><span class="linenos"> 994</span></a><span class="sd">        The adjoint is defined such that for any test functions u and v,</span>
</span><span id="PseudoDifferentialOperator-995"><a href="#PseudoDifferentialOperator-995"><span class="linenos"> 995</span></a><span class="sd">        ⟨P u, v⟩ = ⟨u, P* v⟩ holds in the distributional sense. This is obtained by </span>
</span><span id="PseudoDifferentialOperator-996"><a href="#PseudoDifferentialOperator-996"><span class="linenos"> 996</span></a><span class="sd">        taking the complex conjugate of the symbol and expanding it asymptotically </span>
</span><span id="PseudoDifferentialOperator-997"><a href="#PseudoDifferentialOperator-997"><span class="linenos"> 997</span></a><span class="sd">        at infinity to ensure proper behavior under integration by parts.</span>
</span><span id="PseudoDifferentialOperator-998"><a href="#PseudoDifferentialOperator-998"><span class="linenos"> 998</span></a>
</span><span id="PseudoDifferentialOperator-999"><a href="#PseudoDifferentialOperator-999"><span class="linenos"> 999</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1000"><a href="#PseudoDifferentialOperator-1000"><span class="linenos">1000</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1001"><a href="#PseudoDifferentialOperator-1001"><span class="linenos">1001</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-1002"><a href="#PseudoDifferentialOperator-1002"><span class="linenos">1002</span></a><span class="sd">            The adjoint symbol P*(x, ξ) in 1D or P*(x, y, ξ, η) in 2D.</span>
</span><span id="PseudoDifferentialOperator-1003"><a href="#PseudoDifferentialOperator-1003"><span class="linenos">1003</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1004"><a href="#PseudoDifferentialOperator-1004"><span class="linenos">1004</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator-1005"><a href="#PseudoDifferentialOperator-1005"><span class="linenos">1005</span></a><span class="sd">        - In 1D, the expansion is performed in powers of 1/|ξ|.</span>
</span><span id="PseudoDifferentialOperator-1006"><a href="#PseudoDifferentialOperator-1006"><span class="linenos">1006</span></a><span class="sd">        - In 2D, the expansion is radial in |ξ| = sqrt(ξ² + η²).</span>
</span><span id="PseudoDifferentialOperator-1007"><a href="#PseudoDifferentialOperator-1007"><span class="linenos">1007</span></a><span class="sd">        - This method ensures symbolic simplifications for readability and efficiency.</span>
</span><span id="PseudoDifferentialOperator-1008"><a href="#PseudoDifferentialOperator-1008"><span class="linenos">1008</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1009"><a href="#PseudoDifferentialOperator-1009"><span class="linenos">1009</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-1010"><a href="#PseudoDifferentialOperator-1010"><span class="linenos">1010</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1011"><a href="#PseudoDifferentialOperator-1011"><span class="linenos">1011</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1012"><a href="#PseudoDifferentialOperator-1012"><span class="linenos">1012</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1013"><a href="#PseudoDifferentialOperator-1013"><span class="linenos">1013</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1014"><a href="#PseudoDifferentialOperator-1014"><span class="linenos">1014</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">series</span><span class="p">(</span><span class="n">p_star</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">())</span>
</span><span id="PseudoDifferentialOperator-1015"><a href="#PseudoDifferentialOperator-1015"><span class="linenos">1015</span></a>            <span class="k">return</span> <span class="n">p_star</span>
</span><span id="PseudoDifferentialOperator-1016"><a href="#PseudoDifferentialOperator-1016"><span class="linenos">1016</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1017"><a href="#PseudoDifferentialOperator-1017"><span class="linenos">1017</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1018"><a href="#PseudoDifferentialOperator-1018"><span class="linenos">1018</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1019"><a href="#PseudoDifferentialOperator-1019"><span class="linenos">1019</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1020"><a href="#PseudoDifferentialOperator-1020"><span class="linenos">1020</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">series</span><span class="p">(</span><span class="n">p_star</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">())</span>
</span><span id="PseudoDifferentialOperator-1021"><a href="#PseudoDifferentialOperator-1021"><span class="linenos">1021</span></a>            <span class="k">return</span> <span class="n">p_star</span>
</span><span id="PseudoDifferentialOperator-1022"><a href="#PseudoDifferentialOperator-1022"><span class="linenos">1022</span></a>
</span><span id="PseudoDifferentialOperator-1023"><a href="#PseudoDifferentialOperator-1023"><span class="linenos">1023</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exponential_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1024"><a href="#PseudoDifferentialOperator-1024"><span class="linenos">1024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1025"><a href="#PseudoDifferentialOperator-1025"><span class="linenos">1025</span></a><span class="sd">        Compute the symbol of exp(tP) using asymptotic expansion methods.</span>
</span><span id="PseudoDifferentialOperator-1026"><a href="#PseudoDifferentialOperator-1026"><span class="linenos">1026</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1027"><a href="#PseudoDifferentialOperator-1027"><span class="linenos">1027</span></a><span class="sd">        This method calculates the exponential of a pseudo-differential operator </span>
</span><span id="PseudoDifferentialOperator-1028"><a href="#PseudoDifferentialOperator-1028"><span class="linenos">1028</span></a><span class="sd">        using either a direct power series expansion or a Magnus expansion, </span>
</span><span id="PseudoDifferentialOperator-1029"><a href="#PseudoDifferentialOperator-1029"><span class="linenos">1029</span></a><span class="sd">        depending on the structure of the symbol. The result is valid up to </span>
</span><span id="PseudoDifferentialOperator-1030"><a href="#PseudoDifferentialOperator-1030"><span class="linenos">1030</span></a><span class="sd">        the specified asymptotic order.</span>
</span><span id="PseudoDifferentialOperator-1031"><a href="#PseudoDifferentialOperator-1031"><span class="linenos">1031</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1032"><a href="#PseudoDifferentialOperator-1032"><span class="linenos">1032</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1033"><a href="#PseudoDifferentialOperator-1033"><span class="linenos">1033</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1034"><a href="#PseudoDifferentialOperator-1034"><span class="linenos">1034</span></a><span class="sd">        t : float or sympy.Symbol, default=1.0</span>
</span><span id="PseudoDifferentialOperator-1035"><a href="#PseudoDifferentialOperator-1035"><span class="linenos">1035</span></a><span class="sd">            Time or evolution parameter. Common uses:</span>
</span><span id="PseudoDifferentialOperator-1036"><a href="#PseudoDifferentialOperator-1036"><span class="linenos">1036</span></a><span class="sd">            - t = -i*τ for Schrödinger evolution: exp(-iτH)</span>
</span><span id="PseudoDifferentialOperator-1037"><a href="#PseudoDifferentialOperator-1037"><span class="linenos">1037</span></a><span class="sd">            - t = τ for heat/diffusion: exp(τΔ)</span>
</span><span id="PseudoDifferentialOperator-1038"><a href="#PseudoDifferentialOperator-1038"><span class="linenos">1038</span></a><span class="sd">            - t for general propagators</span>
</span><span id="PseudoDifferentialOperator-1039"><a href="#PseudoDifferentialOperator-1039"><span class="linenos">1039</span></a><span class="sd">        order : int, default=3</span>
</span><span id="PseudoDifferentialOperator-1040"><a href="#PseudoDifferentialOperator-1040"><span class="linenos">1040</span></a><span class="sd">            Maximum order of the asymptotic expansion. Higher orders include </span>
</span><span id="PseudoDifferentialOperator-1041"><a href="#PseudoDifferentialOperator-1041"><span class="linenos">1041</span></a><span class="sd">            more composition terms, improving accuracy for small t or when </span>
</span><span id="PseudoDifferentialOperator-1042"><a href="#PseudoDifferentialOperator-1042"><span class="linenos">1042</span></a><span class="sd">            non-commutativity effects are significant.</span>
</span><span id="PseudoDifferentialOperator-1043"><a href="#PseudoDifferentialOperator-1043"><span class="linenos">1043</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1044"><a href="#PseudoDifferentialOperator-1044"><span class="linenos">1044</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1045"><a href="#PseudoDifferentialOperator-1045"><span class="linenos">1045</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1046"><a href="#PseudoDifferentialOperator-1046"><span class="linenos">1046</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator-1047"><a href="#PseudoDifferentialOperator-1047"><span class="linenos">1047</span></a><span class="sd">            Symbolic expression for the exponential operator symbol, computed </span>
</span><span id="PseudoDifferentialOperator-1048"><a href="#PseudoDifferentialOperator-1048"><span class="linenos">1048</span></a><span class="sd">            as an asymptotic series up to the specified order.</span>
</span><span id="PseudoDifferentialOperator-1049"><a href="#PseudoDifferentialOperator-1049"><span class="linenos">1049</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1050"><a href="#PseudoDifferentialOperator-1050"><span class="linenos">1050</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1051"><a href="#PseudoDifferentialOperator-1051"><span class="linenos">1051</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1052"><a href="#PseudoDifferentialOperator-1052"><span class="linenos">1052</span></a><span class="sd">        - For commutative symbols (e.g., pure multiplication operators), the </span>
</span><span id="PseudoDifferentialOperator-1053"><a href="#PseudoDifferentialOperator-1053"><span class="linenos">1053</span></a><span class="sd">          exponential is exact: exp(tP) = exp(t*p(x,ξ)).</span>
</span><span id="PseudoDifferentialOperator-1054"><a href="#PseudoDifferentialOperator-1054"><span class="linenos">1054</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1055"><a href="#PseudoDifferentialOperator-1055"><span class="linenos">1055</span></a><span class="sd">        - For general non-commutative operators, the method uses the BCH-type </span>
</span><span id="PseudoDifferentialOperator-1056"><a href="#PseudoDifferentialOperator-1056"><span class="linenos">1056</span></a><span class="sd">          expansion via iterated composition:</span>
</span><span id="PseudoDifferentialOperator-1057"><a href="#PseudoDifferentialOperator-1057"><span class="linenos">1057</span></a><span class="sd">          exp(tP) ~ I + tP + (t²/2!)P∘P + (t³/3!)P∘P∘P + ...</span>
</span><span id="PseudoDifferentialOperator-1058"><a href="#PseudoDifferentialOperator-1058"><span class="linenos">1058</span></a><span class="sd">          </span>
</span><span id="PseudoDifferentialOperator-1059"><a href="#PseudoDifferentialOperator-1059"><span class="linenos">1059</span></a><span class="sd">        - Each power P^n is computed via compose_asymptotic, which accounts </span>
</span><span id="PseudoDifferentialOperator-1060"><a href="#PseudoDifferentialOperator-1060"><span class="linenos">1060</span></a><span class="sd">          for the non-commutativity through derivative terms.</span>
</span><span id="PseudoDifferentialOperator-1061"><a href="#PseudoDifferentialOperator-1061"><span class="linenos">1061</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1062"><a href="#PseudoDifferentialOperator-1062"><span class="linenos">1062</span></a><span class="sd">        - The expansion is valid for |t| small enough or when the symbol has </span>
</span><span id="PseudoDifferentialOperator-1063"><a href="#PseudoDifferentialOperator-1063"><span class="linenos">1063</span></a><span class="sd">          appropriate decay/growth properties.</span>
</span><span id="PseudoDifferentialOperator-1064"><a href="#PseudoDifferentialOperator-1064"><span class="linenos">1064</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1065"><a href="#PseudoDifferentialOperator-1065"><span class="linenos">1065</span></a><span class="sd">        - In quantum mechanics (Schrödinger): U(t) = exp(-itH/ℏ) represents </span>
</span><span id="PseudoDifferentialOperator-1066"><a href="#PseudoDifferentialOperator-1066"><span class="linenos">1066</span></a><span class="sd">          the time evolution operator.</span>
</span><span id="PseudoDifferentialOperator-1067"><a href="#PseudoDifferentialOperator-1067"><span class="linenos">1067</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1068"><a href="#PseudoDifferentialOperator-1068"><span class="linenos">1068</span></a><span class="sd">        - In parabolic PDEs (heat equation): exp(tΔ) is the heat kernel.</span>
</span><span id="PseudoDifferentialOperator-1069"><a href="#PseudoDifferentialOperator-1069"><span class="linenos">1069</span></a>
</span><span id="PseudoDifferentialOperator-1070"><a href="#PseudoDifferentialOperator-1070"><span class="linenos">1070</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1071"><a href="#PseudoDifferentialOperator-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1072"><a href="#PseudoDifferentialOperator-1072"><span class="linenos">1072</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1073"><a href="#PseudoDifferentialOperator-1073"><span class="linenos">1073</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1074"><a href="#PseudoDifferentialOperator-1074"><span class="linenos">1074</span></a>            
</span><span id="PseudoDifferentialOperator-1075"><a href="#PseudoDifferentialOperator-1075"><span class="linenos">1075</span></a>            <span class="c1"># Initialize with identity</span>
</span><span id="PseudoDifferentialOperator-1076"><a href="#PseudoDifferentialOperator-1076"><span class="linenos">1076</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="PseudoDifferentialOperator-1077"><a href="#PseudoDifferentialOperator-1077"><span class="linenos">1077</span></a>            
</span><span id="PseudoDifferentialOperator-1078"><a href="#PseudoDifferentialOperator-1078"><span class="linenos">1078</span></a>            <span class="c1"># First order term: tP</span>
</span><span id="PseudoDifferentialOperator-1079"><a href="#PseudoDifferentialOperator-1079"><span class="linenos">1079</span></a>            <span class="n">current_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-1080"><a href="#PseudoDifferentialOperator-1080"><span class="linenos">1080</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator-1081"><a href="#PseudoDifferentialOperator-1081"><span class="linenos">1081</span></a>            
</span><span id="PseudoDifferentialOperator-1082"><a href="#PseudoDifferentialOperator-1082"><span class="linenos">1082</span></a>            <span class="c1"># Higher order terms: (t^n/n!) P^n computed via composition</span>
</span><span id="PseudoDifferentialOperator-1083"><a href="#PseudoDifferentialOperator-1083"><span class="linenos">1083</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1084"><a href="#PseudoDifferentialOperator-1084"><span class="linenos">1084</span></a>                <span class="c1"># Compute P^n = P^(n-1) ∘ P via asymptotic composition</span>
</span><span id="PseudoDifferentialOperator-1085"><a href="#PseudoDifferentialOperator-1085"><span class="linenos">1085</span></a>                <span class="c1"># We use a temporary operator for composition</span>
</span><span id="PseudoDifferentialOperator-1086"><a href="#PseudoDifferentialOperator-1086"><span class="linenos">1086</span></a>                <span class="n">temp_op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-1087"><a href="#PseudoDifferentialOperator-1087"><span class="linenos">1087</span></a>                    <span class="n">current_power</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span>
</span><span id="PseudoDifferentialOperator-1088"><a href="#PseudoDifferentialOperator-1088"><span class="linenos">1088</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1089"><a href="#PseudoDifferentialOperator-1089"><span class="linenos">1089</span></a>                <span class="n">current_power</span> <span class="o">=</span> <span class="n">temp_op</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1090"><a href="#PseudoDifferentialOperator-1090"><span class="linenos">1090</span></a>                
</span><span id="PseudoDifferentialOperator-1091"><a href="#PseudoDifferentialOperator-1091"><span class="linenos">1091</span></a>                <span class="c1"># Add term (t^n/n!) * P^n</span>
</span><span id="PseudoDifferentialOperator-1092"><a href="#PseudoDifferentialOperator-1092"><span class="linenos">1092</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">t</span><span class="o">**</span><span class="n">n</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1093"><a href="#PseudoDifferentialOperator-1093"><span class="linenos">1093</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator-1094"><a href="#PseudoDifferentialOperator-1094"><span class="linenos">1094</span></a>            
</span><span id="PseudoDifferentialOperator-1095"><a href="#PseudoDifferentialOperator-1095"><span class="linenos">1095</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1096"><a href="#PseudoDifferentialOperator-1096"><span class="linenos">1096</span></a>        
</span><span id="PseudoDifferentialOperator-1097"><a href="#PseudoDifferentialOperator-1097"><span class="linenos">1097</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1098"><a href="#PseudoDifferentialOperator-1098"><span class="linenos">1098</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1099"><a href="#PseudoDifferentialOperator-1099"><span class="linenos">1099</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1100"><a href="#PseudoDifferentialOperator-1100"><span class="linenos">1100</span></a>            
</span><span id="PseudoDifferentialOperator-1101"><a href="#PseudoDifferentialOperator-1101"><span class="linenos">1101</span></a>            <span class="c1"># Initialize with identity</span>
</span><span id="PseudoDifferentialOperator-1102"><a href="#PseudoDifferentialOperator-1102"><span class="linenos">1102</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="PseudoDifferentialOperator-1103"><a href="#PseudoDifferentialOperator-1103"><span class="linenos">1103</span></a>            
</span><span id="PseudoDifferentialOperator-1104"><a href="#PseudoDifferentialOperator-1104"><span class="linenos">1104</span></a>            <span class="c1"># First order term: tP</span>
</span><span id="PseudoDifferentialOperator-1105"><a href="#PseudoDifferentialOperator-1105"><span class="linenos">1105</span></a>            <span class="n">current_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-1106"><a href="#PseudoDifferentialOperator-1106"><span class="linenos">1106</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator-1107"><a href="#PseudoDifferentialOperator-1107"><span class="linenos">1107</span></a>            
</span><span id="PseudoDifferentialOperator-1108"><a href="#PseudoDifferentialOperator-1108"><span class="linenos">1108</span></a>            <span class="c1"># Higher order terms: (t^n/n!) P^n computed via composition</span>
</span><span id="PseudoDifferentialOperator-1109"><a href="#PseudoDifferentialOperator-1109"><span class="linenos">1109</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1110"><a href="#PseudoDifferentialOperator-1110"><span class="linenos">1110</span></a>                <span class="c1"># Compute P^n = P^(n-1) ∘ P via asymptotic composition</span>
</span><span id="PseudoDifferentialOperator-1111"><a href="#PseudoDifferentialOperator-1111"><span class="linenos">1111</span></a>                <span class="n">temp_op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-1112"><a href="#PseudoDifferentialOperator-1112"><span class="linenos">1112</span></a>                    <span class="n">current_power</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span>
</span><span id="PseudoDifferentialOperator-1113"><a href="#PseudoDifferentialOperator-1113"><span class="linenos">1113</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1114"><a href="#PseudoDifferentialOperator-1114"><span class="linenos">1114</span></a>                <span class="n">current_power</span> <span class="o">=</span> <span class="n">temp_op</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1115"><a href="#PseudoDifferentialOperator-1115"><span class="linenos">1115</span></a>                
</span><span id="PseudoDifferentialOperator-1116"><a href="#PseudoDifferentialOperator-1116"><span class="linenos">1116</span></a>                <span class="c1"># Add term (t^n/n!) * P^n</span>
</span><span id="PseudoDifferentialOperator-1117"><a href="#PseudoDifferentialOperator-1117"><span class="linenos">1117</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">t</span><span class="o">**</span><span class="n">n</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1118"><a href="#PseudoDifferentialOperator-1118"><span class="linenos">1118</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator-1119"><a href="#PseudoDifferentialOperator-1119"><span class="linenos">1119</span></a>            
</span><span id="PseudoDifferentialOperator-1120"><a href="#PseudoDifferentialOperator-1120"><span class="linenos">1120</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1121"><a href="#PseudoDifferentialOperator-1121"><span class="linenos">1121</span></a>        
</span><span id="PseudoDifferentialOperator-1122"><a href="#PseudoDifferentialOperator-1122"><span class="linenos">1122</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1123"><a href="#PseudoDifferentialOperator-1123"><span class="linenos">1123</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D operators are supported&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1124"><a href="#PseudoDifferentialOperator-1124"><span class="linenos">1124</span></a>        
</span><span id="PseudoDifferentialOperator-1125"><a href="#PseudoDifferentialOperator-1125"><span class="linenos">1125</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trace_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numerical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator-1126"><a href="#PseudoDifferentialOperator-1126"><span class="linenos">1126</span></a>                      <span class="n">x_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1127"><a href="#PseudoDifferentialOperator-1127"><span class="linenos">1127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1128"><a href="#PseudoDifferentialOperator-1128"><span class="linenos">1128</span></a><span class="sd">        Compute the semiclassical trace of the pseudo-differential operator.</span>
</span><span id="PseudoDifferentialOperator-1129"><a href="#PseudoDifferentialOperator-1129"><span class="linenos">1129</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1130"><a href="#PseudoDifferentialOperator-1130"><span class="linenos">1130</span></a><span class="sd">        The trace formula relates the quantum trace of an operator to a </span>
</span><span id="PseudoDifferentialOperator-1131"><a href="#PseudoDifferentialOperator-1131"><span class="linenos">1131</span></a><span class="sd">        phase-space integral of its symbol, providing a fundamental link </span>
</span><span id="PseudoDifferentialOperator-1132"><a href="#PseudoDifferentialOperator-1132"><span class="linenos">1132</span></a><span class="sd">        between classical and quantum mechanics. This implementation supports </span>
</span><span id="PseudoDifferentialOperator-1133"><a href="#PseudoDifferentialOperator-1133"><span class="linenos">1133</span></a><span class="sd">        both symbolic and numerical integration.</span>
</span><span id="PseudoDifferentialOperator-1134"><a href="#PseudoDifferentialOperator-1134"><span class="linenos">1134</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1135"><a href="#PseudoDifferentialOperator-1135"><span class="linenos">1135</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1136"><a href="#PseudoDifferentialOperator-1136"><span class="linenos">1136</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1137"><a href="#PseudoDifferentialOperator-1137"><span class="linenos">1137</span></a><span class="sd">        volume_element : sympy.Expr, optional</span>
</span><span id="PseudoDifferentialOperator-1138"><a href="#PseudoDifferentialOperator-1138"><span class="linenos">1138</span></a><span class="sd">            Custom volume element for the phase space integration. If None, </span>
</span><span id="PseudoDifferentialOperator-1139"><a href="#PseudoDifferentialOperator-1139"><span class="linenos">1139</span></a><span class="sd">            uses the standard Liouville measure dx dξ/(2π)^d.</span>
</span><span id="PseudoDifferentialOperator-1140"><a href="#PseudoDifferentialOperator-1140"><span class="linenos">1140</span></a><span class="sd">        numerical : bool, default=False</span>
</span><span id="PseudoDifferentialOperator-1141"><a href="#PseudoDifferentialOperator-1141"><span class="linenos">1141</span></a><span class="sd">            If True, perform numerical integration over specified bounds.</span>
</span><span id="PseudoDifferentialOperator-1142"><a href="#PseudoDifferentialOperator-1142"><span class="linenos">1142</span></a><span class="sd">            If False, attempt symbolic integration (may fail for complex symbols).</span>
</span><span id="PseudoDifferentialOperator-1143"><a href="#PseudoDifferentialOperator-1143"><span class="linenos">1143</span></a><span class="sd">        x_bounds : tuple of tuples, optional</span>
</span><span id="PseudoDifferentialOperator-1144"><a href="#PseudoDifferentialOperator-1144"><span class="linenos">1144</span></a><span class="sd">            Spatial integration bounds. For 1D: ((x_min, x_max),)</span>
</span><span id="PseudoDifferentialOperator-1145"><a href="#PseudoDifferentialOperator-1145"><span class="linenos">1145</span></a><span class="sd">            For 2D: ((x_min, x_max), (y_min, y_max))</span>
</span><span id="PseudoDifferentialOperator-1146"><a href="#PseudoDifferentialOperator-1146"><span class="linenos">1146</span></a><span class="sd">            Required if numerical=True.</span>
</span><span id="PseudoDifferentialOperator-1147"><a href="#PseudoDifferentialOperator-1147"><span class="linenos">1147</span></a><span class="sd">        xi_bounds : tuple of tuples, optional</span>
</span><span id="PseudoDifferentialOperator-1148"><a href="#PseudoDifferentialOperator-1148"><span class="linenos">1148</span></a><span class="sd">            Frequency integration bounds. For 1D: ((xi_min, xi_max),)</span>
</span><span id="PseudoDifferentialOperator-1149"><a href="#PseudoDifferentialOperator-1149"><span class="linenos">1149</span></a><span class="sd">            For 2D: ((xi_min, xi_max), (eta_min, eta_max))</span>
</span><span id="PseudoDifferentialOperator-1150"><a href="#PseudoDifferentialOperator-1150"><span class="linenos">1150</span></a><span class="sd">            Required if numerical=True.</span>
</span><span id="PseudoDifferentialOperator-1151"><a href="#PseudoDifferentialOperator-1151"><span class="linenos">1151</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1152"><a href="#PseudoDifferentialOperator-1152"><span class="linenos">1152</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1153"><a href="#PseudoDifferentialOperator-1153"><span class="linenos">1153</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1154"><a href="#PseudoDifferentialOperator-1154"><span class="linenos">1154</span></a><span class="sd">        sympy.Expr or float</span>
</span><span id="PseudoDifferentialOperator-1155"><a href="#PseudoDifferentialOperator-1155"><span class="linenos">1155</span></a><span class="sd">            The trace of the operator. Returns a symbolic expression if </span>
</span><span id="PseudoDifferentialOperator-1156"><a href="#PseudoDifferentialOperator-1156"><span class="linenos">1156</span></a><span class="sd">            numerical=False, or a float if numerical=True.</span>
</span><span id="PseudoDifferentialOperator-1157"><a href="#PseudoDifferentialOperator-1157"><span class="linenos">1157</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1158"><a href="#PseudoDifferentialOperator-1158"><span class="linenos">1158</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1159"><a href="#PseudoDifferentialOperator-1159"><span class="linenos">1159</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1160"><a href="#PseudoDifferentialOperator-1160"><span class="linenos">1160</span></a><span class="sd">        - The semiclassical trace formula states:</span>
</span><span id="PseudoDifferentialOperator-1161"><a href="#PseudoDifferentialOperator-1161"><span class="linenos">1161</span></a><span class="sd">          Tr(P) = (2π)^{-d} ∫∫ p(x,ξ) dx dξ</span>
</span><span id="PseudoDifferentialOperator-1162"><a href="#PseudoDifferentialOperator-1162"><span class="linenos">1162</span></a><span class="sd">          where d is the spatial dimension and p(x,ξ) is the operator symbol.</span>
</span><span id="PseudoDifferentialOperator-1163"><a href="#PseudoDifferentialOperator-1163"><span class="linenos">1163</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1164"><a href="#PseudoDifferentialOperator-1164"><span class="linenos">1164</span></a><span class="sd">        - For 1D: Tr(P) = (1/2π) ∫_{-∞}^{∞} ∫_{-∞}^{∞} p(x,ξ) dx dξ</span>
</span><span id="PseudoDifferentialOperator-1165"><a href="#PseudoDifferentialOperator-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1166"><a href="#PseudoDifferentialOperator-1166"><span class="linenos">1166</span></a><span class="sd">        - For 2D: Tr(P) = (1/4π²) ∫∫∫∫ p(x,y,ξ,η) dx dy dξ dη</span>
</span><span id="PseudoDifferentialOperator-1167"><a href="#PseudoDifferentialOperator-1167"><span class="linenos">1167</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1168"><a href="#PseudoDifferentialOperator-1168"><span class="linenos">1168</span></a><span class="sd">        - This formula is exact for trace-class operators and provides an </span>
</span><span id="PseudoDifferentialOperator-1169"><a href="#PseudoDifferentialOperator-1169"><span class="linenos">1169</span></a><span class="sd">          asymptotic approximation for general pseudo-differential operators.</span>
</span><span id="PseudoDifferentialOperator-1170"><a href="#PseudoDifferentialOperator-1170"><span class="linenos">1170</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1171"><a href="#PseudoDifferentialOperator-1171"><span class="linenos">1171</span></a><span class="sd">        - Physical interpretation: the trace counts the &quot;number of states&quot; </span>
</span><span id="PseudoDifferentialOperator-1172"><a href="#PseudoDifferentialOperator-1172"><span class="linenos">1172</span></a><span class="sd">          weighted by the observable p(x,ξ).</span>
</span><span id="PseudoDifferentialOperator-1173"><a href="#PseudoDifferentialOperator-1173"><span class="linenos">1173</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1174"><a href="#PseudoDifferentialOperator-1174"><span class="linenos">1174</span></a><span class="sd">        - For projection operators (χ_Ω with χ² = χ), the trace gives the </span>
</span><span id="PseudoDifferentialOperator-1175"><a href="#PseudoDifferentialOperator-1175"><span class="linenos">1175</span></a><span class="sd">          dimension of the range, related to the phase space volume of Ω.</span>
</span><span id="PseudoDifferentialOperator-1176"><a href="#PseudoDifferentialOperator-1176"><span class="linenos">1176</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1177"><a href="#PseudoDifferentialOperator-1177"><span class="linenos">1177</span></a><span class="sd">        - The factor (2π)^{-d} comes from the quantum normalization of </span>
</span><span id="PseudoDifferentialOperator-1178"><a href="#PseudoDifferentialOperator-1178"><span class="linenos">1178</span></a><span class="sd">          coherent states / Weyl quantization.</span>
</span><span id="PseudoDifferentialOperator-1179"><a href="#PseudoDifferentialOperator-1179"><span class="linenos">1179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1180"><a href="#PseudoDifferentialOperator-1180"><span class="linenos">1180</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">lambdify</span>
</span><span id="PseudoDifferentialOperator-1181"><a href="#PseudoDifferentialOperator-1181"><span class="linenos">1181</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">dblquad</span><span class="p">,</span> <span class="n">nquad</span>
</span><span id="PseudoDifferentialOperator-1182"><a href="#PseudoDifferentialOperator-1182"><span class="linenos">1182</span></a>        
</span><span id="PseudoDifferentialOperator-1183"><a href="#PseudoDifferentialOperator-1183"><span class="linenos">1183</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-1184"><a href="#PseudoDifferentialOperator-1184"><span class="linenos">1184</span></a>        
</span><span id="PseudoDifferentialOperator-1185"><a href="#PseudoDifferentialOperator-1185"><span class="linenos">1185</span></a>        <span class="k">if</span> <span class="n">numerical</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1186"><a href="#PseudoDifferentialOperator-1186"><span class="linenos">1186</span></a>            <span class="k">if</span> <span class="n">x_bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xi_bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1187"><a href="#PseudoDifferentialOperator-1187"><span class="linenos">1187</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-1188"><a href="#PseudoDifferentialOperator-1188"><span class="linenos">1188</span></a>                    <span class="s2">&quot;x_bounds and xi_bounds must be provided for numerical integration&quot;</span>
</span><span id="PseudoDifferentialOperator-1189"><a href="#PseudoDifferentialOperator-1189"><span class="linenos">1189</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1190"><a href="#PseudoDifferentialOperator-1190"><span class="linenos">1190</span></a>        
</span><span id="PseudoDifferentialOperator-1191"><a href="#PseudoDifferentialOperator-1191"><span class="linenos">1191</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1192"><a href="#PseudoDifferentialOperator-1192"><span class="linenos">1192</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1193"><a href="#PseudoDifferentialOperator-1193"><span class="linenos">1193</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1194"><a href="#PseudoDifferentialOperator-1194"><span class="linenos">1194</span></a>            
</span><span id="PseudoDifferentialOperator-1195"><a href="#PseudoDifferentialOperator-1195"><span class="linenos">1195</span></a>            <span class="k">if</span> <span class="n">volume_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1196"><a href="#PseudoDifferentialOperator-1196"><span class="linenos">1196</span></a>                <span class="n">volume_element</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1197"><a href="#PseudoDifferentialOperator-1197"><span class="linenos">1197</span></a>            
</span><span id="PseudoDifferentialOperator-1198"><a href="#PseudoDifferentialOperator-1198"><span class="linenos">1198</span></a>            <span class="k">if</span> <span class="n">numerical</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1199"><a href="#PseudoDifferentialOperator-1199"><span class="linenos">1199</span></a>                <span class="c1"># Numerical integration</span>
</span><span id="PseudoDifferentialOperator-1200"><a href="#PseudoDifferentialOperator-1200"><span class="linenos">1200</span></a>                <span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1201"><a href="#PseudoDifferentialOperator-1201"><span class="linenos">1201</span></a>                <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="o">=</span> <span class="n">x_bounds</span>
</span><span id="PseudoDifferentialOperator-1202"><a href="#PseudoDifferentialOperator-1202"><span class="linenos">1202</span></a>                <span class="p">(</span><span class="n">xi_min</span><span class="p">,</span> <span class="n">xi_max</span><span class="p">),</span> <span class="o">=</span> <span class="n">xi_bounds</span>
</span><span id="PseudoDifferentialOperator-1203"><a href="#PseudoDifferentialOperator-1203"><span class="linenos">1203</span></a>                
</span><span id="PseudoDifferentialOperator-1204"><a href="#PseudoDifferentialOperator-1204"><span class="linenos">1204</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">integrand</span><span class="p">(</span><span class="n">xi_val</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1205"><a href="#PseudoDifferentialOperator-1205"><span class="linenos">1205</span></a>                    <span class="k">return</span> <span class="n">p_func</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1206"><a href="#PseudoDifferentialOperator-1206"><span class="linenos">1206</span></a>                
</span><span id="PseudoDifferentialOperator-1207"><a href="#PseudoDifferentialOperator-1207"><span class="linenos">1207</span></a>                <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">dblquad</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-1208"><a href="#PseudoDifferentialOperator-1208"><span class="linenos">1208</span></a>                    <span class="n">integrand</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1209"><a href="#PseudoDifferentialOperator-1209"><span class="linenos">1209</span></a>                    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1210"><a href="#PseudoDifferentialOperator-1210"><span class="linenos">1210</span></a>                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">xi_min</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">xi_max</span>
</span><span id="PseudoDifferentialOperator-1211"><a href="#PseudoDifferentialOperator-1211"><span class="linenos">1211</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1212"><a href="#PseudoDifferentialOperator-1212"><span class="linenos">1212</span></a>                
</span><span id="PseudoDifferentialOperator-1213"><a href="#PseudoDifferentialOperator-1213"><span class="linenos">1213</span></a>                <span class="n">result</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">volume_element</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1214"><a href="#PseudoDifferentialOperator-1214"><span class="linenos">1214</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numerical trace = </span><span class="si">{</span><span class="n">result</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1215"><a href="#PseudoDifferentialOperator-1215"><span class="linenos">1215</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="PseudoDifferentialOperator-1216"><a href="#PseudoDifferentialOperator-1216"><span class="linenos">1216</span></a>            
</span><span id="PseudoDifferentialOperator-1217"><a href="#PseudoDifferentialOperator-1217"><span class="linenos">1217</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1218"><a href="#PseudoDifferentialOperator-1218"><span class="linenos">1218</span></a>                <span class="c1"># Symbolic integration</span>
</span><span id="PseudoDifferentialOperator-1219"><a href="#PseudoDifferentialOperator-1219"><span class="linenos">1219</span></a>                <span class="n">integrand</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">volume_element</span>
</span><span id="PseudoDifferentialOperator-1220"><a href="#PseudoDifferentialOperator-1220"><span class="linenos">1220</span></a>                
</span><span id="PseudoDifferentialOperator-1221"><a href="#PseudoDifferentialOperator-1221"><span class="linenos">1221</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1222"><a href="#PseudoDifferentialOperator-1222"><span class="linenos">1222</span></a>                    <span class="c1"># Try to integrate over xi first, then x</span>
</span><span id="PseudoDifferentialOperator-1223"><a href="#PseudoDifferentialOperator-1223"><span class="linenos">1223</span></a>                    <span class="n">integral_xi</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1224"><a href="#PseudoDifferentialOperator-1224"><span class="linenos">1224</span></a>                    <span class="n">integral_x</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_xi</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1225"><a href="#PseudoDifferentialOperator-1225"><span class="linenos">1225</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">integral_x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1226"><a href="#PseudoDifferentialOperator-1226"><span class="linenos">1226</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1227"><a href="#PseudoDifferentialOperator-1227"><span class="linenos">1227</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Symbolic integration failed. Try numerical=True&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1228"><a href="#PseudoDifferentialOperator-1228"><span class="linenos">1228</span></a>                    <span class="k">return</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1229"><a href="#PseudoDifferentialOperator-1229"><span class="linenos">1229</span></a>        
</span><span id="PseudoDifferentialOperator-1230"><a href="#PseudoDifferentialOperator-1230"><span class="linenos">1230</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1231"><a href="#PseudoDifferentialOperator-1231"><span class="linenos">1231</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1232"><a href="#PseudoDifferentialOperator-1232"><span class="linenos">1232</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1233"><a href="#PseudoDifferentialOperator-1233"><span class="linenos">1233</span></a>            
</span><span id="PseudoDifferentialOperator-1234"><a href="#PseudoDifferentialOperator-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="n">volume_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1235"><a href="#PseudoDifferentialOperator-1235"><span class="linenos">1235</span></a>                <span class="n">volume_element</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1236"><a href="#PseudoDifferentialOperator-1236"><span class="linenos">1236</span></a>            
</span><span id="PseudoDifferentialOperator-1237"><a href="#PseudoDifferentialOperator-1237"><span class="linenos">1237</span></a>            <span class="k">if</span> <span class="n">numerical</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1238"><a href="#PseudoDifferentialOperator-1238"><span class="linenos">1238</span></a>                <span class="c1"># Numerical integration in 4D</span>
</span><span id="PseudoDifferentialOperator-1239"><a href="#PseudoDifferentialOperator-1239"><span class="linenos">1239</span></a>                <span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1240"><a href="#PseudoDifferentialOperator-1240"><span class="linenos">1240</span></a>                <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_bounds</span>
</span><span id="PseudoDifferentialOperator-1241"><a href="#PseudoDifferentialOperator-1241"><span class="linenos">1241</span></a>                <span class="p">(</span><span class="n">xi_min</span><span class="p">,</span> <span class="n">xi_max</span><span class="p">),</span> <span class="p">(</span><span class="n">eta_min</span><span class="p">,</span> <span class="n">eta_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">xi_bounds</span>
</span><span id="PseudoDifferentialOperator-1242"><a href="#PseudoDifferentialOperator-1242"><span class="linenos">1242</span></a>                
</span><span id="PseudoDifferentialOperator-1243"><a href="#PseudoDifferentialOperator-1243"><span class="linenos">1243</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">integrand</span><span class="p">(</span><span class="n">eta_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1244"><a href="#PseudoDifferentialOperator-1244"><span class="linenos">1244</span></a>                    <span class="k">return</span> <span class="n">p_func</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">,</span> <span class="n">eta_val</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1245"><a href="#PseudoDifferentialOperator-1245"><span class="linenos">1245</span></a>                
</span><span id="PseudoDifferentialOperator-1246"><a href="#PseudoDifferentialOperator-1246"><span class="linenos">1246</span></a>                <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">nquad</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-1247"><a href="#PseudoDifferentialOperator-1247"><span class="linenos">1247</span></a>                    <span class="n">integrand</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1248"><a href="#PseudoDifferentialOperator-1248"><span class="linenos">1248</span></a>                    <span class="p">[</span>
</span><span id="PseudoDifferentialOperator-1249"><a href="#PseudoDifferentialOperator-1249"><span class="linenos">1249</span></a>                        <span class="p">[</span><span class="n">eta_min</span><span class="p">,</span> <span class="n">eta_max</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator-1250"><a href="#PseudoDifferentialOperator-1250"><span class="linenos">1250</span></a>                        <span class="p">[</span><span class="n">xi_min</span><span class="p">,</span> <span class="n">xi_max</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator-1251"><a href="#PseudoDifferentialOperator-1251"><span class="linenos">1251</span></a>                        <span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator-1252"><a href="#PseudoDifferentialOperator-1252"><span class="linenos">1252</span></a>                        <span class="p">[</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1253"><a href="#PseudoDifferentialOperator-1253"><span class="linenos">1253</span></a>                    <span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1254"><a href="#PseudoDifferentialOperator-1254"><span class="linenos">1254</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1255"><a href="#PseudoDifferentialOperator-1255"><span class="linenos">1255</span></a>                
</span><span id="PseudoDifferentialOperator-1256"><a href="#PseudoDifferentialOperator-1256"><span class="linenos">1256</span></a>                <span class="n">result</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">volume_element</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1257"><a href="#PseudoDifferentialOperator-1257"><span class="linenos">1257</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numerical trace = </span><span class="si">{</span><span class="n">result</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1258"><a href="#PseudoDifferentialOperator-1258"><span class="linenos">1258</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="PseudoDifferentialOperator-1259"><a href="#PseudoDifferentialOperator-1259"><span class="linenos">1259</span></a>            
</span><span id="PseudoDifferentialOperator-1260"><a href="#PseudoDifferentialOperator-1260"><span class="linenos">1260</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1261"><a href="#PseudoDifferentialOperator-1261"><span class="linenos">1261</span></a>                <span class="c1"># Symbolic integration</span>
</span><span id="PseudoDifferentialOperator-1262"><a href="#PseudoDifferentialOperator-1262"><span class="linenos">1262</span></a>                <span class="n">integrand</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">volume_element</span>
</span><span id="PseudoDifferentialOperator-1263"><a href="#PseudoDifferentialOperator-1263"><span class="linenos">1263</span></a>                
</span><span id="PseudoDifferentialOperator-1264"><a href="#PseudoDifferentialOperator-1264"><span class="linenos">1264</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1265"><a href="#PseudoDifferentialOperator-1265"><span class="linenos">1265</span></a>                    <span class="c1"># Integrate in order: eta, xi, y, x</span>
</span><span id="PseudoDifferentialOperator-1266"><a href="#PseudoDifferentialOperator-1266"><span class="linenos">1266</span></a>                    <span class="n">integral_eta</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1267"><a href="#PseudoDifferentialOperator-1267"><span class="linenos">1267</span></a>                    <span class="n">integral_xi</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_eta</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1268"><a href="#PseudoDifferentialOperator-1268"><span class="linenos">1268</span></a>                    <span class="n">integral_y</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_xi</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1269"><a href="#PseudoDifferentialOperator-1269"><span class="linenos">1269</span></a>                    <span class="n">integral_x</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_y</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1270"><a href="#PseudoDifferentialOperator-1270"><span class="linenos">1270</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">integral_x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1271"><a href="#PseudoDifferentialOperator-1271"><span class="linenos">1271</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1272"><a href="#PseudoDifferentialOperator-1272"><span class="linenos">1272</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Symbolic integration failed. Try numerical=True&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1273"><a href="#PseudoDifferentialOperator-1273"><span class="linenos">1273</span></a>                    <span class="k">return</span> <span class="n">integrate</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-1274"><a href="#PseudoDifferentialOperator-1274"><span class="linenos">1274</span></a>                        <span class="n">integrand</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1275"><a href="#PseudoDifferentialOperator-1275"><span class="linenos">1275</span></a>                        <span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1276"><a href="#PseudoDifferentialOperator-1276"><span class="linenos">1276</span></a>                        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1277"><a href="#PseudoDifferentialOperator-1277"><span class="linenos">1277</span></a>                    <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1278"><a href="#PseudoDifferentialOperator-1278"><span class="linenos">1278</span></a>        
</span><span id="PseudoDifferentialOperator-1279"><a href="#PseudoDifferentialOperator-1279"><span class="linenos">1279</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1280"><a href="#PseudoDifferentialOperator-1280"><span class="linenos">1280</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D operators are supported&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1281"><a href="#PseudoDifferentialOperator-1281"><span class="linenos">1281</span></a>
</span><span id="PseudoDifferentialOperator-1282"><a href="#PseudoDifferentialOperator-1282"><span class="linenos">1282</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pseudospectrum_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">lambda_real_range</span><span class="p">,</span> <span class="n">lambda_imag_range</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator-1283"><a href="#PseudoDifferentialOperator-1283"><span class="linenos">1283</span></a>                               <span class="n">epsilon_levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator-1284"><a href="#PseudoDifferentialOperator-1284"><span class="linenos">1284</span></a>                               <span class="n">resolution</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;spectral&#39;</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1285"><a href="#PseudoDifferentialOperator-1285"><span class="linenos">1285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1286"><a href="#PseudoDifferentialOperator-1286"><span class="linenos">1286</span></a><span class="sd">        Compute and visualize the pseudospectrum of the pseudo-differential operator.</span>
</span><span id="PseudoDifferentialOperator-1287"><a href="#PseudoDifferentialOperator-1287"><span class="linenos">1287</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1288"><a href="#PseudoDifferentialOperator-1288"><span class="linenos">1288</span></a><span class="sd">        The ε-pseudospectrum is defined as:</span>
</span><span id="PseudoDifferentialOperator-1289"><a href="#PseudoDifferentialOperator-1289"><span class="linenos">1289</span></a><span class="sd">            Λ_ε(A) = { λ ∈ ℂ : ‖(A - λI)^{-1}‖ ≥ ε^{-1} }</span>
</span><span id="PseudoDifferentialOperator-1290"><a href="#PseudoDifferentialOperator-1290"><span class="linenos">1290</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1291"><a href="#PseudoDifferentialOperator-1291"><span class="linenos">1291</span></a><span class="sd">        This method quantizes the operator symbol into a matrix representation </span>
</span><span id="PseudoDifferentialOperator-1292"><a href="#PseudoDifferentialOperator-1292"><span class="linenos">1292</span></a><span class="sd">        and samples the resolvent norm over a grid in the complex plane.</span>
</span><span id="PseudoDifferentialOperator-1293"><a href="#PseudoDifferentialOperator-1293"><span class="linenos">1293</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1294"><a href="#PseudoDifferentialOperator-1294"><span class="linenos">1294</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1295"><a href="#PseudoDifferentialOperator-1295"><span class="linenos">1295</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1296"><a href="#PseudoDifferentialOperator-1296"><span class="linenos">1296</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1297"><a href="#PseudoDifferentialOperator-1297"><span class="linenos">1297</span></a><span class="sd">            Spatial discretization grid (used if method=&#39;finite_difference&#39;)</span>
</span><span id="PseudoDifferentialOperator-1298"><a href="#PseudoDifferentialOperator-1298"><span class="linenos">1298</span></a><span class="sd">        lambda_real_range : tuple</span>
</span><span id="PseudoDifferentialOperator-1299"><a href="#PseudoDifferentialOperator-1299"><span class="linenos">1299</span></a><span class="sd">            Real part range of complex λ: (λ_re_min, λ_re_max)</span>
</span><span id="PseudoDifferentialOperator-1300"><a href="#PseudoDifferentialOperator-1300"><span class="linenos">1300</span></a><span class="sd">        lambda_imag_range : tuple</span>
</span><span id="PseudoDifferentialOperator-1301"><a href="#PseudoDifferentialOperator-1301"><span class="linenos">1301</span></a><span class="sd">            Imaginary part range: (λ_im_min, λ_im_max)</span>
</span><span id="PseudoDifferentialOperator-1302"><a href="#PseudoDifferentialOperator-1302"><span class="linenos">1302</span></a><span class="sd">        epsilon_levels : list of float</span>
</span><span id="PseudoDifferentialOperator-1303"><a href="#PseudoDifferentialOperator-1303"><span class="linenos">1303</span></a><span class="sd">            Contour levels for ε-pseudospectrum boundaries</span>
</span><span id="PseudoDifferentialOperator-1304"><a href="#PseudoDifferentialOperator-1304"><span class="linenos">1304</span></a><span class="sd">        resolution : int</span>
</span><span id="PseudoDifferentialOperator-1305"><a href="#PseudoDifferentialOperator-1305"><span class="linenos">1305</span></a><span class="sd">            Number of grid points per axis in the λ-plane</span>
</span><span id="PseudoDifferentialOperator-1306"><a href="#PseudoDifferentialOperator-1306"><span class="linenos">1306</span></a><span class="sd">        method : str</span>
</span><span id="PseudoDifferentialOperator-1307"><a href="#PseudoDifferentialOperator-1307"><span class="linenos">1307</span></a><span class="sd">            Discretization method:</span>
</span><span id="PseudoDifferentialOperator-1308"><a href="#PseudoDifferentialOperator-1308"><span class="linenos">1308</span></a><span class="sd">            - &#39;spectral&#39;: FFT-based spectral differentiation (periodic, high accuracy)</span>
</span><span id="PseudoDifferentialOperator-1309"><a href="#PseudoDifferentialOperator-1309"><span class="linenos">1309</span></a><span class="sd">            - &#39;finite_difference&#39;: Standard finite differences</span>
</span><span id="PseudoDifferentialOperator-1310"><a href="#PseudoDifferentialOperator-1310"><span class="linenos">1310</span></a><span class="sd">        L : float, optional</span>
</span><span id="PseudoDifferentialOperator-1311"><a href="#PseudoDifferentialOperator-1311"><span class="linenos">1311</span></a><span class="sd">            Half-domain length for spectral method (default: inferred from x_grid)</span>
</span><span id="PseudoDifferentialOperator-1312"><a href="#PseudoDifferentialOperator-1312"><span class="linenos">1312</span></a><span class="sd">        N : int, optional</span>
</span><span id="PseudoDifferentialOperator-1313"><a href="#PseudoDifferentialOperator-1313"><span class="linenos">1313</span></a><span class="sd">            Number of grid points for spectral method (default: len(x_grid))</span>
</span><span id="PseudoDifferentialOperator-1314"><a href="#PseudoDifferentialOperator-1314"><span class="linenos">1314</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1315"><a href="#PseudoDifferentialOperator-1315"><span class="linenos">1315</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1316"><a href="#PseudoDifferentialOperator-1316"><span class="linenos">1316</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1317"><a href="#PseudoDifferentialOperator-1317"><span class="linenos">1317</span></a><span class="sd">        dict</span>
</span><span id="PseudoDifferentialOperator-1318"><a href="#PseudoDifferentialOperator-1318"><span class="linenos">1318</span></a><span class="sd">            Contains:</span>
</span><span id="PseudoDifferentialOperator-1319"><a href="#PseudoDifferentialOperator-1319"><span class="linenos">1319</span></a><span class="sd">            - &#39;lambda_grid&#39;: meshgrid of complex λ values</span>
</span><span id="PseudoDifferentialOperator-1320"><a href="#PseudoDifferentialOperator-1320"><span class="linenos">1320</span></a><span class="sd">            - &#39;resolvent_norm&#39;: 2D array of ‖(A - λI)^{-1}‖</span>
</span><span id="PseudoDifferentialOperator-1321"><a href="#PseudoDifferentialOperator-1321"><span class="linenos">1321</span></a><span class="sd">            - &#39;sigma_min&#39;: 2D array of σ_min(A - λI)</span>
</span><span id="PseudoDifferentialOperator-1322"><a href="#PseudoDifferentialOperator-1322"><span class="linenos">1322</span></a><span class="sd">            - &#39;epsilon_levels&#39;: input epsilon levels</span>
</span><span id="PseudoDifferentialOperator-1323"><a href="#PseudoDifferentialOperator-1323"><span class="linenos">1323</span></a><span class="sd">            - &#39;eigenvalues&#39;: computed eigenvalues (if available)</span>
</span><span id="PseudoDifferentialOperator-1324"><a href="#PseudoDifferentialOperator-1324"><span class="linenos">1324</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1325"><a href="#PseudoDifferentialOperator-1325"><span class="linenos">1325</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1326"><a href="#PseudoDifferentialOperator-1326"><span class="linenos">1326</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1327"><a href="#PseudoDifferentialOperator-1327"><span class="linenos">1327</span></a><span class="sd">        - For non-self-adjoint operators, the pseudospectrum can extend far from </span>
</span><span id="PseudoDifferentialOperator-1328"><a href="#PseudoDifferentialOperator-1328"><span class="linenos">1328</span></a><span class="sd">          the actual spectrum, revealing transient behavior and non-normal dynamics.</span>
</span><span id="PseudoDifferentialOperator-1329"><a href="#PseudoDifferentialOperator-1329"><span class="linenos">1329</span></a><span class="sd">        - The spectral method is preferred for smooth, periodic-like symbols.</span>
</span><span id="PseudoDifferentialOperator-1330"><a href="#PseudoDifferentialOperator-1330"><span class="linenos">1330</span></a><span class="sd">        - Computational cost scales as O(resolution² × N³) due to SVD at each λ.</span>
</span><span id="PseudoDifferentialOperator-1331"><a href="#PseudoDifferentialOperator-1331"><span class="linenos">1331</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1332"><a href="#PseudoDifferentialOperator-1332"><span class="linenos">1332</span></a><span class="sd">        Examples</span>
</span><span id="PseudoDifferentialOperator-1333"><a href="#PseudoDifferentialOperator-1333"><span class="linenos">1333</span></a><span class="sd">        --------</span>
</span><span id="PseudoDifferentialOperator-1334"><a href="#PseudoDifferentialOperator-1334"><span class="linenos">1334</span></a><span class="sd">        &gt;&gt;&gt; # Analyze pseudospectrum of a non-self-adjoint operator</span>
</span><span id="PseudoDifferentialOperator-1335"><a href="#PseudoDifferentialOperator-1335"><span class="linenos">1335</span></a><span class="sd">        &gt;&gt;&gt; x, xi = symbols(&#39;x xi&#39;, real=True)</span>
</span><span id="PseudoDifferentialOperator-1336"><a href="#PseudoDifferentialOperator-1336"><span class="linenos">1336</span></a><span class="sd">        &gt;&gt;&gt; symbol = xi**2 + 1j*x*xi  # non-self-adjoint</span>
</span><span id="PseudoDifferentialOperator-1337"><a href="#PseudoDifferentialOperator-1337"><span class="linenos">1337</span></a><span class="sd">        &gt;&gt;&gt; op = PseudoDifferentialOperator(symbol, [x], mode=&#39;symbol&#39;)</span>
</span><span id="PseudoDifferentialOperator-1338"><a href="#PseudoDifferentialOperator-1338"><span class="linenos">1338</span></a><span class="sd">        &gt;&gt;&gt; result = op.pseudospectrum_analysis(</span>
</span><span id="PseudoDifferentialOperator-1339"><a href="#PseudoDifferentialOperator-1339"><span class="linenos">1339</span></a><span class="sd">        ...     x_grid=np.linspace(-5, 5, 128),</span>
</span><span id="PseudoDifferentialOperator-1340"><a href="#PseudoDifferentialOperator-1340"><span class="linenos">1340</span></a><span class="sd">        ...     lambda_real_range=(-2, 10),</span>
</span><span id="PseudoDifferentialOperator-1341"><a href="#PseudoDifferentialOperator-1341"><span class="linenos">1341</span></a><span class="sd">        ...     lambda_imag_range=(-3, 3),</span>
</span><span id="PseudoDifferentialOperator-1342"><a href="#PseudoDifferentialOperator-1342"><span class="linenos">1342</span></a><span class="sd">        ...     method=&#39;spectral&#39;</span>
</span><span id="PseudoDifferentialOperator-1343"><a href="#PseudoDifferentialOperator-1343"><span class="linenos">1343</span></a><span class="sd">        ... )</span>
</span><span id="PseudoDifferentialOperator-1344"><a href="#PseudoDifferentialOperator-1344"><span class="linenos">1344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1345"><a href="#PseudoDifferentialOperator-1345"><span class="linenos">1345</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">svdvals</span>
</span><span id="PseudoDifferentialOperator-1346"><a href="#PseudoDifferentialOperator-1346"><span class="linenos">1346</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">diags</span>
</span><span id="PseudoDifferentialOperator-1347"><a href="#PseudoDifferentialOperator-1347"><span class="linenos">1347</span></a>        
</span><span id="PseudoDifferentialOperator-1348"><a href="#PseudoDifferentialOperator-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1349"><a href="#PseudoDifferentialOperator-1349"><span class="linenos">1349</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Pseudospectrum analysis currently supports 1D only&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1350"><a href="#PseudoDifferentialOperator-1350"><span class="linenos">1350</span></a>        
</span><span id="PseudoDifferentialOperator-1351"><a href="#PseudoDifferentialOperator-1351"><span class="linenos">1351</span></a>        <span class="c1"># --- Step 1: Quantize the operator into a matrix ---</span>
</span><span id="PseudoDifferentialOperator-1352"><a href="#PseudoDifferentialOperator-1352"><span class="linenos">1352</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;spectral&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1353"><a href="#PseudoDifferentialOperator-1353"><span class="linenos">1353</span></a>            <span class="c1"># Spectral (FFT) discretization</span>
</span><span id="PseudoDifferentialOperator-1354"><a href="#PseudoDifferentialOperator-1354"><span class="linenos">1354</span></a>            <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1355"><a href="#PseudoDifferentialOperator-1355"><span class="linenos">1355</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="PseudoDifferentialOperator-1356"><a href="#PseudoDifferentialOperator-1356"><span class="linenos">1356</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1357"><a href="#PseudoDifferentialOperator-1357"><span class="linenos">1357</span></a>                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1358"><a href="#PseudoDifferentialOperator-1358"><span class="linenos">1358</span></a>            
</span><span id="PseudoDifferentialOperator-1359"><a href="#PseudoDifferentialOperator-1359"><span class="linenos">1359</span></a>            <span class="n">x_grid_spectral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1360"><a href="#PseudoDifferentialOperator-1360"><span class="linenos">1360</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="n">x_grid_spectral</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid_spectral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1361"><a href="#PseudoDifferentialOperator-1361"><span class="linenos">1361</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="PseudoDifferentialOperator-1362"><a href="#PseudoDifferentialOperator-1362"><span class="linenos">1362</span></a>            <span class="n">k2</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># symbol for -d²/dx²</span>
</span><span id="PseudoDifferentialOperator-1363"><a href="#PseudoDifferentialOperator-1363"><span class="linenos">1363</span></a>            
</span><span id="PseudoDifferentialOperator-1364"><a href="#PseudoDifferentialOperator-1364"><span class="linenos">1364</span></a>            <span class="c1"># Build operator matrix via spectral differentiation</span>
</span><span id="PseudoDifferentialOperator-1365"><a href="#PseudoDifferentialOperator-1365"><span class="linenos">1365</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">apply_operator</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1366"><a href="#PseudoDifferentialOperator-1366"><span class="linenos">1366</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;Apply Op(symbol) to vector u&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1367"><a href="#PseudoDifferentialOperator-1367"><span class="linenos">1367</span></a>                <span class="n">u_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1368"><a href="#PseudoDifferentialOperator-1368"><span class="linenos">1368</span></a>                <span class="c1"># Extract kinetic part from symbol (assuming symbol = f(xi) + g(x))</span>
</span><span id="PseudoDifferentialOperator-1369"><a href="#PseudoDifferentialOperator-1369"><span class="linenos">1369</span></a>                <span class="c1"># This is a simplified model; for general symbols, use full quantization</span>
</span><span id="PseudoDifferentialOperator-1370"><a href="#PseudoDifferentialOperator-1370"><span class="linenos">1370</span></a>                <span class="n">kinetic</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">u_hat</span>
</span><span id="PseudoDifferentialOperator-1371"><a href="#PseudoDifferentialOperator-1371"><span class="linenos">1371</span></a>                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">kinetic</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1372"><a href="#PseudoDifferentialOperator-1372"><span class="linenos">1372</span></a>                <span class="c1"># Add potential/position-dependent part</span>
</span><span id="PseudoDifferentialOperator-1373"><a href="#PseudoDifferentialOperator-1373"><span class="linenos">1373</span></a>                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">x_grid_spectral</span>
</span><span id="PseudoDifferentialOperator-1374"><a href="#PseudoDifferentialOperator-1374"><span class="linenos">1374</span></a>                <span class="n">potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># evaluate at ξ=0 for position part</span>
</span><span id="PseudoDifferentialOperator-1375"><a href="#PseudoDifferentialOperator-1375"><span class="linenos">1375</span></a>                <span class="n">v</span> <span class="o">+=</span> <span class="n">potential</span> <span class="o">*</span> <span class="n">u</span>
</span><span id="PseudoDifferentialOperator-1376"><a href="#PseudoDifferentialOperator-1376"><span class="linenos">1376</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1377"><a href="#PseudoDifferentialOperator-1377"><span class="linenos">1377</span></a>            
</span><span id="PseudoDifferentialOperator-1378"><a href="#PseudoDifferentialOperator-1378"><span class="linenos">1378</span></a>            <span class="c1"># Assemble matrix</span>
</span><span id="PseudoDifferentialOperator-1379"><a href="#PseudoDifferentialOperator-1379"><span class="linenos">1379</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1380"><a href="#PseudoDifferentialOperator-1380"><span class="linenos">1380</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1381"><a href="#PseudoDifferentialOperator-1381"><span class="linenos">1381</span></a>                <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1382"><a href="#PseudoDifferentialOperator-1382"><span class="linenos">1382</span></a>                <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="PseudoDifferentialOperator-1383"><a href="#PseudoDifferentialOperator-1383"><span class="linenos">1383</span></a>                <span class="n">H</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_operator</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1384"><a href="#PseudoDifferentialOperator-1384"><span class="linenos">1384</span></a>            
</span><span id="PseudoDifferentialOperator-1385"><a href="#PseudoDifferentialOperator-1385"><span class="linenos">1385</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operator quantized via spectral method: </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> matrix&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1386"><a href="#PseudoDifferentialOperator-1386"><span class="linenos">1386</span></a>        
</span><span id="PseudoDifferentialOperator-1387"><a href="#PseudoDifferentialOperator-1387"><span class="linenos">1387</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;finite_difference&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1388"><a href="#PseudoDifferentialOperator-1388"><span class="linenos">1388</span></a>            <span class="c1"># Finite difference discretization</span>
</span><span id="PseudoDifferentialOperator-1389"><a href="#PseudoDifferentialOperator-1389"><span class="linenos">1389</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1390"><a href="#PseudoDifferentialOperator-1390"><span class="linenos">1390</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1391"><a href="#PseudoDifferentialOperator-1391"><span class="linenos">1391</span></a>            
</span><span id="PseudoDifferentialOperator-1392"><a href="#PseudoDifferentialOperator-1392"><span class="linenos">1392</span></a>            <span class="c1"># Build -d²/dx² using centered differences</span>
</span><span id="PseudoDifferentialOperator-1393"><a href="#PseudoDifferentialOperator-1393"><span class="linenos">1393</span></a>            <span class="n">diag_main</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1394"><a href="#PseudoDifferentialOperator-1394"><span class="linenos">1394</span></a>            <span class="n">diag_off</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1395"><a href="#PseudoDifferentialOperator-1395"><span class="linenos">1395</span></a>            <span class="n">D2</span> <span class="o">=</span> <span class="n">diags</span><span class="p">([</span><span class="n">diag_off</span><span class="p">,</span> <span class="n">diag_main</span><span class="p">,</span> <span class="n">diag_off</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1396"><a href="#PseudoDifferentialOperator-1396"><span class="linenos">1396</span></a>            
</span><span id="PseudoDifferentialOperator-1397"><a href="#PseudoDifferentialOperator-1397"><span class="linenos">1397</span></a>            <span class="c1"># Add position-dependent part from symbol</span>
</span><span id="PseudoDifferentialOperator-1398"><a href="#PseudoDifferentialOperator-1398"><span class="linenos">1398</span></a>            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">x_grid</span>
</span><span id="PseudoDifferentialOperator-1399"><a href="#PseudoDifferentialOperator-1399"><span class="linenos">1399</span></a>            <span class="n">potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1400"><a href="#PseudoDifferentialOperator-1400"><span class="linenos">1400</span></a>            
</span><span id="PseudoDifferentialOperator-1401"><a href="#PseudoDifferentialOperator-1401"><span class="linenos">1401</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="o">-</span><span class="n">D2</span> <span class="o">+</span> <span class="n">potential</span>
</span><span id="PseudoDifferentialOperator-1402"><a href="#PseudoDifferentialOperator-1402"><span class="linenos">1402</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operator quantized via finite differences: </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> matrix&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1403"><a href="#PseudoDifferentialOperator-1403"><span class="linenos">1403</span></a>        
</span><span id="PseudoDifferentialOperator-1404"><a href="#PseudoDifferentialOperator-1404"><span class="linenos">1404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1405"><a href="#PseudoDifferentialOperator-1405"><span class="linenos">1405</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method must be &#39;spectral&#39; or &#39;finite_difference&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1406"><a href="#PseudoDifferentialOperator-1406"><span class="linenos">1406</span></a>        
</span><span id="PseudoDifferentialOperator-1407"><a href="#PseudoDifferentialOperator-1407"><span class="linenos">1407</span></a>        <span class="c1"># --- Step 2: Sample resolvent norm over λ-plane ---</span>
</span><span id="PseudoDifferentialOperator-1408"><a href="#PseudoDifferentialOperator-1408"><span class="linenos">1408</span></a>        <span class="n">lambda_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">lambda_real_range</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1409"><a href="#PseudoDifferentialOperator-1409"><span class="linenos">1409</span></a>        <span class="n">lambda_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">lambda_imag_range</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1410"><a href="#PseudoDifferentialOperator-1410"><span class="linenos">1410</span></a>        <span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lambda_re</span><span class="p">,</span> <span class="n">lambda_im</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1411"><a href="#PseudoDifferentialOperator-1411"><span class="linenos">1411</span></a>        <span class="n">Lambda</span> <span class="o">=</span> <span class="n">Lambda_re</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">Lambda_im</span>
</span><span id="PseudoDifferentialOperator-1412"><a href="#PseudoDifferentialOperator-1412"><span class="linenos">1412</span></a>        
</span><span id="PseudoDifferentialOperator-1413"><a href="#PseudoDifferentialOperator-1413"><span class="linenos">1413</span></a>        <span class="n">resolvent_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Lambda</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1414"><a href="#PseudoDifferentialOperator-1414"><span class="linenos">1414</span></a>        <span class="n">sigma_min_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Lambda</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1415"><a href="#PseudoDifferentialOperator-1415"><span class="linenos">1415</span></a>        
</span><span id="PseudoDifferentialOperator-1416"><a href="#PseudoDifferentialOperator-1416"><span class="linenos">1416</span></a>        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1417"><a href="#PseudoDifferentialOperator-1417"><span class="linenos">1417</span></a>        
</span><span id="PseudoDifferentialOperator-1418"><a href="#PseudoDifferentialOperator-1418"><span class="linenos">1418</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing pseudospectrum over </span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> grid...&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1419"><a href="#PseudoDifferentialOperator-1419"><span class="linenos">1419</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1420"><a href="#PseudoDifferentialOperator-1420"><span class="linenos">1420</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1421"><a href="#PseudoDifferentialOperator-1421"><span class="linenos">1421</span></a>                <span class="n">lam</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1422"><a href="#PseudoDifferentialOperator-1422"><span class="linenos">1422</span></a>                <span class="n">A</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">I</span>
</span><span id="PseudoDifferentialOperator-1423"><a href="#PseudoDifferentialOperator-1423"><span class="linenos">1423</span></a>                
</span><span id="PseudoDifferentialOperator-1424"><a href="#PseudoDifferentialOperator-1424"><span class="linenos">1424</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1425"><a href="#PseudoDifferentialOperator-1425"><span class="linenos">1425</span></a>                    <span class="c1"># Compute smallest singular value</span>
</span><span id="PseudoDifferentialOperator-1426"><a href="#PseudoDifferentialOperator-1426"><span class="linenos">1426</span></a>                    <span class="n">s</span> <span class="o">=</span> <span class="n">svdvals</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1427"><a href="#PseudoDifferentialOperator-1427"><span class="linenos">1427</span></a>                    <span class="n">s_min</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1428"><a href="#PseudoDifferentialOperator-1428"><span class="linenos">1428</span></a>                    <span class="n">sigma_min_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_min</span>
</span><span id="PseudoDifferentialOperator-1429"><a href="#PseudoDifferentialOperator-1429"><span class="linenos">1429</span></a>                    <span class="n">resolvent_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s_min</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>  <span class="c1"># regularization</span>
</span><span id="PseudoDifferentialOperator-1430"><a href="#PseudoDifferentialOperator-1430"><span class="linenos">1430</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1431"><a href="#PseudoDifferentialOperator-1431"><span class="linenos">1431</span></a>                    <span class="n">resolvent_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="PseudoDifferentialOperator-1432"><a href="#PseudoDifferentialOperator-1432"><span class="linenos">1432</span></a>                    <span class="n">sigma_min_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="PseudoDifferentialOperator-1433"><a href="#PseudoDifferentialOperator-1433"><span class="linenos">1433</span></a>        
</span><span id="PseudoDifferentialOperator-1434"><a href="#PseudoDifferentialOperator-1434"><span class="linenos">1434</span></a>        <span class="c1"># --- Step 3: Compute eigenvalues ---</span>
</span><span id="PseudoDifferentialOperator-1435"><a href="#PseudoDifferentialOperator-1435"><span class="linenos">1435</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1436"><a href="#PseudoDifferentialOperator-1436"><span class="linenos">1436</span></a>            <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1437"><a href="#PseudoDifferentialOperator-1437"><span class="linenos">1437</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1438"><a href="#PseudoDifferentialOperator-1438"><span class="linenos">1438</span></a>            <span class="n">eigenvalues</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator-1439"><a href="#PseudoDifferentialOperator-1439"><span class="linenos">1439</span></a>        
</span><span id="PseudoDifferentialOperator-1440"><a href="#PseudoDifferentialOperator-1440"><span class="linenos">1440</span></a>        <span class="c1"># --- Step 4: Visualization ---</span>
</span><span id="PseudoDifferentialOperator-1441"><a href="#PseudoDifferentialOperator-1441"><span class="linenos">1441</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1442"><a href="#PseudoDifferentialOperator-1442"><span class="linenos">1442</span></a>        
</span><span id="PseudoDifferentialOperator-1443"><a href="#PseudoDifferentialOperator-1443"><span class="linenos">1443</span></a>        <span class="c1"># Left panel: log10(resolvent norm)</span>
</span><span id="PseudoDifferentialOperator-1444"><a href="#PseudoDifferentialOperator-1444"><span class="linenos">1444</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1445"><a href="#PseudoDifferentialOperator-1445"><span class="linenos">1445</span></a>        <span class="n">levels_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epsilon_levels</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1446"><a href="#PseudoDifferentialOperator-1446"><span class="linenos">1446</span></a>        <span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">resolvent_norm</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">),</span> 
</span><span id="PseudoDifferentialOperator-1447"><a href="#PseudoDifferentialOperator-1447"><span class="linenos">1447</span></a>                         <span class="n">levels</span><span class="o">=</span><span class="n">levels_log</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1448"><a href="#PseudoDifferentialOperator-1448"><span class="linenos">1448</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ε=10^</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1449"><a href="#PseudoDifferentialOperator-1449"><span class="linenos">1449</span></a>        
</span><span id="PseudoDifferentialOperator-1450"><a href="#PseudoDifferentialOperator-1450"><span class="linenos">1450</span></a>        <span class="k">if</span> <span class="n">eigenvalues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1451"><a href="#PseudoDifferentialOperator-1451"><span class="linenos">1451</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Eigenvalues&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1452"><a href="#PseudoDifferentialOperator-1452"><span class="linenos">1452</span></a>        
</span><span id="PseudoDifferentialOperator-1453"><a href="#PseudoDifferentialOperator-1453"><span class="linenos">1453</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Re(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1454"><a href="#PseudoDifferentialOperator-1454"><span class="linenos">1454</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Im(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1455"><a href="#PseudoDifferentialOperator-1455"><span class="linenos">1455</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ε-Pseudospectrum: log₁₀(‖(A - λI)⁻¹‖)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1456"><a href="#PseudoDifferentialOperator-1456"><span class="linenos">1456</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1457"><a href="#PseudoDifferentialOperator-1457"><span class="linenos">1457</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1458"><a href="#PseudoDifferentialOperator-1458"><span class="linenos">1458</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1459"><a href="#PseudoDifferentialOperator-1459"><span class="linenos">1459</span></a>        
</span><span id="PseudoDifferentialOperator-1460"><a href="#PseudoDifferentialOperator-1460"><span class="linenos">1460</span></a>        <span class="c1"># Right panel: σ_min contours</span>
</span><span id="PseudoDifferentialOperator-1461"><a href="#PseudoDifferentialOperator-1461"><span class="linenos">1461</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1462"><a href="#PseudoDifferentialOperator-1462"><span class="linenos">1462</span></a>        <span class="n">cs2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span><span class="p">,</span> <span class="n">sigma_min_grid</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator-1463"><a href="#PseudoDifferentialOperator-1463"><span class="linenos">1463</span></a>                           <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1464"><a href="#PseudoDifferentialOperator-1464"><span class="linenos">1464</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;σ_min(A - λI)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1465"><a href="#PseudoDifferentialOperator-1465"><span class="linenos">1465</span></a>        
</span><span id="PseudoDifferentialOperator-1466"><a href="#PseudoDifferentialOperator-1466"><span class="linenos">1466</span></a>        <span class="k">if</span> <span class="n">eigenvalues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1467"><a href="#PseudoDifferentialOperator-1467"><span class="linenos">1467</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1468"><a href="#PseudoDifferentialOperator-1468"><span class="linenos">1468</span></a>        
</span><span id="PseudoDifferentialOperator-1469"><a href="#PseudoDifferentialOperator-1469"><span class="linenos">1469</span></a>        <span class="k">for</span> <span class="n">eps</span> <span class="ow">in</span> <span class="n">epsilon_levels</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1470"><a href="#PseudoDifferentialOperator-1470"><span class="linenos">1470</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span><span class="p">,</span> <span class="n">sigma_min_grid</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator-1471"><a href="#PseudoDifferentialOperator-1471"><span class="linenos">1471</span></a>                       <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">eps</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1472"><a href="#PseudoDifferentialOperator-1472"><span class="linenos">1472</span></a>        
</span><span id="PseudoDifferentialOperator-1473"><a href="#PseudoDifferentialOperator-1473"><span class="linenos">1473</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Re(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1474"><a href="#PseudoDifferentialOperator-1474"><span class="linenos">1474</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Im(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1475"><a href="#PseudoDifferentialOperator-1475"><span class="linenos">1475</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Smallest singular value σ_min(A - λI)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1476"><a href="#PseudoDifferentialOperator-1476"><span class="linenos">1476</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1477"><a href="#PseudoDifferentialOperator-1477"><span class="linenos">1477</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1478"><a href="#PseudoDifferentialOperator-1478"><span class="linenos">1478</span></a>        
</span><span id="PseudoDifferentialOperator-1479"><a href="#PseudoDifferentialOperator-1479"><span class="linenos">1479</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1480"><a href="#PseudoDifferentialOperator-1480"><span class="linenos">1480</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1481"><a href="#PseudoDifferentialOperator-1481"><span class="linenos">1481</span></a>        
</span><span id="PseudoDifferentialOperator-1482"><a href="#PseudoDifferentialOperator-1482"><span class="linenos">1482</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="PseudoDifferentialOperator-1483"><a href="#PseudoDifferentialOperator-1483"><span class="linenos">1483</span></a>            <span class="s1">&#39;lambda_grid&#39;</span><span class="p">:</span> <span class="n">Lambda</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1484"><a href="#PseudoDifferentialOperator-1484"><span class="linenos">1484</span></a>            <span class="s1">&#39;resolvent_norm&#39;</span><span class="p">:</span> <span class="n">resolvent_norm</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1485"><a href="#PseudoDifferentialOperator-1485"><span class="linenos">1485</span></a>            <span class="s1">&#39;sigma_min&#39;</span><span class="p">:</span> <span class="n">sigma_min_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1486"><a href="#PseudoDifferentialOperator-1486"><span class="linenos">1486</span></a>            <span class="s1">&#39;epsilon_levels&#39;</span><span class="p">:</span> <span class="n">epsilon_levels</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1487"><a href="#PseudoDifferentialOperator-1487"><span class="linenos">1487</span></a>            <span class="s1">&#39;eigenvalues&#39;</span><span class="p">:</span> <span class="n">eigenvalues</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-1488"><a href="#PseudoDifferentialOperator-1488"><span class="linenos">1488</span></a>            <span class="s1">&#39;operator_matrix&#39;</span><span class="p">:</span> <span class="n">H</span>
</span><span id="PseudoDifferentialOperator-1489"><a href="#PseudoDifferentialOperator-1489"><span class="linenos">1489</span></a>        <span class="p">}</span>
</span><span id="PseudoDifferentialOperator-1490"><a href="#PseudoDifferentialOperator-1490"><span class="linenos">1490</span></a>    
</span><span id="PseudoDifferentialOperator-1491"><a href="#PseudoDifferentialOperator-1491"><span class="linenos">1491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symplectic_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1492"><a href="#PseudoDifferentialOperator-1492"><span class="linenos">1492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1493"><a href="#PseudoDifferentialOperator-1493"><span class="linenos">1493</span></a><span class="sd">        Compute the Hamiltonian vector field associated with the principal symbol.</span>
</span><span id="PseudoDifferentialOperator-1494"><a href="#PseudoDifferentialOperator-1494"><span class="linenos">1494</span></a>
</span><span id="PseudoDifferentialOperator-1495"><a href="#PseudoDifferentialOperator-1495"><span class="linenos">1495</span></a><span class="sd">        This method derives the canonical equations of motion for the phase space variables </span>
</span><span id="PseudoDifferentialOperator-1496"><a href="#PseudoDifferentialOperator-1496"><span class="linenos">1496</span></a><span class="sd">        (x, ξ) in 1D or (x, y, ξ, η) in 2D, based on the Hamiltonian formalism. These describe </span>
</span><span id="PseudoDifferentialOperator-1497"><a href="#PseudoDifferentialOperator-1497"><span class="linenos">1497</span></a><span class="sd">        how position and frequency variables evolve under the flow generated by the symbol.</span>
</span><span id="PseudoDifferentialOperator-1498"><a href="#PseudoDifferentialOperator-1498"><span class="linenos">1498</span></a>
</span><span id="PseudoDifferentialOperator-1499"><a href="#PseudoDifferentialOperator-1499"><span class="linenos">1499</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1500"><a href="#PseudoDifferentialOperator-1500"><span class="linenos">1500</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1501"><a href="#PseudoDifferentialOperator-1501"><span class="linenos">1501</span></a><span class="sd">        dict</span>
</span><span id="PseudoDifferentialOperator-1502"><a href="#PseudoDifferentialOperator-1502"><span class="linenos">1502</span></a><span class="sd">            A dictionary containing the components of the Hamiltonian vector field:</span>
</span><span id="PseudoDifferentialOperator-1503"><a href="#PseudoDifferentialOperator-1503"><span class="linenos">1503</span></a><span class="sd">            - In 1D: keys are &#39;dx/dt&#39; and &#39;dxi/dt&#39;, corresponding to dx/dt = ∂p/∂ξ and dξ/dt = -∂p/∂x.</span>
</span><span id="PseudoDifferentialOperator-1504"><a href="#PseudoDifferentialOperator-1504"><span class="linenos">1504</span></a><span class="sd">            - In 2D: keys are &#39;dx/dt&#39;, &#39;dy/dt&#39;, &#39;dxi/dt&#39;, and &#39;deta/dt&#39;, with similar definitions:</span>
</span><span id="PseudoDifferentialOperator-1505"><a href="#PseudoDifferentialOperator-1505"><span class="linenos">1505</span></a><span class="sd">              dx/dt = ∂p/∂ξ, dy/dt = ∂p/∂η, dξ/dt = -∂p/∂x, dη/dt = -∂p/∂y.</span>
</span><span id="PseudoDifferentialOperator-1506"><a href="#PseudoDifferentialOperator-1506"><span class="linenos">1506</span></a>
</span><span id="PseudoDifferentialOperator-1507"><a href="#PseudoDifferentialOperator-1507"><span class="linenos">1507</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1508"><a href="#PseudoDifferentialOperator-1508"><span class="linenos">1508</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1509"><a href="#PseudoDifferentialOperator-1509"><span class="linenos">1509</span></a><span class="sd">        - The Hamiltonian here is the principal symbol p(x, ξ) itself.</span>
</span><span id="PseudoDifferentialOperator-1510"><a href="#PseudoDifferentialOperator-1510"><span class="linenos">1510</span></a><span class="sd">        - This flow preserves the symplectic structure of phase space.</span>
</span><span id="PseudoDifferentialOperator-1511"><a href="#PseudoDifferentialOperator-1511"><span class="linenos">1511</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1512"><a href="#PseudoDifferentialOperator-1512"><span class="linenos">1512</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1513"><a href="#PseudoDifferentialOperator-1513"><span class="linenos">1513</span></a>            <span class="n">x</span><span class="p">,</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1514"><a href="#PseudoDifferentialOperator-1514"><span class="linenos">1514</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1515"><a href="#PseudoDifferentialOperator-1515"><span class="linenos">1515</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="PseudoDifferentialOperator-1516"><a href="#PseudoDifferentialOperator-1516"><span class="linenos">1516</span></a>                <span class="s1">&#39;dx/dt&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1517"><a href="#PseudoDifferentialOperator-1517"><span class="linenos">1517</span></a>                <span class="s1">&#39;dxi/dt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1518"><a href="#PseudoDifferentialOperator-1518"><span class="linenos">1518</span></a>            <span class="p">}</span>
</span><span id="PseudoDifferentialOperator-1519"><a href="#PseudoDifferentialOperator-1519"><span class="linenos">1519</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1520"><a href="#PseudoDifferentialOperator-1520"><span class="linenos">1520</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1521"><a href="#PseudoDifferentialOperator-1521"><span class="linenos">1521</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1522"><a href="#PseudoDifferentialOperator-1522"><span class="linenos">1522</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="PseudoDifferentialOperator-1523"><a href="#PseudoDifferentialOperator-1523"><span class="linenos">1523</span></a>                <span class="s1">&#39;dx/dt&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1524"><a href="#PseudoDifferentialOperator-1524"><span class="linenos">1524</span></a>                <span class="s1">&#39;dy/dt&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1525"><a href="#PseudoDifferentialOperator-1525"><span class="linenos">1525</span></a>                <span class="s1">&#39;dxi/dt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1526"><a href="#PseudoDifferentialOperator-1526"><span class="linenos">1526</span></a>                <span class="s1">&#39;deta/dt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1527"><a href="#PseudoDifferentialOperator-1527"><span class="linenos">1527</span></a>            <span class="p">}</span>
</span><span id="PseudoDifferentialOperator-1528"><a href="#PseudoDifferentialOperator-1528"><span class="linenos">1528</span></a>
</span><span id="PseudoDifferentialOperator-1529"><a href="#PseudoDifferentialOperator-1529"><span class="linenos">1529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_elliptic_numerically</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1530"><a href="#PseudoDifferentialOperator-1530"><span class="linenos">1530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1531"><a href="#PseudoDifferentialOperator-1531"><span class="linenos">1531</span></a><span class="sd">        Check if the pseudo-differential symbol p(x, ξ) is elliptic over a given grid.</span>
</span><span id="PseudoDifferentialOperator-1532"><a href="#PseudoDifferentialOperator-1532"><span class="linenos">1532</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1533"><a href="#PseudoDifferentialOperator-1533"><span class="linenos">1533</span></a><span class="sd">        A symbol is considered elliptic if its magnitude |p(x, ξ)| remains bounded away from zero </span>
</span><span id="PseudoDifferentialOperator-1534"><a href="#PseudoDifferentialOperator-1534"><span class="linenos">1534</span></a><span class="sd">        across all points in the spatial-frequency domain. This method evaluates the symbol on a </span>
</span><span id="PseudoDifferentialOperator-1535"><a href="#PseudoDifferentialOperator-1535"><span class="linenos">1535</span></a><span class="sd">        grid of spatial and frequency coordinates and checks whether its minimum absolute value </span>
</span><span id="PseudoDifferentialOperator-1536"><a href="#PseudoDifferentialOperator-1536"><span class="linenos">1536</span></a><span class="sd">        exceeds a specified threshold.</span>
</span><span id="PseudoDifferentialOperator-1537"><a href="#PseudoDifferentialOperator-1537"><span class="linenos">1537</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1538"><a href="#PseudoDifferentialOperator-1538"><span class="linenos">1538</span></a><span class="sd">        Resampling is applied to large grids to prevent excessive memory usage, particularly in 2D.</span>
</span><span id="PseudoDifferentialOperator-1539"><a href="#PseudoDifferentialOperator-1539"><span class="linenos">1539</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1540"><a href="#PseudoDifferentialOperator-1540"><span class="linenos">1540</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1541"><a href="#PseudoDifferentialOperator-1541"><span class="linenos">1541</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1542"><a href="#PseudoDifferentialOperator-1542"><span class="linenos">1542</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1543"><a href="#PseudoDifferentialOperator-1543"><span class="linenos">1543</span></a><span class="sd">            Spatial grid: either a 1D array (x) or a tuple of two 1D arrays (x, y).</span>
</span><span id="PseudoDifferentialOperator-1544"><a href="#PseudoDifferentialOperator-1544"><span class="linenos">1544</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1545"><a href="#PseudoDifferentialOperator-1545"><span class="linenos">1545</span></a><span class="sd">            Frequency grid: either a 1D array (ξ) or a tuple of two 1D arrays (ξ, η).</span>
</span><span id="PseudoDifferentialOperator-1546"><a href="#PseudoDifferentialOperator-1546"><span class="linenos">1546</span></a><span class="sd">        threshold : float, optional</span>
</span><span id="PseudoDifferentialOperator-1547"><a href="#PseudoDifferentialOperator-1547"><span class="linenos">1547</span></a><span class="sd">            Minimum acceptable value for |p(x, ξ)|. If the smallest evaluated symbol value falls below this,</span>
</span><span id="PseudoDifferentialOperator-1548"><a href="#PseudoDifferentialOperator-1548"><span class="linenos">1548</span></a><span class="sd">            the symbol is not considered elliptic.</span>
</span><span id="PseudoDifferentialOperator-1549"><a href="#PseudoDifferentialOperator-1549"><span class="linenos">1549</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1550"><a href="#PseudoDifferentialOperator-1550"><span class="linenos">1550</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1551"><a href="#PseudoDifferentialOperator-1551"><span class="linenos">1551</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1552"><a href="#PseudoDifferentialOperator-1552"><span class="linenos">1552</span></a><span class="sd">        bool</span>
</span><span id="PseudoDifferentialOperator-1553"><a href="#PseudoDifferentialOperator-1553"><span class="linenos">1553</span></a><span class="sd">            True if the symbol is elliptic on the resampled grid, False otherwise.</span>
</span><span id="PseudoDifferentialOperator-1554"><a href="#PseudoDifferentialOperator-1554"><span class="linenos">1554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1555"><a href="#PseudoDifferentialOperator-1555"><span class="linenos">1555</span></a>        <span class="n">RESAMPLE_SIZE</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Reduced size to prevent memory explosion</span>
</span><span id="PseudoDifferentialOperator-1556"><a href="#PseudoDifferentialOperator-1556"><span class="linenos">1556</span></a>        
</span><span id="PseudoDifferentialOperator-1557"><a href="#PseudoDifferentialOperator-1557"><span class="linenos">1557</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1558"><a href="#PseudoDifferentialOperator-1558"><span class="linenos">1558</span></a>            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">x_grid</span>
</span><span id="PseudoDifferentialOperator-1559"><a href="#PseudoDifferentialOperator-1559"><span class="linenos">1559</span></a>            <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">xi_grid</span>
</span><span id="PseudoDifferentialOperator-1560"><a href="#PseudoDifferentialOperator-1560"><span class="linenos">1560</span></a>            <span class="c1"># Resampling if necessary</span>
</span><span id="PseudoDifferentialOperator-1561"><a href="#PseudoDifferentialOperator-1561"><span class="linenos">1561</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1562"><a href="#PseudoDifferentialOperator-1562"><span class="linenos">1562</span></a>                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1563"><a href="#PseudoDifferentialOperator-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1564"><a href="#PseudoDifferentialOperator-1564"><span class="linenos">1564</span></a>                <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xi_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1565"><a href="#PseudoDifferentialOperator-1565"><span class="linenos">1565</span></a>        
</span><span id="PseudoDifferentialOperator-1566"><a href="#PseudoDifferentialOperator-1566"><span class="linenos">1566</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1567"><a href="#PseudoDifferentialOperator-1567"><span class="linenos">1567</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1568"><a href="#PseudoDifferentialOperator-1568"><span class="linenos">1568</span></a>        
</span><span id="PseudoDifferentialOperator-1569"><a href="#PseudoDifferentialOperator-1569"><span class="linenos">1569</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1570"><a href="#PseudoDifferentialOperator-1570"><span class="linenos">1570</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">x_grid</span>
</span><span id="PseudoDifferentialOperator-1571"><a href="#PseudoDifferentialOperator-1571"><span class="linenos">1571</span></a>            <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">xi_grid</span>
</span><span id="PseudoDifferentialOperator-1572"><a href="#PseudoDifferentialOperator-1572"><span class="linenos">1572</span></a>        
</span><span id="PseudoDifferentialOperator-1573"><a href="#PseudoDifferentialOperator-1573"><span class="linenos">1573</span></a>            <span class="c1"># Spatial resampling</span>
</span><span id="PseudoDifferentialOperator-1574"><a href="#PseudoDifferentialOperator-1574"><span class="linenos">1574</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1575"><a href="#PseudoDifferentialOperator-1575"><span class="linenos">1575</span></a>                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1576"><a href="#PseudoDifferentialOperator-1576"><span class="linenos">1576</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1577"><a href="#PseudoDifferentialOperator-1577"><span class="linenos">1577</span></a>                <span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1578"><a href="#PseudoDifferentialOperator-1578"><span class="linenos">1578</span></a>        
</span><span id="PseudoDifferentialOperator-1579"><a href="#PseudoDifferentialOperator-1579"><span class="linenos">1579</span></a>            <span class="c1"># Frequency resampling</span>
</span><span id="PseudoDifferentialOperator-1580"><a href="#PseudoDifferentialOperator-1580"><span class="linenos">1580</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1581"><a href="#PseudoDifferentialOperator-1581"><span class="linenos">1581</span></a>                <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xi_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1582"><a href="#PseudoDifferentialOperator-1582"><span class="linenos">1582</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1583"><a href="#PseudoDifferentialOperator-1583"><span class="linenos">1583</span></a>                <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">eta_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">eta_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1584"><a href="#PseudoDifferentialOperator-1584"><span class="linenos">1584</span></a>        
</span><span id="PseudoDifferentialOperator-1585"><a href="#PseudoDifferentialOperator-1585"><span class="linenos">1585</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1586"><a href="#PseudoDifferentialOperator-1586"><span class="linenos">1586</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1587"><a href="#PseudoDifferentialOperator-1587"><span class="linenos">1587</span></a>        
</span><span id="PseudoDifferentialOperator-1588"><a href="#PseudoDifferentialOperator-1588"><span class="linenos">1588</span></a>        <span class="n">min_abs_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1589"><a href="#PseudoDifferentialOperator-1589"><span class="linenos">1589</span></a>        <span class="k">return</span> <span class="n">min_abs_val</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span><span id="PseudoDifferentialOperator-1590"><a href="#PseudoDifferentialOperator-1590"><span class="linenos">1590</span></a>
</span><span id="PseudoDifferentialOperator-1591"><a href="#PseudoDifferentialOperator-1591"><span class="linenos">1591</span></a>
</span><span id="PseudoDifferentialOperator-1592"><a href="#PseudoDifferentialOperator-1592"><span class="linenos">1592</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_self_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1593"><a href="#PseudoDifferentialOperator-1593"><span class="linenos">1593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1594"><a href="#PseudoDifferentialOperator-1594"><span class="linenos">1594</span></a><span class="sd">        Check whether the pseudo-differential operator is formally self-adjoint (Hermitian).</span>
</span><span id="PseudoDifferentialOperator-1595"><a href="#PseudoDifferentialOperator-1595"><span class="linenos">1595</span></a>
</span><span id="PseudoDifferentialOperator-1596"><a href="#PseudoDifferentialOperator-1596"><span class="linenos">1596</span></a><span class="sd">        A self-adjoint operator satisfies P = P*, where P* is the formal adjoint of P.</span>
</span><span id="PseudoDifferentialOperator-1597"><a href="#PseudoDifferentialOperator-1597"><span class="linenos">1597</span></a><span class="sd">        This property is essential for ensuring real-valued eigenvalues and stable evolution </span>
</span><span id="PseudoDifferentialOperator-1598"><a href="#PseudoDifferentialOperator-1598"><span class="linenos">1598</span></a><span class="sd">        in quantum mechanics and symmetric wave propagation.</span>
</span><span id="PseudoDifferentialOperator-1599"><a href="#PseudoDifferentialOperator-1599"><span class="linenos">1599</span></a>
</span><span id="PseudoDifferentialOperator-1600"><a href="#PseudoDifferentialOperator-1600"><span class="linenos">1600</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1601"><a href="#PseudoDifferentialOperator-1601"><span class="linenos">1601</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1602"><a href="#PseudoDifferentialOperator-1602"><span class="linenos">1602</span></a><span class="sd">        tol : float</span>
</span><span id="PseudoDifferentialOperator-1603"><a href="#PseudoDifferentialOperator-1603"><span class="linenos">1603</span></a><span class="sd">            Tolerance for symbolic comparison between P and P*. Small numerical differences </span>
</span><span id="PseudoDifferentialOperator-1604"><a href="#PseudoDifferentialOperator-1604"><span class="linenos">1604</span></a><span class="sd">            below this threshold are considered equal.</span>
</span><span id="PseudoDifferentialOperator-1605"><a href="#PseudoDifferentialOperator-1605"><span class="linenos">1605</span></a>
</span><span id="PseudoDifferentialOperator-1606"><a href="#PseudoDifferentialOperator-1606"><span class="linenos">1606</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1607"><a href="#PseudoDifferentialOperator-1607"><span class="linenos">1607</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1608"><a href="#PseudoDifferentialOperator-1608"><span class="linenos">1608</span></a><span class="sd">        bool</span>
</span><span id="PseudoDifferentialOperator-1609"><a href="#PseudoDifferentialOperator-1609"><span class="linenos">1609</span></a><span class="sd">            True if the symbol p(x, ξ) equals its formal adjoint p*(x, ξ) within the given tolerance,</span>
</span><span id="PseudoDifferentialOperator-1610"><a href="#PseudoDifferentialOperator-1610"><span class="linenos">1610</span></a><span class="sd">            indicating that the operator is self-adjoint.</span>
</span><span id="PseudoDifferentialOperator-1611"><a href="#PseudoDifferentialOperator-1611"><span class="linenos">1611</span></a>
</span><span id="PseudoDifferentialOperator-1612"><a href="#PseudoDifferentialOperator-1612"><span class="linenos">1612</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator-1613"><a href="#PseudoDifferentialOperator-1613"><span class="linenos">1613</span></a><span class="sd">        - The formal adjoint is computed via conjugation and asymptotic expansion at infinity in ξ.</span>
</span><span id="PseudoDifferentialOperator-1614"><a href="#PseudoDifferentialOperator-1614"><span class="linenos">1614</span></a><span class="sd">        - Symbolic simplification is used to verify equality, ensuring robustness against superficial </span>
</span><span id="PseudoDifferentialOperator-1615"><a href="#PseudoDifferentialOperator-1615"><span class="linenos">1615</span></a><span class="sd">          expression differences.</span>
</span><span id="PseudoDifferentialOperator-1616"><a href="#PseudoDifferentialOperator-1616"><span class="linenos">1616</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1617"><a href="#PseudoDifferentialOperator-1617"><span class="linenos">1617</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator-1618"><a href="#PseudoDifferentialOperator-1618"><span class="linenos">1618</span></a>        <span class="n">p_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formal_adjoint</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1619"><a href="#PseudoDifferentialOperator-1619"><span class="linenos">1619</span></a>        <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">p_star</span><span class="p">)</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1620"><a href="#PseudoDifferentialOperator-1620"><span class="linenos">1620</span></a>
</span><span id="PseudoDifferentialOperator-1621"><a href="#PseudoDifferentialOperator-1621"><span class="linenos">1621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_fiber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1622"><a href="#PseudoDifferentialOperator-1622"><span class="linenos">1622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1623"><a href="#PseudoDifferentialOperator-1623"><span class="linenos">1623</span></a><span class="sd">        Plot the cotangent fiber structure at a fixed spatial point (x₀[, y₀]).</span>
</span><span id="PseudoDifferentialOperator-1624"><a href="#PseudoDifferentialOperator-1624"><span class="linenos">1624</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1625"><a href="#PseudoDifferentialOperator-1625"><span class="linenos">1625</span></a><span class="sd">        This visualization shows how the symbol p(x, ξ) behaves on the cotangent fiber </span>
</span><span id="PseudoDifferentialOperator-1626"><a href="#PseudoDifferentialOperator-1626"><span class="linenos">1626</span></a><span class="sd">        above a fixed spatial point. In microlocal analysis, this provides insight into </span>
</span><span id="PseudoDifferentialOperator-1627"><a href="#PseudoDifferentialOperator-1627"><span class="linenos">1627</span></a><span class="sd">        the frequency content of the operator at that location.</span>
</span><span id="PseudoDifferentialOperator-1628"><a href="#PseudoDifferentialOperator-1628"><span class="linenos">1628</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1629"><a href="#PseudoDifferentialOperator-1629"><span class="linenos">1629</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1630"><a href="#PseudoDifferentialOperator-1630"><span class="linenos">1630</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1631"><a href="#PseudoDifferentialOperator-1631"><span class="linenos">1631</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1632"><a href="#PseudoDifferentialOperator-1632"><span class="linenos">1632</span></a><span class="sd">            Spatial grid values (1D) for evaluation in 1D case.</span>
</span><span id="PseudoDifferentialOperator-1633"><a href="#PseudoDifferentialOperator-1633"><span class="linenos">1633</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1634"><a href="#PseudoDifferentialOperator-1634"><span class="linenos">1634</span></a><span class="sd">            Frequency grid values (1D) for evaluation in both 1D and 2D cases.</span>
</span><span id="PseudoDifferentialOperator-1635"><a href="#PseudoDifferentialOperator-1635"><span class="linenos">1635</span></a><span class="sd">        x0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1636"><a href="#PseudoDifferentialOperator-1636"><span class="linenos">1636</span></a><span class="sd">            Fixed x-coordinate of the base point in space (1D or 2D).</span>
</span><span id="PseudoDifferentialOperator-1637"><a href="#PseudoDifferentialOperator-1637"><span class="linenos">1637</span></a><span class="sd">        y0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1638"><a href="#PseudoDifferentialOperator-1638"><span class="linenos">1638</span></a><span class="sd">            Fixed y-coordinate of the base point in space (2D only).</span>
</span><span id="PseudoDifferentialOperator-1639"><a href="#PseudoDifferentialOperator-1639"><span class="linenos">1639</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1640"><a href="#PseudoDifferentialOperator-1640"><span class="linenos">1640</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1641"><a href="#PseudoDifferentialOperator-1641"><span class="linenos">1641</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1642"><a href="#PseudoDifferentialOperator-1642"><span class="linenos">1642</span></a><span class="sd">        - In 1D: Displays |p(x, ξ)| over the (x, ξ) phase plane near the fixed point.</span>
</span><span id="PseudoDifferentialOperator-1643"><a href="#PseudoDifferentialOperator-1643"><span class="linenos">1643</span></a><span class="sd">        - In 2D: Fixes (x₀, y₀) and evaluates p(x₀, y₀, ξ, η), showing the fiber over that point.</span>
</span><span id="PseudoDifferentialOperator-1644"><a href="#PseudoDifferentialOperator-1644"><span class="linenos">1644</span></a><span class="sd">        - The color map represents the magnitude of the symbol, highlighting regions where it vanishes or becomes singular.</span>
</span><span id="PseudoDifferentialOperator-1645"><a href="#PseudoDifferentialOperator-1645"><span class="linenos">1645</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1646"><a href="#PseudoDifferentialOperator-1646"><span class="linenos">1646</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-1647"><a href="#PseudoDifferentialOperator-1647"><span class="linenos">1647</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-1648"><a href="#PseudoDifferentialOperator-1648"><span class="linenos">1648</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-1649"><a href="#PseudoDifferentialOperator-1649"><span class="linenos">1649</span></a><span class="sd">            If called in 2D with missing or improperly formatted grids.</span>
</span><span id="PseudoDifferentialOperator-1650"><a href="#PseudoDifferentialOperator-1650"><span class="linenos">1650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1651"><a href="#PseudoDifferentialOperator-1651"><span class="linenos">1651</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1652"><a href="#PseudoDifferentialOperator-1652"><span class="linenos">1652</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1653"><a href="#PseudoDifferentialOperator-1653"><span class="linenos">1653</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1654"><a href="#PseudoDifferentialOperator-1654"><span class="linenos">1654</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1655"><a href="#PseudoDifferentialOperator-1655"><span class="linenos">1655</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1656"><a href="#PseudoDifferentialOperator-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (position)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1657"><a href="#PseudoDifferentialOperator-1657"><span class="linenos">1657</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ (frequency)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1658"><a href="#PseudoDifferentialOperator-1658"><span class="linenos">1658</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cotangent Fiber Structure&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1659"><a href="#PseudoDifferentialOperator-1659"><span class="linenos">1659</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1660"><a href="#PseudoDifferentialOperator-1660"><span class="linenos">1660</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1661"><a href="#PseudoDifferentialOperator-1661"><span class="linenos">1661</span></a>            <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1662"><a href="#PseudoDifferentialOperator-1662"><span class="linenos">1662</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1663"><a href="#PseudoDifferentialOperator-1663"><span class="linenos">1663</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1664"><a href="#PseudoDifferentialOperator-1664"><span class="linenos">1664</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1665"><a href="#PseudoDifferentialOperator-1665"><span class="linenos">1665</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1666"><a href="#PseudoDifferentialOperator-1666"><span class="linenos">1666</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1667"><a href="#PseudoDifferentialOperator-1667"><span class="linenos">1667</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cotangent Fiber at x=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s1">, y=</span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1668"><a href="#PseudoDifferentialOperator-1668"><span class="linenos">1668</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1669"><a href="#PseudoDifferentialOperator-1669"><span class="linenos">1669</span></a>
</span><span id="PseudoDifferentialOperator-1670"><a href="#PseudoDifferentialOperator-1670"><span class="linenos">1670</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_symbol_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1671"><a href="#PseudoDifferentialOperator-1671"><span class="linenos">1671</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1672"><a href="#PseudoDifferentialOperator-1672"><span class="linenos">1672</span></a><span class="sd">        Display the modulus |p(x, ξ)| or |p(x, y, ξ₀, η₀)| as a color map.</span>
</span><span id="PseudoDifferentialOperator-1673"><a href="#PseudoDifferentialOperator-1673"><span class="linenos">1673</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1674"><a href="#PseudoDifferentialOperator-1674"><span class="linenos">1674</span></a><span class="sd">        This method visualizes the amplitude of the pseudodifferential operator&#39;s symbol </span>
</span><span id="PseudoDifferentialOperator-1675"><a href="#PseudoDifferentialOperator-1675"><span class="linenos">1675</span></a><span class="sd">        in either 1D or 2D spatial configuration. In 2D, the frequency variables are fixed </span>
</span><span id="PseudoDifferentialOperator-1676"><a href="#PseudoDifferentialOperator-1676"><span class="linenos">1676</span></a><span class="sd">        to specified values (ξ₀, η₀) for visualization purposes.</span>
</span><span id="PseudoDifferentialOperator-1677"><a href="#PseudoDifferentialOperator-1677"><span class="linenos">1677</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1678"><a href="#PseudoDifferentialOperator-1678"><span class="linenos">1678</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1679"><a href="#PseudoDifferentialOperator-1679"><span class="linenos">1679</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1680"><a href="#PseudoDifferentialOperator-1680"><span class="linenos">1680</span></a><span class="sd">        x_grid, y_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1681"><a href="#PseudoDifferentialOperator-1681"><span class="linenos">1681</span></a><span class="sd">            Spatial grids over which to evaluate the symbol. y_grid is optional and used only in 2D.</span>
</span><span id="PseudoDifferentialOperator-1682"><a href="#PseudoDifferentialOperator-1682"><span class="linenos">1682</span></a><span class="sd">        xi_grid, eta_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1683"><a href="#PseudoDifferentialOperator-1683"><span class="linenos">1683</span></a><span class="sd">            Frequency grids. In 2D, these define the domain over which the symbol is evaluated,</span>
</span><span id="PseudoDifferentialOperator-1684"><a href="#PseudoDifferentialOperator-1684"><span class="linenos">1684</span></a><span class="sd">            but the visualization fixes ξ = ξ₀ and η = η₀.</span>
</span><span id="PseudoDifferentialOperator-1685"><a href="#PseudoDifferentialOperator-1685"><span class="linenos">1685</span></a><span class="sd">        xi0, eta0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1686"><a href="#PseudoDifferentialOperator-1686"><span class="linenos">1686</span></a><span class="sd">            Fixed frequency values for slicing in 2D visualization. Defaults to zero.</span>
</span><span id="PseudoDifferentialOperator-1687"><a href="#PseudoDifferentialOperator-1687"><span class="linenos">1687</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1688"><a href="#PseudoDifferentialOperator-1688"><span class="linenos">1688</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1689"><a href="#PseudoDifferentialOperator-1689"><span class="linenos">1689</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1690"><a href="#PseudoDifferentialOperator-1690"><span class="linenos">1690</span></a><span class="sd">        - In 1D: Visualizes |p(x, ξ)| over the (x, ξ) grid.</span>
</span><span id="PseudoDifferentialOperator-1691"><a href="#PseudoDifferentialOperator-1691"><span class="linenos">1691</span></a><span class="sd">        - In 2D: Visualizes |p(x, y, ξ₀, η₀)| at fixed frequencies ξ₀ and η₀.</span>
</span><span id="PseudoDifferentialOperator-1692"><a href="#PseudoDifferentialOperator-1692"><span class="linenos">1692</span></a><span class="sd">        - The color intensity represents the magnitude of the symbol, highlighting regions where the symbol is large or small.</span>
</span><span id="PseudoDifferentialOperator-1693"><a href="#PseudoDifferentialOperator-1693"><span class="linenos">1693</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1694"><a href="#PseudoDifferentialOperator-1694"><span class="linenos">1694</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1695"><a href="#PseudoDifferentialOperator-1695"><span class="linenos">1695</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1696"><a href="#PseudoDifferentialOperator-1696"><span class="linenos">1696</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span> 
</span><span id="PseudoDifferentialOperator-1697"><a href="#PseudoDifferentialOperator-1697"><span class="linenos">1697</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1698"><a href="#PseudoDifferentialOperator-1698"><span class="linenos">1698</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1699"><a href="#PseudoDifferentialOperator-1699"><span class="linenos">1699</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1700"><a href="#PseudoDifferentialOperator-1700"><span class="linenos">1700</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1701"><a href="#PseudoDifferentialOperator-1701"><span class="linenos">1701</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Symbol Amplitude |p(x, ξ)|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1702"><a href="#PseudoDifferentialOperator-1702"><span class="linenos">1702</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1703"><a href="#PseudoDifferentialOperator-1703"><span class="linenos">1703</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1704"><a href="#PseudoDifferentialOperator-1704"><span class="linenos">1704</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1705"><a href="#PseudoDifferentialOperator-1705"><span class="linenos">1705</span></a>            <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1706"><a href="#PseudoDifferentialOperator-1706"><span class="linenos">1706</span></a>            <span class="n">ETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1707"><a href="#PseudoDifferentialOperator-1707"><span class="linenos">1707</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1708"><a href="#PseudoDifferentialOperator-1708"><span class="linenos">1708</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1709"><a href="#PseudoDifferentialOperator-1709"><span class="linenos">1709</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1710"><a href="#PseudoDifferentialOperator-1710"><span class="linenos">1710</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1711"><a href="#PseudoDifferentialOperator-1711"><span class="linenos">1711</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1712"><a href="#PseudoDifferentialOperator-1712"><span class="linenos">1712</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Amplitude at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1713"><a href="#PseudoDifferentialOperator-1713"><span class="linenos">1713</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1714"><a href="#PseudoDifferentialOperator-1714"><span class="linenos">1714</span></a>
</span><span id="PseudoDifferentialOperator-1715"><a href="#PseudoDifferentialOperator-1715"><span class="linenos">1715</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1716"><a href="#PseudoDifferentialOperator-1716"><span class="linenos">1716</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1717"><a href="#PseudoDifferentialOperator-1717"><span class="linenos">1717</span></a><span class="sd">        Plot the phase (argument) of the pseudodifferential operator&#39;s symbol p(x, ξ) or p(x, y, ξ, η).</span>
</span><span id="PseudoDifferentialOperator-1718"><a href="#PseudoDifferentialOperator-1718"><span class="linenos">1718</span></a>
</span><span id="PseudoDifferentialOperator-1719"><a href="#PseudoDifferentialOperator-1719"><span class="linenos">1719</span></a><span class="sd">        This visualization helps in understanding the oscillatory behavior and regularity </span>
</span><span id="PseudoDifferentialOperator-1720"><a href="#PseudoDifferentialOperator-1720"><span class="linenos">1720</span></a><span class="sd">        properties of the operator in phase space. The phase is displayed modulo 2π using </span>
</span><span id="PseudoDifferentialOperator-1721"><a href="#PseudoDifferentialOperator-1721"><span class="linenos">1721</span></a><span class="sd">        a cyclic colormap (&#39;twilight&#39;) to emphasize its periodic nature.</span>
</span><span id="PseudoDifferentialOperator-1722"><a href="#PseudoDifferentialOperator-1722"><span class="linenos">1722</span></a>
</span><span id="PseudoDifferentialOperator-1723"><a href="#PseudoDifferentialOperator-1723"><span class="linenos">1723</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1724"><a href="#PseudoDifferentialOperator-1724"><span class="linenos">1724</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1725"><a href="#PseudoDifferentialOperator-1725"><span class="linenos">1725</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1726"><a href="#PseudoDifferentialOperator-1726"><span class="linenos">1726</span></a><span class="sd">            1D array of spatial coordinates (x).</span>
</span><span id="PseudoDifferentialOperator-1727"><a href="#PseudoDifferentialOperator-1727"><span class="linenos">1727</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1728"><a href="#PseudoDifferentialOperator-1728"><span class="linenos">1728</span></a><span class="sd">            1D array of frequency coordinates (ξ).</span>
</span><span id="PseudoDifferentialOperator-1729"><a href="#PseudoDifferentialOperator-1729"><span class="linenos">1729</span></a><span class="sd">        y_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-1730"><a href="#PseudoDifferentialOperator-1730"><span class="linenos">1730</span></a><span class="sd">            2D spatial grid for y-coordinate (in 2D problems). Default is None.</span>
</span><span id="PseudoDifferentialOperator-1731"><a href="#PseudoDifferentialOperator-1731"><span class="linenos">1731</span></a><span class="sd">        eta_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-1732"><a href="#PseudoDifferentialOperator-1732"><span class="linenos">1732</span></a><span class="sd">            2D frequency grid for η (in 2D problems). Not used directly but kept for API consistency.</span>
</span><span id="PseudoDifferentialOperator-1733"><a href="#PseudoDifferentialOperator-1733"><span class="linenos">1733</span></a><span class="sd">        xi0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1734"><a href="#PseudoDifferentialOperator-1734"><span class="linenos">1734</span></a><span class="sd">            Fixed value of ξ for slicing in 2D visualization. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator-1735"><a href="#PseudoDifferentialOperator-1735"><span class="linenos">1735</span></a><span class="sd">        eta0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1736"><a href="#PseudoDifferentialOperator-1736"><span class="linenos">1736</span></a><span class="sd">            Fixed value of η for slicing in 2D visualization. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator-1737"><a href="#PseudoDifferentialOperator-1737"><span class="linenos">1737</span></a>
</span><span id="PseudoDifferentialOperator-1738"><a href="#PseudoDifferentialOperator-1738"><span class="linenos">1738</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator-1739"><a href="#PseudoDifferentialOperator-1739"><span class="linenos">1739</span></a><span class="sd">        - In 1D: Displays arg(p(x, ξ)) over the (x, ξ) phase plane.</span>
</span><span id="PseudoDifferentialOperator-1740"><a href="#PseudoDifferentialOperator-1740"><span class="linenos">1740</span></a><span class="sd">        - In 2D: Displays arg(p(x, y, ξ₀, η₀)) for fixed frequency values (ξ₀, η₀).</span>
</span><span id="PseudoDifferentialOperator-1741"><a href="#PseudoDifferentialOperator-1741"><span class="linenos">1741</span></a><span class="sd">        - Uses plt.pcolormesh with &#39;twilight&#39; colormap to represent angles from -π to π.</span>
</span><span id="PseudoDifferentialOperator-1742"><a href="#PseudoDifferentialOperator-1742"><span class="linenos">1742</span></a>
</span><span id="PseudoDifferentialOperator-1743"><a href="#PseudoDifferentialOperator-1743"><span class="linenos">1743</span></a><span class="sd">        Raises:</span>
</span><span id="PseudoDifferentialOperator-1744"><a href="#PseudoDifferentialOperator-1744"><span class="linenos">1744</span></a><span class="sd">        - NotImplementedError: If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator-1745"><a href="#PseudoDifferentialOperator-1745"><span class="linenos">1745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1746"><a href="#PseudoDifferentialOperator-1746"><span class="linenos">1746</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1747"><a href="#PseudoDifferentialOperator-1747"><span class="linenos">1747</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1748"><a href="#PseudoDifferentialOperator-1748"><span class="linenos">1748</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span> 
</span><span id="PseudoDifferentialOperator-1749"><a href="#PseudoDifferentialOperator-1749"><span class="linenos">1749</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;twilight&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1750"><a href="#PseudoDifferentialOperator-1750"><span class="linenos">1750</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;arg(Symbol) [rad]&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1751"><a href="#PseudoDifferentialOperator-1751"><span class="linenos">1751</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1752"><a href="#PseudoDifferentialOperator-1752"><span class="linenos">1752</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1753"><a href="#PseudoDifferentialOperator-1753"><span class="linenos">1753</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Phase Portrait (arg p(x, ξ))&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1754"><a href="#PseudoDifferentialOperator-1754"><span class="linenos">1754</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1755"><a href="#PseudoDifferentialOperator-1755"><span class="linenos">1755</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1756"><a href="#PseudoDifferentialOperator-1756"><span class="linenos">1756</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1757"><a href="#PseudoDifferentialOperator-1757"><span class="linenos">1757</span></a>            <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1758"><a href="#PseudoDifferentialOperator-1758"><span class="linenos">1758</span></a>            <span class="n">ETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1759"><a href="#PseudoDifferentialOperator-1759"><span class="linenos">1759</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1760"><a href="#PseudoDifferentialOperator-1760"><span class="linenos">1760</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;twilight&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1761"><a href="#PseudoDifferentialOperator-1761"><span class="linenos">1761</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;arg(Symbol) [rad]&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1762"><a href="#PseudoDifferentialOperator-1762"><span class="linenos">1762</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1763"><a href="#PseudoDifferentialOperator-1763"><span class="linenos">1763</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1764"><a href="#PseudoDifferentialOperator-1764"><span class="linenos">1764</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Phase Portrait at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1765"><a href="#PseudoDifferentialOperator-1765"><span class="linenos">1765</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1766"><a href="#PseudoDifferentialOperator-1766"><span class="linenos">1766</span></a>            
</span><span id="PseudoDifferentialOperator-1767"><a href="#PseudoDifferentialOperator-1767"><span class="linenos">1767</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_characteristic_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-1</span><span class="p">]):</span>
</span><span id="PseudoDifferentialOperator-1768"><a href="#PseudoDifferentialOperator-1768"><span class="linenos">1768</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1769"><a href="#PseudoDifferentialOperator-1769"><span class="linenos">1769</span></a><span class="sd">        Visualize the characteristic set of the pseudo-differential symbol, defined as the approximate zero set p(x, ξ) ≈ 0.</span>
</span><span id="PseudoDifferentialOperator-1770"><a href="#PseudoDifferentialOperator-1770"><span class="linenos">1770</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1771"><a href="#PseudoDifferentialOperator-1771"><span class="linenos">1771</span></a><span class="sd">        In microlocal analysis, the characteristic set is the locus of points in phase space (x, ξ) where the symbol p(x, ξ) vanishes,</span>
</span><span id="PseudoDifferentialOperator-1772"><a href="#PseudoDifferentialOperator-1772"><span class="linenos">1772</span></a><span class="sd">        playing a key role in understanding propagation of singularities.</span>
</span><span id="PseudoDifferentialOperator-1773"><a href="#PseudoDifferentialOperator-1773"><span class="linenos">1773</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1774"><a href="#PseudoDifferentialOperator-1774"><span class="linenos">1774</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1775"><a href="#PseudoDifferentialOperator-1775"><span class="linenos">1775</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1776"><a href="#PseudoDifferentialOperator-1776"><span class="linenos">1776</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1777"><a href="#PseudoDifferentialOperator-1777"><span class="linenos">1777</span></a><span class="sd">            Spatial grid values (1D array) for plotting in 1D or evaluation point in 2D.</span>
</span><span id="PseudoDifferentialOperator-1778"><a href="#PseudoDifferentialOperator-1778"><span class="linenos">1778</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator-1779"><a href="#PseudoDifferentialOperator-1779"><span class="linenos">1779</span></a><span class="sd">            Frequency variable grid values (1D array) used to construct the frequency domain.</span>
</span><span id="PseudoDifferentialOperator-1780"><a href="#PseudoDifferentialOperator-1780"><span class="linenos">1780</span></a><span class="sd">        x0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1781"><a href="#PseudoDifferentialOperator-1781"><span class="linenos">1781</span></a><span class="sd">            Fixed spatial coordinate in 2D case for evaluating the symbol at a specific x position.</span>
</span><span id="PseudoDifferentialOperator-1782"><a href="#PseudoDifferentialOperator-1782"><span class="linenos">1782</span></a><span class="sd">        y0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1783"><a href="#PseudoDifferentialOperator-1783"><span class="linenos">1783</span></a><span class="sd">            Fixed spatial coordinate in 2D case for evaluating the symbol at a specific y position.</span>
</span><span id="PseudoDifferentialOperator-1784"><a href="#PseudoDifferentialOperator-1784"><span class="linenos">1784</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1785"><a href="#PseudoDifferentialOperator-1785"><span class="linenos">1785</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1786"><a href="#PseudoDifferentialOperator-1786"><span class="linenos">1786</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1787"><a href="#PseudoDifferentialOperator-1787"><span class="linenos">1787</span></a><span class="sd">        - For 1D, this method plots the contour of |p(x, ξ)| = ε with ε = 1e-5 over the (x, ξ) plane.</span>
</span><span id="PseudoDifferentialOperator-1788"><a href="#PseudoDifferentialOperator-1788"><span class="linenos">1788</span></a><span class="sd">        - For 2D, it evaluates the symbol at fixed (x₀, y₀) and plots the characteristic set in the (ξ, η) frequency plane.</span>
</span><span id="PseudoDifferentialOperator-1789"><a href="#PseudoDifferentialOperator-1789"><span class="linenos">1789</span></a><span class="sd">        - This visualization helps identify directions of degeneracy or hypoellipticity of the operator.</span>
</span><span id="PseudoDifferentialOperator-1790"><a href="#PseudoDifferentialOperator-1790"><span class="linenos">1790</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1791"><a href="#PseudoDifferentialOperator-1791"><span class="linenos">1791</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-1792"><a href="#PseudoDifferentialOperator-1792"><span class="linenos">1792</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-1793"><a href="#PseudoDifferentialOperator-1793"><span class="linenos">1793</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-1794"><a href="#PseudoDifferentialOperator-1794"><span class="linenos">1794</span></a><span class="sd">            If called on a solver with dimensionality other than 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator-1795"><a href="#PseudoDifferentialOperator-1795"><span class="linenos">1795</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-1796"><a href="#PseudoDifferentialOperator-1796"><span class="linenos">1796</span></a><span class="sd">        Displays</span>
</span><span id="PseudoDifferentialOperator-1797"><a href="#PseudoDifferentialOperator-1797"><span class="linenos">1797</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-1798"><a href="#PseudoDifferentialOperator-1798"><span class="linenos">1798</span></a><span class="sd">        A matplotlib contour plot showing either:</span>
</span><span id="PseudoDifferentialOperator-1799"><a href="#PseudoDifferentialOperator-1799"><span class="linenos">1799</span></a><span class="sd">            - The characteristic curve in the (x, ξ) phase plane (1D),</span>
</span><span id="PseudoDifferentialOperator-1800"><a href="#PseudoDifferentialOperator-1800"><span class="linenos">1800</span></a><span class="sd">            - The characteristic surface slice in the (ξ, η) frequency plane at (x₀, y₀) (2D).</span>
</span><span id="PseudoDifferentialOperator-1801"><a href="#PseudoDifferentialOperator-1801"><span class="linenos">1801</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1802"><a href="#PseudoDifferentialOperator-1802"><span class="linenos">1802</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1803"><a href="#PseudoDifferentialOperator-1803"><span class="linenos">1803</span></a>            <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1804"><a href="#PseudoDifferentialOperator-1804"><span class="linenos">1804</span></a>            <span class="n">xi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1805"><a href="#PseudoDifferentialOperator-1805"><span class="linenos">1805</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1806"><a href="#PseudoDifferentialOperator-1806"><span class="linenos">1806</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span> 
</span><span id="PseudoDifferentialOperator-1807"><a href="#PseudoDifferentialOperator-1807"><span class="linenos">1807</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1808"><a href="#PseudoDifferentialOperator-1808"><span class="linenos">1808</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1809"><a href="#PseudoDifferentialOperator-1809"><span class="linenos">1809</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1810"><a href="#PseudoDifferentialOperator-1810"><span class="linenos">1810</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Characteristic Set (p(x, ξ) ≈ 0)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1811"><a href="#PseudoDifferentialOperator-1811"><span class="linenos">1811</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1812"><a href="#PseudoDifferentialOperator-1812"><span class="linenos">1812</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1813"><a href="#PseudoDifferentialOperator-1813"><span class="linenos">1813</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1814"><a href="#PseudoDifferentialOperator-1814"><span class="linenos">1814</span></a>            <span class="k">if</span> <span class="n">eta_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1815"><a href="#PseudoDifferentialOperator-1815"><span class="linenos">1815</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;eta_grid must be provided for 2D visualization.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1816"><a href="#PseudoDifferentialOperator-1816"><span class="linenos">1816</span></a>            <span class="n">xi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1817"><a href="#PseudoDifferentialOperator-1817"><span class="linenos">1817</span></a>            <span class="n">eta_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eta_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1818"><a href="#PseudoDifferentialOperator-1818"><span class="linenos">1818</span></a>            <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1819"><a href="#PseudoDifferentialOperator-1819"><span class="linenos">1819</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1820"><a href="#PseudoDifferentialOperator-1820"><span class="linenos">1820</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1821"><a href="#PseudoDifferentialOperator-1821"><span class="linenos">1821</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1822"><a href="#PseudoDifferentialOperator-1822"><span class="linenos">1822</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1823"><a href="#PseudoDifferentialOperator-1823"><span class="linenos">1823</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Characteristic Set at x=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s1">, y=</span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1824"><a href="#PseudoDifferentialOperator-1824"><span class="linenos">1824</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1825"><a href="#PseudoDifferentialOperator-1825"><span class="linenos">1825</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1826"><a href="#PseudoDifferentialOperator-1826"><span class="linenos">1826</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1827"><a href="#PseudoDifferentialOperator-1827"><span class="linenos">1827</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D/2D characteristic sets supported.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1828"><a href="#PseudoDifferentialOperator-1828"><span class="linenos">1828</span></a>
</span><span id="PseudoDifferentialOperator-1829"><a href="#PseudoDifferentialOperator-1829"><span class="linenos">1829</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_characteristic_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1830"><a href="#PseudoDifferentialOperator-1830"><span class="linenos">1830</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1831"><a href="#PseudoDifferentialOperator-1831"><span class="linenos">1831</span></a><span class="sd">        Visualize the norm of the gradient of the symbol in phase space.</span>
</span><span id="PseudoDifferentialOperator-1832"><a href="#PseudoDifferentialOperator-1832"><span class="linenos">1832</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1833"><a href="#PseudoDifferentialOperator-1833"><span class="linenos">1833</span></a><span class="sd">        This method computes the magnitude of the gradient |∇p| of a pseudo-differential </span>
</span><span id="PseudoDifferentialOperator-1834"><a href="#PseudoDifferentialOperator-1834"><span class="linenos">1834</span></a><span class="sd">        symbol p(x, ξ) in 1D or p(x, y, ξ, η) in 2D. The resulting colormap reveals </span>
</span><span id="PseudoDifferentialOperator-1835"><a href="#PseudoDifferentialOperator-1835"><span class="linenos">1835</span></a><span class="sd">        regions where the symbol varies rapidly or remains nearly stationary, </span>
</span><span id="PseudoDifferentialOperator-1836"><a href="#PseudoDifferentialOperator-1836"><span class="linenos">1836</span></a><span class="sd">        which is particularly useful for analyzing characteristic sets.</span>
</span><span id="PseudoDifferentialOperator-1837"><a href="#PseudoDifferentialOperator-1837"><span class="linenos">1837</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1838"><a href="#PseudoDifferentialOperator-1838"><span class="linenos">1838</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1839"><a href="#PseudoDifferentialOperator-1839"><span class="linenos">1839</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1840"><a href="#PseudoDifferentialOperator-1840"><span class="linenos">1840</span></a><span class="sd">        x_grid : numpy.ndarray</span>
</span><span id="PseudoDifferentialOperator-1841"><a href="#PseudoDifferentialOperator-1841"><span class="linenos">1841</span></a><span class="sd">            1D array of spatial coordinates for the x-direction.</span>
</span><span id="PseudoDifferentialOperator-1842"><a href="#PseudoDifferentialOperator-1842"><span class="linenos">1842</span></a><span class="sd">        xi_grid : numpy.ndarray</span>
</span><span id="PseudoDifferentialOperator-1843"><a href="#PseudoDifferentialOperator-1843"><span class="linenos">1843</span></a><span class="sd">            1D array of frequency coordinates (ξ).</span>
</span><span id="PseudoDifferentialOperator-1844"><a href="#PseudoDifferentialOperator-1844"><span class="linenos">1844</span></a><span class="sd">        y_grid : numpy.ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-1845"><a href="#PseudoDifferentialOperator-1845"><span class="linenos">1845</span></a><span class="sd">            1D array of spatial coordinates for the y-direction (used in 2D mode). Default is None.</span>
</span><span id="PseudoDifferentialOperator-1846"><a href="#PseudoDifferentialOperator-1846"><span class="linenos">1846</span></a><span class="sd">        eta_grid : numpy.ndarray, optional</span>
</span><span id="PseudoDifferentialOperator-1847"><a href="#PseudoDifferentialOperator-1847"><span class="linenos">1847</span></a><span class="sd">            1D array of frequency coordinates (η) for the 2D case. Default is None.</span>
</span><span id="PseudoDifferentialOperator-1848"><a href="#PseudoDifferentialOperator-1848"><span class="linenos">1848</span></a><span class="sd">        x0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1849"><a href="#PseudoDifferentialOperator-1849"><span class="linenos">1849</span></a><span class="sd">            Fixed x-coordinate for evaluating the symbol in 2D. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator-1850"><a href="#PseudoDifferentialOperator-1850"><span class="linenos">1850</span></a><span class="sd">        y0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1851"><a href="#PseudoDifferentialOperator-1851"><span class="linenos">1851</span></a><span class="sd">            Fixed y-coordinate for evaluating the symbol in 2D. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator-1852"><a href="#PseudoDifferentialOperator-1852"><span class="linenos">1852</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1853"><a href="#PseudoDifferentialOperator-1853"><span class="linenos">1853</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-1854"><a href="#PseudoDifferentialOperator-1854"><span class="linenos">1854</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-1855"><a href="#PseudoDifferentialOperator-1855"><span class="linenos">1855</span></a><span class="sd">        None</span>
</span><span id="PseudoDifferentialOperator-1856"><a href="#PseudoDifferentialOperator-1856"><span class="linenos">1856</span></a><span class="sd">            Displays a 2D colormap of |∇p| over the relevant phase-space domain.</span>
</span><span id="PseudoDifferentialOperator-1857"><a href="#PseudoDifferentialOperator-1857"><span class="linenos">1857</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator-1858"><a href="#PseudoDifferentialOperator-1858"><span class="linenos">1858</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1859"><a href="#PseudoDifferentialOperator-1859"><span class="linenos">1859</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1860"><a href="#PseudoDifferentialOperator-1860"><span class="linenos">1860</span></a><span class="sd">        - In 1D, the full gradient ∇p = (∂ₓp, ∂ξp) is computed over the (x, ξ) grid.</span>
</span><span id="PseudoDifferentialOperator-1861"><a href="#PseudoDifferentialOperator-1861"><span class="linenos">1861</span></a><span class="sd">        - In 2D, the gradient ∇p = (∂ξp, ∂ηp) is computed at a fixed spatial point (x₀, y₀) over the (ξ, η) grid.</span>
</span><span id="PseudoDifferentialOperator-1862"><a href="#PseudoDifferentialOperator-1862"><span class="linenos">1862</span></a><span class="sd">        - Numerical differentiation is performed using `np.gradient`.</span>
</span><span id="PseudoDifferentialOperator-1863"><a href="#PseudoDifferentialOperator-1863"><span class="linenos">1863</span></a><span class="sd">        - High values of |∇p| indicate rapid variation of the symbol, while low values typically suggest characteristic regions.</span>
</span><span id="PseudoDifferentialOperator-1864"><a href="#PseudoDifferentialOperator-1864"><span class="linenos">1864</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1865"><a href="#PseudoDifferentialOperator-1865"><span class="linenos">1865</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1866"><a href="#PseudoDifferentialOperator-1866"><span class="linenos">1866</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1867"><a href="#PseudoDifferentialOperator-1867"><span class="linenos">1867</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1868"><a href="#PseudoDifferentialOperator-1868"><span class="linenos">1868</span></a>            <span class="n">grad_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1869"><a href="#PseudoDifferentialOperator-1869"><span class="linenos">1869</span></a>            <span class="n">grad_xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1870"><a href="#PseudoDifferentialOperator-1870"><span class="linenos">1870</span></a>            <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grad_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grad_xi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1871"><a href="#PseudoDifferentialOperator-1871"><span class="linenos">1871</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">grad_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1872"><a href="#PseudoDifferentialOperator-1872"><span class="linenos">1872</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|∇p|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1873"><a href="#PseudoDifferentialOperator-1873"><span class="linenos">1873</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1874"><a href="#PseudoDifferentialOperator-1874"><span class="linenos">1874</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1875"><a href="#PseudoDifferentialOperator-1875"><span class="linenos">1875</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gradient Norm (High Near Zeros)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1876"><a href="#PseudoDifferentialOperator-1876"><span class="linenos">1876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1877"><a href="#PseudoDifferentialOperator-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1878"><a href="#PseudoDifferentialOperator-1878"><span class="linenos">1878</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1879"><a href="#PseudoDifferentialOperator-1879"><span class="linenos">1879</span></a>            <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1880"><a href="#PseudoDifferentialOperator-1880"><span class="linenos">1880</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1881"><a href="#PseudoDifferentialOperator-1881"><span class="linenos">1881</span></a>            <span class="n">grad_xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1882"><a href="#PseudoDifferentialOperator-1882"><span class="linenos">1882</span></a>            <span class="n">grad_eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1883"><a href="#PseudoDifferentialOperator-1883"><span class="linenos">1883</span></a>            <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">grad_xi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">grad_eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1884"><a href="#PseudoDifferentialOperator-1884"><span class="linenos">1884</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">grad_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1885"><a href="#PseudoDifferentialOperator-1885"><span class="linenos">1885</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|∇p|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1886"><a href="#PseudoDifferentialOperator-1886"><span class="linenos">1886</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1887"><a href="#PseudoDifferentialOperator-1887"><span class="linenos">1887</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1888"><a href="#PseudoDifferentialOperator-1888"><span class="linenos">1888</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gradient Norm at x=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s1">, y=</span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1889"><a href="#PseudoDifferentialOperator-1889"><span class="linenos">1889</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1890"><a href="#PseudoDifferentialOperator-1890"><span class="linenos">1890</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1891"><a href="#PseudoDifferentialOperator-1891"><span class="linenos">1891</span></a>
</span><span id="PseudoDifferentialOperator-1892"><a href="#PseudoDifferentialOperator-1892"><span class="linenos">1892</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hamiltonian_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">show_field</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1893"><a href="#PseudoDifferentialOperator-1893"><span class="linenos">1893</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1894"><a href="#PseudoDifferentialOperator-1894"><span class="linenos">1894</span></a><span class="sd">        Integrate and plot the Hamiltonian trajectories of the symbol in phase space.</span>
</span><span id="PseudoDifferentialOperator-1895"><a href="#PseudoDifferentialOperator-1895"><span class="linenos">1895</span></a>
</span><span id="PseudoDifferentialOperator-1896"><a href="#PseudoDifferentialOperator-1896"><span class="linenos">1896</span></a><span class="sd">        This method numerically integrates the Hamiltonian vector field derived from </span>
</span><span id="PseudoDifferentialOperator-1897"><a href="#PseudoDifferentialOperator-1897"><span class="linenos">1897</span></a><span class="sd">        the operator&#39;s symbol to visualize how singularities propagate under the flow. </span>
</span><span id="PseudoDifferentialOperator-1898"><a href="#PseudoDifferentialOperator-1898"><span class="linenos">1898</span></a><span class="sd">        It supports both 1D and 2D problems.</span>
</span><span id="PseudoDifferentialOperator-1899"><a href="#PseudoDifferentialOperator-1899"><span class="linenos">1899</span></a>
</span><span id="PseudoDifferentialOperator-1900"><a href="#PseudoDifferentialOperator-1900"><span class="linenos">1900</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-1901"><a href="#PseudoDifferentialOperator-1901"><span class="linenos">1901</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-1902"><a href="#PseudoDifferentialOperator-1902"><span class="linenos">1902</span></a><span class="sd">        x0, xi0 : float</span>
</span><span id="PseudoDifferentialOperator-1903"><a href="#PseudoDifferentialOperator-1903"><span class="linenos">1903</span></a><span class="sd">            Initial position and frequency (momentum) in 1D.</span>
</span><span id="PseudoDifferentialOperator-1904"><a href="#PseudoDifferentialOperator-1904"><span class="linenos">1904</span></a><span class="sd">        y0, eta0 : float, optional</span>
</span><span id="PseudoDifferentialOperator-1905"><a href="#PseudoDifferentialOperator-1905"><span class="linenos">1905</span></a><span class="sd">            Initial position and frequency in 2D; defaults to zero.</span>
</span><span id="PseudoDifferentialOperator-1906"><a href="#PseudoDifferentialOperator-1906"><span class="linenos">1906</span></a><span class="sd">        tmax : float</span>
</span><span id="PseudoDifferentialOperator-1907"><a href="#PseudoDifferentialOperator-1907"><span class="linenos">1907</span></a><span class="sd">            Final integration time for the ODE solver.</span>
</span><span id="PseudoDifferentialOperator-1908"><a href="#PseudoDifferentialOperator-1908"><span class="linenos">1908</span></a><span class="sd">        n_steps : int</span>
</span><span id="PseudoDifferentialOperator-1909"><a href="#PseudoDifferentialOperator-1909"><span class="linenos">1909</span></a><span class="sd">            Number of time steps used in the integration.</span>
</span><span id="PseudoDifferentialOperator-1910"><a href="#PseudoDifferentialOperator-1910"><span class="linenos">1910</span></a>
</span><span id="PseudoDifferentialOperator-1911"><a href="#PseudoDifferentialOperator-1911"><span class="linenos">1911</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-1912"><a href="#PseudoDifferentialOperator-1912"><span class="linenos">1912</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-1913"><a href="#PseudoDifferentialOperator-1913"><span class="linenos">1913</span></a><span class="sd">        - The Hamiltonian vector field is obtained from the symplectic flow of the symbol.</span>
</span><span id="PseudoDifferentialOperator-1914"><a href="#PseudoDifferentialOperator-1914"><span class="linenos">1914</span></a><span class="sd">        - If the field is complex-valued, only its real part is used for integration.</span>
</span><span id="PseudoDifferentialOperator-1915"><a href="#PseudoDifferentialOperator-1915"><span class="linenos">1915</span></a><span class="sd">        - In 1D, the trajectory is plotted in (x, ξ) phase space.</span>
</span><span id="PseudoDifferentialOperator-1916"><a href="#PseudoDifferentialOperator-1916"><span class="linenos">1916</span></a><span class="sd">        - In 2D, the spatial trajectory (x(t), y(t)) is shown along with instantaneous </span>
</span><span id="PseudoDifferentialOperator-1917"><a href="#PseudoDifferentialOperator-1917"><span class="linenos">1917</span></a><span class="sd">          momentum vectors (ξ(t), η(t)) using a quiver plot.</span>
</span><span id="PseudoDifferentialOperator-1918"><a href="#PseudoDifferentialOperator-1918"><span class="linenos">1918</span></a>
</span><span id="PseudoDifferentialOperator-1919"><a href="#PseudoDifferentialOperator-1919"><span class="linenos">1919</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-1920"><a href="#PseudoDifferentialOperator-1920"><span class="linenos">1920</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-1921"><a href="#PseudoDifferentialOperator-1921"><span class="linenos">1921</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-1922"><a href="#PseudoDifferentialOperator-1922"><span class="linenos">1922</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator-1923"><a href="#PseudoDifferentialOperator-1923"><span class="linenos">1923</span></a>
</span><span id="PseudoDifferentialOperator-1924"><a href="#PseudoDifferentialOperator-1924"><span class="linenos">1924</span></a><span class="sd">        Displays</span>
</span><span id="PseudoDifferentialOperator-1925"><a href="#PseudoDifferentialOperator-1925"><span class="linenos">1925</span></a><span class="sd">        --------</span>
</span><span id="PseudoDifferentialOperator-1926"><a href="#PseudoDifferentialOperator-1926"><span class="linenos">1926</span></a><span class="sd">        matplotlib plot</span>
</span><span id="PseudoDifferentialOperator-1927"><a href="#PseudoDifferentialOperator-1927"><span class="linenos">1927</span></a><span class="sd">            Phase space trajectory(ies) showing the evolution of position and momentum </span>
</span><span id="PseudoDifferentialOperator-1928"><a href="#PseudoDifferentialOperator-1928"><span class="linenos">1928</span></a><span class="sd">            under the Hamiltonian dynamics.</span>
</span><span id="PseudoDifferentialOperator-1929"><a href="#PseudoDifferentialOperator-1929"><span class="linenos">1929</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-1930"><a href="#PseudoDifferentialOperator-1930"><span class="linenos">1930</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">make_real</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1931"><a href="#PseudoDifferentialOperator-1931"><span class="linenos">1931</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">simplify</span>
</span><span id="PseudoDifferentialOperator-1932"><a href="#PseudoDifferentialOperator-1932"><span class="linenos">1932</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">doit</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1933"><a href="#PseudoDifferentialOperator-1933"><span class="linenos">1933</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">re</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1934"><a href="#PseudoDifferentialOperator-1934"><span class="linenos">1934</span></a>    
</span><span id="PseudoDifferentialOperator-1935"><a href="#PseudoDifferentialOperator-1935"><span class="linenos">1935</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symplectic_flow</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1936"><a href="#PseudoDifferentialOperator-1936"><span class="linenos">1936</span></a>    
</span><span id="PseudoDifferentialOperator-1937"><a href="#PseudoDifferentialOperator-1937"><span class="linenos">1937</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">im</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">H</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1938"><a href="#PseudoDifferentialOperator-1938"><span class="linenos">1938</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ The Hamiltonian field is complex. Only the real part is used for integration.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1939"><a href="#PseudoDifferentialOperator-1939"><span class="linenos">1939</span></a>    
</span><span id="PseudoDifferentialOperator-1940"><a href="#PseudoDifferentialOperator-1940"><span class="linenos">1940</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1941"><a href="#PseudoDifferentialOperator-1941"><span class="linenos">1941</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1942"><a href="#PseudoDifferentialOperator-1942"><span class="linenos">1942</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1943"><a href="#PseudoDifferentialOperator-1943"><span class="linenos">1943</span></a>    
</span><span id="PseudoDifferentialOperator-1944"><a href="#PseudoDifferentialOperator-1944"><span class="linenos">1944</span></a>            <span class="n">dxdt_expr</span> <span class="o">=</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-1945"><a href="#PseudoDifferentialOperator-1945"><span class="linenos">1945</span></a>            <span class="n">dxidt_expr</span> <span class="o">=</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-1946"><a href="#PseudoDifferentialOperator-1946"><span class="linenos">1946</span></a>    
</span><span id="PseudoDifferentialOperator-1947"><a href="#PseudoDifferentialOperator-1947"><span class="linenos">1947</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxdt_expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1948"><a href="#PseudoDifferentialOperator-1948"><span class="linenos">1948</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxidt_expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1949"><a href="#PseudoDifferentialOperator-1949"><span class="linenos">1949</span></a>    
</span><span id="PseudoDifferentialOperator-1950"><a href="#PseudoDifferentialOperator-1950"><span class="linenos">1950</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1951"><a href="#PseudoDifferentialOperator-1951"><span class="linenos">1951</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator-1952"><a href="#PseudoDifferentialOperator-1952"><span class="linenos">1952</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">)]</span>
</span><span id="PseudoDifferentialOperator-1953"><a href="#PseudoDifferentialOperator-1953"><span class="linenos">1953</span></a>    
</span><span id="PseudoDifferentialOperator-1954"><a href="#PseudoDifferentialOperator-1954"><span class="linenos">1954</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">],</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1955"><a href="#PseudoDifferentialOperator-1955"><span class="linenos">1955</span></a>
</span><span id="PseudoDifferentialOperator-1956"><a href="#PseudoDifferentialOperator-1956"><span class="linenos">1956</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1957"><a href="#PseudoDifferentialOperator-1957"><span class="linenos">1957</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1958"><a href="#PseudoDifferentialOperator-1958"><span class="linenos">1958</span></a>            
</span><span id="PseudoDifferentialOperator-1959"><a href="#PseudoDifferentialOperator-1959"><span class="linenos">1959</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1960"><a href="#PseudoDifferentialOperator-1960"><span class="linenos">1960</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1961"><a href="#PseudoDifferentialOperator-1961"><span class="linenos">1961</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1962"><a href="#PseudoDifferentialOperator-1962"><span class="linenos">1962</span></a>                <span class="n">n_steps</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator-1963"><a href="#PseudoDifferentialOperator-1963"><span class="linenos">1963</span></a>
</span><span id="PseudoDifferentialOperator-1964"><a href="#PseudoDifferentialOperator-1964"><span class="linenos">1964</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator-1965"><a href="#PseudoDifferentialOperator-1965"><span class="linenos">1965</span></a>    
</span><span id="PseudoDifferentialOperator-1966"><a href="#PseudoDifferentialOperator-1966"><span class="linenos">1966</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1967"><a href="#PseudoDifferentialOperator-1967"><span class="linenos">1967</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1968"><a href="#PseudoDifferentialOperator-1968"><span class="linenos">1968</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ξ&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1969"><a href="#PseudoDifferentialOperator-1969"><span class="linenos">1969</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hamiltonian Flow in Phase Space (1D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1970"><a href="#PseudoDifferentialOperator-1970"><span class="linenos">1970</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1971"><a href="#PseudoDifferentialOperator-1971"><span class="linenos">1971</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-1972"><a href="#PseudoDifferentialOperator-1972"><span class="linenos">1972</span></a>    
</span><span id="PseudoDifferentialOperator-1973"><a href="#PseudoDifferentialOperator-1973"><span class="linenos">1973</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1974"><a href="#PseudoDifferentialOperator-1974"><span class="linenos">1974</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-1975"><a href="#PseudoDifferentialOperator-1975"><span class="linenos">1975</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1976"><a href="#PseudoDifferentialOperator-1976"><span class="linenos">1976</span></a>    
</span><span id="PseudoDifferentialOperator-1977"><a href="#PseudoDifferentialOperator-1977"><span class="linenos">1977</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1978"><a href="#PseudoDifferentialOperator-1978"><span class="linenos">1978</span></a>            <span class="n">dydt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dy/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1979"><a href="#PseudoDifferentialOperator-1979"><span class="linenos">1979</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1980"><a href="#PseudoDifferentialOperator-1980"><span class="linenos">1980</span></a>            <span class="n">detadt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;deta/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1981"><a href="#PseudoDifferentialOperator-1981"><span class="linenos">1981</span></a>    
</span><span id="PseudoDifferentialOperator-1982"><a href="#PseudoDifferentialOperator-1982"><span class="linenos">1982</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-1983"><a href="#PseudoDifferentialOperator-1983"><span class="linenos">1983</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator-1984"><a href="#PseudoDifferentialOperator-1984"><span class="linenos">1984</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="PseudoDifferentialOperator-1985"><a href="#PseudoDifferentialOperator-1985"><span class="linenos">1985</span></a>                    <span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1986"><a href="#PseudoDifferentialOperator-1986"><span class="linenos">1986</span></a>                    <span class="n">dydt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1987"><a href="#PseudoDifferentialOperator-1987"><span class="linenos">1987</span></a>                    <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-1988"><a href="#PseudoDifferentialOperator-1988"><span class="linenos">1988</span></a>                    <span class="n">detadt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1989"><a href="#PseudoDifferentialOperator-1989"><span class="linenos">1989</span></a>                <span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1990"><a href="#PseudoDifferentialOperator-1990"><span class="linenos">1990</span></a>    
</span><span id="PseudoDifferentialOperator-1991"><a href="#PseudoDifferentialOperator-1991"><span class="linenos">1991</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">],</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-1992"><a href="#PseudoDifferentialOperator-1992"><span class="linenos">1992</span></a>
</span><span id="PseudoDifferentialOperator-1993"><a href="#PseudoDifferentialOperator-1993"><span class="linenos">1993</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1994"><a href="#PseudoDifferentialOperator-1994"><span class="linenos">1994</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1995"><a href="#PseudoDifferentialOperator-1995"><span class="linenos">1995</span></a>            
</span><span id="PseudoDifferentialOperator-1996"><a href="#PseudoDifferentialOperator-1996"><span class="linenos">1996</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-1997"><a href="#PseudoDifferentialOperator-1997"><span class="linenos">1997</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-1998"><a href="#PseudoDifferentialOperator-1998"><span class="linenos">1998</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-1999"><a href="#PseudoDifferentialOperator-1999"><span class="linenos">1999</span></a>                <span class="n">n_steps</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator-2000"><a href="#PseudoDifferentialOperator-2000"><span class="linenos">2000</span></a>
</span><span id="PseudoDifferentialOperator-2001"><a href="#PseudoDifferentialOperator-2001"><span class="linenos">2001</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator-2002"><a href="#PseudoDifferentialOperator-2002"><span class="linenos">2002</span></a>    
</span><span id="PseudoDifferentialOperator-2003"><a href="#PseudoDifferentialOperator-2003"><span class="linenos">2003</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2004"><a href="#PseudoDifferentialOperator-2004"><span class="linenos">2004</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2005"><a href="#PseudoDifferentialOperator-2005"><span class="linenos">2005</span></a>            
</span><span id="PseudoDifferentialOperator-2006"><a href="#PseudoDifferentialOperator-2006"><span class="linenos">2006</span></a>            <span class="c1"># Vector field of the flow (optional)</span>
</span><span id="PseudoDifferentialOperator-2007"><a href="#PseudoDifferentialOperator-2007"><span class="linenos">2007</span></a>            <span class="k">if</span> <span class="n">show_field</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2008"><a href="#PseudoDifferentialOperator-2008"><span class="linenos">2008</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2009"><a href="#PseudoDifferentialOperator-2009"><span class="linenos">2009</span></a>                                   <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2010"><a href="#PseudoDifferentialOperator-2010"><span class="linenos">2010</span></a>                <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span> <span class="o">=</span> <span class="n">xi0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">eta0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2011"><a href="#PseudoDifferentialOperator-2011"><span class="linenos">2011</span></a>                <span class="n">U</span> <span class="o">=</span> <span class="n">dxdt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2012"><a href="#PseudoDifferentialOperator-2012"><span class="linenos">2012</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2013"><a href="#PseudoDifferentialOperator-2013"><span class="linenos">2013</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2014"><a href="#PseudoDifferentialOperator-2014"><span class="linenos">2014</span></a>
</span><span id="PseudoDifferentialOperator-2015"><a href="#PseudoDifferentialOperator-2015"><span class="linenos">2015</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2016"><a href="#PseudoDifferentialOperator-2016"><span class="linenos">2016</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2017"><a href="#PseudoDifferentialOperator-2017"><span class="linenos">2017</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hamiltonian Flow in Phase Space (2D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2018"><a href="#PseudoDifferentialOperator-2018"><span class="linenos">2018</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2019"><a href="#PseudoDifferentialOperator-2019"><span class="linenos">2019</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2020"><a href="#PseudoDifferentialOperator-2020"><span class="linenos">2020</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2021"><a href="#PseudoDifferentialOperator-2021"><span class="linenos">2021</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2022"><a href="#PseudoDifferentialOperator-2022"><span class="linenos">2022</span></a>
</span><span id="PseudoDifferentialOperator-2023"><a href="#PseudoDifferentialOperator-2023"><span class="linenos">2023</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_symplectic_vector_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2024"><a href="#PseudoDifferentialOperator-2024"><span class="linenos">2024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2025"><a href="#PseudoDifferentialOperator-2025"><span class="linenos">2025</span></a><span class="sd">        Visualize the symplectic vector field (Hamiltonian vector field) associated with the operator&#39;s symbol.</span>
</span><span id="PseudoDifferentialOperator-2026"><a href="#PseudoDifferentialOperator-2026"><span class="linenos">2026</span></a>
</span><span id="PseudoDifferentialOperator-2027"><a href="#PseudoDifferentialOperator-2027"><span class="linenos">2027</span></a><span class="sd">        The plotted vector field corresponds to (∂_ξ p, -∂_x p), where p(x, ξ) is the principal symbol </span>
</span><span id="PseudoDifferentialOperator-2028"><a href="#PseudoDifferentialOperator-2028"><span class="linenos">2028</span></a><span class="sd">        of the pseudo-differential operator. This field governs the bicharacteristic flow in phase space.</span>
</span><span id="PseudoDifferentialOperator-2029"><a href="#PseudoDifferentialOperator-2029"><span class="linenos">2029</span></a>
</span><span id="PseudoDifferentialOperator-2030"><a href="#PseudoDifferentialOperator-2030"><span class="linenos">2030</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-2031"><a href="#PseudoDifferentialOperator-2031"><span class="linenos">2031</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-2032"><a href="#PseudoDifferentialOperator-2032"><span class="linenos">2032</span></a><span class="sd">        xlim : tuple of float</span>
</span><span id="PseudoDifferentialOperator-2033"><a href="#PseudoDifferentialOperator-2033"><span class="linenos">2033</span></a><span class="sd">            Range for spatial variable x, as (x_min, x_max).</span>
</span><span id="PseudoDifferentialOperator-2034"><a href="#PseudoDifferentialOperator-2034"><span class="linenos">2034</span></a><span class="sd">        klim : tuple of float</span>
</span><span id="PseudoDifferentialOperator-2035"><a href="#PseudoDifferentialOperator-2035"><span class="linenos">2035</span></a><span class="sd">            Range for frequency variable ξ, as (ξ_min, ξ_max).</span>
</span><span id="PseudoDifferentialOperator-2036"><a href="#PseudoDifferentialOperator-2036"><span class="linenos">2036</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator-2037"><a href="#PseudoDifferentialOperator-2037"><span class="linenos">2037</span></a><span class="sd">            Number of grid points per axis for the visualization grid.</span>
</span><span id="PseudoDifferentialOperator-2038"><a href="#PseudoDifferentialOperator-2038"><span class="linenos">2038</span></a>
</span><span id="PseudoDifferentialOperator-2039"><a href="#PseudoDifferentialOperator-2039"><span class="linenos">2039</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-2040"><a href="#PseudoDifferentialOperator-2040"><span class="linenos">2040</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-2041"><a href="#PseudoDifferentialOperator-2041"><span class="linenos">2041</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-2042"><a href="#PseudoDifferentialOperator-2042"><span class="linenos">2042</span></a><span class="sd">            If called on a 2D operator (currently only 1D implementation available).</span>
</span><span id="PseudoDifferentialOperator-2043"><a href="#PseudoDifferentialOperator-2043"><span class="linenos">2043</span></a>
</span><span id="PseudoDifferentialOperator-2044"><a href="#PseudoDifferentialOperator-2044"><span class="linenos">2044</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-2045"><a href="#PseudoDifferentialOperator-2045"><span class="linenos">2045</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-2046"><a href="#PseudoDifferentialOperator-2046"><span class="linenos">2046</span></a><span class="sd">        - Only supports one-dimensional operators.</span>
</span><span id="PseudoDifferentialOperator-2047"><a href="#PseudoDifferentialOperator-2047"><span class="linenos">2047</span></a><span class="sd">        - Uses symbolic differentiation to compute ∂_ξ p and ∂_x p.</span>
</span><span id="PseudoDifferentialOperator-2048"><a href="#PseudoDifferentialOperator-2048"><span class="linenos">2048</span></a><span class="sd">        - Numerical evaluation is done via lambdify with NumPy backend.</span>
</span><span id="PseudoDifferentialOperator-2049"><a href="#PseudoDifferentialOperator-2049"><span class="linenos">2049</span></a><span class="sd">        - Visualization uses matplotlib quiver plot to show vector directions.</span>
</span><span id="PseudoDifferentialOperator-2050"><a href="#PseudoDifferentialOperator-2050"><span class="linenos">2050</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2051"><a href="#PseudoDifferentialOperator-2051"><span class="linenos">2051</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2052"><a href="#PseudoDifferentialOperator-2052"><span class="linenos">2052</span></a>        <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">klim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2053"><a href="#PseudoDifferentialOperator-2053"><span class="linenos">2053</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2054"><a href="#PseudoDifferentialOperator-2054"><span class="linenos">2054</span></a>
</span><span id="PseudoDifferentialOperator-2055"><a href="#PseudoDifferentialOperator-2055"><span class="linenos">2055</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2056"><a href="#PseudoDifferentialOperator-2056"><span class="linenos">2056</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D version implemented.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2057"><a href="#PseudoDifferentialOperator-2057"><span class="linenos">2057</span></a>
</span><span id="PseudoDifferentialOperator-2058"><a href="#PseudoDifferentialOperator-2058"><span class="linenos">2058</span></a>        <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2059"><a href="#PseudoDifferentialOperator-2059"><span class="linenos">2059</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2060"><a href="#PseudoDifferentialOperator-2060"><span class="linenos">2060</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symplectic_flow</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2061"><a href="#PseudoDifferentialOperator-2061"><span class="linenos">2061</span></a>        <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">simplify</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2062"><a href="#PseudoDifferentialOperator-2062"><span class="linenos">2062</span></a>        <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">simplify</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2063"><a href="#PseudoDifferentialOperator-2063"><span class="linenos">2063</span></a>
</span><span id="PseudoDifferentialOperator-2064"><a href="#PseudoDifferentialOperator-2064"><span class="linenos">2064</span></a>        <span class="n">U</span> <span class="o">=</span> <span class="n">dxdt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2065"><a href="#PseudoDifferentialOperator-2065"><span class="linenos">2065</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">dxidt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2066"><a href="#PseudoDifferentialOperator-2066"><span class="linenos">2066</span></a>
</span><span id="PseudoDifferentialOperator-2067"><a href="#PseudoDifferentialOperator-2067"><span class="linenos">2067</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2068"><a href="#PseudoDifferentialOperator-2068"><span class="linenos">2068</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2069"><a href="#PseudoDifferentialOperator-2069"><span class="linenos">2069</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2070"><a href="#PseudoDifferentialOperator-2070"><span class="linenos">2070</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Symplectic Vector Field (1D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2071"><a href="#PseudoDifferentialOperator-2071"><span class="linenos">2071</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2072"><a href="#PseudoDifferentialOperator-2072"><span class="linenos">2072</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2073"><a href="#PseudoDifferentialOperator-2073"><span class="linenos">2073</span></a>
</span><span id="PseudoDifferentialOperator-2074"><a href="#PseudoDifferentialOperator-2074"><span class="linenos">2074</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_micro_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2075"><a href="#PseudoDifferentialOperator-2075"><span class="linenos">2075</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2076"><a href="#PseudoDifferentialOperator-2076"><span class="linenos">2076</span></a><span class="sd">        Visualize the micro-support of the operator by plotting the inverse of the symbol magnitude 1 / |p(x, ξ)|.</span>
</span><span id="PseudoDifferentialOperator-2077"><a href="#PseudoDifferentialOperator-2077"><span class="linenos">2077</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2078"><a href="#PseudoDifferentialOperator-2078"><span class="linenos">2078</span></a><span class="sd">        The micro-support provides insight into the singularities of a pseudo-differential operator </span>
</span><span id="PseudoDifferentialOperator-2079"><a href="#PseudoDifferentialOperator-2079"><span class="linenos">2079</span></a><span class="sd">        in phase space (x, ξ). Regions where |p(x, ξ)| is small correspond to large values in 1/|p(x, ξ)|,</span>
</span><span id="PseudoDifferentialOperator-2080"><a href="#PseudoDifferentialOperator-2080"><span class="linenos">2080</span></a><span class="sd">        highlighting areas of significant operator influence or singularity.</span>
</span><span id="PseudoDifferentialOperator-2081"><a href="#PseudoDifferentialOperator-2081"><span class="linenos">2081</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2082"><a href="#PseudoDifferentialOperator-2082"><span class="linenos">2082</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-2083"><a href="#PseudoDifferentialOperator-2083"><span class="linenos">2083</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-2084"><a href="#PseudoDifferentialOperator-2084"><span class="linenos">2084</span></a><span class="sd">        xlim : tuple</span>
</span><span id="PseudoDifferentialOperator-2085"><a href="#PseudoDifferentialOperator-2085"><span class="linenos">2085</span></a><span class="sd">            Spatial domain limits (x_min, x_max).</span>
</span><span id="PseudoDifferentialOperator-2086"><a href="#PseudoDifferentialOperator-2086"><span class="linenos">2086</span></a><span class="sd">        klim : tuple</span>
</span><span id="PseudoDifferentialOperator-2087"><a href="#PseudoDifferentialOperator-2087"><span class="linenos">2087</span></a><span class="sd">            Frequency domain limits (ξ_min, ξ_max).</span>
</span><span id="PseudoDifferentialOperator-2088"><a href="#PseudoDifferentialOperator-2088"><span class="linenos">2088</span></a><span class="sd">        threshold : float</span>
</span><span id="PseudoDifferentialOperator-2089"><a href="#PseudoDifferentialOperator-2089"><span class="linenos">2089</span></a><span class="sd">            Threshold below which |p(x, ξ)| is considered effectively zero; used for numerical stability.</span>
</span><span id="PseudoDifferentialOperator-2090"><a href="#PseudoDifferentialOperator-2090"><span class="linenos">2090</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator-2091"><a href="#PseudoDifferentialOperator-2091"><span class="linenos">2091</span></a><span class="sd">            Number of grid points along each axis for visualization resolution.</span>
</span><span id="PseudoDifferentialOperator-2092"><a href="#PseudoDifferentialOperator-2092"><span class="linenos">2092</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2093"><a href="#PseudoDifferentialOperator-2093"><span class="linenos">2093</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-2094"><a href="#PseudoDifferentialOperator-2094"><span class="linenos">2094</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-2095"><a href="#PseudoDifferentialOperator-2095"><span class="linenos">2095</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-2096"><a href="#PseudoDifferentialOperator-2096"><span class="linenos">2096</span></a><span class="sd">            If called on a solver with dimension greater than 1 (only 1D visualization is supported).</span>
</span><span id="PseudoDifferentialOperator-2097"><a href="#PseudoDifferentialOperator-2097"><span class="linenos">2097</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2098"><a href="#PseudoDifferentialOperator-2098"><span class="linenos">2098</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-2099"><a href="#PseudoDifferentialOperator-2099"><span class="linenos">2099</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-2100"><a href="#PseudoDifferentialOperator-2100"><span class="linenos">2100</span></a><span class="sd">        - This method evaluates the symbol p(x, ξ) over a grid and plots its reciprocal to emphasize </span>
</span><span id="PseudoDifferentialOperator-2101"><a href="#PseudoDifferentialOperator-2101"><span class="linenos">2101</span></a><span class="sd">          regions where the symbol is near zero.</span>
</span><span id="PseudoDifferentialOperator-2102"><a href="#PseudoDifferentialOperator-2102"><span class="linenos">2102</span></a><span class="sd">        - A small constant (1e-10) is added to the denominator to avoid division by zero.</span>
</span><span id="PseudoDifferentialOperator-2103"><a href="#PseudoDifferentialOperator-2103"><span class="linenos">2103</span></a><span class="sd">        - The resulting plot helps identify characteristic sets.</span>
</span><span id="PseudoDifferentialOperator-2104"><a href="#PseudoDifferentialOperator-2104"><span class="linenos">2104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2105"><a href="#PseudoDifferentialOperator-2105"><span class="linenos">2105</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2106"><a href="#PseudoDifferentialOperator-2106"><span class="linenos">2106</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D micro-support visualization implemented.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2107"><a href="#PseudoDifferentialOperator-2107"><span class="linenos">2107</span></a>
</span><span id="PseudoDifferentialOperator-2108"><a href="#PseudoDifferentialOperator-2108"><span class="linenos">2108</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2109"><a href="#PseudoDifferentialOperator-2109"><span class="linenos">2109</span></a>        <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">klim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2110"><a href="#PseudoDifferentialOperator-2110"><span class="linenos">2110</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2111"><a href="#PseudoDifferentialOperator-2111"><span class="linenos">2111</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2112"><a href="#PseudoDifferentialOperator-2112"><span class="linenos">2112</span></a>
</span><span id="PseudoDifferentialOperator-2113"><a href="#PseudoDifferentialOperator-2113"><span class="linenos">2113</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2114"><a href="#PseudoDifferentialOperator-2114"><span class="linenos">2114</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$1/|p(x,\xi)|$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2115"><a href="#PseudoDifferentialOperator-2115"><span class="linenos">2115</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2116"><a href="#PseudoDifferentialOperator-2116"><span class="linenos">2116</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2117"><a href="#PseudoDifferentialOperator-2117"><span class="linenos">2117</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Micro-Support Estimate (1/|Symbol|)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2118"><a href="#PseudoDifferentialOperator-2118"><span class="linenos">2118</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2119"><a href="#PseudoDifferentialOperator-2119"><span class="linenos">2119</span></a>
</span><span id="PseudoDifferentialOperator-2120"><a href="#PseudoDifferentialOperator-2120"><span class="linenos">2120</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">group_velocity_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2121"><a href="#PseudoDifferentialOperator-2121"><span class="linenos">2121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2122"><a href="#PseudoDifferentialOperator-2122"><span class="linenos">2122</span></a><span class="sd">        Plot the group velocity field ∇_ξ p(x, ξ) for 1D pseudo-differential operators.</span>
</span><span id="PseudoDifferentialOperator-2123"><a href="#PseudoDifferentialOperator-2123"><span class="linenos">2123</span></a>
</span><span id="PseudoDifferentialOperator-2124"><a href="#PseudoDifferentialOperator-2124"><span class="linenos">2124</span></a><span class="sd">        The group velocity represents the speed at which waves of different frequencies propagate </span>
</span><span id="PseudoDifferentialOperator-2125"><a href="#PseudoDifferentialOperator-2125"><span class="linenos">2125</span></a><span class="sd">        in a dispersive medium. It is defined as the gradient of the symbol p(x, ξ) with respect </span>
</span><span id="PseudoDifferentialOperator-2126"><a href="#PseudoDifferentialOperator-2126"><span class="linenos">2126</span></a><span class="sd">        to the frequency variable ξ.</span>
</span><span id="PseudoDifferentialOperator-2127"><a href="#PseudoDifferentialOperator-2127"><span class="linenos">2127</span></a>
</span><span id="PseudoDifferentialOperator-2128"><a href="#PseudoDifferentialOperator-2128"><span class="linenos">2128</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-2129"><a href="#PseudoDifferentialOperator-2129"><span class="linenos">2129</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-2130"><a href="#PseudoDifferentialOperator-2130"><span class="linenos">2130</span></a><span class="sd">        xlim : tuple of float</span>
</span><span id="PseudoDifferentialOperator-2131"><a href="#PseudoDifferentialOperator-2131"><span class="linenos">2131</span></a><span class="sd">            Spatial domain limits (x-axis).</span>
</span><span id="PseudoDifferentialOperator-2132"><a href="#PseudoDifferentialOperator-2132"><span class="linenos">2132</span></a><span class="sd">        klim : tuple of float</span>
</span><span id="PseudoDifferentialOperator-2133"><a href="#PseudoDifferentialOperator-2133"><span class="linenos">2133</span></a><span class="sd">            Frequency domain limits (ξ-axis).</span>
</span><span id="PseudoDifferentialOperator-2134"><a href="#PseudoDifferentialOperator-2134"><span class="linenos">2134</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator-2135"><a href="#PseudoDifferentialOperator-2135"><span class="linenos">2135</span></a><span class="sd">            Number of grid points per axis used for visualization.</span>
</span><span id="PseudoDifferentialOperator-2136"><a href="#PseudoDifferentialOperator-2136"><span class="linenos">2136</span></a>
</span><span id="PseudoDifferentialOperator-2137"><a href="#PseudoDifferentialOperator-2137"><span class="linenos">2137</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-2138"><a href="#PseudoDifferentialOperator-2138"><span class="linenos">2138</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-2139"><a href="#PseudoDifferentialOperator-2139"><span class="linenos">2139</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-2140"><a href="#PseudoDifferentialOperator-2140"><span class="linenos">2140</span></a><span class="sd">            If called on a 2D operator, since this visualization is only implemented for 1D.</span>
</span><span id="PseudoDifferentialOperator-2141"><a href="#PseudoDifferentialOperator-2141"><span class="linenos">2141</span></a>
</span><span id="PseudoDifferentialOperator-2142"><a href="#PseudoDifferentialOperator-2142"><span class="linenos">2142</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-2143"><a href="#PseudoDifferentialOperator-2143"><span class="linenos">2143</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-2144"><a href="#PseudoDifferentialOperator-2144"><span class="linenos">2144</span></a><span class="sd">        - This method visualizes the vector field (∂p/∂ξ) in phase space.</span>
</span><span id="PseudoDifferentialOperator-2145"><a href="#PseudoDifferentialOperator-2145"><span class="linenos">2145</span></a><span class="sd">        - Used for analyzing wave propagation properties and dispersion relations.</span>
</span><span id="PseudoDifferentialOperator-2146"><a href="#PseudoDifferentialOperator-2146"><span class="linenos">2146</span></a><span class="sd">        - Requires symbolic expression self.expr depending on x and ξ.</span>
</span><span id="PseudoDifferentialOperator-2147"><a href="#PseudoDifferentialOperator-2147"><span class="linenos">2147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2148"><a href="#PseudoDifferentialOperator-2148"><span class="linenos">2148</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2149"><a href="#PseudoDifferentialOperator-2149"><span class="linenos">2149</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D group velocity visualization implemented.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2150"><a href="#PseudoDifferentialOperator-2150"><span class="linenos">2150</span></a>
</span><span id="PseudoDifferentialOperator-2151"><a href="#PseudoDifferentialOperator-2151"><span class="linenos">2151</span></a>        <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2152"><a href="#PseudoDifferentialOperator-2152"><span class="linenos">2152</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2153"><a href="#PseudoDifferentialOperator-2153"><span class="linenos">2153</span></a>        <span class="n">dp_dxi</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2154"><a href="#PseudoDifferentialOperator-2154"><span class="linenos">2154</span></a>        <span class="n">grad_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dp_dxi</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2155"><a href="#PseudoDifferentialOperator-2155"><span class="linenos">2155</span></a>
</span><span id="PseudoDifferentialOperator-2156"><a href="#PseudoDifferentialOperator-2156"><span class="linenos">2156</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2157"><a href="#PseudoDifferentialOperator-2157"><span class="linenos">2157</span></a>        <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">klim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2158"><a href="#PseudoDifferentialOperator-2158"><span class="linenos">2158</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2159"><a href="#PseudoDifferentialOperator-2159"><span class="linenos">2159</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">grad_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2160"><a href="#PseudoDifferentialOperator-2160"><span class="linenos">2160</span></a>
</span><span id="PseudoDifferentialOperator-2161"><a href="#PseudoDifferentialOperator-2161"><span class="linenos">2161</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2162"><a href="#PseudoDifferentialOperator-2162"><span class="linenos">2162</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2163"><a href="#PseudoDifferentialOperator-2163"><span class="linenos">2163</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2164"><a href="#PseudoDifferentialOperator-2164"><span class="linenos">2164</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Group Velocity Field (1D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2165"><a href="#PseudoDifferentialOperator-2165"><span class="linenos">2165</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2166"><a href="#PseudoDifferentialOperator-2166"><span class="linenos">2166</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2167"><a href="#PseudoDifferentialOperator-2167"><span class="linenos">2167</span></a>
</span><span id="PseudoDifferentialOperator-2168"><a href="#PseudoDifferentialOperator-2168"><span class="linenos">2168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">animate_singularity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2169"><a href="#PseudoDifferentialOperator-2169"><span class="linenos">2169</span></a>                            <span class="n">tmax</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2170"><a href="#PseudoDifferentialOperator-2170"><span class="linenos">2170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2171"><a href="#PseudoDifferentialOperator-2171"><span class="linenos">2171</span></a><span class="sd">        Animate the propagation of a singularity under the Hamiltonian flow.</span>
</span><span id="PseudoDifferentialOperator-2172"><a href="#PseudoDifferentialOperator-2172"><span class="linenos">2172</span></a>
</span><span id="PseudoDifferentialOperator-2173"><a href="#PseudoDifferentialOperator-2173"><span class="linenos">2173</span></a><span class="sd">        This method visualizes how a singularity (x₀, y₀, ξ₀, η₀) evolves in phase space </span>
</span><span id="PseudoDifferentialOperator-2174"><a href="#PseudoDifferentialOperator-2174"><span class="linenos">2174</span></a><span class="sd">        according to the Hamiltonian dynamics induced by the principal symbol of the operator.</span>
</span><span id="PseudoDifferentialOperator-2175"><a href="#PseudoDifferentialOperator-2175"><span class="linenos">2175</span></a><span class="sd">        The animation integrates the Hamiltonian equations of motion and supports various projections:</span>
</span><span id="PseudoDifferentialOperator-2176"><a href="#PseudoDifferentialOperator-2176"><span class="linenos">2176</span></a><span class="sd">        position (x-y), frequency (ξ-η), or mixed phase space coordinates.</span>
</span><span id="PseudoDifferentialOperator-2177"><a href="#PseudoDifferentialOperator-2177"><span class="linenos">2177</span></a>
</span><span id="PseudoDifferentialOperator-2178"><a href="#PseudoDifferentialOperator-2178"><span class="linenos">2178</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-2179"><a href="#PseudoDifferentialOperator-2179"><span class="linenos">2179</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-2180"><a href="#PseudoDifferentialOperator-2180"><span class="linenos">2180</span></a><span class="sd">        xi0, eta0 : float</span>
</span><span id="PseudoDifferentialOperator-2181"><a href="#PseudoDifferentialOperator-2181"><span class="linenos">2181</span></a><span class="sd">            Initial frequency components (ξ₀, η₀).</span>
</span><span id="PseudoDifferentialOperator-2182"><a href="#PseudoDifferentialOperator-2182"><span class="linenos">2182</span></a><span class="sd">        x0, y0 : float</span>
</span><span id="PseudoDifferentialOperator-2183"><a href="#PseudoDifferentialOperator-2183"><span class="linenos">2183</span></a><span class="sd">            Initial spatial coordinates (x₀, y₀).</span>
</span><span id="PseudoDifferentialOperator-2184"><a href="#PseudoDifferentialOperator-2184"><span class="linenos">2184</span></a><span class="sd">        tmax : float</span>
</span><span id="PseudoDifferentialOperator-2185"><a href="#PseudoDifferentialOperator-2185"><span class="linenos">2185</span></a><span class="sd">            Total time of integration (final animation time).</span>
</span><span id="PseudoDifferentialOperator-2186"><a href="#PseudoDifferentialOperator-2186"><span class="linenos">2186</span></a><span class="sd">        n_frames : int</span>
</span><span id="PseudoDifferentialOperator-2187"><a href="#PseudoDifferentialOperator-2187"><span class="linenos">2187</span></a><span class="sd">            Number of frames in the resulting animation.</span>
</span><span id="PseudoDifferentialOperator-2188"><a href="#PseudoDifferentialOperator-2188"><span class="linenos">2188</span></a><span class="sd">        projection : str or None</span>
</span><span id="PseudoDifferentialOperator-2189"><a href="#PseudoDifferentialOperator-2189"><span class="linenos">2189</span></a><span class="sd">            Type of projection to display:</span>
</span><span id="PseudoDifferentialOperator-2190"><a href="#PseudoDifferentialOperator-2190"><span class="linenos">2190</span></a><span class="sd">                - &#39;position&#39; : x vs y (or x alone in 1D)</span>
</span><span id="PseudoDifferentialOperator-2191"><a href="#PseudoDifferentialOperator-2191"><span class="linenos">2191</span></a><span class="sd">                - &#39;frequency&#39;: ξ vs η (or ξ alone in 1D)</span>
</span><span id="PseudoDifferentialOperator-2192"><a href="#PseudoDifferentialOperator-2192"><span class="linenos">2192</span></a><span class="sd">                - &#39;phase&#39;    : mixed coordinates like x vs ξ or x vs η</span>
</span><span id="PseudoDifferentialOperator-2193"><a href="#PseudoDifferentialOperator-2193"><span class="linenos">2193</span></a><span class="sd">                If None, defaults to &#39;phase&#39; in 1D and &#39;position&#39; in 2D.</span>
</span><span id="PseudoDifferentialOperator-2194"><a href="#PseudoDifferentialOperator-2194"><span class="linenos">2194</span></a>
</span><span id="PseudoDifferentialOperator-2195"><a href="#PseudoDifferentialOperator-2195"><span class="linenos">2195</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator-2196"><a href="#PseudoDifferentialOperator-2196"><span class="linenos">2196</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator-2197"><a href="#PseudoDifferentialOperator-2197"><span class="linenos">2197</span></a><span class="sd">        matplotlib.animation.FuncAnimation</span>
</span><span id="PseudoDifferentialOperator-2198"><a href="#PseudoDifferentialOperator-2198"><span class="linenos">2198</span></a><span class="sd">            Animation object that can be displayed interactively in Jupyter notebooks or saved as a video.</span>
</span><span id="PseudoDifferentialOperator-2199"><a href="#PseudoDifferentialOperator-2199"><span class="linenos">2199</span></a>
</span><span id="PseudoDifferentialOperator-2200"><a href="#PseudoDifferentialOperator-2200"><span class="linenos">2200</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-2201"><a href="#PseudoDifferentialOperator-2201"><span class="linenos">2201</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-2202"><a href="#PseudoDifferentialOperator-2202"><span class="linenos">2202</span></a><span class="sd">        - In 1D, only one spatial and one frequency variable are used.</span>
</span><span id="PseudoDifferentialOperator-2203"><a href="#PseudoDifferentialOperator-2203"><span class="linenos">2203</span></a><span class="sd">        - Complex-valued Hamiltonian fields are truncated to their real parts for integration.</span>
</span><span id="PseudoDifferentialOperator-2204"><a href="#PseudoDifferentialOperator-2204"><span class="linenos">2204</span></a><span class="sd">        - Trajectories are shown with both instantaneous position (dot) and full path (dashed line).</span>
</span><span id="PseudoDifferentialOperator-2205"><a href="#PseudoDifferentialOperator-2205"><span class="linenos">2205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2206"><a href="#PseudoDifferentialOperator-2206"><span class="linenos">2206</span></a>        <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;animation&#39;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="s1">&#39;jshtml&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2207"><a href="#PseudoDifferentialOperator-2207"><span class="linenos">2207</span></a>    
</span><span id="PseudoDifferentialOperator-2208"><a href="#PseudoDifferentialOperator-2208"><span class="linenos">2208</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">make_real</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2209"><a href="#PseudoDifferentialOperator-2209"><span class="linenos">2209</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">simplify</span>
</span><span id="PseudoDifferentialOperator-2210"><a href="#PseudoDifferentialOperator-2210"><span class="linenos">2210</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">doit</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2211"><a href="#PseudoDifferentialOperator-2211"><span class="linenos">2211</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">re</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2212"><a href="#PseudoDifferentialOperator-2212"><span class="linenos">2212</span></a>  
</span><span id="PseudoDifferentialOperator-2213"><a href="#PseudoDifferentialOperator-2213"><span class="linenos">2213</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symplectic_flow</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2214"><a href="#PseudoDifferentialOperator-2214"><span class="linenos">2214</span></a>
</span><span id="PseudoDifferentialOperator-2215"><a href="#PseudoDifferentialOperator-2215"><span class="linenos">2215</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">doit</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">H</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="PseudoDifferentialOperator-2216"><a href="#PseudoDifferentialOperator-2216"><span class="linenos">2216</span></a>
</span><span id="PseudoDifferentialOperator-2217"><a href="#PseudoDifferentialOperator-2217"><span class="linenos">2217</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;H = &quot;</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2218"><a href="#PseudoDifferentialOperator-2218"><span class="linenos">2218</span></a>    
</span><span id="PseudoDifferentialOperator-2219"><a href="#PseudoDifferentialOperator-2219"><span class="linenos">2219</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">im</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">H</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2220"><a href="#PseudoDifferentialOperator-2220"><span class="linenos">2220</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ The Hamiltonian field is complex. Only the real part is used for integration.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2221"><a href="#PseudoDifferentialOperator-2221"><span class="linenos">2221</span></a>    
</span><span id="PseudoDifferentialOperator-2222"><a href="#PseudoDifferentialOperator-2222"><span class="linenos">2222</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2223"><a href="#PseudoDifferentialOperator-2223"><span class="linenos">2223</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2224"><a href="#PseudoDifferentialOperator-2224"><span class="linenos">2224</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2225"><a href="#PseudoDifferentialOperator-2225"><span class="linenos">2225</span></a>    
</span><span id="PseudoDifferentialOperator-2226"><a href="#PseudoDifferentialOperator-2226"><span class="linenos">2226</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2227"><a href="#PseudoDifferentialOperator-2227"><span class="linenos">2227</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2228"><a href="#PseudoDifferentialOperator-2228"><span class="linenos">2228</span></a>    
</span><span id="PseudoDifferentialOperator-2229"><a href="#PseudoDifferentialOperator-2229"><span class="linenos">2229</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2230"><a href="#PseudoDifferentialOperator-2230"><span class="linenos">2230</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator-2231"><a href="#PseudoDifferentialOperator-2231"><span class="linenos">2231</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">)]</span>
</span><span id="PseudoDifferentialOperator-2232"><a href="#PseudoDifferentialOperator-2232"><span class="linenos">2232</span></a>    
</span><span id="PseudoDifferentialOperator-2233"><a href="#PseudoDifferentialOperator-2233"><span class="linenos">2233</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator-2234"><a href="#PseudoDifferentialOperator-2234"><span class="linenos">2234</span></a>                            <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2235"><a href="#PseudoDifferentialOperator-2235"><span class="linenos">2235</span></a>            
</span><span id="PseudoDifferentialOperator-2236"><a href="#PseudoDifferentialOperator-2236"><span class="linenos">2236</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2237"><a href="#PseudoDifferentialOperator-2237"><span class="linenos">2237</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2238"><a href="#PseudoDifferentialOperator-2238"><span class="linenos">2238</span></a>            
</span><span id="PseudoDifferentialOperator-2239"><a href="#PseudoDifferentialOperator-2239"><span class="linenos">2239</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2240"><a href="#PseudoDifferentialOperator-2240"><span class="linenos">2240</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_frames</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2241"><a href="#PseudoDifferentialOperator-2241"><span class="linenos">2241</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2242"><a href="#PseudoDifferentialOperator-2242"><span class="linenos">2242</span></a>                <span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator-2243"><a href="#PseudoDifferentialOperator-2243"><span class="linenos">2243</span></a>
</span><span id="PseudoDifferentialOperator-2244"><a href="#PseudoDifferentialOperator-2244"><span class="linenos">2244</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator-2245"><a href="#PseudoDifferentialOperator-2245"><span class="linenos">2245</span></a>    
</span><span id="PseudoDifferentialOperator-2246"><a href="#PseudoDifferentialOperator-2246"><span class="linenos">2246</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2247"><a href="#PseudoDifferentialOperator-2247"><span class="linenos">2247</span></a>                <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;phase&#39;</span>
</span><span id="PseudoDifferentialOperator-2248"><a href="#PseudoDifferentialOperator-2248"><span class="linenos">2248</span></a>    
</span><span id="PseudoDifferentialOperator-2249"><a href="#PseudoDifferentialOperator-2249"><span class="linenos">2249</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2250"><a href="#PseudoDifferentialOperator-2250"><span class="linenos">2250</span></a>            <span class="n">point</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2251"><a href="#PseudoDifferentialOperator-2251"><span class="linenos">2251</span></a>            <span class="n">traj</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2252"><a href="#PseudoDifferentialOperator-2252"><span class="linenos">2252</span></a>    
</span><span id="PseudoDifferentialOperator-2253"><a href="#PseudoDifferentialOperator-2253"><span class="linenos">2253</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2254"><a href="#PseudoDifferentialOperator-2254"><span class="linenos">2254</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2255"><a href="#PseudoDifferentialOperator-2255"><span class="linenos">2255</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2256"><a href="#PseudoDifferentialOperator-2256"><span class="linenos">2256</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2257"><a href="#PseudoDifferentialOperator-2257"><span class="linenos">2257</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2258"><a href="#PseudoDifferentialOperator-2258"><span class="linenos">2258</span></a>    
</span><span id="PseudoDifferentialOperator-2259"><a href="#PseudoDifferentialOperator-2259"><span class="linenos">2259</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2260"><a href="#PseudoDifferentialOperator-2260"><span class="linenos">2260</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator-2261"><a href="#PseudoDifferentialOperator-2261"><span class="linenos">2261</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2262"><a href="#PseudoDifferentialOperator-2262"><span class="linenos">2262</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator-2263"><a href="#PseudoDifferentialOperator-2263"><span class="linenos">2263</span></a>    
</span><span id="PseudoDifferentialOperator-2264"><a href="#PseudoDifferentialOperator-2264"><span class="linenos">2264</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2265"><a href="#PseudoDifferentialOperator-2265"><span class="linenos">2265</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2266"><a href="#PseudoDifferentialOperator-2266"><span class="linenos">2266</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2267"><a href="#PseudoDifferentialOperator-2267"><span class="linenos">2267</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2268"><a href="#PseudoDifferentialOperator-2268"><span class="linenos">2268</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2269"><a href="#PseudoDifferentialOperator-2269"><span class="linenos">2269</span></a>    
</span><span id="PseudoDifferentialOperator-2270"><a href="#PseudoDifferentialOperator-2270"><span class="linenos">2270</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2271"><a href="#PseudoDifferentialOperator-2271"><span class="linenos">2271</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator-2272"><a href="#PseudoDifferentialOperator-2272"><span class="linenos">2272</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2273"><a href="#PseudoDifferentialOperator-2273"><span class="linenos">2273</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator-2274"><a href="#PseudoDifferentialOperator-2274"><span class="linenos">2274</span></a>    
</span><span id="PseudoDifferentialOperator-2275"><a href="#PseudoDifferentialOperator-2275"><span class="linenos">2275</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2276"><a href="#PseudoDifferentialOperator-2276"><span class="linenos">2276</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2277"><a href="#PseudoDifferentialOperator-2277"><span class="linenos">2277</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2278"><a href="#PseudoDifferentialOperator-2278"><span class="linenos">2278</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2279"><a href="#PseudoDifferentialOperator-2279"><span class="linenos">2279</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2280"><a href="#PseudoDifferentialOperator-2280"><span class="linenos">2280</span></a>    
</span><span id="PseudoDifferentialOperator-2281"><a href="#PseudoDifferentialOperator-2281"><span class="linenos">2281</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2282"><a href="#PseudoDifferentialOperator-2282"><span class="linenos">2282</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator-2283"><a href="#PseudoDifferentialOperator-2283"><span class="linenos">2283</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2284"><a href="#PseudoDifferentialOperator-2284"><span class="linenos">2284</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator-2285"><a href="#PseudoDifferentialOperator-2285"><span class="linenos">2285</span></a>    
</span><span id="PseudoDifferentialOperator-2286"><a href="#PseudoDifferentialOperator-2286"><span class="linenos">2286</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2287"><a href="#PseudoDifferentialOperator-2287"><span class="linenos">2287</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid projection mode&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2288"><a href="#PseudoDifferentialOperator-2288"><span class="linenos">2288</span></a>    
</span><span id="PseudoDifferentialOperator-2289"><a href="#PseudoDifferentialOperator-2289"><span class="linenos">2289</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1D Singularity Flow (</span><span class="si">{</span><span class="n">projection</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2290"><a href="#PseudoDifferentialOperator-2290"><span class="linenos">2290</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2291"><a href="#PseudoDifferentialOperator-2291"><span class="linenos">2291</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2292"><a href="#PseudoDifferentialOperator-2292"><span class="linenos">2292</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2293"><a href="#PseudoDifferentialOperator-2293"><span class="linenos">2293</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PseudoDifferentialOperator-2294"><a href="#PseudoDifferentialOperator-2294"><span class="linenos">2294</span></a>    
</span><span id="PseudoDifferentialOperator-2295"><a href="#PseudoDifferentialOperator-2295"><span class="linenos">2295</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2296"><a href="#PseudoDifferentialOperator-2296"><span class="linenos">2296</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2297"><a href="#PseudoDifferentialOperator-2297"><span class="linenos">2297</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2298"><a href="#PseudoDifferentialOperator-2298"><span class="linenos">2298</span></a>    
</span><span id="PseudoDifferentialOperator-2299"><a href="#PseudoDifferentialOperator-2299"><span class="linenos">2299</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2300"><a href="#PseudoDifferentialOperator-2300"><span class="linenos">2300</span></a>            <span class="n">dydt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dy/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2301"><a href="#PseudoDifferentialOperator-2301"><span class="linenos">2301</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2302"><a href="#PseudoDifferentialOperator-2302"><span class="linenos">2302</span></a>            <span class="n">detadt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;deta/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2303"><a href="#PseudoDifferentialOperator-2303"><span class="linenos">2303</span></a>    
</span><span id="PseudoDifferentialOperator-2304"><a href="#PseudoDifferentialOperator-2304"><span class="linenos">2304</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2305"><a href="#PseudoDifferentialOperator-2305"><span class="linenos">2305</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator-2306"><a href="#PseudoDifferentialOperator-2306"><span class="linenos">2306</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="PseudoDifferentialOperator-2307"><a href="#PseudoDifferentialOperator-2307"><span class="linenos">2307</span></a>                    <span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2308"><a href="#PseudoDifferentialOperator-2308"><span class="linenos">2308</span></a>                    <span class="n">dydt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2309"><a href="#PseudoDifferentialOperator-2309"><span class="linenos">2309</span></a>                    <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2310"><a href="#PseudoDifferentialOperator-2310"><span class="linenos">2310</span></a>                    <span class="n">detadt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2311"><a href="#PseudoDifferentialOperator-2311"><span class="linenos">2311</span></a>                <span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2312"><a href="#PseudoDifferentialOperator-2312"><span class="linenos">2312</span></a>    
</span><span id="PseudoDifferentialOperator-2313"><a href="#PseudoDifferentialOperator-2313"><span class="linenos">2313</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator-2314"><a href="#PseudoDifferentialOperator-2314"><span class="linenos">2314</span></a>                            <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2315"><a href="#PseudoDifferentialOperator-2315"><span class="linenos">2315</span></a>
</span><span id="PseudoDifferentialOperator-2316"><a href="#PseudoDifferentialOperator-2316"><span class="linenos">2316</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2317"><a href="#PseudoDifferentialOperator-2317"><span class="linenos">2317</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2318"><a href="#PseudoDifferentialOperator-2318"><span class="linenos">2318</span></a>            
</span><span id="PseudoDifferentialOperator-2319"><a href="#PseudoDifferentialOperator-2319"><span class="linenos">2319</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2320"><a href="#PseudoDifferentialOperator-2320"><span class="linenos">2320</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_frames</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2321"><a href="#PseudoDifferentialOperator-2321"><span class="linenos">2321</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2322"><a href="#PseudoDifferentialOperator-2322"><span class="linenos">2322</span></a>                <span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator-2323"><a href="#PseudoDifferentialOperator-2323"><span class="linenos">2323</span></a>                
</span><span id="PseudoDifferentialOperator-2324"><a href="#PseudoDifferentialOperator-2324"><span class="linenos">2324</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator-2325"><a href="#PseudoDifferentialOperator-2325"><span class="linenos">2325</span></a>    
</span><span id="PseudoDifferentialOperator-2326"><a href="#PseudoDifferentialOperator-2326"><span class="linenos">2326</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2327"><a href="#PseudoDifferentialOperator-2327"><span class="linenos">2327</span></a>                <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;position&#39;</span>
</span><span id="PseudoDifferentialOperator-2328"><a href="#PseudoDifferentialOperator-2328"><span class="linenos">2328</span></a>    
</span><span id="PseudoDifferentialOperator-2329"><a href="#PseudoDifferentialOperator-2329"><span class="linenos">2329</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator-2330"><a href="#PseudoDifferentialOperator-2330"><span class="linenos">2330</span></a>            <span class="n">point</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2331"><a href="#PseudoDifferentialOperator-2331"><span class="linenos">2331</span></a>            <span class="n">traj</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2332"><a href="#PseudoDifferentialOperator-2332"><span class="linenos">2332</span></a>    
</span><span id="PseudoDifferentialOperator-2333"><a href="#PseudoDifferentialOperator-2333"><span class="linenos">2333</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2334"><a href="#PseudoDifferentialOperator-2334"><span class="linenos">2334</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2335"><a href="#PseudoDifferentialOperator-2335"><span class="linenos">2335</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2336"><a href="#PseudoDifferentialOperator-2336"><span class="linenos">2336</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2337"><a href="#PseudoDifferentialOperator-2337"><span class="linenos">2337</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2338"><a href="#PseudoDifferentialOperator-2338"><span class="linenos">2338</span></a>    
</span><span id="PseudoDifferentialOperator-2339"><a href="#PseudoDifferentialOperator-2339"><span class="linenos">2339</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2340"><a href="#PseudoDifferentialOperator-2340"><span class="linenos">2340</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">y_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator-2341"><a href="#PseudoDifferentialOperator-2341"><span class="linenos">2341</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2342"><a href="#PseudoDifferentialOperator-2342"><span class="linenos">2342</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator-2343"><a href="#PseudoDifferentialOperator-2343"><span class="linenos">2343</span></a>    
</span><span id="PseudoDifferentialOperator-2344"><a href="#PseudoDifferentialOperator-2344"><span class="linenos">2344</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2345"><a href="#PseudoDifferentialOperator-2345"><span class="linenos">2345</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2346"><a href="#PseudoDifferentialOperator-2346"><span class="linenos">2346</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\eta$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2347"><a href="#PseudoDifferentialOperator-2347"><span class="linenos">2347</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2348"><a href="#PseudoDifferentialOperator-2348"><span class="linenos">2348</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2349"><a href="#PseudoDifferentialOperator-2349"><span class="linenos">2349</span></a>    
</span><span id="PseudoDifferentialOperator-2350"><a href="#PseudoDifferentialOperator-2350"><span class="linenos">2350</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2351"><a href="#PseudoDifferentialOperator-2351"><span class="linenos">2351</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">eta_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator-2352"><a href="#PseudoDifferentialOperator-2352"><span class="linenos">2352</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">eta_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2353"><a href="#PseudoDifferentialOperator-2353"><span class="linenos">2353</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator-2354"><a href="#PseudoDifferentialOperator-2354"><span class="linenos">2354</span></a>    
</span><span id="PseudoDifferentialOperator-2355"><a href="#PseudoDifferentialOperator-2355"><span class="linenos">2355</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2356"><a href="#PseudoDifferentialOperator-2356"><span class="linenos">2356</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2357"><a href="#PseudoDifferentialOperator-2357"><span class="linenos">2357</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\eta$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2358"><a href="#PseudoDifferentialOperator-2358"><span class="linenos">2358</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2359"><a href="#PseudoDifferentialOperator-2359"><span class="linenos">2359</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2360"><a href="#PseudoDifferentialOperator-2360"><span class="linenos">2360</span></a>    
</span><span id="PseudoDifferentialOperator-2361"><a href="#PseudoDifferentialOperator-2361"><span class="linenos">2361</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2362"><a href="#PseudoDifferentialOperator-2362"><span class="linenos">2362</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">eta_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator-2363"><a href="#PseudoDifferentialOperator-2363"><span class="linenos">2363</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">eta_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2364"><a href="#PseudoDifferentialOperator-2364"><span class="linenos">2364</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator-2365"><a href="#PseudoDifferentialOperator-2365"><span class="linenos">2365</span></a>    
</span><span id="PseudoDifferentialOperator-2366"><a href="#PseudoDifferentialOperator-2366"><span class="linenos">2366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2367"><a href="#PseudoDifferentialOperator-2367"><span class="linenos">2367</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid projection mode&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2368"><a href="#PseudoDifferentialOperator-2368"><span class="linenos">2368</span></a>    
</span><span id="PseudoDifferentialOperator-2369"><a href="#PseudoDifferentialOperator-2369"><span class="linenos">2369</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2D Singularity Flow (</span><span class="si">{</span><span class="n">projection</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2370"><a href="#PseudoDifferentialOperator-2370"><span class="linenos">2370</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2371"><a href="#PseudoDifferentialOperator-2371"><span class="linenos">2371</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2372"><a href="#PseudoDifferentialOperator-2372"><span class="linenos">2372</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2373"><a href="#PseudoDifferentialOperator-2373"><span class="linenos">2373</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2374"><a href="#PseudoDifferentialOperator-2374"><span class="linenos">2374</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PseudoDifferentialOperator-2375"><a href="#PseudoDifferentialOperator-2375"><span class="linenos">2375</span></a>
</span><span id="PseudoDifferentialOperator-2376"><a href="#PseudoDifferentialOperator-2376"><span class="linenos">2376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">interactive_symbol_analysis</span><span class="p">(</span><span class="n">pseudo_op</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2377"><a href="#PseudoDifferentialOperator-2377"><span class="linenos">2377</span></a>                                    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2378"><a href="#PseudoDifferentialOperator-2378"><span class="linenos">2378</span></a>                                    <span class="n">xi_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">eta_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2379"><a href="#PseudoDifferentialOperator-2379"><span class="linenos">2379</span></a>                                    <span class="n">density</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2380"><a href="#PseudoDifferentialOperator-2380"><span class="linenos">2380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2381"><a href="#PseudoDifferentialOperator-2381"><span class="linenos">2381</span></a><span class="sd">        Launch an interactive dashboard for symbol exploration using ipywidgets.</span>
</span><span id="PseudoDifferentialOperator-2382"><a href="#PseudoDifferentialOperator-2382"><span class="linenos">2382</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2383"><a href="#PseudoDifferentialOperator-2383"><span class="linenos">2383</span></a><span class="sd">        This function provides a user-friendly interface to visualize various aspects of the pseudo-differential operator&#39;s symbol.</span>
</span><span id="PseudoDifferentialOperator-2384"><a href="#PseudoDifferentialOperator-2384"><span class="linenos">2384</span></a><span class="sd">        It supports multiple visualization modes in both 1D and 2D, including group velocity fields, micro-support estimates,</span>
</span><span id="PseudoDifferentialOperator-2385"><a href="#PseudoDifferentialOperator-2385"><span class="linenos">2385</span></a><span class="sd">        symplectic vector fields, symbol amplitude/phase, cotangent fiber structure, characteristic sets and Hamiltonian flows.</span>
</span><span id="PseudoDifferentialOperator-2386"><a href="#PseudoDifferentialOperator-2386"><span class="linenos">2386</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2387"><a href="#PseudoDifferentialOperator-2387"><span class="linenos">2387</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator-2388"><a href="#PseudoDifferentialOperator-2388"><span class="linenos">2388</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator-2389"><a href="#PseudoDifferentialOperator-2389"><span class="linenos">2389</span></a><span class="sd">        pseudo_op : PseudoDifferentialOperator</span>
</span><span id="PseudoDifferentialOperator-2390"><a href="#PseudoDifferentialOperator-2390"><span class="linenos">2390</span></a><span class="sd">            The pseudo-differential operator whose symbol is to be analyzed interactively.</span>
</span><span id="PseudoDifferentialOperator-2391"><a href="#PseudoDifferentialOperator-2391"><span class="linenos">2391</span></a><span class="sd">        xlim, ylim : tuple of float</span>
</span><span id="PseudoDifferentialOperator-2392"><a href="#PseudoDifferentialOperator-2392"><span class="linenos">2392</span></a><span class="sd">            Spatial domain limits along x and y axes respectively.</span>
</span><span id="PseudoDifferentialOperator-2393"><a href="#PseudoDifferentialOperator-2393"><span class="linenos">2393</span></a><span class="sd">        xi_range, eta_range : tuple</span>
</span><span id="PseudoDifferentialOperator-2394"><a href="#PseudoDifferentialOperator-2394"><span class="linenos">2394</span></a><span class="sd">            Frequency domain limits along ξ and η axes respectively.</span>
</span><span id="PseudoDifferentialOperator-2395"><a href="#PseudoDifferentialOperator-2395"><span class="linenos">2395</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator-2396"><a href="#PseudoDifferentialOperator-2396"><span class="linenos">2396</span></a><span class="sd">            Number of points per axis used to construct the evaluation grid. Controls resolution.</span>
</span><span id="PseudoDifferentialOperator-2397"><a href="#PseudoDifferentialOperator-2397"><span class="linenos">2397</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2398"><a href="#PseudoDifferentialOperator-2398"><span class="linenos">2398</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator-2399"><a href="#PseudoDifferentialOperator-2399"><span class="linenos">2399</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator-2400"><a href="#PseudoDifferentialOperator-2400"><span class="linenos">2400</span></a><span class="sd">        - In 1D mode, sliders control the fixed frequency (ξ₀) and spatial position (x₀).</span>
</span><span id="PseudoDifferentialOperator-2401"><a href="#PseudoDifferentialOperator-2401"><span class="linenos">2401</span></a><span class="sd">        - In 2D mode, additional sliders control the second frequency component (η₀) and second spatial coordinate (y₀).</span>
</span><span id="PseudoDifferentialOperator-2402"><a href="#PseudoDifferentialOperator-2402"><span class="linenos">2402</span></a><span class="sd">        - Visualization updates dynamically as parameters are adjusted via sliders or dropdown menus.</span>
</span><span id="PseudoDifferentialOperator-2403"><a href="#PseudoDifferentialOperator-2403"><span class="linenos">2403</span></a><span class="sd">        - Supported visualization modes:</span>
</span><span id="PseudoDifferentialOperator-2404"><a href="#PseudoDifferentialOperator-2404"><span class="linenos">2404</span></a><span class="sd">            &#39;Symbol Amplitude&#39;           : |p(x,ξ)| or |p(x,y,ξ,η)|</span>
</span><span id="PseudoDifferentialOperator-2405"><a href="#PseudoDifferentialOperator-2405"><span class="linenos">2405</span></a><span class="sd">            &#39;Symbol Phase&#39;               : arg(p(x,ξ)) or similar in 2D</span>
</span><span id="PseudoDifferentialOperator-2406"><a href="#PseudoDifferentialOperator-2406"><span class="linenos">2406</span></a><span class="sd">            &#39;Micro-Support (1/|p|)&#39;      : Reciprocal of symbol magnitude</span>
</span><span id="PseudoDifferentialOperator-2407"><a href="#PseudoDifferentialOperator-2407"><span class="linenos">2407</span></a><span class="sd">            &#39;Cotangent Fiber&#39;            : Structure of symbol over frequency space at fixed x</span>
</span><span id="PseudoDifferentialOperator-2408"><a href="#PseudoDifferentialOperator-2408"><span class="linenos">2408</span></a><span class="sd">            &#39;Characteristic Set&#39;         : Zero set approximation {p ≈ 0}</span>
</span><span id="PseudoDifferentialOperator-2409"><a href="#PseudoDifferentialOperator-2409"><span class="linenos">2409</span></a><span class="sd">            &#39;Characteristic Gradient&#39;    : |∇p(x, ξ)| or |∇p(x₀, y₀, ξ, η)|</span>
</span><span id="PseudoDifferentialOperator-2410"><a href="#PseudoDifferentialOperator-2410"><span class="linenos">2410</span></a><span class="sd">            &#39;Group Velocity Field&#39;       : ∇_ξ p(x,ξ) or ∇_{ξ,η} p(x,y,ξ,η)</span>
</span><span id="PseudoDifferentialOperator-2411"><a href="#PseudoDifferentialOperator-2411"><span class="linenos">2411</span></a><span class="sd">            &#39;Symplectic Vector Field&#39;    : (∇_ξ p, -∇_x p) or similar in 2D</span>
</span><span id="PseudoDifferentialOperator-2412"><a href="#PseudoDifferentialOperator-2412"><span class="linenos">2412</span></a><span class="sd">            &#39;Hamiltonian Flow&#39;           : Trajectories generated by the Hamiltonian vector field</span>
</span><span id="PseudoDifferentialOperator-2413"><a href="#PseudoDifferentialOperator-2413"><span class="linenos">2413</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2414"><a href="#PseudoDifferentialOperator-2414"><span class="linenos">2414</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator-2415"><a href="#PseudoDifferentialOperator-2415"><span class="linenos">2415</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-2416"><a href="#PseudoDifferentialOperator-2416"><span class="linenos">2416</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator-2417"><a href="#PseudoDifferentialOperator-2417"><span class="linenos">2417</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator-2418"><a href="#PseudoDifferentialOperator-2418"><span class="linenos">2418</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator-2419"><a href="#PseudoDifferentialOperator-2419"><span class="linenos">2419</span></a><span class="sd">        Prints</span>
</span><span id="PseudoDifferentialOperator-2420"><a href="#PseudoDifferentialOperator-2420"><span class="linenos">2420</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator-2421"><a href="#PseudoDifferentialOperator-2421"><span class="linenos">2421</span></a><span class="sd">        Interactive matplotlib figures with dynamic updates based on widget inputs.</span>
</span><span id="PseudoDifferentialOperator-2422"><a href="#PseudoDifferentialOperator-2422"><span class="linenos">2422</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator-2423"><a href="#PseudoDifferentialOperator-2423"><span class="linenos">2423</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="n">pseudo_op</span><span class="o">.</span><span class="n">dim</span>
</span><span id="PseudoDifferentialOperator-2424"><a href="#PseudoDifferentialOperator-2424"><span class="linenos">2424</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">pseudo_op</span><span class="o">.</span><span class="n">expr</span>
</span><span id="PseudoDifferentialOperator-2425"><a href="#PseudoDifferentialOperator-2425"><span class="linenos">2425</span></a>        <span class="n">vars_x</span> <span class="o">=</span> <span class="n">pseudo_op</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2426"><a href="#PseudoDifferentialOperator-2426"><span class="linenos">2426</span></a>    
</span><span id="PseudoDifferentialOperator-2427"><a href="#PseudoDifferentialOperator-2427"><span class="linenos">2427</span></a>        <span class="n">mode_selector_1D</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-2428"><a href="#PseudoDifferentialOperator-2428"><span class="linenos">2428</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="PseudoDifferentialOperator-2429"><a href="#PseudoDifferentialOperator-2429"><span class="linenos">2429</span></a>                <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2430"><a href="#PseudoDifferentialOperator-2430"><span class="linenos">2430</span></a>                <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2431"><a href="#PseudoDifferentialOperator-2431"><span class="linenos">2431</span></a>                <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2432"><a href="#PseudoDifferentialOperator-2432"><span class="linenos">2432</span></a>                <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2433"><a href="#PseudoDifferentialOperator-2433"><span class="linenos">2433</span></a>                <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2434"><a href="#PseudoDifferentialOperator-2434"><span class="linenos">2434</span></a>                <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2435"><a href="#PseudoDifferentialOperator-2435"><span class="linenos">2435</span></a>                <span class="s1">&#39;Group Velocity Field&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2436"><a href="#PseudoDifferentialOperator-2436"><span class="linenos">2436</span></a>                <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2437"><a href="#PseudoDifferentialOperator-2437"><span class="linenos">2437</span></a>                <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2438"><a href="#PseudoDifferentialOperator-2438"><span class="linenos">2438</span></a>            <span class="p">],</span>
</span><span id="PseudoDifferentialOperator-2439"><a href="#PseudoDifferentialOperator-2439"><span class="linenos">2439</span></a>            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2440"><a href="#PseudoDifferentialOperator-2440"><span class="linenos">2440</span></a>            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Mode:&#39;</span>
</span><span id="PseudoDifferentialOperator-2441"><a href="#PseudoDifferentialOperator-2441"><span class="linenos">2441</span></a>        <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2442"><a href="#PseudoDifferentialOperator-2442"><span class="linenos">2442</span></a>
</span><span id="PseudoDifferentialOperator-2443"><a href="#PseudoDifferentialOperator-2443"><span class="linenos">2443</span></a>        <span class="n">mode_selector_2D</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator-2444"><a href="#PseudoDifferentialOperator-2444"><span class="linenos">2444</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="PseudoDifferentialOperator-2445"><a href="#PseudoDifferentialOperator-2445"><span class="linenos">2445</span></a>                <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2446"><a href="#PseudoDifferentialOperator-2446"><span class="linenos">2446</span></a>                <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2447"><a href="#PseudoDifferentialOperator-2447"><span class="linenos">2447</span></a>                <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2448"><a href="#PseudoDifferentialOperator-2448"><span class="linenos">2448</span></a>                <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2449"><a href="#PseudoDifferentialOperator-2449"><span class="linenos">2449</span></a>                <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2450"><a href="#PseudoDifferentialOperator-2450"><span class="linenos">2450</span></a>                <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2451"><a href="#PseudoDifferentialOperator-2451"><span class="linenos">2451</span></a>                <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2452"><a href="#PseudoDifferentialOperator-2452"><span class="linenos">2452</span></a>                <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2453"><a href="#PseudoDifferentialOperator-2453"><span class="linenos">2453</span></a>            <span class="p">],</span>
</span><span id="PseudoDifferentialOperator-2454"><a href="#PseudoDifferentialOperator-2454"><span class="linenos">2454</span></a>            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2455"><a href="#PseudoDifferentialOperator-2455"><span class="linenos">2455</span></a>            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Mode:&#39;</span>
</span><span id="PseudoDifferentialOperator-2456"><a href="#PseudoDifferentialOperator-2456"><span class="linenos">2456</span></a>        <span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2457"><a href="#PseudoDifferentialOperator-2457"><span class="linenos">2457</span></a>    
</span><span id="PseudoDifferentialOperator-2458"><a href="#PseudoDifferentialOperator-2458"><span class="linenos">2458</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2459"><a href="#PseudoDifferentialOperator-2459"><span class="linenos">2459</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2460"><a href="#PseudoDifferentialOperator-2460"><span class="linenos">2460</span></a>            <span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2461"><a href="#PseudoDifferentialOperator-2461"><span class="linenos">2461</span></a>    
</span><span id="PseudoDifferentialOperator-2462"><a href="#PseudoDifferentialOperator-2462"><span class="linenos">2462</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2463"><a href="#PseudoDifferentialOperator-2463"><span class="linenos">2463</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2464"><a href="#PseudoDifferentialOperator-2464"><span class="linenos">2464</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2465"><a href="#PseudoDifferentialOperator-2465"><span class="linenos">2465</span></a>            <span class="n">grad_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2466"><a href="#PseudoDifferentialOperator-2466"><span class="linenos">2466</span></a>            <span class="n">symplectic_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="p">[</span><span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">x</span><span class="p">)],</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2467"><a href="#PseudoDifferentialOperator-2467"><span class="linenos">2467</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2468"><a href="#PseudoDifferentialOperator-2468"><span class="linenos">2468</span></a>
</span><span id="PseudoDifferentialOperator-2469"><a href="#PseudoDifferentialOperator-2469"><span class="linenos">2469</span></a>            <span class="n">xi_slider</span> <span class="o">=</span> <span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;ξ₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2470"><a href="#PseudoDifferentialOperator-2470"><span class="linenos">2470</span></a>            <span class="n">x_slider</span> <span class="o">=</span> <span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;x₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2471"><a href="#PseudoDifferentialOperator-2471"><span class="linenos">2471</span></a>    
</span><span id="PseudoDifferentialOperator-2472"><a href="#PseudoDifferentialOperator-2472"><span class="linenos">2472</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">plot_1d</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2473"><a href="#PseudoDifferentialOperator-2473"><span class="linenos">2473</span></a>                <span class="n">X</span> <span class="o">=</span> <span class="n">x_vals</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2474"><a href="#PseudoDifferentialOperator-2474"><span class="linenos">2474</span></a>    
</span><span id="PseudoDifferentialOperator-2475"><a href="#PseudoDifferentialOperator-2475"><span class="linenos">2475</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Group Velocity Field&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2476"><a href="#PseudoDifferentialOperator-2476"><span class="linenos">2476</span></a>                    <span class="n">V</span> <span class="o">=</span> <span class="n">grad_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2477"><a href="#PseudoDifferentialOperator-2477"><span class="linenos">2477</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2478"><a href="#PseudoDifferentialOperator-2478"><span class="linenos">2478</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2479"><a href="#PseudoDifferentialOperator-2479"><span class="linenos">2479</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Group Velocity Field at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2480"><a href="#PseudoDifferentialOperator-2480"><span class="linenos">2480</span></a>    
</span><span id="PseudoDifferentialOperator-2481"><a href="#PseudoDifferentialOperator-2481"><span class="linenos">2481</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2482"><a href="#PseudoDifferentialOperator-2482"><span class="linenos">2482</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2483"><a href="#PseudoDifferentialOperator-2483"><span class="linenos">2483</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2484"><a href="#PseudoDifferentialOperator-2484"><span class="linenos">2484</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2485"><a href="#PseudoDifferentialOperator-2485"><span class="linenos">2485</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Micro-Support (1/|p|) at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2486"><a href="#PseudoDifferentialOperator-2486"><span class="linenos">2486</span></a>    
</span><span id="PseudoDifferentialOperator-2487"><a href="#PseudoDifferentialOperator-2487"><span class="linenos">2487</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2488"><a href="#PseudoDifferentialOperator-2488"><span class="linenos">2488</span></a>                    <span class="n">U</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">symplectic_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2489"><a href="#PseudoDifferentialOperator-2489"><span class="linenos">2489</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2490"><a href="#PseudoDifferentialOperator-2490"><span class="linenos">2490</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2491"><a href="#PseudoDifferentialOperator-2491"><span class="linenos">2491</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symplectic Field at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2492"><a href="#PseudoDifferentialOperator-2492"><span class="linenos">2492</span></a>    
</span><span id="PseudoDifferentialOperator-2493"><a href="#PseudoDifferentialOperator-2493"><span class="linenos">2493</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2494"><a href="#PseudoDifferentialOperator-2494"><span class="linenos">2494</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2495"><a href="#PseudoDifferentialOperator-2495"><span class="linenos">2495</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2496"><a href="#PseudoDifferentialOperator-2496"><span class="linenos">2496</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2497"><a href="#PseudoDifferentialOperator-2497"><span class="linenos">2497</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Amplitude |p(x,ξ)| at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2498"><a href="#PseudoDifferentialOperator-2498"><span class="linenos">2498</span></a>    
</span><span id="PseudoDifferentialOperator-2499"><a href="#PseudoDifferentialOperator-2499"><span class="linenos">2499</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2500"><a href="#PseudoDifferentialOperator-2500"><span class="linenos">2500</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2501"><a href="#PseudoDifferentialOperator-2501"><span class="linenos">2501</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2502"><a href="#PseudoDifferentialOperator-2502"><span class="linenos">2502</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2503"><a href="#PseudoDifferentialOperator-2503"><span class="linenos">2503</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Phase arg(p(x,ξ)) at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2504"><a href="#PseudoDifferentialOperator-2504"><span class="linenos">2504</span></a>    
</span><span id="PseudoDifferentialOperator-2505"><a href="#PseudoDifferentialOperator-2505"><span class="linenos">2505</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2506"><a href="#PseudoDifferentialOperator-2506"><span class="linenos">2506</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_fiber</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2507"><a href="#PseudoDifferentialOperator-2507"><span class="linenos">2507</span></a>    
</span><span id="PseudoDifferentialOperator-2508"><a href="#PseudoDifferentialOperator-2508"><span class="linenos">2508</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2509"><a href="#PseudoDifferentialOperator-2509"><span class="linenos">2509</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_set</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2510"><a href="#PseudoDifferentialOperator-2510"><span class="linenos">2510</span></a>    
</span><span id="PseudoDifferentialOperator-2511"><a href="#PseudoDifferentialOperator-2511"><span class="linenos">2511</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2512"><a href="#PseudoDifferentialOperator-2512"><span class="linenos">2512</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_gradient</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2513"><a href="#PseudoDifferentialOperator-2513"><span class="linenos">2513</span></a>    
</span><span id="PseudoDifferentialOperator-2514"><a href="#PseudoDifferentialOperator-2514"><span class="linenos">2514</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2515"><a href="#PseudoDifferentialOperator-2515"><span class="linenos">2515</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">plot_hamiltonian_flow</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2516"><a href="#PseudoDifferentialOperator-2516"><span class="linenos">2516</span></a>    
</span><span id="PseudoDifferentialOperator-2517"><a href="#PseudoDifferentialOperator-2517"><span class="linenos">2517</span></a>            <span class="c1"># --- Dynamic container for sliders ---</span>
</span><span id="PseudoDifferentialOperator-2518"><a href="#PseudoDifferentialOperator-2518"><span class="linenos">2518</span></a>            <span class="n">controls_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">mode_selector_1D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2519"><a href="#PseudoDifferentialOperator-2519"><span class="linenos">2519</span></a>            <span class="c1"># --- Function to adjust visible sliders based on mode ---</span>
</span><span id="PseudoDifferentialOperator-2520"><a href="#PseudoDifferentialOperator-2520"><span class="linenos">2520</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">update_controls</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2521"><a href="#PseudoDifferentialOperator-2521"><span class="linenos">2521</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2522"><a href="#PseudoDifferentialOperator-2522"><span class="linenos">2522</span></a>                <span class="c1"># modes that depend only on xi and eta</span>
</span><span id="PseudoDifferentialOperator-2523"><a href="#PseudoDifferentialOperator-2523"><span class="linenos">2523</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator-2524"><a href="#PseudoDifferentialOperator-2524"><span class="linenos">2524</span></a>                            <span class="s1">&#39;Group Velocity Field&#39;</span><span class="p">,</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator-2525"><a href="#PseudoDifferentialOperator-2525"><span class="linenos">2525</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_1D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2526"><a href="#PseudoDifferentialOperator-2526"><span class="linenos">2526</span></a>                <span class="c1"># modes that require xi and x</span>
</span><span id="PseudoDifferentialOperator-2527"><a href="#PseudoDifferentialOperator-2527"><span class="linenos">2527</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator-2528"><a href="#PseudoDifferentialOperator-2528"><span class="linenos">2528</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_1D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2529"><a href="#PseudoDifferentialOperator-2529"><span class="linenos">2529</span></a>                <span class="c1"># modes that require nothing</span>
</span><span id="PseudoDifferentialOperator-2530"><a href="#PseudoDifferentialOperator-2530"><span class="linenos">2530</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator-2531"><a href="#PseudoDifferentialOperator-2531"><span class="linenos">2531</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_1D</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2532"><a href="#PseudoDifferentialOperator-2532"><span class="linenos">2532</span></a>            <span class="n">mode_selector_1D</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_controls</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2533"><a href="#PseudoDifferentialOperator-2533"><span class="linenos">2533</span></a>            <span class="n">update_controls</span><span class="p">({</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="n">mode_selector_1D</span><span class="o">.</span><span class="n">value</span><span class="p">})</span> 
</span><span id="PseudoDifferentialOperator-2534"><a href="#PseudoDifferentialOperator-2534"><span class="linenos">2534</span></a>            <span class="c1"># --- Interactive binding ---</span>
</span><span id="PseudoDifferentialOperator-2535"><a href="#PseudoDifferentialOperator-2535"><span class="linenos">2535</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode_selector_1D</span><span class="p">,</span> <span class="s1">&#39;xi0&#39;</span><span class="p">:</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">x_slider</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator-2536"><a href="#PseudoDifferentialOperator-2536"><span class="linenos">2536</span></a>            <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">controls_box</span><span class="p">,</span> <span class="n">out</span><span class="p">]))</span>
</span><span id="PseudoDifferentialOperator-2537"><a href="#PseudoDifferentialOperator-2537"><span class="linenos">2537</span></a>
</span><span id="PseudoDifferentialOperator-2538"><a href="#PseudoDifferentialOperator-2538"><span class="linenos">2538</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2539"><a href="#PseudoDifferentialOperator-2539"><span class="linenos">2539</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator-2540"><a href="#PseudoDifferentialOperator-2540"><span class="linenos">2540</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2541"><a href="#PseudoDifferentialOperator-2541"><span class="linenos">2541</span></a>            <span class="n">symplectic_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="p">[</span><span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">eta</span><span class="p">)],</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2542"><a href="#PseudoDifferentialOperator-2542"><span class="linenos">2542</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2543"><a href="#PseudoDifferentialOperator-2543"><span class="linenos">2543</span></a>
</span><span id="PseudoDifferentialOperator-2544"><a href="#PseudoDifferentialOperator-2544"><span class="linenos">2544</span></a>            <span class="n">xi_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;ξ₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2545"><a href="#PseudoDifferentialOperator-2545"><span class="linenos">2545</span></a>            <span class="n">eta_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;η₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2546"><a href="#PseudoDifferentialOperator-2546"><span class="linenos">2546</span></a>            <span class="n">x_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;x₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2547"><a href="#PseudoDifferentialOperator-2547"><span class="linenos">2547</span></a>            <span class="n">y_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;y₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2548"><a href="#PseudoDifferentialOperator-2548"><span class="linenos">2548</span></a>    
</span><span id="PseudoDifferentialOperator-2549"><a href="#PseudoDifferentialOperator-2549"><span class="linenos">2549</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">plot_2d</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2550"><a href="#PseudoDifferentialOperator-2550"><span class="linenos">2550</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2551"><a href="#PseudoDifferentialOperator-2551"><span class="linenos">2551</span></a>    
</span><span id="PseudoDifferentialOperator-2552"><a href="#PseudoDifferentialOperator-2552"><span class="linenos">2552</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2553"><a href="#PseudoDifferentialOperator-2553"><span class="linenos">2553</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2554"><a href="#PseudoDifferentialOperator-2554"><span class="linenos">2554</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2555"><a href="#PseudoDifferentialOperator-2555"><span class="linenos">2555</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;1/|p|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2556"><a href="#PseudoDifferentialOperator-2556"><span class="linenos">2556</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2557"><a href="#PseudoDifferentialOperator-2557"><span class="linenos">2557</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2558"><a href="#PseudoDifferentialOperator-2558"><span class="linenos">2558</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Micro-Support at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2559"><a href="#PseudoDifferentialOperator-2559"><span class="linenos">2559</span></a>    
</span><span id="PseudoDifferentialOperator-2560"><a href="#PseudoDifferentialOperator-2560"><span class="linenos">2560</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2561"><a href="#PseudoDifferentialOperator-2561"><span class="linenos">2561</span></a>                    <span class="n">U</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">symplectic_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2562"><a href="#PseudoDifferentialOperator-2562"><span class="linenos">2562</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2563"><a href="#PseudoDifferentialOperator-2563"><span class="linenos">2563</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2564"><a href="#PseudoDifferentialOperator-2564"><span class="linenos">2564</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2565"><a href="#PseudoDifferentialOperator-2565"><span class="linenos">2565</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symplectic Field at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2566"><a href="#PseudoDifferentialOperator-2566"><span class="linenos">2566</span></a>    
</span><span id="PseudoDifferentialOperator-2567"><a href="#PseudoDifferentialOperator-2567"><span class="linenos">2567</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2568"><a href="#PseudoDifferentialOperator-2568"><span class="linenos">2568</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2569"><a href="#PseudoDifferentialOperator-2569"><span class="linenos">2569</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2570"><a href="#PseudoDifferentialOperator-2570"><span class="linenos">2570</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|p(x,y,ξ,η)|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2571"><a href="#PseudoDifferentialOperator-2571"><span class="linenos">2571</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2572"><a href="#PseudoDifferentialOperator-2572"><span class="linenos">2572</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2573"><a href="#PseudoDifferentialOperator-2573"><span class="linenos">2573</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Amplitude at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2574"><a href="#PseudoDifferentialOperator-2574"><span class="linenos">2574</span></a>    
</span><span id="PseudoDifferentialOperator-2575"><a href="#PseudoDifferentialOperator-2575"><span class="linenos">2575</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2576"><a href="#PseudoDifferentialOperator-2576"><span class="linenos">2576</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator-2577"><a href="#PseudoDifferentialOperator-2577"><span class="linenos">2577</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;twilight&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2578"><a href="#PseudoDifferentialOperator-2578"><span class="linenos">2578</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;arg(p)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2579"><a href="#PseudoDifferentialOperator-2579"><span class="linenos">2579</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2580"><a href="#PseudoDifferentialOperator-2580"><span class="linenos">2580</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2581"><a href="#PseudoDifferentialOperator-2581"><span class="linenos">2581</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Phase at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2582"><a href="#PseudoDifferentialOperator-2582"><span class="linenos">2582</span></a>    
</span><span id="PseudoDifferentialOperator-2583"><a href="#PseudoDifferentialOperator-2583"><span class="linenos">2583</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2584"><a href="#PseudoDifferentialOperator-2584"><span class="linenos">2584</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_fiber</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">eta_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2585"><a href="#PseudoDifferentialOperator-2585"><span class="linenos">2585</span></a>                                              <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2586"><a href="#PseudoDifferentialOperator-2586"><span class="linenos">2586</span></a>    
</span><span id="PseudoDifferentialOperator-2587"><a href="#PseudoDifferentialOperator-2587"><span class="linenos">2587</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2588"><a href="#PseudoDifferentialOperator-2588"><span class="linenos">2588</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_set</span><span class="p">(</span><span class="n">x_grid</span><span class="o">=</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2589"><a href="#PseudoDifferentialOperator-2589"><span class="linenos">2589</span></a>                                                  <span class="n">y_grid</span><span class="o">=</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">eta_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2590"><a href="#PseudoDifferentialOperator-2590"><span class="linenos">2590</span></a>    
</span><span id="PseudoDifferentialOperator-2591"><a href="#PseudoDifferentialOperator-2591"><span class="linenos">2591</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2592"><a href="#PseudoDifferentialOperator-2592"><span class="linenos">2592</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_gradient</span><span class="p">(</span><span class="n">x_grid</span><span class="o">=</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator-2593"><a href="#PseudoDifferentialOperator-2593"><span class="linenos">2593</span></a>                                                  <span class="n">y_grid</span><span class="o">=</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">eta_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2594"><a href="#PseudoDifferentialOperator-2594"><span class="linenos">2594</span></a>    
</span><span id="PseudoDifferentialOperator-2595"><a href="#PseudoDifferentialOperator-2595"><span class="linenos">2595</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator-2596"><a href="#PseudoDifferentialOperator-2596"><span class="linenos">2596</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">plot_hamiltonian_flow</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2597"><a href="#PseudoDifferentialOperator-2597"><span class="linenos">2597</span></a>                    
</span><span id="PseudoDifferentialOperator-2598"><a href="#PseudoDifferentialOperator-2598"><span class="linenos">2598</span></a>            <span class="c1"># --- Dynamic container for sliders ---</span>
</span><span id="PseudoDifferentialOperator-2599"><a href="#PseudoDifferentialOperator-2599"><span class="linenos">2599</span></a>            <span class="n">controls_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">eta_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">,</span> <span class="n">y_slider</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator-2600"><a href="#PseudoDifferentialOperator-2600"><span class="linenos">2600</span></a>            <span class="c1"># --- Function to adjust visible sliders based on mode ---</span>
</span><span id="PseudoDifferentialOperator-2601"><a href="#PseudoDifferentialOperator-2601"><span class="linenos">2601</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">update_controls</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator-2602"><a href="#PseudoDifferentialOperator-2602"><span class="linenos">2602</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2603"><a href="#PseudoDifferentialOperator-2603"><span class="linenos">2603</span></a>                <span class="c1"># modes that depend only on xi</span>
</span><span id="PseudoDifferentialOperator-2604"><a href="#PseudoDifferentialOperator-2604"><span class="linenos">2604</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator-2605"><a href="#PseudoDifferentialOperator-2605"><span class="linenos">2605</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">eta_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2606"><a href="#PseudoDifferentialOperator-2606"><span class="linenos">2606</span></a>                <span class="c1"># modes that require xi, eta, x and y</span>
</span><span id="PseudoDifferentialOperator-2607"><a href="#PseudoDifferentialOperator-2607"><span class="linenos">2607</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator-2608"><a href="#PseudoDifferentialOperator-2608"><span class="linenos">2608</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">eta_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">,</span> <span class="n">y_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2609"><a href="#PseudoDifferentialOperator-2609"><span class="linenos">2609</span></a>                <span class="c1"># modes that require x and y</span>
</span><span id="PseudoDifferentialOperator-2610"><a href="#PseudoDifferentialOperator-2610"><span class="linenos">2610</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator-2611"><a href="#PseudoDifferentialOperator-2611"><span class="linenos">2611</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">,</span> <span class="n">y_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator-2612"><a href="#PseudoDifferentialOperator-2612"><span class="linenos">2612</span></a>            <span class="n">mode_selector_2D</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_controls</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator-2613"><a href="#PseudoDifferentialOperator-2613"><span class="linenos">2613</span></a>            <span class="n">update_controls</span><span class="p">({</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="n">mode_selector_2D</span><span class="o">.</span><span class="n">value</span><span class="p">})</span> 
</span><span id="PseudoDifferentialOperator-2614"><a href="#PseudoDifferentialOperator-2614"><span class="linenos">2614</span></a>            <span class="c1"># --- Interactive binding ---</span>
</span><span id="PseudoDifferentialOperator-2615"><a href="#PseudoDifferentialOperator-2615"><span class="linenos">2615</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_2d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode_selector_2D</span><span class="p">,</span> <span class="s1">&#39;xi0&#39;</span><span class="p">:</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="s1">&#39;eta0&#39;</span><span class="p">:</span> <span class="n">eta_slider</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">x_slider</span><span class="p">,</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">y_slider</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator-2616"><a href="#PseudoDifferentialOperator-2616"><span class="linenos">2616</span></a>            <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">controls_box</span><span class="p">,</span> <span class="n">out</span><span class="p">]))</span>
</span></pre></div>


            <div class="docstring"><p>Pseudo-differential operator with dynamic symbol evaluation on spatial grids.
Supports both 1D and 2D operators, and can be defined explicitly (symbol mode)
or extracted automatically from symbolic equations (auto mode).</p>

<h2 id="parameters">Parameters</h2>

<p>expr : sympy expression
    Symbolic expression representing the pseudo-differential symbol.
vars_x : list of sympy symbols
    Spatial variables (e.g., [x] for 1D, [x, y] for 2D).
var_u : sympy function, optional
    Function u(x, t) used in auto mode to extract the operator symbol.
mode : str, {'symbol', 'auto'}
    - 'symbol': directly uses expr as the operator symbol.
    - 'auto': computes the symbol automatically by applying expr to exp(i x ξ).</p>

<h2 id="attributes">Attributes</h2>

<p>dim : int
    Spatial dimension (1 or 2).
fft, ifft : callable
    Fast Fourier transform and inverse (scipy.fft or scipy.fft2).
p_func : callable
    Evaluated symbol function ready for numerical use.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 'symbol' mode, <code><a href="#PseudoDifferentialOperator.expr">expr</a></code> should be expressed in terms of spatial variables and frequency variables (ξ, η).</li>
<li>In 'auto' mode, the symbol is derived by applying the differential expression to a complex exponential.</li>
<li>Frequency variables are internally named 'xi' and 'eta' for consistency.</li>
<li>Uses numpy for numerical evaluation and scipy.fft for FFT operations.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Example 1: 1D Laplacian operator (symbol mode)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">symbols</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">vars_x</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Example 2: 1D transport operator (auto mode)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Function</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">vars_x</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">var_u</span><span class="o">=</span><span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</code></pre>
</div>
</div>


                            <div id="PseudoDifferentialOperator.__init__" class="classattr">
                                        <input id="PseudoDifferentialOperator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PseudoDifferentialOperator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">expr</span>, </span><span class="param"><span class="n">vars_x</span>, </span><span class="param"><span class="n">var_u</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span></span>)</span>

                <label class="view-source-button" for="PseudoDifferentialOperator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.__init__-73"><a href="#PseudoDifferentialOperator.__init__-73"><span class="linenos"> 73</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">vars_x</span><span class="p">,</span> <span class="n">var_u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.__init__-74"><a href="#PseudoDifferentialOperator.__init__-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-75"><a href="#PseudoDifferentialOperator.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
</span><span id="PseudoDifferentialOperator.__init__-76"><a href="#PseudoDifferentialOperator.__init__-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.__init__-77"><a href="#PseudoDifferentialOperator.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
</span><span id="PseudoDifferentialOperator.__init__-78"><a href="#PseudoDifferentialOperator.__init__-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.__init__-79"><a href="#PseudoDifferentialOperator.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="PseudoDifferentialOperator.__init__-80"><a href="#PseudoDifferentialOperator.__init__-80"><span class="linenos"> 80</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-81"><a href="#PseudoDifferentialOperator.__init__-81"><span class="linenos"> 81</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.__init__-82"><a href="#PseudoDifferentialOperator.__init__-82"><span class="linenos"> 82</span></a>            <span class="n">xi_internal</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-83"><a href="#PseudoDifferentialOperator.__init__-83"><span class="linenos"> 83</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">xi_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-84"><a href="#PseudoDifferentialOperator.__init__-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-85"><a href="#PseudoDifferentialOperator.__init__-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-86"><a href="#PseudoDifferentialOperator.__init__-86"><span class="linenos"> 86</span></a>
</span><span id="PseudoDifferentialOperator.__init__-87"><a href="#PseudoDifferentialOperator.__init__-87"><span class="linenos"> 87</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-88"><a href="#PseudoDifferentialOperator.__init__-88"><span class="linenos"> 88</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-89"><a href="#PseudoDifferentialOperator.__init__-89"><span class="linenos"> 89</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span>
</span><span id="PseudoDifferentialOperator.__init__-90"><a href="#PseudoDifferentialOperator.__init__-90"><span class="linenos"> 90</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-91"><a href="#PseudoDifferentialOperator.__init__-91"><span class="linenos"> 91</span></a>                <span class="k">if</span> <span class="n">var_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-92"><a href="#PseudoDifferentialOperator.__init__-92"><span class="linenos"> 92</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var_u must be provided in mode=&#39;auto&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-93"><a href="#PseudoDifferentialOperator.__init__-93"><span class="linenos"> 93</span></a>                <span class="n">exp_i</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">xi_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-94"><a href="#PseudoDifferentialOperator.__init__-94"><span class="linenos"> 94</span></a>                <span class="n">P_ei</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">var_u</span><span class="p">,</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-95"><a href="#PseudoDifferentialOperator.__init__-95"><span class="linenos"> 95</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">P_ei</span> <span class="o">/</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-96"><a href="#PseudoDifferentialOperator.__init__-96"><span class="linenos"> 96</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-97"><a href="#PseudoDifferentialOperator.__init__-97"><span class="linenos"> 97</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.__init__-98"><a href="#PseudoDifferentialOperator.__init__-98"><span class="linenos"> 98</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">),</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-99"><a href="#PseudoDifferentialOperator.__init__-99"><span class="linenos"> 99</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-100"><a href="#PseudoDifferentialOperator.__init__-100"><span class="linenos">100</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;auto&#39; or &#39;symbol&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-101"><a href="#PseudoDifferentialOperator.__init__-101"><span class="linenos">101</span></a>
</span><span id="PseudoDifferentialOperator.__init__-102"><a href="#PseudoDifferentialOperator.__init__-102"><span class="linenos">102</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-103"><a href="#PseudoDifferentialOperator.__init__-103"><span class="linenos">103</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.__init__-104"><a href="#PseudoDifferentialOperator.__init__-104"><span class="linenos">104</span></a>            <span class="n">xi_internal</span><span class="p">,</span> <span class="n">eta_internal</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-105"><a href="#PseudoDifferentialOperator.__init__-105"><span class="linenos">105</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">xi_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-106"><a href="#PseudoDifferentialOperator.__init__-106"><span class="linenos">106</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">eta_internal</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-107"><a href="#PseudoDifferentialOperator.__init__-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-108"><a href="#PseudoDifferentialOperator.__init__-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-109"><a href="#PseudoDifferentialOperator.__init__-109"><span class="linenos">109</span></a>
</span><span id="PseudoDifferentialOperator.__init__-110"><a href="#PseudoDifferentialOperator.__init__-110"><span class="linenos">110</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-111"><a href="#PseudoDifferentialOperator.__init__-111"><span class="linenos">111</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span>
</span><span id="PseudoDifferentialOperator.__init__-112"><a href="#PseudoDifferentialOperator.__init__-112"><span class="linenos">112</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">,</span> <span class="n">eta_internal</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-113"><a href="#PseudoDifferentialOperator.__init__-113"><span class="linenos">113</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-114"><a href="#PseudoDifferentialOperator.__init__-114"><span class="linenos">114</span></a>                <span class="k">if</span> <span class="n">var_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-115"><a href="#PseudoDifferentialOperator.__init__-115"><span class="linenos">115</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var_u must be provided in mode=&#39;auto&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-116"><a href="#PseudoDifferentialOperator.__init__-116"><span class="linenos">116</span></a>                <span class="n">exp_i</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">xi_internal</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">eta_internal</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.__init__-117"><a href="#PseudoDifferentialOperator.__init__-117"><span class="linenos">117</span></a>                <span class="n">P_ei</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">var_u</span><span class="p">,</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-118"><a href="#PseudoDifferentialOperator.__init__-118"><span class="linenos">118</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">P_ei</span> <span class="o">/</span> <span class="n">exp_i</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-119"><a href="#PseudoDifferentialOperator.__init__-119"><span class="linenos">119</span></a>                <span class="n">symbol</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-120"><a href="#PseudoDifferentialOperator.__init__-120"><span class="linenos">120</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.__init__-121"><a href="#PseudoDifferentialOperator.__init__-121"><span class="linenos">121</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi_internal</span><span class="p">,</span> <span class="n">eta_internal</span><span class="p">),</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-122"><a href="#PseudoDifferentialOperator.__init__-122"><span class="linenos">122</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-123"><a href="#PseudoDifferentialOperator.__init__-123"><span class="linenos">123</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;auto&#39; or &#39;symbol&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-124"><a href="#PseudoDifferentialOperator.__init__-124"><span class="linenos">124</span></a>
</span><span id="PseudoDifferentialOperator.__init__-125"><a href="#PseudoDifferentialOperator.__init__-125"><span class="linenos">125</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-126"><a href="#PseudoDifferentialOperator.__init__-126"><span class="linenos">126</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-127"><a href="#PseudoDifferentialOperator.__init__-127"><span class="linenos">127</span></a>
</span><span id="PseudoDifferentialOperator.__init__-128"><a href="#PseudoDifferentialOperator.__init__-128"><span class="linenos">128</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.__init__-129"><a href="#PseudoDifferentialOperator.__init__-129"><span class="linenos">129</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">symbol = &quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.__init__-130"><a href="#PseudoDifferentialOperator.__init__-130"><span class="linenos">130</span></a>            <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PseudoDifferentialOperator.dim" class="classattr">
                                <div class="attr variable">
            <span class="name">dim</span>

        
    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.dim"></a>
    
    

                            </div>
                            <div id="PseudoDifferentialOperator.mode" class="classattr">
                                <div class="attr variable">
            <span class="name">mode</span>

        
    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.mode"></a>
    
    

                            </div>
                            <div id="PseudoDifferentialOperator.symbol_cached" class="classattr">
                                <div class="attr variable">
            <span class="name">symbol_cached</span>

        
    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.symbol_cached"></a>
    
    

                            </div>
                            <div id="PseudoDifferentialOperator.expr" class="classattr">
                                <div class="attr variable">
            <span class="name">expr</span>

        
    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.expr"></a>
    
    

                            </div>
                            <div id="PseudoDifferentialOperator.vars_x" class="classattr">
                                <div class="attr variable">
            <span class="name">vars_x</span>

        
    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.vars_x"></a>
    
    

                            </div>
                            <div id="PseudoDifferentialOperator.evaluate" class="classattr">
                                        <input id="PseudoDifferentialOperator.evaluate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">Y</span>, </span><span class="param"><span class="n">KX</span>, </span><span class="param"><span class="n">KY</span>, </span><span class="param"><span class="n">cache</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.evaluate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.evaluate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.evaluate-132"><a href="#PseudoDifferentialOperator.evaluate-132"><span class="linenos">132</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.evaluate-133"><a href="#PseudoDifferentialOperator.evaluate-133"><span class="linenos">133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.evaluate-134"><a href="#PseudoDifferentialOperator.evaluate-134"><span class="linenos">134</span></a><span class="sd">        Evaluate the pseudo-differential operator&#39;s symbol on a grid of spatial and frequency coordinates.</span>
</span><span id="PseudoDifferentialOperator.evaluate-135"><a href="#PseudoDifferentialOperator.evaluate-135"><span class="linenos">135</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-136"><a href="#PseudoDifferentialOperator.evaluate-136"><span class="linenos">136</span></a><span class="sd">        The method dynamically selects between 1D and 2D evaluation based on the spatial dimension.</span>
</span><span id="PseudoDifferentialOperator.evaluate-137"><a href="#PseudoDifferentialOperator.evaluate-137"><span class="linenos">137</span></a><span class="sd">        If caching is enabled and a cached symbol exists, it returns the cached result to avoid recomputation.</span>
</span><span id="PseudoDifferentialOperator.evaluate-138"><a href="#PseudoDifferentialOperator.evaluate-138"><span class="linenos">138</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-139"><a href="#PseudoDifferentialOperator.evaluate-139"><span class="linenos">139</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.evaluate-140"><a href="#PseudoDifferentialOperator.evaluate-140"><span class="linenos">140</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.evaluate-141"><a href="#PseudoDifferentialOperator.evaluate-141"><span class="linenos">141</span></a><span class="sd">        X, Y : ndarray</span>
</span><span id="PseudoDifferentialOperator.evaluate-142"><a href="#PseudoDifferentialOperator.evaluate-142"><span class="linenos">142</span></a><span class="sd">            Spatial grid coordinates. In 1D, Y is ignored.</span>
</span><span id="PseudoDifferentialOperator.evaluate-143"><a href="#PseudoDifferentialOperator.evaluate-143"><span class="linenos">143</span></a><span class="sd">        KX, KY : ndarray</span>
</span><span id="PseudoDifferentialOperator.evaluate-144"><a href="#PseudoDifferentialOperator.evaluate-144"><span class="linenos">144</span></a><span class="sd">            Frequency grid coordinates. In 1D, KY is ignored.</span>
</span><span id="PseudoDifferentialOperator.evaluate-145"><a href="#PseudoDifferentialOperator.evaluate-145"><span class="linenos">145</span></a><span class="sd">        cache : bool, default=True</span>
</span><span id="PseudoDifferentialOperator.evaluate-146"><a href="#PseudoDifferentialOperator.evaluate-146"><span class="linenos">146</span></a><span class="sd">            If True, stores the computed symbol for reuse in subsequent calls to avoid redundant computation.</span>
</span><span id="PseudoDifferentialOperator.evaluate-147"><a href="#PseudoDifferentialOperator.evaluate-147"><span class="linenos">147</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-148"><a href="#PseudoDifferentialOperator.evaluate-148"><span class="linenos">148</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.evaluate-149"><a href="#PseudoDifferentialOperator.evaluate-149"><span class="linenos">149</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.evaluate-150"><a href="#PseudoDifferentialOperator.evaluate-150"><span class="linenos">150</span></a><span class="sd">        ndarray</span>
</span><span id="PseudoDifferentialOperator.evaluate-151"><a href="#PseudoDifferentialOperator.evaluate-151"><span class="linenos">151</span></a><span class="sd">            Evaluated symbol values over the input grid. Shape matches the input spatial/frequency grids.</span>
</span><span id="PseudoDifferentialOperator.evaluate-152"><a href="#PseudoDifferentialOperator.evaluate-152"><span class="linenos">152</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-153"><a href="#PseudoDifferentialOperator.evaluate-153"><span class="linenos">153</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.evaluate-154"><a href="#PseudoDifferentialOperator.evaluate-154"><span class="linenos">154</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.evaluate-155"><a href="#PseudoDifferentialOperator.evaluate-155"><span class="linenos">155</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.evaluate-156"><a href="#PseudoDifferentialOperator.evaluate-156"><span class="linenos">156</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator.evaluate-157"><a href="#PseudoDifferentialOperator.evaluate-157"><span class="linenos">157</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.evaluate-158"><a href="#PseudoDifferentialOperator.evaluate-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.evaluate-159"><a href="#PseudoDifferentialOperator.evaluate-159"><span class="linenos">159</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span>
</span><span id="PseudoDifferentialOperator.evaluate-160"><a href="#PseudoDifferentialOperator.evaluate-160"><span class="linenos">160</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-161"><a href="#PseudoDifferentialOperator.evaluate-161"><span class="linenos">161</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.evaluate-162"><a href="#PseudoDifferentialOperator.evaluate-162"><span class="linenos">162</span></a>            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">KX</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.evaluate-163"><a href="#PseudoDifferentialOperator.evaluate-163"><span class="linenos">163</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.evaluate-164"><a href="#PseudoDifferentialOperator.evaluate-164"><span class="linenos">164</span></a>            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.evaluate-165"><a href="#PseudoDifferentialOperator.evaluate-165"><span class="linenos">165</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-166"><a href="#PseudoDifferentialOperator.evaluate-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.evaluate-167"><a href="#PseudoDifferentialOperator.evaluate-167"><span class="linenos">167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.evaluate-168"><a href="#PseudoDifferentialOperator.evaluate-168"><span class="linenos">168</span></a>
</span><span id="PseudoDifferentialOperator.evaluate-169"><a href="#PseudoDifferentialOperator.evaluate-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="n">symbol</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate the pseudo-differential operator's symbol on a grid of spatial and frequency coordinates.</p>

<p>The method dynamically selects between 1D and 2D evaluation based on the spatial dimension.
If caching is enabled and a cached symbol exists, it returns the cached result to avoid recomputation.</p>

<h2 id="parameters">Parameters</h2>

<p>X, Y : ndarray
    Spatial grid coordinates. In 1D, Y is ignored.
KX, KY : ndarray
    Frequency grid coordinates. In 1D, KY is ignored.
cache : bool, default=True
    If True, stores the computed symbol for reuse in subsequent calls to avoid redundant computation.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Evaluated symbol values over the input grid. Shape matches the input spatial/frequency grids.</p>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If the spatial dimension is not 1D or 2D.</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.clear_cache" class="classattr">
                                        <input id="PseudoDifferentialOperator.clear_cache-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_cache</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.clear_cache-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.clear_cache"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.clear_cache-171"><a href="#PseudoDifferentialOperator.clear_cache-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.clear_cache-172"><a href="#PseudoDifferentialOperator.clear_cache-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.clear_cache-173"><a href="#PseudoDifferentialOperator.clear_cache-173"><span class="linenos">173</span></a><span class="sd">        Clear cached symbol evaluations.</span>
</span><span id="PseudoDifferentialOperator.clear_cache-174"><a href="#PseudoDifferentialOperator.clear_cache-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>        
</span><span id="PseudoDifferentialOperator.clear_cache-175"><a href="#PseudoDifferentialOperator.clear_cache-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cached</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Clear cached symbol evaluations.</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.apply" class="classattr">
                                        <input id="PseudoDifferentialOperator.apply-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u</span>,</span><span class="param">	<span class="n">x_grid</span>,</span><span class="param">	<span class="n">kx</span>,</span><span class="param">	<span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span>,</span><span class="param">	<span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ky</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">dealiasing_mask</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">freq_window</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span>,</span><span class="param">	<span class="n">clamp</span><span class="o">=</span><span class="mf">1000000.0</span>,</span><span class="param">	<span class="n">space_window</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.apply-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.apply"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.apply-177"><a href="#PseudoDifferentialOperator.apply-177"><span class="linenos">177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator.apply-178"><a href="#PseudoDifferentialOperator.apply-178"><span class="linenos">178</span></a>              <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dealiasing_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-179"><a href="#PseudoDifferentialOperator.apply-179"><span class="linenos">179</span></a>              <span class="n">freq_window</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">space_window</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.apply-180"><a href="#PseudoDifferentialOperator.apply-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.apply-181"><a href="#PseudoDifferentialOperator.apply-181"><span class="linenos">181</span></a><span class="sd">        Apply the pseudo-differential operator to the input field u.</span>
</span><span id="PseudoDifferentialOperator.apply-182"><a href="#PseudoDifferentialOperator.apply-182"><span class="linenos">182</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.apply-183"><a href="#PseudoDifferentialOperator.apply-183"><span class="linenos">183</span></a><span class="sd">        This method dispatches the application of the pseudo-differential operator based on:</span>
</span><span id="PseudoDifferentialOperator.apply-184"><a href="#PseudoDifferentialOperator.apply-184"><span class="linenos">184</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.apply-185"><a href="#PseudoDifferentialOperator.apply-185"><span class="linenos">185</span></a><span class="sd">        - Whether the symbol is spatially dependent (x/y)</span>
</span><span id="PseudoDifferentialOperator.apply-186"><a href="#PseudoDifferentialOperator.apply-186"><span class="linenos">186</span></a><span class="sd">        - The boundary condition in use (periodic or dirichlet)</span>
</span><span id="PseudoDifferentialOperator.apply-187"><a href="#PseudoDifferentialOperator.apply-187"><span class="linenos">187</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.apply-188"><a href="#PseudoDifferentialOperator.apply-188"><span class="linenos">188</span></a><span class="sd">        Supported operations:</span>
</span><span id="PseudoDifferentialOperator.apply-189"><a href="#PseudoDifferentialOperator.apply-189"><span class="linenos">189</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.apply-190"><a href="#PseudoDifferentialOperator.apply-190"><span class="linenos">190</span></a><span class="sd">        - Constant-coefficient symbols: applied via Fourier multiplication.</span>
</span><span id="PseudoDifferentialOperator.apply-191"><a href="#PseudoDifferentialOperator.apply-191"><span class="linenos">191</span></a><span class="sd">        - Spatially varying symbols: applied via Kohn–Nirenberg quantization.</span>
</span><span id="PseudoDifferentialOperator.apply-192"><a href="#PseudoDifferentialOperator.apply-192"><span class="linenos">192</span></a><span class="sd">        - Dirichlet boundary conditions: handled with non-periodic convolution-like quantization.</span>
</span><span id="PseudoDifferentialOperator.apply-193"><a href="#PseudoDifferentialOperator.apply-193"><span class="linenos">193</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.apply-194"><a href="#PseudoDifferentialOperator.apply-194"><span class="linenos">194</span></a><span class="sd">        Dispatch Logic:\n</span>
</span><span id="PseudoDifferentialOperator.apply-195"><a href="#PseudoDifferentialOperator.apply-195"><span class="linenos">195</span></a><span class="sd">        if not self.is_spatial: u ↦ Op(p)(D) ⋅ u = 𝓕⁻¹[ p(ξ) ⋅ 𝓕(u) ]\n</span>
</span><span id="PseudoDifferentialOperator.apply-196"><a href="#PseudoDifferentialOperator.apply-196"><span class="linenos">196</span></a><span class="sd">        elif periodic: u ↦ Op(p)(x,D) ⋅ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ based of FFT (quicker)\n</span>
</span><span id="PseudoDifferentialOperator.apply-197"><a href="#PseudoDifferentialOperator.apply-197"><span class="linenos">197</span></a><span class="sd">        elif dirichlet: u ↦ Op(p)(x,D) ⋅ u ≈ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ (slower)\n</span>
</span><span id="PseudoDifferentialOperator.apply-198"><a href="#PseudoDifferentialOperator.apply-198"><span class="linenos">198</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.apply-199"><a href="#PseudoDifferentialOperator.apply-199"><span class="linenos">199</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.apply-200"><a href="#PseudoDifferentialOperator.apply-200"><span class="linenos">200</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.apply-201"><a href="#PseudoDifferentialOperator.apply-201"><span class="linenos">201</span></a><span class="sd">        u : ndarray</span>
</span><span id="PseudoDifferentialOperator.apply-202"><a href="#PseudoDifferentialOperator.apply-202"><span class="linenos">202</span></a><span class="sd">            Function to which the operator is applied</span>
</span><span id="PseudoDifferentialOperator.apply-203"><a href="#PseudoDifferentialOperator.apply-203"><span class="linenos">203</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.apply-204"><a href="#PseudoDifferentialOperator.apply-204"><span class="linenos">204</span></a><span class="sd">            Spatial grid in x direction</span>
</span><span id="PseudoDifferentialOperator.apply-205"><a href="#PseudoDifferentialOperator.apply-205"><span class="linenos">205</span></a><span class="sd">        kx : ndarray</span>
</span><span id="PseudoDifferentialOperator.apply-206"><a href="#PseudoDifferentialOperator.apply-206"><span class="linenos">206</span></a><span class="sd">            Frequency grid in x direction</span>
</span><span id="PseudoDifferentialOperator.apply-207"><a href="#PseudoDifferentialOperator.apply-207"><span class="linenos">207</span></a><span class="sd">        boundary_condition : str</span>
</span><span id="PseudoDifferentialOperator.apply-208"><a href="#PseudoDifferentialOperator.apply-208"><span class="linenos">208</span></a><span class="sd">            &#39;periodic&#39; or &#39;dirichlet&#39;</span>
</span><span id="PseudoDifferentialOperator.apply-209"><a href="#PseudoDifferentialOperator.apply-209"><span class="linenos">209</span></a><span class="sd">        y_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.apply-210"><a href="#PseudoDifferentialOperator.apply-210"><span class="linenos">210</span></a><span class="sd">            Spatial grid in y direction (for 2D)</span>
</span><span id="PseudoDifferentialOperator.apply-211"><a href="#PseudoDifferentialOperator.apply-211"><span class="linenos">211</span></a><span class="sd">        ky : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.apply-212"><a href="#PseudoDifferentialOperator.apply-212"><span class="linenos">212</span></a><span class="sd">            Frequency grid in y direction (for 2D)</span>
</span><span id="PseudoDifferentialOperator.apply-213"><a href="#PseudoDifferentialOperator.apply-213"><span class="linenos">213</span></a><span class="sd">        dealiasing_mask : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.apply-214"><a href="#PseudoDifferentialOperator.apply-214"><span class="linenos">214</span></a><span class="sd">            Dealiasing mask</span>
</span><span id="PseudoDifferentialOperator.apply-215"><a href="#PseudoDifferentialOperator.apply-215"><span class="linenos">215</span></a><span class="sd">        freq_window : str</span>
</span><span id="PseudoDifferentialOperator.apply-216"><a href="#PseudoDifferentialOperator.apply-216"><span class="linenos">216</span></a><span class="sd">            Frequency windowing (&#39;gaussian&#39; or &#39;hann&#39;)</span>
</span><span id="PseudoDifferentialOperator.apply-217"><a href="#PseudoDifferentialOperator.apply-217"><span class="linenos">217</span></a><span class="sd">        clamp : float</span>
</span><span id="PseudoDifferentialOperator.apply-218"><a href="#PseudoDifferentialOperator.apply-218"><span class="linenos">218</span></a><span class="sd">            Clamp symbol values to [-clamp, clamp]</span>
</span><span id="PseudoDifferentialOperator.apply-219"><a href="#PseudoDifferentialOperator.apply-219"><span class="linenos">219</span></a><span class="sd">        space_window : bool</span>
</span><span id="PseudoDifferentialOperator.apply-220"><a href="#PseudoDifferentialOperator.apply-220"><span class="linenos">220</span></a><span class="sd">            Apply spatial windowing</span>
</span><span id="PseudoDifferentialOperator.apply-221"><a href="#PseudoDifferentialOperator.apply-221"><span class="linenos">221</span></a><span class="sd">            </span>
</span><span id="PseudoDifferentialOperator.apply-222"><a href="#PseudoDifferentialOperator.apply-222"><span class="linenos">222</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.apply-223"><a href="#PseudoDifferentialOperator.apply-223"><span class="linenos">223</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.apply-224"><a href="#PseudoDifferentialOperator.apply-224"><span class="linenos">224</span></a><span class="sd">        ndarray</span>
</span><span id="PseudoDifferentialOperator.apply-225"><a href="#PseudoDifferentialOperator.apply-225"><span class="linenos">225</span></a><span class="sd">            Result of applying the operator</span>
</span><span id="PseudoDifferentialOperator.apply-226"><a href="#PseudoDifferentialOperator.apply-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.apply-227"><a href="#PseudoDifferentialOperator.apply-227"><span class="linenos">227</span></a>        <span class="c1"># Check if symbol depends on spatial variables</span>
</span><span id="PseudoDifferentialOperator.apply-228"><a href="#PseudoDifferentialOperator.apply-228"><span class="linenos">228</span></a>        <span class="n">is_spatial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_spatial_dependent</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.apply-229"><a href="#PseudoDifferentialOperator.apply-229"><span class="linenos">229</span></a>        
</span><span id="PseudoDifferentialOperator.apply-230"><a href="#PseudoDifferentialOperator.apply-230"><span class="linenos">230</span></a>        <span class="c1"># Case 1: Constant symbol with periodic BC (fast path)</span>
</span><span id="PseudoDifferentialOperator.apply-231"><a href="#PseudoDifferentialOperator.apply-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_spatial</span> <span class="ow">and</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.apply-232"><a href="#PseudoDifferentialOperator.apply-232"><span class="linenos">232</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_constant_fft</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">dealiasing_mask</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.apply-233"><a href="#PseudoDifferentialOperator.apply-233"><span class="linenos">233</span></a>        
</span><span id="PseudoDifferentialOperator.apply-234"><a href="#PseudoDifferentialOperator.apply-234"><span class="linenos">234</span></a>        <span class="c1"># Case 2: Spatial symbol with periodic BC</span>
</span><span id="PseudoDifferentialOperator.apply-235"><a href="#PseudoDifferentialOperator.apply-235"><span class="linenos">235</span></a>        <span class="k">elif</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.apply-236"><a href="#PseudoDifferentialOperator.apply-236"><span class="linenos">236</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol_func</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.apply-237"><a href="#PseudoDifferentialOperator.apply-237"><span class="linenos">237</span></a>            <span class="k">return</span> <span class="n">kohn_nirenberg_fft</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.apply-238"><a href="#PseudoDifferentialOperator.apply-238"><span class="linenos">238</span></a>                <span class="n">u_vals</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-239"><a href="#PseudoDifferentialOperator.apply-239"><span class="linenos">239</span></a>                <span class="n">symbol_func</span><span class="o">=</span><span class="n">symbol_func</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-240"><a href="#PseudoDifferentialOperator.apply-240"><span class="linenos">240</span></a>                <span class="n">x_grid</span><span class="o">=</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-241"><a href="#PseudoDifferentialOperator.apply-241"><span class="linenos">241</span></a>                <span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-242"><a href="#PseudoDifferentialOperator.apply-242"><span class="linenos">242</span></a>                <span class="n">fft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-243"><a href="#PseudoDifferentialOperator.apply-243"><span class="linenos">243</span></a>                <span class="n">ifft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-244"><a href="#PseudoDifferentialOperator.apply-244"><span class="linenos">244</span></a>                <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-245"><a href="#PseudoDifferentialOperator.apply-245"><span class="linenos">245</span></a>                <span class="n">y_grid</span><span class="o">=</span><span class="n">y_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-246"><a href="#PseudoDifferentialOperator.apply-246"><span class="linenos">246</span></a>                <span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-247"><a href="#PseudoDifferentialOperator.apply-247"><span class="linenos">247</span></a>                <span class="n">freq_window</span><span class="o">=</span><span class="n">freq_window</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-248"><a href="#PseudoDifferentialOperator.apply-248"><span class="linenos">248</span></a>                <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-249"><a href="#PseudoDifferentialOperator.apply-249"><span class="linenos">249</span></a>                <span class="n">space_window</span><span class="o">=</span><span class="n">space_window</span>
</span><span id="PseudoDifferentialOperator.apply-250"><a href="#PseudoDifferentialOperator.apply-250"><span class="linenos">250</span></a>            <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.apply-251"><a href="#PseudoDifferentialOperator.apply-251"><span class="linenos">251</span></a>        
</span><span id="PseudoDifferentialOperator.apply-252"><a href="#PseudoDifferentialOperator.apply-252"><span class="linenos">252</span></a>        <span class="c1"># Case 3: Dirichlet BC (non-periodic)</span>
</span><span id="PseudoDifferentialOperator.apply-253"><a href="#PseudoDifferentialOperator.apply-253"><span class="linenos">253</span></a>        <span class="k">elif</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.apply-254"><a href="#PseudoDifferentialOperator.apply-254"><span class="linenos">254</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol_func</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.apply-255"><a href="#PseudoDifferentialOperator.apply-255"><span class="linenos">255</span></a>            
</span><span id="PseudoDifferentialOperator.apply-256"><a href="#PseudoDifferentialOperator.apply-256"><span class="linenos">256</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.apply-257"><a href="#PseudoDifferentialOperator.apply-257"><span class="linenos">257</span></a>                <span class="k">return</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.apply-258"><a href="#PseudoDifferentialOperator.apply-258"><span class="linenos">258</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-259"><a href="#PseudoDifferentialOperator.apply-259"><span class="linenos">259</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-260"><a href="#PseudoDifferentialOperator.apply-260"><span class="linenos">260</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-261"><a href="#PseudoDifferentialOperator.apply-261"><span class="linenos">261</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">symbol_func</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-262"><a href="#PseudoDifferentialOperator.apply-262"><span class="linenos">262</span></a>                    <span class="n">freq_window</span><span class="o">=</span><span class="n">freq_window</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-263"><a href="#PseudoDifferentialOperator.apply-263"><span class="linenos">263</span></a>                    <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-264"><a href="#PseudoDifferentialOperator.apply-264"><span class="linenos">264</span></a>                    <span class="n">space_window</span><span class="o">=</span><span class="n">space_window</span>
</span><span id="PseudoDifferentialOperator.apply-265"><a href="#PseudoDifferentialOperator.apply-265"><span class="linenos">265</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.apply-266"><a href="#PseudoDifferentialOperator.apply-266"><span class="linenos">266</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.apply-267"><a href="#PseudoDifferentialOperator.apply-267"><span class="linenos">267</span></a>                <span class="k">return</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.apply-268"><a href="#PseudoDifferentialOperator.apply-268"><span class="linenos">268</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-269"><a href="#PseudoDifferentialOperator.apply-269"><span class="linenos">269</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.apply-270"><a href="#PseudoDifferentialOperator.apply-270"><span class="linenos">270</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.apply-271"><a href="#PseudoDifferentialOperator.apply-271"><span class="linenos">271</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">symbol_func</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-272"><a href="#PseudoDifferentialOperator.apply-272"><span class="linenos">272</span></a>                    <span class="n">freq_window</span><span class="o">=</span><span class="n">freq_window</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-273"><a href="#PseudoDifferentialOperator.apply-273"><span class="linenos">273</span></a>                    <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.apply-274"><a href="#PseudoDifferentialOperator.apply-274"><span class="linenos">274</span></a>                    <span class="n">space_window</span><span class="o">=</span><span class="n">space_window</span>
</span><span id="PseudoDifferentialOperator.apply-275"><a href="#PseudoDifferentialOperator.apply-275"><span class="linenos">275</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.apply-276"><a href="#PseudoDifferentialOperator.apply-276"><span class="linenos">276</span></a>        
</span><span id="PseudoDifferentialOperator.apply-277"><a href="#PseudoDifferentialOperator.apply-277"><span class="linenos">277</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.apply-278"><a href="#PseudoDifferentialOperator.apply-278"><span class="linenos">278</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid boundary condition &#39;</span><span class="si">{</span><span class="n">boundary_condition</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply the pseudo-differential operator to the input field u.</p>

<p>This method dispatches the application of the pseudo-differential operator based on:</p>

<ul>
<li>Whether the symbol is spatially dependent (x/y)</li>
<li>The boundary condition in use (periodic or dirichlet)</li>
</ul>

<p>Supported operations:</p>

<ul>
<li>Constant-coefficient symbols: applied via Fourier multiplication.</li>
<li>Spatially varying symbols: applied via Kohn–Nirenberg quantization.</li>
<li>Dirichlet boundary conditions: handled with non-periodic convolution-like quantization.</li>
</ul>

<p>Dispatch Logic:</p>

<p>if not self.is_spatial: u ↦ Op(p)(D) ⋅ u = 𝓕⁻¹[ p(ξ) ⋅ 𝓕(u) ]</p>

<p>elif periodic: u ↦ Op(p)(x,D) ⋅ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ based of FFT (quicker)</p>

<p>elif dirichlet: u ↦ Op(p)(x,D) ⋅ u ≈ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ (slower)</p>

<h2 id="parameters">Parameters</h2>

<p>u : ndarray
    Function to which the operator is applied
x_grid : ndarray
    Spatial grid in x direction
kx : ndarray
    Frequency grid in x direction
boundary_condition : str
    'periodic' or 'dirichlet'
y_grid : ndarray, optional
    Spatial grid in y direction (for 2D)
ky : ndarray, optional
    Frequency grid in y direction (for 2D)
dealiasing_mask : ndarray, optional
    Dealiasing mask
freq_window : str
    Frequency windowing ('gaussian' or 'hann')
clamp : float
    Clamp symbol values to [-clamp, clamp]
space_window : bool
    Apply spatial windowing</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Result of applying the operator</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.principal_symbol" class="classattr">
                                        <input id="PseudoDifferentialOperator.principal_symbol-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">principal_symbol</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.principal_symbol-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.principal_symbol"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.principal_symbol-376"><a href="#PseudoDifferentialOperator.principal_symbol-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">principal_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-377"><a href="#PseudoDifferentialOperator.principal_symbol-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-378"><a href="#PseudoDifferentialOperator.principal_symbol-378"><span class="linenos">378</span></a><span class="sd">        Compute the leading homogeneous component of the pseudo-differential symbol.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-379"><a href="#PseudoDifferentialOperator.principal_symbol-379"><span class="linenos">379</span></a>
</span><span id="PseudoDifferentialOperator.principal_symbol-380"><a href="#PseudoDifferentialOperator.principal_symbol-380"><span class="linenos">380</span></a><span class="sd">        This method extracts the principal part of the symbol, which is the dominant </span>
</span><span id="PseudoDifferentialOperator.principal_symbol-381"><a href="#PseudoDifferentialOperator.principal_symbol-381"><span class="linenos">381</span></a><span class="sd">        term under high-frequency asymptotics (|ξ| → ∞). The expansion is performed </span>
</span><span id="PseudoDifferentialOperator.principal_symbol-382"><a href="#PseudoDifferentialOperator.principal_symbol-382"><span class="linenos">382</span></a><span class="sd">        in polar coordinates for 2D symbols to maintain rotational symmetry, then </span>
</span><span id="PseudoDifferentialOperator.principal_symbol-383"><a href="#PseudoDifferentialOperator.principal_symbol-383"><span class="linenos">383</span></a><span class="sd">        converted back to Cartesian form.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-384"><a href="#PseudoDifferentialOperator.principal_symbol-384"><span class="linenos">384</span></a>
</span><span id="PseudoDifferentialOperator.principal_symbol-385"><a href="#PseudoDifferentialOperator.principal_symbol-385"><span class="linenos">385</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-386"><a href="#PseudoDifferentialOperator.principal_symbol-386"><span class="linenos">386</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-387"><a href="#PseudoDifferentialOperator.principal_symbol-387"><span class="linenos">387</span></a><span class="sd">        order : int</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-388"><a href="#PseudoDifferentialOperator.principal_symbol-388"><span class="linenos">388</span></a><span class="sd">            Order of the asymptotic expansion in powers of 1/ρ, where ρ = |ξ| in 1D </span>
</span><span id="PseudoDifferentialOperator.principal_symbol-389"><a href="#PseudoDifferentialOperator.principal_symbol-389"><span class="linenos">389</span></a><span class="sd">            or ρ = sqrt(ξ² + η²) in 2D. Only the leading-order term is returned.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-390"><a href="#PseudoDifferentialOperator.principal_symbol-390"><span class="linenos">390</span></a>
</span><span id="PseudoDifferentialOperator.principal_symbol-391"><a href="#PseudoDifferentialOperator.principal_symbol-391"><span class="linenos">391</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-392"><a href="#PseudoDifferentialOperator.principal_symbol-392"><span class="linenos">392</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-393"><a href="#PseudoDifferentialOperator.principal_symbol-393"><span class="linenos">393</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-394"><a href="#PseudoDifferentialOperator.principal_symbol-394"><span class="linenos">394</span></a><span class="sd">            The principal symbol component, homogeneous of degree `m - order`, where </span>
</span><span id="PseudoDifferentialOperator.principal_symbol-395"><a href="#PseudoDifferentialOperator.principal_symbol-395"><span class="linenos">395</span></a><span class="sd">            `m` is the original symbol&#39;s order.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-396"><a href="#PseudoDifferentialOperator.principal_symbol-396"><span class="linenos">396</span></a>
</span><span id="PseudoDifferentialOperator.principal_symbol-397"><a href="#PseudoDifferentialOperator.principal_symbol-397"><span class="linenos">397</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-398"><a href="#PseudoDifferentialOperator.principal_symbol-398"><span class="linenos">398</span></a><span class="sd">        - In 1D, uses direct series expansion in ξ.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-399"><a href="#PseudoDifferentialOperator.principal_symbol-399"><span class="linenos">399</span></a><span class="sd">        - In 2D, expands in radial variable ρ while preserving angular dependence.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-400"><a href="#PseudoDifferentialOperator.principal_symbol-400"><span class="linenos">400</span></a><span class="sd">        - Useful for microlocal analysis and constructing parametrices.</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-401"><a href="#PseudoDifferentialOperator.principal_symbol-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-402"><a href="#PseudoDifferentialOperator.principal_symbol-402"><span class="linenos">402</span></a>
</span><span id="PseudoDifferentialOperator.principal_symbol-403"><a href="#PseudoDifferentialOperator.principal_symbol-403"><span class="linenos">403</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-404"><a href="#PseudoDifferentialOperator.principal_symbol-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-405"><a href="#PseudoDifferentialOperator.principal_symbol-405"><span class="linenos">405</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-406"><a href="#PseudoDifferentialOperator.principal_symbol-406"><span class="linenos">406</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">series</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">())</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-407"><a href="#PseudoDifferentialOperator.principal_symbol-407"><span class="linenos">407</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-408"><a href="#PseudoDifferentialOperator.principal_symbol-408"><span class="linenos">408</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-409"><a href="#PseudoDifferentialOperator.principal_symbol-409"><span class="linenos">409</span></a>            <span class="c1"># Homogeneous radial expansion: we set (ξ, η) = ρ (cosθ, sinθ)</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-410"><a href="#PseudoDifferentialOperator.principal_symbol-410"><span class="linenos">410</span></a>            <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;rho theta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-411"><a href="#PseudoDifferentialOperator.principal_symbol-411"><span class="linenos">411</span></a>            <span class="n">p_rho</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">eta</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)})</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-412"><a href="#PseudoDifferentialOperator.principal_symbol-412"><span class="linenos">412</span></a>            <span class="n">expansion</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">p_rho</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-413"><a href="#PseudoDifferentialOperator.principal_symbol-413"><span class="linenos">413</span></a>            <span class="c1"># Revert back to (ξ, η)</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-414"><a href="#PseudoDifferentialOperator.principal_symbol-414"><span class="linenos">414</span></a>            <span class="n">expansion_cart</span> <span class="o">=</span> <span class="n">expansion</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">rho</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-415"><a href="#PseudoDifferentialOperator.principal_symbol-415"><span class="linenos">415</span></a>                                             <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">xi</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-416"><a href="#PseudoDifferentialOperator.principal_symbol-416"><span class="linenos">416</span></a>                                             <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">)})</span>
</span><span id="PseudoDifferentialOperator.principal_symbol-417"><a href="#PseudoDifferentialOperator.principal_symbol-417"><span class="linenos">417</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expansion_cart</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Compute the leading homogeneous component of the pseudo-differential symbol.</p>

<p>This method extracts the principal part of the symbol, which is the dominant 
term under high-frequency asymptotics (|ξ| → ∞). The expansion is performed 
in polar coordinates for 2D symbols to maintain rotational symmetry, then 
converted back to Cartesian form.</p>

<h2 id="parameters">Parameters</h2>

<p>order : int
    Order of the asymptotic expansion in powers of 1/ρ, where ρ = |ξ| in 1D 
    or ρ = sqrt(ξ² + η²) in 2D. Only the leading-order term is returned.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    The principal symbol component, homogeneous of degree <code>m - order</code>, where 
    <code>m</code> is the original symbol's order.</p>

<p>Notes:</p>

<ul>
<li>In 1D, uses direct series expansion in ξ.</li>
<li>In 2D, expands in radial variable ρ while preserving angular dependence.</li>
<li>Useful for microlocal analysis and constructing parametrices.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.is_homogeneous" class="classattr">
                                        <input id="PseudoDifferentialOperator.is_homogeneous-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_homogeneous</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.is_homogeneous-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.is_homogeneous"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.is_homogeneous-419"><a href="#PseudoDifferentialOperator.is_homogeneous-419"><span class="linenos">419</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_homogeneous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-420"><a href="#PseudoDifferentialOperator.is_homogeneous-420"><span class="linenos">420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-421"><a href="#PseudoDifferentialOperator.is_homogeneous-421"><span class="linenos">421</span></a><span class="sd">        Check whether the symbol is homogeneous in the frequency variables.</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-422"><a href="#PseudoDifferentialOperator.is_homogeneous-422"><span class="linenos">422</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-423"><a href="#PseudoDifferentialOperator.is_homogeneous-423"><span class="linenos">423</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-424"><a href="#PseudoDifferentialOperator.is_homogeneous-424"><span class="linenos">424</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-425"><a href="#PseudoDifferentialOperator.is_homogeneous-425"><span class="linenos">425</span></a><span class="sd">        (bool, Rational or float or None)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-426"><a href="#PseudoDifferentialOperator.is_homogeneous-426"><span class="linenos">426</span></a><span class="sd">            Tuple (is_homogeneous, degree) where:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-427"><a href="#PseudoDifferentialOperator.is_homogeneous-427"><span class="linenos">427</span></a><span class="sd">            - is_homogeneous: True if the symbol satisfies p(λξ, λη) = λ^m * p(ξ, η)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-428"><a href="#PseudoDifferentialOperator.is_homogeneous-428"><span class="linenos">428</span></a><span class="sd">            - degree: the detected degree m if homogeneous, or None</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-429"><a href="#PseudoDifferentialOperator.is_homogeneous-429"><span class="linenos">429</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-430"><a href="#PseudoDifferentialOperator.is_homogeneous-430"><span class="linenos">430</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">expand</span><span class="p">,</span> <span class="n">Eq</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-431"><a href="#PseudoDifferentialOperator.is_homogeneous-431"><span class="linenos">431</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-432"><a href="#PseudoDifferentialOperator.is_homogeneous-432"><span class="linenos">432</span></a>    
</span><span id="PseudoDifferentialOperator.is_homogeneous-433"><a href="#PseudoDifferentialOperator.is_homogeneous-433"><span class="linenos">433</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-434"><a href="#PseudoDifferentialOperator.is_homogeneous-434"><span class="linenos">434</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-435"><a href="#PseudoDifferentialOperator.is_homogeneous-435"><span class="linenos">435</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-436"><a href="#PseudoDifferentialOperator.is_homogeneous-436"><span class="linenos">436</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-437"><a href="#PseudoDifferentialOperator.is_homogeneous-437"><span class="linenos">437</span></a>            <span class="n">p_scaled</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-438"><a href="#PseudoDifferentialOperator.is_homogeneous-438"><span class="linenos">438</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p_scaled</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-439"><a href="#PseudoDifferentialOperator.is_homogeneous-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="n">ratio</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-440"><a href="#PseudoDifferentialOperator.is_homogeneous-440"><span class="linenos">440</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-441"><a href="#PseudoDifferentialOperator.is_homogeneous-441"><span class="linenos">441</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-442"><a href="#PseudoDifferentialOperator.is_homogeneous-442"><span class="linenos">442</span></a>                <span class="n">deg</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-443"><a href="#PseudoDifferentialOperator.is_homogeneous-443"><span class="linenos">443</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">deg</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-444"><a href="#PseudoDifferentialOperator.is_homogeneous-444"><span class="linenos">444</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-445"><a href="#PseudoDifferentialOperator.is_homogeneous-445"><span class="linenos">445</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-446"><a href="#PseudoDifferentialOperator.is_homogeneous-446"><span class="linenos">446</span></a>    
</span><span id="PseudoDifferentialOperator.is_homogeneous-447"><a href="#PseudoDifferentialOperator.is_homogeneous-447"><span class="linenos">447</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-448"><a href="#PseudoDifferentialOperator.is_homogeneous-448"><span class="linenos">448</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-449"><a href="#PseudoDifferentialOperator.is_homogeneous-449"><span class="linenos">449</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-450"><a href="#PseudoDifferentialOperator.is_homogeneous-450"><span class="linenos">450</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-451"><a href="#PseudoDifferentialOperator.is_homogeneous-451"><span class="linenos">451</span></a>            <span class="n">p_scaled</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">l</span> <span class="o">*</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">l</span> <span class="o">*</span> <span class="n">eta</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-452"><a href="#PseudoDifferentialOperator.is_homogeneous-452"><span class="linenos">452</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p_scaled</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-453"><a href="#PseudoDifferentialOperator.is_homogeneous-453"><span class="linenos">453</span></a>            <span class="c1"># If ratio == l**m with no (xi, eta) left, it&#39;s homogeneous</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-454"><a href="#PseudoDifferentialOperator.is_homogeneous-454"><span class="linenos">454</span></a>            <span class="k">if</span> <span class="n">ratio</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-455"><a href="#PseudoDifferentialOperator.is_homogeneous-455"><span class="linenos">455</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-456"><a href="#PseudoDifferentialOperator.is_homogeneous-456"><span class="linenos">456</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-457"><a href="#PseudoDifferentialOperator.is_homogeneous-457"><span class="linenos">457</span></a>                <span class="n">base</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-458"><a href="#PseudoDifferentialOperator.is_homogeneous-458"><span class="linenos">458</span></a>                <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-459"><a href="#PseudoDifferentialOperator.is_homogeneous-459"><span class="linenos">459</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exp</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-460"><a href="#PseudoDifferentialOperator.is_homogeneous-460"><span class="linenos">460</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-461"><a href="#PseudoDifferentialOperator.is_homogeneous-461"><span class="linenos">461</span></a>                <span class="k">pass</span>
</span><span id="PseudoDifferentialOperator.is_homogeneous-462"><a href="#PseudoDifferentialOperator.is_homogeneous-462"><span class="linenos">462</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Check whether the symbol is homogeneous in the frequency variables.</p>

<h2 id="returns">Returns</h2>

<p>(bool, Rational or float or None)
    Tuple (is_homogeneous, degree) where:
    - is_homogeneous: True if the symbol satisfies p(λξ, λη) = λ^m * p(ξ, η)
    - degree: the detected degree m if homogeneous, or None</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.symbol_order" class="classattr">
                                        <input id="PseudoDifferentialOperator.symbol_order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">symbol_order</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">max_order</span><span class="o">=</span><span class="mi">10</span>, </span><span class="param"><span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.symbol_order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.symbol_order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.symbol_order-464"><a href="#PseudoDifferentialOperator.symbol_order-464"><span class="linenos">464</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symbol_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.symbol_order-465"><a href="#PseudoDifferentialOperator.symbol_order-465"><span class="linenos">465</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.symbol_order-466"><a href="#PseudoDifferentialOperator.symbol_order-466"><span class="linenos">466</span></a><span class="sd">        Estimate the homogeneity order of the pseudo-differential symbol in high-frequency asymptotics.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-467"><a href="#PseudoDifferentialOperator.symbol_order-467"><span class="linenos">467</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-468"><a href="#PseudoDifferentialOperator.symbol_order-468"><span class="linenos">468</span></a><span class="sd">        This method attempts to determine the leading-order behavior of the symbol p(x, ξ) or p(x, y, ξ, η)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-469"><a href="#PseudoDifferentialOperator.symbol_order-469"><span class="linenos">469</span></a><span class="sd">        as |ξ| → ∞ (in 1D) or |(ξ, η)| → ∞ (in 2D). The returned value represents the asymptotic growth or decay rate,</span>
</span><span id="PseudoDifferentialOperator.symbol_order-470"><a href="#PseudoDifferentialOperator.symbol_order-470"><span class="linenos">470</span></a><span class="sd">        which is essential for understanding the regularity and mapping properties of the corresponding operator.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-471"><a href="#PseudoDifferentialOperator.symbol_order-471"><span class="linenos">471</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-472"><a href="#PseudoDifferentialOperator.symbol_order-472"><span class="linenos">472</span></a><span class="sd">        The function uses symbolic preprocessing to ensure proper factorization of frequency variables,</span>
</span><span id="PseudoDifferentialOperator.symbol_order-473"><a href="#PseudoDifferentialOperator.symbol_order-473"><span class="linenos">473</span></a><span class="sd">        especially in sqrt and power expressions, to avoid erroneous order detection (e.g., due to hidden scaling).</span>
</span><span id="PseudoDifferentialOperator.symbol_order-474"><a href="#PseudoDifferentialOperator.symbol_order-474"><span class="linenos">474</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-475"><a href="#PseudoDifferentialOperator.symbol_order-475"><span class="linenos">475</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.symbol_order-476"><a href="#PseudoDifferentialOperator.symbol_order-476"><span class="linenos">476</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.symbol_order-477"><a href="#PseudoDifferentialOperator.symbol_order-477"><span class="linenos">477</span></a><span class="sd">        max_order : int, optional</span>
</span><span id="PseudoDifferentialOperator.symbol_order-478"><a href="#PseudoDifferentialOperator.symbol_order-478"><span class="linenos">478</span></a><span class="sd">            Maximum number of terms to consider in the series expansion. Default is 10.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-479"><a href="#PseudoDifferentialOperator.symbol_order-479"><span class="linenos">479</span></a><span class="sd">        tol : float, optional</span>
</span><span id="PseudoDifferentialOperator.symbol_order-480"><a href="#PseudoDifferentialOperator.symbol_order-480"><span class="linenos">480</span></a><span class="sd">            Tolerance threshold for evaluating the coefficient magnitude. If the coefficient is too small,</span>
</span><span id="PseudoDifferentialOperator.symbol_order-481"><a href="#PseudoDifferentialOperator.symbol_order-481"><span class="linenos">481</span></a><span class="sd">            the detected order may be discarded. Default is 1e-3.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-482"><a href="#PseudoDifferentialOperator.symbol_order-482"><span class="linenos">482</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-483"><a href="#PseudoDifferentialOperator.symbol_order-483"><span class="linenos">483</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.symbol_order-484"><a href="#PseudoDifferentialOperator.symbol_order-484"><span class="linenos">484</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.symbol_order-485"><a href="#PseudoDifferentialOperator.symbol_order-485"><span class="linenos">485</span></a><span class="sd">        float or None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-486"><a href="#PseudoDifferentialOperator.symbol_order-486"><span class="linenos">486</span></a><span class="sd">            - If the symbol is homogeneous, returns its exact homogeneity degree as a float.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-487"><a href="#PseudoDifferentialOperator.symbol_order-487"><span class="linenos">487</span></a><span class="sd">            - Otherwise, estimates the dominant asymptotic order from leading terms in the expansion.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-488"><a href="#PseudoDifferentialOperator.symbol_order-488"><span class="linenos">488</span></a><span class="sd">            - Returns None if no valid order could be determined.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-489"><a href="#PseudoDifferentialOperator.symbol_order-489"><span class="linenos">489</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-490"><a href="#PseudoDifferentialOperator.symbol_order-490"><span class="linenos">490</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.symbol_order-491"><a href="#PseudoDifferentialOperator.symbol_order-491"><span class="linenos">491</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.symbol_order-492"><a href="#PseudoDifferentialOperator.symbol_order-492"><span class="linenos">492</span></a><span class="sd">        - In 1D:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-493"><a href="#PseudoDifferentialOperator.symbol_order-493"><span class="linenos">493</span></a><span class="sd">            Two strategies are used:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-494"><a href="#PseudoDifferentialOperator.symbol_order-494"><span class="linenos">494</span></a><span class="sd">                1. Expand directly in xi at infinity.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-495"><a href="#PseudoDifferentialOperator.symbol_order-495"><span class="linenos">495</span></a><span class="sd">                2. Substitute xi = 1/z and expand around z = 0.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-496"><a href="#PseudoDifferentialOperator.symbol_order-496"><span class="linenos">496</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-497"><a href="#PseudoDifferentialOperator.symbol_order-497"><span class="linenos">497</span></a><span class="sd">        - In 2D:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-498"><a href="#PseudoDifferentialOperator.symbol_order-498"><span class="linenos">498</span></a><span class="sd">            - Transform the symbol into polar coordinates: (xi, eta) = rho*(cos(theta), sin(theta)).</span>
</span><span id="PseudoDifferentialOperator.symbol_order-499"><a href="#PseudoDifferentialOperator.symbol_order-499"><span class="linenos">499</span></a><span class="sd">            - Expand in rho at infinity, then extract the leading term&#39;s power.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-500"><a href="#PseudoDifferentialOperator.symbol_order-500"><span class="linenos">500</span></a><span class="sd">            - An alternative substitution using 1/z is also tried if the first method fails.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-501"><a href="#PseudoDifferentialOperator.symbol_order-501"><span class="linenos">501</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-502"><a href="#PseudoDifferentialOperator.symbol_order-502"><span class="linenos">502</span></a><span class="sd">        - Preprocessing steps:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-503"><a href="#PseudoDifferentialOperator.symbol_order-503"><span class="linenos">503</span></a><span class="sd">            - Sqrt expressions involving frequencies are rewritten to isolate the leading variable.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-504"><a href="#PseudoDifferentialOperator.symbol_order-504"><span class="linenos">504</span></a><span class="sd">            - Power expressions are factored explicitly to ensure correct symbolic scaling.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-505"><a href="#PseudoDifferentialOperator.symbol_order-505"><span class="linenos">505</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-506"><a href="#PseudoDifferentialOperator.symbol_order-506"><span class="linenos">506</span></a><span class="sd">        - If the symbol is not homogeneous, a warning is issued, and the result should be interpreted with care.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-507"><a href="#PseudoDifferentialOperator.symbol_order-507"><span class="linenos">507</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.symbol_order-508"><a href="#PseudoDifferentialOperator.symbol_order-508"><span class="linenos">508</span></a><span class="sd">        - For non-homogeneous symbols, only the principal asymptotic term is considered.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-509"><a href="#PseudoDifferentialOperator.symbol_order-509"><span class="linenos">509</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.symbol_order-510"><a href="#PseudoDifferentialOperator.symbol_order-510"><span class="linenos">510</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.symbol_order-511"><a href="#PseudoDifferentialOperator.symbol_order-511"><span class="linenos">511</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.symbol_order-512"><a href="#PseudoDifferentialOperator.symbol_order-512"><span class="linenos">512</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.symbol_order-513"><a href="#PseudoDifferentialOperator.symbol_order-513"><span class="linenos">513</span></a><span class="sd">            If the spatial dimension is neither 1 nor 2.</span>
</span><span id="PseudoDifferentialOperator.symbol_order-514"><a href="#PseudoDifferentialOperator.symbol_order-514"><span class="linenos">514</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.symbol_order-515"><a href="#PseudoDifferentialOperator.symbol_order-515"><span class="linenos">515</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="PseudoDifferentialOperator.symbol_order-516"><a href="#PseudoDifferentialOperator.symbol_order-516"><span class="linenos">516</span></a>            <span class="n">symbols</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">powdenest</span><span class="p">,</span> <span class="n">radsimp</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.symbol_order-517"><a href="#PseudoDifferentialOperator.symbol_order-517"><span class="linenos">517</span></a>            <span class="n">expand</span><span class="p">,</span> <span class="n">expand_power_base</span>
</span><span id="PseudoDifferentialOperator.symbol_order-518"><a href="#PseudoDifferentialOperator.symbol_order-518"><span class="linenos">518</span></a>        <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-519"><a href="#PseudoDifferentialOperator.symbol_order-519"><span class="linenos">519</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-520"><a href="#PseudoDifferentialOperator.symbol_order-520"><span class="linenos">520</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_sqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.symbol_order-521"><a href="#PseudoDifferentialOperator.symbol_order-521"><span class="linenos">521</span></a>            <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.symbol_order-522"><a href="#PseudoDifferentialOperator.symbol_order-522"><span class="linenos">522</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">sqrt</span> <span class="ow">and</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.symbol_order-523"><a href="#PseudoDifferentialOperator.symbol_order-523"><span class="linenos">523</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">freq</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">freq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-524"><a href="#PseudoDifferentialOperator.symbol_order-524"><span class="linenos">524</span></a>            <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-525"><a href="#PseudoDifferentialOperator.symbol_order-525"><span class="linenos">525</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-526"><a href="#PseudoDifferentialOperator.symbol_order-526"><span class="linenos">526</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_power</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.symbol_order-527"><a href="#PseudoDifferentialOperator.symbol_order-527"><span class="linenos">527</span></a>            <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.symbol_order-528"><a href="#PseudoDifferentialOperator.symbol_order-528"><span class="linenos">528</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.symbol_order-529"><a href="#PseudoDifferentialOperator.symbol_order-529"><span class="linenos">529</span></a>                <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">freq</span><span class="o">**</span><span class="n">e</span><span class="o">.</span><span class="n">exp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">base</span> <span class="o">/</span> <span class="n">freq</span><span class="o">**</span><span class="n">e</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="n">e</span><span class="o">.</span><span class="n">exp</span>
</span><span id="PseudoDifferentialOperator.symbol_order-530"><a href="#PseudoDifferentialOperator.symbol_order-530"><span class="linenos">530</span></a>            <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-531"><a href="#PseudoDifferentialOperator.symbol_order-531"><span class="linenos">531</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-532"><a href="#PseudoDifferentialOperator.symbol_order-532"><span class="linenos">532</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">vars_x</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.symbol_order-533"><a href="#PseudoDifferentialOperator.symbol_order-533"><span class="linenos">533</span></a>            <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-534"><a href="#PseudoDifferentialOperator.symbol_order-534"><span class="linenos">534</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-535"><a href="#PseudoDifferentialOperator.symbol_order-535"><span class="linenos">535</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">coeff</span><span class="o">.</span><span class="n">free_symbols</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_x</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.symbol_order-536"><a href="#PseudoDifferentialOperator.symbol_order-536"><span class="linenos">536</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Coefficient depends on spatial variables; ignoring&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-537"><a href="#PseudoDifferentialOperator.symbol_order-537"><span class="linenos">537</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-538"><a href="#PseudoDifferentialOperator.symbol_order-538"><span class="linenos">538</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-539"><a href="#PseudoDifferentialOperator.symbol_order-539"><span class="linenos">539</span></a>                <span class="n">coeff_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="o">.</span><span class="n">evalf</span><span class="p">()))</span>
</span><span id="PseudoDifferentialOperator.symbol_order-540"><a href="#PseudoDifferentialOperator.symbol_order-540"><span class="linenos">540</span></a>                <span class="k">if</span> <span class="n">coeff_val</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-541"><a href="#PseudoDifferentialOperator.symbol_order-541"><span class="linenos">541</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Coefficient too small (</span><span class="si">{</span><span class="n">coeff_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">tol</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-542"><a href="#PseudoDifferentialOperator.symbol_order-542"><span class="linenos">542</span></a>                    <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-543"><a href="#PseudoDifferentialOperator.symbol_order-543"><span class="linenos">543</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-544"><a href="#PseudoDifferentialOperator.symbol_order-544"><span class="linenos">544</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Coefficient evaluation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-545"><a href="#PseudoDifferentialOperator.symbol_order-545"><span class="linenos">545</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-546"><a href="#PseudoDifferentialOperator.symbol_order-546"><span class="linenos">546</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="k">if</span> <span class="n">power</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-547"><a href="#PseudoDifferentialOperator.symbol_order-547"><span class="linenos">547</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-548"><a href="#PseudoDifferentialOperator.symbol_order-548"><span class="linenos">548</span></a>        <span class="c1"># Homogeneity check</span>
</span><span id="PseudoDifferentialOperator.symbol_order-549"><a href="#PseudoDifferentialOperator.symbol_order-549"><span class="linenos">549</span></a>        <span class="n">is_homog</span><span class="p">,</span> <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.symbol_order-550"><a href="#PseudoDifferentialOperator.symbol_order-550"><span class="linenos">550</span></a>        <span class="k">if</span> <span class="n">is_homog</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-551"><a href="#PseudoDifferentialOperator.symbol_order-551"><span class="linenos">551</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">degree</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-552"><a href="#PseudoDifferentialOperator.symbol_order-552"><span class="linenos">552</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-553"><a href="#PseudoDifferentialOperator.symbol_order-553"><span class="linenos">553</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ The symbol is not homogeneous. The asymptotic order is not well defined.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-554"><a href="#PseudoDifferentialOperator.symbol_order-554"><span class="linenos">554</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-555"><a href="#PseudoDifferentialOperator.symbol_order-555"><span class="linenos">555</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-556"><a href="#PseudoDifferentialOperator.symbol_order-556"><span class="linenos">556</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.symbol_order-557"><a href="#PseudoDifferentialOperator.symbol_order-557"><span class="linenos">557</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-558"><a href="#PseudoDifferentialOperator.symbol_order-558"><span class="linenos">558</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-559"><a href="#PseudoDifferentialOperator.symbol_order-559"><span class="linenos">559</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-560"><a href="#PseudoDifferentialOperator.symbol_order-560"><span class="linenos">560</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1D symbol_order - method 1&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-561"><a href="#PseudoDifferentialOperator.symbol_order-561"><span class="linenos">561</span></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">preprocess_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-562"><a href="#PseudoDifferentialOperator.symbol_order-562"><span class="linenos">562</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.symbol_order-563"><a href="#PseudoDifferentialOperator.symbol_order-563"><span class="linenos">563</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.symbol_order-564"><a href="#PseudoDifferentialOperator.symbol_order-564"><span class="linenos">564</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-565"><a href="#PseudoDifferentialOperator.symbol_order-565"><span class="linenos">565</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">xi</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.symbol_order-566"><a href="#PseudoDifferentialOperator.symbol_order-566"><span class="linenos">566</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-567"><a href="#PseudoDifferentialOperator.symbol_order-567"><span class="linenos">567</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-568"><a href="#PseudoDifferentialOperator.symbol_order-568"><span class="linenos">568</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-569"><a href="#PseudoDifferentialOperator.symbol_order-569"><span class="linenos">569</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-570"><a href="#PseudoDifferentialOperator.symbol_order-570"><span class="linenos">570</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-571"><a href="#PseudoDifferentialOperator.symbol_order-571"><span class="linenos">571</span></a>                    <span class="k">return</span> <span class="n">order</span>
</span><span id="PseudoDifferentialOperator.symbol_order-572"><a href="#PseudoDifferentialOperator.symbol_order-572"><span class="linenos">572</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-573"><a href="#PseudoDifferentialOperator.symbol_order-573"><span class="linenos">573</span></a>                <span class="k">pass</span>
</span><span id="PseudoDifferentialOperator.symbol_order-574"><a href="#PseudoDifferentialOperator.symbol_order-574"><span class="linenos">574</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-575"><a href="#PseudoDifferentialOperator.symbol_order-575"><span class="linenos">575</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-576"><a href="#PseudoDifferentialOperator.symbol_order-576"><span class="linenos">576</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1D symbol_order - method 2&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-577"><a href="#PseudoDifferentialOperator.symbol_order-577"><span class="linenos">577</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-578"><a href="#PseudoDifferentialOperator.symbol_order-578"><span class="linenos">578</span></a>                <span class="n">expr_z</span> <span class="o">=</span> <span class="n">preprocess_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-579"><a href="#PseudoDifferentialOperator.symbol_order-579"><span class="linenos">579</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">expr_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.symbol_order-580"><a href="#PseudoDifferentialOperator.symbol_order-580"><span class="linenos">580</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.symbol_order-581"><a href="#PseudoDifferentialOperator.symbol_order-581"><span class="linenos">581</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-582"><a href="#PseudoDifferentialOperator.symbol_order-582"><span class="linenos">582</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">z</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.symbol_order-583"><a href="#PseudoDifferentialOperator.symbol_order-583"><span class="linenos">583</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-584"><a href="#PseudoDifferentialOperator.symbol_order-584"><span class="linenos">584</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-585"><a href="#PseudoDifferentialOperator.symbol_order-585"><span class="linenos">585</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-586"><a href="#PseudoDifferentialOperator.symbol_order-586"><span class="linenos">586</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-587"><a href="#PseudoDifferentialOperator.symbol_order-587"><span class="linenos">587</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-588"><a href="#PseudoDifferentialOperator.symbol_order-588"><span class="linenos">588</span></a>                    <span class="k">return</span> <span class="o">-</span><span class="n">order</span>
</span><span id="PseudoDifferentialOperator.symbol_order-589"><a href="#PseudoDifferentialOperator.symbol_order-589"><span class="linenos">589</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-590"><a href="#PseudoDifferentialOperator.symbol_order-590"><span class="linenos">590</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ fallback z failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-591"><a href="#PseudoDifferentialOperator.symbol_order-591"><span class="linenos">591</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-592"><a href="#PseudoDifferentialOperator.symbol_order-592"><span class="linenos">592</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-593"><a href="#PseudoDifferentialOperator.symbol_order-593"><span class="linenos">593</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-594"><a href="#PseudoDifferentialOperator.symbol_order-594"><span class="linenos">594</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.symbol_order-595"><a href="#PseudoDifferentialOperator.symbol_order-595"><span class="linenos">595</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-596"><a href="#PseudoDifferentialOperator.symbol_order-596"><span class="linenos">596</span></a>            <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;rho theta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-597"><a href="#PseudoDifferentialOperator.symbol_order-597"><span class="linenos">597</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-598"><a href="#PseudoDifferentialOperator.symbol_order-598"><span class="linenos">598</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-599"><a href="#PseudoDifferentialOperator.symbol_order-599"><span class="linenos">599</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D symbol_order - method 1&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-600"><a href="#PseudoDifferentialOperator.symbol_order-600"><span class="linenos">600</span></a>                <span class="n">p_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">eta</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)})</span>
</span><span id="PseudoDifferentialOperator.symbol_order-601"><a href="#PseudoDifferentialOperator.symbol_order-601"><span class="linenos">601</span></a>                <span class="n">p_rho</span> <span class="o">=</span> <span class="n">preprocess_power</span><span class="p">(</span><span class="n">preprocess_sqrt</span><span class="p">(</span><span class="n">p_rho</span><span class="p">,</span> <span class="n">rho</span><span class="p">),</span> <span class="n">rho</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-602"><a href="#PseudoDifferentialOperator.symbol_order-602"><span class="linenos">602</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">p_rho</span><span class="p">),</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.symbol_order-603"><a href="#PseudoDifferentialOperator.symbol_order-603"><span class="linenos">603</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">radsimp</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="PseudoDifferentialOperator.symbol_order-604"><a href="#PseudoDifferentialOperator.symbol_order-604"><span class="linenos">604</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-605"><a href="#PseudoDifferentialOperator.symbol_order-605"><span class="linenos">605</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">rho</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.symbol_order-606"><a href="#PseudoDifferentialOperator.symbol_order-606"><span class="linenos">606</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-607"><a href="#PseudoDifferentialOperator.symbol_order-607"><span class="linenos">607</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-608"><a href="#PseudoDifferentialOperator.symbol_order-608"><span class="linenos">608</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-609"><a href="#PseudoDifferentialOperator.symbol_order-609"><span class="linenos">609</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-610"><a href="#PseudoDifferentialOperator.symbol_order-610"><span class="linenos">610</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-611"><a href="#PseudoDifferentialOperator.symbol_order-611"><span class="linenos">611</span></a>                    <span class="k">return</span> <span class="n">order</span>
</span><span id="PseudoDifferentialOperator.symbol_order-612"><a href="#PseudoDifferentialOperator.symbol_order-612"><span class="linenos">612</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-613"><a href="#PseudoDifferentialOperator.symbol_order-613"><span class="linenos">613</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ polar expansion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-614"><a href="#PseudoDifferentialOperator.symbol_order-614"><span class="linenos">614</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-615"><a href="#PseudoDifferentialOperator.symbol_order-615"><span class="linenos">615</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-616"><a href="#PseudoDifferentialOperator.symbol_order-616"><span class="linenos">616</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D symbol_order - method 2&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-617"><a href="#PseudoDifferentialOperator.symbol_order-617"><span class="linenos">617</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-618"><a href="#PseudoDifferentialOperator.symbol_order-618"><span class="linenos">618</span></a>                <span class="n">xi_eta</span> <span class="o">=</span> <span class="p">{</span><span class="n">xi</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">eta</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)}</span>
</span><span id="PseudoDifferentialOperator.symbol_order-619"><a href="#PseudoDifferentialOperator.symbol_order-619"><span class="linenos">619</span></a>                <span class="n">p_rho</span> <span class="o">=</span> <span class="n">preprocess_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi_eta</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-620"><a href="#PseudoDifferentialOperator.symbol_order-620"><span class="linenos">620</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">p_rho</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.symbol_order-621"><a href="#PseudoDifferentialOperator.symbol_order-621"><span class="linenos">621</span></a>                <span class="n">lead</span> <span class="o">=</span> <span class="n">radsimp</span><span class="p">(</span><span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_leading_term</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="PseudoDifferentialOperator.symbol_order-622"><a href="#PseudoDifferentialOperator.symbol_order-622"><span class="linenos">622</span></a>                <span class="n">power</span> <span class="o">=</span> <span class="n">lead</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-623"><a href="#PseudoDifferentialOperator.symbol_order-623"><span class="linenos">623</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">lead</span> <span class="o">/</span> <span class="n">z</span><span class="o">**</span><span class="n">power</span> <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.symbol_order-624"><a href="#PseudoDifferentialOperator.symbol_order-624"><span class="linenos">624</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lead =&quot;</span><span class="p">,</span> <span class="n">lead</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-625"><a href="#PseudoDifferentialOperator.symbol_order-625"><span class="linenos">625</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;power =&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-626"><a href="#PseudoDifferentialOperator.symbol_order-626"><span class="linenos">626</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff =&quot;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-627"><a href="#PseudoDifferentialOperator.symbol_order-627"><span class="linenos">627</span></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">validate_order</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-628"><a href="#PseudoDifferentialOperator.symbol_order-628"><span class="linenos">628</span></a>                <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-629"><a href="#PseudoDifferentialOperator.symbol_order-629"><span class="linenos">629</span></a>                    <span class="k">return</span> <span class="o">-</span><span class="n">order</span>
</span><span id="PseudoDifferentialOperator.symbol_order-630"><a href="#PseudoDifferentialOperator.symbol_order-630"><span class="linenos">630</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-631"><a href="#PseudoDifferentialOperator.symbol_order-631"><span class="linenos">631</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ fallback z (2D) failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symbol_order-632"><a href="#PseudoDifferentialOperator.symbol_order-632"><span class="linenos">632</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.symbol_order-633"><a href="#PseudoDifferentialOperator.symbol_order-633"><span class="linenos">633</span></a>    
</span><span id="PseudoDifferentialOperator.symbol_order-634"><a href="#PseudoDifferentialOperator.symbol_order-634"><span class="linenos">634</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symbol_order-635"><a href="#PseudoDifferentialOperator.symbol_order-635"><span class="linenos">635</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Estimate the homogeneity order of the pseudo-differential symbol in high-frequency asymptotics.</p>

<p>This method attempts to determine the leading-order behavior of the symbol p(x, ξ) or p(x, y, ξ, η)
as |ξ| → ∞ (in 1D) or |(ξ, η)| → ∞ (in 2D). The returned value represents the asymptotic growth or decay rate,
which is essential for understanding the regularity and mapping properties of the corresponding operator.</p>

<p>The function uses symbolic preprocessing to ensure proper factorization of frequency variables,
especially in sqrt and power expressions, to avoid erroneous order detection (e.g., due to hidden scaling).</p>

<h2 id="parameters">Parameters</h2>

<p>max_order : int, optional
    Maximum number of terms to consider in the series expansion. Default is 10.
tol : float, optional
    Tolerance threshold for evaluating the coefficient magnitude. If the coefficient is too small,
    the detected order may be discarded. Default is 1e-3.</p>

<h2 id="returns">Returns</h2>

<p>float or None
    - If the symbol is homogeneous, returns its exact homogeneity degree as a float.
    - Otherwise, estimates the dominant asymptotic order from leading terms in the expansion.
    - Returns None if no valid order could be determined.</p>

<h2 id="notes">Notes</h2>

<ul>
<li><p>In 1D:
Two strategies are used:
    1. Expand directly in xi at infinity.
    2. Substitute xi = 1/z and expand around z = 0.</p></li>
<li><p>In 2D:</p>

<ul>
<li>Transform the symbol into polar coordinates: (xi, eta) = rho*(cos(theta), sin(theta)).</li>
<li>Expand in rho at infinity, then extract the leading term's power.</li>
<li>An alternative substitution using 1/z is also tried if the first method fails.</li>
</ul></li>
<li><p>Preprocessing steps:</p>

<ul>
<li>Sqrt expressions involving frequencies are rewritten to isolate the leading variable.</li>
<li>Power expressions are factored explicitly to ensure correct symbolic scaling.</li>
</ul></li>
<li><p>If the symbol is not homogeneous, a warning is issued, and the result should be interpreted with care.</p></li>
<li><p>For non-homogeneous symbols, only the principal asymptotic term is considered.</p></li>
</ul>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If the spatial dimension is neither 1 nor 2.</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.asymptotic_expansion" class="classattr">
                                        <input id="PseudoDifferentialOperator.asymptotic_expansion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">asymptotic_expansion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">3</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.asymptotic_expansion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.asymptotic_expansion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.asymptotic_expansion-638"><a href="#PseudoDifferentialOperator.asymptotic_expansion-638"><span class="linenos">638</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">asymptotic_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-639"><a href="#PseudoDifferentialOperator.asymptotic_expansion-639"><span class="linenos">639</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-640"><a href="#PseudoDifferentialOperator.asymptotic_expansion-640"><span class="linenos">640</span></a><span class="sd">        Compute the asymptotic expansion of the symbol as |ξ| → ∞ (high-frequency regime).</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-641"><a href="#PseudoDifferentialOperator.asymptotic_expansion-641"><span class="linenos">641</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-642"><a href="#PseudoDifferentialOperator.asymptotic_expansion-642"><span class="linenos">642</span></a><span class="sd">        This method expands the pseudo-differential symbol in inverse powers of the </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-643"><a href="#PseudoDifferentialOperator.asymptotic_expansion-643"><span class="linenos">643</span></a><span class="sd">        frequency variable(s), either in 1D or 2D. It handles both polynomial and </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-644"><a href="#PseudoDifferentialOperator.asymptotic_expansion-644"><span class="linenos">644</span></a><span class="sd">        exponential symbols by performing a series expansion in 1/|ξ| up to the specified order.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-645"><a href="#PseudoDifferentialOperator.asymptotic_expansion-645"><span class="linenos">645</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-646"><a href="#PseudoDifferentialOperator.asymptotic_expansion-646"><span class="linenos">646</span></a><span class="sd">        The expansion is performed directly in Cartesian coordinates for 1D symbols.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-647"><a href="#PseudoDifferentialOperator.asymptotic_expansion-647"><span class="linenos">647</span></a><span class="sd">        For 2D symbols, the method uses polar coordinates (ρ, θ) to perform the expansion </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-648"><a href="#PseudoDifferentialOperator.asymptotic_expansion-648"><span class="linenos">648</span></a><span class="sd">        at infinity in ρ, then converts the result back to Cartesian coordinates.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-649"><a href="#PseudoDifferentialOperator.asymptotic_expansion-649"><span class="linenos">649</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-650"><a href="#PseudoDifferentialOperator.asymptotic_expansion-650"><span class="linenos">650</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-651"><a href="#PseudoDifferentialOperator.asymptotic_expansion-651"><span class="linenos">651</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-652"><a href="#PseudoDifferentialOperator.asymptotic_expansion-652"><span class="linenos">652</span></a><span class="sd">        order : int, optional</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-653"><a href="#PseudoDifferentialOperator.asymptotic_expansion-653"><span class="linenos">653</span></a><span class="sd">            Maximum order of the asymptotic expansion. Default is 3.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-654"><a href="#PseudoDifferentialOperator.asymptotic_expansion-654"><span class="linenos">654</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-655"><a href="#PseudoDifferentialOperator.asymptotic_expansion-655"><span class="linenos">655</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-656"><a href="#PseudoDifferentialOperator.asymptotic_expansion-656"><span class="linenos">656</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-657"><a href="#PseudoDifferentialOperator.asymptotic_expansion-657"><span class="linenos">657</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-658"><a href="#PseudoDifferentialOperator.asymptotic_expansion-658"><span class="linenos">658</span></a><span class="sd">            The asymptotic expansion of the symbol up to the given order, expressed in Cartesian coordinates.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-659"><a href="#PseudoDifferentialOperator.asymptotic_expansion-659"><span class="linenos">659</span></a><span class="sd">            If expansion fails, returns the original unexpanded symbol.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-660"><a href="#PseudoDifferentialOperator.asymptotic_expansion-660"><span class="linenos">660</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-661"><a href="#PseudoDifferentialOperator.asymptotic_expansion-661"><span class="linenos">661</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-662"><a href="#PseudoDifferentialOperator.asymptotic_expansion-662"><span class="linenos">662</span></a><span class="sd">        - In 1D: expansion is performed directly in terms of ξ.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-663"><a href="#PseudoDifferentialOperator.asymptotic_expansion-663"><span class="linenos">663</span></a><span class="sd">        - In 2D: the symbol is first rewritten in polar coordinates (ρ,θ), expanded asymptotically </span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-664"><a href="#PseudoDifferentialOperator.asymptotic_expansion-664"><span class="linenos">664</span></a><span class="sd">          in ρ → ∞, then converted back to Cartesian coordinates (ξ,η).</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-665"><a href="#PseudoDifferentialOperator.asymptotic_expansion-665"><span class="linenos">665</span></a><span class="sd">        - Handles special case when the symbol is an exponential function by expanding its argument.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-666"><a href="#PseudoDifferentialOperator.asymptotic_expansion-666"><span class="linenos">666</span></a><span class="sd">        - Symbolic normalization is applied early (via `simplify`) for 2D expressions to improve convergence.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-667"><a href="#PseudoDifferentialOperator.asymptotic_expansion-667"><span class="linenos">667</span></a><span class="sd">        - Robust to failures: catches exceptions and issues warnings instead of raising errors.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-668"><a href="#PseudoDifferentialOperator.asymptotic_expansion-668"><span class="linenos">668</span></a><span class="sd">        - Final expression is simplified using `powdenest` and `expand` for improved readability.</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-669"><a href="#PseudoDifferentialOperator.asymptotic_expansion-669"><span class="linenos">669</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-670"><a href="#PseudoDifferentialOperator.asymptotic_expansion-670"><span class="linenos">670</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-671"><a href="#PseudoDifferentialOperator.asymptotic_expansion-671"><span class="linenos">671</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-672"><a href="#PseudoDifferentialOperator.asymptotic_expansion-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-673"><a href="#PseudoDifferentialOperator.asymptotic_expansion-673"><span class="linenos">673</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-674"><a href="#PseudoDifferentialOperator.asymptotic_expansion-674"><span class="linenos">674</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-675"><a href="#PseudoDifferentialOperator.asymptotic_expansion-675"><span class="linenos">675</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-676"><a href="#PseudoDifferentialOperator.asymptotic_expansion-676"><span class="linenos">676</span></a>                <span class="c1"># Case: exponential function</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-677"><a href="#PseudoDifferentialOperator.asymptotic_expansion-677"><span class="linenos">677</span></a>                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">exp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-678"><a href="#PseudoDifferentialOperator.asymptotic_expansion-678"><span class="linenos">678</span></a>                    <span class="n">arg</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-679"><a href="#PseudoDifferentialOperator.asymptotic_expansion-679"><span class="linenos">679</span></a>                    <span class="n">arg_series</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-680"><a href="#PseudoDifferentialOperator.asymptotic_expansion-680"><span class="linenos">680</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">arg_series</span><span class="p">)),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-681"><a href="#PseudoDifferentialOperator.asymptotic_expansion-681"><span class="linenos">681</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-682"><a href="#PseudoDifferentialOperator.asymptotic_expansion-682"><span class="linenos">682</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-683"><a href="#PseudoDifferentialOperator.asymptotic_expansion-683"><span class="linenos">683</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-684"><a href="#PseudoDifferentialOperator.asymptotic_expansion-684"><span class="linenos">684</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-685"><a href="#PseudoDifferentialOperator.asymptotic_expansion-685"><span class="linenos">685</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-686"><a href="#PseudoDifferentialOperator.asymptotic_expansion-686"><span class="linenos">686</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-687"><a href="#PseudoDifferentialOperator.asymptotic_expansion-687"><span class="linenos">687</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: 1D expansion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-688"><a href="#PseudoDifferentialOperator.asymptotic_expansion-688"><span class="linenos">688</span></a>                <span class="k">return</span> <span class="n">p</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-689"><a href="#PseudoDifferentialOperator.asymptotic_expansion-689"><span class="linenos">689</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-690"><a href="#PseudoDifferentialOperator.asymptotic_expansion-690"><span class="linenos">690</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-691"><a href="#PseudoDifferentialOperator.asymptotic_expansion-691"><span class="linenos">691</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-692"><a href="#PseudoDifferentialOperator.asymptotic_expansion-692"><span class="linenos">692</span></a>            <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;rho theta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-693"><a href="#PseudoDifferentialOperator.asymptotic_expansion-693"><span class="linenos">693</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-694"><a href="#PseudoDifferentialOperator.asymptotic_expansion-694"><span class="linenos">694</span></a>            <span class="c1"># Normalize before substitution</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-695"><a href="#PseudoDifferentialOperator.asymptotic_expansion-695"><span class="linenos">695</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-696"><a href="#PseudoDifferentialOperator.asymptotic_expansion-696"><span class="linenos">696</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-697"><a href="#PseudoDifferentialOperator.asymptotic_expansion-697"><span class="linenos">697</span></a>            <span class="c1"># Substitute polar coordinates</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-698"><a href="#PseudoDifferentialOperator.asymptotic_expansion-698"><span class="linenos">698</span></a>            <span class="n">p_polar</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-699"><a href="#PseudoDifferentialOperator.asymptotic_expansion-699"><span class="linenos">699</span></a>                <span class="n">xi</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-700"><a href="#PseudoDifferentialOperator.asymptotic_expansion-700"><span class="linenos">700</span></a>                <span class="n">eta</span><span class="p">:</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-701"><a href="#PseudoDifferentialOperator.asymptotic_expansion-701"><span class="linenos">701</span></a>            <span class="p">})</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-702"><a href="#PseudoDifferentialOperator.asymptotic_expansion-702"><span class="linenos">702</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-703"><a href="#PseudoDifferentialOperator.asymptotic_expansion-703"><span class="linenos">703</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-704"><a href="#PseudoDifferentialOperator.asymptotic_expansion-704"><span class="linenos">704</span></a>                <span class="c1"># Handle exponentials</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-705"><a href="#PseudoDifferentialOperator.asymptotic_expansion-705"><span class="linenos">705</span></a>                <span class="k">if</span> <span class="n">p_polar</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">exp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_polar</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-706"><a href="#PseudoDifferentialOperator.asymptotic_expansion-706"><span class="linenos">706</span></a>                    <span class="n">arg</span> <span class="o">=</span> <span class="n">p_polar</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-707"><a href="#PseudoDifferentialOperator.asymptotic_expansion-707"><span class="linenos">707</span></a>                    <span class="n">arg_series</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-708"><a href="#PseudoDifferentialOperator.asymptotic_expansion-708"><span class="linenos">708</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">arg_series</span><span class="p">)),</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-709"><a href="#PseudoDifferentialOperator.asymptotic_expansion-709"><span class="linenos">709</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-710"><a href="#PseudoDifferentialOperator.asymptotic_expansion-710"><span class="linenos">710</span></a>                    <span class="n">expanded</span> <span class="o">=</span> <span class="n">series</span><span class="p">(</span><span class="n">p_polar</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-711"><a href="#PseudoDifferentialOperator.asymptotic_expansion-711"><span class="linenos">711</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-712"><a href="#PseudoDifferentialOperator.asymptotic_expansion-712"><span class="linenos">712</span></a>                <span class="c1"># Convert back to Cartesian</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-713"><a href="#PseudoDifferentialOperator.asymptotic_expansion-713"><span class="linenos">713</span></a>                <span class="n">norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-714"><a href="#PseudoDifferentialOperator.asymptotic_expansion-714"><span class="linenos">714</span></a>                <span class="n">expansion_cart</span> <span class="o">=</span> <span class="n">expanded</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-715"><a href="#PseudoDifferentialOperator.asymptotic_expansion-715"><span class="linenos">715</span></a>                    <span class="n">rho</span><span class="p">:</span> <span class="n">norm</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-716"><a href="#PseudoDifferentialOperator.asymptotic_expansion-716"><span class="linenos">716</span></a>                    <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">xi</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-717"><a href="#PseudoDifferentialOperator.asymptotic_expansion-717"><span class="linenos">717</span></a>                    <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">norm</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-718"><a href="#PseudoDifferentialOperator.asymptotic_expansion-718"><span class="linenos">718</span></a>                <span class="p">})</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-719"><a href="#PseudoDifferentialOperator.asymptotic_expansion-719"><span class="linenos">719</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-720"><a href="#PseudoDifferentialOperator.asymptotic_expansion-720"><span class="linenos">720</span></a>                <span class="c1"># Final simplifications</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-721"><a href="#PseudoDifferentialOperator.asymptotic_expansion-721"><span class="linenos">721</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">powdenest</span><span class="p">(</span><span class="n">expansion_cart</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-722"><a href="#PseudoDifferentialOperator.asymptotic_expansion-722"><span class="linenos">722</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-723"><a href="#PseudoDifferentialOperator.asymptotic_expansion-723"><span class="linenos">723</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-724"><a href="#PseudoDifferentialOperator.asymptotic_expansion-724"><span class="linenos">724</span></a>    
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-725"><a href="#PseudoDifferentialOperator.asymptotic_expansion-725"><span class="linenos">725</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-726"><a href="#PseudoDifferentialOperator.asymptotic_expansion-726"><span class="linenos">726</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: 2D expansion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.asymptotic_expansion-727"><a href="#PseudoDifferentialOperator.asymptotic_expansion-727"><span class="linenos">727</span></a>                <span class="k">return</span> <span class="n">p</span>  
</span></pre></div>


            <div class="docstring"><p>Compute the asymptotic expansion of the symbol as |ξ| → ∞ (high-frequency regime).</p>

<p>This method expands the pseudo-differential symbol in inverse powers of the 
frequency variable(s), either in 1D or 2D. It handles both polynomial and 
exponential symbols by performing a series expansion in 1/|ξ| up to the specified order.</p>

<p>The expansion is performed directly in Cartesian coordinates for 1D symbols.
For 2D symbols, the method uses polar coordinates (ρ, θ) to perform the expansion 
at infinity in ρ, then converts the result back to Cartesian coordinates.</p>

<h2 id="parameters">Parameters</h2>

<p>order : int, optional
    Maximum order of the asymptotic expansion. Default is 3.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    The asymptotic expansion of the symbol up to the given order, expressed in Cartesian coordinates.
    If expansion fails, returns the original unexpanded symbol.</p>

<p>Notes:</p>

<ul>
<li>In 1D: expansion is performed directly in terms of ξ.</li>
<li>In 2D: the symbol is first rewritten in polar coordinates (ρ,θ), expanded asymptotically 
in ρ → ∞, then converted back to Cartesian coordinates (ξ,η).</li>
<li>Handles special case when the symbol is an exponential function by expanding its argument.</li>
<li>Symbolic normalization is applied early (via <code>simplify</code>) for 2D expressions to improve convergence.</li>
<li>Robust to failures: catches exceptions and issues warnings instead of raising errors.</li>
<li>Final expression is simplified using <code>powdenest</code> and <code>expand</code> for improved readability.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.compose_asymptotic" class="classattr">
                                        <input id="PseudoDifferentialOperator.compose_asymptotic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compose_asymptotic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">other</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span>, </span><span class="param"><span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.compose_asymptotic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.compose_asymptotic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.compose_asymptotic-729"><a href="#PseudoDifferentialOperator.compose_asymptotic-729"><span class="linenos">729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-730"><a href="#PseudoDifferentialOperator.compose_asymptotic-730"><span class="linenos">730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-731"><a href="#PseudoDifferentialOperator.compose_asymptotic-731"><span class="linenos">731</span></a><span class="sd">        Compose two pseudo-differential operators using an asymptotic expansion</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-732"><a href="#PseudoDifferentialOperator.compose_asymptotic-732"><span class="linenos">732</span></a><span class="sd">        in the chosen quantization scheme (Kohn–Nirenberg or Weyl).</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-733"><a href="#PseudoDifferentialOperator.compose_asymptotic-733"><span class="linenos">733</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-734"><a href="#PseudoDifferentialOperator.compose_asymptotic-734"><span class="linenos">734</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-735"><a href="#PseudoDifferentialOperator.compose_asymptotic-735"><span class="linenos">735</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-736"><a href="#PseudoDifferentialOperator.compose_asymptotic-736"><span class="linenos">736</span></a><span class="sd">        other : PseudoDifferentialOperator</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-737"><a href="#PseudoDifferentialOperator.compose_asymptotic-737"><span class="linenos">737</span></a><span class="sd">            The operator to compose with this one.</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-738"><a href="#PseudoDifferentialOperator.compose_asymptotic-738"><span class="linenos">738</span></a><span class="sd">        order : int, default=1</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-739"><a href="#PseudoDifferentialOperator.compose_asymptotic-739"><span class="linenos">739</span></a><span class="sd">            Maximum order of the asymptotic expansion.</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-740"><a href="#PseudoDifferentialOperator.compose_asymptotic-740"><span class="linenos">740</span></a><span class="sd">        mode : {&#39;kn&#39;, &#39;weyl&#39;}, default=&#39;kn&#39;</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-741"><a href="#PseudoDifferentialOperator.compose_asymptotic-741"><span class="linenos">741</span></a><span class="sd">            Quantization mode:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-742"><a href="#PseudoDifferentialOperator.compose_asymptotic-742"><span class="linenos">742</span></a><span class="sd">            - &#39;kn&#39; : Kohn–Nirenberg quantization (left-quantized)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-743"><a href="#PseudoDifferentialOperator.compose_asymptotic-743"><span class="linenos">743</span></a><span class="sd">            - &#39;weyl&#39; : Weyl symmetric quantization</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-744"><a href="#PseudoDifferentialOperator.compose_asymptotic-744"><span class="linenos">744</span></a><span class="sd">        sign_convention : {&#39;standard&#39;, &#39;inverse&#39;}, optional</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-745"><a href="#PseudoDifferentialOperator.compose_asymptotic-745"><span class="linenos">745</span></a><span class="sd">            Controls the phase factor convention for the KN case:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-746"><a href="#PseudoDifferentialOperator.compose_asymptotic-746"><span class="linenos">746</span></a><span class="sd">            - &#39;standard&#39; → (i)^(-n), gives [x, ξ] = +i (physics convention)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-747"><a href="#PseudoDifferentialOperator.compose_asymptotic-747"><span class="linenos">747</span></a><span class="sd">            - &#39;inverse&#39; → (i)^(+n), gives [x, ξ] = -i (mathematical adjoint convention)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-748"><a href="#PseudoDifferentialOperator.compose_asymptotic-748"><span class="linenos">748</span></a><span class="sd">            If None, defaults to &#39;standard&#39;.</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-749"><a href="#PseudoDifferentialOperator.compose_asymptotic-749"><span class="linenos">749</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-750"><a href="#PseudoDifferentialOperator.compose_asymptotic-750"><span class="linenos">750</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-751"><a href="#PseudoDifferentialOperator.compose_asymptotic-751"><span class="linenos">751</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-752"><a href="#PseudoDifferentialOperator.compose_asymptotic-752"><span class="linenos">752</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-753"><a href="#PseudoDifferentialOperator.compose_asymptotic-753"><span class="linenos">753</span></a><span class="sd">            Symbolic expression for the composed symbol up to the given order.</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-754"><a href="#PseudoDifferentialOperator.compose_asymptotic-754"><span class="linenos">754</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-755"><a href="#PseudoDifferentialOperator.compose_asymptotic-755"><span class="linenos">755</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-756"><a href="#PseudoDifferentialOperator.compose_asymptotic-756"><span class="linenos">756</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-757"><a href="#PseudoDifferentialOperator.compose_asymptotic-757"><span class="linenos">757</span></a><span class="sd">        - In 1D (Kohn–Nirenberg):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-758"><a href="#PseudoDifferentialOperator.compose_asymptotic-758"><span class="linenos">758</span></a><span class="sd">            (p ∘ q)(x, ξ) ~ Σₙ (1/n!) (i sgn)^n ∂_ξⁿ p(x, ξ) ∂_xⁿ q(x, ξ)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-759"><a href="#PseudoDifferentialOperator.compose_asymptotic-759"><span class="linenos">759</span></a><span class="sd">        - In 1D (Weyl):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-760"><a href="#PseudoDifferentialOperator.compose_asymptotic-760"><span class="linenos">760</span></a><span class="sd">            (p # q)(x, ξ) = exp[(i/2)(∂_ξ^p ∂_x^q - ∂_x^p ∂_ξ^q)] p(x, ξ) q(x, ξ)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-761"><a href="#PseudoDifferentialOperator.compose_asymptotic-761"><span class="linenos">761</span></a><span class="sd">            truncated at given order.</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-762"><a href="#PseudoDifferentialOperator.compose_asymptotic-762"><span class="linenos">762</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-763"><a href="#PseudoDifferentialOperator.compose_asymptotic-763"><span class="linenos">763</span></a><span class="sd">        Examples</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-764"><a href="#PseudoDifferentialOperator.compose_asymptotic-764"><span class="linenos">764</span></a><span class="sd">        --------</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-765"><a href="#PseudoDifferentialOperator.compose_asymptotic-765"><span class="linenos">765</span></a><span class="sd">        X = a*x, Y = b*ξ</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-766"><a href="#PseudoDifferentialOperator.compose_asymptotic-766"><span class="linenos">766</span></a><span class="sd">        X_op.compose_asymptotic(Y_op, order=3, mode=&#39;weyl&#39;)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-767"><a href="#PseudoDifferentialOperator.compose_asymptotic-767"><span class="linenos">767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-768"><a href="#PseudoDifferentialOperator.compose_asymptotic-768"><span class="linenos">768</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-769"><a href="#PseudoDifferentialOperator.compose_asymptotic-769"><span class="linenos">769</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">diff</span><span class="p">,</span> <span class="n">factorial</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">symbols</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-770"><a href="#PseudoDifferentialOperator.compose_asymptotic-770"><span class="linenos">770</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-771"><a href="#PseudoDifferentialOperator.compose_asymptotic-771"><span class="linenos">771</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;Operator dimensions must match&quot;</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-772"><a href="#PseudoDifferentialOperator.compose_asymptotic-772"><span class="linenos">772</span></a>        <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-773"><a href="#PseudoDifferentialOperator.compose_asymptotic-773"><span class="linenos">773</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-774"><a href="#PseudoDifferentialOperator.compose_asymptotic-774"><span class="linenos">774</span></a>        <span class="c1"># Default sign convention</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-775"><a href="#PseudoDifferentialOperator.compose_asymptotic-775"><span class="linenos">775</span></a>        <span class="k">if</span> <span class="n">sign_convention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-776"><a href="#PseudoDifferentialOperator.compose_asymptotic-776"><span class="linenos">776</span></a>            <span class="n">sign_convention</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-777"><a href="#PseudoDifferentialOperator.compose_asymptotic-777"><span class="linenos">777</span></a>        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sign_convention</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-778"><a href="#PseudoDifferentialOperator.compose_asymptotic-778"><span class="linenos">778</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-779"><a href="#PseudoDifferentialOperator.compose_asymptotic-779"><span class="linenos">779</span></a>        <span class="c1"># --- 1D case ---</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-780"><a href="#PseudoDifferentialOperator.compose_asymptotic-780"><span class="linenos">780</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-781"><a href="#PseudoDifferentialOperator.compose_asymptotic-781"><span class="linenos">781</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-782"><a href="#PseudoDifferentialOperator.compose_asymptotic-782"><span class="linenos">782</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-783"><a href="#PseudoDifferentialOperator.compose_asymptotic-783"><span class="linenos">783</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-784"><a href="#PseudoDifferentialOperator.compose_asymptotic-784"><span class="linenos">784</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-785"><a href="#PseudoDifferentialOperator.compose_asymptotic-785"><span class="linenos">785</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kn&#39;</span><span class="p">:</span>  <span class="c1"># Kohn–Nirenberg</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-786"><a href="#PseudoDifferentialOperator.compose_asymptotic-786"><span class="linenos">786</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-787"><a href="#PseudoDifferentialOperator.compose_asymptotic-787"><span class="linenos">787</span></a>                    <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-788"><a href="#PseudoDifferentialOperator.compose_asymptotic-788"><span class="linenos">788</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-789"><a href="#PseudoDifferentialOperator.compose_asymptotic-789"><span class="linenos">789</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-790"><a href="#PseudoDifferentialOperator.compose_asymptotic-790"><span class="linenos">790</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;weyl&#39;</span><span class="p">:</span>  <span class="c1"># Weyl symmetric composition</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-791"><a href="#PseudoDifferentialOperator.compose_asymptotic-791"><span class="linenos">791</span></a>                <span class="c1"># Weyl star product: exp((i/2)(∂_ξ^p ∂_x^q - ∂_x^p ∂_ξ^q))</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-792"><a href="#PseudoDifferentialOperator.compose_asymptotic-792"><span class="linenos">792</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-793"><a href="#PseudoDifferentialOperator.compose_asymptotic-793"><span class="linenos">793</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-794"><a href="#PseudoDifferentialOperator.compose_asymptotic-794"><span class="linenos">794</span></a>                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-795"><a href="#PseudoDifferentialOperator.compose_asymptotic-795"><span class="linenos">795</span></a>                        <span class="c1"># k derivatives acting as (∂_ξ^k p)(∂_x^(n−k) q)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-796"><a href="#PseudoDifferentialOperator.compose_asymptotic-796"><span class="linenos">796</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-797"><a href="#PseudoDifferentialOperator.compose_asymptotic-797"><span class="linenos">797</span></a>                        <span class="n">term</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-798"><a href="#PseudoDifferentialOperator.compose_asymptotic-798"><span class="linenos">798</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-799"><a href="#PseudoDifferentialOperator.compose_asymptotic-799"><span class="linenos">799</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-800"><a href="#PseudoDifferentialOperator.compose_asymptotic-800"><span class="linenos">800</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-801"><a href="#PseudoDifferentialOperator.compose_asymptotic-801"><span class="linenos">801</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be either &#39;kn&#39; or &#39;weyl&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-802"><a href="#PseudoDifferentialOperator.compose_asymptotic-802"><span class="linenos">802</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-803"><a href="#PseudoDifferentialOperator.compose_asymptotic-803"><span class="linenos">803</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-804"><a href="#PseudoDifferentialOperator.compose_asymptotic-804"><span class="linenos">804</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-805"><a href="#PseudoDifferentialOperator.compose_asymptotic-805"><span class="linenos">805</span></a>        <span class="c1"># --- 2D case ---</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-806"><a href="#PseudoDifferentialOperator.compose_asymptotic-806"><span class="linenos">806</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-807"><a href="#PseudoDifferentialOperator.compose_asymptotic-807"><span class="linenos">807</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-808"><a href="#PseudoDifferentialOperator.compose_asymptotic-808"><span class="linenos">808</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-809"><a href="#PseudoDifferentialOperator.compose_asymptotic-809"><span class="linenos">809</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-810"><a href="#PseudoDifferentialOperator.compose_asymptotic-810"><span class="linenos">810</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-811"><a href="#PseudoDifferentialOperator.compose_asymptotic-811"><span class="linenos">811</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kn&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-812"><a href="#PseudoDifferentialOperator.compose_asymptotic-812"><span class="linenos">812</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-813"><a href="#PseudoDifferentialOperator.compose_asymptotic-813"><span class="linenos">813</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-814"><a href="#PseudoDifferentialOperator.compose_asymptotic-814"><span class="linenos">814</span></a>                        <span class="n">j</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-815"><a href="#PseudoDifferentialOperator.compose_asymptotic-815"><span class="linenos">815</span></a>                        <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">*</span> \
</span><span id="PseudoDifferentialOperator.compose_asymptotic-816"><a href="#PseudoDifferentialOperator.compose_asymptotic-816"><span class="linenos">816</span></a>                               <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-817"><a href="#PseudoDifferentialOperator.compose_asymptotic-817"><span class="linenos">817</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-818"><a href="#PseudoDifferentialOperator.compose_asymptotic-818"><span class="linenos">818</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-819"><a href="#PseudoDifferentialOperator.compose_asymptotic-819"><span class="linenos">819</span></a>            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;weyl&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-820"><a href="#PseudoDifferentialOperator.compose_asymptotic-820"><span class="linenos">820</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-821"><a href="#PseudoDifferentialOperator.compose_asymptotic-821"><span class="linenos">821</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-822"><a href="#PseudoDifferentialOperator.compose_asymptotic-822"><span class="linenos">822</span></a>                        <span class="n">j</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-823"><a href="#PseudoDifferentialOperator.compose_asymptotic-823"><span class="linenos">823</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-824"><a href="#PseudoDifferentialOperator.compose_asymptotic-824"><span class="linenos">824</span></a>                        <span class="n">term</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-825"><a href="#PseudoDifferentialOperator.compose_asymptotic-825"><span class="linenos">825</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-826"><a href="#PseudoDifferentialOperator.compose_asymptotic-826"><span class="linenos">826</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-827"><a href="#PseudoDifferentialOperator.compose_asymptotic-827"><span class="linenos">827</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be either &#39;kn&#39; or &#39;weyl&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-828"><a href="#PseudoDifferentialOperator.compose_asymptotic-828"><span class="linenos">828</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-829"><a href="#PseudoDifferentialOperator.compose_asymptotic-829"><span class="linenos">829</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-830"><a href="#PseudoDifferentialOperator.compose_asymptotic-830"><span class="linenos">830</span></a>    
</span><span id="PseudoDifferentialOperator.compose_asymptotic-831"><a href="#PseudoDifferentialOperator.compose_asymptotic-831"><span class="linenos">831</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.compose_asymptotic-832"><a href="#PseudoDifferentialOperator.compose_asymptotic-832"><span class="linenos">832</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D cases are implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compose two pseudo-differential operators using an asymptotic expansion
in the chosen quantization scheme (Kohn–Nirenberg or Weyl).</p>

<h2 id="parameters">Parameters</h2>

<p>other : PseudoDifferentialOperator
    The operator to compose with this one.
order : int, default=1
    Maximum order of the asymptotic expansion.
mode : {'kn', 'weyl'}, default='kn'
    Quantization mode:
    - 'kn' : Kohn–Nirenberg quantization (left-quantized)
    - 'weyl' : Weyl symmetric quantization
sign_convention : {'standard', 'inverse'}, optional
    Controls the phase factor convention for the KN case:
    - 'standard' → (i)^(-n), gives [x, ξ] = +i (physics convention)
    - 'inverse' → (i)^(+n), gives [x, ξ] = -i (mathematical adjoint convention)
    If None, defaults to 'standard'.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    Symbolic expression for the composed symbol up to the given order.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D (Kohn–Nirenberg):
(p ∘ q)(x, ξ) ~ Σₙ (1/n!) (i sgn)^n ∂_ξⁿ p(x, ξ) ∂_xⁿ q(x, ξ)</li>
<li>In 1D (Weyl):
(p # q)(x, ξ) = exp[(i/2)(∂_ξ^p ∂_x^q - ∂_x^p ∂_ξ^q)] p(x, ξ) q(x, ξ)
truncated at given order.</li>
</ul>

<h2 id="examples">Examples</h2>

<p>X = a<em>x, Y = b</em>ξ
X_op.compose_asymptotic(Y_op, order=3, mode='weyl')</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.commutator_symbolic" class="classattr">
                                        <input id="PseudoDifferentialOperator.commutator_symbolic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">commutator_symbolic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">other</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span>, </span><span class="param"><span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.commutator_symbolic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.commutator_symbolic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.commutator_symbolic-834"><a href="#PseudoDifferentialOperator.commutator_symbolic-834"><span class="linenos">834</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">commutator_symbolic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-835"><a href="#PseudoDifferentialOperator.commutator_symbolic-835"><span class="linenos">835</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-836"><a href="#PseudoDifferentialOperator.commutator_symbolic-836"><span class="linenos">836</span></a><span class="sd">        Compute the symbolic commutator [A, B] = A∘B − B∘A of two pseudo-differential operators</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-837"><a href="#PseudoDifferentialOperator.commutator_symbolic-837"><span class="linenos">837</span></a><span class="sd">        using formal asymptotic expansion of their composition symbols.</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-838"><a href="#PseudoDifferentialOperator.commutator_symbolic-838"><span class="linenos">838</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-839"><a href="#PseudoDifferentialOperator.commutator_symbolic-839"><span class="linenos">839</span></a><span class="sd">        This method computes the asymptotic expansion of the commutator&#39;s symbol up to a given </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-840"><a href="#PseudoDifferentialOperator.commutator_symbolic-840"><span class="linenos">840</span></a><span class="sd">        order, based on the symbolic calculus of pseudo-differential operators in the </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-841"><a href="#PseudoDifferentialOperator.commutator_symbolic-841"><span class="linenos">841</span></a><span class="sd">        Kohn–Nirenberg quantization. The result is a purely symbolic sympy expression that </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-842"><a href="#PseudoDifferentialOperator.commutator_symbolic-842"><span class="linenos">842</span></a><span class="sd">        captures the leading-order noncommutativity of the operators.</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-843"><a href="#PseudoDifferentialOperator.commutator_symbolic-843"><span class="linenos">843</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-844"><a href="#PseudoDifferentialOperator.commutator_symbolic-844"><span class="linenos">844</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-845"><a href="#PseudoDifferentialOperator.commutator_symbolic-845"><span class="linenos">845</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-846"><a href="#PseudoDifferentialOperator.commutator_symbolic-846"><span class="linenos">846</span></a><span class="sd">        other : PseudoDifferentialOperator</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-847"><a href="#PseudoDifferentialOperator.commutator_symbolic-847"><span class="linenos">847</span></a><span class="sd">            The pseudo-differential operator B to commute with this operator A.</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-848"><a href="#PseudoDifferentialOperator.commutator_symbolic-848"><span class="linenos">848</span></a><span class="sd">        order : int, default=1</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-849"><a href="#PseudoDifferentialOperator.commutator_symbolic-849"><span class="linenos">849</span></a><span class="sd">            Maximum order of the asymptotic expansion. </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-850"><a href="#PseudoDifferentialOperator.commutator_symbolic-850"><span class="linenos">850</span></a><span class="sd">            - order=1 yields the leading term proportional to the Poisson bracket {p, q}.</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-851"><a href="#PseudoDifferentialOperator.commutator_symbolic-851"><span class="linenos">851</span></a><span class="sd">            - Higher orders include correction terms involving higher mixed derivatives.</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-852"><a href="#PseudoDifferentialOperator.commutator_symbolic-852"><span class="linenos">852</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-853"><a href="#PseudoDifferentialOperator.commutator_symbolic-853"><span class="linenos">853</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-854"><a href="#PseudoDifferentialOperator.commutator_symbolic-854"><span class="linenos">854</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-855"><a href="#PseudoDifferentialOperator.commutator_symbolic-855"><span class="linenos">855</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-856"><a href="#PseudoDifferentialOperator.commutator_symbolic-856"><span class="linenos">856</span></a><span class="sd">            Symbolic expression for the asymptotic expansion of the commutator symbol </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-857"><a href="#PseudoDifferentialOperator.commutator_symbolic-857"><span class="linenos">857</span></a><span class="sd">            σ([A,B]) = σ(A∘B − B∘A).</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-858"><a href="#PseudoDifferentialOperator.commutator_symbolic-858"><span class="linenos">858</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-859"><a href="#PseudoDifferentialOperator.commutator_symbolic-859"><span class="linenos">859</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-860"><a href="#PseudoDifferentialOperator.commutator_symbolic-860"><span class="linenos">860</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="s2">&quot;Operator dimensions must match&quot;</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-861"><a href="#PseudoDifferentialOperator.commutator_symbolic-861"><span class="linenos">861</span></a>        <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-862"><a href="#PseudoDifferentialOperator.commutator_symbolic-862"><span class="linenos">862</span></a>    
</span><span id="PseudoDifferentialOperator.commutator_symbolic-863"><a href="#PseudoDifferentialOperator.commutator_symbolic-863"><span class="linenos">863</span></a>        <span class="n">pq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-864"><a href="#PseudoDifferentialOperator.commutator_symbolic-864"><span class="linenos">864</span></a>        <span class="n">qp</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-865"><a href="#PseudoDifferentialOperator.commutator_symbolic-865"><span class="linenos">865</span></a>        
</span><span id="PseudoDifferentialOperator.commutator_symbolic-866"><a href="#PseudoDifferentialOperator.commutator_symbolic-866"><span class="linenos">866</span></a>        <span class="n">comm_symbol</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">pq</span><span class="o">-</span><span class="n">qp</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-867"><a href="#PseudoDifferentialOperator.commutator_symbolic-867"><span class="linenos">867</span></a>
</span><span id="PseudoDifferentialOperator.commutator_symbolic-868"><a href="#PseudoDifferentialOperator.commutator_symbolic-868"><span class="linenos">868</span></a>        <span class="k">return</span> <span class="n">comm_symbol</span>
</span></pre></div>


            <div class="docstring"><p>Compute the symbolic commutator [A, B] = A∘B − B∘A of two pseudo-differential operators
using formal asymptotic expansion of their composition symbols.</p>

<p>This method computes the asymptotic expansion of the commutator's symbol up to a given 
order, based on the symbolic calculus of pseudo-differential operators in the 
Kohn–Nirenberg quantization. The result is a purely symbolic sympy expression that 
captures the leading-order noncommutativity of the operators.</p>

<h2 id="parameters">Parameters</h2>

<p>other : PseudoDifferentialOperator
    The pseudo-differential operator B to commute with this operator A.
order : int, default=1
    Maximum order of the asymptotic expansion. 
    - order=1 yields the leading term proportional to the Poisson bracket {p, q}.
    - Higher orders include correction terms involving higher mixed derivatives.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    Symbolic expression for the asymptotic expansion of the commutator symbol 
    σ([A,B]) = σ(A∘B − B∘A).</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.right_inverse_asymptotic" class="classattr">
                                        <input id="PseudoDifferentialOperator.right_inverse_asymptotic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">right_inverse_asymptotic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.right_inverse_asymptotic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.right_inverse_asymptotic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-870"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-870"><span class="linenos">870</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">right_inverse_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-871"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-871"><span class="linenos">871</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-872"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-872"><span class="linenos">872</span></a><span class="sd">        Construct a formal right inverse R of the pseudo-differential operator P such that </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-873"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-873"><span class="linenos">873</span></a><span class="sd">        the composition P ∘ R equals the identity plus a smoothing operator of order -order.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-874"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-874"><span class="linenos">874</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-875"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-875"><span class="linenos">875</span></a><span class="sd">        This method computes an asymptotic expansion for the right inverse using recursive </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-876"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-876"><span class="linenos">876</span></a><span class="sd">        corrections based on derivatives of the symbol p(x, ξ) and lower-order terms of R.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-877"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-877"><span class="linenos">877</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-878"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-878"><span class="linenos">878</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-879"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-879"><span class="linenos">879</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-880"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-880"><span class="linenos">880</span></a><span class="sd">        order : int</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-881"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-881"><span class="linenos">881</span></a><span class="sd">            Number of terms to include in the asymptotic expansion. Higher values improve </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-882"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-882"><span class="linenos">882</span></a><span class="sd">            approximation at the cost of complexity and computational effort.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-883"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-883"><span class="linenos">883</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-884"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-884"><span class="linenos">884</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-885"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-885"><span class="linenos">885</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-886"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-886"><span class="linenos">886</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-887"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-887"><span class="linenos">887</span></a><span class="sd">            The symbolic expression representing the formal right inverse R(x, ξ), which satisfies:</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-888"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-888"><span class="linenos">888</span></a><span class="sd">            P ∘ R = Id + O(⟨ξ⟩^{-order}), where ⟨ξ⟩ = (1 + |ξ|²)^{1/2}.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-889"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-889"><span class="linenos">889</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-890"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-890"><span class="linenos">890</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-891"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-891"><span class="linenos">891</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-892"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-892"><span class="linenos">892</span></a><span class="sd">        - In 1D: The recursion involves spatial derivatives of R and derivatives of p with respect to ξ.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-893"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-893"><span class="linenos">893</span></a><span class="sd">        - In 2D: The multi-index generalization is used with mixed derivatives in ξ and η.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-894"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-894"><span class="linenos">894</span></a><span class="sd">        - The construction relies on the non-vanishing of the principal symbol p to ensure invertibility.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-895"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-895"><span class="linenos">895</span></a><span class="sd">        - Each term in the expansion corresponds to higher-order corrections involving commutators </span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-896"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-896"><span class="linenos">896</span></a><span class="sd">          between the operator P and the current approximation of R.</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-897"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-897"><span class="linenos">897</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-898"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-898"><span class="linenos">898</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-899"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-899"><span class="linenos">899</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-900"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-900"><span class="linenos">900</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-901"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-901"><span class="linenos">901</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-902"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-902"><span class="linenos">902</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>  <span class="c1"># r0</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-903"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-903"><span class="linenos">903</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-904"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-904"><span class="linenos">904</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-905"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-905"><span class="linenos">905</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-906"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-906"><span class="linenos">906</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-907"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-907"><span class="linenos">907</span></a>                    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-908"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-908"><span class="linenos">908</span></a>                    <span class="n">inner</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-909"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-909"><span class="linenos">909</span></a>                    <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">inner</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-910"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-910"><span class="linenos">910</span></a>                <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">r</span> <span class="o">*</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-911"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-911"><span class="linenos">911</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-912"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-912"><span class="linenos">912</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-913"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-913"><span class="linenos">913</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-914"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-914"><span class="linenos">914</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">eta</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-915"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-915"><span class="linenos">915</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-916"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-916"><span class="linenos">916</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-917"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-917"><span class="linenos">917</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-918"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-918"><span class="linenos">918</span></a>                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-919"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-919"><span class="linenos">919</span></a>                    <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-920"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-920"><span class="linenos">920</span></a>                        <span class="k">if</span> <span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-921"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-921"><span class="linenos">921</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-922"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-922"><span class="linenos">922</span></a>                        <span class="n">dp</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-923"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-923"><span class="linenos">923</span></a>                        <span class="n">dR</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-924"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-924"><span class="linenos">924</span></a>                        <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">dR</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-925"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-925"><span class="linenos">925</span></a>                <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">r</span> <span class="o">*</span> <span class="n">term</span>
</span><span id="PseudoDifferentialOperator.right_inverse_asymptotic-926"><a href="#PseudoDifferentialOperator.right_inverse_asymptotic-926"><span class="linenos">926</span></a>        <span class="k">return</span> <span class="n">R</span>
</span></pre></div>


            <div class="docstring"><p>Construct a formal right inverse R of the pseudo-differential operator P such that 
the composition P ∘ R equals the identity plus a smoothing operator of order -order.</p>

<p>This method computes an asymptotic expansion for the right inverse using recursive 
corrections based on derivatives of the symbol p(x, ξ) and lower-order terms of R.</p>

<h2 id="parameters">Parameters</h2>

<p>order : int
    Number of terms to include in the asymptotic expansion. Higher values improve 
    approximation at the cost of complexity and computational effort.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    The symbolic expression representing the formal right inverse R(x, ξ), which satisfies:
    P ∘ R = Id + O(⟨ξ⟩^{-order}), where ⟨ξ⟩ = (1 + |ξ|²)^{1/2}.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D: The recursion involves spatial derivatives of R and derivatives of p with respect to ξ.</li>
<li>In 2D: The multi-index generalization is used with mixed derivatives in ξ and η.</li>
<li>The construction relies on the non-vanishing of the principal symbol p to ensure invertibility.</li>
<li>Each term in the expansion corresponds to higher-order corrections involving commutators 
between the operator P and the current approximation of R.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.left_inverse_asymptotic" class="classattr">
                                        <input id="PseudoDifferentialOperator.left_inverse_asymptotic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">left_inverse_asymptotic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.left_inverse_asymptotic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.left_inverse_asymptotic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-928"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-928"><span class="linenos">928</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">left_inverse_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-929"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-929"><span class="linenos">929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-930"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-930"><span class="linenos">930</span></a><span class="sd">        Construct a formal left inverse L such that the composition L ∘ P equals the identity </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-931"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-931"><span class="linenos">931</span></a><span class="sd">        operator up to terms of order ξ^{-order}. This expansion is performed asymptotically </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-932"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-932"><span class="linenos">932</span></a><span class="sd">        at infinity in the frequency variable(s).</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-933"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-933"><span class="linenos">933</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-934"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-934"><span class="linenos">934</span></a><span class="sd">        The left inverse is built iteratively using symbolic differentiation and the </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-935"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-935"><span class="linenos">935</span></a><span class="sd">        method of asymptotic expansions for pseudo-differential operators. It ensures that:</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-936"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-936"><span class="linenos">936</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-937"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-937"><span class="linenos">937</span></a><span class="sd">            L(P(x,ξ),x,D) ∘ P(x,D) = Id + smoothing operator of order -order</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-938"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-938"><span class="linenos">938</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-939"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-939"><span class="linenos">939</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-940"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-940"><span class="linenos">940</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-941"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-941"><span class="linenos">941</span></a><span class="sd">        order : int, optional</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-942"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-942"><span class="linenos">942</span></a><span class="sd">            Maximum number of terms in the asymptotic expansion (default is 1). Higher values </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-943"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-943"><span class="linenos">943</span></a><span class="sd">            yield more accurate inverses at the cost of increased computational complexity.</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-944"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-944"><span class="linenos">944</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-945"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-945"><span class="linenos">945</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-946"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-946"><span class="linenos">946</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-947"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-947"><span class="linenos">947</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-948"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-948"><span class="linenos">948</span></a><span class="sd">            Symbolic expression representing the principal symbol of the formal left inverse </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-949"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-949"><span class="linenos">949</span></a><span class="sd">            operator L(x,ξ). This expression depends on spatial variables and frequencies, </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-950"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-950"><span class="linenos">950</span></a><span class="sd">            and includes correction terms up to the specified order.</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-951"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-951"><span class="linenos">951</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-952"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-952"><span class="linenos">952</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-953"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-953"><span class="linenos">953</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-954"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-954"><span class="linenos">954</span></a><span class="sd">        - In 1D: Uses recursive application of the Leibniz formula for symbols.</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-955"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-955"><span class="linenos">955</span></a><span class="sd">        - In 2D: Generalizes to multi-indices for mixed derivatives in (x,y) and (ξ,η).</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-956"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-956"><span class="linenos">956</span></a><span class="sd">        - Each term involves combinations of derivatives of the original symbol p(x,ξ) and </span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-957"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-957"><span class="linenos">957</span></a><span class="sd">          previously computed terms of the inverse.</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-958"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-958"><span class="linenos">958</span></a><span class="sd">        - Coefficients include powers of 1j (i) and factorial normalization for derivative terms.</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-959"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-959"><span class="linenos">959</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-960"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-960"><span class="linenos">960</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-961"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-961"><span class="linenos">961</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-962"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-962"><span class="linenos">962</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-963"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-963"><span class="linenos">963</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-964"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-964"><span class="linenos">964</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-965"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-965"><span class="linenos">965</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-966"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-966"><span class="linenos">966</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-967"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-967"><span class="linenos">967</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-968"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-968"><span class="linenos">968</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-969"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-969"><span class="linenos">969</span></a>                    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-970"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-970"><span class="linenos">970</span></a>                    <span class="n">inner</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-971"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-971"><span class="linenos">971</span></a>                    <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">inner</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-972"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-972"><span class="linenos">972</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="n">term</span> <span class="o">*</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-973"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-973"><span class="linenos">973</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-974"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-974"><span class="linenos">974</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-975"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-975"><span class="linenos">975</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-976"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-976"><span class="linenos">976</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">xi</span><span class="p">:</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">eta</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-977"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-977"><span class="linenos">977</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-978"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-978"><span class="linenos">978</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-979"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-979"><span class="linenos">979</span></a>                <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-980"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-980"><span class="linenos">980</span></a>                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-981"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-981"><span class="linenos">981</span></a>                    <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-982"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-982"><span class="linenos">982</span></a>                        <span class="k">if</span> <span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-983"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-983"><span class="linenos">983</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-984"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-984"><span class="linenos">984</span></a>                        <span class="n">dp</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-985"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-985"><span class="linenos">985</span></a>                        <span class="n">dL</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-986"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-986"><span class="linenos">986</span></a>                        <span class="n">term</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">dL</span> <span class="o">*</span> <span class="n">dp</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-987"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-987"><span class="linenos">987</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="n">term</span> <span class="o">*</span> <span class="n">l</span>
</span><span id="PseudoDifferentialOperator.left_inverse_asymptotic-988"><a href="#PseudoDifferentialOperator.left_inverse_asymptotic-988"><span class="linenos">988</span></a>        <span class="k">return</span> <span class="n">L</span>
</span></pre></div>


            <div class="docstring"><p>Construct a formal left inverse L such that the composition L ∘ P equals the identity 
operator up to terms of order ξ^{-order}. This expansion is performed asymptotically 
at infinity in the frequency variable(s).</p>

<p>The left inverse is built iteratively using symbolic differentiation and the 
method of asymptotic expansions for pseudo-differential operators. It ensures that:</p>

<pre><code>L(P(x,ξ),x,D) ∘ P(x,D) = Id + smoothing operator of order -order
</code></pre>

<h2 id="parameters">Parameters</h2>

<p>order : int, optional
    Maximum number of terms in the asymptotic expansion (default is 1). Higher values 
    yield more accurate inverses at the cost of increased computational complexity.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    Symbolic expression representing the principal symbol of the formal left inverse 
    operator L(x,ξ). This expression depends on spatial variables and frequencies, 
    and includes correction terms up to the specified order.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D: Uses recursive application of the Leibniz formula for symbols.</li>
<li>In 2D: Generalizes to multi-indices for mixed derivatives in (x,y) and (ξ,η).</li>
<li>Each term involves combinations of derivatives of the original symbol p(x,ξ) and 
previously computed terms of the inverse.</li>
<li>Coefficients include powers of 1j (i) and factorial normalization for derivative terms.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.formal_adjoint" class="classattr">
                                        <input id="PseudoDifferentialOperator.formal_adjoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">formal_adjoint</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.formal_adjoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.formal_adjoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.formal_adjoint-990"><a href="#PseudoDifferentialOperator.formal_adjoint-990"><span class="linenos"> 990</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">formal_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-991"><a href="#PseudoDifferentialOperator.formal_adjoint-991"><span class="linenos"> 991</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-992"><a href="#PseudoDifferentialOperator.formal_adjoint-992"><span class="linenos"> 992</span></a><span class="sd">        Compute the formal adjoint symbol P* of the pseudo-differential operator.</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-993"><a href="#PseudoDifferentialOperator.formal_adjoint-993"><span class="linenos"> 993</span></a>
</span><span id="PseudoDifferentialOperator.formal_adjoint-994"><a href="#PseudoDifferentialOperator.formal_adjoint-994"><span class="linenos"> 994</span></a><span class="sd">        The adjoint is defined such that for any test functions u and v,</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-995"><a href="#PseudoDifferentialOperator.formal_adjoint-995"><span class="linenos"> 995</span></a><span class="sd">        ⟨P u, v⟩ = ⟨u, P* v⟩ holds in the distributional sense. This is obtained by </span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-996"><a href="#PseudoDifferentialOperator.formal_adjoint-996"><span class="linenos"> 996</span></a><span class="sd">        taking the complex conjugate of the symbol and expanding it asymptotically </span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-997"><a href="#PseudoDifferentialOperator.formal_adjoint-997"><span class="linenos"> 997</span></a><span class="sd">        at infinity to ensure proper behavior under integration by parts.</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-998"><a href="#PseudoDifferentialOperator.formal_adjoint-998"><span class="linenos"> 998</span></a>
</span><span id="PseudoDifferentialOperator.formal_adjoint-999"><a href="#PseudoDifferentialOperator.formal_adjoint-999"><span class="linenos"> 999</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1000"><a href="#PseudoDifferentialOperator.formal_adjoint-1000"><span class="linenos">1000</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1001"><a href="#PseudoDifferentialOperator.formal_adjoint-1001"><span class="linenos">1001</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1002"><a href="#PseudoDifferentialOperator.formal_adjoint-1002"><span class="linenos">1002</span></a><span class="sd">            The adjoint symbol P*(x, ξ) in 1D or P*(x, y, ξ, η) in 2D.</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1003"><a href="#PseudoDifferentialOperator.formal_adjoint-1003"><span class="linenos">1003</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1004"><a href="#PseudoDifferentialOperator.formal_adjoint-1004"><span class="linenos">1004</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1005"><a href="#PseudoDifferentialOperator.formal_adjoint-1005"><span class="linenos">1005</span></a><span class="sd">        - In 1D, the expansion is performed in powers of 1/|ξ|.</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1006"><a href="#PseudoDifferentialOperator.formal_adjoint-1006"><span class="linenos">1006</span></a><span class="sd">        - In 2D, the expansion is radial in |ξ| = sqrt(ξ² + η²).</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1007"><a href="#PseudoDifferentialOperator.formal_adjoint-1007"><span class="linenos">1007</span></a><span class="sd">        - This method ensures symbolic simplifications for readability and efficiency.</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1008"><a href="#PseudoDifferentialOperator.formal_adjoint-1008"><span class="linenos">1008</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1009"><a href="#PseudoDifferentialOperator.formal_adjoint-1009"><span class="linenos">1009</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1010"><a href="#PseudoDifferentialOperator.formal_adjoint-1010"><span class="linenos">1010</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1011"><a href="#PseudoDifferentialOperator.formal_adjoint-1011"><span class="linenos">1011</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1012"><a href="#PseudoDifferentialOperator.formal_adjoint-1012"><span class="linenos">1012</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1013"><a href="#PseudoDifferentialOperator.formal_adjoint-1013"><span class="linenos">1013</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1014"><a href="#PseudoDifferentialOperator.formal_adjoint-1014"><span class="linenos">1014</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">series</span><span class="p">(</span><span class="n">p_star</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">())</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1015"><a href="#PseudoDifferentialOperator.formal_adjoint-1015"><span class="linenos">1015</span></a>            <span class="k">return</span> <span class="n">p_star</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1016"><a href="#PseudoDifferentialOperator.formal_adjoint-1016"><span class="linenos">1016</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1017"><a href="#PseudoDifferentialOperator.formal_adjoint-1017"><span class="linenos">1017</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1018"><a href="#PseudoDifferentialOperator.formal_adjoint-1018"><span class="linenos">1018</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1019"><a href="#PseudoDifferentialOperator.formal_adjoint-1019"><span class="linenos">1019</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1020"><a href="#PseudoDifferentialOperator.formal_adjoint-1020"><span class="linenos">1020</span></a>            <span class="n">p_star</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">series</span><span class="p">(</span><span class="n">p_star</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">oo</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">())</span>
</span><span id="PseudoDifferentialOperator.formal_adjoint-1021"><a href="#PseudoDifferentialOperator.formal_adjoint-1021"><span class="linenos">1021</span></a>            <span class="k">return</span> <span class="n">p_star</span>
</span></pre></div>


            <div class="docstring"><p>Compute the formal adjoint symbol P* of the pseudo-differential operator.</p>

<p>The adjoint is defined such that for any test functions u and v,
⟨P u, v⟩ = ⟨u, P* v⟩ holds in the distributional sense. This is obtained by 
taking the complex conjugate of the symbol and expanding it asymptotically 
at infinity to ensure proper behavior under integration by parts.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    The adjoint symbol P<em>(x, ξ) in 1D or P</em>(x, y, ξ, η) in 2D.</p>

<p>Notes:</p>

<ul>
<li>In 1D, the expansion is performed in powers of 1/|ξ|.</li>
<li>In 2D, the expansion is radial in |ξ| = sqrt(ξ² + η²).</li>
<li>This method ensures symbolic simplifications for readability and efficiency.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.exponential_symbol" class="classattr">
                                        <input id="PseudoDifferentialOperator.exponential_symbol-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">exponential_symbol</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">t</span><span class="o">=</span><span class="mf">1.0</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span>, </span><span class="param"><span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.exponential_symbol-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.exponential_symbol"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.exponential_symbol-1023"><a href="#PseudoDifferentialOperator.exponential_symbol-1023"><span class="linenos">1023</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exponential_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kn&#39;</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1024"><a href="#PseudoDifferentialOperator.exponential_symbol-1024"><span class="linenos">1024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1025"><a href="#PseudoDifferentialOperator.exponential_symbol-1025"><span class="linenos">1025</span></a><span class="sd">        Compute the symbol of exp(tP) using asymptotic expansion methods.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1026"><a href="#PseudoDifferentialOperator.exponential_symbol-1026"><span class="linenos">1026</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1027"><a href="#PseudoDifferentialOperator.exponential_symbol-1027"><span class="linenos">1027</span></a><span class="sd">        This method calculates the exponential of a pseudo-differential operator </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1028"><a href="#PseudoDifferentialOperator.exponential_symbol-1028"><span class="linenos">1028</span></a><span class="sd">        using either a direct power series expansion or a Magnus expansion, </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1029"><a href="#PseudoDifferentialOperator.exponential_symbol-1029"><span class="linenos">1029</span></a><span class="sd">        depending on the structure of the symbol. The result is valid up to </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1030"><a href="#PseudoDifferentialOperator.exponential_symbol-1030"><span class="linenos">1030</span></a><span class="sd">        the specified asymptotic order.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1031"><a href="#PseudoDifferentialOperator.exponential_symbol-1031"><span class="linenos">1031</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1032"><a href="#PseudoDifferentialOperator.exponential_symbol-1032"><span class="linenos">1032</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1033"><a href="#PseudoDifferentialOperator.exponential_symbol-1033"><span class="linenos">1033</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1034"><a href="#PseudoDifferentialOperator.exponential_symbol-1034"><span class="linenos">1034</span></a><span class="sd">        t : float or sympy.Symbol, default=1.0</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1035"><a href="#PseudoDifferentialOperator.exponential_symbol-1035"><span class="linenos">1035</span></a><span class="sd">            Time or evolution parameter. Common uses:</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1036"><a href="#PseudoDifferentialOperator.exponential_symbol-1036"><span class="linenos">1036</span></a><span class="sd">            - t = -i*τ for Schrödinger evolution: exp(-iτH)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1037"><a href="#PseudoDifferentialOperator.exponential_symbol-1037"><span class="linenos">1037</span></a><span class="sd">            - t = τ for heat/diffusion: exp(τΔ)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1038"><a href="#PseudoDifferentialOperator.exponential_symbol-1038"><span class="linenos">1038</span></a><span class="sd">            - t for general propagators</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1039"><a href="#PseudoDifferentialOperator.exponential_symbol-1039"><span class="linenos">1039</span></a><span class="sd">        order : int, default=3</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1040"><a href="#PseudoDifferentialOperator.exponential_symbol-1040"><span class="linenos">1040</span></a><span class="sd">            Maximum order of the asymptotic expansion. Higher orders include </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1041"><a href="#PseudoDifferentialOperator.exponential_symbol-1041"><span class="linenos">1041</span></a><span class="sd">            more composition terms, improving accuracy for small t or when </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1042"><a href="#PseudoDifferentialOperator.exponential_symbol-1042"><span class="linenos">1042</span></a><span class="sd">            non-commutativity effects are significant.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1043"><a href="#PseudoDifferentialOperator.exponential_symbol-1043"><span class="linenos">1043</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1044"><a href="#PseudoDifferentialOperator.exponential_symbol-1044"><span class="linenos">1044</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1045"><a href="#PseudoDifferentialOperator.exponential_symbol-1045"><span class="linenos">1045</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1046"><a href="#PseudoDifferentialOperator.exponential_symbol-1046"><span class="linenos">1046</span></a><span class="sd">        sympy.Expr</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1047"><a href="#PseudoDifferentialOperator.exponential_symbol-1047"><span class="linenos">1047</span></a><span class="sd">            Symbolic expression for the exponential operator symbol, computed </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1048"><a href="#PseudoDifferentialOperator.exponential_symbol-1048"><span class="linenos">1048</span></a><span class="sd">            as an asymptotic series up to the specified order.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1049"><a href="#PseudoDifferentialOperator.exponential_symbol-1049"><span class="linenos">1049</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1050"><a href="#PseudoDifferentialOperator.exponential_symbol-1050"><span class="linenos">1050</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1051"><a href="#PseudoDifferentialOperator.exponential_symbol-1051"><span class="linenos">1051</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1052"><a href="#PseudoDifferentialOperator.exponential_symbol-1052"><span class="linenos">1052</span></a><span class="sd">        - For commutative symbols (e.g., pure multiplication operators), the </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1053"><a href="#PseudoDifferentialOperator.exponential_symbol-1053"><span class="linenos">1053</span></a><span class="sd">          exponential is exact: exp(tP) = exp(t*p(x,ξ)).</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1054"><a href="#PseudoDifferentialOperator.exponential_symbol-1054"><span class="linenos">1054</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1055"><a href="#PseudoDifferentialOperator.exponential_symbol-1055"><span class="linenos">1055</span></a><span class="sd">        - For general non-commutative operators, the method uses the BCH-type </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1056"><a href="#PseudoDifferentialOperator.exponential_symbol-1056"><span class="linenos">1056</span></a><span class="sd">          expansion via iterated composition:</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1057"><a href="#PseudoDifferentialOperator.exponential_symbol-1057"><span class="linenos">1057</span></a><span class="sd">          exp(tP) ~ I + tP + (t²/2!)P∘P + (t³/3!)P∘P∘P + ...</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1058"><a href="#PseudoDifferentialOperator.exponential_symbol-1058"><span class="linenos">1058</span></a><span class="sd">          </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1059"><a href="#PseudoDifferentialOperator.exponential_symbol-1059"><span class="linenos">1059</span></a><span class="sd">        - Each power P^n is computed via compose_asymptotic, which accounts </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1060"><a href="#PseudoDifferentialOperator.exponential_symbol-1060"><span class="linenos">1060</span></a><span class="sd">          for the non-commutativity through derivative terms.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1061"><a href="#PseudoDifferentialOperator.exponential_symbol-1061"><span class="linenos">1061</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1062"><a href="#PseudoDifferentialOperator.exponential_symbol-1062"><span class="linenos">1062</span></a><span class="sd">        - The expansion is valid for |t| small enough or when the symbol has </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1063"><a href="#PseudoDifferentialOperator.exponential_symbol-1063"><span class="linenos">1063</span></a><span class="sd">          appropriate decay/growth properties.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1064"><a href="#PseudoDifferentialOperator.exponential_symbol-1064"><span class="linenos">1064</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1065"><a href="#PseudoDifferentialOperator.exponential_symbol-1065"><span class="linenos">1065</span></a><span class="sd">        - In quantum mechanics (Schrödinger): U(t) = exp(-itH/ℏ) represents </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1066"><a href="#PseudoDifferentialOperator.exponential_symbol-1066"><span class="linenos">1066</span></a><span class="sd">          the time evolution operator.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1067"><a href="#PseudoDifferentialOperator.exponential_symbol-1067"><span class="linenos">1067</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1068"><a href="#PseudoDifferentialOperator.exponential_symbol-1068"><span class="linenos">1068</span></a><span class="sd">        - In parabolic PDEs (heat equation): exp(tΔ) is the heat kernel.</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1069"><a href="#PseudoDifferentialOperator.exponential_symbol-1069"><span class="linenos">1069</span></a>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1070"><a href="#PseudoDifferentialOperator.exponential_symbol-1070"><span class="linenos">1070</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1071"><a href="#PseudoDifferentialOperator.exponential_symbol-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1072"><a href="#PseudoDifferentialOperator.exponential_symbol-1072"><span class="linenos">1072</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1073"><a href="#PseudoDifferentialOperator.exponential_symbol-1073"><span class="linenos">1073</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1074"><a href="#PseudoDifferentialOperator.exponential_symbol-1074"><span class="linenos">1074</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1075"><a href="#PseudoDifferentialOperator.exponential_symbol-1075"><span class="linenos">1075</span></a>            <span class="c1"># Initialize with identity</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1076"><a href="#PseudoDifferentialOperator.exponential_symbol-1076"><span class="linenos">1076</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1077"><a href="#PseudoDifferentialOperator.exponential_symbol-1077"><span class="linenos">1077</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1078"><a href="#PseudoDifferentialOperator.exponential_symbol-1078"><span class="linenos">1078</span></a>            <span class="c1"># First order term: tP</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1079"><a href="#PseudoDifferentialOperator.exponential_symbol-1079"><span class="linenos">1079</span></a>            <span class="n">current_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1080"><a href="#PseudoDifferentialOperator.exponential_symbol-1080"><span class="linenos">1080</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1081"><a href="#PseudoDifferentialOperator.exponential_symbol-1081"><span class="linenos">1081</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1082"><a href="#PseudoDifferentialOperator.exponential_symbol-1082"><span class="linenos">1082</span></a>            <span class="c1"># Higher order terms: (t^n/n!) P^n computed via composition</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1083"><a href="#PseudoDifferentialOperator.exponential_symbol-1083"><span class="linenos">1083</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1084"><a href="#PseudoDifferentialOperator.exponential_symbol-1084"><span class="linenos">1084</span></a>                <span class="c1"># Compute P^n = P^(n-1) ∘ P via asymptotic composition</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1085"><a href="#PseudoDifferentialOperator.exponential_symbol-1085"><span class="linenos">1085</span></a>                <span class="c1"># We use a temporary operator for composition</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1086"><a href="#PseudoDifferentialOperator.exponential_symbol-1086"><span class="linenos">1086</span></a>                <span class="n">temp_op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1087"><a href="#PseudoDifferentialOperator.exponential_symbol-1087"><span class="linenos">1087</span></a>                    <span class="n">current_power</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1088"><a href="#PseudoDifferentialOperator.exponential_symbol-1088"><span class="linenos">1088</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1089"><a href="#PseudoDifferentialOperator.exponential_symbol-1089"><span class="linenos">1089</span></a>                <span class="n">current_power</span> <span class="o">=</span> <span class="n">temp_op</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1090"><a href="#PseudoDifferentialOperator.exponential_symbol-1090"><span class="linenos">1090</span></a>                
</span><span id="PseudoDifferentialOperator.exponential_symbol-1091"><a href="#PseudoDifferentialOperator.exponential_symbol-1091"><span class="linenos">1091</span></a>                <span class="c1"># Add term (t^n/n!) * P^n</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1092"><a href="#PseudoDifferentialOperator.exponential_symbol-1092"><span class="linenos">1092</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">t</span><span class="o">**</span><span class="n">n</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1093"><a href="#PseudoDifferentialOperator.exponential_symbol-1093"><span class="linenos">1093</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1094"><a href="#PseudoDifferentialOperator.exponential_symbol-1094"><span class="linenos">1094</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1095"><a href="#PseudoDifferentialOperator.exponential_symbol-1095"><span class="linenos">1095</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1096"><a href="#PseudoDifferentialOperator.exponential_symbol-1096"><span class="linenos">1096</span></a>        
</span><span id="PseudoDifferentialOperator.exponential_symbol-1097"><a href="#PseudoDifferentialOperator.exponential_symbol-1097"><span class="linenos">1097</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1098"><a href="#PseudoDifferentialOperator.exponential_symbol-1098"><span class="linenos">1098</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1099"><a href="#PseudoDifferentialOperator.exponential_symbol-1099"><span class="linenos">1099</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1100"><a href="#PseudoDifferentialOperator.exponential_symbol-1100"><span class="linenos">1100</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1101"><a href="#PseudoDifferentialOperator.exponential_symbol-1101"><span class="linenos">1101</span></a>            <span class="c1"># Initialize with identity</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1102"><a href="#PseudoDifferentialOperator.exponential_symbol-1102"><span class="linenos">1102</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1103"><a href="#PseudoDifferentialOperator.exponential_symbol-1103"><span class="linenos">1103</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1104"><a href="#PseudoDifferentialOperator.exponential_symbol-1104"><span class="linenos">1104</span></a>            <span class="c1"># First order term: tP</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1105"><a href="#PseudoDifferentialOperator.exponential_symbol-1105"><span class="linenos">1105</span></a>            <span class="n">current_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1106"><a href="#PseudoDifferentialOperator.exponential_symbol-1106"><span class="linenos">1106</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1107"><a href="#PseudoDifferentialOperator.exponential_symbol-1107"><span class="linenos">1107</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1108"><a href="#PseudoDifferentialOperator.exponential_symbol-1108"><span class="linenos">1108</span></a>            <span class="c1"># Higher order terms: (t^n/n!) P^n computed via composition</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1109"><a href="#PseudoDifferentialOperator.exponential_symbol-1109"><span class="linenos">1109</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1110"><a href="#PseudoDifferentialOperator.exponential_symbol-1110"><span class="linenos">1110</span></a>                <span class="c1"># Compute P^n = P^(n-1) ∘ P via asymptotic composition</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1111"><a href="#PseudoDifferentialOperator.exponential_symbol-1111"><span class="linenos">1111</span></a>                <span class="n">temp_op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1112"><a href="#PseudoDifferentialOperator.exponential_symbol-1112"><span class="linenos">1112</span></a>                    <span class="n">current_power</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1113"><a href="#PseudoDifferentialOperator.exponential_symbol-1113"><span class="linenos">1113</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1114"><a href="#PseudoDifferentialOperator.exponential_symbol-1114"><span class="linenos">1114</span></a>                <span class="n">current_power</span> <span class="o">=</span> <span class="n">temp_op</span><span class="o">.</span><span class="n">compose_asymptotic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sign_convention</span><span class="o">=</span><span class="n">sign_convention</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1115"><a href="#PseudoDifferentialOperator.exponential_symbol-1115"><span class="linenos">1115</span></a>                
</span><span id="PseudoDifferentialOperator.exponential_symbol-1116"><a href="#PseudoDifferentialOperator.exponential_symbol-1116"><span class="linenos">1116</span></a>                <span class="c1"># Add term (t^n/n!) * P^n</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1117"><a href="#PseudoDifferentialOperator.exponential_symbol-1117"><span class="linenos">1117</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">t</span><span class="o">**</span><span class="n">n</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1118"><a href="#PseudoDifferentialOperator.exponential_symbol-1118"><span class="linenos">1118</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">current_power</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1119"><a href="#PseudoDifferentialOperator.exponential_symbol-1119"><span class="linenos">1119</span></a>            
</span><span id="PseudoDifferentialOperator.exponential_symbol-1120"><a href="#PseudoDifferentialOperator.exponential_symbol-1120"><span class="linenos">1120</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1121"><a href="#PseudoDifferentialOperator.exponential_symbol-1121"><span class="linenos">1121</span></a>        
</span><span id="PseudoDifferentialOperator.exponential_symbol-1122"><a href="#PseudoDifferentialOperator.exponential_symbol-1122"><span class="linenos">1122</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.exponential_symbol-1123"><a href="#PseudoDifferentialOperator.exponential_symbol-1123"><span class="linenos">1123</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D operators are supported&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the symbol of exp(tP) using asymptotic expansion methods.</p>

<p>This method calculates the exponential of a pseudo-differential operator 
using either a direct power series expansion or a Magnus expansion, 
depending on the structure of the symbol. The result is valid up to 
the specified asymptotic order.</p>

<h2 id="parameters">Parameters</h2>

<p>t : float or sympy.Symbol, default=1.0
    Time or evolution parameter. Common uses:
    - t = -i*τ for Schrödinger evolution: exp(-iτH)
    - t = τ for heat/diffusion: exp(τΔ)
    - t for general propagators
order : int, default=3
    Maximum order of the asymptotic expansion. Higher orders include 
    more composition terms, improving accuracy for small t or when 
    non-commutativity effects are significant.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr
    Symbolic expression for the exponential operator symbol, computed 
    as an asymptotic series up to the specified order.</p>

<h2 id="notes">Notes</h2>

<ul>
<li><p>For commutative symbols (e.g., pure multiplication operators), the 
exponential is exact: exp(tP) = exp(t*p(x,ξ)).</p></li>
<li><p>For general non-commutative operators, the method uses the BCH-type 
expansion via iterated composition:
exp(tP) ~ I + tP + (t²/2!)P∘P + (t³/3!)P∘P∘P + ...</p></li>
<li><p>Each power P^n is computed via compose_asymptotic, which accounts 
for the non-commutativity through derivative terms.</p></li>
<li><p>The expansion is valid for |t| small enough or when the symbol has 
appropriate decay/growth properties.</p></li>
<li><p>In quantum mechanics (Schrödinger): U(t) = exp(-itH/ℏ) represents 
the time evolution operator.</p></li>
<li><p>In parabolic PDEs (heat equation): exp(tΔ) is the heat kernel.</p></li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.trace_formula" class="classattr">
                                        <input id="PseudoDifferentialOperator.trace_formula-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">trace_formula</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">volume_element</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">numerical</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">x_bounds</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">xi_bounds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.trace_formula-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.trace_formula"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.trace_formula-1125"><a href="#PseudoDifferentialOperator.trace_formula-1125"><span class="linenos">1125</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trace_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numerical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator.trace_formula-1126"><a href="#PseudoDifferentialOperator.trace_formula-1126"><span class="linenos">1126</span></a>                      <span class="n">x_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1127"><a href="#PseudoDifferentialOperator.trace_formula-1127"><span class="linenos">1127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1128"><a href="#PseudoDifferentialOperator.trace_formula-1128"><span class="linenos">1128</span></a><span class="sd">        Compute the semiclassical trace of the pseudo-differential operator.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1129"><a href="#PseudoDifferentialOperator.trace_formula-1129"><span class="linenos">1129</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1130"><a href="#PseudoDifferentialOperator.trace_formula-1130"><span class="linenos">1130</span></a><span class="sd">        The trace formula relates the quantum trace of an operator to a </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1131"><a href="#PseudoDifferentialOperator.trace_formula-1131"><span class="linenos">1131</span></a><span class="sd">        phase-space integral of its symbol, providing a fundamental link </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1132"><a href="#PseudoDifferentialOperator.trace_formula-1132"><span class="linenos">1132</span></a><span class="sd">        between classical and quantum mechanics. This implementation supports </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1133"><a href="#PseudoDifferentialOperator.trace_formula-1133"><span class="linenos">1133</span></a><span class="sd">        both symbolic and numerical integration.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1134"><a href="#PseudoDifferentialOperator.trace_formula-1134"><span class="linenos">1134</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1135"><a href="#PseudoDifferentialOperator.trace_formula-1135"><span class="linenos">1135</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1136"><a href="#PseudoDifferentialOperator.trace_formula-1136"><span class="linenos">1136</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1137"><a href="#PseudoDifferentialOperator.trace_formula-1137"><span class="linenos">1137</span></a><span class="sd">        volume_element : sympy.Expr, optional</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1138"><a href="#PseudoDifferentialOperator.trace_formula-1138"><span class="linenos">1138</span></a><span class="sd">            Custom volume element for the phase space integration. If None, </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1139"><a href="#PseudoDifferentialOperator.trace_formula-1139"><span class="linenos">1139</span></a><span class="sd">            uses the standard Liouville measure dx dξ/(2π)^d.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1140"><a href="#PseudoDifferentialOperator.trace_formula-1140"><span class="linenos">1140</span></a><span class="sd">        numerical : bool, default=False</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1141"><a href="#PseudoDifferentialOperator.trace_formula-1141"><span class="linenos">1141</span></a><span class="sd">            If True, perform numerical integration over specified bounds.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1142"><a href="#PseudoDifferentialOperator.trace_formula-1142"><span class="linenos">1142</span></a><span class="sd">            If False, attempt symbolic integration (may fail for complex symbols).</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1143"><a href="#PseudoDifferentialOperator.trace_formula-1143"><span class="linenos">1143</span></a><span class="sd">        x_bounds : tuple of tuples, optional</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1144"><a href="#PseudoDifferentialOperator.trace_formula-1144"><span class="linenos">1144</span></a><span class="sd">            Spatial integration bounds. For 1D: ((x_min, x_max),)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1145"><a href="#PseudoDifferentialOperator.trace_formula-1145"><span class="linenos">1145</span></a><span class="sd">            For 2D: ((x_min, x_max), (y_min, y_max))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1146"><a href="#PseudoDifferentialOperator.trace_formula-1146"><span class="linenos">1146</span></a><span class="sd">            Required if numerical=True.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1147"><a href="#PseudoDifferentialOperator.trace_formula-1147"><span class="linenos">1147</span></a><span class="sd">        xi_bounds : tuple of tuples, optional</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1148"><a href="#PseudoDifferentialOperator.trace_formula-1148"><span class="linenos">1148</span></a><span class="sd">            Frequency integration bounds. For 1D: ((xi_min, xi_max),)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1149"><a href="#PseudoDifferentialOperator.trace_formula-1149"><span class="linenos">1149</span></a><span class="sd">            For 2D: ((xi_min, xi_max), (eta_min, eta_max))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1150"><a href="#PseudoDifferentialOperator.trace_formula-1150"><span class="linenos">1150</span></a><span class="sd">            Required if numerical=True.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1151"><a href="#PseudoDifferentialOperator.trace_formula-1151"><span class="linenos">1151</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1152"><a href="#PseudoDifferentialOperator.trace_formula-1152"><span class="linenos">1152</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1153"><a href="#PseudoDifferentialOperator.trace_formula-1153"><span class="linenos">1153</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1154"><a href="#PseudoDifferentialOperator.trace_formula-1154"><span class="linenos">1154</span></a><span class="sd">        sympy.Expr or float</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1155"><a href="#PseudoDifferentialOperator.trace_formula-1155"><span class="linenos">1155</span></a><span class="sd">            The trace of the operator. Returns a symbolic expression if </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1156"><a href="#PseudoDifferentialOperator.trace_formula-1156"><span class="linenos">1156</span></a><span class="sd">            numerical=False, or a float if numerical=True.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1157"><a href="#PseudoDifferentialOperator.trace_formula-1157"><span class="linenos">1157</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1158"><a href="#PseudoDifferentialOperator.trace_formula-1158"><span class="linenos">1158</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1159"><a href="#PseudoDifferentialOperator.trace_formula-1159"><span class="linenos">1159</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1160"><a href="#PseudoDifferentialOperator.trace_formula-1160"><span class="linenos">1160</span></a><span class="sd">        - The semiclassical trace formula states:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1161"><a href="#PseudoDifferentialOperator.trace_formula-1161"><span class="linenos">1161</span></a><span class="sd">          Tr(P) = (2π)^{-d} ∫∫ p(x,ξ) dx dξ</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1162"><a href="#PseudoDifferentialOperator.trace_formula-1162"><span class="linenos">1162</span></a><span class="sd">          where d is the spatial dimension and p(x,ξ) is the operator symbol.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1163"><a href="#PseudoDifferentialOperator.trace_formula-1163"><span class="linenos">1163</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1164"><a href="#PseudoDifferentialOperator.trace_formula-1164"><span class="linenos">1164</span></a><span class="sd">        - For 1D: Tr(P) = (1/2π) ∫_{-∞}^{∞} ∫_{-∞}^{∞} p(x,ξ) dx dξ</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1165"><a href="#PseudoDifferentialOperator.trace_formula-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1166"><a href="#PseudoDifferentialOperator.trace_formula-1166"><span class="linenos">1166</span></a><span class="sd">        - For 2D: Tr(P) = (1/4π²) ∫∫∫∫ p(x,y,ξ,η) dx dy dξ dη</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1167"><a href="#PseudoDifferentialOperator.trace_formula-1167"><span class="linenos">1167</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1168"><a href="#PseudoDifferentialOperator.trace_formula-1168"><span class="linenos">1168</span></a><span class="sd">        - This formula is exact for trace-class operators and provides an </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1169"><a href="#PseudoDifferentialOperator.trace_formula-1169"><span class="linenos">1169</span></a><span class="sd">          asymptotic approximation for general pseudo-differential operators.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1170"><a href="#PseudoDifferentialOperator.trace_formula-1170"><span class="linenos">1170</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1171"><a href="#PseudoDifferentialOperator.trace_formula-1171"><span class="linenos">1171</span></a><span class="sd">        - Physical interpretation: the trace counts the &quot;number of states&quot; </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1172"><a href="#PseudoDifferentialOperator.trace_formula-1172"><span class="linenos">1172</span></a><span class="sd">          weighted by the observable p(x,ξ).</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1173"><a href="#PseudoDifferentialOperator.trace_formula-1173"><span class="linenos">1173</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1174"><a href="#PseudoDifferentialOperator.trace_formula-1174"><span class="linenos">1174</span></a><span class="sd">        - For projection operators (χ_Ω with χ² = χ), the trace gives the </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1175"><a href="#PseudoDifferentialOperator.trace_formula-1175"><span class="linenos">1175</span></a><span class="sd">          dimension of the range, related to the phase space volume of Ω.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1176"><a href="#PseudoDifferentialOperator.trace_formula-1176"><span class="linenos">1176</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1177"><a href="#PseudoDifferentialOperator.trace_formula-1177"><span class="linenos">1177</span></a><span class="sd">        - The factor (2π)^{-d} comes from the quantum normalization of </span>
</span><span id="PseudoDifferentialOperator.trace_formula-1178"><a href="#PseudoDifferentialOperator.trace_formula-1178"><span class="linenos">1178</span></a><span class="sd">          coherent states / Weyl quantization.</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1179"><a href="#PseudoDifferentialOperator.trace_formula-1179"><span class="linenos">1179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1180"><a href="#PseudoDifferentialOperator.trace_formula-1180"><span class="linenos">1180</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">lambdify</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1181"><a href="#PseudoDifferentialOperator.trace_formula-1181"><span class="linenos">1181</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">dblquad</span><span class="p">,</span> <span class="n">nquad</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1182"><a href="#PseudoDifferentialOperator.trace_formula-1182"><span class="linenos">1182</span></a>        
</span><span id="PseudoDifferentialOperator.trace_formula-1183"><a href="#PseudoDifferentialOperator.trace_formula-1183"><span class="linenos">1183</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1184"><a href="#PseudoDifferentialOperator.trace_formula-1184"><span class="linenos">1184</span></a>        
</span><span id="PseudoDifferentialOperator.trace_formula-1185"><a href="#PseudoDifferentialOperator.trace_formula-1185"><span class="linenos">1185</span></a>        <span class="k">if</span> <span class="n">numerical</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1186"><a href="#PseudoDifferentialOperator.trace_formula-1186"><span class="linenos">1186</span></a>            <span class="k">if</span> <span class="n">x_bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xi_bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1187"><a href="#PseudoDifferentialOperator.trace_formula-1187"><span class="linenos">1187</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1188"><a href="#PseudoDifferentialOperator.trace_formula-1188"><span class="linenos">1188</span></a>                    <span class="s2">&quot;x_bounds and xi_bounds must be provided for numerical integration&quot;</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1189"><a href="#PseudoDifferentialOperator.trace_formula-1189"><span class="linenos">1189</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1190"><a href="#PseudoDifferentialOperator.trace_formula-1190"><span class="linenos">1190</span></a>        
</span><span id="PseudoDifferentialOperator.trace_formula-1191"><a href="#PseudoDifferentialOperator.trace_formula-1191"><span class="linenos">1191</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1192"><a href="#PseudoDifferentialOperator.trace_formula-1192"><span class="linenos">1192</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1193"><a href="#PseudoDifferentialOperator.trace_formula-1193"><span class="linenos">1193</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1194"><a href="#PseudoDifferentialOperator.trace_formula-1194"><span class="linenos">1194</span></a>            
</span><span id="PseudoDifferentialOperator.trace_formula-1195"><a href="#PseudoDifferentialOperator.trace_formula-1195"><span class="linenos">1195</span></a>            <span class="k">if</span> <span class="n">volume_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1196"><a href="#PseudoDifferentialOperator.trace_formula-1196"><span class="linenos">1196</span></a>                <span class="n">volume_element</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1197"><a href="#PseudoDifferentialOperator.trace_formula-1197"><span class="linenos">1197</span></a>            
</span><span id="PseudoDifferentialOperator.trace_formula-1198"><a href="#PseudoDifferentialOperator.trace_formula-1198"><span class="linenos">1198</span></a>            <span class="k">if</span> <span class="n">numerical</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1199"><a href="#PseudoDifferentialOperator.trace_formula-1199"><span class="linenos">1199</span></a>                <span class="c1"># Numerical integration</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1200"><a href="#PseudoDifferentialOperator.trace_formula-1200"><span class="linenos">1200</span></a>                <span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1201"><a href="#PseudoDifferentialOperator.trace_formula-1201"><span class="linenos">1201</span></a>                <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="o">=</span> <span class="n">x_bounds</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1202"><a href="#PseudoDifferentialOperator.trace_formula-1202"><span class="linenos">1202</span></a>                <span class="p">(</span><span class="n">xi_min</span><span class="p">,</span> <span class="n">xi_max</span><span class="p">),</span> <span class="o">=</span> <span class="n">xi_bounds</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1203"><a href="#PseudoDifferentialOperator.trace_formula-1203"><span class="linenos">1203</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1204"><a href="#PseudoDifferentialOperator.trace_formula-1204"><span class="linenos">1204</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">integrand</span><span class="p">(</span><span class="n">xi_val</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1205"><a href="#PseudoDifferentialOperator.trace_formula-1205"><span class="linenos">1205</span></a>                    <span class="k">return</span> <span class="n">p_func</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1206"><a href="#PseudoDifferentialOperator.trace_formula-1206"><span class="linenos">1206</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1207"><a href="#PseudoDifferentialOperator.trace_formula-1207"><span class="linenos">1207</span></a>                <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">dblquad</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1208"><a href="#PseudoDifferentialOperator.trace_formula-1208"><span class="linenos">1208</span></a>                    <span class="n">integrand</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1209"><a href="#PseudoDifferentialOperator.trace_formula-1209"><span class="linenos">1209</span></a>                    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1210"><a href="#PseudoDifferentialOperator.trace_formula-1210"><span class="linenos">1210</span></a>                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">xi_min</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">xi_max</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1211"><a href="#PseudoDifferentialOperator.trace_formula-1211"><span class="linenos">1211</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1212"><a href="#PseudoDifferentialOperator.trace_formula-1212"><span class="linenos">1212</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1213"><a href="#PseudoDifferentialOperator.trace_formula-1213"><span class="linenos">1213</span></a>                <span class="n">result</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">volume_element</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1214"><a href="#PseudoDifferentialOperator.trace_formula-1214"><span class="linenos">1214</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numerical trace = </span><span class="si">{</span><span class="n">result</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1215"><a href="#PseudoDifferentialOperator.trace_formula-1215"><span class="linenos">1215</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1216"><a href="#PseudoDifferentialOperator.trace_formula-1216"><span class="linenos">1216</span></a>            
</span><span id="PseudoDifferentialOperator.trace_formula-1217"><a href="#PseudoDifferentialOperator.trace_formula-1217"><span class="linenos">1217</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1218"><a href="#PseudoDifferentialOperator.trace_formula-1218"><span class="linenos">1218</span></a>                <span class="c1"># Symbolic integration</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1219"><a href="#PseudoDifferentialOperator.trace_formula-1219"><span class="linenos">1219</span></a>                <span class="n">integrand</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">volume_element</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1220"><a href="#PseudoDifferentialOperator.trace_formula-1220"><span class="linenos">1220</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1221"><a href="#PseudoDifferentialOperator.trace_formula-1221"><span class="linenos">1221</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1222"><a href="#PseudoDifferentialOperator.trace_formula-1222"><span class="linenos">1222</span></a>                    <span class="c1"># Try to integrate over xi first, then x</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1223"><a href="#PseudoDifferentialOperator.trace_formula-1223"><span class="linenos">1223</span></a>                    <span class="n">integral_xi</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1224"><a href="#PseudoDifferentialOperator.trace_formula-1224"><span class="linenos">1224</span></a>                    <span class="n">integral_x</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_xi</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1225"><a href="#PseudoDifferentialOperator.trace_formula-1225"><span class="linenos">1225</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">integral_x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1226"><a href="#PseudoDifferentialOperator.trace_formula-1226"><span class="linenos">1226</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1227"><a href="#PseudoDifferentialOperator.trace_formula-1227"><span class="linenos">1227</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Symbolic integration failed. Try numerical=True&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1228"><a href="#PseudoDifferentialOperator.trace_formula-1228"><span class="linenos">1228</span></a>                    <span class="k">return</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1229"><a href="#PseudoDifferentialOperator.trace_formula-1229"><span class="linenos">1229</span></a>        
</span><span id="PseudoDifferentialOperator.trace_formula-1230"><a href="#PseudoDifferentialOperator.trace_formula-1230"><span class="linenos">1230</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1231"><a href="#PseudoDifferentialOperator.trace_formula-1231"><span class="linenos">1231</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1232"><a href="#PseudoDifferentialOperator.trace_formula-1232"><span class="linenos">1232</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1233"><a href="#PseudoDifferentialOperator.trace_formula-1233"><span class="linenos">1233</span></a>            
</span><span id="PseudoDifferentialOperator.trace_formula-1234"><a href="#PseudoDifferentialOperator.trace_formula-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="n">volume_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1235"><a href="#PseudoDifferentialOperator.trace_formula-1235"><span class="linenos">1235</span></a>                <span class="n">volume_element</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1236"><a href="#PseudoDifferentialOperator.trace_formula-1236"><span class="linenos">1236</span></a>            
</span><span id="PseudoDifferentialOperator.trace_formula-1237"><a href="#PseudoDifferentialOperator.trace_formula-1237"><span class="linenos">1237</span></a>            <span class="k">if</span> <span class="n">numerical</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1238"><a href="#PseudoDifferentialOperator.trace_formula-1238"><span class="linenos">1238</span></a>                <span class="c1"># Numerical integration in 4D</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1239"><a href="#PseudoDifferentialOperator.trace_formula-1239"><span class="linenos">1239</span></a>                <span class="n">p_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1240"><a href="#PseudoDifferentialOperator.trace_formula-1240"><span class="linenos">1240</span></a>                <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_bounds</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1241"><a href="#PseudoDifferentialOperator.trace_formula-1241"><span class="linenos">1241</span></a>                <span class="p">(</span><span class="n">xi_min</span><span class="p">,</span> <span class="n">xi_max</span><span class="p">),</span> <span class="p">(</span><span class="n">eta_min</span><span class="p">,</span> <span class="n">eta_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">xi_bounds</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1242"><a href="#PseudoDifferentialOperator.trace_formula-1242"><span class="linenos">1242</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1243"><a href="#PseudoDifferentialOperator.trace_formula-1243"><span class="linenos">1243</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">integrand</span><span class="p">(</span><span class="n">eta_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1244"><a href="#PseudoDifferentialOperator.trace_formula-1244"><span class="linenos">1244</span></a>                    <span class="k">return</span> <span class="n">p_func</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">,</span> <span class="n">eta_val</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1245"><a href="#PseudoDifferentialOperator.trace_formula-1245"><span class="linenos">1245</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1246"><a href="#PseudoDifferentialOperator.trace_formula-1246"><span class="linenos">1246</span></a>                <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">nquad</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1247"><a href="#PseudoDifferentialOperator.trace_formula-1247"><span class="linenos">1247</span></a>                    <span class="n">integrand</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1248"><a href="#PseudoDifferentialOperator.trace_formula-1248"><span class="linenos">1248</span></a>                    <span class="p">[</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1249"><a href="#PseudoDifferentialOperator.trace_formula-1249"><span class="linenos">1249</span></a>                        <span class="p">[</span><span class="n">eta_min</span><span class="p">,</span> <span class="n">eta_max</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1250"><a href="#PseudoDifferentialOperator.trace_formula-1250"><span class="linenos">1250</span></a>                        <span class="p">[</span><span class="n">xi_min</span><span class="p">,</span> <span class="n">xi_max</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1251"><a href="#PseudoDifferentialOperator.trace_formula-1251"><span class="linenos">1251</span></a>                        <span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1252"><a href="#PseudoDifferentialOperator.trace_formula-1252"><span class="linenos">1252</span></a>                        <span class="p">[</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1253"><a href="#PseudoDifferentialOperator.trace_formula-1253"><span class="linenos">1253</span></a>                    <span class="p">]</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1254"><a href="#PseudoDifferentialOperator.trace_formula-1254"><span class="linenos">1254</span></a>                <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1255"><a href="#PseudoDifferentialOperator.trace_formula-1255"><span class="linenos">1255</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1256"><a href="#PseudoDifferentialOperator.trace_formula-1256"><span class="linenos">1256</span></a>                <span class="n">result</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">volume_element</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1257"><a href="#PseudoDifferentialOperator.trace_formula-1257"><span class="linenos">1257</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numerical trace = </span><span class="si">{</span><span class="n">result</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1258"><a href="#PseudoDifferentialOperator.trace_formula-1258"><span class="linenos">1258</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1259"><a href="#PseudoDifferentialOperator.trace_formula-1259"><span class="linenos">1259</span></a>            
</span><span id="PseudoDifferentialOperator.trace_formula-1260"><a href="#PseudoDifferentialOperator.trace_formula-1260"><span class="linenos">1260</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1261"><a href="#PseudoDifferentialOperator.trace_formula-1261"><span class="linenos">1261</span></a>                <span class="c1"># Symbolic integration</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1262"><a href="#PseudoDifferentialOperator.trace_formula-1262"><span class="linenos">1262</span></a>                <span class="n">integrand</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">volume_element</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1263"><a href="#PseudoDifferentialOperator.trace_formula-1263"><span class="linenos">1263</span></a>                
</span><span id="PseudoDifferentialOperator.trace_formula-1264"><a href="#PseudoDifferentialOperator.trace_formula-1264"><span class="linenos">1264</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1265"><a href="#PseudoDifferentialOperator.trace_formula-1265"><span class="linenos">1265</span></a>                    <span class="c1"># Integrate in order: eta, xi, y, x</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1266"><a href="#PseudoDifferentialOperator.trace_formula-1266"><span class="linenos">1266</span></a>                    <span class="n">integral_eta</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1267"><a href="#PseudoDifferentialOperator.trace_formula-1267"><span class="linenos">1267</span></a>                    <span class="n">integral_xi</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_eta</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1268"><a href="#PseudoDifferentialOperator.trace_formula-1268"><span class="linenos">1268</span></a>                    <span class="n">integral_y</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_xi</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1269"><a href="#PseudoDifferentialOperator.trace_formula-1269"><span class="linenos">1269</span></a>                    <span class="n">integral_x</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">integral_y</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1270"><a href="#PseudoDifferentialOperator.trace_formula-1270"><span class="linenos">1270</span></a>                    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">integral_x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1271"><a href="#PseudoDifferentialOperator.trace_formula-1271"><span class="linenos">1271</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1272"><a href="#PseudoDifferentialOperator.trace_formula-1272"><span class="linenos">1272</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Symbolic integration failed. Try numerical=True&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1273"><a href="#PseudoDifferentialOperator.trace_formula-1273"><span class="linenos">1273</span></a>                    <span class="k">return</span> <span class="n">integrate</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1274"><a href="#PseudoDifferentialOperator.trace_formula-1274"><span class="linenos">1274</span></a>                        <span class="n">integrand</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1275"><a href="#PseudoDifferentialOperator.trace_formula-1275"><span class="linenos">1275</span></a>                        <span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1276"><a href="#PseudoDifferentialOperator.trace_formula-1276"><span class="linenos">1276</span></a>                        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">oo</span><span class="p">,</span> <span class="n">oo</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1277"><a href="#PseudoDifferentialOperator.trace_formula-1277"><span class="linenos">1277</span></a>                    <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1278"><a href="#PseudoDifferentialOperator.trace_formula-1278"><span class="linenos">1278</span></a>        
</span><span id="PseudoDifferentialOperator.trace_formula-1279"><a href="#PseudoDifferentialOperator.trace_formula-1279"><span class="linenos">1279</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.trace_formula-1280"><a href="#PseudoDifferentialOperator.trace_formula-1280"><span class="linenos">1280</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D operators are supported&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the semiclassical trace of the pseudo-differential operator.</p>

<p>The trace formula relates the quantum trace of an operator to a 
phase-space integral of its symbol, providing a fundamental link 
between classical and quantum mechanics. This implementation supports 
both symbolic and numerical integration.</p>

<h2 id="parameters">Parameters</h2>

<p>volume_element : sympy.Expr, optional
    Custom volume element for the phase space integration. If None, 
    uses the standard Liouville measure dx dξ/(2π)^d.
numerical : bool, default=False
    If True, perform numerical integration over specified bounds.
    If False, attempt symbolic integration (may fail for complex symbols).
x_bounds : tuple of tuples, optional
    Spatial integration bounds. For 1D: ((x_min, x_max),)
    For 2D: ((x_min, x_max), (y_min, y_max))
    Required if numerical=True.
xi_bounds : tuple of tuples, optional
    Frequency integration bounds. For 1D: ((xi_min, xi_max),)
    For 2D: ((xi_min, xi_max), (eta_min, eta_max))
    Required if numerical=True.</p>

<h2 id="returns">Returns</h2>

<p>sympy.Expr or float
    The trace of the operator. Returns a symbolic expression if 
    numerical=False, or a float if numerical=True.</p>

<h2 id="notes">Notes</h2>

<ul>
<li><p>The semiclassical trace formula states:
Tr(P) = (2π)^{-d} ∫∫ p(x,ξ) dx dξ
where d is the spatial dimension and p(x,ξ) is the operator symbol.</p></li>
<li><p>For 1D: Tr(P) = (1/2π) ∫_{-∞}^{∞} ∫_{-∞}^{∞} p(x,ξ) dx dξ</p></li>
<li><p>For 2D: Tr(P) = (1/4π²) ∫∫∫∫ p(x,y,ξ,η) dx dy dξ dη</p></li>
<li><p>This formula is exact for trace-class operators and provides an 
asymptotic approximation for general pseudo-differential operators.</p></li>
<li><p>Physical interpretation: the trace counts the "number of states" 
weighted by the observable p(x,ξ).</p></li>
<li><p>For projection operators (χ_Ω with χ² = χ), the trace gives the 
dimension of the range, related to the phase space volume of Ω.</p></li>
<li><p>The factor (2π)^{-d} comes from the quantum normalization of 
coherent states / Weyl quantization.</p></li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.pseudospectrum_analysis" class="classattr">
                                        <input id="PseudoDifferentialOperator.pseudospectrum_analysis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pseudospectrum_analysis</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x_grid</span>,</span><span class="param">	<span class="n">lambda_real_range</span>,</span><span class="param">	<span class="n">lambda_imag_range</span>,</span><span class="param">	<span class="n">epsilon_levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">]</span>,</span><span class="param">	<span class="n">resolution</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">method</span><span class="o">=</span><span class="s1">&#39;spectral&#39;</span>,</span><span class="param">	<span class="n">L</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">N</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.pseudospectrum_analysis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.pseudospectrum_analysis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1282"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1282"><span class="linenos">1282</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pseudospectrum_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">lambda_real_range</span><span class="p">,</span> <span class="n">lambda_imag_range</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1283"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1283"><span class="linenos">1283</span></a>                               <span class="n">epsilon_levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1284"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1284"><span class="linenos">1284</span></a>                               <span class="n">resolution</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;spectral&#39;</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1285"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1285"><span class="linenos">1285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1286"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1286"><span class="linenos">1286</span></a><span class="sd">        Compute and visualize the pseudospectrum of the pseudo-differential operator.</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1287"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1287"><span class="linenos">1287</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1288"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1288"><span class="linenos">1288</span></a><span class="sd">        The ε-pseudospectrum is defined as:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1289"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1289"><span class="linenos">1289</span></a><span class="sd">            Λ_ε(A) = { λ ∈ ℂ : ‖(A - λI)^{-1}‖ ≥ ε^{-1} }</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1290"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1290"><span class="linenos">1290</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1291"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1291"><span class="linenos">1291</span></a><span class="sd">        This method quantizes the operator symbol into a matrix representation </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1292"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1292"><span class="linenos">1292</span></a><span class="sd">        and samples the resolvent norm over a grid in the complex plane.</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1293"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1293"><span class="linenos">1293</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1294"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1294"><span class="linenos">1294</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1295"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1295"><span class="linenos">1295</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1296"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1296"><span class="linenos">1296</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1297"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1297"><span class="linenos">1297</span></a><span class="sd">            Spatial discretization grid (used if method=&#39;finite_difference&#39;)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1298"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1298"><span class="linenos">1298</span></a><span class="sd">        lambda_real_range : tuple</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1299"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1299"><span class="linenos">1299</span></a><span class="sd">            Real part range of complex λ: (λ_re_min, λ_re_max)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1300"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1300"><span class="linenos">1300</span></a><span class="sd">        lambda_imag_range : tuple</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1301"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1301"><span class="linenos">1301</span></a><span class="sd">            Imaginary part range: (λ_im_min, λ_im_max)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1302"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1302"><span class="linenos">1302</span></a><span class="sd">        epsilon_levels : list of float</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1303"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1303"><span class="linenos">1303</span></a><span class="sd">            Contour levels for ε-pseudospectrum boundaries</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1304"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1304"><span class="linenos">1304</span></a><span class="sd">        resolution : int</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1305"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1305"><span class="linenos">1305</span></a><span class="sd">            Number of grid points per axis in the λ-plane</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1306"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1306"><span class="linenos">1306</span></a><span class="sd">        method : str</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1307"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1307"><span class="linenos">1307</span></a><span class="sd">            Discretization method:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1308"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1308"><span class="linenos">1308</span></a><span class="sd">            - &#39;spectral&#39;: FFT-based spectral differentiation (periodic, high accuracy)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1309"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1309"><span class="linenos">1309</span></a><span class="sd">            - &#39;finite_difference&#39;: Standard finite differences</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1310"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1310"><span class="linenos">1310</span></a><span class="sd">        L : float, optional</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1311"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1311"><span class="linenos">1311</span></a><span class="sd">            Half-domain length for spectral method (default: inferred from x_grid)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1312"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1312"><span class="linenos">1312</span></a><span class="sd">        N : int, optional</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1313"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1313"><span class="linenos">1313</span></a><span class="sd">            Number of grid points for spectral method (default: len(x_grid))</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1314"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1314"><span class="linenos">1314</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1315"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1315"><span class="linenos">1315</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1316"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1316"><span class="linenos">1316</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1317"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1317"><span class="linenos">1317</span></a><span class="sd">        dict</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1318"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1318"><span class="linenos">1318</span></a><span class="sd">            Contains:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1319"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1319"><span class="linenos">1319</span></a><span class="sd">            - &#39;lambda_grid&#39;: meshgrid of complex λ values</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1320"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1320"><span class="linenos">1320</span></a><span class="sd">            - &#39;resolvent_norm&#39;: 2D array of ‖(A - λI)^{-1}‖</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1321"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1321"><span class="linenos">1321</span></a><span class="sd">            - &#39;sigma_min&#39;: 2D array of σ_min(A - λI)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1322"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1322"><span class="linenos">1322</span></a><span class="sd">            - &#39;epsilon_levels&#39;: input epsilon levels</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1323"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1323"><span class="linenos">1323</span></a><span class="sd">            - &#39;eigenvalues&#39;: computed eigenvalues (if available)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1324"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1324"><span class="linenos">1324</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1325"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1325"><span class="linenos">1325</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1326"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1326"><span class="linenos">1326</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1327"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1327"><span class="linenos">1327</span></a><span class="sd">        - For non-self-adjoint operators, the pseudospectrum can extend far from </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1328"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1328"><span class="linenos">1328</span></a><span class="sd">          the actual spectrum, revealing transient behavior and non-normal dynamics.</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1329"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1329"><span class="linenos">1329</span></a><span class="sd">        - The spectral method is preferred for smooth, periodic-like symbols.</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1330"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1330"><span class="linenos">1330</span></a><span class="sd">        - Computational cost scales as O(resolution² × N³) due to SVD at each λ.</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1331"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1331"><span class="linenos">1331</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1332"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1332"><span class="linenos">1332</span></a><span class="sd">        Examples</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1333"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1333"><span class="linenos">1333</span></a><span class="sd">        --------</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1334"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1334"><span class="linenos">1334</span></a><span class="sd">        &gt;&gt;&gt; # Analyze pseudospectrum of a non-self-adjoint operator</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1335"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1335"><span class="linenos">1335</span></a><span class="sd">        &gt;&gt;&gt; x, xi = symbols(&#39;x xi&#39;, real=True)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1336"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1336"><span class="linenos">1336</span></a><span class="sd">        &gt;&gt;&gt; symbol = xi**2 + 1j*x*xi  # non-self-adjoint</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1337"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1337"><span class="linenos">1337</span></a><span class="sd">        &gt;&gt;&gt; op = PseudoDifferentialOperator(symbol, [x], mode=&#39;symbol&#39;)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1338"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1338"><span class="linenos">1338</span></a><span class="sd">        &gt;&gt;&gt; result = op.pseudospectrum_analysis(</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1339"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1339"><span class="linenos">1339</span></a><span class="sd">        ...     x_grid=np.linspace(-5, 5, 128),</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1340"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1340"><span class="linenos">1340</span></a><span class="sd">        ...     lambda_real_range=(-2, 10),</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1341"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1341"><span class="linenos">1341</span></a><span class="sd">        ...     lambda_imag_range=(-3, 3),</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1342"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1342"><span class="linenos">1342</span></a><span class="sd">        ...     method=&#39;spectral&#39;</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1343"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1343"><span class="linenos">1343</span></a><span class="sd">        ... )</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1344"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1344"><span class="linenos">1344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1345"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1345"><span class="linenos">1345</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">svdvals</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1346"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1346"><span class="linenos">1346</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">diags</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1347"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1347"><span class="linenos">1347</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1348"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1349"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1349"><span class="linenos">1349</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Pseudospectrum analysis currently supports 1D only&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1350"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1350"><span class="linenos">1350</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1351"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1351"><span class="linenos">1351</span></a>        <span class="c1"># --- Step 1: Quantize the operator into a matrix ---</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1352"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1352"><span class="linenos">1352</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;spectral&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1353"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1353"><span class="linenos">1353</span></a>            <span class="c1"># Spectral (FFT) discretization</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1354"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1354"><span class="linenos">1354</span></a>            <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1355"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1355"><span class="linenos">1355</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1356"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1356"><span class="linenos">1356</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1357"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1357"><span class="linenos">1357</span></a>                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1358"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1358"><span class="linenos">1358</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1359"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1359"><span class="linenos">1359</span></a>            <span class="n">x_grid_spectral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1360"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1360"><span class="linenos">1360</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="n">x_grid_spectral</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid_spectral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1361"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1361"><span class="linenos">1361</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1362"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1362"><span class="linenos">1362</span></a>            <span class="n">k2</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># symbol for -d²/dx²</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1363"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1363"><span class="linenos">1363</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1364"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1364"><span class="linenos">1364</span></a>            <span class="c1"># Build operator matrix via spectral differentiation</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1365"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1365"><span class="linenos">1365</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">apply_operator</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1366"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1366"><span class="linenos">1366</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;Apply Op(symbol) to vector u&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1367"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1367"><span class="linenos">1367</span></a>                <span class="n">u_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1368"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1368"><span class="linenos">1368</span></a>                <span class="c1"># Extract kinetic part from symbol (assuming symbol = f(xi) + g(x))</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1369"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1369"><span class="linenos">1369</span></a>                <span class="c1"># This is a simplified model; for general symbols, use full quantization</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1370"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1370"><span class="linenos">1370</span></a>                <span class="n">kinetic</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">u_hat</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1371"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1371"><span class="linenos">1371</span></a>                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">kinetic</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1372"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1372"><span class="linenos">1372</span></a>                <span class="c1"># Add potential/position-dependent part</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1373"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1373"><span class="linenos">1373</span></a>                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">x_grid_spectral</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1374"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1374"><span class="linenos">1374</span></a>                <span class="n">potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># evaluate at ξ=0 for position part</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1375"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1375"><span class="linenos">1375</span></a>                <span class="n">v</span> <span class="o">+=</span> <span class="n">potential</span> <span class="o">*</span> <span class="n">u</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1376"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1376"><span class="linenos">1376</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1377"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1377"><span class="linenos">1377</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1378"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1378"><span class="linenos">1378</span></a>            <span class="c1"># Assemble matrix</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1379"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1379"><span class="linenos">1379</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1380"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1380"><span class="linenos">1380</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1381"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1381"><span class="linenos">1381</span></a>                <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1382"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1382"><span class="linenos">1382</span></a>                <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1383"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1383"><span class="linenos">1383</span></a>                <span class="n">H</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_operator</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1384"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1384"><span class="linenos">1384</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1385"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1385"><span class="linenos">1385</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operator quantized via spectral method: </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> matrix&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1386"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1386"><span class="linenos">1386</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1387"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1387"><span class="linenos">1387</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;finite_difference&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1388"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1388"><span class="linenos">1388</span></a>            <span class="c1"># Finite difference discretization</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1389"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1389"><span class="linenos">1389</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1390"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1390"><span class="linenos">1390</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1391"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1391"><span class="linenos">1391</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1392"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1392"><span class="linenos">1392</span></a>            <span class="c1"># Build -d²/dx² using centered differences</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1393"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1393"><span class="linenos">1393</span></a>            <span class="n">diag_main</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1394"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1394"><span class="linenos">1394</span></a>            <span class="n">diag_off</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1395"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1395"><span class="linenos">1395</span></a>            <span class="n">D2</span> <span class="o">=</span> <span class="n">diags</span><span class="p">([</span><span class="n">diag_off</span><span class="p">,</span> <span class="n">diag_main</span><span class="p">,</span> <span class="n">diag_off</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1396"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1396"><span class="linenos">1396</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1397"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1397"><span class="linenos">1397</span></a>            <span class="c1"># Add position-dependent part from symbol</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1398"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1398"><span class="linenos">1398</span></a>            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">x_grid</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1399"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1399"><span class="linenos">1399</span></a>            <span class="n">potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1400"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1400"><span class="linenos">1400</span></a>            
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1401"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1401"><span class="linenos">1401</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="o">-</span><span class="n">D2</span> <span class="o">+</span> <span class="n">potential</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1402"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1402"><span class="linenos">1402</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operator quantized via finite differences: </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> matrix&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1403"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1403"><span class="linenos">1403</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1404"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1404"><span class="linenos">1404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1405"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1405"><span class="linenos">1405</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method must be &#39;spectral&#39; or &#39;finite_difference&#39;&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1406"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1406"><span class="linenos">1406</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1407"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1407"><span class="linenos">1407</span></a>        <span class="c1"># --- Step 2: Sample resolvent norm over λ-plane ---</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1408"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1408"><span class="linenos">1408</span></a>        <span class="n">lambda_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">lambda_real_range</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1409"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1409"><span class="linenos">1409</span></a>        <span class="n">lambda_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">lambda_imag_range</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1410"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1410"><span class="linenos">1410</span></a>        <span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lambda_re</span><span class="p">,</span> <span class="n">lambda_im</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1411"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1411"><span class="linenos">1411</span></a>        <span class="n">Lambda</span> <span class="o">=</span> <span class="n">Lambda_re</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">Lambda_im</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1412"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1412"><span class="linenos">1412</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1413"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1413"><span class="linenos">1413</span></a>        <span class="n">resolvent_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Lambda</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1414"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1414"><span class="linenos">1414</span></a>        <span class="n">sigma_min_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Lambda</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1415"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1415"><span class="linenos">1415</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1416"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1416"><span class="linenos">1416</span></a>        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1417"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1417"><span class="linenos">1417</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1418"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1418"><span class="linenos">1418</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing pseudospectrum over </span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> grid...&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1419"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1419"><span class="linenos">1419</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1420"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1420"><span class="linenos">1420</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1421"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1421"><span class="linenos">1421</span></a>                <span class="n">lam</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1422"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1422"><span class="linenos">1422</span></a>                <span class="n">A</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">I</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1423"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1423"><span class="linenos">1423</span></a>                
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1424"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1424"><span class="linenos">1424</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1425"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1425"><span class="linenos">1425</span></a>                    <span class="c1"># Compute smallest singular value</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1426"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1426"><span class="linenos">1426</span></a>                    <span class="n">s</span> <span class="o">=</span> <span class="n">svdvals</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1427"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1427"><span class="linenos">1427</span></a>                    <span class="n">s_min</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1428"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1428"><span class="linenos">1428</span></a>                    <span class="n">sigma_min_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_min</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1429"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1429"><span class="linenos">1429</span></a>                    <span class="n">resolvent_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s_min</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>  <span class="c1"># regularization</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1430"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1430"><span class="linenos">1430</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1431"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1431"><span class="linenos">1431</span></a>                    <span class="n">resolvent_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1432"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1432"><span class="linenos">1432</span></a>                    <span class="n">sigma_min_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1433"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1433"><span class="linenos">1433</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1434"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1434"><span class="linenos">1434</span></a>        <span class="c1"># --- Step 3: Compute eigenvalues ---</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1435"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1435"><span class="linenos">1435</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1436"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1436"><span class="linenos">1436</span></a>            <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1437"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1437"><span class="linenos">1437</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1438"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1438"><span class="linenos">1438</span></a>            <span class="n">eigenvalues</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1439"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1439"><span class="linenos">1439</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1440"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1440"><span class="linenos">1440</span></a>        <span class="c1"># --- Step 4: Visualization ---</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1441"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1441"><span class="linenos">1441</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1442"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1442"><span class="linenos">1442</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1443"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1443"><span class="linenos">1443</span></a>        <span class="c1"># Left panel: log10(resolvent norm)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1444"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1444"><span class="linenos">1444</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1445"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1445"><span class="linenos">1445</span></a>        <span class="n">levels_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epsilon_levels</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1446"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1446"><span class="linenos">1446</span></a>        <span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">resolvent_norm</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">),</span> 
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1447"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1447"><span class="linenos">1447</span></a>                         <span class="n">levels</span><span class="o">=</span><span class="n">levels_log</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1448"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1448"><span class="linenos">1448</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ε=10^</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1449"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1449"><span class="linenos">1449</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1450"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1450"><span class="linenos">1450</span></a>        <span class="k">if</span> <span class="n">eigenvalues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1451"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1451"><span class="linenos">1451</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Eigenvalues&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1452"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1452"><span class="linenos">1452</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1453"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1453"><span class="linenos">1453</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Re(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1454"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1454"><span class="linenos">1454</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Im(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1455"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1455"><span class="linenos">1455</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ε-Pseudospectrum: log₁₀(‖(A - λI)⁻¹‖)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1456"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1456"><span class="linenos">1456</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1457"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1457"><span class="linenos">1457</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1458"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1458"><span class="linenos">1458</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1459"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1459"><span class="linenos">1459</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1460"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1460"><span class="linenos">1460</span></a>        <span class="c1"># Right panel: σ_min contours</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1461"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1461"><span class="linenos">1461</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1462"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1462"><span class="linenos">1462</span></a>        <span class="n">cs2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span><span class="p">,</span> <span class="n">sigma_min_grid</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1463"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1463"><span class="linenos">1463</span></a>                           <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1464"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1464"><span class="linenos">1464</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;σ_min(A - λI)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1465"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1465"><span class="linenos">1465</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1466"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1466"><span class="linenos">1466</span></a>        <span class="k">if</span> <span class="n">eigenvalues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1467"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1467"><span class="linenos">1467</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1468"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1468"><span class="linenos">1468</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1469"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1469"><span class="linenos">1469</span></a>        <span class="k">for</span> <span class="n">eps</span> <span class="ow">in</span> <span class="n">epsilon_levels</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1470"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1470"><span class="linenos">1470</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Lambda_re</span><span class="p">,</span> <span class="n">Lambda_im</span><span class="p">,</span> <span class="n">sigma_min_grid</span><span class="p">,</span> 
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1471"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1471"><span class="linenos">1471</span></a>                       <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">eps</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1472"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1472"><span class="linenos">1472</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1473"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1473"><span class="linenos">1473</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Re(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1474"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1474"><span class="linenos">1474</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Im(λ)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1475"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1475"><span class="linenos">1475</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Smallest singular value σ_min(A - λI)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1476"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1476"><span class="linenos">1476</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1477"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1477"><span class="linenos">1477</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1478"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1478"><span class="linenos">1478</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1479"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1479"><span class="linenos">1479</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1480"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1480"><span class="linenos">1480</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1481"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1481"><span class="linenos">1481</span></a>        
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1482"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1482"><span class="linenos">1482</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1483"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1483"><span class="linenos">1483</span></a>            <span class="s1">&#39;lambda_grid&#39;</span><span class="p">:</span> <span class="n">Lambda</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1484"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1484"><span class="linenos">1484</span></a>            <span class="s1">&#39;resolvent_norm&#39;</span><span class="p">:</span> <span class="n">resolvent_norm</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1485"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1485"><span class="linenos">1485</span></a>            <span class="s1">&#39;sigma_min&#39;</span><span class="p">:</span> <span class="n">sigma_min_grid</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1486"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1486"><span class="linenos">1486</span></a>            <span class="s1">&#39;epsilon_levels&#39;</span><span class="p">:</span> <span class="n">epsilon_levels</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1487"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1487"><span class="linenos">1487</span></a>            <span class="s1">&#39;eigenvalues&#39;</span><span class="p">:</span> <span class="n">eigenvalues</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1488"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1488"><span class="linenos">1488</span></a>            <span class="s1">&#39;operator_matrix&#39;</span><span class="p">:</span> <span class="n">H</span>
</span><span id="PseudoDifferentialOperator.pseudospectrum_analysis-1489"><a href="#PseudoDifferentialOperator.pseudospectrum_analysis-1489"><span class="linenos">1489</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Compute and visualize the pseudospectrum of the pseudo-differential operator.</p>

<p>The ε-pseudospectrum is defined as:
    Λ_ε(A) = { λ ∈ ℂ : ‖(A - λI)^{-1}‖ ≥ ε^{-1} }</p>

<p>This method quantizes the operator symbol into a matrix representation 
and samples the resolvent norm over a grid in the complex plane.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid : ndarray
    Spatial discretization grid (used if method='finite_difference')
lambda_real_range : tuple
    Real part range of complex λ: (λ_re_min, λ_re_max)
lambda_imag_range : tuple
    Imaginary part range: (λ_im_min, λ_im_max)
epsilon_levels : list of float
    Contour levels for ε-pseudospectrum boundaries
resolution : int
    Number of grid points per axis in the λ-plane
method : str
    Discretization method:
    - 'spectral': FFT-based spectral differentiation (periodic, high accuracy)
    - 'finite_difference': Standard finite differences
L : float, optional
    Half-domain length for spectral method (default: inferred from x_grid)
N : int, optional
    Number of grid points for spectral method (default: len(x_grid))</p>

<h2 id="returns">Returns</h2>

<p>dict
    Contains:
    - 'lambda_grid': meshgrid of complex λ values
    - 'resolvent_norm': 2D array of ‖(A - λI)^{-1}‖
    - 'sigma_min': 2D array of σ_min(A - λI)
    - 'epsilon_levels': input epsilon levels
    - 'eigenvalues': computed eigenvalues (if available)</p>

<h2 id="notes">Notes</h2>

<ul>
<li>For non-self-adjoint operators, the pseudospectrum can extend far from 
the actual spectrum, revealing transient behavior and non-normal dynamics.</li>
<li>The spectral method is preferred for smooth, periodic-like symbols.</li>
<li>Computational cost scales as O(resolution² × N³) due to SVD at each λ.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Analyze pseudospectrum of a non-self-adjoint operator</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">symbol</span> <span class="o">=</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">xi</span>  <span class="c1"># non-self-adjoint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">op</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">pseudospectrum_analysis</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">x_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">lambda_real_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">lambda_imag_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;spectral&#39;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre>
</div>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.symplectic_flow" class="classattr">
                                        <input id="PseudoDifferentialOperator.symplectic_flow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">symplectic_flow</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.symplectic_flow-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.symplectic_flow"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.symplectic_flow-1491"><a href="#PseudoDifferentialOperator.symplectic_flow-1491"><span class="linenos">1491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symplectic_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1492"><a href="#PseudoDifferentialOperator.symplectic_flow-1492"><span class="linenos">1492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1493"><a href="#PseudoDifferentialOperator.symplectic_flow-1493"><span class="linenos">1493</span></a><span class="sd">        Compute the Hamiltonian vector field associated with the principal symbol.</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1494"><a href="#PseudoDifferentialOperator.symplectic_flow-1494"><span class="linenos">1494</span></a>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1495"><a href="#PseudoDifferentialOperator.symplectic_flow-1495"><span class="linenos">1495</span></a><span class="sd">        This method derives the canonical equations of motion for the phase space variables </span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1496"><a href="#PseudoDifferentialOperator.symplectic_flow-1496"><span class="linenos">1496</span></a><span class="sd">        (x, ξ) in 1D or (x, y, ξ, η) in 2D, based on the Hamiltonian formalism. These describe </span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1497"><a href="#PseudoDifferentialOperator.symplectic_flow-1497"><span class="linenos">1497</span></a><span class="sd">        how position and frequency variables evolve under the flow generated by the symbol.</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1498"><a href="#PseudoDifferentialOperator.symplectic_flow-1498"><span class="linenos">1498</span></a>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1499"><a href="#PseudoDifferentialOperator.symplectic_flow-1499"><span class="linenos">1499</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1500"><a href="#PseudoDifferentialOperator.symplectic_flow-1500"><span class="linenos">1500</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1501"><a href="#PseudoDifferentialOperator.symplectic_flow-1501"><span class="linenos">1501</span></a><span class="sd">        dict</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1502"><a href="#PseudoDifferentialOperator.symplectic_flow-1502"><span class="linenos">1502</span></a><span class="sd">            A dictionary containing the components of the Hamiltonian vector field:</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1503"><a href="#PseudoDifferentialOperator.symplectic_flow-1503"><span class="linenos">1503</span></a><span class="sd">            - In 1D: keys are &#39;dx/dt&#39; and &#39;dxi/dt&#39;, corresponding to dx/dt = ∂p/∂ξ and dξ/dt = -∂p/∂x.</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1504"><a href="#PseudoDifferentialOperator.symplectic_flow-1504"><span class="linenos">1504</span></a><span class="sd">            - In 2D: keys are &#39;dx/dt&#39;, &#39;dy/dt&#39;, &#39;dxi/dt&#39;, and &#39;deta/dt&#39;, with similar definitions:</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1505"><a href="#PseudoDifferentialOperator.symplectic_flow-1505"><span class="linenos">1505</span></a><span class="sd">              dx/dt = ∂p/∂ξ, dy/dt = ∂p/∂η, dξ/dt = -∂p/∂x, dη/dt = -∂p/∂y.</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1506"><a href="#PseudoDifferentialOperator.symplectic_flow-1506"><span class="linenos">1506</span></a>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1507"><a href="#PseudoDifferentialOperator.symplectic_flow-1507"><span class="linenos">1507</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1508"><a href="#PseudoDifferentialOperator.symplectic_flow-1508"><span class="linenos">1508</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1509"><a href="#PseudoDifferentialOperator.symplectic_flow-1509"><span class="linenos">1509</span></a><span class="sd">        - The Hamiltonian here is the principal symbol p(x, ξ) itself.</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1510"><a href="#PseudoDifferentialOperator.symplectic_flow-1510"><span class="linenos">1510</span></a><span class="sd">        - This flow preserves the symplectic structure of phase space.</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1511"><a href="#PseudoDifferentialOperator.symplectic_flow-1511"><span class="linenos">1511</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1512"><a href="#PseudoDifferentialOperator.symplectic_flow-1512"><span class="linenos">1512</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1513"><a href="#PseudoDifferentialOperator.symplectic_flow-1513"><span class="linenos">1513</span></a>            <span class="n">x</span><span class="p">,</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1514"><a href="#PseudoDifferentialOperator.symplectic_flow-1514"><span class="linenos">1514</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1515"><a href="#PseudoDifferentialOperator.symplectic_flow-1515"><span class="linenos">1515</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1516"><a href="#PseudoDifferentialOperator.symplectic_flow-1516"><span class="linenos">1516</span></a>                <span class="s1">&#39;dx/dt&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1517"><a href="#PseudoDifferentialOperator.symplectic_flow-1517"><span class="linenos">1517</span></a>                <span class="s1">&#39;dxi/dt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1518"><a href="#PseudoDifferentialOperator.symplectic_flow-1518"><span class="linenos">1518</span></a>            <span class="p">}</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1519"><a href="#PseudoDifferentialOperator.symplectic_flow-1519"><span class="linenos">1519</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1520"><a href="#PseudoDifferentialOperator.symplectic_flow-1520"><span class="linenos">1520</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1521"><a href="#PseudoDifferentialOperator.symplectic_flow-1521"><span class="linenos">1521</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1522"><a href="#PseudoDifferentialOperator.symplectic_flow-1522"><span class="linenos">1522</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1523"><a href="#PseudoDifferentialOperator.symplectic_flow-1523"><span class="linenos">1523</span></a>                <span class="s1">&#39;dx/dt&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1524"><a href="#PseudoDifferentialOperator.symplectic_flow-1524"><span class="linenos">1524</span></a>                <span class="s1">&#39;dy/dt&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1525"><a href="#PseudoDifferentialOperator.symplectic_flow-1525"><span class="linenos">1525</span></a>                <span class="s1">&#39;dxi/dt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1526"><a href="#PseudoDifferentialOperator.symplectic_flow-1526"><span class="linenos">1526</span></a>                <span class="s1">&#39;deta/dt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.symplectic_flow-1527"><a href="#PseudoDifferentialOperator.symplectic_flow-1527"><span class="linenos">1527</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Compute the Hamiltonian vector field associated with the principal symbol.</p>

<p>This method derives the canonical equations of motion for the phase space variables 
(x, ξ) in 1D or (x, y, ξ, η) in 2D, based on the Hamiltonian formalism. These describe 
how position and frequency variables evolve under the flow generated by the symbol.</p>

<h2 id="returns">Returns</h2>

<p>dict
    A dictionary containing the components of the Hamiltonian vector field:
    - In 1D: keys are 'dx/dt' and 'dxi/dt', corresponding to dx/dt = ∂p/∂ξ and dξ/dt = -∂p/∂x.
    - In 2D: keys are 'dx/dt', 'dy/dt', 'dxi/dt', and 'deta/dt', with similar definitions:
      dx/dt = ∂p/∂ξ, dy/dt = ∂p/∂η, dξ/dt = -∂p/∂x, dη/dt = -∂p/∂y.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The Hamiltonian here is the principal symbol p(x, ξ) itself.</li>
<li>This flow preserves the symplectic structure of phase space.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.is_elliptic_numerically" class="classattr">
                                        <input id="PseudoDifferentialOperator.is_elliptic_numerically-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_elliptic_numerically</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x_grid</span>, </span><span class="param"><span class="n">xi_grid</span>, </span><span class="param"><span class="n">threshold</span><span class="o">=</span><span class="mf">1e-08</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.is_elliptic_numerically-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.is_elliptic_numerically"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1529"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1529"><span class="linenos">1529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_elliptic_numerically</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1530"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1530"><span class="linenos">1530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1531"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1531"><span class="linenos">1531</span></a><span class="sd">        Check if the pseudo-differential symbol p(x, ξ) is elliptic over a given grid.</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1532"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1532"><span class="linenos">1532</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1533"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1533"><span class="linenos">1533</span></a><span class="sd">        A symbol is considered elliptic if its magnitude |p(x, ξ)| remains bounded away from zero </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1534"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1534"><span class="linenos">1534</span></a><span class="sd">        across all points in the spatial-frequency domain. This method evaluates the symbol on a </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1535"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1535"><span class="linenos">1535</span></a><span class="sd">        grid of spatial and frequency coordinates and checks whether its minimum absolute value </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1536"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1536"><span class="linenos">1536</span></a><span class="sd">        exceeds a specified threshold.</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1537"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1537"><span class="linenos">1537</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1538"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1538"><span class="linenos">1538</span></a><span class="sd">        Resampling is applied to large grids to prevent excessive memory usage, particularly in 2D.</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1539"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1539"><span class="linenos">1539</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1540"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1540"><span class="linenos">1540</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1541"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1541"><span class="linenos">1541</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1542"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1542"><span class="linenos">1542</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1543"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1543"><span class="linenos">1543</span></a><span class="sd">            Spatial grid: either a 1D array (x) or a tuple of two 1D arrays (x, y).</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1544"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1544"><span class="linenos">1544</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1545"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1545"><span class="linenos">1545</span></a><span class="sd">            Frequency grid: either a 1D array (ξ) or a tuple of two 1D arrays (ξ, η).</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1546"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1546"><span class="linenos">1546</span></a><span class="sd">        threshold : float, optional</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1547"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1547"><span class="linenos">1547</span></a><span class="sd">            Minimum acceptable value for |p(x, ξ)|. If the smallest evaluated symbol value falls below this,</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1548"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1548"><span class="linenos">1548</span></a><span class="sd">            the symbol is not considered elliptic.</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1549"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1549"><span class="linenos">1549</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1550"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1550"><span class="linenos">1550</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1551"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1551"><span class="linenos">1551</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1552"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1552"><span class="linenos">1552</span></a><span class="sd">        bool</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1553"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1553"><span class="linenos">1553</span></a><span class="sd">            True if the symbol is elliptic on the resampled grid, False otherwise.</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1554"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1554"><span class="linenos">1554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1555"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1555"><span class="linenos">1555</span></a>        <span class="n">RESAMPLE_SIZE</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Reduced size to prevent memory explosion</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1556"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1556"><span class="linenos">1556</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1557"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1557"><span class="linenos">1557</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1558"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1558"><span class="linenos">1558</span></a>            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">x_grid</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1559"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1559"><span class="linenos">1559</span></a>            <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">xi_grid</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1560"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1560"><span class="linenos">1560</span></a>            <span class="c1"># Resampling if necessary</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1561"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1561"><span class="linenos">1561</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1562"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1562"><span class="linenos">1562</span></a>                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1563"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1564"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1564"><span class="linenos">1564</span></a>                <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xi_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1565"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1565"><span class="linenos">1565</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1566"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1566"><span class="linenos">1566</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1567"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1567"><span class="linenos">1567</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1568"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1568"><span class="linenos">1568</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1569"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1569"><span class="linenos">1569</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1570"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1570"><span class="linenos">1570</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">x_grid</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1571"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1571"><span class="linenos">1571</span></a>            <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">xi_grid</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1572"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1572"><span class="linenos">1572</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1573"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1573"><span class="linenos">1573</span></a>            <span class="c1"># Spatial resampling</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1574"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1574"><span class="linenos">1574</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1575"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1575"><span class="linenos">1575</span></a>                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1576"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1576"><span class="linenos">1576</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1577"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1577"><span class="linenos">1577</span></a>                <span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1578"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1578"><span class="linenos">1578</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1579"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1579"><span class="linenos">1579</span></a>            <span class="c1"># Frequency resampling</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1580"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1580"><span class="linenos">1580</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1581"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1581"><span class="linenos">1581</span></a>                <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xi_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1582"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1582"><span class="linenos">1582</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RESAMPLE_SIZE</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1583"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1583"><span class="linenos">1583</span></a>                <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">eta_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">eta_vals</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">RESAMPLE_SIZE</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1584"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1584"><span class="linenos">1584</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1585"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1585"><span class="linenos">1585</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1586"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1586"><span class="linenos">1586</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1587"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1587"><span class="linenos">1587</span></a>        
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1588"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1588"><span class="linenos">1588</span></a>        <span class="n">min_abs_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.is_elliptic_numerically-1589"><a href="#PseudoDifferentialOperator.is_elliptic_numerically-1589"><span class="linenos">1589</span></a>        <span class="k">return</span> <span class="n">min_abs_val</span> <span class="o">&gt;</span> <span class="n">threshold</span>
</span></pre></div>


            <div class="docstring"><p>Check if the pseudo-differential symbol p(x, ξ) is elliptic over a given grid.</p>

<p>A symbol is considered elliptic if its magnitude |p(x, ξ)| remains bounded away from zero 
across all points in the spatial-frequency domain. This method evaluates the symbol on a 
grid of spatial and frequency coordinates and checks whether its minimum absolute value 
exceeds a specified threshold.</p>

<p>Resampling is applied to large grids to prevent excessive memory usage, particularly in 2D.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid : ndarray
    Spatial grid: either a 1D array (x) or a tuple of two 1D arrays (x, y).
xi_grid : ndarray
    Frequency grid: either a 1D array (ξ) or a tuple of two 1D arrays (ξ, η).
threshold : float, optional
    Minimum acceptable value for |p(x, ξ)|. If the smallest evaluated symbol value falls below this,
    the symbol is not considered elliptic.</p>

<h2 id="returns">Returns</h2>

<p>bool
    True if the symbol is elliptic on the resampled grid, False otherwise.</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.is_self_adjoint" class="classattr">
                                        <input id="PseudoDifferentialOperator.is_self_adjoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_self_adjoint</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.is_self_adjoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.is_self_adjoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.is_self_adjoint-1592"><a href="#PseudoDifferentialOperator.is_self_adjoint-1592"><span class="linenos">1592</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_self_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1593"><a href="#PseudoDifferentialOperator.is_self_adjoint-1593"><span class="linenos">1593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1594"><a href="#PseudoDifferentialOperator.is_self_adjoint-1594"><span class="linenos">1594</span></a><span class="sd">        Check whether the pseudo-differential operator is formally self-adjoint (Hermitian).</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1595"><a href="#PseudoDifferentialOperator.is_self_adjoint-1595"><span class="linenos">1595</span></a>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1596"><a href="#PseudoDifferentialOperator.is_self_adjoint-1596"><span class="linenos">1596</span></a><span class="sd">        A self-adjoint operator satisfies P = P*, where P* is the formal adjoint of P.</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1597"><a href="#PseudoDifferentialOperator.is_self_adjoint-1597"><span class="linenos">1597</span></a><span class="sd">        This property is essential for ensuring real-valued eigenvalues and stable evolution </span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1598"><a href="#PseudoDifferentialOperator.is_self_adjoint-1598"><span class="linenos">1598</span></a><span class="sd">        in quantum mechanics and symmetric wave propagation.</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1599"><a href="#PseudoDifferentialOperator.is_self_adjoint-1599"><span class="linenos">1599</span></a>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1600"><a href="#PseudoDifferentialOperator.is_self_adjoint-1600"><span class="linenos">1600</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1601"><a href="#PseudoDifferentialOperator.is_self_adjoint-1601"><span class="linenos">1601</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1602"><a href="#PseudoDifferentialOperator.is_self_adjoint-1602"><span class="linenos">1602</span></a><span class="sd">        tol : float</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1603"><a href="#PseudoDifferentialOperator.is_self_adjoint-1603"><span class="linenos">1603</span></a><span class="sd">            Tolerance for symbolic comparison between P and P*. Small numerical differences </span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1604"><a href="#PseudoDifferentialOperator.is_self_adjoint-1604"><span class="linenos">1604</span></a><span class="sd">            below this threshold are considered equal.</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1605"><a href="#PseudoDifferentialOperator.is_self_adjoint-1605"><span class="linenos">1605</span></a>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1606"><a href="#PseudoDifferentialOperator.is_self_adjoint-1606"><span class="linenos">1606</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1607"><a href="#PseudoDifferentialOperator.is_self_adjoint-1607"><span class="linenos">1607</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1608"><a href="#PseudoDifferentialOperator.is_self_adjoint-1608"><span class="linenos">1608</span></a><span class="sd">        bool</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1609"><a href="#PseudoDifferentialOperator.is_self_adjoint-1609"><span class="linenos">1609</span></a><span class="sd">            True if the symbol p(x, ξ) equals its formal adjoint p*(x, ξ) within the given tolerance,</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1610"><a href="#PseudoDifferentialOperator.is_self_adjoint-1610"><span class="linenos">1610</span></a><span class="sd">            indicating that the operator is self-adjoint.</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1611"><a href="#PseudoDifferentialOperator.is_self_adjoint-1611"><span class="linenos">1611</span></a>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1612"><a href="#PseudoDifferentialOperator.is_self_adjoint-1612"><span class="linenos">1612</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1613"><a href="#PseudoDifferentialOperator.is_self_adjoint-1613"><span class="linenos">1613</span></a><span class="sd">        - The formal adjoint is computed via conjugation and asymptotic expansion at infinity in ξ.</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1614"><a href="#PseudoDifferentialOperator.is_self_adjoint-1614"><span class="linenos">1614</span></a><span class="sd">        - Symbolic simplification is used to verify equality, ensuring robustness against superficial </span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1615"><a href="#PseudoDifferentialOperator.is_self_adjoint-1615"><span class="linenos">1615</span></a><span class="sd">          expression differences.</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1616"><a href="#PseudoDifferentialOperator.is_self_adjoint-1616"><span class="linenos">1616</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1617"><a href="#PseudoDifferentialOperator.is_self_adjoint-1617"><span class="linenos">1617</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1618"><a href="#PseudoDifferentialOperator.is_self_adjoint-1618"><span class="linenos">1618</span></a>        <span class="n">p_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formal_adjoint</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.is_self_adjoint-1619"><a href="#PseudoDifferentialOperator.is_self_adjoint-1619"><span class="linenos">1619</span></a>        <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">p_star</span><span class="p">)</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check whether the pseudo-differential operator is formally self-adjoint (Hermitian).</p>

<p>A self-adjoint operator satisfies P = P<em>, where P</em> is the formal adjoint of P.
This property is essential for ensuring real-valued eigenvalues and stable evolution 
in quantum mechanics and symmetric wave propagation.</p>

<h2 id="parameters">Parameters</h2>

<p>tol : float
    Tolerance for symbolic comparison between P and P*. Small numerical differences 
    below this threshold are considered equal.</p>

<h2 id="returns">Returns</h2>

<p>bool
    True if the symbol p(x, ξ) equals its formal adjoint p*(x, ξ) within the given tolerance,
    indicating that the operator is self-adjoint.</p>

<p>Notes:</p>

<ul>
<li>The formal adjoint is computed via conjugation and asymptotic expansion at infinity in ξ.</li>
<li>Symbolic simplification is used to verify equality, ensuring robustness against superficial 
expression differences.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.visualize_fiber" class="classattr">
                                        <input id="PseudoDifferentialOperator.visualize_fiber-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_fiber</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x_grid</span>, </span><span class="param"><span class="n">xi_grid</span>, </span><span class="param"><span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span>, </span><span class="param"><span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.visualize_fiber-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.visualize_fiber"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.visualize_fiber-1621"><a href="#PseudoDifferentialOperator.visualize_fiber-1621"><span class="linenos">1621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_fiber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1622"><a href="#PseudoDifferentialOperator.visualize_fiber-1622"><span class="linenos">1622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1623"><a href="#PseudoDifferentialOperator.visualize_fiber-1623"><span class="linenos">1623</span></a><span class="sd">        Plot the cotangent fiber structure at a fixed spatial point (x₀[, y₀]).</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1624"><a href="#PseudoDifferentialOperator.visualize_fiber-1624"><span class="linenos">1624</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1625"><a href="#PseudoDifferentialOperator.visualize_fiber-1625"><span class="linenos">1625</span></a><span class="sd">        This visualization shows how the symbol p(x, ξ) behaves on the cotangent fiber </span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1626"><a href="#PseudoDifferentialOperator.visualize_fiber-1626"><span class="linenos">1626</span></a><span class="sd">        above a fixed spatial point. In microlocal analysis, this provides insight into </span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1627"><a href="#PseudoDifferentialOperator.visualize_fiber-1627"><span class="linenos">1627</span></a><span class="sd">        the frequency content of the operator at that location.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1628"><a href="#PseudoDifferentialOperator.visualize_fiber-1628"><span class="linenos">1628</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1629"><a href="#PseudoDifferentialOperator.visualize_fiber-1629"><span class="linenos">1629</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1630"><a href="#PseudoDifferentialOperator.visualize_fiber-1630"><span class="linenos">1630</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1631"><a href="#PseudoDifferentialOperator.visualize_fiber-1631"><span class="linenos">1631</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1632"><a href="#PseudoDifferentialOperator.visualize_fiber-1632"><span class="linenos">1632</span></a><span class="sd">            Spatial grid values (1D) for evaluation in 1D case.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1633"><a href="#PseudoDifferentialOperator.visualize_fiber-1633"><span class="linenos">1633</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1634"><a href="#PseudoDifferentialOperator.visualize_fiber-1634"><span class="linenos">1634</span></a><span class="sd">            Frequency grid values (1D) for evaluation in both 1D and 2D cases.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1635"><a href="#PseudoDifferentialOperator.visualize_fiber-1635"><span class="linenos">1635</span></a><span class="sd">        x0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1636"><a href="#PseudoDifferentialOperator.visualize_fiber-1636"><span class="linenos">1636</span></a><span class="sd">            Fixed x-coordinate of the base point in space (1D or 2D).</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1637"><a href="#PseudoDifferentialOperator.visualize_fiber-1637"><span class="linenos">1637</span></a><span class="sd">        y0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1638"><a href="#PseudoDifferentialOperator.visualize_fiber-1638"><span class="linenos">1638</span></a><span class="sd">            Fixed y-coordinate of the base point in space (2D only).</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1639"><a href="#PseudoDifferentialOperator.visualize_fiber-1639"><span class="linenos">1639</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1640"><a href="#PseudoDifferentialOperator.visualize_fiber-1640"><span class="linenos">1640</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1641"><a href="#PseudoDifferentialOperator.visualize_fiber-1641"><span class="linenos">1641</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1642"><a href="#PseudoDifferentialOperator.visualize_fiber-1642"><span class="linenos">1642</span></a><span class="sd">        - In 1D: Displays |p(x, ξ)| over the (x, ξ) phase plane near the fixed point.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1643"><a href="#PseudoDifferentialOperator.visualize_fiber-1643"><span class="linenos">1643</span></a><span class="sd">        - In 2D: Fixes (x₀, y₀) and evaluates p(x₀, y₀, ξ, η), showing the fiber over that point.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1644"><a href="#PseudoDifferentialOperator.visualize_fiber-1644"><span class="linenos">1644</span></a><span class="sd">        - The color map represents the magnitude of the symbol, highlighting regions where it vanishes or becomes singular.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1645"><a href="#PseudoDifferentialOperator.visualize_fiber-1645"><span class="linenos">1645</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1646"><a href="#PseudoDifferentialOperator.visualize_fiber-1646"><span class="linenos">1646</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1647"><a href="#PseudoDifferentialOperator.visualize_fiber-1647"><span class="linenos">1647</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1648"><a href="#PseudoDifferentialOperator.visualize_fiber-1648"><span class="linenos">1648</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1649"><a href="#PseudoDifferentialOperator.visualize_fiber-1649"><span class="linenos">1649</span></a><span class="sd">            If called in 2D with missing or improperly formatted grids.</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1650"><a href="#PseudoDifferentialOperator.visualize_fiber-1650"><span class="linenos">1650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1651"><a href="#PseudoDifferentialOperator.visualize_fiber-1651"><span class="linenos">1651</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1652"><a href="#PseudoDifferentialOperator.visualize_fiber-1652"><span class="linenos">1652</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1653"><a href="#PseudoDifferentialOperator.visualize_fiber-1653"><span class="linenos">1653</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1654"><a href="#PseudoDifferentialOperator.visualize_fiber-1654"><span class="linenos">1654</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1655"><a href="#PseudoDifferentialOperator.visualize_fiber-1655"><span class="linenos">1655</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1656"><a href="#PseudoDifferentialOperator.visualize_fiber-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (position)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1657"><a href="#PseudoDifferentialOperator.visualize_fiber-1657"><span class="linenos">1657</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ (frequency)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1658"><a href="#PseudoDifferentialOperator.visualize_fiber-1658"><span class="linenos">1658</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cotangent Fiber Structure&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1659"><a href="#PseudoDifferentialOperator.visualize_fiber-1659"><span class="linenos">1659</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1660"><a href="#PseudoDifferentialOperator.visualize_fiber-1660"><span class="linenos">1660</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1661"><a href="#PseudoDifferentialOperator.visualize_fiber-1661"><span class="linenos">1661</span></a>            <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1662"><a href="#PseudoDifferentialOperator.visualize_fiber-1662"><span class="linenos">1662</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1663"><a href="#PseudoDifferentialOperator.visualize_fiber-1663"><span class="linenos">1663</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1664"><a href="#PseudoDifferentialOperator.visualize_fiber-1664"><span class="linenos">1664</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1665"><a href="#PseudoDifferentialOperator.visualize_fiber-1665"><span class="linenos">1665</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1666"><a href="#PseudoDifferentialOperator.visualize_fiber-1666"><span class="linenos">1666</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1667"><a href="#PseudoDifferentialOperator.visualize_fiber-1667"><span class="linenos">1667</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cotangent Fiber at x=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s1">, y=</span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_fiber-1668"><a href="#PseudoDifferentialOperator.visualize_fiber-1668"><span class="linenos">1668</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the cotangent fiber structure at a fixed spatial point (x₀[, y₀]).</p>

<p>This visualization shows how the symbol p(x, ξ) behaves on the cotangent fiber 
above a fixed spatial point. In microlocal analysis, this provides insight into 
the frequency content of the operator at that location.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid : ndarray
    Spatial grid values (1D) for evaluation in 1D case.
xi_grid : ndarray
    Frequency grid values (1D) for evaluation in both 1D and 2D cases.
x0 : float, optional
    Fixed x-coordinate of the base point in space (1D or 2D).
y0 : float, optional
    Fixed y-coordinate of the base point in space (2D only).</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D: Displays |p(x, ξ)| over the (x, ξ) phase plane near the fixed point.</li>
<li>In 2D: Fixes (x₀, y₀) and evaluates p(x₀, y₀, ξ, η), showing the fiber over that point.</li>
<li>The color map represents the magnitude of the symbol, highlighting regions where it vanishes or becomes singular.</li>
</ul>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If called in 2D with missing or improperly formatted grids.</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.visualize_symbol_amplitude" class="classattr">
                                        <input id="PseudoDifferentialOperator.visualize_symbol_amplitude-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_symbol_amplitude</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x_grid</span>, </span><span class="param"><span class="n">xi_grid</span>, </span><span class="param"><span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">xi0</span><span class="o">=</span><span class="mf">0.0</span>, </span><span class="param"><span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.visualize_symbol_amplitude-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.visualize_symbol_amplitude"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1670"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1670"><span class="linenos">1670</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_symbol_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1671"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1671"><span class="linenos">1671</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1672"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1672"><span class="linenos">1672</span></a><span class="sd">        Display the modulus |p(x, ξ)| or |p(x, y, ξ₀, η₀)| as a color map.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1673"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1673"><span class="linenos">1673</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1674"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1674"><span class="linenos">1674</span></a><span class="sd">        This method visualizes the amplitude of the pseudodifferential operator&#39;s symbol </span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1675"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1675"><span class="linenos">1675</span></a><span class="sd">        in either 1D or 2D spatial configuration. In 2D, the frequency variables are fixed </span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1676"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1676"><span class="linenos">1676</span></a><span class="sd">        to specified values (ξ₀, η₀) for visualization purposes.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1677"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1677"><span class="linenos">1677</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1678"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1678"><span class="linenos">1678</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1679"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1679"><span class="linenos">1679</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1680"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1680"><span class="linenos">1680</span></a><span class="sd">        x_grid, y_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1681"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1681"><span class="linenos">1681</span></a><span class="sd">            Spatial grids over which to evaluate the symbol. y_grid is optional and used only in 2D.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1682"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1682"><span class="linenos">1682</span></a><span class="sd">        xi_grid, eta_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1683"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1683"><span class="linenos">1683</span></a><span class="sd">            Frequency grids. In 2D, these define the domain over which the symbol is evaluated,</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1684"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1684"><span class="linenos">1684</span></a><span class="sd">            but the visualization fixes ξ = ξ₀ and η = η₀.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1685"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1685"><span class="linenos">1685</span></a><span class="sd">        xi0, eta0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1686"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1686"><span class="linenos">1686</span></a><span class="sd">            Fixed frequency values for slicing in 2D visualization. Defaults to zero.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1687"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1687"><span class="linenos">1687</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1688"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1688"><span class="linenos">1688</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1689"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1689"><span class="linenos">1689</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1690"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1690"><span class="linenos">1690</span></a><span class="sd">        - In 1D: Visualizes |p(x, ξ)| over the (x, ξ) grid.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1691"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1691"><span class="linenos">1691</span></a><span class="sd">        - In 2D: Visualizes |p(x, y, ξ₀, η₀)| at fixed frequencies ξ₀ and η₀.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1692"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1692"><span class="linenos">1692</span></a><span class="sd">        - The color intensity represents the magnitude of the symbol, highlighting regions where the symbol is large or small.</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1693"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1693"><span class="linenos">1693</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1694"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1694"><span class="linenos">1694</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1695"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1695"><span class="linenos">1695</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1696"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1696"><span class="linenos">1696</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span> 
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1697"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1697"><span class="linenos">1697</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1698"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1698"><span class="linenos">1698</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1699"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1699"><span class="linenos">1699</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1700"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1700"><span class="linenos">1700</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1701"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1701"><span class="linenos">1701</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Symbol Amplitude |p(x, ξ)|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1702"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1702"><span class="linenos">1702</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1703"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1703"><span class="linenos">1703</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1704"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1704"><span class="linenos">1704</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1705"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1705"><span class="linenos">1705</span></a>            <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1706"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1706"><span class="linenos">1706</span></a>            <span class="n">ETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1707"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1707"><span class="linenos">1707</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1708"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1708"><span class="linenos">1708</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1709"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1709"><span class="linenos">1709</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|Symbol|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1710"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1710"><span class="linenos">1710</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1711"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1711"><span class="linenos">1711</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1712"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1712"><span class="linenos">1712</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Amplitude at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_symbol_amplitude-1713"><a href="#PseudoDifferentialOperator.visualize_symbol_amplitude-1713"><span class="linenos">1713</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Display the modulus |p(x, ξ)| or |p(x, y, ξ₀, η₀)| as a color map.</p>

<p>This method visualizes the amplitude of the pseudodifferential operator's symbol 
in either 1D or 2D spatial configuration. In 2D, the frequency variables are fixed 
to specified values (ξ₀, η₀) for visualization purposes.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid, y_grid : ndarray
    Spatial grids over which to evaluate the symbol. y_grid is optional and used only in 2D.
xi_grid, eta_grid : ndarray
    Frequency grids. In 2D, these define the domain over which the symbol is evaluated,
    but the visualization fixes ξ = ξ₀ and η = η₀.
xi0, eta0 : float, optional
    Fixed frequency values for slicing in 2D visualization. Defaults to zero.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D: Visualizes |p(x, ξ)| over the (x, ξ) grid.</li>
<li>In 2D: Visualizes |p(x, y, ξ₀, η₀)| at fixed frequencies ξ₀ and η₀.</li>
<li>The color intensity represents the magnitude of the symbol, highlighting regions where the symbol is large or small.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.visualize_phase" class="classattr">
                                        <input id="PseudoDifferentialOperator.visualize_phase-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_phase</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x_grid</span>, </span><span class="param"><span class="n">xi_grid</span>, </span><span class="param"><span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">xi0</span><span class="o">=</span><span class="mf">0.0</span>, </span><span class="param"><span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.visualize_phase-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.visualize_phase"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.visualize_phase-1715"><a href="#PseudoDifferentialOperator.visualize_phase-1715"><span class="linenos">1715</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1716"><a href="#PseudoDifferentialOperator.visualize_phase-1716"><span class="linenos">1716</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1717"><a href="#PseudoDifferentialOperator.visualize_phase-1717"><span class="linenos">1717</span></a><span class="sd">        Plot the phase (argument) of the pseudodifferential operator&#39;s symbol p(x, ξ) or p(x, y, ξ, η).</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1718"><a href="#PseudoDifferentialOperator.visualize_phase-1718"><span class="linenos">1718</span></a>
</span><span id="PseudoDifferentialOperator.visualize_phase-1719"><a href="#PseudoDifferentialOperator.visualize_phase-1719"><span class="linenos">1719</span></a><span class="sd">        This visualization helps in understanding the oscillatory behavior and regularity </span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1720"><a href="#PseudoDifferentialOperator.visualize_phase-1720"><span class="linenos">1720</span></a><span class="sd">        properties of the operator in phase space. The phase is displayed modulo 2π using </span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1721"><a href="#PseudoDifferentialOperator.visualize_phase-1721"><span class="linenos">1721</span></a><span class="sd">        a cyclic colormap (&#39;twilight&#39;) to emphasize its periodic nature.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1722"><a href="#PseudoDifferentialOperator.visualize_phase-1722"><span class="linenos">1722</span></a>
</span><span id="PseudoDifferentialOperator.visualize_phase-1723"><a href="#PseudoDifferentialOperator.visualize_phase-1723"><span class="linenos">1723</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1724"><a href="#PseudoDifferentialOperator.visualize_phase-1724"><span class="linenos">1724</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1725"><a href="#PseudoDifferentialOperator.visualize_phase-1725"><span class="linenos">1725</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1726"><a href="#PseudoDifferentialOperator.visualize_phase-1726"><span class="linenos">1726</span></a><span class="sd">            1D array of spatial coordinates (x).</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1727"><a href="#PseudoDifferentialOperator.visualize_phase-1727"><span class="linenos">1727</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1728"><a href="#PseudoDifferentialOperator.visualize_phase-1728"><span class="linenos">1728</span></a><span class="sd">            1D array of frequency coordinates (ξ).</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1729"><a href="#PseudoDifferentialOperator.visualize_phase-1729"><span class="linenos">1729</span></a><span class="sd">        y_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1730"><a href="#PseudoDifferentialOperator.visualize_phase-1730"><span class="linenos">1730</span></a><span class="sd">            2D spatial grid for y-coordinate (in 2D problems). Default is None.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1731"><a href="#PseudoDifferentialOperator.visualize_phase-1731"><span class="linenos">1731</span></a><span class="sd">        eta_grid : ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1732"><a href="#PseudoDifferentialOperator.visualize_phase-1732"><span class="linenos">1732</span></a><span class="sd">            2D frequency grid for η (in 2D problems). Not used directly but kept for API consistency.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1733"><a href="#PseudoDifferentialOperator.visualize_phase-1733"><span class="linenos">1733</span></a><span class="sd">        xi0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1734"><a href="#PseudoDifferentialOperator.visualize_phase-1734"><span class="linenos">1734</span></a><span class="sd">            Fixed value of ξ for slicing in 2D visualization. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1735"><a href="#PseudoDifferentialOperator.visualize_phase-1735"><span class="linenos">1735</span></a><span class="sd">        eta0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1736"><a href="#PseudoDifferentialOperator.visualize_phase-1736"><span class="linenos">1736</span></a><span class="sd">            Fixed value of η for slicing in 2D visualization. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1737"><a href="#PseudoDifferentialOperator.visualize_phase-1737"><span class="linenos">1737</span></a>
</span><span id="PseudoDifferentialOperator.visualize_phase-1738"><a href="#PseudoDifferentialOperator.visualize_phase-1738"><span class="linenos">1738</span></a><span class="sd">        Notes:</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1739"><a href="#PseudoDifferentialOperator.visualize_phase-1739"><span class="linenos">1739</span></a><span class="sd">        - In 1D: Displays arg(p(x, ξ)) over the (x, ξ) phase plane.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1740"><a href="#PseudoDifferentialOperator.visualize_phase-1740"><span class="linenos">1740</span></a><span class="sd">        - In 2D: Displays arg(p(x, y, ξ₀, η₀)) for fixed frequency values (ξ₀, η₀).</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1741"><a href="#PseudoDifferentialOperator.visualize_phase-1741"><span class="linenos">1741</span></a><span class="sd">        - Uses plt.pcolormesh with &#39;twilight&#39; colormap to represent angles from -π to π.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1742"><a href="#PseudoDifferentialOperator.visualize_phase-1742"><span class="linenos">1742</span></a>
</span><span id="PseudoDifferentialOperator.visualize_phase-1743"><a href="#PseudoDifferentialOperator.visualize_phase-1743"><span class="linenos">1743</span></a><span class="sd">        Raises:</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1744"><a href="#PseudoDifferentialOperator.visualize_phase-1744"><span class="linenos">1744</span></a><span class="sd">        - NotImplementedError: If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1745"><a href="#PseudoDifferentialOperator.visualize_phase-1745"><span class="linenos">1745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1746"><a href="#PseudoDifferentialOperator.visualize_phase-1746"><span class="linenos">1746</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1747"><a href="#PseudoDifferentialOperator.visualize_phase-1747"><span class="linenos">1747</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1748"><a href="#PseudoDifferentialOperator.visualize_phase-1748"><span class="linenos">1748</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span> 
</span><span id="PseudoDifferentialOperator.visualize_phase-1749"><a href="#PseudoDifferentialOperator.visualize_phase-1749"><span class="linenos">1749</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;twilight&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1750"><a href="#PseudoDifferentialOperator.visualize_phase-1750"><span class="linenos">1750</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;arg(Symbol) [rad]&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1751"><a href="#PseudoDifferentialOperator.visualize_phase-1751"><span class="linenos">1751</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1752"><a href="#PseudoDifferentialOperator.visualize_phase-1752"><span class="linenos">1752</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1753"><a href="#PseudoDifferentialOperator.visualize_phase-1753"><span class="linenos">1753</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Phase Portrait (arg p(x, ξ))&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1754"><a href="#PseudoDifferentialOperator.visualize_phase-1754"><span class="linenos">1754</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1755"><a href="#PseudoDifferentialOperator.visualize_phase-1755"><span class="linenos">1755</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1756"><a href="#PseudoDifferentialOperator.visualize_phase-1756"><span class="linenos">1756</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1757"><a href="#PseudoDifferentialOperator.visualize_phase-1757"><span class="linenos">1757</span></a>            <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1758"><a href="#PseudoDifferentialOperator.visualize_phase-1758"><span class="linenos">1758</span></a>            <span class="n">ETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1759"><a href="#PseudoDifferentialOperator.visualize_phase-1759"><span class="linenos">1759</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1760"><a href="#PseudoDifferentialOperator.visualize_phase-1760"><span class="linenos">1760</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;twilight&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1761"><a href="#PseudoDifferentialOperator.visualize_phase-1761"><span class="linenos">1761</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;arg(Symbol) [rad]&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1762"><a href="#PseudoDifferentialOperator.visualize_phase-1762"><span class="linenos">1762</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1763"><a href="#PseudoDifferentialOperator.visualize_phase-1763"><span class="linenos">1763</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1764"><a href="#PseudoDifferentialOperator.visualize_phase-1764"><span class="linenos">1764</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Phase Portrait at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_phase-1765"><a href="#PseudoDifferentialOperator.visualize_phase-1765"><span class="linenos">1765</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the phase (argument) of the pseudodifferential operator's symbol p(x, ξ) or p(x, y, ξ, η).</p>

<p>This visualization helps in understanding the oscillatory behavior and regularity 
properties of the operator in phase space. The phase is displayed modulo 2π using 
a cyclic colormap ('twilight') to emphasize its periodic nature.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid : ndarray
    1D array of spatial coordinates (x).
xi_grid : ndarray
    1D array of frequency coordinates (ξ).
y_grid : ndarray, optional
    2D spatial grid for y-coordinate (in 2D problems). Default is None.
eta_grid : ndarray, optional
    2D frequency grid for η (in 2D problems). Not used directly but kept for API consistency.
xi0 : float, optional
    Fixed value of ξ for slicing in 2D visualization. Default is 0.0.
eta0 : float, optional
    Fixed value of η for slicing in 2D visualization. Default is 0.0.</p>

<p>Notes:</p>

<ul>
<li>In 1D: Displays arg(p(x, ξ)) over the (x, ξ) phase plane.</li>
<li>In 2D: Displays arg(p(x, y, ξ₀, η₀)) for fixed frequency values (ξ₀, η₀).</li>
<li>Uses plt.pcolormesh with 'twilight' colormap to represent angles from -π to π.</li>
</ul>

<p>Raises:</p>

<ul>
<li>NotImplementedError: If the spatial dimension is not 1D or 2D.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.visualize_characteristic_set" class="classattr">
                                        <input id="PseudoDifferentialOperator.visualize_characteristic_set-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_characteristic_set</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x_grid</span>,</span><span class="param">	<span class="n">xi_grid</span>,</span><span class="param">	<span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.visualize_characteristic_set-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.visualize_characteristic_set"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1767"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1767"><span class="linenos">1767</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_characteristic_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-1</span><span class="p">]):</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1768"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1768"><span class="linenos">1768</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1769"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1769"><span class="linenos">1769</span></a><span class="sd">        Visualize the characteristic set of the pseudo-differential symbol, defined as the approximate zero set p(x, ξ) ≈ 0.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1770"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1770"><span class="linenos">1770</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1771"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1771"><span class="linenos">1771</span></a><span class="sd">        In microlocal analysis, the characteristic set is the locus of points in phase space (x, ξ) where the symbol p(x, ξ) vanishes,</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1772"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1772"><span class="linenos">1772</span></a><span class="sd">        playing a key role in understanding propagation of singularities.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1773"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1773"><span class="linenos">1773</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1774"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1774"><span class="linenos">1774</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1775"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1775"><span class="linenos">1775</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1776"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1776"><span class="linenos">1776</span></a><span class="sd">        x_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1777"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1777"><span class="linenos">1777</span></a><span class="sd">            Spatial grid values (1D array) for plotting in 1D or evaluation point in 2D.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1778"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1778"><span class="linenos">1778</span></a><span class="sd">        xi_grid : ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1779"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1779"><span class="linenos">1779</span></a><span class="sd">            Frequency variable grid values (1D array) used to construct the frequency domain.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1780"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1780"><span class="linenos">1780</span></a><span class="sd">        x0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1781"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1781"><span class="linenos">1781</span></a><span class="sd">            Fixed spatial coordinate in 2D case for evaluating the symbol at a specific x position.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1782"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1782"><span class="linenos">1782</span></a><span class="sd">        y0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1783"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1783"><span class="linenos">1783</span></a><span class="sd">            Fixed spatial coordinate in 2D case for evaluating the symbol at a specific y position.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1784"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1784"><span class="linenos">1784</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1785"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1785"><span class="linenos">1785</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1786"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1786"><span class="linenos">1786</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1787"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1787"><span class="linenos">1787</span></a><span class="sd">        - For 1D, this method plots the contour of |p(x, ξ)| = ε with ε = 1e-5 over the (x, ξ) plane.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1788"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1788"><span class="linenos">1788</span></a><span class="sd">        - For 2D, it evaluates the symbol at fixed (x₀, y₀) and plots the characteristic set in the (ξ, η) frequency plane.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1789"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1789"><span class="linenos">1789</span></a><span class="sd">        - This visualization helps identify directions of degeneracy or hypoellipticity of the operator.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1790"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1790"><span class="linenos">1790</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1791"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1791"><span class="linenos">1791</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1792"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1792"><span class="linenos">1792</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1793"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1793"><span class="linenos">1793</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1794"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1794"><span class="linenos">1794</span></a><span class="sd">            If called on a solver with dimensionality other than 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1795"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1795"><span class="linenos">1795</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1796"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1796"><span class="linenos">1796</span></a><span class="sd">        Displays</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1797"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1797"><span class="linenos">1797</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1798"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1798"><span class="linenos">1798</span></a><span class="sd">        A matplotlib contour plot showing either:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1799"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1799"><span class="linenos">1799</span></a><span class="sd">            - The characteristic curve in the (x, ξ) phase plane (1D),</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1800"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1800"><span class="linenos">1800</span></a><span class="sd">            - The characteristic surface slice in the (ξ, η) frequency plane at (x₀, y₀) (2D).</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1801"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1801"><span class="linenos">1801</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1802"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1802"><span class="linenos">1802</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1803"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1803"><span class="linenos">1803</span></a>            <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1804"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1804"><span class="linenos">1804</span></a>            <span class="n">xi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1805"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1805"><span class="linenos">1805</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1806"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1806"><span class="linenos">1806</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span> 
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1807"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1807"><span class="linenos">1807</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1808"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1808"><span class="linenos">1808</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1809"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1809"><span class="linenos">1809</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1810"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1810"><span class="linenos">1810</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Characteristic Set (p(x, ξ) ≈ 0)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1811"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1811"><span class="linenos">1811</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1812"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1812"><span class="linenos">1812</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1813"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1813"><span class="linenos">1813</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1814"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1814"><span class="linenos">1814</span></a>            <span class="k">if</span> <span class="n">eta_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1815"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1815"><span class="linenos">1815</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;eta_grid must be provided for 2D visualization.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1816"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1816"><span class="linenos">1816</span></a>            <span class="n">xi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1817"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1817"><span class="linenos">1817</span></a>            <span class="n">eta_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eta_grid</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1818"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1818"><span class="linenos">1818</span></a>            <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1819"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1819"><span class="linenos">1819</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1820"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1820"><span class="linenos">1820</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1821"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1821"><span class="linenos">1821</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1822"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1822"><span class="linenos">1822</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1823"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1823"><span class="linenos">1823</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Characteristic Set at x=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s1">, y=</span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1824"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1824"><span class="linenos">1824</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1825"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1825"><span class="linenos">1825</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1826"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1826"><span class="linenos">1826</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_set-1827"><a href="#PseudoDifferentialOperator.visualize_characteristic_set-1827"><span class="linenos">1827</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D/2D characteristic sets supported.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the characteristic set of the pseudo-differential symbol, defined as the approximate zero set p(x, ξ) ≈ 0.</p>

<p>In microlocal analysis, the characteristic set is the locus of points in phase space (x, ξ) where the symbol p(x, ξ) vanishes,
playing a key role in understanding propagation of singularities.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid : ndarray
    Spatial grid values (1D array) for plotting in 1D or evaluation point in 2D.
xi_grid : ndarray
    Frequency variable grid values (1D array) used to construct the frequency domain.
x0 : float, optional
    Fixed spatial coordinate in 2D case for evaluating the symbol at a specific x position.
y0 : float, optional
    Fixed spatial coordinate in 2D case for evaluating the symbol at a specific y position.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>For 1D, this method plots the contour of |p(x, ξ)| = ε with ε = 1e-5 over the (x, ξ) plane.</li>
<li>For 2D, it evaluates the symbol at fixed (x₀, y₀) and plots the characteristic set in the (ξ, η) frequency plane.</li>
<li>This visualization helps identify directions of degeneracy or hypoellipticity of the operator.</li>
</ul>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If called on a solver with dimensionality other than 1D or 2D.</p>

<h2 id="displays">Displays</h2>

<p>A matplotlib contour plot showing either:
    - The characteristic curve in the (x, ξ) phase plane (1D),
    - The characteristic surface slice in the (ξ, η) frequency plane at (x₀, y₀) (2D).</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.visualize_characteristic_gradient" class="classattr">
                                        <input id="PseudoDifferentialOperator.visualize_characteristic_gradient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_characteristic_gradient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x_grid</span>, </span><span class="param"><span class="n">xi_grid</span>, </span><span class="param"><span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span>, </span><span class="param"><span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.visualize_characteristic_gradient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.visualize_characteristic_gradient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1829"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1829"><span class="linenos">1829</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_characteristic_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1830"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1830"><span class="linenos">1830</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1831"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1831"><span class="linenos">1831</span></a><span class="sd">        Visualize the norm of the gradient of the symbol in phase space.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1832"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1832"><span class="linenos">1832</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1833"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1833"><span class="linenos">1833</span></a><span class="sd">        This method computes the magnitude of the gradient |∇p| of a pseudo-differential </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1834"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1834"><span class="linenos">1834</span></a><span class="sd">        symbol p(x, ξ) in 1D or p(x, y, ξ, η) in 2D. The resulting colormap reveals </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1835"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1835"><span class="linenos">1835</span></a><span class="sd">        regions where the symbol varies rapidly or remains nearly stationary, </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1836"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1836"><span class="linenos">1836</span></a><span class="sd">        which is particularly useful for analyzing characteristic sets.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1837"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1837"><span class="linenos">1837</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1838"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1838"><span class="linenos">1838</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1839"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1839"><span class="linenos">1839</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1840"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1840"><span class="linenos">1840</span></a><span class="sd">        x_grid : numpy.ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1841"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1841"><span class="linenos">1841</span></a><span class="sd">            1D array of spatial coordinates for the x-direction.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1842"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1842"><span class="linenos">1842</span></a><span class="sd">        xi_grid : numpy.ndarray</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1843"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1843"><span class="linenos">1843</span></a><span class="sd">            1D array of frequency coordinates (ξ).</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1844"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1844"><span class="linenos">1844</span></a><span class="sd">        y_grid : numpy.ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1845"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1845"><span class="linenos">1845</span></a><span class="sd">            1D array of spatial coordinates for the y-direction (used in 2D mode). Default is None.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1846"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1846"><span class="linenos">1846</span></a><span class="sd">        eta_grid : numpy.ndarray, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1847"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1847"><span class="linenos">1847</span></a><span class="sd">            1D array of frequency coordinates (η) for the 2D case. Default is None.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1848"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1848"><span class="linenos">1848</span></a><span class="sd">        x0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1849"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1849"><span class="linenos">1849</span></a><span class="sd">            Fixed x-coordinate for evaluating the symbol in 2D. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1850"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1850"><span class="linenos">1850</span></a><span class="sd">        y0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1851"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1851"><span class="linenos">1851</span></a><span class="sd">            Fixed y-coordinate for evaluating the symbol in 2D. Default is 0.0.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1852"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1852"><span class="linenos">1852</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1853"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1853"><span class="linenos">1853</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1854"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1854"><span class="linenos">1854</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1855"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1855"><span class="linenos">1855</span></a><span class="sd">        None</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1856"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1856"><span class="linenos">1856</span></a><span class="sd">            Displays a 2D colormap of |∇p| over the relevant phase-space domain.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1857"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1857"><span class="linenos">1857</span></a><span class="sd">        </span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1858"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1858"><span class="linenos">1858</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1859"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1859"><span class="linenos">1859</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1860"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1860"><span class="linenos">1860</span></a><span class="sd">        - In 1D, the full gradient ∇p = (∂ₓp, ∂ξp) is computed over the (x, ξ) grid.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1861"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1861"><span class="linenos">1861</span></a><span class="sd">        - In 2D, the gradient ∇p = (∂ξp, ∂ηp) is computed at a fixed spatial point (x₀, y₀) over the (ξ, η) grid.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1862"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1862"><span class="linenos">1862</span></a><span class="sd">        - Numerical differentiation is performed using `np.gradient`.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1863"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1863"><span class="linenos">1863</span></a><span class="sd">        - High values of |∇p| indicate rapid variation of the symbol, while low values typically suggest characteristic regions.</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1864"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1864"><span class="linenos">1864</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1865"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1865"><span class="linenos">1865</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1866"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1866"><span class="linenos">1866</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1867"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1867"><span class="linenos">1867</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1868"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1868"><span class="linenos">1868</span></a>            <span class="n">grad_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1869"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1869"><span class="linenos">1869</span></a>            <span class="n">grad_xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1870"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1870"><span class="linenos">1870</span></a>            <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grad_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grad_xi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1871"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1871"><span class="linenos">1871</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">grad_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1872"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1872"><span class="linenos">1872</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|∇p|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1873"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1873"><span class="linenos">1873</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1874"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1874"><span class="linenos">1874</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1875"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1875"><span class="linenos">1875</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gradient Norm (High Near Zeros)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1876"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1876"><span class="linenos">1876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1877"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1878"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1878"><span class="linenos">1878</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1879"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1879"><span class="linenos">1879</span></a>            <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1880"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1880"><span class="linenos">1880</span></a>            <span class="n">symbol_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi_grid2</span><span class="p">,</span> <span class="n">eta_grid2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1881"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1881"><span class="linenos">1881</span></a>            <span class="n">grad_xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1882"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1882"><span class="linenos">1882</span></a>            <span class="n">grad_eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">symbol_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1883"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1883"><span class="linenos">1883</span></a>            <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">grad_xi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">grad_eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1884"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1884"><span class="linenos">1884</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xi_grid</span><span class="p">,</span> <span class="n">eta_grid</span><span class="p">,</span> <span class="n">grad_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1885"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1885"><span class="linenos">1885</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|∇p|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1886"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1886"><span class="linenos">1886</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1887"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1887"><span class="linenos">1887</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1888"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1888"><span class="linenos">1888</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gradient Norm at x=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s1">, y=</span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1889"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1889"><span class="linenos">1889</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_characteristic_gradient-1890"><a href="#PseudoDifferentialOperator.visualize_characteristic_gradient-1890"><span class="linenos">1890</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the norm of the gradient of the symbol in phase space.</p>

<p>This method computes the magnitude of the gradient |∇p| of a pseudo-differential 
symbol p(x, ξ) in 1D or p(x, y, ξ, η) in 2D. The resulting colormap reveals 
regions where the symbol varies rapidly or remains nearly stationary, 
which is particularly useful for analyzing characteristic sets.</p>

<h2 id="parameters">Parameters</h2>

<p>x_grid : numpy.ndarray
    1D array of spatial coordinates for the x-direction.
xi_grid : numpy.ndarray
    1D array of frequency coordinates (ξ).
y_grid : numpy.ndarray, optional
    1D array of spatial coordinates for the y-direction (used in 2D mode). Default is None.
eta_grid : numpy.ndarray, optional
    1D array of frequency coordinates (η) for the 2D case. Default is None.
x0 : float, optional
    Fixed x-coordinate for evaluating the symbol in 2D. Default is 0.0.
y0 : float, optional
    Fixed y-coordinate for evaluating the symbol in 2D. Default is 0.0.</p>

<h2 id="returns">Returns</h2>

<p>None
    Displays a 2D colormap of |∇p| over the relevant phase-space domain.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D, the full gradient ∇p = (∂ₓp, ∂ξp) is computed over the (x, ξ) grid.</li>
<li>In 2D, the gradient ∇p = (∂ξp, ∂ηp) is computed at a fixed spatial point (x₀, y₀) over the (ξ, η) grid.</li>
<li>Numerical differentiation is performed using <code>np.gradient</code>.</li>
<li>High values of |∇p| indicate rapid variation of the symbol, while low values typically suggest characteristic regions.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.plot_hamiltonian_flow" class="classattr">
                                        <input id="PseudoDifferentialOperator.plot_hamiltonian_flow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_hamiltonian_flow</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">xi0</span><span class="o">=</span><span class="mf">5.0</span>,</span><span class="param">	<span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">tmax</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">n_steps</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">show_field</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.plot_hamiltonian_flow-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.plot_hamiltonian_flow"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1892"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1892"><span class="linenos">1892</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hamiltonian_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">show_field</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1893"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1893"><span class="linenos">1893</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1894"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1894"><span class="linenos">1894</span></a><span class="sd">        Integrate and plot the Hamiltonian trajectories of the symbol in phase space.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1895"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1895"><span class="linenos">1895</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1896"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1896"><span class="linenos">1896</span></a><span class="sd">        This method numerically integrates the Hamiltonian vector field derived from </span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1897"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1897"><span class="linenos">1897</span></a><span class="sd">        the operator&#39;s symbol to visualize how singularities propagate under the flow. </span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1898"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1898"><span class="linenos">1898</span></a><span class="sd">        It supports both 1D and 2D problems.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1899"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1899"><span class="linenos">1899</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1900"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1900"><span class="linenos">1900</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1901"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1901"><span class="linenos">1901</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1902"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1902"><span class="linenos">1902</span></a><span class="sd">        x0, xi0 : float</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1903"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1903"><span class="linenos">1903</span></a><span class="sd">            Initial position and frequency (momentum) in 1D.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1904"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1904"><span class="linenos">1904</span></a><span class="sd">        y0, eta0 : float, optional</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1905"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1905"><span class="linenos">1905</span></a><span class="sd">            Initial position and frequency in 2D; defaults to zero.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1906"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1906"><span class="linenos">1906</span></a><span class="sd">        tmax : float</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1907"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1907"><span class="linenos">1907</span></a><span class="sd">            Final integration time for the ODE solver.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1908"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1908"><span class="linenos">1908</span></a><span class="sd">        n_steps : int</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1909"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1909"><span class="linenos">1909</span></a><span class="sd">            Number of time steps used in the integration.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1910"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1910"><span class="linenos">1910</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1911"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1911"><span class="linenos">1911</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1912"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1912"><span class="linenos">1912</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1913"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1913"><span class="linenos">1913</span></a><span class="sd">        - The Hamiltonian vector field is obtained from the symplectic flow of the symbol.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1914"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1914"><span class="linenos">1914</span></a><span class="sd">        - If the field is complex-valued, only its real part is used for integration.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1915"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1915"><span class="linenos">1915</span></a><span class="sd">        - In 1D, the trajectory is plotted in (x, ξ) phase space.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1916"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1916"><span class="linenos">1916</span></a><span class="sd">        - In 2D, the spatial trajectory (x(t), y(t)) is shown along with instantaneous </span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1917"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1917"><span class="linenos">1917</span></a><span class="sd">          momentum vectors (ξ(t), η(t)) using a quiver plot.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1918"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1918"><span class="linenos">1918</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1919"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1919"><span class="linenos">1919</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1920"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1920"><span class="linenos">1920</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1921"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1921"><span class="linenos">1921</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1922"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1922"><span class="linenos">1922</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1923"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1923"><span class="linenos">1923</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1924"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1924"><span class="linenos">1924</span></a><span class="sd">        Displays</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1925"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1925"><span class="linenos">1925</span></a><span class="sd">        --------</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1926"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1926"><span class="linenos">1926</span></a><span class="sd">        matplotlib plot</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1927"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1927"><span class="linenos">1927</span></a><span class="sd">            Phase space trajectory(ies) showing the evolution of position and momentum </span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1928"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1928"><span class="linenos">1928</span></a><span class="sd">            under the Hamiltonian dynamics.</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1929"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1929"><span class="linenos">1929</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1930"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1930"><span class="linenos">1930</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">make_real</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1931"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1931"><span class="linenos">1931</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">simplify</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1932"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1932"><span class="linenos">1932</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">doit</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1933"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1933"><span class="linenos">1933</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">re</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1934"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1934"><span class="linenos">1934</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1935"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1935"><span class="linenos">1935</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symplectic_flow</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1936"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1936"><span class="linenos">1936</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1937"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1937"><span class="linenos">1937</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">im</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">H</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1938"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1938"><span class="linenos">1938</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ The Hamiltonian field is complex. Only the real part is used for integration.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1939"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1939"><span class="linenos">1939</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1940"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1940"><span class="linenos">1940</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1941"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1941"><span class="linenos">1941</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1942"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1942"><span class="linenos">1942</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1943"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1943"><span class="linenos">1943</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1944"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1944"><span class="linenos">1944</span></a>            <span class="n">dxdt_expr</span> <span class="o">=</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1945"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1945"><span class="linenos">1945</span></a>            <span class="n">dxidt_expr</span> <span class="o">=</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1946"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1946"><span class="linenos">1946</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1947"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1947"><span class="linenos">1947</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxdt_expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1948"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1948"><span class="linenos">1948</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxidt_expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1949"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1949"><span class="linenos">1949</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1950"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1950"><span class="linenos">1950</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1951"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1951"><span class="linenos">1951</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1952"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1952"><span class="linenos">1952</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">)]</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1953"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1953"><span class="linenos">1953</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1954"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1954"><span class="linenos">1954</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">],</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1955"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1955"><span class="linenos">1955</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1956"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1956"><span class="linenos">1956</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1957"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1957"><span class="linenos">1957</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1958"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1958"><span class="linenos">1958</span></a>            
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1959"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1959"><span class="linenos">1959</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1960"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1960"><span class="linenos">1960</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1961"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1961"><span class="linenos">1961</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1962"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1962"><span class="linenos">1962</span></a>                <span class="n">n_steps</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1963"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1963"><span class="linenos">1963</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1964"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1964"><span class="linenos">1964</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1965"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1965"><span class="linenos">1965</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1966"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1966"><span class="linenos">1966</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1967"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1967"><span class="linenos">1967</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1968"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1968"><span class="linenos">1968</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ξ&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1969"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1969"><span class="linenos">1969</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hamiltonian Flow in Phase Space (1D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1970"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1970"><span class="linenos">1970</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1971"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1971"><span class="linenos">1971</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1972"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1972"><span class="linenos">1972</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1973"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1973"><span class="linenos">1973</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1974"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1974"><span class="linenos">1974</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1975"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1975"><span class="linenos">1975</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1976"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1976"><span class="linenos">1976</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1977"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1977"><span class="linenos">1977</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1978"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1978"><span class="linenos">1978</span></a>            <span class="n">dydt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dy/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1979"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1979"><span class="linenos">1979</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1980"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1980"><span class="linenos">1980</span></a>            <span class="n">detadt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;deta/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1981"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1981"><span class="linenos">1981</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1982"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1982"><span class="linenos">1982</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1983"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1983"><span class="linenos">1983</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1984"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1984"><span class="linenos">1984</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1985"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1985"><span class="linenos">1985</span></a>                    <span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1986"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1986"><span class="linenos">1986</span></a>                    <span class="n">dydt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1987"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1987"><span class="linenos">1987</span></a>                    <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1988"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1988"><span class="linenos">1988</span></a>                    <span class="n">detadt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1989"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1989"><span class="linenos">1989</span></a>                <span class="p">]</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1990"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1990"><span class="linenos">1990</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1991"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1991"><span class="linenos">1991</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">],</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1992"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1992"><span class="linenos">1992</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1993"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1993"><span class="linenos">1993</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1994"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1994"><span class="linenos">1994</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1995"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1995"><span class="linenos">1995</span></a>            
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1996"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1996"><span class="linenos">1996</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1997"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1997"><span class="linenos">1997</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1998"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1998"><span class="linenos">1998</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-1999"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-1999"><span class="linenos">1999</span></a>                <span class="n">n_steps</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2000"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2000"><span class="linenos">2000</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2001"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2001"><span class="linenos">2001</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2002"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2002"><span class="linenos">2002</span></a>    
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2003"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2003"><span class="linenos">2003</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2004"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2004"><span class="linenos">2004</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2005"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2005"><span class="linenos">2005</span></a>            
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2006"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2006"><span class="linenos">2006</span></a>            <span class="c1"># Vector field of the flow (optional)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2007"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2007"><span class="linenos">2007</span></a>            <span class="k">if</span> <span class="n">show_field</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2008"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2008"><span class="linenos">2008</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2009"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2009"><span class="linenos">2009</span></a>                                   <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2010"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2010"><span class="linenos">2010</span></a>                <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span> <span class="o">=</span> <span class="n">xi0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">eta0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2011"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2011"><span class="linenos">2011</span></a>                <span class="n">U</span> <span class="o">=</span> <span class="n">dxdt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2012"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2012"><span class="linenos">2012</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">dydt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">ETA</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2013"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2013"><span class="linenos">2013</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2014"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2014"><span class="linenos">2014</span></a>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2015"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2015"><span class="linenos">2015</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2016"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2016"><span class="linenos">2016</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2017"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2017"><span class="linenos">2017</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hamiltonian Flow in Phase Space (2D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2018"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2018"><span class="linenos">2018</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2019"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2019"><span class="linenos">2019</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2020"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2020"><span class="linenos">2020</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_hamiltonian_flow-2021"><a href="#PseudoDifferentialOperator.plot_hamiltonian_flow-2021"><span class="linenos">2021</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Integrate and plot the Hamiltonian trajectories of the symbol in phase space.</p>

<p>This method numerically integrates the Hamiltonian vector field derived from 
the operator's symbol to visualize how singularities propagate under the flow. 
It supports both 1D and 2D problems.</p>

<h2 id="parameters">Parameters</h2>

<p>x0, xi0 : float
    Initial position and frequency (momentum) in 1D.
y0, eta0 : float, optional
    Initial position and frequency in 2D; defaults to zero.
tmax : float
    Final integration time for the ODE solver.
n_steps : int
    Number of time steps used in the integration.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The Hamiltonian vector field is obtained from the symplectic flow of the symbol.</li>
<li>If the field is complex-valued, only its real part is used for integration.</li>
<li>In 1D, the trajectory is plotted in (x, ξ) phase space.</li>
<li>In 2D, the spatial trajectory (x(t), y(t)) is shown along with instantaneous 
momentum vectors (ξ(t), η(t)) using a quiver plot.</li>
</ul>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If the spatial dimension is not 1D or 2D.</p>

<h2 id="displays">Displays</h2>

<p>matplotlib plot
    Phase space trajectory(ies) showing the evolution of position and momentum 
    under the Hamiltonian dynamics.</p>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.plot_symplectic_vector_field" class="classattr">
                                        <input id="PseudoDifferentialOperator.plot_symplectic_vector_field-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_symplectic_vector_field</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>, </span><span class="param"><span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>, </span><span class="param"><span class="n">density</span><span class="o">=</span><span class="mi">30</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.plot_symplectic_vector_field-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.plot_symplectic_vector_field"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2023"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2023"><span class="linenos">2023</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_symplectic_vector_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2024"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2024"><span class="linenos">2024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2025"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2025"><span class="linenos">2025</span></a><span class="sd">        Visualize the symplectic vector field (Hamiltonian vector field) associated with the operator&#39;s symbol.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2026"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2026"><span class="linenos">2026</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2027"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2027"><span class="linenos">2027</span></a><span class="sd">        The plotted vector field corresponds to (∂_ξ p, -∂_x p), where p(x, ξ) is the principal symbol </span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2028"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2028"><span class="linenos">2028</span></a><span class="sd">        of the pseudo-differential operator. This field governs the bicharacteristic flow in phase space.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2029"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2029"><span class="linenos">2029</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2030"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2030"><span class="linenos">2030</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2031"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2031"><span class="linenos">2031</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2032"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2032"><span class="linenos">2032</span></a><span class="sd">        xlim : tuple of float</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2033"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2033"><span class="linenos">2033</span></a><span class="sd">            Range for spatial variable x, as (x_min, x_max).</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2034"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2034"><span class="linenos">2034</span></a><span class="sd">        klim : tuple of float</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2035"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2035"><span class="linenos">2035</span></a><span class="sd">            Range for frequency variable ξ, as (ξ_min, ξ_max).</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2036"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2036"><span class="linenos">2036</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2037"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2037"><span class="linenos">2037</span></a><span class="sd">            Number of grid points per axis for the visualization grid.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2038"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2038"><span class="linenos">2038</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2039"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2039"><span class="linenos">2039</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2040"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2040"><span class="linenos">2040</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2041"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2041"><span class="linenos">2041</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2042"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2042"><span class="linenos">2042</span></a><span class="sd">            If called on a 2D operator (currently only 1D implementation available).</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2043"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2043"><span class="linenos">2043</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2044"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2044"><span class="linenos">2044</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2045"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2045"><span class="linenos">2045</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2046"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2046"><span class="linenos">2046</span></a><span class="sd">        - Only supports one-dimensional operators.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2047"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2047"><span class="linenos">2047</span></a><span class="sd">        - Uses symbolic differentiation to compute ∂_ξ p and ∂_x p.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2048"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2048"><span class="linenos">2048</span></a><span class="sd">        - Numerical evaluation is done via lambdify with NumPy backend.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2049"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2049"><span class="linenos">2049</span></a><span class="sd">        - Visualization uses matplotlib quiver plot to show vector directions.</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2050"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2050"><span class="linenos">2050</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2051"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2051"><span class="linenos">2051</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2052"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2052"><span class="linenos">2052</span></a>        <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">klim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2053"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2053"><span class="linenos">2053</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2054"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2054"><span class="linenos">2054</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2055"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2055"><span class="linenos">2055</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2056"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2056"><span class="linenos">2056</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D version implemented.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2057"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2057"><span class="linenos">2057</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2058"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2058"><span class="linenos">2058</span></a>        <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2059"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2059"><span class="linenos">2059</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2060"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2060"><span class="linenos">2060</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symplectic_flow</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2061"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2061"><span class="linenos">2061</span></a>        <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">simplify</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2062"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2062"><span class="linenos">2062</span></a>        <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">simplify</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2063"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2063"><span class="linenos">2063</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2064"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2064"><span class="linenos">2064</span></a>        <span class="n">U</span> <span class="o">=</span> <span class="n">dxdt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2065"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2065"><span class="linenos">2065</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">dxidt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2066"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2066"><span class="linenos">2066</span></a>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2067"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2067"><span class="linenos">2067</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2068"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2068"><span class="linenos">2068</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2069"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2069"><span class="linenos">2069</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2070"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2070"><span class="linenos">2070</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Symplectic Vector Field (1D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2071"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2071"><span class="linenos">2071</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.plot_symplectic_vector_field-2072"><a href="#PseudoDifferentialOperator.plot_symplectic_vector_field-2072"><span class="linenos">2072</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the symplectic vector field (Hamiltonian vector field) associated with the operator's symbol.</p>

<p>The plotted vector field corresponds to (∂_ξ p, -∂_x p), where p(x, ξ) is the principal symbol 
of the pseudo-differential operator. This field governs the bicharacteristic flow in phase space.</p>

<h2 id="parameters">Parameters</h2>

<p>xlim : tuple of float
    Range for spatial variable x, as (x_min, x_max).
klim : tuple of float
    Range for frequency variable ξ, as (ξ_min, ξ_max).
density : int
    Number of grid points per axis for the visualization grid.</p>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If called on a 2D operator (currently only 1D implementation available).</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Only supports one-dimensional operators.</li>
<li>Uses symbolic differentiation to compute ∂_ξ p and ∂_x p.</li>
<li>Numerical evaluation is done via lambdify with NumPy backend.</li>
<li>Visualization uses matplotlib quiver plot to show vector directions.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.visualize_micro_support" class="classattr">
                                        <input id="PseudoDifferentialOperator.visualize_micro_support-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_micro_support</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>, </span><span class="param"><span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>, </span><span class="param"><span class="n">threshold</span><span class="o">=</span><span class="mf">0.001</span>, </span><span class="param"><span class="n">density</span><span class="o">=</span><span class="mi">300</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.visualize_micro_support-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.visualize_micro_support"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.visualize_micro_support-2074"><a href="#PseudoDifferentialOperator.visualize_micro_support-2074"><span class="linenos">2074</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_micro_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2075"><a href="#PseudoDifferentialOperator.visualize_micro_support-2075"><span class="linenos">2075</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2076"><a href="#PseudoDifferentialOperator.visualize_micro_support-2076"><span class="linenos">2076</span></a><span class="sd">        Visualize the micro-support of the operator by plotting the inverse of the symbol magnitude 1 / |p(x, ξ)|.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2077"><a href="#PseudoDifferentialOperator.visualize_micro_support-2077"><span class="linenos">2077</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2078"><a href="#PseudoDifferentialOperator.visualize_micro_support-2078"><span class="linenos">2078</span></a><span class="sd">        The micro-support provides insight into the singularities of a pseudo-differential operator </span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2079"><a href="#PseudoDifferentialOperator.visualize_micro_support-2079"><span class="linenos">2079</span></a><span class="sd">        in phase space (x, ξ). Regions where |p(x, ξ)| is small correspond to large values in 1/|p(x, ξ)|,</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2080"><a href="#PseudoDifferentialOperator.visualize_micro_support-2080"><span class="linenos">2080</span></a><span class="sd">        highlighting areas of significant operator influence or singularity.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2081"><a href="#PseudoDifferentialOperator.visualize_micro_support-2081"><span class="linenos">2081</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2082"><a href="#PseudoDifferentialOperator.visualize_micro_support-2082"><span class="linenos">2082</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2083"><a href="#PseudoDifferentialOperator.visualize_micro_support-2083"><span class="linenos">2083</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2084"><a href="#PseudoDifferentialOperator.visualize_micro_support-2084"><span class="linenos">2084</span></a><span class="sd">        xlim : tuple</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2085"><a href="#PseudoDifferentialOperator.visualize_micro_support-2085"><span class="linenos">2085</span></a><span class="sd">            Spatial domain limits (x_min, x_max).</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2086"><a href="#PseudoDifferentialOperator.visualize_micro_support-2086"><span class="linenos">2086</span></a><span class="sd">        klim : tuple</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2087"><a href="#PseudoDifferentialOperator.visualize_micro_support-2087"><span class="linenos">2087</span></a><span class="sd">            Frequency domain limits (ξ_min, ξ_max).</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2088"><a href="#PseudoDifferentialOperator.visualize_micro_support-2088"><span class="linenos">2088</span></a><span class="sd">        threshold : float</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2089"><a href="#PseudoDifferentialOperator.visualize_micro_support-2089"><span class="linenos">2089</span></a><span class="sd">            Threshold below which |p(x, ξ)| is considered effectively zero; used for numerical stability.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2090"><a href="#PseudoDifferentialOperator.visualize_micro_support-2090"><span class="linenos">2090</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2091"><a href="#PseudoDifferentialOperator.visualize_micro_support-2091"><span class="linenos">2091</span></a><span class="sd">            Number of grid points along each axis for visualization resolution.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2092"><a href="#PseudoDifferentialOperator.visualize_micro_support-2092"><span class="linenos">2092</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2093"><a href="#PseudoDifferentialOperator.visualize_micro_support-2093"><span class="linenos">2093</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2094"><a href="#PseudoDifferentialOperator.visualize_micro_support-2094"><span class="linenos">2094</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2095"><a href="#PseudoDifferentialOperator.visualize_micro_support-2095"><span class="linenos">2095</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2096"><a href="#PseudoDifferentialOperator.visualize_micro_support-2096"><span class="linenos">2096</span></a><span class="sd">            If called on a solver with dimension greater than 1 (only 1D visualization is supported).</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2097"><a href="#PseudoDifferentialOperator.visualize_micro_support-2097"><span class="linenos">2097</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2098"><a href="#PseudoDifferentialOperator.visualize_micro_support-2098"><span class="linenos">2098</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2099"><a href="#PseudoDifferentialOperator.visualize_micro_support-2099"><span class="linenos">2099</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2100"><a href="#PseudoDifferentialOperator.visualize_micro_support-2100"><span class="linenos">2100</span></a><span class="sd">        - This method evaluates the symbol p(x, ξ) over a grid and plots its reciprocal to emphasize </span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2101"><a href="#PseudoDifferentialOperator.visualize_micro_support-2101"><span class="linenos">2101</span></a><span class="sd">          regions where the symbol is near zero.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2102"><a href="#PseudoDifferentialOperator.visualize_micro_support-2102"><span class="linenos">2102</span></a><span class="sd">        - A small constant (1e-10) is added to the denominator to avoid division by zero.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2103"><a href="#PseudoDifferentialOperator.visualize_micro_support-2103"><span class="linenos">2103</span></a><span class="sd">        - The resulting plot helps identify characteristic sets.</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2104"><a href="#PseudoDifferentialOperator.visualize_micro_support-2104"><span class="linenos">2104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2105"><a href="#PseudoDifferentialOperator.visualize_micro_support-2105"><span class="linenos">2105</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2106"><a href="#PseudoDifferentialOperator.visualize_micro_support-2106"><span class="linenos">2106</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D micro-support visualization implemented.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2107"><a href="#PseudoDifferentialOperator.visualize_micro_support-2107"><span class="linenos">2107</span></a>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2108"><a href="#PseudoDifferentialOperator.visualize_micro_support-2108"><span class="linenos">2108</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2109"><a href="#PseudoDifferentialOperator.visualize_micro_support-2109"><span class="linenos">2109</span></a>        <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">klim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2110"><a href="#PseudoDifferentialOperator.visualize_micro_support-2110"><span class="linenos">2110</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2111"><a href="#PseudoDifferentialOperator.visualize_micro_support-2111"><span class="linenos">2111</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2112"><a href="#PseudoDifferentialOperator.visualize_micro_support-2112"><span class="linenos">2112</span></a>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2113"><a href="#PseudoDifferentialOperator.visualize_micro_support-2113"><span class="linenos">2113</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2114"><a href="#PseudoDifferentialOperator.visualize_micro_support-2114"><span class="linenos">2114</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$1/|p(x,\xi)|$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2115"><a href="#PseudoDifferentialOperator.visualize_micro_support-2115"><span class="linenos">2115</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2116"><a href="#PseudoDifferentialOperator.visualize_micro_support-2116"><span class="linenos">2116</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2117"><a href="#PseudoDifferentialOperator.visualize_micro_support-2117"><span class="linenos">2117</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Micro-Support Estimate (1/|Symbol|)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.visualize_micro_support-2118"><a href="#PseudoDifferentialOperator.visualize_micro_support-2118"><span class="linenos">2118</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the micro-support of the operator by plotting the inverse of the symbol magnitude 1 / |p(x, ξ)|.</p>

<p>The micro-support provides insight into the singularities of a pseudo-differential operator 
in phase space (x, ξ). Regions where |p(x, ξ)| is small correspond to large values in 1/|p(x, ξ)|,
highlighting areas of significant operator influence or singularity.</p>

<h2 id="parameters">Parameters</h2>

<p>xlim : tuple
    Spatial domain limits (x_min, x_max).
klim : tuple
    Frequency domain limits (ξ_min, ξ_max).
threshold : float
    Threshold below which |p(x, ξ)| is considered effectively zero; used for numerical stability.
density : int
    Number of grid points along each axis for visualization resolution.</p>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If called on a solver with dimension greater than 1 (only 1D visualization is supported).</p>

<h2 id="notes">Notes</h2>

<ul>
<li>This method evaluates the symbol p(x, ξ) over a grid and plots its reciprocal to emphasize 
regions where the symbol is near zero.</li>
<li>A small constant (1e-10) is added to the denominator to avoid division by zero.</li>
<li>The resulting plot helps identify characteristic sets.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.group_velocity_field" class="classattr">
                                        <input id="PseudoDifferentialOperator.group_velocity_field-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">group_velocity_field</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>, </span><span class="param"><span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>, </span><span class="param"><span class="n">density</span><span class="o">=</span><span class="mi">30</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.group_velocity_field-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.group_velocity_field"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.group_velocity_field-2120"><a href="#PseudoDifferentialOperator.group_velocity_field-2120"><span class="linenos">2120</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">group_velocity_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">klim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2121"><a href="#PseudoDifferentialOperator.group_velocity_field-2121"><span class="linenos">2121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2122"><a href="#PseudoDifferentialOperator.group_velocity_field-2122"><span class="linenos">2122</span></a><span class="sd">        Plot the group velocity field ∇_ξ p(x, ξ) for 1D pseudo-differential operators.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2123"><a href="#PseudoDifferentialOperator.group_velocity_field-2123"><span class="linenos">2123</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2124"><a href="#PseudoDifferentialOperator.group_velocity_field-2124"><span class="linenos">2124</span></a><span class="sd">        The group velocity represents the speed at which waves of different frequencies propagate </span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2125"><a href="#PseudoDifferentialOperator.group_velocity_field-2125"><span class="linenos">2125</span></a><span class="sd">        in a dispersive medium. It is defined as the gradient of the symbol p(x, ξ) with respect </span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2126"><a href="#PseudoDifferentialOperator.group_velocity_field-2126"><span class="linenos">2126</span></a><span class="sd">        to the frequency variable ξ.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2127"><a href="#PseudoDifferentialOperator.group_velocity_field-2127"><span class="linenos">2127</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2128"><a href="#PseudoDifferentialOperator.group_velocity_field-2128"><span class="linenos">2128</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2129"><a href="#PseudoDifferentialOperator.group_velocity_field-2129"><span class="linenos">2129</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2130"><a href="#PseudoDifferentialOperator.group_velocity_field-2130"><span class="linenos">2130</span></a><span class="sd">        xlim : tuple of float</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2131"><a href="#PseudoDifferentialOperator.group_velocity_field-2131"><span class="linenos">2131</span></a><span class="sd">            Spatial domain limits (x-axis).</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2132"><a href="#PseudoDifferentialOperator.group_velocity_field-2132"><span class="linenos">2132</span></a><span class="sd">        klim : tuple of float</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2133"><a href="#PseudoDifferentialOperator.group_velocity_field-2133"><span class="linenos">2133</span></a><span class="sd">            Frequency domain limits (ξ-axis).</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2134"><a href="#PseudoDifferentialOperator.group_velocity_field-2134"><span class="linenos">2134</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2135"><a href="#PseudoDifferentialOperator.group_velocity_field-2135"><span class="linenos">2135</span></a><span class="sd">            Number of grid points per axis used for visualization.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2136"><a href="#PseudoDifferentialOperator.group_velocity_field-2136"><span class="linenos">2136</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2137"><a href="#PseudoDifferentialOperator.group_velocity_field-2137"><span class="linenos">2137</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2138"><a href="#PseudoDifferentialOperator.group_velocity_field-2138"><span class="linenos">2138</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2139"><a href="#PseudoDifferentialOperator.group_velocity_field-2139"><span class="linenos">2139</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2140"><a href="#PseudoDifferentialOperator.group_velocity_field-2140"><span class="linenos">2140</span></a><span class="sd">            If called on a 2D operator, since this visualization is only implemented for 1D.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2141"><a href="#PseudoDifferentialOperator.group_velocity_field-2141"><span class="linenos">2141</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2142"><a href="#PseudoDifferentialOperator.group_velocity_field-2142"><span class="linenos">2142</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2143"><a href="#PseudoDifferentialOperator.group_velocity_field-2143"><span class="linenos">2143</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2144"><a href="#PseudoDifferentialOperator.group_velocity_field-2144"><span class="linenos">2144</span></a><span class="sd">        - This method visualizes the vector field (∂p/∂ξ) in phase space.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2145"><a href="#PseudoDifferentialOperator.group_velocity_field-2145"><span class="linenos">2145</span></a><span class="sd">        - Used for analyzing wave propagation properties and dispersion relations.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2146"><a href="#PseudoDifferentialOperator.group_velocity_field-2146"><span class="linenos">2146</span></a><span class="sd">        - Requires symbolic expression self.expr depending on x and ξ.</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2147"><a href="#PseudoDifferentialOperator.group_velocity_field-2147"><span class="linenos">2147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2148"><a href="#PseudoDifferentialOperator.group_velocity_field-2148"><span class="linenos">2148</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2149"><a href="#PseudoDifferentialOperator.group_velocity_field-2149"><span class="linenos">2149</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D group velocity visualization implemented.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2150"><a href="#PseudoDifferentialOperator.group_velocity_field-2150"><span class="linenos">2150</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2151"><a href="#PseudoDifferentialOperator.group_velocity_field-2151"><span class="linenos">2151</span></a>        <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2152"><a href="#PseudoDifferentialOperator.group_velocity_field-2152"><span class="linenos">2152</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2153"><a href="#PseudoDifferentialOperator.group_velocity_field-2153"><span class="linenos">2153</span></a>        <span class="n">dp_dxi</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2154"><a href="#PseudoDifferentialOperator.group_velocity_field-2154"><span class="linenos">2154</span></a>        <span class="n">grad_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dp_dxi</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2155"><a href="#PseudoDifferentialOperator.group_velocity_field-2155"><span class="linenos">2155</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2156"><a href="#PseudoDifferentialOperator.group_velocity_field-2156"><span class="linenos">2156</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2157"><a href="#PseudoDifferentialOperator.group_velocity_field-2157"><span class="linenos">2157</span></a>        <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">klim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2158"><a href="#PseudoDifferentialOperator.group_velocity_field-2158"><span class="linenos">2158</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">XI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2159"><a href="#PseudoDifferentialOperator.group_velocity_field-2159"><span class="linenos">2159</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">grad_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2160"><a href="#PseudoDifferentialOperator.group_velocity_field-2160"><span class="linenos">2160</span></a>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2161"><a href="#PseudoDifferentialOperator.group_velocity_field-2161"><span class="linenos">2161</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XI</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2162"><a href="#PseudoDifferentialOperator.group_velocity_field-2162"><span class="linenos">2162</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2163"><a href="#PseudoDifferentialOperator.group_velocity_field-2163"><span class="linenos">2163</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2164"><a href="#PseudoDifferentialOperator.group_velocity_field-2164"><span class="linenos">2164</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Group Velocity Field (1D)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2165"><a href="#PseudoDifferentialOperator.group_velocity_field-2165"><span class="linenos">2165</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.group_velocity_field-2166"><a href="#PseudoDifferentialOperator.group_velocity_field-2166"><span class="linenos">2166</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the group velocity field ∇_ξ p(x, ξ) for 1D pseudo-differential operators.</p>

<p>The group velocity represents the speed at which waves of different frequencies propagate 
in a dispersive medium. It is defined as the gradient of the symbol p(x, ξ) with respect 
to the frequency variable ξ.</p>

<h2 id="parameters">Parameters</h2>

<p>xlim : tuple of float
    Spatial domain limits (x-axis).
klim : tuple of float
    Frequency domain limits (ξ-axis).
density : int
    Number of grid points per axis used for visualization.</p>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If called on a 2D operator, since this visualization is only implemented for 1D.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>This method visualizes the vector field (∂p/∂ξ) in phase space.</li>
<li>Used for analyzing wave propagation properties and dispersion relations.</li>
<li>Requires symbolic expression self.expr depending on x and ξ.</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.animate_singularity" class="classattr">
                                        <input id="PseudoDifferentialOperator.animate_singularity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">animate_singularity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">xi0</span><span class="o">=</span><span class="mf">5.0</span>,</span><span class="param">	<span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">tmax</span><span class="o">=</span><span class="mf">4.0</span>,</span><span class="param">	<span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">projection</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.animate_singularity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.animate_singularity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.animate_singularity-2168"><a href="#PseudoDifferentialOperator.animate_singularity-2168"><span class="linenos">2168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">animate_singularity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2169"><a href="#PseudoDifferentialOperator.animate_singularity-2169"><span class="linenos">2169</span></a>                            <span class="n">tmax</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2170"><a href="#PseudoDifferentialOperator.animate_singularity-2170"><span class="linenos">2170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2171"><a href="#PseudoDifferentialOperator.animate_singularity-2171"><span class="linenos">2171</span></a><span class="sd">        Animate the propagation of a singularity under the Hamiltonian flow.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2172"><a href="#PseudoDifferentialOperator.animate_singularity-2172"><span class="linenos">2172</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2173"><a href="#PseudoDifferentialOperator.animate_singularity-2173"><span class="linenos">2173</span></a><span class="sd">        This method visualizes how a singularity (x₀, y₀, ξ₀, η₀) evolves in phase space </span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2174"><a href="#PseudoDifferentialOperator.animate_singularity-2174"><span class="linenos">2174</span></a><span class="sd">        according to the Hamiltonian dynamics induced by the principal symbol of the operator.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2175"><a href="#PseudoDifferentialOperator.animate_singularity-2175"><span class="linenos">2175</span></a><span class="sd">        The animation integrates the Hamiltonian equations of motion and supports various projections:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2176"><a href="#PseudoDifferentialOperator.animate_singularity-2176"><span class="linenos">2176</span></a><span class="sd">        position (x-y), frequency (ξ-η), or mixed phase space coordinates.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2177"><a href="#PseudoDifferentialOperator.animate_singularity-2177"><span class="linenos">2177</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2178"><a href="#PseudoDifferentialOperator.animate_singularity-2178"><span class="linenos">2178</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2179"><a href="#PseudoDifferentialOperator.animate_singularity-2179"><span class="linenos">2179</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2180"><a href="#PseudoDifferentialOperator.animate_singularity-2180"><span class="linenos">2180</span></a><span class="sd">        xi0, eta0 : float</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2181"><a href="#PseudoDifferentialOperator.animate_singularity-2181"><span class="linenos">2181</span></a><span class="sd">            Initial frequency components (ξ₀, η₀).</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2182"><a href="#PseudoDifferentialOperator.animate_singularity-2182"><span class="linenos">2182</span></a><span class="sd">        x0, y0 : float</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2183"><a href="#PseudoDifferentialOperator.animate_singularity-2183"><span class="linenos">2183</span></a><span class="sd">            Initial spatial coordinates (x₀, y₀).</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2184"><a href="#PseudoDifferentialOperator.animate_singularity-2184"><span class="linenos">2184</span></a><span class="sd">        tmax : float</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2185"><a href="#PseudoDifferentialOperator.animate_singularity-2185"><span class="linenos">2185</span></a><span class="sd">            Total time of integration (final animation time).</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2186"><a href="#PseudoDifferentialOperator.animate_singularity-2186"><span class="linenos">2186</span></a><span class="sd">        n_frames : int</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2187"><a href="#PseudoDifferentialOperator.animate_singularity-2187"><span class="linenos">2187</span></a><span class="sd">            Number of frames in the resulting animation.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2188"><a href="#PseudoDifferentialOperator.animate_singularity-2188"><span class="linenos">2188</span></a><span class="sd">        projection : str or None</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2189"><a href="#PseudoDifferentialOperator.animate_singularity-2189"><span class="linenos">2189</span></a><span class="sd">            Type of projection to display:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2190"><a href="#PseudoDifferentialOperator.animate_singularity-2190"><span class="linenos">2190</span></a><span class="sd">                - &#39;position&#39; : x vs y (or x alone in 1D)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2191"><a href="#PseudoDifferentialOperator.animate_singularity-2191"><span class="linenos">2191</span></a><span class="sd">                - &#39;frequency&#39;: ξ vs η (or ξ alone in 1D)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2192"><a href="#PseudoDifferentialOperator.animate_singularity-2192"><span class="linenos">2192</span></a><span class="sd">                - &#39;phase&#39;    : mixed coordinates like x vs ξ or x vs η</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2193"><a href="#PseudoDifferentialOperator.animate_singularity-2193"><span class="linenos">2193</span></a><span class="sd">                If None, defaults to &#39;phase&#39; in 1D and &#39;position&#39; in 2D.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2194"><a href="#PseudoDifferentialOperator.animate_singularity-2194"><span class="linenos">2194</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2195"><a href="#PseudoDifferentialOperator.animate_singularity-2195"><span class="linenos">2195</span></a><span class="sd">        Returns</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2196"><a href="#PseudoDifferentialOperator.animate_singularity-2196"><span class="linenos">2196</span></a><span class="sd">        -------</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2197"><a href="#PseudoDifferentialOperator.animate_singularity-2197"><span class="linenos">2197</span></a><span class="sd">        matplotlib.animation.FuncAnimation</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2198"><a href="#PseudoDifferentialOperator.animate_singularity-2198"><span class="linenos">2198</span></a><span class="sd">            Animation object that can be displayed interactively in Jupyter notebooks or saved as a video.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2199"><a href="#PseudoDifferentialOperator.animate_singularity-2199"><span class="linenos">2199</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2200"><a href="#PseudoDifferentialOperator.animate_singularity-2200"><span class="linenos">2200</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2201"><a href="#PseudoDifferentialOperator.animate_singularity-2201"><span class="linenos">2201</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2202"><a href="#PseudoDifferentialOperator.animate_singularity-2202"><span class="linenos">2202</span></a><span class="sd">        - In 1D, only one spatial and one frequency variable are used.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2203"><a href="#PseudoDifferentialOperator.animate_singularity-2203"><span class="linenos">2203</span></a><span class="sd">        - Complex-valued Hamiltonian fields are truncated to their real parts for integration.</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2204"><a href="#PseudoDifferentialOperator.animate_singularity-2204"><span class="linenos">2204</span></a><span class="sd">        - Trajectories are shown with both instantaneous position (dot) and full path (dashed line).</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2205"><a href="#PseudoDifferentialOperator.animate_singularity-2205"><span class="linenos">2205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2206"><a href="#PseudoDifferentialOperator.animate_singularity-2206"><span class="linenos">2206</span></a>        <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;animation&#39;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="s1">&#39;jshtml&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2207"><a href="#PseudoDifferentialOperator.animate_singularity-2207"><span class="linenos">2207</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2208"><a href="#PseudoDifferentialOperator.animate_singularity-2208"><span class="linenos">2208</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">make_real</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2209"><a href="#PseudoDifferentialOperator.animate_singularity-2209"><span class="linenos">2209</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">simplify</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2210"><a href="#PseudoDifferentialOperator.animate_singularity-2210"><span class="linenos">2210</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">doit</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2211"><a href="#PseudoDifferentialOperator.animate_singularity-2211"><span class="linenos">2211</span></a>            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">re</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2212"><a href="#PseudoDifferentialOperator.animate_singularity-2212"><span class="linenos">2212</span></a>  
</span><span id="PseudoDifferentialOperator.animate_singularity-2213"><a href="#PseudoDifferentialOperator.animate_singularity-2213"><span class="linenos">2213</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symplectic_flow</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2214"><a href="#PseudoDifferentialOperator.animate_singularity-2214"><span class="linenos">2214</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2215"><a href="#PseudoDifferentialOperator.animate_singularity-2215"><span class="linenos">2215</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">doit</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">H</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2216"><a href="#PseudoDifferentialOperator.animate_singularity-2216"><span class="linenos">2216</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2217"><a href="#PseudoDifferentialOperator.animate_singularity-2217"><span class="linenos">2217</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;H = &quot;</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2218"><a href="#PseudoDifferentialOperator.animate_singularity-2218"><span class="linenos">2218</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2219"><a href="#PseudoDifferentialOperator.animate_singularity-2219"><span class="linenos">2219</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">im</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">H</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2220"><a href="#PseudoDifferentialOperator.animate_singularity-2220"><span class="linenos">2220</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ The Hamiltonian field is complex. Only the real part is used for integration.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2221"><a href="#PseudoDifferentialOperator.animate_singularity-2221"><span class="linenos">2221</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2222"><a href="#PseudoDifferentialOperator.animate_singularity-2222"><span class="linenos">2222</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2223"><a href="#PseudoDifferentialOperator.animate_singularity-2223"><span class="linenos">2223</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2224"><a href="#PseudoDifferentialOperator.animate_singularity-2224"><span class="linenos">2224</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2225"><a href="#PseudoDifferentialOperator.animate_singularity-2225"><span class="linenos">2225</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2226"><a href="#PseudoDifferentialOperator.animate_singularity-2226"><span class="linenos">2226</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2227"><a href="#PseudoDifferentialOperator.animate_singularity-2227"><span class="linenos">2227</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2228"><a href="#PseudoDifferentialOperator.animate_singularity-2228"><span class="linenos">2228</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2229"><a href="#PseudoDifferentialOperator.animate_singularity-2229"><span class="linenos">2229</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2230"><a href="#PseudoDifferentialOperator.animate_singularity-2230"><span class="linenos">2230</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2231"><a href="#PseudoDifferentialOperator.animate_singularity-2231"><span class="linenos">2231</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">)]</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2232"><a href="#PseudoDifferentialOperator.animate_singularity-2232"><span class="linenos">2232</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2233"><a href="#PseudoDifferentialOperator.animate_singularity-2233"><span class="linenos">2233</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2234"><a href="#PseudoDifferentialOperator.animate_singularity-2234"><span class="linenos">2234</span></a>                            <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2235"><a href="#PseudoDifferentialOperator.animate_singularity-2235"><span class="linenos">2235</span></a>            
</span><span id="PseudoDifferentialOperator.animate_singularity-2236"><a href="#PseudoDifferentialOperator.animate_singularity-2236"><span class="linenos">2236</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2237"><a href="#PseudoDifferentialOperator.animate_singularity-2237"><span class="linenos">2237</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2238"><a href="#PseudoDifferentialOperator.animate_singularity-2238"><span class="linenos">2238</span></a>            
</span><span id="PseudoDifferentialOperator.animate_singularity-2239"><a href="#PseudoDifferentialOperator.animate_singularity-2239"><span class="linenos">2239</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2240"><a href="#PseudoDifferentialOperator.animate_singularity-2240"><span class="linenos">2240</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_frames</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2241"><a href="#PseudoDifferentialOperator.animate_singularity-2241"><span class="linenos">2241</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2242"><a href="#PseudoDifferentialOperator.animate_singularity-2242"><span class="linenos">2242</span></a>                <span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2243"><a href="#PseudoDifferentialOperator.animate_singularity-2243"><span class="linenos">2243</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2244"><a href="#PseudoDifferentialOperator.animate_singularity-2244"><span class="linenos">2244</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2245"><a href="#PseudoDifferentialOperator.animate_singularity-2245"><span class="linenos">2245</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2246"><a href="#PseudoDifferentialOperator.animate_singularity-2246"><span class="linenos">2246</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2247"><a href="#PseudoDifferentialOperator.animate_singularity-2247"><span class="linenos">2247</span></a>                <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;phase&#39;</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2248"><a href="#PseudoDifferentialOperator.animate_singularity-2248"><span class="linenos">2248</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2249"><a href="#PseudoDifferentialOperator.animate_singularity-2249"><span class="linenos">2249</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2250"><a href="#PseudoDifferentialOperator.animate_singularity-2250"><span class="linenos">2250</span></a>            <span class="n">point</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2251"><a href="#PseudoDifferentialOperator.animate_singularity-2251"><span class="linenos">2251</span></a>            <span class="n">traj</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2252"><a href="#PseudoDifferentialOperator.animate_singularity-2252"><span class="linenos">2252</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2253"><a href="#PseudoDifferentialOperator.animate_singularity-2253"><span class="linenos">2253</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2254"><a href="#PseudoDifferentialOperator.animate_singularity-2254"><span class="linenos">2254</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2255"><a href="#PseudoDifferentialOperator.animate_singularity-2255"><span class="linenos">2255</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2256"><a href="#PseudoDifferentialOperator.animate_singularity-2256"><span class="linenos">2256</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2257"><a href="#PseudoDifferentialOperator.animate_singularity-2257"><span class="linenos">2257</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2258"><a href="#PseudoDifferentialOperator.animate_singularity-2258"><span class="linenos">2258</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2259"><a href="#PseudoDifferentialOperator.animate_singularity-2259"><span class="linenos">2259</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2260"><a href="#PseudoDifferentialOperator.animate_singularity-2260"><span class="linenos">2260</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2261"><a href="#PseudoDifferentialOperator.animate_singularity-2261"><span class="linenos">2261</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2262"><a href="#PseudoDifferentialOperator.animate_singularity-2262"><span class="linenos">2262</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2263"><a href="#PseudoDifferentialOperator.animate_singularity-2263"><span class="linenos">2263</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2264"><a href="#PseudoDifferentialOperator.animate_singularity-2264"><span class="linenos">2264</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2265"><a href="#PseudoDifferentialOperator.animate_singularity-2265"><span class="linenos">2265</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2266"><a href="#PseudoDifferentialOperator.animate_singularity-2266"><span class="linenos">2266</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2267"><a href="#PseudoDifferentialOperator.animate_singularity-2267"><span class="linenos">2267</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2268"><a href="#PseudoDifferentialOperator.animate_singularity-2268"><span class="linenos">2268</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2269"><a href="#PseudoDifferentialOperator.animate_singularity-2269"><span class="linenos">2269</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2270"><a href="#PseudoDifferentialOperator.animate_singularity-2270"><span class="linenos">2270</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2271"><a href="#PseudoDifferentialOperator.animate_singularity-2271"><span class="linenos">2271</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2272"><a href="#PseudoDifferentialOperator.animate_singularity-2272"><span class="linenos">2272</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2273"><a href="#PseudoDifferentialOperator.animate_singularity-2273"><span class="linenos">2273</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2274"><a href="#PseudoDifferentialOperator.animate_singularity-2274"><span class="linenos">2274</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2275"><a href="#PseudoDifferentialOperator.animate_singularity-2275"><span class="linenos">2275</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2276"><a href="#PseudoDifferentialOperator.animate_singularity-2276"><span class="linenos">2276</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2277"><a href="#PseudoDifferentialOperator.animate_singularity-2277"><span class="linenos">2277</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2278"><a href="#PseudoDifferentialOperator.animate_singularity-2278"><span class="linenos">2278</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2279"><a href="#PseudoDifferentialOperator.animate_singularity-2279"><span class="linenos">2279</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2280"><a href="#PseudoDifferentialOperator.animate_singularity-2280"><span class="linenos">2280</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2281"><a href="#PseudoDifferentialOperator.animate_singularity-2281"><span class="linenos">2281</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2282"><a href="#PseudoDifferentialOperator.animate_singularity-2282"><span class="linenos">2282</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2283"><a href="#PseudoDifferentialOperator.animate_singularity-2283"><span class="linenos">2283</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2284"><a href="#PseudoDifferentialOperator.animate_singularity-2284"><span class="linenos">2284</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2285"><a href="#PseudoDifferentialOperator.animate_singularity-2285"><span class="linenos">2285</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2286"><a href="#PseudoDifferentialOperator.animate_singularity-2286"><span class="linenos">2286</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2287"><a href="#PseudoDifferentialOperator.animate_singularity-2287"><span class="linenos">2287</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid projection mode&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2288"><a href="#PseudoDifferentialOperator.animate_singularity-2288"><span class="linenos">2288</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2289"><a href="#PseudoDifferentialOperator.animate_singularity-2289"><span class="linenos">2289</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1D Singularity Flow (</span><span class="si">{</span><span class="n">projection</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2290"><a href="#PseudoDifferentialOperator.animate_singularity-2290"><span class="linenos">2290</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2291"><a href="#PseudoDifferentialOperator.animate_singularity-2291"><span class="linenos">2291</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2292"><a href="#PseudoDifferentialOperator.animate_singularity-2292"><span class="linenos">2292</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2293"><a href="#PseudoDifferentialOperator.animate_singularity-2293"><span class="linenos">2293</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2294"><a href="#PseudoDifferentialOperator.animate_singularity-2294"><span class="linenos">2294</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2295"><a href="#PseudoDifferentialOperator.animate_singularity-2295"><span class="linenos">2295</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2296"><a href="#PseudoDifferentialOperator.animate_singularity-2296"><span class="linenos">2296</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2297"><a href="#PseudoDifferentialOperator.animate_singularity-2297"><span class="linenos">2297</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2298"><a href="#PseudoDifferentialOperator.animate_singularity-2298"><span class="linenos">2298</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2299"><a href="#PseudoDifferentialOperator.animate_singularity-2299"><span class="linenos">2299</span></a>            <span class="n">dxdt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dx/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2300"><a href="#PseudoDifferentialOperator.animate_singularity-2300"><span class="linenos">2300</span></a>            <span class="n">dydt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dy/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2301"><a href="#PseudoDifferentialOperator.animate_singularity-2301"><span class="linenos">2301</span></a>            <span class="n">dxidt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;dxi/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2302"><a href="#PseudoDifferentialOperator.animate_singularity-2302"><span class="linenos">2302</span></a>            <span class="n">detadt</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">make_real</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;deta/dt&#39;</span><span class="p">]),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2303"><a href="#PseudoDifferentialOperator.animate_singularity-2303"><span class="linenos">2303</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2304"><a href="#PseudoDifferentialOperator.animate_singularity-2304"><span class="linenos">2304</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">hamilton</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2305"><a href="#PseudoDifferentialOperator.animate_singularity-2305"><span class="linenos">2305</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2306"><a href="#PseudoDifferentialOperator.animate_singularity-2306"><span class="linenos">2306</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2307"><a href="#PseudoDifferentialOperator.animate_singularity-2307"><span class="linenos">2307</span></a>                    <span class="n">dxdt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2308"><a href="#PseudoDifferentialOperator.animate_singularity-2308"><span class="linenos">2308</span></a>                    <span class="n">dydt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2309"><a href="#PseudoDifferentialOperator.animate_singularity-2309"><span class="linenos">2309</span></a>                    <span class="n">dxidt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2310"><a href="#PseudoDifferentialOperator.animate_singularity-2310"><span class="linenos">2310</span></a>                    <span class="n">detadt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2311"><a href="#PseudoDifferentialOperator.animate_singularity-2311"><span class="linenos">2311</span></a>                <span class="p">]</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2312"><a href="#PseudoDifferentialOperator.animate_singularity-2312"><span class="linenos">2312</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2313"><a href="#PseudoDifferentialOperator.animate_singularity-2313"><span class="linenos">2313</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">hamilton</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">],</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">],</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2314"><a href="#PseudoDifferentialOperator.animate_singularity-2314"><span class="linenos">2314</span></a>                            <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2315"><a href="#PseudoDifferentialOperator.animate_singularity-2315"><span class="linenos">2315</span></a>
</span><span id="PseudoDifferentialOperator.animate_singularity-2316"><a href="#PseudoDifferentialOperator.animate_singularity-2316"><span class="linenos">2316</span></a>            <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2317"><a href="#PseudoDifferentialOperator.animate_singularity-2317"><span class="linenos">2317</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Integration warning: </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2318"><a href="#PseudoDifferentialOperator.animate_singularity-2318"><span class="linenos">2318</span></a>            
</span><span id="PseudoDifferentialOperator.animate_singularity-2319"><a href="#PseudoDifferentialOperator.animate_singularity-2319"><span class="linenos">2319</span></a>            <span class="n">n_points</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2320"><a href="#PseudoDifferentialOperator.animate_singularity-2320"><span class="linenos">2320</span></a>            <span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="n">n_frames</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2321"><a href="#PseudoDifferentialOperator.animate_singularity-2321"><span class="linenos">2321</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Only </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> frames computed. Adjusting animation.&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2322"><a href="#PseudoDifferentialOperator.animate_singularity-2322"><span class="linenos">2322</span></a>                <span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_points</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2323"><a href="#PseudoDifferentialOperator.animate_singularity-2323"><span class="linenos">2323</span></a>                
</span><span id="PseudoDifferentialOperator.animate_singularity-2324"><a href="#PseudoDifferentialOperator.animate_singularity-2324"><span class="linenos">2324</span></a>            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">xi_vals</span><span class="p">,</span> <span class="n">eta_vals</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2325"><a href="#PseudoDifferentialOperator.animate_singularity-2325"><span class="linenos">2325</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2326"><a href="#PseudoDifferentialOperator.animate_singularity-2326"><span class="linenos">2326</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2327"><a href="#PseudoDifferentialOperator.animate_singularity-2327"><span class="linenos">2327</span></a>                <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;position&#39;</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2328"><a href="#PseudoDifferentialOperator.animate_singularity-2328"><span class="linenos">2328</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2329"><a href="#PseudoDifferentialOperator.animate_singularity-2329"><span class="linenos">2329</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2330"><a href="#PseudoDifferentialOperator.animate_singularity-2330"><span class="linenos">2330</span></a>            <span class="n">point</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2331"><a href="#PseudoDifferentialOperator.animate_singularity-2331"><span class="linenos">2331</span></a>            <span class="n">traj</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2332"><a href="#PseudoDifferentialOperator.animate_singularity-2332"><span class="linenos">2332</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2333"><a href="#PseudoDifferentialOperator.animate_singularity-2333"><span class="linenos">2333</span></a>            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2334"><a href="#PseudoDifferentialOperator.animate_singularity-2334"><span class="linenos">2334</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2335"><a href="#PseudoDifferentialOperator.animate_singularity-2335"><span class="linenos">2335</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2336"><a href="#PseudoDifferentialOperator.animate_singularity-2336"><span class="linenos">2336</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2337"><a href="#PseudoDifferentialOperator.animate_singularity-2337"><span class="linenos">2337</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2338"><a href="#PseudoDifferentialOperator.animate_singularity-2338"><span class="linenos">2338</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2339"><a href="#PseudoDifferentialOperator.animate_singularity-2339"><span class="linenos">2339</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2340"><a href="#PseudoDifferentialOperator.animate_singularity-2340"><span class="linenos">2340</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">y_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2341"><a href="#PseudoDifferentialOperator.animate_singularity-2341"><span class="linenos">2341</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2342"><a href="#PseudoDifferentialOperator.animate_singularity-2342"><span class="linenos">2342</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2343"><a href="#PseudoDifferentialOperator.animate_singularity-2343"><span class="linenos">2343</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2344"><a href="#PseudoDifferentialOperator.animate_singularity-2344"><span class="linenos">2344</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2345"><a href="#PseudoDifferentialOperator.animate_singularity-2345"><span class="linenos">2345</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\xi$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2346"><a href="#PseudoDifferentialOperator.animate_singularity-2346"><span class="linenos">2346</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\eta$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2347"><a href="#PseudoDifferentialOperator.animate_singularity-2347"><span class="linenos">2347</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2348"><a href="#PseudoDifferentialOperator.animate_singularity-2348"><span class="linenos">2348</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2349"><a href="#PseudoDifferentialOperator.animate_singularity-2349"><span class="linenos">2349</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2350"><a href="#PseudoDifferentialOperator.animate_singularity-2350"><span class="linenos">2350</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2351"><a href="#PseudoDifferentialOperator.animate_singularity-2351"><span class="linenos">2351</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xi_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">eta_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2352"><a href="#PseudoDifferentialOperator.animate_singularity-2352"><span class="linenos">2352</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">xi_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">eta_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2353"><a href="#PseudoDifferentialOperator.animate_singularity-2353"><span class="linenos">2353</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2354"><a href="#PseudoDifferentialOperator.animate_singularity-2354"><span class="linenos">2354</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2355"><a href="#PseudoDifferentialOperator.animate_singularity-2355"><span class="linenos">2355</span></a>            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2356"><a href="#PseudoDifferentialOperator.animate_singularity-2356"><span class="linenos">2356</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2357"><a href="#PseudoDifferentialOperator.animate_singularity-2357"><span class="linenos">2357</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\eta$&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2358"><a href="#PseudoDifferentialOperator.animate_singularity-2358"><span class="linenos">2358</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2359"><a href="#PseudoDifferentialOperator.animate_singularity-2359"><span class="linenos">2359</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eta_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2360"><a href="#PseudoDifferentialOperator.animate_singularity-2360"><span class="linenos">2360</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2361"><a href="#PseudoDifferentialOperator.animate_singularity-2361"><span class="linenos">2361</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2362"><a href="#PseudoDifferentialOperator.animate_singularity-2362"><span class="linenos">2362</span></a>                    <span class="n">point</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">eta_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2363"><a href="#PseudoDifferentialOperator.animate_singularity-2363"><span class="linenos">2363</span></a>                    <span class="n">traj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">eta_vals</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2364"><a href="#PseudoDifferentialOperator.animate_singularity-2364"><span class="linenos">2364</span></a>                    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">traj</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2365"><a href="#PseudoDifferentialOperator.animate_singularity-2365"><span class="linenos">2365</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2366"><a href="#PseudoDifferentialOperator.animate_singularity-2366"><span class="linenos">2366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2367"><a href="#PseudoDifferentialOperator.animate_singularity-2367"><span class="linenos">2367</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid projection mode&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2368"><a href="#PseudoDifferentialOperator.animate_singularity-2368"><span class="linenos">2368</span></a>    
</span><span id="PseudoDifferentialOperator.animate_singularity-2369"><a href="#PseudoDifferentialOperator.animate_singularity-2369"><span class="linenos">2369</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2D Singularity Flow (</span><span class="si">{</span><span class="n">projection</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2370"><a href="#PseudoDifferentialOperator.animate_singularity-2370"><span class="linenos">2370</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2371"><a href="#PseudoDifferentialOperator.animate_singularity-2371"><span class="linenos">2371</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2372"><a href="#PseudoDifferentialOperator.animate_singularity-2372"><span class="linenos">2372</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2373"><a href="#PseudoDifferentialOperator.animate_singularity-2373"><span class="linenos">2373</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.animate_singularity-2374"><a href="#PseudoDifferentialOperator.animate_singularity-2374"><span class="linenos">2374</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span></pre></div>


            <div class="docstring"><p>Animate the propagation of a singularity under the Hamiltonian flow.</p>

<p>This method visualizes how a singularity (x₀, y₀, ξ₀, η₀) evolves in phase space 
according to the Hamiltonian dynamics induced by the principal symbol of the operator.
The animation integrates the Hamiltonian equations of motion and supports various projections:
position (x-y), frequency (ξ-η), or mixed phase space coordinates.</p>

<h2 id="parameters">Parameters</h2>

<p>xi0, eta0 : float
    Initial frequency components (ξ₀, η₀).
x0, y0 : float
    Initial spatial coordinates (x₀, y₀).
tmax : float
    Total time of integration (final animation time).
n_frames : int
    Number of frames in the resulting animation.
projection : str or None
    Type of projection to display:
        - 'position' : x vs y (or x alone in 1D)
        - 'frequency': ξ vs η (or ξ alone in 1D)
        - 'phase'    : mixed coordinates like x vs ξ or x vs η
        If None, defaults to 'phase' in 1D and 'position' in 2D.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.animation.FuncAnimation
    Animation object that can be displayed interactively in Jupyter notebooks or saved as a video.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D, only one spatial and one frequency variable are used.</li>
<li>Complex-valued Hamiltonian fields are truncated to their real parts for integration.</li>
<li>Trajectories are shown with both instantaneous position (dot) and full path (dashed line).</li>
</ul>
</div>


                            </div>
                            <div id="PseudoDifferentialOperator.interactive_symbol_analysis" class="classattr">
                                        <input id="PseudoDifferentialOperator.interactive_symbol_analysis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">interactive_symbol_analysis</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">pseudo_op</span>,</span><span class="param">	<span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>,</span><span class="param">	<span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>,</span><span class="param">	<span class="n">xi_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">eta_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">density</span><span class="o">=</span><span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PseudoDifferentialOperator.interactive_symbol_analysis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PseudoDifferentialOperator.interactive_symbol_analysis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2376"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2376"><span class="linenos">2376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">interactive_symbol_analysis</span><span class="p">(</span><span class="n">pseudo_op</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2377"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2377"><span class="linenos">2377</span></a>                                    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2378"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2378"><span class="linenos">2378</span></a>                                    <span class="n">xi_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">eta_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2379"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2379"><span class="linenos">2379</span></a>                                    <span class="n">density</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2380"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2380"><span class="linenos">2380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2381"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2381"><span class="linenos">2381</span></a><span class="sd">        Launch an interactive dashboard for symbol exploration using ipywidgets.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2382"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2382"><span class="linenos">2382</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2383"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2383"><span class="linenos">2383</span></a><span class="sd">        This function provides a user-friendly interface to visualize various aspects of the pseudo-differential operator&#39;s symbol.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2384"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2384"><span class="linenos">2384</span></a><span class="sd">        It supports multiple visualization modes in both 1D and 2D, including group velocity fields, micro-support estimates,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2385"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2385"><span class="linenos">2385</span></a><span class="sd">        symplectic vector fields, symbol amplitude/phase, cotangent fiber structure, characteristic sets and Hamiltonian flows.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2386"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2386"><span class="linenos">2386</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2387"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2387"><span class="linenos">2387</span></a><span class="sd">        Parameters</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2388"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2388"><span class="linenos">2388</span></a><span class="sd">        ----------</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2389"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2389"><span class="linenos">2389</span></a><span class="sd">        pseudo_op : PseudoDifferentialOperator</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2390"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2390"><span class="linenos">2390</span></a><span class="sd">            The pseudo-differential operator whose symbol is to be analyzed interactively.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2391"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2391"><span class="linenos">2391</span></a><span class="sd">        xlim, ylim : tuple of float</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2392"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2392"><span class="linenos">2392</span></a><span class="sd">            Spatial domain limits along x and y axes respectively.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2393"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2393"><span class="linenos">2393</span></a><span class="sd">        xi_range, eta_range : tuple</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2394"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2394"><span class="linenos">2394</span></a><span class="sd">            Frequency domain limits along ξ and η axes respectively.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2395"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2395"><span class="linenos">2395</span></a><span class="sd">        density : int</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2396"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2396"><span class="linenos">2396</span></a><span class="sd">            Number of points per axis used to construct the evaluation grid. Controls resolution.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2397"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2397"><span class="linenos">2397</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2398"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2398"><span class="linenos">2398</span></a><span class="sd">        Notes</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2399"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2399"><span class="linenos">2399</span></a><span class="sd">        -----</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2400"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2400"><span class="linenos">2400</span></a><span class="sd">        - In 1D mode, sliders control the fixed frequency (ξ₀) and spatial position (x₀).</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2401"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2401"><span class="linenos">2401</span></a><span class="sd">        - In 2D mode, additional sliders control the second frequency component (η₀) and second spatial coordinate (y₀).</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2402"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2402"><span class="linenos">2402</span></a><span class="sd">        - Visualization updates dynamically as parameters are adjusted via sliders or dropdown menus.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2403"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2403"><span class="linenos">2403</span></a><span class="sd">        - Supported visualization modes:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2404"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2404"><span class="linenos">2404</span></a><span class="sd">            &#39;Symbol Amplitude&#39;           : |p(x,ξ)| or |p(x,y,ξ,η)|</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2405"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2405"><span class="linenos">2405</span></a><span class="sd">            &#39;Symbol Phase&#39;               : arg(p(x,ξ)) or similar in 2D</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2406"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2406"><span class="linenos">2406</span></a><span class="sd">            &#39;Micro-Support (1/|p|)&#39;      : Reciprocal of symbol magnitude</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2407"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2407"><span class="linenos">2407</span></a><span class="sd">            &#39;Cotangent Fiber&#39;            : Structure of symbol over frequency space at fixed x</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2408"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2408"><span class="linenos">2408</span></a><span class="sd">            &#39;Characteristic Set&#39;         : Zero set approximation {p ≈ 0}</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2409"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2409"><span class="linenos">2409</span></a><span class="sd">            &#39;Characteristic Gradient&#39;    : |∇p(x, ξ)| or |∇p(x₀, y₀, ξ, η)|</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2410"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2410"><span class="linenos">2410</span></a><span class="sd">            &#39;Group Velocity Field&#39;       : ∇_ξ p(x,ξ) or ∇_{ξ,η} p(x,y,ξ,η)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2411"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2411"><span class="linenos">2411</span></a><span class="sd">            &#39;Symplectic Vector Field&#39;    : (∇_ξ p, -∇_x p) or similar in 2D</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2412"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2412"><span class="linenos">2412</span></a><span class="sd">            &#39;Hamiltonian Flow&#39;           : Trajectories generated by the Hamiltonian vector field</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2413"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2413"><span class="linenos">2413</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2414"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2414"><span class="linenos">2414</span></a><span class="sd">        Raises</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2415"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2415"><span class="linenos">2415</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2416"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2416"><span class="linenos">2416</span></a><span class="sd">        NotImplementedError</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2417"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2417"><span class="linenos">2417</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2418"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2418"><span class="linenos">2418</span></a><span class="sd">    </span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2419"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2419"><span class="linenos">2419</span></a><span class="sd">        Prints</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2420"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2420"><span class="linenos">2420</span></a><span class="sd">        ------</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2421"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2421"><span class="linenos">2421</span></a><span class="sd">        Interactive matplotlib figures with dynamic updates based on widget inputs.</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2422"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2422"><span class="linenos">2422</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2423"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2423"><span class="linenos">2423</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="n">pseudo_op</span><span class="o">.</span><span class="n">dim</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2424"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2424"><span class="linenos">2424</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">pseudo_op</span><span class="o">.</span><span class="n">expr</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2425"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2425"><span class="linenos">2425</span></a>        <span class="n">vars_x</span> <span class="o">=</span> <span class="n">pseudo_op</span><span class="o">.</span><span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2426"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2426"><span class="linenos">2426</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2427"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2427"><span class="linenos">2427</span></a>        <span class="n">mode_selector_1D</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2428"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2428"><span class="linenos">2428</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2429"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2429"><span class="linenos">2429</span></a>                <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2430"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2430"><span class="linenos">2430</span></a>                <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2431"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2431"><span class="linenos">2431</span></a>                <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2432"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2432"><span class="linenos">2432</span></a>                <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2433"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2433"><span class="linenos">2433</span></a>                <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2434"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2434"><span class="linenos">2434</span></a>                <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2435"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2435"><span class="linenos">2435</span></a>                <span class="s1">&#39;Group Velocity Field&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2436"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2436"><span class="linenos">2436</span></a>                <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2437"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2437"><span class="linenos">2437</span></a>                <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2438"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2438"><span class="linenos">2438</span></a>            <span class="p">],</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2439"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2439"><span class="linenos">2439</span></a>            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2440"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2440"><span class="linenos">2440</span></a>            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Mode:&#39;</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2441"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2441"><span class="linenos">2441</span></a>        <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2442"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2442"><span class="linenos">2442</span></a>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2443"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2443"><span class="linenos">2443</span></a>        <span class="n">mode_selector_2D</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2444"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2444"><span class="linenos">2444</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2445"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2445"><span class="linenos">2445</span></a>                <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2446"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2446"><span class="linenos">2446</span></a>                <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2447"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2447"><span class="linenos">2447</span></a>                <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2448"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2448"><span class="linenos">2448</span></a>                <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2449"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2449"><span class="linenos">2449</span></a>                <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2450"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2450"><span class="linenos">2450</span></a>                <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2451"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2451"><span class="linenos">2451</span></a>                <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2452"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2452"><span class="linenos">2452</span></a>                <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2453"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2453"><span class="linenos">2453</span></a>            <span class="p">],</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2454"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2454"><span class="linenos">2454</span></a>            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2455"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2455"><span class="linenos">2455</span></a>            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Mode:&#39;</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2456"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2456"><span class="linenos">2456</span></a>        <span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2457"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2457"><span class="linenos">2457</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2458"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2458"><span class="linenos">2458</span></a>        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2459"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2459"><span class="linenos">2459</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2460"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2460"><span class="linenos">2460</span></a>            <span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2461"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2461"><span class="linenos">2461</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2462"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2462"><span class="linenos">2462</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2463"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2463"><span class="linenos">2463</span></a>            <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2464"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2464"><span class="linenos">2464</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2465"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2465"><span class="linenos">2465</span></a>            <span class="n">grad_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2466"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2466"><span class="linenos">2466</span></a>            <span class="n">symplectic_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="p">[</span><span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="o">-</span><span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">x</span><span class="p">)],</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2467"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2467"><span class="linenos">2467</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2468"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2468"><span class="linenos">2468</span></a>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2469"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2469"><span class="linenos">2469</span></a>            <span class="n">xi_slider</span> <span class="o">=</span> <span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;ξ₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2470"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2470"><span class="linenos">2470</span></a>            <span class="n">x_slider</span> <span class="o">=</span> <span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;x₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2471"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2471"><span class="linenos">2471</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2472"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2472"><span class="linenos">2472</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">plot_1d</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2473"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2473"><span class="linenos">2473</span></a>                <span class="n">X</span> <span class="o">=</span> <span class="n">x_vals</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2474"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2474"><span class="linenos">2474</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2475"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2475"><span class="linenos">2475</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Group Velocity Field&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2476"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2476"><span class="linenos">2476</span></a>                    <span class="n">V</span> <span class="o">=</span> <span class="n">grad_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2477"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2477"><span class="linenos">2477</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2478"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2478"><span class="linenos">2478</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2479"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2479"><span class="linenos">2479</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Group Velocity Field at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2480"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2480"><span class="linenos">2480</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2481"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2481"><span class="linenos">2481</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2482"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2482"><span class="linenos">2482</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2483"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2483"><span class="linenos">2483</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2484"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2484"><span class="linenos">2484</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2485"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2485"><span class="linenos">2485</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Micro-Support (1/|p|) at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2486"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2486"><span class="linenos">2486</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2487"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2487"><span class="linenos">2487</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2488"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2488"><span class="linenos">2488</span></a>                    <span class="n">U</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">symplectic_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2489"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2489"><span class="linenos">2489</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2490"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2490"><span class="linenos">2490</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2491"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2491"><span class="linenos">2491</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symplectic Field at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2492"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2492"><span class="linenos">2492</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2493"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2493"><span class="linenos">2493</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2494"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2494"><span class="linenos">2494</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2495"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2495"><span class="linenos">2495</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2496"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2496"><span class="linenos">2496</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2497"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2497"><span class="linenos">2497</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Amplitude |p(x,ξ)| at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2498"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2498"><span class="linenos">2498</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2499"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2499"><span class="linenos">2499</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2500"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2500"><span class="linenos">2500</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">xi0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2501"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2501"><span class="linenos">2501</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2502"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2502"><span class="linenos">2502</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2503"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2503"><span class="linenos">2503</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Phase arg(p(x,ξ)) at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2504"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2504"><span class="linenos">2504</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2505"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2505"><span class="linenos">2505</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2506"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2506"><span class="linenos">2506</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_fiber</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2507"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2507"><span class="linenos">2507</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2508"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2508"><span class="linenos">2508</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2509"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2509"><span class="linenos">2509</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_set</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2510"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2510"><span class="linenos">2510</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2511"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2511"><span class="linenos">2511</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2512"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2512"><span class="linenos">2512</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_gradient</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2513"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2513"><span class="linenos">2513</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2514"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2514"><span class="linenos">2514</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2515"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2515"><span class="linenos">2515</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">plot_hamiltonian_flow</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="n">xi0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2516"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2516"><span class="linenos">2516</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2517"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2517"><span class="linenos">2517</span></a>            <span class="c1"># --- Dynamic container for sliders ---</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2518"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2518"><span class="linenos">2518</span></a>            <span class="n">controls_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">mode_selector_1D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2519"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2519"><span class="linenos">2519</span></a>            <span class="c1"># --- Function to adjust visible sliders based on mode ---</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2520"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2520"><span class="linenos">2520</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">update_controls</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2521"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2521"><span class="linenos">2521</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2522"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2522"><span class="linenos">2522</span></a>                <span class="c1"># modes that depend only on xi and eta</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2523"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2523"><span class="linenos">2523</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2524"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2524"><span class="linenos">2524</span></a>                            <span class="s1">&#39;Group Velocity Field&#39;</span><span class="p">,</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2525"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2525"><span class="linenos">2525</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_1D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2526"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2526"><span class="linenos">2526</span></a>                <span class="c1"># modes that require xi and x</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2527"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2527"><span class="linenos">2527</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2528"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2528"><span class="linenos">2528</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_1D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2529"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2529"><span class="linenos">2529</span></a>                <span class="c1"># modes that require nothing</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2530"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2530"><span class="linenos">2530</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2531"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2531"><span class="linenos">2531</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_1D</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2532"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2532"><span class="linenos">2532</span></a>            <span class="n">mode_selector_1D</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_controls</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2533"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2533"><span class="linenos">2533</span></a>            <span class="n">update_controls</span><span class="p">({</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="n">mode_selector_1D</span><span class="o">.</span><span class="n">value</span><span class="p">})</span> 
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2534"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2534"><span class="linenos">2534</span></a>            <span class="c1"># --- Interactive binding ---</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2535"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2535"><span class="linenos">2535</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_1d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode_selector_1D</span><span class="p">,</span> <span class="s1">&#39;xi0&#39;</span><span class="p">:</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">x_slider</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2536"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2536"><span class="linenos">2536</span></a>            <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">controls_box</span><span class="p">,</span> <span class="n">out</span><span class="p">]))</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2537"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2537"><span class="linenos">2537</span></a>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2538"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2538"><span class="linenos">2538</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2539"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2539"><span class="linenos">2539</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vars_x</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2540"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2540"><span class="linenos">2540</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2541"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2541"><span class="linenos">2541</span></a>            <span class="n">symplectic_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="p">[</span><span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">diff</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">eta</span><span class="p">)],</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2542"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2542"><span class="linenos">2542</span></a>            <span class="n">symbol_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2543"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2543"><span class="linenos">2543</span></a>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2544"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2544"><span class="linenos">2544</span></a>            <span class="n">xi_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;ξ₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2545"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2545"><span class="linenos">2545</span></a>            <span class="n">eta_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;η₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2546"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2546"><span class="linenos">2546</span></a>            <span class="n">x_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;x₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2547"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2547"><span class="linenos">2547</span></a>            <span class="n">y_slider</span><span class="o">=</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;y₀&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2548"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2548"><span class="linenos">2548</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2549"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2549"><span class="linenos">2549</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">plot_2d</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2550"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2550"><span class="linenos">2550</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2551"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2551"><span class="linenos">2551</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2552"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2552"><span class="linenos">2552</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2553"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2553"><span class="linenos">2553</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2554"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2554"><span class="linenos">2554</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2555"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2555"><span class="linenos">2555</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;1/|p|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2556"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2556"><span class="linenos">2556</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2557"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2557"><span class="linenos">2557</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2558"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2558"><span class="linenos">2558</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Micro-Support at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2559"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2559"><span class="linenos">2559</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2560"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2560"><span class="linenos">2560</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2561"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2561"><span class="linenos">2561</span></a>                    <span class="n">U</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">symplectic_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2562"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2562"><span class="linenos">2562</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2563"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2563"><span class="linenos">2563</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2564"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2564"><span class="linenos">2564</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2565"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2565"><span class="linenos">2565</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symplectic Field at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2566"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2566"><span class="linenos">2566</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2567"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2567"><span class="linenos">2567</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2568"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2568"><span class="linenos">2568</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2569"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2569"><span class="linenos">2569</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2570"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2570"><span class="linenos">2570</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|p(x,y,ξ,η)|&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2571"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2571"><span class="linenos">2571</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2572"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2572"><span class="linenos">2572</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2573"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2573"><span class="linenos">2573</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Amplitude at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2574"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2574"><span class="linenos">2574</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2575"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2575"><span class="linenos">2575</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2576"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2576"><span class="linenos">2576</span></a>                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">symbol_func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">))</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2577"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2577"><span class="linenos">2577</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;twilight&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2578"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2578"><span class="linenos">2578</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;arg(p)&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2579"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2579"><span class="linenos">2579</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2580"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2580"><span class="linenos">2580</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2581"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2581"><span class="linenos">2581</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symbol Phase at ξ=</span><span class="si">{</span><span class="n">xi0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, η=</span><span class="si">{</span><span class="n">eta0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2582"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2582"><span class="linenos">2582</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2583"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2583"><span class="linenos">2583</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2584"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2584"><span class="linenos">2584</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_fiber</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">eta_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2585"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2585"><span class="linenos">2585</span></a>                                              <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2586"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2586"><span class="linenos">2586</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2587"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2587"><span class="linenos">2587</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2588"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2588"><span class="linenos">2588</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_set</span><span class="p">(</span><span class="n">x_grid</span><span class="o">=</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2589"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2589"><span class="linenos">2589</span></a>                                                  <span class="n">y_grid</span><span class="o">=</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">eta_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2590"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2590"><span class="linenos">2590</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2591"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2591"><span class="linenos">2591</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2592"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2592"><span class="linenos">2592</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">visualize_characteristic_gradient</span><span class="p">(</span><span class="n">x_grid</span><span class="o">=</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">xi_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">xi_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2593"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2593"><span class="linenos">2593</span></a>                                                  <span class="n">y_grid</span><span class="o">=</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">eta_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">eta_range</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2594"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2594"><span class="linenos">2594</span></a>    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2595"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2595"><span class="linenos">2595</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2596"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2596"><span class="linenos">2596</span></a>                    <span class="n">pseudo_op</span><span class="o">.</span><span class="n">plot_hamiltonian_flow</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="o">=</span><span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="n">eta0</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2597"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2597"><span class="linenos">2597</span></a>                    
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2598"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2598"><span class="linenos">2598</span></a>            <span class="c1"># --- Dynamic container for sliders ---</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2599"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2599"><span class="linenos">2599</span></a>            <span class="n">controls_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">eta_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">,</span> <span class="n">y_slider</span><span class="p">])</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2600"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2600"><span class="linenos">2600</span></a>            <span class="c1"># --- Function to adjust visible sliders based on mode ---</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2601"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2601"><span class="linenos">2601</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">update_controls</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2602"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2602"><span class="linenos">2602</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2603"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2603"><span class="linenos">2603</span></a>                <span class="c1"># modes that depend only on xi</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2604"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2604"><span class="linenos">2604</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Symbol Amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Symbol Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;Micro-Support (1/|p|)&#39;</span><span class="p">,</span> <span class="s1">&#39;Symplectic Vector Field&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2605"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2605"><span class="linenos">2605</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">eta_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2606"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2606"><span class="linenos">2606</span></a>                <span class="c1"># modes that require xi, eta, x and y</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2607"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2607"><span class="linenos">2607</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Hamiltonian Flow&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2608"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2608"><span class="linenos">2608</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="n">eta_slider</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">,</span> <span class="n">y_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2609"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2609"><span class="linenos">2609</span></a>                <span class="c1"># modes that require x and y</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2610"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2610"><span class="linenos">2610</span></a>                <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cotangent Fiber&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Set&#39;</span><span class="p">,</span> <span class="s1">&#39;Characteristic Gradient&#39;</span><span class="p">]:</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2611"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2611"><span class="linenos">2611</span></a>                    <span class="n">controls_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_selector_2D</span><span class="p">,</span> <span class="n">x_slider</span><span class="p">,</span> <span class="n">y_slider</span><span class="p">]</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2612"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2612"><span class="linenos">2612</span></a>            <span class="n">mode_selector_2D</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_controls</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2613"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2613"><span class="linenos">2613</span></a>            <span class="n">update_controls</span><span class="p">({</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="n">mode_selector_2D</span><span class="o">.</span><span class="n">value</span><span class="p">})</span> 
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2614"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2614"><span class="linenos">2614</span></a>            <span class="c1"># --- Interactive binding ---</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2615"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2615"><span class="linenos">2615</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_2d</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode_selector_2D</span><span class="p">,</span> <span class="s1">&#39;xi0&#39;</span><span class="p">:</span> <span class="n">xi_slider</span><span class="p">,</span> <span class="s1">&#39;eta0&#39;</span><span class="p">:</span> <span class="n">eta_slider</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">x_slider</span><span class="p">,</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">y_slider</span><span class="p">})</span>
</span><span id="PseudoDifferentialOperator.interactive_symbol_analysis-2616"><a href="#PseudoDifferentialOperator.interactive_symbol_analysis-2616"><span class="linenos">2616</span></a>            <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">controls_box</span><span class="p">,</span> <span class="n">out</span><span class="p">]))</span>
</span></pre></div>


            <div class="docstring"><p>Launch an interactive dashboard for symbol exploration using ipywidgets.</p>

<p>This function provides a user-friendly interface to visualize various aspects of the pseudo-differential operator's symbol.
It supports multiple visualization modes in both 1D and 2D, including group velocity fields, micro-support estimates,
symplectic vector fields, symbol amplitude/phase, cotangent fiber structure, characteristic sets and Hamiltonian flows.</p>

<h2 id="parameters">Parameters</h2>

<p>pseudo_op : PseudoDifferentialOperator
    The pseudo-differential operator whose symbol is to be analyzed interactively.
xlim, ylim : tuple of float
    Spatial domain limits along x and y axes respectively.
xi_range, eta_range : tuple
    Frequency domain limits along ξ and η axes respectively.
density : int
    Number of points per axis used to construct the evaluation grid. Controls resolution.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D mode, sliders control the fixed frequency (ξ₀) and spatial position (x₀).</li>
<li>In 2D mode, additional sliders control the second frequency component (η₀) and second spatial coordinate (y₀).</li>
<li>Visualization updates dynamically as parameters are adjusted via sliders or dropdown menus.</li>
<li>Supported visualization modes:
'Symbol Amplitude'           : |p(x,ξ)| or |p(x,y,ξ,η)|
'Symbol Phase'               : arg(p(x,ξ)) or similar in 2D
'Micro-Support (1/|p|)'      : Reciprocal of symbol magnitude
'Cotangent Fiber'            : Structure of symbol over frequency space at fixed x
'Characteristic Set'         : Zero set approximation {p ≈ 0}
'Characteristic Gradient'    : |∇p(x, ξ)| or |∇p(x₀, y₀, ξ, η)|
'Group Velocity Field'       : ∇_ξ p(x,ξ) or ∇_{ξ,η} p(x,y,ξ,η)
'Symplectic Vector Field'    : (∇_ξ p, -∇_x p) or similar in 2D
'Hamiltonian Flow'           : Trajectories generated by the Hamiltonian vector field</li>
</ul>

<h2 id="raises">Raises</h2>

<p>NotImplementedError
    If the spatial dimension is not 1D or 2D.</p>

<h2 id="prints">Prints</h2>

<p>Interactive matplotlib figures with dynamic updates based on widget inputs.</p>
</div>


                            </div>
                </section>
                <section id="PDESolver">
                            <input id="PDESolver-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PDESolver</span>:

                <label class="view-source-button" for="PDESolver-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver-28"><a href="#PDESolver-28"><span class="linenos">  28</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PDESolver</span><span class="p">:</span>
</span><span id="PDESolver-29"><a href="#PDESolver-29"><span class="linenos">  29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-30"><a href="#PDESolver-30"><span class="linenos">  30</span></a><span class="sd">    A partial differential equation (PDE) solver based on **spectral methods** using Fourier transforms.</span>
</span><span id="PDESolver-31"><a href="#PDESolver-31"><span class="linenos">  31</span></a>
</span><span id="PDESolver-32"><a href="#PDESolver-32"><span class="linenos">  32</span></a><span class="sd">    This solver supports symbolic specification of PDEs via SymPy and numerical solution using high-order spectral techniques. </span>
</span><span id="PDESolver-33"><a href="#PDESolver-33"><span class="linenos">  33</span></a><span class="sd">    It is designed for both **linear and nonlinear time-dependent PDEs**, as well as **stationary pseudo-differential problems**.</span>
</span><span id="PDESolver-34"><a href="#PDESolver-34"><span class="linenos">  34</span></a><span class="sd">    </span>
</span><span id="PDESolver-35"><a href="#PDESolver-35"><span class="linenos">  35</span></a><span class="sd">    Key Features:</span>
</span><span id="PDESolver-36"><a href="#PDESolver-36"><span class="linenos">  36</span></a><span class="sd">    -------------</span>
</span><span id="PDESolver-37"><a href="#PDESolver-37"><span class="linenos">  37</span></a><span class="sd">    - Symbolic PDE parsing using SymPy expressions</span>
</span><span id="PDESolver-38"><a href="#PDESolver-38"><span class="linenos">  38</span></a><span class="sd">    - 1D and 2D spatial domains with periodic boundary conditions</span>
</span><span id="PDESolver-39"><a href="#PDESolver-39"><span class="linenos">  39</span></a><span class="sd">    - Fourier-based spectral discretization with dealiasing</span>
</span><span id="PDESolver-40"><a href="#PDESolver-40"><span class="linenos">  40</span></a><span class="sd">    - Temporal integration schemes:</span>
</span><span id="PDESolver-41"><a href="#PDESolver-41"><span class="linenos">  41</span></a><span class="sd">        - Default exponential time stepping</span>
</span><span id="PDESolver-42"><a href="#PDESolver-42"><span class="linenos">  42</span></a><span class="sd">        - ETD-RK4 (Exponential Time Differencing Runge-Kutta of 4th order)</span>
</span><span id="PDESolver-43"><a href="#PDESolver-43"><span class="linenos">  43</span></a><span class="sd">    - Nonlinear terms handled through pseudo-spectral evaluation</span>
</span><span id="PDESolver-44"><a href="#PDESolver-44"><span class="linenos">  44</span></a><span class="sd">    - Built-in tools for:</span>
</span><span id="PDESolver-45"><a href="#PDESolver-45"><span class="linenos">  45</span></a><span class="sd">        - Visualization of solutions and error surfaces</span>
</span><span id="PDESolver-46"><a href="#PDESolver-46"><span class="linenos">  46</span></a><span class="sd">        - Symbol analysis of linear and pseudo-differential operators</span>
</span><span id="PDESolver-47"><a href="#PDESolver-47"><span class="linenos">  47</span></a><span class="sd">        - Microlocal analysis (e.g., Hamiltonian flows)</span>
</span><span id="PDESolver-48"><a href="#PDESolver-48"><span class="linenos">  48</span></a><span class="sd">        - CFL condition checking and numerical stability diagnostics</span>
</span><span id="PDESolver-49"><a href="#PDESolver-49"><span class="linenos">  49</span></a>
</span><span id="PDESolver-50"><a href="#PDESolver-50"><span class="linenos">  50</span></a><span class="sd">    Supported Operators:</span>
</span><span id="PDESolver-51"><a href="#PDESolver-51"><span class="linenos">  51</span></a><span class="sd">    --------------------</span>
</span><span id="PDESolver-52"><a href="#PDESolver-52"><span class="linenos">  52</span></a><span class="sd">    - Linear differential and pseudo-differential operators</span>
</span><span id="PDESolver-53"><a href="#PDESolver-53"><span class="linenos">  53</span></a><span class="sd">    - Nonlinear terms up to second order in derivatives</span>
</span><span id="PDESolver-54"><a href="#PDESolver-54"><span class="linenos">  54</span></a><span class="sd">    - Symbolic operator composition and adjoints</span>
</span><span id="PDESolver-55"><a href="#PDESolver-55"><span class="linenos">  55</span></a><span class="sd">    - Asymptotic inversion of elliptic operators for stationary problems</span>
</span><span id="PDESolver-56"><a href="#PDESolver-56"><span class="linenos">  56</span></a>
</span><span id="PDESolver-57"><a href="#PDESolver-57"><span class="linenos">  57</span></a><span class="sd">    Example Usage:</span>
</span><span id="PDESolver-58"><a href="#PDESolver-58"><span class="linenos">  58</span></a><span class="sd">    --------------</span>
</span><span id="PDESolver-59"><a href="#PDESolver-59"><span class="linenos">  59</span></a><span class="sd">    &gt;&gt;&gt; from PDESolver import *</span>
</span><span id="PDESolver-60"><a href="#PDESolver-60"><span class="linenos">  60</span></a><span class="sd">    &gt;&gt;&gt; u = Function(&#39;u&#39;)</span>
</span><span id="PDESolver-61"><a href="#PDESolver-61"><span class="linenos">  61</span></a><span class="sd">    &gt;&gt;&gt; t, x = symbols(&#39;t x&#39;)</span>
</span><span id="PDESolver-62"><a href="#PDESolver-62"><span class="linenos">  62</span></a><span class="sd">    &gt;&gt;&gt; eq = Eq(diff(u(t, x), t), diff(u(t, x), x, 2) + u(t, x)**2)</span>
</span><span id="PDESolver-63"><a href="#PDESolver-63"><span class="linenos">  63</span></a><span class="sd">    &gt;&gt;&gt; def _initial(x): return np.sin(x)</span>
</span><span id="PDESolver-64"><a href="#PDESolver-64"><span class="linenos">  64</span></a><span class="sd">    &gt;&gt;&gt; solver = PDESolver(eq)</span>
</span><span id="PDESolver-65"><a href="#PDESolver-65"><span class="linenos">  65</span></a><span class="sd">    &gt;&gt;&gt; solver.setup(Lx=2*np.pi, Nx=128, Lt=1.0, Nt=1000, initial_condition=initial)</span>
</span><span id="PDESolver-66"><a href="#PDESolver-66"><span class="linenos">  66</span></a><span class="sd">    &gt;&gt;&gt; solver.solve()</span>
</span><span id="PDESolver-67"><a href="#PDESolver-67"><span class="linenos">  67</span></a><span class="sd">    &gt;&gt;&gt; ani = solver.animate()</span>
</span><span id="PDESolver-68"><a href="#PDESolver-68"><span class="linenos">  68</span></a><span class="sd">    &gt;&gt;&gt; HTML(ani.to_jshtml())  # Display animation in Jupyter notebook</span>
</span><span id="PDESolver-69"><a href="#PDESolver-69"><span class="linenos">  69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PDESolver-70"><a href="#PDESolver-70"><span class="linenos">  70</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">time_scheme</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">dealiasing_ratio</span><span class="o">=</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
</span><span id="PDESolver-71"><a href="#PDESolver-71"><span class="linenos">  71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-72"><a href="#PDESolver-72"><span class="linenos">  72</span></a><span class="sd">        Initialize the PDE solver with a given equation.</span>
</span><span id="PDESolver-73"><a href="#PDESolver-73"><span class="linenos">  73</span></a>
</span><span id="PDESolver-74"><a href="#PDESolver-74"><span class="linenos">  74</span></a><span class="sd">        This method analyzes the input partial differential equation (PDE), </span>
</span><span id="PDESolver-75"><a href="#PDESolver-75"><span class="linenos">  75</span></a><span class="sd">        identifies the unknown function and its dependencies, determines whether </span>
</span><span id="PDESolver-76"><a href="#PDESolver-76"><span class="linenos">  76</span></a><span class="sd">        the problem is stationary or time-dependent, and prepares symbolic and </span>
</span><span id="PDESolver-77"><a href="#PDESolver-77"><span class="linenos">  77</span></a><span class="sd">        numerical structures for solving in spectral space.</span>
</span><span id="PDESolver-78"><a href="#PDESolver-78"><span class="linenos">  78</span></a>
</span><span id="PDESolver-79"><a href="#PDESolver-79"><span class="linenos">  79</span></a><span class="sd">        Supported features:</span>
</span><span id="PDESolver-80"><a href="#PDESolver-80"><span class="linenos">  80</span></a><span class="sd">        </span>
</span><span id="PDESolver-81"><a href="#PDESolver-81"><span class="linenos">  81</span></a><span class="sd">        - 1D and 2D problems</span>
</span><span id="PDESolver-82"><a href="#PDESolver-82"><span class="linenos">  82</span></a><span class="sd">        - Time-dependent and stationary equations</span>
</span><span id="PDESolver-83"><a href="#PDESolver-83"><span class="linenos">  83</span></a><span class="sd">        - Linear and nonlinear terms</span>
</span><span id="PDESolver-84"><a href="#PDESolver-84"><span class="linenos">  84</span></a><span class="sd">        - Pseudo-differential operators via `psiOp`</span>
</span><span id="PDESolver-85"><a href="#PDESolver-85"><span class="linenos">  85</span></a><span class="sd">        - Source terms and boundary conditions</span>
</span><span id="PDESolver-86"><a href="#PDESolver-86"><span class="linenos">  86</span></a>
</span><span id="PDESolver-87"><a href="#PDESolver-87"><span class="linenos">  87</span></a><span class="sd">        The equation is parsed to extract linear, nonlinear, source, and </span>
</span><span id="PDESolver-88"><a href="#PDESolver-88"><span class="linenos">  88</span></a><span class="sd">        pseudo-differential components. Symbolic manipulation is used to derive </span>
</span><span id="PDESolver-89"><a href="#PDESolver-89"><span class="linenos">  89</span></a><span class="sd">        the Fourier representation of linear operators when applicable.</span>
</span><span id="PDESolver-90"><a href="#PDESolver-90"><span class="linenos">  90</span></a>
</span><span id="PDESolver-91"><a href="#PDESolver-91"><span class="linenos">  91</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-92"><a href="#PDESolver-92"><span class="linenos">  92</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-93"><a href="#PDESolver-93"><span class="linenos">  93</span></a><span class="sd">        equation : sympy.Eq </span>
</span><span id="PDESolver-94"><a href="#PDESolver-94"><span class="linenos">  94</span></a><span class="sd">            The PDE expressed as a SymPy equation.</span>
</span><span id="PDESolver-95"><a href="#PDESolver-95"><span class="linenos">  95</span></a><span class="sd">        time_scheme : str</span>
</span><span id="PDESolver-96"><a href="#PDESolver-96"><span class="linenos">  96</span></a><span class="sd">            Temporal integration scheme: </span>
</span><span id="PDESolver-97"><a href="#PDESolver-97"><span class="linenos">  97</span></a><span class="sd">                - &#39;default&#39; for exponential </span>
</span><span id="PDESolver-98"><a href="#PDESolver-98"><span class="linenos">  98</span></a><span class="sd">                - time-stepping or &#39;ETD-RK4&#39; for fourth-order exponential </span>
</span><span id="PDESolver-99"><a href="#PDESolver-99"><span class="linenos">  99</span></a><span class="sd">                - time differencing Runge–Kutta.</span>
</span><span id="PDESolver-100"><a href="#PDESolver-100"><span class="linenos"> 100</span></a><span class="sd">        dealiasing_ratio : float</span>
</span><span id="PDESolver-101"><a href="#PDESolver-101"><span class="linenos"> 101</span></a><span class="sd">            Fraction of high-frequency modes to zero out </span>
</span><span id="PDESolver-102"><a href="#PDESolver-102"><span class="linenos"> 102</span></a><span class="sd">            during dealiasing (e.g., 2/3 for standard truncation).</span>
</span><span id="PDESolver-103"><a href="#PDESolver-103"><span class="linenos"> 103</span></a>
</span><span id="PDESolver-104"><a href="#PDESolver-104"><span class="linenos"> 104</span></a><span class="sd">        Attributes initialized:</span>
</span><span id="PDESolver-105"><a href="#PDESolver-105"><span class="linenos"> 105</span></a><span class="sd">        </span>
</span><span id="PDESolver-106"><a href="#PDESolver-106"><span class="linenos"> 106</span></a><span class="sd">        - self.u: the unknown function (e.g., u(t, x))</span>
</span><span id="PDESolver-107"><a href="#PDESolver-107"><span class="linenos"> 107</span></a><span class="sd">        - self.dim: spatial dimension (1 or 2)</span>
</span><span id="PDESolver-108"><a href="#PDESolver-108"><span class="linenos"> 108</span></a><span class="sd">        - self.spatial_vars: list of spatial variables (e.g., [x] or [x, y])</span>
</span><span id="PDESolver-109"><a href="#PDESolver-109"><span class="linenos"> 109</span></a><span class="sd">        - self.is_stationary: boolean indicating if the problem is stationary</span>
</span><span id="PDESolver-110"><a href="#PDESolver-110"><span class="linenos"> 110</span></a><span class="sd">        - self.linear_terms: dictionary mapping derivative orders to coefficients</span>
</span><span id="PDESolver-111"><a href="#PDESolver-111"><span class="linenos"> 111</span></a><span class="sd">        - self.nonlinear_terms: list of nonlinear expressions</span>
</span><span id="PDESolver-112"><a href="#PDESolver-112"><span class="linenos"> 112</span></a><span class="sd">        - self.source_terms: list of source functions</span>
</span><span id="PDESolver-113"><a href="#PDESolver-113"><span class="linenos"> 113</span></a><span class="sd">        - self.pseudo_terms: list of pseudo-differential operator expressions</span>
</span><span id="PDESolver-114"><a href="#PDESolver-114"><span class="linenos"> 114</span></a><span class="sd">        - self.has_psi: boolean indicating presence of pseudo-differential operators</span>
</span><span id="PDESolver-115"><a href="#PDESolver-115"><span class="linenos"> 115</span></a><span class="sd">        - self.fft / self.ifft: appropriate FFT routines based on spatial dimension</span>
</span><span id="PDESolver-116"><a href="#PDESolver-116"><span class="linenos"> 116</span></a><span class="sd">        - self.kx, self.ky: symbolic wavenumber variables for Fourier space</span>
</span><span id="PDESolver-117"><a href="#PDESolver-117"><span class="linenos"> 117</span></a>
</span><span id="PDESolver-118"><a href="#PDESolver-118"><span class="linenos"> 118</span></a><span class="sd">        Raises:</span>
</span><span id="PDESolver-119"><a href="#PDESolver-119"><span class="linenos"> 119</span></a><span class="sd">            ValueError: If the equation does not contain exactly one unknown function,</span>
</span><span id="PDESolver-120"><a href="#PDESolver-120"><span class="linenos"> 120</span></a><span class="sd">                        if unsupported dimensions are detected, or invalid dependencies.</span>
</span><span id="PDESolver-121"><a href="#PDESolver-121"><span class="linenos"> 121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-122"><a href="#PDESolver-122"><span class="linenos"> 122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_scheme</span> <span class="o">=</span> <span class="n">time_scheme</span> <span class="c1"># &#39;default&#39;  or &#39;ETD-RK4&#39;</span>
</span><span id="PDESolver-123"><a href="#PDESolver-123"><span class="linenos"> 123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_ratio</span> <span class="o">=</span> <span class="n">dealiasing_ratio</span>
</span><span id="PDESolver-124"><a href="#PDESolver-124"><span class="linenos"> 124</span></a>        
</span><span id="PDESolver-125"><a href="#PDESolver-125"><span class="linenos"> 125</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*********************************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-126"><a href="#PDESolver-126"><span class="linenos"> 126</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Partial differential equation *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-127"><a href="#PDESolver-127"><span class="linenos"> 127</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-128"><a href="#PDESolver-128"><span class="linenos"> 128</span></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver-129"><a href="#PDESolver-129"><span class="linenos"> 129</span></a>        
</span><span id="PDESolver-130"><a href="#PDESolver-130"><span class="linenos"> 130</span></a>        <span class="c1"># Extract symbols and function from the equation</span>
</span><span id="PDESolver-131"><a href="#PDESolver-131"><span class="linenos"> 131</span></a>        <span class="n">functions</span> <span class="o">=</span> <span class="n">equation</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Function</span><span class="p">)</span>
</span><span id="PDESolver-132"><a href="#PDESolver-132"><span class="linenos"> 132</span></a>        
</span><span id="PDESolver-133"><a href="#PDESolver-133"><span class="linenos"> 133</span></a>        <span class="c1"># Ignore the wrappers psiOp and Op</span>
</span><span id="PDESolver-134"><a href="#PDESolver-134"><span class="linenos"> 134</span></a>        <span class="n">excluded_wrappers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psiOp&#39;</span><span class="p">,</span> <span class="s1">&#39;Op&#39;</span><span class="p">}</span>
</span><span id="PDESolver-135"><a href="#PDESolver-135"><span class="linenos"> 135</span></a>        
</span><span id="PDESolver-136"><a href="#PDESolver-136"><span class="linenos"> 136</span></a>        <span class="c1"># Extract the candidate fonctions (excluding wrappers)</span>
</span><span id="PDESolver-137"><a href="#PDESolver-137"><span class="linenos"> 137</span></a>        <span class="n">candidate_functions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PDESolver-138"><a href="#PDESolver-138"><span class="linenos"> 138</span></a>            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span> 
</span><span id="PDESolver-139"><a href="#PDESolver-139"><span class="linenos"> 139</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_wrappers</span>
</span><span id="PDESolver-140"><a href="#PDESolver-140"><span class="linenos"> 140</span></a>        <span class="p">]</span>
</span><span id="PDESolver-141"><a href="#PDESolver-141"><span class="linenos"> 141</span></a>        
</span><span id="PDESolver-142"><a href="#PDESolver-142"><span class="linenos"> 142</span></a>        <span class="c1"># Keep only user functions (u(x), u(x, t), etc.)</span>
</span><span id="PDESolver-143"><a href="#PDESolver-143"><span class="linenos"> 143</span></a>        <span class="n">candidate_functions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PDESolver-144"><a href="#PDESolver-144"><span class="linenos"> 144</span></a>            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span>
</span><span id="PDESolver-145"><a href="#PDESolver-145"><span class="linenos"> 145</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">AppliedUndef</span><span class="p">)</span>
</span><span id="PDESolver-146"><a href="#PDESolver-146"><span class="linenos"> 146</span></a>        <span class="p">]</span>
</span><span id="PDESolver-147"><a href="#PDESolver-147"><span class="linenos"> 147</span></a>        
</span><span id="PDESolver-148"><a href="#PDESolver-148"><span class="linenos"> 148</span></a>        <span class="c1"># Stationary detection: no dependence on t</span>
</span><span id="PDESolver-149"><a href="#PDESolver-149"><span class="linenos"> 149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="PDESolver-150"><a href="#PDESolver-150"><span class="linenos"> 150</span></a>            <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span><span id="PDESolver-151"><a href="#PDESolver-151"><span class="linenos"> 151</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">candidate_functions</span>
</span><span id="PDESolver-152"><a href="#PDESolver-152"><span class="linenos"> 152</span></a>        <span class="p">)</span>
</span><span id="PDESolver-153"><a href="#PDESolver-153"><span class="linenos"> 153</span></a>        
</span><span id="PDESolver-154"><a href="#PDESolver-154"><span class="linenos"> 154</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_functions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-155"><a href="#PDESolver-155"><span class="linenos"> 155</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;candidate_functions :&quot;</span><span class="p">,</span> <span class="n">candidate_functions</span><span class="p">)</span>
</span><span id="PDESolver-156"><a href="#PDESolver-156"><span class="linenos"> 156</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The equation must contain exactly one unknown function&quot;</span><span class="p">)</span>
</span><span id="PDESolver-157"><a href="#PDESolver-157"><span class="linenos"> 157</span></a>        
</span><span id="PDESolver-158"><a href="#PDESolver-158"><span class="linenos"> 158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">candidate_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-159"><a href="#PDESolver-159"><span class="linenos"> 159</span></a>
</span><span id="PDESolver-160"><a href="#PDESolver-160"><span class="linenos"> 160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
</span><span id="PDESolver-161"><a href="#PDESolver-161"><span class="linenos"> 161</span></a>
</span><span id="PDESolver-162"><a href="#PDESolver-162"><span class="linenos"> 162</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">args</span>
</span><span id="PDESolver-163"><a href="#PDESolver-163"><span class="linenos"> 163</span></a>        
</span><span id="PDESolver-164"><a href="#PDESolver-164"><span class="linenos"> 164</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver-165"><a href="#PDESolver-165"><span class="linenos"> 165</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="PDESolver-166"><a href="#PDESolver-166"><span class="linenos"> 166</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stationary problems must depend on 1 or 2 spatial variables&quot;</span><span class="p">)</span>
</span><span id="PDESolver-167"><a href="#PDESolver-167"><span class="linenos"> 167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span> <span class="o">=</span> <span class="n">args</span>
</span><span id="PDESolver-168"><a href="#PDESolver-168"><span class="linenos"> 168</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-169"><a href="#PDESolver-169"><span class="linenos"> 169</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="PDESolver-170"><a href="#PDESolver-170"><span class="linenos"> 170</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The function must depend on t and at least one spatial variable (x [, y])&quot;</span><span class="p">)</span>
</span><span id="PDESolver-171"><a href="#PDESolver-171"><span class="linenos"> 171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-172"><a href="#PDESolver-172"><span class="linenos"> 172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="PDESolver-173"><a href="#PDESolver-173"><span class="linenos"> 173</span></a>
</span><span id="PDESolver-174"><a href="#PDESolver-174"><span class="linenos"> 174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">)</span>
</span><span id="PDESolver-175"><a href="#PDESolver-175"><span class="linenos"> 175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-176"><a href="#PDESolver-176"><span class="linenos"> 176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-177"><a href="#PDESolver-177"><span class="linenos"> 177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver-178"><a href="#PDESolver-178"><span class="linenos"> 178</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-179"><a href="#PDESolver-179"><span class="linenos"> 179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span>
</span><span id="PDESolver-180"><a href="#PDESolver-180"><span class="linenos"> 180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-181"><a href="#PDESolver-181"><span class="linenos"> 181</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D problems are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-182"><a href="#PDESolver-182"><span class="linenos"> 182</span></a>
</span><span id="PDESolver-183"><a href="#PDESolver-183"><span class="linenos"> 183</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-184"><a href="#PDESolver-184"><span class="linenos"> 184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver-185"><a href="#PDESolver-185"><span class="linenos"> 185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver-186"><a href="#PDESolver-186"><span class="linenos"> 186</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-187"><a href="#PDESolver-187"><span class="linenos"> 187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver-188"><a href="#PDESolver-188"><span class="linenos"> 188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver-189"><a href="#PDESolver-189"><span class="linenos"> 189</span></a>            
</span><span id="PDESolver-190"><a href="#PDESolver-190"><span class="linenos"> 190</span></a>        <span class="c1"># Parse the equation</span>
</span><span id="PDESolver-191"><a href="#PDESolver-191"><span class="linenos"> 191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PDESolver-192"><a href="#PDESolver-192"><span class="linenos"> 192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-193"><a href="#PDESolver-193"><span class="linenos"> 193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-194"><a href="#PDESolver-194"><span class="linenos"> 194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-195"><a href="#PDESolver-195"><span class="linenos"> 195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-196"><a href="#PDESolver-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Order of the temporal derivative</span>
</span><span id="PDESolver-197"><a href="#PDESolver-197"><span class="linenos"> 197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equation</span><span class="p">(</span><span class="n">equation</span><span class="p">)</span>
</span><span id="PDESolver-198"><a href="#PDESolver-198"><span class="linenos"> 198</span></a>        <span class="c1"># flag : pseudo‑differential operator present ?</span>
</span><span id="PDESolver-199"><a href="#PDESolver-199"><span class="linenos"> 199</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">)</span>
</span><span id="PDESolver-200"><a href="#PDESolver-200"><span class="linenos"> 200</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-201"><a href="#PDESolver-201"><span class="linenos"> 201</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚠️  Pseudo‑differential operator detected: all other linear terms have been rejected.&#39;</span><span class="p">)</span>
</span><span id="PDESolver-202"><a href="#PDESolver-202"><span class="linenos"> 202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PDESolver-203"><a href="#PDESolver-203"><span class="linenos"> 203</span></a>            <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver-204"><a href="#PDESolver-204"><span class="linenos"> 204</span></a>                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
</span><span id="PDESolver-205"><a href="#PDESolver-205"><span class="linenos"> 205</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PDESolver-206"><a href="#PDESolver-206"><span class="linenos"> 206</span></a>                    <span class="k">break</span>
</span><span id="PDESolver-207"><a href="#PDESolver-207"><span class="linenos"> 207</span></a>    
</span><span id="PDESolver-208"><a href="#PDESolver-208"><span class="linenos"> 208</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-209"><a href="#PDESolver-209"><span class="linenos"> 209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">kx</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;kx&#39;</span><span class="p">)</span>
</span><span id="PDESolver-210"><a href="#PDESolver-210"><span class="linenos"> 210</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-211"><a href="#PDESolver-211"><span class="linenos"> 211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;kx ky&#39;</span><span class="p">)</span>
</span><span id="PDESolver-212"><a href="#PDESolver-212"><span class="linenos"> 212</span></a>    
</span><span id="PDESolver-213"><a href="#PDESolver-213"><span class="linenos"> 213</span></a>        <span class="c1"># Compute linear operator</span>
</span><span id="PDESolver-214"><a href="#PDESolver-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver-215"><a href="#PDESolver-215"><span class="linenos"> 215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_linear_operator</span><span class="p">()</span>
</span><span id="PDESolver-216"><a href="#PDESolver-216"><span class="linenos"> 216</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-217"><a href="#PDESolver-217"><span class="linenos"> 217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-218"><a href="#PDESolver-218"><span class="linenos"> 218</span></a>            <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">sym_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver-219"><a href="#PDESolver-219"><span class="linenos"> 219</span></a>                <span class="n">psi</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">sym_expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
</span><span id="PDESolver-220"><a href="#PDESolver-220"><span class="linenos"> 220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span>
</span><span id="PDESolver-221"><a href="#PDESolver-221"><span class="linenos"> 221</span></a>
</span><span id="PDESolver-222"><a href="#PDESolver-222"><span class="linenos"> 222</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">):</span>
</span><span id="PDESolver-223"><a href="#PDESolver-223"><span class="linenos"> 223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-224"><a href="#PDESolver-224"><span class="linenos"> 224</span></a><span class="sd">        Parse the PDE to separate linear and nonlinear terms, symbolic operators (Op), </span>
</span><span id="PDESolver-225"><a href="#PDESolver-225"><span class="linenos"> 225</span></a><span class="sd">        source terms, and pseudo-differential operators (psiOp).</span>
</span><span id="PDESolver-226"><a href="#PDESolver-226"><span class="linenos"> 226</span></a><span class="sd">    </span>
</span><span id="PDESolver-227"><a href="#PDESolver-227"><span class="linenos"> 227</span></a><span class="sd">        This method rewrites the input equation in standard form (lhs - rhs = 0),</span>
</span><span id="PDESolver-228"><a href="#PDESolver-228"><span class="linenos"> 228</span></a><span class="sd">        expands it, and classifies each term into one of the following categories:</span>
</span><span id="PDESolver-229"><a href="#PDESolver-229"><span class="linenos"> 229</span></a><span class="sd">        </span>
</span><span id="PDESolver-230"><a href="#PDESolver-230"><span class="linenos"> 230</span></a><span class="sd">        - Linear terms involving derivatives or the unknown function u</span>
</span><span id="PDESolver-231"><a href="#PDESolver-231"><span class="linenos"> 231</span></a><span class="sd">        - Nonlinear terms (products with u, powers of u, etc.)</span>
</span><span id="PDESolver-232"><a href="#PDESolver-232"><span class="linenos"> 232</span></a><span class="sd">        - Symbolic pseudo-differential operators (Op)</span>
</span><span id="PDESolver-233"><a href="#PDESolver-233"><span class="linenos"> 233</span></a><span class="sd">        - Source terms (independent of u)</span>
</span><span id="PDESolver-234"><a href="#PDESolver-234"><span class="linenos"> 234</span></a><span class="sd">        - Pseudo-differential operators (psiOp)</span>
</span><span id="PDESolver-235"><a href="#PDESolver-235"><span class="linenos"> 235</span></a><span class="sd">    </span>
</span><span id="PDESolver-236"><a href="#PDESolver-236"><span class="linenos"> 236</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-237"><a href="#PDESolver-237"><span class="linenos"> 237</span></a><span class="sd">            equation (sympy.Eq): The partial differential equation to be analyzed. </span>
</span><span id="PDESolver-238"><a href="#PDESolver-238"><span class="linenos"> 238</span></a><span class="sd">                                 Can be provided as an Eq object or a sympy expression.</span>
</span><span id="PDESolver-239"><a href="#PDESolver-239"><span class="linenos"> 239</span></a><span class="sd">    </span>
</span><span id="PDESolver-240"><a href="#PDESolver-240"><span class="linenos"> 240</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-241"><a href="#PDESolver-241"><span class="linenos"> 241</span></a><span class="sd">            tuple: A 5-tuple containing:</span>
</span><span id="PDESolver-242"><a href="#PDESolver-242"><span class="linenos"> 242</span></a><span class="sd">            </span>
</span><span id="PDESolver-243"><a href="#PDESolver-243"><span class="linenos"> 243</span></a><span class="sd">                - linear_terms (dict): Mapping from derivative/function to coefficient.</span>
</span><span id="PDESolver-244"><a href="#PDESolver-244"><span class="linenos"> 244</span></a><span class="sd">                - nonlinear_terms (list): List of terms classified as nonlinear.</span>
</span><span id="PDESolver-245"><a href="#PDESolver-245"><span class="linenos"> 245</span></a><span class="sd">                - symbol_terms (list): List of (coefficient, symbolic operator) pairs.</span>
</span><span id="PDESolver-246"><a href="#PDESolver-246"><span class="linenos"> 246</span></a><span class="sd">                - source_terms (list): List of terms independent of the unknown function.</span>
</span><span id="PDESolver-247"><a href="#PDESolver-247"><span class="linenos"> 247</span></a><span class="sd">                - pseudo_terms (list): List of (coefficient, pseudo-differential symbol) pairs.</span>
</span><span id="PDESolver-248"><a href="#PDESolver-248"><span class="linenos"> 248</span></a><span class="sd">    </span>
</span><span id="PDESolver-249"><a href="#PDESolver-249"><span class="linenos"> 249</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-250"><a href="#PDESolver-250"><span class="linenos"> 250</span></a><span class="sd">            - If `psiOp` is present in the equation, expansion is skipped for safety.</span>
</span><span id="PDESolver-251"><a href="#PDESolver-251"><span class="linenos"> 251</span></a><span class="sd">            - When `psiOp` is used, only nonlinear terms, source terms, and possibly </span>
</span><span id="PDESolver-252"><a href="#PDESolver-252"><span class="linenos"> 252</span></a><span class="sd">              a time derivative are allowed; other linear terms and symbolic operators </span>
</span><span id="PDESolver-253"><a href="#PDESolver-253"><span class="linenos"> 253</span></a><span class="sd">              (Op) are forbidden.</span>
</span><span id="PDESolver-254"><a href="#PDESolver-254"><span class="linenos"> 254</span></a><span class="sd">            - Classification logic includes:</span>
</span><span id="PDESolver-255"><a href="#PDESolver-255"><span class="linenos"> 255</span></a><span class="sd">                - Detection of nonlinear structures like products or powers of u</span>
</span><span id="PDESolver-256"><a href="#PDESolver-256"><span class="linenos"> 256</span></a><span class="sd">                - Mixed terms involving both u and its derivatives</span>
</span><span id="PDESolver-257"><a href="#PDESolver-257"><span class="linenos"> 257</span></a><span class="sd">                - External symbolic operators (Op) and pseudo-differential operators (psiOp)</span>
</span><span id="PDESolver-258"><a href="#PDESolver-258"><span class="linenos"> 258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-259"><a href="#PDESolver-259"><span class="linenos"> 259</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_is_nonlinear_term</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">u_func</span><span class="p">):</span>
</span><span id="PDESolver-260"><a href="#PDESolver-260"><span class="linenos"> 260</span></a>            <span class="c1"># If the term contains functions (Abs, sin, exp, ...) applied to u</span>
</span><span id="PDESolver-261"><a href="#PDESolver-261"><span class="linenos"> 261</span></a>            <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">u_func</span><span class="p">):</span>
</span><span id="PDESolver-262"><a href="#PDESolver-262"><span class="linenos"> 262</span></a>                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">preorder_traversal</span><span class="p">(</span><span class="n">term</span><span class="p">):</span>
</span><span id="PDESolver-263"><a href="#PDESolver-263"><span class="linenos"> 263</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">u_func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">func</span> <span class="o">!=</span> <span class="n">u_func</span><span class="o">.</span><span class="n">func</span><span class="p">:</span>
</span><span id="PDESolver-264"><a href="#PDESolver-264"><span class="linenos"> 264</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="PDESolver-265"><a href="#PDESolver-265"><span class="linenos"> 265</span></a>            <span class="c1"># If the term contains a nonlinear power of u</span>
</span><span id="PDESolver-266"><a href="#PDESolver-266"><span class="linenos"> 266</span></a>            <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">Pow</span><span class="p">):</span>
</span><span id="PDESolver-267"><a href="#PDESolver-267"><span class="linenos"> 267</span></a>                <span class="k">for</span> <span class="n">pow_term</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Pow</span><span class="p">):</span>
</span><span id="PDESolver-268"><a href="#PDESolver-268"><span class="linenos"> 268</span></a>                    <span class="k">if</span> <span class="n">pow_term</span><span class="o">.</span><span class="n">base</span> <span class="o">==</span> <span class="n">u_func</span> <span class="ow">and</span> <span class="n">pow_term</span><span class="o">.</span><span class="n">exp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-269"><a href="#PDESolver-269"><span class="linenos"> 269</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="PDESolver-270"><a href="#PDESolver-270"><span class="linenos"> 270</span></a>            <span class="c1"># If the term is a product containing u and its derivative</span>
</span><span id="PDESolver-271"><a href="#PDESolver-271"><span class="linenos"> 271</span></a>            <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">Mul</span><span class="p">:</span>
</span><span id="PDESolver-272"><a href="#PDESolver-272"><span class="linenos"> 272</span></a>                <span class="n">factors</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">args</span>
</span><span id="PDESolver-273"><a href="#PDESolver-273"><span class="linenos"> 273</span></a>                <span class="n">has_u</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">u_func</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Derivative</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">))</span>
</span><span id="PDESolver-274"><a href="#PDESolver-274"><span class="linenos"> 274</span></a>                <span class="n">has_derivative</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Derivative</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">u_func</span><span class="o">.</span><span class="n">func</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">))</span>
</span><span id="PDESolver-275"><a href="#PDESolver-275"><span class="linenos"> 275</span></a>                <span class="k">if</span> <span class="n">has_u</span> <span class="ow">and</span> <span class="n">has_derivative</span><span class="p">:</span>
</span><span id="PDESolver-276"><a href="#PDESolver-276"><span class="linenos"> 276</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="PDESolver-277"><a href="#PDESolver-277"><span class="linenos"> 277</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="PDESolver-278"><a href="#PDESolver-278"><span class="linenos"> 278</span></a>    
</span><span id="PDESolver-279"><a href="#PDESolver-279"><span class="linenos"> 279</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">********************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-280"><a href="#PDESolver-280"><span class="linenos"> 280</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Equation parsing *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-281"><a href="#PDESolver-281"><span class="linenos"> 281</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;********************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-282"><a href="#PDESolver-282"><span class="linenos"> 282</span></a>    
</span><span id="PDESolver-283"><a href="#PDESolver-283"><span class="linenos"> 283</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">Eq</span><span class="p">):</span>
</span><span id="PDESolver-284"><a href="#PDESolver-284"><span class="linenos"> 284</span></a>            <span class="n">lhs</span> <span class="o">=</span> <span class="n">equation</span><span class="o">.</span><span class="n">lhs</span> <span class="o">-</span> <span class="n">equation</span><span class="o">.</span><span class="n">rhs</span>
</span><span id="PDESolver-285"><a href="#PDESolver-285"><span class="linenos"> 285</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-286"><a href="#PDESolver-286"><span class="linenos"> 286</span></a>            <span class="n">lhs</span> <span class="o">=</span> <span class="n">equation</span>
</span><span id="PDESolver-287"><a href="#PDESolver-287"><span class="linenos"> 287</span></a>    
</span><span id="PDESolver-288"><a href="#PDESolver-288"><span class="linenos"> 288</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Equation rewritten in standard form: </span><span class="si">{</span><span class="n">lhs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-289"><a href="#PDESolver-289"><span class="linenos"> 289</span></a>        <span class="k">if</span> <span class="n">lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">psiOp</span><span class="p">):</span>
</span><span id="PDESolver-290"><a href="#PDESolver-290"><span class="linenos"> 290</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ psiOp detected: skipping expansion for safety&quot;</span><span class="p">)</span>
</span><span id="PDESolver-291"><a href="#PDESolver-291"><span class="linenos"> 291</span></a>            <span class="n">lhs_expanded</span> <span class="o">=</span> <span class="n">lhs</span>
</span><span id="PDESolver-292"><a href="#PDESolver-292"><span class="linenos"> 292</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-293"><a href="#PDESolver-293"><span class="linenos"> 293</span></a>            <span class="n">lhs_expanded</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
</span><span id="PDESolver-294"><a href="#PDESolver-294"><span class="linenos"> 294</span></a>    
</span><span id="PDESolver-295"><a href="#PDESolver-295"><span class="linenos"> 295</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expanded equation: </span><span class="si">{</span><span class="n">lhs_expanded</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-296"><a href="#PDESolver-296"><span class="linenos"> 296</span></a>    
</span><span id="PDESolver-297"><a href="#PDESolver-297"><span class="linenos"> 297</span></a>        <span class="n">linear_terms</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PDESolver-298"><a href="#PDESolver-298"><span class="linenos"> 298</span></a>        <span class="n">nonlinear_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-299"><a href="#PDESolver-299"><span class="linenos"> 299</span></a>        <span class="n">symbol_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-300"><a href="#PDESolver-300"><span class="linenos"> 300</span></a>        <span class="n">source_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-301"><a href="#PDESolver-301"><span class="linenos"> 301</span></a>        <span class="n">pseudo_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-302"><a href="#PDESolver-302"><span class="linenos"> 302</span></a>    
</span><span id="PDESolver-303"><a href="#PDESolver-303"><span class="linenos"> 303</span></a>        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">lhs_expanded</span><span class="o">.</span><span class="n">as_ordered_terms</span><span class="p">():</span>
</span><span id="PDESolver-304"><a href="#PDESolver-304"><span class="linenos"> 304</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing term: </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-305"><a href="#PDESolver-305"><span class="linenos"> 305</span></a>    
</span><span id="PDESolver-306"><a href="#PDESolver-306"><span class="linenos"> 306</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">psiOp</span><span class="p">):</span>
</span><span id="PDESolver-307"><a href="#PDESolver-307"><span class="linenos"> 307</span></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-308"><a href="#PDESolver-308"><span class="linenos"> 308</span></a>                <span class="n">pseudo_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
</span><span id="PDESolver-309"><a href="#PDESolver-309"><span class="linenos"> 309</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as pseudo linear term (psiOp)&quot;</span><span class="p">)</span>
</span><span id="PDESolver-310"><a href="#PDESolver-310"><span class="linenos"> 310</span></a>                <span class="k">continue</span>
</span><span id="PDESolver-311"><a href="#PDESolver-311"><span class="linenos"> 311</span></a>    
</span><span id="PDESolver-312"><a href="#PDESolver-312"><span class="linenos"> 312</span></a>            <span class="c1"># Otherwise, look for psiOp inside (general case)</span>
</span><span id="PDESolver-313"><a href="#PDESolver-313"><span class="linenos"> 313</span></a>            <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">psiOp</span><span class="p">):</span>
</span><span id="PDESolver-314"><a href="#PDESolver-314"><span class="linenos"> 314</span></a>                <span class="n">psiops</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">psiOp</span><span class="p">)</span>
</span><span id="PDESolver-315"><a href="#PDESolver-315"><span class="linenos"> 315</span></a>                <span class="k">for</span> <span class="n">psi</span> <span class="ow">in</span> <span class="n">psiops</span><span class="p">:</span>
</span><span id="PDESolver-316"><a href="#PDESolver-316"><span class="linenos"> 316</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-317"><a href="#PDESolver-317"><span class="linenos"> 317</span></a>                        <span class="n">coeff</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">term</span> <span class="o">/</span> <span class="n">psi</span><span class="p">)</span>
</span><span id="PDESolver-318"><a href="#PDESolver-318"><span class="linenos"> 318</span></a>                        <span class="n">expr</span> <span class="o">=</span> <span class="n">psi</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-319"><a href="#PDESolver-319"><span class="linenos"> 319</span></a>                        <span class="n">pseudo_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
</span><span id="PDESolver-320"><a href="#PDESolver-320"><span class="linenos"> 320</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as pseudo linear term (psiOp)&quot;</span><span class="p">)</span>
</span><span id="PDESolver-321"><a href="#PDESolver-321"><span class="linenos"> 321</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PDESolver-322"><a href="#PDESolver-322"><span class="linenos"> 322</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ⚠️ Failed to extract psiOp coefficient in term: </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-323"><a href="#PDESolver-323"><span class="linenos"> 323</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Reason: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-324"><a href="#PDESolver-324"><span class="linenos"> 324</span></a>                        <span class="n">nonlinear_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
</span><span id="PDESolver-325"><a href="#PDESolver-325"><span class="linenos"> 325</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Fallback: classified as nonlinear&quot;</span><span class="p">)</span>
</span><span id="PDESolver-326"><a href="#PDESolver-326"><span class="linenos"> 326</span></a>                <span class="k">continue</span>
</span><span id="PDESolver-327"><a href="#PDESolver-327"><span class="linenos"> 327</span></a>    
</span><span id="PDESolver-328"><a href="#PDESolver-328"><span class="linenos"> 328</span></a>            <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">Op</span><span class="p">):</span>
</span><span id="PDESolver-329"><a href="#PDESolver-329"><span class="linenos"> 329</span></a>                <span class="n">ops</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Op</span><span class="p">)</span>
</span><span id="PDESolver-330"><a href="#PDESolver-330"><span class="linenos"> 330</span></a>                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="PDESolver-331"><a href="#PDESolver-331"><span class="linenos"> 331</span></a>                    <span class="n">coeff</span> <span class="o">=</span> <span class="n">term</span> <span class="o">/</span> <span class="n">op</span>
</span><span id="PDESolver-332"><a href="#PDESolver-332"><span class="linenos"> 332</span></a>                    <span class="n">expr</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-333"><a href="#PDESolver-333"><span class="linenos"> 333</span></a>                    <span class="n">symbol_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
</span><span id="PDESolver-334"><a href="#PDESolver-334"><span class="linenos"> 334</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as symbolic linear term (Op)&quot;</span><span class="p">)</span>
</span><span id="PDESolver-335"><a href="#PDESolver-335"><span class="linenos"> 335</span></a>                <span class="k">continue</span>
</span><span id="PDESolver-336"><a href="#PDESolver-336"><span class="linenos"> 336</span></a>    
</span><span id="PDESolver-337"><a href="#PDESolver-337"><span class="linenos"> 337</span></a>            <span class="k">if</span> <span class="n">_is_nonlinear_term</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver-338"><a href="#PDESolver-338"><span class="linenos"> 338</span></a>                <span class="n">nonlinear_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
</span><span id="PDESolver-339"><a href="#PDESolver-339"><span class="linenos"> 339</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as nonlinear&quot;</span><span class="p">)</span>
</span><span id="PDESolver-340"><a href="#PDESolver-340"><span class="linenos"> 340</span></a>                <span class="k">continue</span>
</span><span id="PDESolver-341"><a href="#PDESolver-341"><span class="linenos"> 341</span></a>    
</span><span id="PDESolver-342"><a href="#PDESolver-342"><span class="linenos"> 342</span></a>            <span class="n">derivs</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Derivative</span><span class="p">)</span>
</span><span id="PDESolver-343"><a href="#PDESolver-343"><span class="linenos"> 343</span></a>            <span class="k">if</span> <span class="n">derivs</span><span class="p">:</span>
</span><span id="PDESolver-344"><a href="#PDESolver-344"><span class="linenos"> 344</span></a>                <span class="n">deriv</span> <span class="o">=</span> <span class="n">derivs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="PDESolver-345"><a href="#PDESolver-345"><span class="linenos"> 345</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">term</span> <span class="o">/</span> <span class="n">deriv</span>
</span><span id="PDESolver-346"><a href="#PDESolver-346"><span class="linenos"> 346</span></a>                <span class="n">linear_terms</span><span class="p">[</span><span class="n">deriv</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_terms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">coeff</span>
</span><span id="PDESolver-347"><a href="#PDESolver-347"><span class="linenos"> 347</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Derivative found: </span><span class="si">{</span><span class="n">deriv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-348"><a href="#PDESolver-348"><span class="linenos"> 348</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as linear&quot;</span><span class="p">)</span>
</span><span id="PDESolver-349"><a href="#PDESolver-349"><span class="linenos"> 349</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
</span><span id="PDESolver-350"><a href="#PDESolver-350"><span class="linenos"> 350</span></a>                <span class="n">coeff</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">as_coefficients_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PDESolver-351"><a href="#PDESolver-351"><span class="linenos"> 351</span></a>                <span class="n">linear_terms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_terms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">coeff</span>
</span><span id="PDESolver-352"><a href="#PDESolver-352"><span class="linenos"> 352</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as linear&quot;</span><span class="p">)</span>
</span><span id="PDESolver-353"><a href="#PDESolver-353"><span class="linenos"> 353</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-354"><a href="#PDESolver-354"><span class="linenos"> 354</span></a>                <span class="n">source_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
</span><span id="PDESolver-355"><a href="#PDESolver-355"><span class="linenos"> 355</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  --&gt; Classified as source term&quot;</span><span class="p">)</span>
</span><span id="PDESolver-356"><a href="#PDESolver-356"><span class="linenos"> 356</span></a>    
</span><span id="PDESolver-357"><a href="#PDESolver-357"><span class="linenos"> 357</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final linear terms: </span><span class="si">{</span><span class="n">linear_terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-358"><a href="#PDESolver-358"><span class="linenos"> 358</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final nonlinear terms: </span><span class="si">{</span><span class="n">nonlinear_terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-359"><a href="#PDESolver-359"><span class="linenos"> 359</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol terms: </span><span class="si">{</span><span class="n">symbol_terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-360"><a href="#PDESolver-360"><span class="linenos"> 360</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pseudo terms: </span><span class="si">{</span><span class="n">pseudo_terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-361"><a href="#PDESolver-361"><span class="linenos"> 361</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source terms: </span><span class="si">{</span><span class="n">source_terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-362"><a href="#PDESolver-362"><span class="linenos"> 362</span></a>    
</span><span id="PDESolver-363"><a href="#PDESolver-363"><span class="linenos"> 363</span></a>        <span class="k">if</span> <span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver-364"><a href="#PDESolver-364"><span class="linenos"> 364</span></a>            <span class="c1"># Check if a time derivative is present among the linear terms</span>
</span><span id="PDESolver-365"><a href="#PDESolver-365"><span class="linenos"> 365</span></a>            <span class="n">has_time_derivative</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="PDESolver-366"><a href="#PDESolver-366"><span class="linenos"> 366</span></a>                <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Derivative</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">_</span>  <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">variable_count</span><span class="p">]</span>
</span><span id="PDESolver-367"><a href="#PDESolver-367"><span class="linenos"> 367</span></a>                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">linear_terms</span>
</span><span id="PDESolver-368"><a href="#PDESolver-368"><span class="linenos"> 368</span></a>            <span class="p">)</span>
</span><span id="PDESolver-369"><a href="#PDESolver-369"><span class="linenos"> 369</span></a>            <span class="c1"># Extract non-temporal linear terms</span>
</span><span id="PDESolver-370"><a href="#PDESolver-370"><span class="linenos"> 370</span></a>            <span class="n">invalid_linear_terms</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PDESolver-371"><a href="#PDESolver-371"><span class="linenos"> 371</span></a>                <span class="n">term</span><span class="p">:</span> <span class="n">coeff</span> <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">linear_terms</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PDESolver-372"><a href="#PDESolver-372"><span class="linenos"> 372</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="PDESolver-373"><a href="#PDESolver-373"><span class="linenos"> 373</span></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Derivative</span><span class="p">)</span>
</span><span id="PDESolver-374"><a href="#PDESolver-374"><span class="linenos"> 374</span></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">_</span>  <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">variable_count</span><span class="p">]</span>
</span><span id="PDESolver-375"><a href="#PDESolver-375"><span class="linenos"> 375</span></a>                <span class="p">)</span>
</span><span id="PDESolver-376"><a href="#PDESolver-376"><span class="linenos"> 376</span></a>                <span class="ow">and</span> <span class="n">term</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>  <span class="c1"># exclusion of the simple u term (without derivative)</span>
</span><span id="PDESolver-377"><a href="#PDESolver-377"><span class="linenos"> 377</span></a>            <span class="p">}</span>
</span><span id="PDESolver-378"><a href="#PDESolver-378"><span class="linenos"> 378</span></a>    
</span><span id="PDESolver-379"><a href="#PDESolver-379"><span class="linenos"> 379</span></a>            <span class="k">if</span> <span class="n">invalid_linear_terms</span> <span class="ow">or</span> <span class="n">symbol_terms</span><span class="p">:</span>
</span><span id="PDESolver-380"><a href="#PDESolver-380"><span class="linenos"> 380</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PDESolver-381"><a href="#PDESolver-381"><span class="linenos"> 381</span></a>                    <span class="s2">&quot;When psiOp is used, only nonlinear terms, source terms, &quot;</span>
</span><span id="PDESolver-382"><a href="#PDESolver-382"><span class="linenos"> 382</span></a>                    <span class="s2">&quot;and possibly a time derivative are allowed. &quot;</span>
</span><span id="PDESolver-383"><a href="#PDESolver-383"><span class="linenos"> 383</span></a>                    <span class="s2">&quot;Other linear terms and Ops are forbidden.&quot;</span>
</span><span id="PDESolver-384"><a href="#PDESolver-384"><span class="linenos"> 384</span></a>                <span class="p">)</span>
</span><span id="PDESolver-385"><a href="#PDESolver-385"><span class="linenos"> 385</span></a>    
</span><span id="PDESolver-386"><a href="#PDESolver-386"><span class="linenos"> 386</span></a>        <span class="k">return</span> <span class="n">linear_terms</span><span class="p">,</span> <span class="n">nonlinear_terms</span><span class="p">,</span> <span class="n">symbol_terms</span><span class="p">,</span> <span class="n">source_terms</span><span class="p">,</span> <span class="n">pseudo_terms</span>
</span><span id="PDESolver-387"><a href="#PDESolver-387"><span class="linenos"> 387</span></a>
</span><span id="PDESolver-388"><a href="#PDESolver-388"><span class="linenos"> 388</span></a>
</span><span id="PDESolver-389"><a href="#PDESolver-389"><span class="linenos"> 389</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_linear_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-390"><a href="#PDESolver-390"><span class="linenos"> 390</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-391"><a href="#PDESolver-391"><span class="linenos"> 391</span></a><span class="sd">        Compute the symbolic Fourier representation L(k) of the linear operator </span>
</span><span id="PDESolver-392"><a href="#PDESolver-392"><span class="linenos"> 392</span></a><span class="sd">        derived from the linear part of the PDE.</span>
</span><span id="PDESolver-393"><a href="#PDESolver-393"><span class="linenos"> 393</span></a><span class="sd">    </span>
</span><span id="PDESolver-394"><a href="#PDESolver-394"><span class="linenos"> 394</span></a><span class="sd">        This method constructs a dispersion relation by applying each symbolic derivative</span>
</span><span id="PDESolver-395"><a href="#PDESolver-395"><span class="linenos"> 395</span></a><span class="sd">        to a plane wave exp(i(k·x - ωt)) and extracting the resulting expression.</span>
</span><span id="PDESolver-396"><a href="#PDESolver-396"><span class="linenos"> 396</span></a><span class="sd">        It handles arbitrary derivative combinations and includes symbolic and</span>
</span><span id="PDESolver-397"><a href="#PDESolver-397"><span class="linenos"> 397</span></a><span class="sd">        pseudo-differential terms.</span>
</span><span id="PDESolver-398"><a href="#PDESolver-398"><span class="linenos"> 398</span></a><span class="sd">    </span>
</span><span id="PDESolver-399"><a href="#PDESolver-399"><span class="linenos"> 399</span></a><span class="sd">        Steps:</span>
</span><span id="PDESolver-400"><a href="#PDESolver-400"><span class="linenos"> 400</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-401"><a href="#PDESolver-401"><span class="linenos"> 401</span></a><span class="sd">        1. Construct a plane wave φ(x, t) = exp(i(k·x - ωt)).</span>
</span><span id="PDESolver-402"><a href="#PDESolver-402"><span class="linenos"> 402</span></a><span class="sd">        2. Apply each term from self.linear_terms to φ.</span>
</span><span id="PDESolver-403"><a href="#PDESolver-403"><span class="linenos"> 403</span></a><span class="sd">        3. Normalize by φ and simplify to obtain L(k).</span>
</span><span id="PDESolver-404"><a href="#PDESolver-404"><span class="linenos"> 404</span></a><span class="sd">        4. Include symbolic terms (e.g., psiOp) if present.</span>
</span><span id="PDESolver-405"><a href="#PDESolver-405"><span class="linenos"> 405</span></a><span class="sd">        5. Detect the temporal order from the dispersion relation.</span>
</span><span id="PDESolver-406"><a href="#PDESolver-406"><span class="linenos"> 406</span></a><span class="sd">        6. Build the numerical function L(k) via lambdify.</span>
</span><span id="PDESolver-407"><a href="#PDESolver-407"><span class="linenos"> 407</span></a><span class="sd">    </span>
</span><span id="PDESolver-408"><a href="#PDESolver-408"><span class="linenos"> 408</span></a><span class="sd">        Sets:</span>
</span><span id="PDESolver-409"><a href="#PDESolver-409"><span class="linenos"> 409</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-410"><a href="#PDESolver-410"><span class="linenos"> 410</span></a><span class="sd">        - self.L_symbolic : sympy.Expr</span>
</span><span id="PDESolver-411"><a href="#PDESolver-411"><span class="linenos"> 411</span></a><span class="sd">            Symbolic form of L(k).</span>
</span><span id="PDESolver-412"><a href="#PDESolver-412"><span class="linenos"> 412</span></a><span class="sd">        - self.L : callable</span>
</span><span id="PDESolver-413"><a href="#PDESolver-413"><span class="linenos"> 413</span></a><span class="sd">            Numerical function of L(kx[, ky]).</span>
</span><span id="PDESolver-414"><a href="#PDESolver-414"><span class="linenos"> 414</span></a><span class="sd">        - self.omega : callable or None</span>
</span><span id="PDESolver-415"><a href="#PDESolver-415"><span class="linenos"> 415</span></a><span class="sd">            Frequency root ω(k), if available.</span>
</span><span id="PDESolver-416"><a href="#PDESolver-416"><span class="linenos"> 416</span></a><span class="sd">        - self.temporal_order : int</span>
</span><span id="PDESolver-417"><a href="#PDESolver-417"><span class="linenos"> 417</span></a><span class="sd">            Order of time derivatives detected.</span>
</span><span id="PDESolver-418"><a href="#PDESolver-418"><span class="linenos"> 418</span></a><span class="sd">        - self.psi_ops : list of (coeff, PseudoDifferentialOperator)</span>
</span><span id="PDESolver-419"><a href="#PDESolver-419"><span class="linenos"> 419</span></a><span class="sd">            Pseudo-differential terms present in the equation.</span>
</span><span id="PDESolver-420"><a href="#PDESolver-420"><span class="linenos"> 420</span></a><span class="sd">    </span>
</span><span id="PDESolver-421"><a href="#PDESolver-421"><span class="linenos"> 421</span></a><span class="sd">        Raises:</span>
</span><span id="PDESolver-422"><a href="#PDESolver-422"><span class="linenos"> 422</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-423"><a href="#PDESolver-423"><span class="linenos"> 423</span></a><span class="sd">        ValueError if the dimension is unsupported or the dispersion relation fails.</span>
</span><span id="PDESolver-424"><a href="#PDESolver-424"><span class="linenos"> 424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-425"><a href="#PDESolver-425"><span class="linenos"> 425</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-426"><a href="#PDESolver-426"><span class="linenos"> 426</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Linear operator computation *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-427"><a href="#PDESolver-427"><span class="linenos"> 427</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*******************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-428"><a href="#PDESolver-428"><span class="linenos"> 428</span></a>    
</span><span id="PDESolver-429"><a href="#PDESolver-429"><span class="linenos"> 429</span></a>        <span class="c1"># --- Step 1: symbolic variables ---</span>
</span><span id="PDESolver-430"><a href="#PDESolver-430"><span class="linenos"> 430</span></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;omega&quot;</span><span class="p">)</span>
</span><span id="PDESolver-431"><a href="#PDESolver-431"><span class="linenos"> 431</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-432"><a href="#PDESolver-432"><span class="linenos"> 432</span></a>            <span class="n">kvars</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;kx&quot;</span><span class="p">)]</span>
</span><span id="PDESolver-433"><a href="#PDESolver-433"><span class="linenos"> 433</span></a>            <span class="n">space_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">]</span>
</span><span id="PDESolver-434"><a href="#PDESolver-434"><span class="linenos"> 434</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-435"><a href="#PDESolver-435"><span class="linenos"> 435</span></a>            <span class="n">kvars</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;kx ky&quot;</span><span class="p">)</span>
</span><span id="PDESolver-436"><a href="#PDESolver-436"><span class="linenos"> 436</span></a>            <span class="n">space_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
</span><span id="PDESolver-437"><a href="#PDESolver-437"><span class="linenos"> 437</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-438"><a href="#PDESolver-438"><span class="linenos"> 438</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-439"><a href="#PDESolver-439"><span class="linenos"> 439</span></a>    
</span><span id="PDESolver-440"><a href="#PDESolver-440"><span class="linenos"> 440</span></a>        <span class="n">kdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">space_vars</span><span class="p">,</span> <span class="n">kvars</span><span class="p">))</span>
</span><span id="PDESolver-441"><a href="#PDESolver-441"><span class="linenos"> 441</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span> <span class="o">=</span> <span class="n">kvars</span>
</span><span id="PDESolver-442"><a href="#PDESolver-442"><span class="linenos"> 442</span></a>    
</span><span id="PDESolver-443"><a href="#PDESolver-443"><span class="linenos"> 443</span></a>        <span class="c1"># Plane wave expression</span>
</span><span id="PDESolver-444"><a href="#PDESolver-444"><span class="linenos"> 444</span></a>        <span class="n">phase</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">x</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kvars</span><span class="p">,</span> <span class="n">space_vars</span><span class="p">))</span> <span class="o">-</span> <span class="n">omega</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
</span><span id="PDESolver-445"><a href="#PDESolver-445"><span class="linenos"> 445</span></a>        <span class="n">plane_wave</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="n">phase</span><span class="p">)</span>
</span><span id="PDESolver-446"><a href="#PDESolver-446"><span class="linenos"> 446</span></a>    
</span><span id="PDESolver-447"><a href="#PDESolver-447"><span class="linenos"> 447</span></a>        <span class="c1"># --- Step 2: build lhs expression from linear terms ---</span>
</span><span id="PDESolver-448"><a href="#PDESolver-448"><span class="linenos"> 448</span></a>        <span class="n">lhs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-449"><a href="#PDESolver-449"><span class="linenos"> 449</span></a>        <span class="k">for</span> <span class="n">deriv</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="PDESolver-450"><a href="#PDESolver-450"><span class="linenos"> 450</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span> <span class="n">Derivative</span><span class="p">):</span>
</span><span id="PDESolver-451"><a href="#PDESolver-451"><span class="linenos"> 451</span></a>                <span class="n">total_factor</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="PDESolver-452"><a href="#PDESolver-452"><span class="linenos"> 452</span></a>                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">deriv</span><span class="o">.</span><span class="n">variable_count</span><span class="p">:</span>
</span><span id="PDESolver-453"><a href="#PDESolver-453"><span class="linenos"> 453</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
</span><span id="PDESolver-454"><a href="#PDESolver-454"><span class="linenos"> 454</span></a>                        <span class="n">total_factor</span> <span class="o">*=</span> <span class="p">(</span><span class="o">-</span><span class="n">I</span> <span class="o">*</span> <span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="n">n</span>
</span><span id="PDESolver-455"><a href="#PDESolver-455"><span class="linenos"> 455</span></a>                    <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">kdict</span><span class="p">:</span>
</span><span id="PDESolver-456"><a href="#PDESolver-456"><span class="linenos"> 456</span></a>                        <span class="n">total_factor</span> <span class="o">*=</span> <span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="n">kdict</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">**</span><span class="n">n</span>
</span><span id="PDESolver-457"><a href="#PDESolver-457"><span class="linenos"> 457</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-458"><a href="#PDESolver-458"><span class="linenos"> 458</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> in derivative&quot;</span><span class="p">)</span>
</span><span id="PDESolver-459"><a href="#PDESolver-459"><span class="linenos"> 459</span></a>                <span class="n">lhs</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">total_factor</span> <span class="o">*</span> <span class="n">plane_wave</span>
</span><span id="PDESolver-460"><a href="#PDESolver-460"><span class="linenos"> 460</span></a>            <span class="k">elif</span> <span class="n">deriv</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">:</span>
</span><span id="PDESolver-461"><a href="#PDESolver-461"><span class="linenos"> 461</span></a>                <span class="n">lhs</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">plane_wave</span>
</span><span id="PDESolver-462"><a href="#PDESolver-462"><span class="linenos"> 462</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-463"><a href="#PDESolver-463"><span class="linenos"> 463</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported linear term: </span><span class="si">{</span><span class="n">deriv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-464"><a href="#PDESolver-464"><span class="linenos"> 464</span></a>    
</span><span id="PDESolver-465"><a href="#PDESolver-465"><span class="linenos"> 465</span></a>        <span class="c1"># --- Step 3: dispersion relation ---</span>
</span><span id="PDESolver-466"><a href="#PDESolver-466"><span class="linenos"> 466</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">lhs</span> <span class="o">/</span> <span class="n">plane_wave</span><span class="p">)</span>
</span><span id="PDESolver-467"><a href="#PDESolver-467"><span class="linenos"> 467</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Characteristic equation before symbol treatment:&quot;</span><span class="p">)</span>
</span><span id="PDESolver-468"><a href="#PDESolver-468"><span class="linenos"> 468</span></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver-469"><a href="#PDESolver-469"><span class="linenos"> 469</span></a>
</span><span id="PDESolver-470"><a href="#PDESolver-470"><span class="linenos"> 470</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Symbolic symbol analysis ---&quot;</span><span class="p">)</span>
</span><span id="PDESolver-471"><a href="#PDESolver-471"><span class="linenos"> 471</span></a>        <span class="n">symb_omega</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-472"><a href="#PDESolver-472"><span class="linenos"> 472</span></a>        <span class="n">symb_k</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-473"><a href="#PDESolver-473"><span class="linenos"> 473</span></a>        
</span><span id="PDESolver-474"><a href="#PDESolver-474"><span class="linenos"> 474</span></a>        <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_terms</span><span class="p">:</span>
</span><span id="PDESolver-475"><a href="#PDESolver-475"><span class="linenos"> 475</span></a>            <span class="k">if</span> <span class="n">symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
</span><span id="PDESolver-476"><a href="#PDESolver-476"><span class="linenos"> 476</span></a>                <span class="c1"># Ajouter directement les termes dépendant de omega</span>
</span><span id="PDESolver-477"><a href="#PDESolver-477"><span class="linenos"> 477</span></a>                <span class="n">symb_omega</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">symbol</span>
</span><span id="PDESolver-478"><a href="#PDESolver-478"><span class="linenos"> 478</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span><span class="p">):</span>
</span><span id="PDESolver-479"><a href="#PDESolver-479"><span class="linenos"> 479</span></a>                 <span class="n">symb_k</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">symbol</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span><span class="p">)))</span>
</span><span id="PDESolver-480"><a href="#PDESolver-480"><span class="linenos"> 480</span></a>
</span><span id="PDESolver-481"><a href="#PDESolver-481"><span class="linenos"> 481</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;symb_omega: </span><span class="si">{</span><span class="n">symb_omega</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-482"><a href="#PDESolver-482"><span class="linenos"> 482</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;symb_k: </span><span class="si">{</span><span class="n">symb_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-483"><a href="#PDESolver-483"><span class="linenos"> 483</span></a>        
</span><span id="PDESolver-484"><a href="#PDESolver-484"><span class="linenos"> 484</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="n">equation</span> <span class="o">+</span> <span class="n">symb_omega</span> <span class="o">+</span> <span class="n">symb_k</span>         
</span><span id="PDESolver-485"><a href="#PDESolver-485"><span class="linenos"> 485</span></a>
</span><span id="PDESolver-486"><a href="#PDESolver-486"><span class="linenos"> 486</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raw characteristic equation:&quot;</span><span class="p">)</span>
</span><span id="PDESolver-487"><a href="#PDESolver-487"><span class="linenos"> 487</span></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver-488"><a href="#PDESolver-488"><span class="linenos"> 488</span></a>
</span><span id="PDESolver-489"><a href="#PDESolver-489"><span class="linenos"> 489</span></a>        <span class="c1"># Temporal derivative order detection</span>
</span><span id="PDESolver-490"><a href="#PDESolver-490"><span class="linenos"> 490</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-491"><a href="#PDESolver-491"><span class="linenos"> 491</span></a>            <span class="n">poly_eq</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="PDESolver-492"><a href="#PDESolver-492"><span class="linenos"> 492</span></a>            <span class="n">poly</span> <span class="o">=</span> <span class="n">poly_eq</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">as_poly</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
</span><span id="PDESolver-493"><a href="#PDESolver-493"><span class="linenos"> 493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="k">if</span> <span class="n">poly</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PDESolver-494"><a href="#PDESolver-494"><span class="linenos"> 494</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PDESolver-495"><a href="#PDESolver-495"><span class="linenos"> 495</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine temporal order: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="PDESolver-496"><a href="#PDESolver-496"><span class="linenos"> 496</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-497"><a href="#PDESolver-497"><span class="linenos"> 497</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporal order from dispersion relation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-498"><a href="#PDESolver-498"><span class="linenos"> 498</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.pseudo_terms = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">)</span>
</span><span id="PDESolver-499"><a href="#PDESolver-499"><span class="linenos"> 499</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver-500"><a href="#PDESolver-500"><span class="linenos"> 500</span></a>            <span class="n">coeff_time</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="PDESolver-501"><a href="#PDESolver-501"><span class="linenos"> 501</span></a>            <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="PDESolver-502"><a href="#PDESolver-502"><span class="linenos"> 502</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Derivative</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">_</span>  <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">variable_count</span><span class="p">):</span>
</span><span id="PDESolver-503"><a href="#PDESolver-503"><span class="linenos"> 503</span></a>                    <span class="n">coeff_time</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="PDESolver-504"><a href="#PDESolver-504"><span class="linenos"> 504</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Time derivative coefficient detected: </span><span class="si">{</span><span class="n">coeff_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-505"><a href="#PDESolver-505"><span class="linenos"> 505</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-506"><a href="#PDESolver-506"><span class="linenos"> 506</span></a>            <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">sym_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver-507"><a href="#PDESolver-507"><span class="linenos"> 507</span></a>                <span class="c1"># expr est le Sympy expr. différentiel, var_x la liste [x] ou [x,y]</span>
</span><span id="PDESolver-508"><a href="#PDESolver-508"><span class="linenos"> 508</span></a>                <span class="n">psi</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">sym_expr</span> <span class="o">/</span> <span class="n">coeff_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
</span><span id="PDESolver-509"><a href="#PDESolver-509"><span class="linenos"> 509</span></a>                
</span><span id="PDESolver-510"><a href="#PDESolver-510"><span class="linenos"> 510</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span>
</span><span id="PDESolver-511"><a href="#PDESolver-511"><span class="linenos"> 511</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-512"><a href="#PDESolver-512"><span class="linenos"> 512</span></a>            <span class="n">dispersion</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">Eq</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">omega</span><span class="p">)</span>
</span><span id="PDESolver-513"><a href="#PDESolver-513"><span class="linenos"> 513</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dispersion</span><span class="p">:</span>
</span><span id="PDESolver-514"><a href="#PDESolver-514"><span class="linenos"> 514</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No solution found for omega&quot;</span><span class="p">)</span>
</span><span id="PDESolver-515"><a href="#PDESolver-515"><span class="linenos"> 515</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Solutions found ---&quot;</span><span class="p">)</span>
</span><span id="PDESolver-516"><a href="#PDESolver-516"><span class="linenos"> 516</span></a>            <span class="n">pprint</span><span class="p">(</span><span class="n">dispersion</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver-517"><a href="#PDESolver-517"><span class="linenos"> 517</span></a>        
</span><span id="PDESolver-518"><a href="#PDESolver-518"><span class="linenos"> 518</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-519"><a href="#PDESolver-519"><span class="linenos"> 519</span></a>                <span class="n">omega_expr</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dispersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="PDESolver-520"><a href="#PDESolver-520"><span class="linenos"> 520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">omega_symbolic</span> <span class="o">=</span> <span class="n">omega_expr</span>
</span><span id="PDESolver-521"><a href="#PDESolver-521"><span class="linenos"> 521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span><span class="p">,</span> <span class="n">omega_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="PDESolver-522"><a href="#PDESolver-522"><span class="linenos"> 522</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">L_symbolic</span> <span class="o">=</span> <span class="o">-</span><span class="n">omega_expr</span><span class="o">**</span><span class="mi">2</span>
</span><span id="PDESolver-523"><a href="#PDESolver-523"><span class="linenos"> 523</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-524"><a href="#PDESolver-524"><span class="linenos"> 524</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">L_symbolic</span> <span class="o">=</span> <span class="o">-</span><span class="n">I</span> <span class="o">*</span> <span class="n">dispersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-525"><a href="#PDESolver-525"><span class="linenos"> 525</span></a>        
</span><span id="PDESolver-526"><a href="#PDESolver-526"><span class="linenos"> 526</span></a>        
</span><span id="PDESolver-527"><a href="#PDESolver-527"><span class="linenos"> 527</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_symbolic</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="PDESolver-528"><a href="#PDESolver-528"><span class="linenos"> 528</span></a>  
</span><span id="PDESolver-529"><a href="#PDESolver-529"><span class="linenos"> 529</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Final linear operator ---&quot;</span><span class="p">)</span>
</span><span id="PDESolver-530"><a href="#PDESolver-530"><span class="linenos"> 530</span></a>            <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L_symbolic</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>   
</span><span id="PDESolver-531"><a href="#PDESolver-531"><span class="linenos"> 531</span></a>
</span><span id="PDESolver-532"><a href="#PDESolver-532"><span class="linenos"> 532</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_linear_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PDESolver-533"><a href="#PDESolver-533"><span class="linenos"> 533</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-534"><a href="#PDESolver-534"><span class="linenos"> 534</span></a><span class="sd">        Apply the linear operator (in Fourier space) to the field u or v.</span>
</span><span id="PDESolver-535"><a href="#PDESolver-535"><span class="linenos"> 535</span></a>
</span><span id="PDESolver-536"><a href="#PDESolver-536"><span class="linenos"> 536</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-537"><a href="#PDESolver-537"><span class="linenos"> 537</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-538"><a href="#PDESolver-538"><span class="linenos"> 538</span></a><span class="sd">        u : np.ndarray</span>
</span><span id="PDESolver-539"><a href="#PDESolver-539"><span class="linenos"> 539</span></a><span class="sd">            Input solution array.</span>
</span><span id="PDESolver-540"><a href="#PDESolver-540"><span class="linenos"> 540</span></a><span class="sd">        is_v : bool</span>
</span><span id="PDESolver-541"><a href="#PDESolver-541"><span class="linenos"> 541</span></a><span class="sd">            Whether to apply the operator to v instead of u.</span>
</span><span id="PDESolver-542"><a href="#PDESolver-542"><span class="linenos"> 542</span></a>
</span><span id="PDESolver-543"><a href="#PDESolver-543"><span class="linenos"> 543</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver-544"><a href="#PDESolver-544"><span class="linenos"> 544</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-545"><a href="#PDESolver-545"><span class="linenos"> 545</span></a><span class="sd">        np.ndarray</span>
</span><span id="PDESolver-546"><a href="#PDESolver-546"><span class="linenos"> 546</span></a><span class="sd">            Result of applying the linear operator.</span>
</span><span id="PDESolver-547"><a href="#PDESolver-547"><span class="linenos"> 547</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-548"><a href="#PDESolver-548"><span class="linenos"> 548</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-549"><a href="#PDESolver-549"><span class="linenos"> 549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-550"><a href="#PDESolver-550"><span class="linenos"> 550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_u</span>  <span class="c1"># même opérateur pour u et v</span>
</span><span id="PDESolver-551"><a href="#PDESolver-551"><span class="linenos"> 551</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-552"><a href="#PDESolver-552"><span class="linenos"> 552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-553"><a href="#PDESolver-553"><span class="linenos"> 553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_u</span>
</span><span id="PDESolver-554"><a href="#PDESolver-554"><span class="linenos"> 554</span></a>        <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-555"><a href="#PDESolver-555"><span class="linenos"> 555</span></a>        <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_v</span> <span class="k">if</span> <span class="n">is_v</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_u</span>
</span><span id="PDESolver-556"><a href="#PDESolver-556"><span class="linenos"> 556</span></a>        <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-557"><a href="#PDESolver-557"><span class="linenos"> 557</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-558"><a href="#PDESolver-558"><span class="linenos"> 558</span></a>
</span><span id="PDESolver-559"><a href="#PDESolver-559"><span class="linenos"> 559</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
</span><span id="PDESolver-560"><a href="#PDESolver-560"><span class="linenos"> 560</span></a>              <span class="n">initial_condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PDESolver-561"><a href="#PDESolver-561"><span class="linenos"> 561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-562"><a href="#PDESolver-562"><span class="linenos"> 562</span></a><span class="sd">        Configure the spatial/temporal grid and initialize the solution field.</span>
</span><span id="PDESolver-563"><a href="#PDESolver-563"><span class="linenos"> 563</span></a><span class="sd">    </span>
</span><span id="PDESolver-564"><a href="#PDESolver-564"><span class="linenos"> 564</span></a><span class="sd">        This method sets up the computational domain, initializes spatial and temporal grids,</span>
</span><span id="PDESolver-565"><a href="#PDESolver-565"><span class="linenos"> 565</span></a><span class="sd">        applies boundary conditions, and prepares symbolic and numerical operators.</span>
</span><span id="PDESolver-566"><a href="#PDESolver-566"><span class="linenos"> 566</span></a><span class="sd">        It also performs essential analyses such as:</span>
</span><span id="PDESolver-567"><a href="#PDESolver-567"><span class="linenos"> 567</span></a><span class="sd">        </span>
</span><span id="PDESolver-568"><a href="#PDESolver-568"><span class="linenos"> 568</span></a><span class="sd">            - CFL condition verification (for stability)</span>
</span><span id="PDESolver-569"><a href="#PDESolver-569"><span class="linenos"> 569</span></a><span class="sd">            - Symbol analysis (e.g., dispersion relation, regularity)</span>
</span><span id="PDESolver-570"><a href="#PDESolver-570"><span class="linenos"> 570</span></a><span class="sd">            - Wave propagation analysis for second-order equations</span>
</span><span id="PDESolver-571"><a href="#PDESolver-571"><span class="linenos"> 571</span></a><span class="sd">    </span>
</span><span id="PDESolver-572"><a href="#PDESolver-572"><span class="linenos"> 572</span></a><span class="sd">        If pseudo-differential operators (ψOp) are present, symbolic analysis is skipped</span>
</span><span id="PDESolver-573"><a href="#PDESolver-573"><span class="linenos"> 573</span></a><span class="sd">        in favor of interactive exploration via `interactive_symbol_analysis`.</span>
</span><span id="PDESolver-574"><a href="#PDESolver-574"><span class="linenos"> 574</span></a><span class="sd">    </span>
</span><span id="PDESolver-575"><a href="#PDESolver-575"><span class="linenos"> 575</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-576"><a href="#PDESolver-576"><span class="linenos"> 576</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-577"><a href="#PDESolver-577"><span class="linenos"> 577</span></a><span class="sd">        Lx : float</span>
</span><span id="PDESolver-578"><a href="#PDESolver-578"><span class="linenos"> 578</span></a><span class="sd">            Size of the spatial domain along x-axis.</span>
</span><span id="PDESolver-579"><a href="#PDESolver-579"><span class="linenos"> 579</span></a><span class="sd">        Ly : float, optional</span>
</span><span id="PDESolver-580"><a href="#PDESolver-580"><span class="linenos"> 580</span></a><span class="sd">            Size of the spatial domain along y-axis (for 2D problems).</span>
</span><span id="PDESolver-581"><a href="#PDESolver-581"><span class="linenos"> 581</span></a><span class="sd">        Nx : int</span>
</span><span id="PDESolver-582"><a href="#PDESolver-582"><span class="linenos"> 582</span></a><span class="sd">            Number of spatial points along x-axis.</span>
</span><span id="PDESolver-583"><a href="#PDESolver-583"><span class="linenos"> 583</span></a><span class="sd">        Ny : int, optional</span>
</span><span id="PDESolver-584"><a href="#PDESolver-584"><span class="linenos"> 584</span></a><span class="sd">            Number of spatial points along y-axis (for 2D problems).</span>
</span><span id="PDESolver-585"><a href="#PDESolver-585"><span class="linenos"> 585</span></a><span class="sd">        Lt : float, default=1.0</span>
</span><span id="PDESolver-586"><a href="#PDESolver-586"><span class="linenos"> 586</span></a><span class="sd">            Total simulation time.</span>
</span><span id="PDESolver-587"><a href="#PDESolver-587"><span class="linenos"> 587</span></a><span class="sd">        Nt : int, default=100</span>
</span><span id="PDESolver-588"><a href="#PDESolver-588"><span class="linenos"> 588</span></a><span class="sd">            Number of time steps.</span>
</span><span id="PDESolver-589"><a href="#PDESolver-589"><span class="linenos"> 589</span></a><span class="sd">        initial_condition : callable</span>
</span><span id="PDESolver-590"><a href="#PDESolver-590"><span class="linenos"> 590</span></a><span class="sd">            Function returning the initial state u(x, 0) or u(x, y, 0).</span>
</span><span id="PDESolver-591"><a href="#PDESolver-591"><span class="linenos"> 591</span></a><span class="sd">        initial_velocity : callable, optional</span>
</span><span id="PDESolver-592"><a href="#PDESolver-592"><span class="linenos"> 592</span></a><span class="sd">            Function returning the initial time derivative ∂ₜu(x, 0) or ∂ₜu(x, y, 0),</span>
</span><span id="PDESolver-593"><a href="#PDESolver-593"><span class="linenos"> 593</span></a><span class="sd">            required for second-order equations.</span>
</span><span id="PDESolver-594"><a href="#PDESolver-594"><span class="linenos"> 594</span></a><span class="sd">        n_frames : int, default=100</span>
</span><span id="PDESolver-595"><a href="#PDESolver-595"><span class="linenos"> 595</span></a><span class="sd">            Number of time frames to store during simulation for visualization or output.</span>
</span><span id="PDESolver-596"><a href="#PDESolver-596"><span class="linenos"> 596</span></a><span class="sd">    </span>
</span><span id="PDESolver-597"><a href="#PDESolver-597"><span class="linenos"> 597</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-598"><a href="#PDESolver-598"><span class="linenos"> 598</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-599"><a href="#PDESolver-599"><span class="linenos"> 599</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver-600"><a href="#PDESolver-600"><span class="linenos"> 600</span></a><span class="sd">            If mandatory parameters are missing (e.g., Nx not given in 1D, Ly/Ny not given in 2D).</span>
</span><span id="PDESolver-601"><a href="#PDESolver-601"><span class="linenos"> 601</span></a><span class="sd">    </span>
</span><span id="PDESolver-602"><a href="#PDESolver-602"><span class="linenos"> 602</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-603"><a href="#PDESolver-603"><span class="linenos"> 603</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-604"><a href="#PDESolver-604"><span class="linenos"> 604</span></a><span class="sd">        - The spatial discretization assumes periodic boundary conditions by default.</span>
</span><span id="PDESolver-605"><a href="#PDESolver-605"><span class="linenos"> 605</span></a><span class="sd">        - Fourier transforms are computed using real-to-complex FFTs (`scipy.fft.fft`, `fft2`).</span>
</span><span id="PDESolver-606"><a href="#PDESolver-606"><span class="linenos"> 606</span></a><span class="sd">        - Frequency arrays (`KX`, `KY`) are defined following standard spectral conventions.</span>
</span><span id="PDESolver-607"><a href="#PDESolver-607"><span class="linenos"> 607</span></a><span class="sd">        - Dealiasing is applied using a sharp cutoff filter at a fraction of the maximum frequency.</span>
</span><span id="PDESolver-608"><a href="#PDESolver-608"><span class="linenos"> 608</span></a><span class="sd">        - For second-order equations, initial acceleration is derived from the governing operator.</span>
</span><span id="PDESolver-609"><a href="#PDESolver-609"><span class="linenos"> 609</span></a><span class="sd">        - Symbolic analysis includes plotting of the symbol&#39;s real/imaginary/absolute values</span>
</span><span id="PDESolver-610"><a href="#PDESolver-610"><span class="linenos"> 610</span></a><span class="sd">          and dispersion relation.</span>
</span><span id="PDESolver-611"><a href="#PDESolver-611"><span class="linenos"> 611</span></a><span class="sd">    </span>
</span><span id="PDESolver-612"><a href="#PDESolver-612"><span class="linenos"> 612</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-613"><a href="#PDESolver-613"><span class="linenos"> 613</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-614"><a href="#PDESolver-614"><span class="linenos"> 614</span></a><span class="sd">        setup_1D : Sets up internal variables for one-dimensional problems.</span>
</span><span id="PDESolver-615"><a href="#PDESolver-615"><span class="linenos"> 615</span></a><span class="sd">        setup_2D : Sets up internal variables for two-dimensional problems.</span>
</span><span id="PDESolver-616"><a href="#PDESolver-616"><span class="linenos"> 616</span></a><span class="sd">        initialize_conditions : Applies initial data and enforces compatibility.</span>
</span><span id="PDESolver-617"><a href="#PDESolver-617"><span class="linenos"> 617</span></a><span class="sd">        check_cfl_condition : Verifies time step against stability constraints.</span>
</span><span id="PDESolver-618"><a href="#PDESolver-618"><span class="linenos"> 618</span></a><span class="sd">        plot_symbol : Visualizes the linear operator’s symbol in frequency space.</span>
</span><span id="PDESolver-619"><a href="#PDESolver-619"><span class="linenos"> 619</span></a><span class="sd">        analyze_wave_propagation : Analyzes group velocity.</span>
</span><span id="PDESolver-620"><a href="#PDESolver-620"><span class="linenos"> 620</span></a><span class="sd">        interactive_symbol_analysis : Interactive tools for ψOp-based equations.</span>
</span><span id="PDESolver-621"><a href="#PDESolver-621"><span class="linenos"> 621</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-622"><a href="#PDESolver-622"><span class="linenos"> 622</span></a>        
</span><span id="PDESolver-623"><a href="#PDESolver-623"><span class="linenos"> 623</span></a>        <span class="c1"># Temporal parameters</span>
</span><span id="PDESolver-624"><a href="#PDESolver-624"><span class="linenos"> 624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">Lt</span><span class="p">,</span> <span class="n">Nt</span>
</span><span id="PDESolver-625"><a href="#PDESolver-625"><span class="linenos"> 625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Lt</span> <span class="o">/</span> <span class="n">Nt</span>
</span><span id="PDESolver-626"><a href="#PDESolver-626"><span class="linenos"> 626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_frames</span>
</span><span id="PDESolver-627"><a href="#PDESolver-627"><span class="linenos"> 627</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-628"><a href="#PDESolver-628"><span class="linenos"> 628</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span> <span class="o">=</span> <span class="n">initial_condition</span>
</span><span id="PDESolver-629"><a href="#PDESolver-629"><span class="linenos"> 629</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">=</span> <span class="n">boundary_condition</span>
</span><span id="PDESolver-630"><a href="#PDESolver-630"><span class="linenos"> 630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
</span><span id="PDESolver-631"><a href="#PDESolver-631"><span class="linenos"> 631</span></a>
</span><span id="PDESolver-632"><a href="#PDESolver-632"><span class="linenos"> 632</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-633"><a href="#PDESolver-633"><span class="linenos"> 633</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PDESolver-634"><a href="#PDESolver-634"><span class="linenos"> 634</span></a>                <span class="s2">&quot;Dirichlet boundary conditions require the equation to be defined via a pseudo-differential operator (psiOp). &quot;</span>
</span><span id="PDESolver-635"><a href="#PDESolver-635"><span class="linenos"> 635</span></a>                <span class="s2">&quot;Please provide an equation involving psiOp for non-periodic boundary treatment.&quot;</span>
</span><span id="PDESolver-636"><a href="#PDESolver-636"><span class="linenos"> 636</span></a>            <span class="p">)</span>
</span><span id="PDESolver-637"><a href="#PDESolver-637"><span class="linenos"> 637</span></a>    
</span><span id="PDESolver-638"><a href="#PDESolver-638"><span class="linenos"> 638</span></a>        <span class="c1"># Dimension checks</span>
</span><span id="PDESolver-639"><a href="#PDESolver-639"><span class="linenos"> 639</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-640"><a href="#PDESolver-640"><span class="linenos"> 640</span></a>            <span class="k">if</span> <span class="n">Nx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-641"><a href="#PDESolver-641"><span class="linenos"> 641</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nx must be specified in 1D.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-642"><a href="#PDESolver-642"><span class="linenos"> 642</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_1D</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span>
</span><span id="PDESolver-643"><a href="#PDESolver-643"><span class="linenos"> 643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-644"><a href="#PDESolver-644"><span class="linenos"> 644</span></a>            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Ly</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
</span><span id="PDESolver-645"><a href="#PDESolver-645"><span class="linenos"> 645</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In 2D, Ly and Ny must be provided.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-646"><a href="#PDESolver-646"><span class="linenos"> 646</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_2D</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
</span><span id="PDESolver-647"><a href="#PDESolver-647"><span class="linenos"> 647</span></a>    
</span><span id="PDESolver-648"><a href="#PDESolver-648"><span class="linenos"> 648</span></a>        <span class="c1"># Initialization of solution and velocities</span>
</span><span id="PDESolver-649"><a href="#PDESolver-649"><span class="linenos"> 649</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver-650"><a href="#PDESolver-650"><span class="linenos"> 650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_conditions</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">initial_velocity</span><span class="p">)</span>
</span><span id="PDESolver-651"><a href="#PDESolver-651"><span class="linenos"> 651</span></a>            
</span><span id="PDESolver-652"><a href="#PDESolver-652"><span class="linenos"> 652</span></a>        <span class="c1"># Symbol analysis if present</span>
</span><span id="PDESolver-653"><a href="#PDESolver-653"><span class="linenos"> 653</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-654"><a href="#PDESolver-654"><span class="linenos"> 654</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ For psiOp, use interactive_symbol_analysis.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-655"><a href="#PDESolver-655"><span class="linenos"> 655</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-656"><a href="#PDESolver-656"><span class="linenos"> 656</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_symbolic</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver-657"><a href="#PDESolver-657"><span class="linenos"> 657</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Linear operator is null.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-658"><a href="#PDESolver-658"><span class="linenos"> 658</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-659"><a href="#PDESolver-659"><span class="linenos"> 659</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_check_cfl_condition</span><span class="p">()</span>
</span><span id="PDESolver-660"><a href="#PDESolver-660"><span class="linenos"> 660</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_check_symbol_conditions</span><span class="p">()</span>
</span><span id="PDESolver-661"><a href="#PDESolver-661"><span class="linenos"> 661</span></a>                <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="PDESolver-662"><a href="#PDESolver-662"><span class="linenos"> 662</span></a>                	<span class="bp">self</span><span class="o">.</span><span class="n">_plot_symbol</span><span class="p">()</span>
</span><span id="PDESolver-663"><a href="#PDESolver-663"><span class="linenos"> 663</span></a>                	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-664"><a href="#PDESolver-664"><span class="linenos"> 664</span></a>                		<span class="bp">self</span><span class="o">.</span><span class="n">_analyze_wave_propagation</span><span class="p">()</span>
</span><span id="PDESolver-665"><a href="#PDESolver-665"><span class="linenos"> 665</span></a>
</span><span id="PDESolver-666"><a href="#PDESolver-666"><span class="linenos"> 666</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
</span><span id="PDESolver-667"><a href="#PDESolver-667"><span class="linenos"> 667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-668"><a href="#PDESolver-668"><span class="linenos"> 668</span></a><span class="sd">        Configure internal variables for one-dimensional (1D) problems.</span>
</span><span id="PDESolver-669"><a href="#PDESolver-669"><span class="linenos"> 669</span></a><span class="sd">    </span>
</span><span id="PDESolver-670"><a href="#PDESolver-670"><span class="linenos"> 670</span></a><span class="sd">        This private method initializes spatial and frequency grids, applies dealiasing,</span>
</span><span id="PDESolver-671"><a href="#PDESolver-671"><span class="linenos"> 671</span></a><span class="sd">        and prepares either pseudo-differential symbols or linear operators for use in time evolution.</span>
</span><span id="PDESolver-672"><a href="#PDESolver-672"><span class="linenos"> 672</span></a><span class="sd">        </span>
</span><span id="PDESolver-673"><a href="#PDESolver-673"><span class="linenos"> 673</span></a><span class="sd">        It assumes periodic boundary conditions and uses real-to-complex FFT conventions.</span>
</span><span id="PDESolver-674"><a href="#PDESolver-674"><span class="linenos"> 674</span></a><span class="sd">        The spatial domain is centered at zero: [-Lx/2, Lx/2].</span>
</span><span id="PDESolver-675"><a href="#PDESolver-675"><span class="linenos"> 675</span></a><span class="sd">    </span>
</span><span id="PDESolver-676"><a href="#PDESolver-676"><span class="linenos"> 676</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-677"><a href="#PDESolver-677"><span class="linenos"> 677</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-678"><a href="#PDESolver-678"><span class="linenos"> 678</span></a><span class="sd">        Lx : float</span>
</span><span id="PDESolver-679"><a href="#PDESolver-679"><span class="linenos"> 679</span></a><span class="sd">            Physical size of the spatial domain along the x-axis.</span>
</span><span id="PDESolver-680"><a href="#PDESolver-680"><span class="linenos"> 680</span></a><span class="sd">        Nx : int</span>
</span><span id="PDESolver-681"><a href="#PDESolver-681"><span class="linenos"> 681</span></a><span class="sd">            Number of grid points in the x-direction.</span>
</span><span id="PDESolver-682"><a href="#PDESolver-682"><span class="linenos"> 682</span></a><span class="sd">    </span>
</span><span id="PDESolver-683"><a href="#PDESolver-683"><span class="linenos"> 683</span></a><span class="sd">        Attributes Set</span>
</span><span id="PDESolver-684"><a href="#PDESolver-684"><span class="linenos"> 684</span></a><span class="sd">        --------------</span>
</span><span id="PDESolver-685"><a href="#PDESolver-685"><span class="linenos"> 685</span></a><span class="sd">        - self.Lx : float</span>
</span><span id="PDESolver-686"><a href="#PDESolver-686"><span class="linenos"> 686</span></a><span class="sd">            Size of the spatial domain.</span>
</span><span id="PDESolver-687"><a href="#PDESolver-687"><span class="linenos"> 687</span></a><span class="sd">        - self.Nx : int</span>
</span><span id="PDESolver-688"><a href="#PDESolver-688"><span class="linenos"> 688</span></a><span class="sd">            Number of spatial points.</span>
</span><span id="PDESolver-689"><a href="#PDESolver-689"><span class="linenos"> 689</span></a><span class="sd">        - self.x_grid : np.ndarray</span>
</span><span id="PDESolver-690"><a href="#PDESolver-690"><span class="linenos"> 690</span></a><span class="sd">            1D array of spatial coordinates.</span>
</span><span id="PDESolver-691"><a href="#PDESolver-691"><span class="linenos"> 691</span></a><span class="sd">        - self.X : np.ndarray</span>
</span><span id="PDESolver-692"><a href="#PDESolver-692"><span class="linenos"> 692</span></a><span class="sd">            Alias to `self.x_grid`, used in physical space computations.</span>
</span><span id="PDESolver-693"><a href="#PDESolver-693"><span class="linenos"> 693</span></a><span class="sd">        - self.kx : np.ndarray</span>
</span><span id="PDESolver-694"><a href="#PDESolver-694"><span class="linenos"> 694</span></a><span class="sd">            Array of wavenumbers corresponding to the Fourier transform.</span>
</span><span id="PDESolver-695"><a href="#PDESolver-695"><span class="linenos"> 695</span></a><span class="sd">        - self.KX : np.ndarray</span>
</span><span id="PDESolver-696"><a href="#PDESolver-696"><span class="linenos"> 696</span></a><span class="sd">            Alias to `self.kx`, used in frequency space computations.</span>
</span><span id="PDESolver-697"><a href="#PDESolver-697"><span class="linenos"> 697</span></a><span class="sd">        - self.dealiasing_mask : np.ndarray</span>
</span><span id="PDESolver-698"><a href="#PDESolver-698"><span class="linenos"> 698</span></a><span class="sd">            Boolean mask used to suppress aliased frequencies during nonlinear calculations.</span>
</span><span id="PDESolver-699"><a href="#PDESolver-699"><span class="linenos"> 699</span></a><span class="sd">        - self.exp_L : np.ndarray</span>
</span><span id="PDESolver-700"><a href="#PDESolver-700"><span class="linenos"> 700</span></a><span class="sd">            Exponential of the linear operator scaled by time step: exp(L(k) · dt).</span>
</span><span id="PDESolver-701"><a href="#PDESolver-701"><span class="linenos"> 701</span></a><span class="sd">        - self.omega_val : np.ndarray</span>
</span><span id="PDESolver-702"><a href="#PDESolver-702"><span class="linenos"> 702</span></a><span class="sd">            Frequency values ω(k) = Re[√(L(k))] used in second-order time stepping.</span>
</span><span id="PDESolver-703"><a href="#PDESolver-703"><span class="linenos"> 703</span></a><span class="sd">        - self.cos_omega_dt, self.sin_omega_dt : np.ndarray</span>
</span><span id="PDESolver-704"><a href="#PDESolver-704"><span class="linenos"> 704</span></a><span class="sd">            Cosine and sine of ω(k)·dt for dispersive propagation.</span>
</span><span id="PDESolver-705"><a href="#PDESolver-705"><span class="linenos"> 705</span></a><span class="sd">        - self.inv_omega : np.ndarray</span>
</span><span id="PDESolver-706"><a href="#PDESolver-706"><span class="linenos"> 706</span></a><span class="sd">            Inverse of ω(k), used to avoid division-by-zero in time stepping.</span>
</span><span id="PDESolver-707"><a href="#PDESolver-707"><span class="linenos"> 707</span></a><span class="sd">    </span>
</span><span id="PDESolver-708"><a href="#PDESolver-708"><span class="linenos"> 708</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-709"><a href="#PDESolver-709"><span class="linenos"> 709</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-710"><a href="#PDESolver-710"><span class="linenos"> 710</span></a><span class="sd">        - Frequencies are computed using `scipy.fft.fftfreq` and then shifted to center zero frequency.</span>
</span><span id="PDESolver-711"><a href="#PDESolver-711"><span class="linenos"> 711</span></a><span class="sd">        - Dealiasing is applied using a sharp cutoff filter based on `self.dealiasing_ratio`.</span>
</span><span id="PDESolver-712"><a href="#PDESolver-712"><span class="linenos"> 712</span></a><span class="sd">        - If pseudo-differential operators (ψOp) are present, symbolic tables are precomputed via `prepare_symbol_tables`.</span>
</span><span id="PDESolver-713"><a href="#PDESolver-713"><span class="linenos"> 713</span></a><span class="sd">        - For second-order equations, the dispersion relation ω(k) is extracted from the linear operator L(k).</span>
</span><span id="PDESolver-714"><a href="#PDESolver-714"><span class="linenos"> 714</span></a><span class="sd">    </span>
</span><span id="PDESolver-715"><a href="#PDESolver-715"><span class="linenos"> 715</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-716"><a href="#PDESolver-716"><span class="linenos"> 716</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-717"><a href="#PDESolver-717"><span class="linenos"> 717</span></a><span class="sd">        setup_2D : Equivalent setup for two-dimensional problems.</span>
</span><span id="PDESolver-718"><a href="#PDESolver-718"><span class="linenos"> 718</span></a><span class="sd">        prepare_symbol_tables : Precomputes symbolic arrays for ψOp evaluation.</span>
</span><span id="PDESolver-719"><a href="#PDESolver-719"><span class="linenos"> 719</span></a><span class="sd">        setup_omega_terms : Sets up terms involving ω(k) for second-order evolution.</span>
</span><span id="PDESolver-720"><a href="#PDESolver-720"><span class="linenos"> 720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-721"><a href="#PDESolver-721"><span class="linenos"> 721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">=</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Nx</span>
</span><span id="PDESolver-722"><a href="#PDESolver-722"><span class="linenos"> 722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-723"><a href="#PDESolver-723"><span class="linenos"> 723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span>
</span><span id="PDESolver-724"><a href="#PDESolver-724"><span class="linenos"> 724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">Lx</span> <span class="o">/</span> <span class="n">Nx</span><span class="p">)</span>
</span><span id="PDESolver-725"><a href="#PDESolver-725"><span class="linenos"> 725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span>
</span><span id="PDESolver-726"><a href="#PDESolver-726"><span class="linenos"> 726</span></a>    
</span><span id="PDESolver-727"><a href="#PDESolver-727"><span class="linenos"> 727</span></a>        <span class="c1"># Dealiasing mask</span>
</span><span id="PDESolver-728"><a href="#PDESolver-728"><span class="linenos"> 728</span></a>        <span class="n">k_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_ratio</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">))</span>
</span><span id="PDESolver-729"><a href="#PDESolver-729"><span class="linenos"> 729</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">k_max</span><span class="p">)</span>
</span><span id="PDESolver-730"><a href="#PDESolver-730"><span class="linenos"> 730</span></a>    
</span><span id="PDESolver-731"><a href="#PDESolver-731"><span class="linenos"> 731</span></a>        <span class="c1"># Preparation of symbol or linear operator</span>
</span><span id="PDESolver-732"><a href="#PDESolver-732"><span class="linenos"> 732</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-733"><a href="#PDESolver-733"><span class="linenos"> 733</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_symbol_tables</span><span class="p">()</span>
</span><span id="PDESolver-734"><a href="#PDESolver-734"><span class="linenos"> 734</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-735"><a href="#PDESolver-735"><span class="linenos"> 735</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-736"><a href="#PDESolver-736"><span class="linenos"> 736</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exp_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">L_vals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver-737"><a href="#PDESolver-737"><span class="linenos"> 737</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-738"><a href="#PDESolver-738"><span class="linenos"> 738</span></a>                <span class="n">omega_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span>
</span><span id="PDESolver-739"><a href="#PDESolver-739"><span class="linenos"> 739</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_omega_terms</span><span class="p">(</span><span class="n">omega_val</span><span class="p">)</span>
</span><span id="PDESolver-740"><a href="#PDESolver-740"><span class="linenos"> 740</span></a>    
</span><span id="PDESolver-741"><a href="#PDESolver-741"><span class="linenos"> 741</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
</span><span id="PDESolver-742"><a href="#PDESolver-742"><span class="linenos"> 742</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-743"><a href="#PDESolver-743"><span class="linenos"> 743</span></a><span class="sd">        Configure internal variables for two-dimensional (2D) problems.</span>
</span><span id="PDESolver-744"><a href="#PDESolver-744"><span class="linenos"> 744</span></a><span class="sd">    </span>
</span><span id="PDESolver-745"><a href="#PDESolver-745"><span class="linenos"> 745</span></a><span class="sd">        This private method initializes spatial and frequency grids, applies dealiasing,</span>
</span><span id="PDESolver-746"><a href="#PDESolver-746"><span class="linenos"> 746</span></a><span class="sd">        and prepares either pseudo-differential symbols or linear operators for use in time evolution.</span>
</span><span id="PDESolver-747"><a href="#PDESolver-747"><span class="linenos"> 747</span></a><span class="sd">        </span>
</span><span id="PDESolver-748"><a href="#PDESolver-748"><span class="linenos"> 748</span></a><span class="sd">        It assumes periodic boundary conditions and uses real-to-complex FFT conventions.</span>
</span><span id="PDESolver-749"><a href="#PDESolver-749"><span class="linenos"> 749</span></a><span class="sd">        The spatial domain is centered at zero: [-Lx/2, Lx/2] × [-Ly/2, Ly/2].</span>
</span><span id="PDESolver-750"><a href="#PDESolver-750"><span class="linenos"> 750</span></a><span class="sd">    </span>
</span><span id="PDESolver-751"><a href="#PDESolver-751"><span class="linenos"> 751</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-752"><a href="#PDESolver-752"><span class="linenos"> 752</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-753"><a href="#PDESolver-753"><span class="linenos"> 753</span></a><span class="sd">        Lx : float</span>
</span><span id="PDESolver-754"><a href="#PDESolver-754"><span class="linenos"> 754</span></a><span class="sd">            Physical size of the spatial domain along the x-axis.</span>
</span><span id="PDESolver-755"><a href="#PDESolver-755"><span class="linenos"> 755</span></a><span class="sd">        Ly : float</span>
</span><span id="PDESolver-756"><a href="#PDESolver-756"><span class="linenos"> 756</span></a><span class="sd">            Physical size of the spatial domain along the y-axis.</span>
</span><span id="PDESolver-757"><a href="#PDESolver-757"><span class="linenos"> 757</span></a><span class="sd">        Nx : int</span>
</span><span id="PDESolver-758"><a href="#PDESolver-758"><span class="linenos"> 758</span></a><span class="sd">            Number of grid points along the x-direction.</span>
</span><span id="PDESolver-759"><a href="#PDESolver-759"><span class="linenos"> 759</span></a><span class="sd">        Ny : int</span>
</span><span id="PDESolver-760"><a href="#PDESolver-760"><span class="linenos"> 760</span></a><span class="sd">            Number of grid points along the y-direction.</span>
</span><span id="PDESolver-761"><a href="#PDESolver-761"><span class="linenos"> 761</span></a><span class="sd">    </span>
</span><span id="PDESolver-762"><a href="#PDESolver-762"><span class="linenos"> 762</span></a><span class="sd">        Attributes Set</span>
</span><span id="PDESolver-763"><a href="#PDESolver-763"><span class="linenos"> 763</span></a><span class="sd">        --------------</span>
</span><span id="PDESolver-764"><a href="#PDESolver-764"><span class="linenos"> 764</span></a><span class="sd">        - self.Lx, self.Ly : float</span>
</span><span id="PDESolver-765"><a href="#PDESolver-765"><span class="linenos"> 765</span></a><span class="sd">            Size of the spatial domain in each direction.</span>
</span><span id="PDESolver-766"><a href="#PDESolver-766"><span class="linenos"> 766</span></a><span class="sd">        - self.Nx, self.Ny : int</span>
</span><span id="PDESolver-767"><a href="#PDESolver-767"><span class="linenos"> 767</span></a><span class="sd">            Number of spatial points in each direction.</span>
</span><span id="PDESolver-768"><a href="#PDESolver-768"><span class="linenos"> 768</span></a><span class="sd">        - self.x_grid, self.y_grid : np.ndarray</span>
</span><span id="PDESolver-769"><a href="#PDESolver-769"><span class="linenos"> 769</span></a><span class="sd">            1D arrays of spatial coordinates in x and y directions.</span>
</span><span id="PDESolver-770"><a href="#PDESolver-770"><span class="linenos"> 770</span></a><span class="sd">        - self.X, self.Y : np.ndarray</span>
</span><span id="PDESolver-771"><a href="#PDESolver-771"><span class="linenos"> 771</span></a><span class="sd">            2D meshgrids of spatial coordinates for physical space computations.</span>
</span><span id="PDESolver-772"><a href="#PDESolver-772"><span class="linenos"> 772</span></a><span class="sd">        - self.kx, self.ky : np.ndarray</span>
</span><span id="PDESolver-773"><a href="#PDESolver-773"><span class="linenos"> 773</span></a><span class="sd">            Arrays of wavenumbers corresponding to Fourier transforms in x and y directions.</span>
</span><span id="PDESolver-774"><a href="#PDESolver-774"><span class="linenos"> 774</span></a><span class="sd">        - self.KX, self.KY : np.ndarray</span>
</span><span id="PDESolver-775"><a href="#PDESolver-775"><span class="linenos"> 775</span></a><span class="sd">            Meshgrids of wavenumbers used in frequency space computations.</span>
</span><span id="PDESolver-776"><a href="#PDESolver-776"><span class="linenos"> 776</span></a><span class="sd">        - self.dealiasing_mask : np.ndarray</span>
</span><span id="PDESolver-777"><a href="#PDESolver-777"><span class="linenos"> 777</span></a><span class="sd">            Boolean mask used to suppress aliased frequencies during nonlinear calculations.</span>
</span><span id="PDESolver-778"><a href="#PDESolver-778"><span class="linenos"> 778</span></a><span class="sd">        - self.exp_L : np.ndarray</span>
</span><span id="PDESolver-779"><a href="#PDESolver-779"><span class="linenos"> 779</span></a><span class="sd">            Exponential of the linear operator scaled by time step: exp(L(kx, ky) · dt).</span>
</span><span id="PDESolver-780"><a href="#PDESolver-780"><span class="linenos"> 780</span></a><span class="sd">        - self.omega_val : np.ndarray</span>
</span><span id="PDESolver-781"><a href="#PDESolver-781"><span class="linenos"> 781</span></a><span class="sd">            Frequency values ω(kx, ky) = Re[√(L(kx, ky))] used in second-order time stepping.</span>
</span><span id="PDESolver-782"><a href="#PDESolver-782"><span class="linenos"> 782</span></a><span class="sd">        - self.cos_omega_dt, self.sin_omega_dt : np.ndarray</span>
</span><span id="PDESolver-783"><a href="#PDESolver-783"><span class="linenos"> 783</span></a><span class="sd">            Cosine and sine of ω(kx, ky)·dt for dispersive propagation.</span>
</span><span id="PDESolver-784"><a href="#PDESolver-784"><span class="linenos"> 784</span></a><span class="sd">        - self.inv_omega : np.ndarray</span>
</span><span id="PDESolver-785"><a href="#PDESolver-785"><span class="linenos"> 785</span></a><span class="sd">            Inverse of ω(kx, ky), used to avoid division-by-zero in time stepping.</span>
</span><span id="PDESolver-786"><a href="#PDESolver-786"><span class="linenos"> 786</span></a><span class="sd">    </span>
</span><span id="PDESolver-787"><a href="#PDESolver-787"><span class="linenos"> 787</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-788"><a href="#PDESolver-788"><span class="linenos"> 788</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-789"><a href="#PDESolver-789"><span class="linenos"> 789</span></a><span class="sd">        - Frequencies are computed using `scipy.fft.fftfreq` and then shifted to center zero frequency.</span>
</span><span id="PDESolver-790"><a href="#PDESolver-790"><span class="linenos"> 790</span></a><span class="sd">        - Dealiasing is applied using a sharp cutoff filter based on `self.dealiasing_ratio`.</span>
</span><span id="PDESolver-791"><a href="#PDESolver-791"><span class="linenos"> 791</span></a><span class="sd">        - If pseudo-differential operators (ψOp) are present, symbolic tables are precomputed via `prepare_symbol_tables`.</span>
</span><span id="PDESolver-792"><a href="#PDESolver-792"><span class="linenos"> 792</span></a><span class="sd">        - For second-order equations, the dispersion relation ω(kx, ky) is extracted from the linear operator L(kx, ky).</span>
</span><span id="PDESolver-793"><a href="#PDESolver-793"><span class="linenos"> 793</span></a><span class="sd">    </span>
</span><span id="PDESolver-794"><a href="#PDESolver-794"><span class="linenos"> 794</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-795"><a href="#PDESolver-795"><span class="linenos"> 795</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-796"><a href="#PDESolver-796"><span class="linenos"> 796</span></a><span class="sd">        setup_1D : Equivalent setup for one-dimensional problems.</span>
</span><span id="PDESolver-797"><a href="#PDESolver-797"><span class="linenos"> 797</span></a><span class="sd">        prepare_symbol_tables : Precomputes symbolic arrays for ψOp evaluation.</span>
</span><span id="PDESolver-798"><a href="#PDESolver-798"><span class="linenos"> 798</span></a><span class="sd">        setup_omega_terms : Sets up terms involving ω(kx, ky) for second-order evolution.</span>
</span><span id="PDESolver-799"><a href="#PDESolver-799"><span class="linenos"> 799</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-800"><a href="#PDESolver-800"><span class="linenos"> 800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span> <span class="o">=</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span>
</span><span id="PDESolver-801"><a href="#PDESolver-801"><span class="linenos"> 801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">=</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span>
</span><span id="PDESolver-802"><a href="#PDESolver-802"><span class="linenos"> 802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-803"><a href="#PDESolver-803"><span class="linenos"> 803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ly</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-804"><a href="#PDESolver-804"><span class="linenos"> 804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PDESolver-805"><a href="#PDESolver-805"><span class="linenos"> 805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">Lx</span> <span class="o">/</span> <span class="n">Nx</span><span class="p">)</span>
</span><span id="PDESolver-806"><a href="#PDESolver-806"><span class="linenos"> 806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ky</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">Ny</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">Ly</span> <span class="o">/</span> <span class="n">Ny</span><span class="p">)</span>
</span><span id="PDESolver-807"><a href="#PDESolver-807"><span class="linenos"> 807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="PDESolver-808"><a href="#PDESolver-808"><span class="linenos"> 808</span></a>    
</span><span id="PDESolver-809"><a href="#PDESolver-809"><span class="linenos"> 809</span></a>        <span class="c1"># Dealiasing mask</span>
</span><span id="PDESolver-810"><a href="#PDESolver-810"><span class="linenos"> 810</span></a>        <span class="n">kx_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_ratio</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">))</span>
</span><span id="PDESolver-811"><a href="#PDESolver-811"><span class="linenos"> 811</span></a>        <span class="n">ky_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_ratio</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">))</span>
</span><span id="PDESolver-812"><a href="#PDESolver-812"><span class="linenos"> 812</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">kx_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ky_max</span><span class="p">)</span>
</span><span id="PDESolver-813"><a href="#PDESolver-813"><span class="linenos"> 813</span></a>    
</span><span id="PDESolver-814"><a href="#PDESolver-814"><span class="linenos"> 814</span></a>        <span class="c1"># Preparation of symbol or linear operator</span>
</span><span id="PDESolver-815"><a href="#PDESolver-815"><span class="linenos"> 815</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-816"><a href="#PDESolver-816"><span class="linenos"> 816</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_symbol_tables</span><span class="p">()</span>
</span><span id="PDESolver-817"><a href="#PDESolver-817"><span class="linenos"> 817</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-818"><a href="#PDESolver-818"><span class="linenos"> 818</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-819"><a href="#PDESolver-819"><span class="linenos"> 819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exp_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">L_vals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver-820"><a href="#PDESolver-820"><span class="linenos"> 820</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-821"><a href="#PDESolver-821"><span class="linenos"> 821</span></a>                <span class="n">omega_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-822"><a href="#PDESolver-822"><span class="linenos"> 822</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_omega_terms</span><span class="p">(</span><span class="n">omega_val</span><span class="p">)</span>
</span><span id="PDESolver-823"><a href="#PDESolver-823"><span class="linenos"> 823</span></a>    
</span><span id="PDESolver-824"><a href="#PDESolver-824"><span class="linenos"> 824</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_omega_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omega_val</span><span class="p">):</span>
</span><span id="PDESolver-825"><a href="#PDESolver-825"><span class="linenos"> 825</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-826"><a href="#PDESolver-826"><span class="linenos"> 826</span></a><span class="sd">        Initialize terms derived from the angular frequency ω for time evolution.</span>
</span><span id="PDESolver-827"><a href="#PDESolver-827"><span class="linenos"> 827</span></a><span class="sd">    </span>
</span><span id="PDESolver-828"><a href="#PDESolver-828"><span class="linenos"> 828</span></a><span class="sd">        This private method precomputes and stores key trigonometric and inverse quantities</span>
</span><span id="PDESolver-829"><a href="#PDESolver-829"><span class="linenos"> 829</span></a><span class="sd">        based on the dispersion relation ω(k), used in second-order time integration schemes.</span>
</span><span id="PDESolver-830"><a href="#PDESolver-830"><span class="linenos"> 830</span></a><span class="sd">        </span>
</span><span id="PDESolver-831"><a href="#PDESolver-831"><span class="linenos"> 831</span></a><span class="sd">        These values are essential for solving wave-like equations with dispersive behavior:</span>
</span><span id="PDESolver-832"><a href="#PDESolver-832"><span class="linenos"> 832</span></a><span class="sd">            cos(ω·dt), sin(ω·dt), 1/ω</span>
</span><span id="PDESolver-833"><a href="#PDESolver-833"><span class="linenos"> 833</span></a><span class="sd">        </span>
</span><span id="PDESolver-834"><a href="#PDESolver-834"><span class="linenos"> 834</span></a><span class="sd">        The inverse frequency is computed safely to avoid division by zero.</span>
</span><span id="PDESolver-835"><a href="#PDESolver-835"><span class="linenos"> 835</span></a><span class="sd">    </span>
</span><span id="PDESolver-836"><a href="#PDESolver-836"><span class="linenos"> 836</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-837"><a href="#PDESolver-837"><span class="linenos"> 837</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-838"><a href="#PDESolver-838"><span class="linenos"> 838</span></a><span class="sd">        omega_val : np.ndarray</span>
</span><span id="PDESolver-839"><a href="#PDESolver-839"><span class="linenos"> 839</span></a><span class="sd">            Array of angular frequency values ω(k) evaluated at discrete wavenumbers.</span>
</span><span id="PDESolver-840"><a href="#PDESolver-840"><span class="linenos"> 840</span></a><span class="sd">            Can be one-dimensional (1D) or two-dimensional (2D) depending on spatial dimension.</span>
</span><span id="PDESolver-841"><a href="#PDESolver-841"><span class="linenos"> 841</span></a><span class="sd">    </span>
</span><span id="PDESolver-842"><a href="#PDESolver-842"><span class="linenos"> 842</span></a><span class="sd">        Attributes Set</span>
</span><span id="PDESolver-843"><a href="#PDESolver-843"><span class="linenos"> 843</span></a><span class="sd">        --------------</span>
</span><span id="PDESolver-844"><a href="#PDESolver-844"><span class="linenos"> 844</span></a><span class="sd">        - self.omega_val : np.ndarray</span>
</span><span id="PDESolver-845"><a href="#PDESolver-845"><span class="linenos"> 845</span></a><span class="sd">            Copy of the input angular frequency array.</span>
</span><span id="PDESolver-846"><a href="#PDESolver-846"><span class="linenos"> 846</span></a><span class="sd">        - self.cos_omega_dt : np.ndarray</span>
</span><span id="PDESolver-847"><a href="#PDESolver-847"><span class="linenos"> 847</span></a><span class="sd">            Cosine of ω(k) multiplied by time step: cos(ω(k) · dt).</span>
</span><span id="PDESolver-848"><a href="#PDESolver-848"><span class="linenos"> 848</span></a><span class="sd">        - self.sin_omega_dt : np.ndarray</span>
</span><span id="PDESolver-849"><a href="#PDESolver-849"><span class="linenos"> 849</span></a><span class="sd">            Sine of ω(k) multiplied by time step: sin(ω(k) · dt).</span>
</span><span id="PDESolver-850"><a href="#PDESolver-850"><span class="linenos"> 850</span></a><span class="sd">        - self.inv_omega : np.ndarray</span>
</span><span id="PDESolver-851"><a href="#PDESolver-851"><span class="linenos"> 851</span></a><span class="sd">            Inverse of ω(k), with zeros where ω(k) == 0 to avoid division by zero.</span>
</span><span id="PDESolver-852"><a href="#PDESolver-852"><span class="linenos"> 852</span></a><span class="sd">    </span>
</span><span id="PDESolver-853"><a href="#PDESolver-853"><span class="linenos"> 853</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-854"><a href="#PDESolver-854"><span class="linenos"> 854</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-855"><a href="#PDESolver-855"><span class="linenos"> 855</span></a><span class="sd">        - This method is typically called during setup when solving second-order PDEs</span>
</span><span id="PDESolver-856"><a href="#PDESolver-856"><span class="linenos"> 856</span></a><span class="sd">          involving dispersive waves (e.g., Klein-Gordon, Schrödinger, or water wave equations).</span>
</span><span id="PDESolver-857"><a href="#PDESolver-857"><span class="linenos"> 857</span></a><span class="sd">        - The safe computation of 1/ω ensures numerical stability even when low frequencies are present.</span>
</span><span id="PDESolver-858"><a href="#PDESolver-858"><span class="linenos"> 858</span></a><span class="sd">        - These precomputed arrays are used in spectral propagators for accurate time stepping.</span>
</span><span id="PDESolver-859"><a href="#PDESolver-859"><span class="linenos"> 859</span></a><span class="sd">    </span>
</span><span id="PDESolver-860"><a href="#PDESolver-860"><span class="linenos"> 860</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-861"><a href="#PDESolver-861"><span class="linenos"> 861</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-862"><a href="#PDESolver-862"><span class="linenos"> 862</span></a><span class="sd">        setup_1D : Sets up internal variables for one-dimensional problems.</span>
</span><span id="PDESolver-863"><a href="#PDESolver-863"><span class="linenos"> 863</span></a><span class="sd">        setup_2D : Sets up internal variables for two-dimensional problems.</span>
</span><span id="PDESolver-864"><a href="#PDESolver-864"><span class="linenos"> 864</span></a><span class="sd">        solve : Time integration using the computed frequency terms.</span>
</span><span id="PDESolver-865"><a href="#PDESolver-865"><span class="linenos"> 865</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-866"><a href="#PDESolver-866"><span class="linenos"> 866</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">omega_val</span> <span class="o">=</span> <span class="n">omega_val</span>
</span><span id="PDESolver-867"><a href="#PDESolver-867"><span class="linenos"> 867</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cos_omega_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega_val</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver-868"><a href="#PDESolver-868"><span class="linenos"> 868</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sin_omega_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega_val</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver-869"><a href="#PDESolver-869"><span class="linenos"> 869</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inv_omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">omega_val</span><span class="p">)</span>
</span><span id="PDESolver-870"><a href="#PDESolver-870"><span class="linenos"> 870</span></a>        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">omega_val</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span id="PDESolver-871"><a href="#PDESolver-871"><span class="linenos"> 871</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inv_omega</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">omega_val</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span>
</span><span id="PDESolver-872"><a href="#PDESolver-872"><span class="linenos"> 872</span></a>
</span><span id="PDESolver-873"><a href="#PDESolver-873"><span class="linenos"> 873</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_source_at_t0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-874"><a href="#PDESolver-874"><span class="linenos"> 874</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-875"><a href="#PDESolver-875"><span class="linenos"> 875</span></a><span class="sd">        Evaluate source terms at initial time t = 0 over the spatial grid.</span>
</span><span id="PDESolver-876"><a href="#PDESolver-876"><span class="linenos"> 876</span></a><span class="sd">    </span>
</span><span id="PDESolver-877"><a href="#PDESolver-877"><span class="linenos"> 877</span></a><span class="sd">        This private method computes the total contribution of all source terms at the initial time,</span>
</span><span id="PDESolver-878"><a href="#PDESolver-878"><span class="linenos"> 878</span></a><span class="sd">        evaluated across the entire spatial domain. It supports both one-dimensional (1D) and</span>
</span><span id="PDESolver-879"><a href="#PDESolver-879"><span class="linenos"> 879</span></a><span class="sd">        two-dimensional (2D) configurations.</span>
</span><span id="PDESolver-880"><a href="#PDESolver-880"><span class="linenos"> 880</span></a><span class="sd">    </span>
</span><span id="PDESolver-881"><a href="#PDESolver-881"><span class="linenos"> 881</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver-882"><a href="#PDESolver-882"><span class="linenos"> 882</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-883"><a href="#PDESolver-883"><span class="linenos"> 883</span></a><span class="sd">        np.ndarray</span>
</span><span id="PDESolver-884"><a href="#PDESolver-884"><span class="linenos"> 884</span></a><span class="sd">            A numpy array representing the evaluated source term at t=0:</span>
</span><span id="PDESolver-885"><a href="#PDESolver-885"><span class="linenos"> 885</span></a><span class="sd">            - In 1D: Shape (Nx,), evaluated at each x in `self.x_grid`.</span>
</span><span id="PDESolver-886"><a href="#PDESolver-886"><span class="linenos"> 886</span></a><span class="sd">            - In 2D: Shape (Nx, Ny), evaluated at each (x, y) pair in the grid.</span>
</span><span id="PDESolver-887"><a href="#PDESolver-887"><span class="linenos"> 887</span></a><span class="sd">    </span>
</span><span id="PDESolver-888"><a href="#PDESolver-888"><span class="linenos"> 888</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-889"><a href="#PDESolver-889"><span class="linenos"> 889</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-890"><a href="#PDESolver-890"><span class="linenos"> 890</span></a><span class="sd">        - The symbolic expressions in `self.source_terms` are substituted with numerical values at t=0.</span>
</span><span id="PDESolver-891"><a href="#PDESolver-891"><span class="linenos"> 891</span></a><span class="sd">        - In 1D, each term is evaluated at (t=0, x=x_val).</span>
</span><span id="PDESolver-892"><a href="#PDESolver-892"><span class="linenos"> 892</span></a><span class="sd">        - In 2D, each term is evaluated at (t=0, x=x_val, y=y_val).</span>
</span><span id="PDESolver-893"><a href="#PDESolver-893"><span class="linenos"> 893</span></a><span class="sd">        - Evaluated using SymPy&#39;s `evalf()` to ensure numeric conversion.</span>
</span><span id="PDESolver-894"><a href="#PDESolver-894"><span class="linenos"> 894</span></a><span class="sd">        - This method assumes that the source terms have already been lambdified or are compatible with symbolic substitution.</span>
</span><span id="PDESolver-895"><a href="#PDESolver-895"><span class="linenos"> 895</span></a><span class="sd">    </span>
</span><span id="PDESolver-896"><a href="#PDESolver-896"><span class="linenos"> 896</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-897"><a href="#PDESolver-897"><span class="linenos"> 897</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-898"><a href="#PDESolver-898"><span class="linenos"> 898</span></a><span class="sd">        setup : Initializes the spatial grid and source terms.</span>
</span><span id="PDESolver-899"><a href="#PDESolver-899"><span class="linenos"> 899</span></a><span class="sd">        solve : Uses this evaluation during the first time step.</span>
</span><span id="PDESolver-900"><a href="#PDESolver-900"><span class="linenos"> 900</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-901"><a href="#PDESolver-901"><span class="linenos"> 901</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-902"><a href="#PDESolver-902"><span class="linenos"> 902</span></a>            <span class="c1"># Evaluation on the 1D spatial grid</span>
</span><span id="PDESolver-903"><a href="#PDESolver-903"><span class="linenos"> 903</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="PDESolver-904"><a href="#PDESolver-904"><span class="linenos"> 904</span></a>                <span class="nb">sum</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">evalf</span><span class="p">()</span>
</span><span id="PDESolver-905"><a href="#PDESolver-905"><span class="linenos"> 905</span></a>                    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">)</span>
</span><span id="PDESolver-906"><a href="#PDESolver-906"><span class="linenos"> 906</span></a>                <span class="k">for</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span>
</span><span id="PDESolver-907"><a href="#PDESolver-907"><span class="linenos"> 907</span></a>            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="PDESolver-908"><a href="#PDESolver-908"><span class="linenos"> 908</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-909"><a href="#PDESolver-909"><span class="linenos"> 909</span></a>            <span class="c1"># Evaluation on the 2D spatial grid</span>
</span><span id="PDESolver-910"><a href="#PDESolver-910"><span class="linenos"> 910</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="PDESolver-911"><a href="#PDESolver-911"><span class="linenos"> 911</span></a>                <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="n">x_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">y_val</span><span class="p">})</span><span class="o">.</span><span class="n">evalf</span><span class="p">()</span>
</span><span id="PDESolver-912"><a href="#PDESolver-912"><span class="linenos"> 912</span></a>                      <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">)</span>
</span><span id="PDESolver-913"><a href="#PDESolver-913"><span class="linenos"> 913</span></a>                 <span class="k">for</span> <span class="n">y_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">]</span>
</span><span id="PDESolver-914"><a href="#PDESolver-914"><span class="linenos"> 914</span></a>                <span class="k">for</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span>
</span><span id="PDESolver-915"><a href="#PDESolver-915"><span class="linenos"> 915</span></a>            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="PDESolver-916"><a href="#PDESolver-916"><span class="linenos"> 916</span></a>    
</span><span id="PDESolver-917"><a href="#PDESolver-917"><span class="linenos"> 917</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_condition</span><span class="p">,</span> <span class="n">initial_velocity</span><span class="p">):</span>
</span><span id="PDESolver-918"><a href="#PDESolver-918"><span class="linenos"> 918</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-919"><a href="#PDESolver-919"><span class="linenos"> 919</span></a><span class="sd">        Initialize the solution and velocity fields at t = 0.</span>
</span><span id="PDESolver-920"><a href="#PDESolver-920"><span class="linenos"> 920</span></a><span class="sd">    </span>
</span><span id="PDESolver-921"><a href="#PDESolver-921"><span class="linenos"> 921</span></a><span class="sd">        This private method sets up the initial state of the solution `u_prev` and, if applicable,</span>
</span><span id="PDESolver-922"><a href="#PDESolver-922"><span class="linenos"> 922</span></a><span class="sd">        the time derivative (velocity) `v_prev` for second-order evolution equations.</span>
</span><span id="PDESolver-923"><a href="#PDESolver-923"><span class="linenos"> 923</span></a><span class="sd">        </span>
</span><span id="PDESolver-924"><a href="#PDESolver-924"><span class="linenos"> 924</span></a><span class="sd">        For second-order equations, it also computes the backward-in-time value `u_prev2`</span>
</span><span id="PDESolver-925"><a href="#PDESolver-925"><span class="linenos"> 925</span></a><span class="sd">        needed by the Leap-Frog method. The acceleration at t = 0 is computed from:</span>
</span><span id="PDESolver-926"><a href="#PDESolver-926"><span class="linenos"> 926</span></a><span class="sd">            ∂ₜ²u = L(u) + N(u) + f(x, t=0)</span>
</span><span id="PDESolver-927"><a href="#PDESolver-927"><span class="linenos"> 927</span></a><span class="sd">        where L is the linear operator, N is the nonlinear term, and f is the source term.</span>
</span><span id="PDESolver-928"><a href="#PDESolver-928"><span class="linenos"> 928</span></a><span class="sd">    </span>
</span><span id="PDESolver-929"><a href="#PDESolver-929"><span class="linenos"> 929</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-930"><a href="#PDESolver-930"><span class="linenos"> 930</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-931"><a href="#PDESolver-931"><span class="linenos"> 931</span></a><span class="sd">        initial_condition : callable</span>
</span><span id="PDESolver-932"><a href="#PDESolver-932"><span class="linenos"> 932</span></a><span class="sd">            Function returning the initial condition u(x, 0) or u(x, y, 0).</span>
</span><span id="PDESolver-933"><a href="#PDESolver-933"><span class="linenos"> 933</span></a><span class="sd">        initial_velocity : callable or None</span>
</span><span id="PDESolver-934"><a href="#PDESolver-934"><span class="linenos"> 934</span></a><span class="sd">            Function returning the initial velocity ∂ₜu(x, 0) or ∂ₜu(x, y, 0). Required for</span>
</span><span id="PDESolver-935"><a href="#PDESolver-935"><span class="linenos"> 935</span></a><span class="sd">            second-order equations; ignored otherwise.</span>
</span><span id="PDESolver-936"><a href="#PDESolver-936"><span class="linenos"> 936</span></a><span class="sd">    </span>
</span><span id="PDESolver-937"><a href="#PDESolver-937"><span class="linenos"> 937</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-938"><a href="#PDESolver-938"><span class="linenos"> 938</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-939"><a href="#PDESolver-939"><span class="linenos"> 939</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver-940"><a href="#PDESolver-940"><span class="linenos"> 940</span></a><span class="sd">            If `initial_velocity` is not provided for second-order equations.</span>
</span><span id="PDESolver-941"><a href="#PDESolver-941"><span class="linenos"> 941</span></a><span class="sd">    </span>
</span><span id="PDESolver-942"><a href="#PDESolver-942"><span class="linenos"> 942</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-943"><a href="#PDESolver-943"><span class="linenos"> 943</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-944"><a href="#PDESolver-944"><span class="linenos"> 944</span></a><span class="sd">        - Applies periodic boundary conditions after setting initial data.</span>
</span><span id="PDESolver-945"><a href="#PDESolver-945"><span class="linenos"> 945</span></a><span class="sd">        - Stores a copy of the initial state in `self.frames` for visualization/output.</span>
</span><span id="PDESolver-946"><a href="#PDESolver-946"><span class="linenos"> 946</span></a><span class="sd">        - In second-order systems, initializes `self.u_prev2` using a Taylor expansion:</span>
</span><span id="PDESolver-947"><a href="#PDESolver-947"><span class="linenos"> 947</span></a><span class="sd">          u_prev2 = u_prev - dt * v_prev + 0.5 * dt² * (∂ₜ²u)</span>
</span><span id="PDESolver-948"><a href="#PDESolver-948"><span class="linenos"> 948</span></a><span class="sd">    </span>
</span><span id="PDESolver-949"><a href="#PDESolver-949"><span class="linenos"> 949</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-950"><a href="#PDESolver-950"><span class="linenos"> 950</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-951"><a href="#PDESolver-951"><span class="linenos"> 951</span></a><span class="sd">        apply_boundary : Enforces periodic boundary conditions on the solution field.</span>
</span><span id="PDESolver-952"><a href="#PDESolver-952"><span class="linenos"> 952</span></a><span class="sd">        psiOp_apply : Computes pseudo-differential operator action for acceleration.</span>
</span><span id="PDESolver-953"><a href="#PDESolver-953"><span class="linenos"> 953</span></a><span class="sd">        linear_rhs : Evaluates linear part of the equation in Fourier space.</span>
</span><span id="PDESolver-954"><a href="#PDESolver-954"><span class="linenos"> 954</span></a><span class="sd">        apply_nonlinear : Handles nonlinear terms with spectral differentiation.</span>
</span><span id="PDESolver-955"><a href="#PDESolver-955"><span class="linenos"> 955</span></a><span class="sd">        evaluate_source_at_t0 : Evaluates source terms at the initial time.</span>
</span><span id="PDESolver-956"><a href="#PDESolver-956"><span class="linenos"> 956</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-957"><a href="#PDESolver-957"><span class="linenos"> 957</span></a>        <span class="c1"># Initial condition</span>
</span><span id="PDESolver-958"><a href="#PDESolver-958"><span class="linenos"> 958</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-959"><a href="#PDESolver-959"><span class="linenos"> 959</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">initial_condition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver-960"><a href="#PDESolver-960"><span class="linenos"> 960</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-961"><a href="#PDESolver-961"><span class="linenos"> 961</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">initial_condition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PDESolver-962"><a href="#PDESolver-962"><span class="linenos"> 962</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-963"><a href="#PDESolver-963"><span class="linenos"> 963</span></a>    
</span><span id="PDESolver-964"><a href="#PDESolver-964"><span class="linenos"> 964</span></a>        <span class="c1"># Initial velocity (second order)</span>
</span><span id="PDESolver-965"><a href="#PDESolver-965"><span class="linenos"> 965</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-966"><a href="#PDESolver-966"><span class="linenos"> 966</span></a>            <span class="k">if</span> <span class="n">initial_velocity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-967"><a href="#PDESolver-967"><span class="linenos"> 967</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Initial velocity is required for second-order equations.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-968"><a href="#PDESolver-968"><span class="linenos"> 968</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-969"><a href="#PDESolver-969"><span class="linenos"> 969</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span> <span class="o">=</span> <span class="n">initial_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver-970"><a href="#PDESolver-970"><span class="linenos"> 970</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-971"><a href="#PDESolver-971"><span class="linenos"> 971</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span> <span class="o">=</span> <span class="n">initial_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PDESolver-972"><a href="#PDESolver-972"><span class="linenos"> 972</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-973"><a href="#PDESolver-973"><span class="linenos"> 973</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">)</span>
</span><span id="PDESolver-974"><a href="#PDESolver-974"><span class="linenos"> 974</span></a>    
</span><span id="PDESolver-975"><a href="#PDESolver-975"><span class="linenos"> 975</span></a>            <span class="c1"># Calculation of u_prev2 (initial acceleration)</span>
</span><span id="PDESolver-976"><a href="#PDESolver-976"><span class="linenos"> 976</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;u_prev2&#39;</span><span class="p">):</span>
</span><span id="PDESolver-977"><a href="#PDESolver-977"><span class="linenos"> 977</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-978"><a href="#PDESolver-978"><span class="linenos"> 978</span></a>                    <span class="n">acc0</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_psiOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-979"><a href="#PDESolver-979"><span class="linenos"> 979</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-980"><a href="#PDESolver-980"><span class="linenos"> 980</span></a>                    <span class="n">acc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_rhs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-981"><a href="#PDESolver-981"><span class="linenos"> 981</span></a>                <span class="n">rhs_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-982"><a href="#PDESolver-982"><span class="linenos"> 982</span></a>                <span class="n">acc0</span> <span class="o">+=</span> <span class="n">rhs_nl</span>
</span><span id="PDESolver-983"><a href="#PDESolver-983"><span class="linenos"> 983</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;source_terms&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver-984"><a href="#PDESolver-984"><span class="linenos"> 984</span></a>                    <span class="n">acc0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_source_at_t0</span><span class="p">()</span>
</span><span id="PDESolver-985"><a href="#PDESolver-985"><span class="linenos"> 985</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">u_prev2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">acc0</span>
</span><span id="PDESolver-986"><a href="#PDESolver-986"><span class="linenos"> 986</span></a>    
</span><span id="PDESolver-987"><a href="#PDESolver-987"><span class="linenos"> 987</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
</span><span id="PDESolver-988"><a href="#PDESolver-988"><span class="linenos"> 988</span></a>           
</span><span id="PDESolver-989"><a href="#PDESolver-989"><span class="linenos"> 989</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver-990"><a href="#PDESolver-990"><span class="linenos"> 990</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-991"><a href="#PDESolver-991"><span class="linenos"> 991</span></a><span class="sd">        Apply boundary conditions to the solution array based on the specified type.</span>
</span><span id="PDESolver-992"><a href="#PDESolver-992"><span class="linenos"> 992</span></a><span class="sd">    </span>
</span><span id="PDESolver-993"><a href="#PDESolver-993"><span class="linenos"> 993</span></a><span class="sd">        This method supports two types of boundary conditions:</span>
</span><span id="PDESolver-994"><a href="#PDESolver-994"><span class="linenos"> 994</span></a><span class="sd">        </span>
</span><span id="PDESolver-995"><a href="#PDESolver-995"><span class="linenos"> 995</span></a><span class="sd">        - &#39;periodic&#39;: Enforces periodicity by copying opposite boundary values.</span>
</span><span id="PDESolver-996"><a href="#PDESolver-996"><span class="linenos"> 996</span></a><span class="sd">        - &#39;dirichlet&#39;: Sets all boundary values to zero (homogeneous Dirichlet condition).</span>
</span><span id="PDESolver-997"><a href="#PDESolver-997"><span class="linenos"> 997</span></a><span class="sd">    </span>
</span><span id="PDESolver-998"><a href="#PDESolver-998"><span class="linenos"> 998</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-999"><a href="#PDESolver-999"><span class="linenos"> 999</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-1000"><a href="#PDESolver-1000"><span class="linenos">1000</span></a><span class="sd">        u : np.ndarray</span>
</span><span id="PDESolver-1001"><a href="#PDESolver-1001"><span class="linenos">1001</span></a><span class="sd">            The solution array representing the field values on a spatial grid.</span>
</span><span id="PDESolver-1002"><a href="#PDESolver-1002"><span class="linenos">1002</span></a><span class="sd">            In 1D, shape must be (Nx,). In 2D, shape must be (Nx, Ny).</span>
</span><span id="PDESolver-1003"><a href="#PDESolver-1003"><span class="linenos">1003</span></a><span class="sd">    </span>
</span><span id="PDESolver-1004"><a href="#PDESolver-1004"><span class="linenos">1004</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-1005"><a href="#PDESolver-1005"><span class="linenos">1005</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-1006"><a href="#PDESolver-1006"><span class="linenos">1006</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver-1007"><a href="#PDESolver-1007"><span class="linenos">1007</span></a><span class="sd">            If `self.boundary_condition` is not one of {&#39;periodic&#39;, &#39;dirichlet&#39;}.</span>
</span><span id="PDESolver-1008"><a href="#PDESolver-1008"><span class="linenos">1008</span></a><span class="sd">    </span>
</span><span id="PDESolver-1009"><a href="#PDESolver-1009"><span class="linenos">1009</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-1010"><a href="#PDESolver-1010"><span class="linenos">1010</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-1011"><a href="#PDESolver-1011"><span class="linenos">1011</span></a><span class="sd">        - For &#39;periodic&#39;:</span>
</span><span id="PDESolver-1012"><a href="#PDESolver-1012"><span class="linenos">1012</span></a><span class="sd">            * In 1D: u[0] = u[-2], u[-1] = u[1]</span>
</span><span id="PDESolver-1013"><a href="#PDESolver-1013"><span class="linenos">1013</span></a><span class="sd">            * In 2D: First and last rows/columns are set equal to their neighbors.</span>
</span><span id="PDESolver-1014"><a href="#PDESolver-1014"><span class="linenos">1014</span></a><span class="sd">        - For &#39;dirichlet&#39;:</span>
</span><span id="PDESolver-1015"><a href="#PDESolver-1015"><span class="linenos">1015</span></a><span class="sd">            * All boundary points are explicitly set to zero.</span>
</span><span id="PDESolver-1016"><a href="#PDESolver-1016"><span class="linenos">1016</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1017"><a href="#PDESolver-1017"><span class="linenos">1017</span></a>    
</span><span id="PDESolver-1018"><a href="#PDESolver-1018"><span class="linenos">1018</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PDESolver-1019"><a href="#PDESolver-1019"><span class="linenos">1019</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1020"><a href="#PDESolver-1020"><span class="linenos">1020</span></a>                <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span><span id="PDESolver-1021"><a href="#PDESolver-1021"><span class="linenos">1021</span></a>                <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PDESolver-1022"><a href="#PDESolver-1022"><span class="linenos">1022</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1023"><a href="#PDESolver-1023"><span class="linenos">1023</span></a>                <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="PDESolver-1024"><a href="#PDESolver-1024"><span class="linenos">1024</span></a>                <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="PDESolver-1025"><a href="#PDESolver-1025"><span class="linenos">1025</span></a>                <span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span><span id="PDESolver-1026"><a href="#PDESolver-1026"><span class="linenos">1026</span></a>                <span class="n">u</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="PDESolver-1027"><a href="#PDESolver-1027"><span class="linenos">1027</span></a>    
</span><span id="PDESolver-1028"><a href="#PDESolver-1028"><span class="linenos">1028</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">:</span>
</span><span id="PDESolver-1029"><a href="#PDESolver-1029"><span class="linenos">1029</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1030"><a href="#PDESolver-1030"><span class="linenos">1030</span></a>                <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1031"><a href="#PDESolver-1031"><span class="linenos">1031</span></a>                <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1032"><a href="#PDESolver-1032"><span class="linenos">1032</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1033"><a href="#PDESolver-1033"><span class="linenos">1033</span></a>                <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1034"><a href="#PDESolver-1034"><span class="linenos">1034</span></a>                <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1035"><a href="#PDESolver-1035"><span class="linenos">1035</span></a>                <span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1036"><a href="#PDESolver-1036"><span class="linenos">1036</span></a>                <span class="n">u</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1037"><a href="#PDESolver-1037"><span class="linenos">1037</span></a>    
</span><span id="PDESolver-1038"><a href="#PDESolver-1038"><span class="linenos">1038</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1039"><a href="#PDESolver-1039"><span class="linenos">1039</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PDESolver-1040"><a href="#PDESolver-1040"><span class="linenos">1040</span></a>                <span class="sa">f</span><span class="s2">&quot;Invalid boundary condition &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
</span><span id="PDESolver-1041"><a href="#PDESolver-1041"><span class="linenos">1041</span></a>                <span class="s2">&quot;Supported types are &#39;periodic&#39; and &#39;dirichlet&#39;.&quot;</span>
</span><span id="PDESolver-1042"><a href="#PDESolver-1042"><span class="linenos">1042</span></a>            <span class="p">)</span>
</span><span id="PDESolver-1043"><a href="#PDESolver-1043"><span class="linenos">1043</span></a>
</span><span id="PDESolver-1044"><a href="#PDESolver-1044"><span class="linenos">1044</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PDESolver-1045"><a href="#PDESolver-1045"><span class="linenos">1045</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1046"><a href="#PDESolver-1046"><span class="linenos">1046</span></a><span class="sd">        Apply nonlinear terms to the solution using spectral differentiation with dealiasing.</span>
</span><span id="PDESolver-1047"><a href="#PDESolver-1047"><span class="linenos">1047</span></a>
</span><span id="PDESolver-1048"><a href="#PDESolver-1048"><span class="linenos">1048</span></a><span class="sd">        This method evaluates all nonlinear terms present in the PDE by substituting spatial </span>
</span><span id="PDESolver-1049"><a href="#PDESolver-1049"><span class="linenos">1049</span></a><span class="sd">        derivatives with their spectral approximations computed via FFT. The dealiasing mask </span>
</span><span id="PDESolver-1050"><a href="#PDESolver-1050"><span class="linenos">1050</span></a><span class="sd">        ensures numerical stability by removing high-frequency components that could lead </span>
</span><span id="PDESolver-1051"><a href="#PDESolver-1051"><span class="linenos">1051</span></a><span class="sd">        to aliasing errors.</span>
</span><span id="PDESolver-1052"><a href="#PDESolver-1052"><span class="linenos">1052</span></a>
</span><span id="PDESolver-1053"><a href="#PDESolver-1053"><span class="linenos">1053</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1054"><a href="#PDESolver-1054"><span class="linenos">1054</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-1055"><a href="#PDESolver-1055"><span class="linenos">1055</span></a><span class="sd">        u : numpy.ndarray</span>
</span><span id="PDESolver-1056"><a href="#PDESolver-1056"><span class="linenos">1056</span></a><span class="sd">            Current solution array on the spatial grid.</span>
</span><span id="PDESolver-1057"><a href="#PDESolver-1057"><span class="linenos">1057</span></a><span class="sd">        is_v : bool</span>
</span><span id="PDESolver-1058"><a href="#PDESolver-1058"><span class="linenos">1058</span></a><span class="sd">            If True, evaluates nonlinear terms for the velocity field v instead of u.</span>
</span><span id="PDESolver-1059"><a href="#PDESolver-1059"><span class="linenos">1059</span></a>
</span><span id="PDESolver-1060"><a href="#PDESolver-1060"><span class="linenos">1060</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1061"><a href="#PDESolver-1061"><span class="linenos">1061</span></a><span class="sd">            numpy.ndarray: Array representing the contribution of nonlinear terms multiplied by dt.</span>
</span><span id="PDESolver-1062"><a href="#PDESolver-1062"><span class="linenos">1062</span></a>
</span><span id="PDESolver-1063"><a href="#PDESolver-1063"><span class="linenos">1063</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-1064"><a href="#PDESolver-1064"><span class="linenos">1064</span></a><span class="sd">        </span>
</span><span id="PDESolver-1065"><a href="#PDESolver-1065"><span class="linenos">1065</span></a><span class="sd">        - In 1D, computes ∂ₓu via FFT and substitutes any derivative term in the nonlinear expressions.</span>
</span><span id="PDESolver-1066"><a href="#PDESolver-1066"><span class="linenos">1066</span></a><span class="sd">        - In 2D, computes ∂ₓu and ∂ᵧu via FFT and performs similar substitutions.</span>
</span><span id="PDESolver-1067"><a href="#PDESolver-1067"><span class="linenos">1067</span></a><span class="sd">        - Uses lambdify to evaluate symbolic nonlinear expressions numerically.</span>
</span><span id="PDESolver-1068"><a href="#PDESolver-1068"><span class="linenos">1068</span></a><span class="sd">        - Derivatives are replaced symbolically with &#39;u_x&#39; and &#39;u_y&#39; before evaluation.</span>
</span><span id="PDESolver-1069"><a href="#PDESolver-1069"><span class="linenos">1069</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1070"><a href="#PDESolver-1070"><span class="linenos">1070</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">:</span>
</span><span id="PDESolver-1071"><a href="#PDESolver-1071"><span class="linenos">1071</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-1072"><a href="#PDESolver-1072"><span class="linenos">1072</span></a>        
</span><span id="PDESolver-1073"><a href="#PDESolver-1073"><span class="linenos">1073</span></a>        <span class="n">nonlinear_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-1074"><a href="#PDESolver-1074"><span class="linenos">1074</span></a>    
</span><span id="PDESolver-1075"><a href="#PDESolver-1075"><span class="linenos">1075</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1076"><a href="#PDESolver-1076"><span class="linenos">1076</span></a>            <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1077"><a href="#PDESolver-1077"><span class="linenos">1077</span></a>            <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-1078"><a href="#PDESolver-1078"><span class="linenos">1078</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-1079"><a href="#PDESolver-1079"><span class="linenos">1079</span></a>    
</span><span id="PDESolver-1080"><a href="#PDESolver-1080"><span class="linenos">1080</span></a>            <span class="n">u_x_hat</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span> <span class="o">*</span> <span class="n">u_hat</span>
</span><span id="PDESolver-1081"><a href="#PDESolver-1081"><span class="linenos">1081</span></a>            <span class="n">u_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_x_hat</span><span class="p">)</span>
</span><span id="PDESolver-1082"><a href="#PDESolver-1082"><span class="linenos">1082</span></a>    
</span><span id="PDESolver-1083"><a href="#PDESolver-1083"><span class="linenos">1083</span></a>            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">:</span>
</span><span id="PDESolver-1084"><a href="#PDESolver-1084"><span class="linenos">1084</span></a>                <span class="n">term_replaced</span> <span class="o">=</span> <span class="n">term</span>
</span><span id="PDESolver-1085"><a href="#PDESolver-1085"><span class="linenos">1085</span></a>                <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">Derivative</span><span class="p">):</span>
</span><span id="PDESolver-1086"><a href="#PDESolver-1086"><span class="linenos">1086</span></a>                    <span class="k">for</span> <span class="n">deriv</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Derivative</span><span class="p">):</span>
</span><span id="PDESolver-1087"><a href="#PDESolver-1087"><span class="linenos">1087</span></a>                        <span class="k">if</span> <span class="n">deriv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
</span><span id="PDESolver-1088"><a href="#PDESolver-1088"><span class="linenos">1088</span></a>                            <span class="n">term_replaced</span> <span class="o">=</span> <span class="n">term_replaced</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;u_x&#39;</span><span class="p">))</span>            
</span><span id="PDESolver-1089"><a href="#PDESolver-1089"><span class="linenos">1089</span></a>                <span class="n">term_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_eq</span><span class="p">,</span> <span class="s1">&#39;u_x&#39;</span><span class="p">),</span> <span class="n">term_replaced</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1090"><a href="#PDESolver-1090"><span class="linenos">1090</span></a>                <span class="k">if</span> <span class="n">is_v</span><span class="p">:</span>
</span><span id="PDESolver-1091"><a href="#PDESolver-1091"><span class="linenos">1091</span></a>                    <span class="n">nonlinear_term</span> <span class="o">+=</span> <span class="n">term_func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">,</span> <span class="n">u_x</span><span class="p">)</span>
</span><span id="PDESolver-1092"><a href="#PDESolver-1092"><span class="linenos">1092</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1093"><a href="#PDESolver-1093"><span class="linenos">1093</span></a>                    <span class="n">nonlinear_term</span> <span class="o">+=</span> <span class="n">term_func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_x</span><span class="p">)</span>
</span><span id="PDESolver-1094"><a href="#PDESolver-1094"><span class="linenos">1094</span></a>    
</span><span id="PDESolver-1095"><a href="#PDESolver-1095"><span class="linenos">1095</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1096"><a href="#PDESolver-1096"><span class="linenos">1096</span></a>            <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1097"><a href="#PDESolver-1097"><span class="linenos">1097</span></a>            <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-1098"><a href="#PDESolver-1098"><span class="linenos">1098</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-1099"><a href="#PDESolver-1099"><span class="linenos">1099</span></a>    
</span><span id="PDESolver-1100"><a href="#PDESolver-1100"><span class="linenos">1100</span></a>            <span class="n">u_x_hat</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span> <span class="o">*</span> <span class="n">u_hat</span>
</span><span id="PDESolver-1101"><a href="#PDESolver-1101"><span class="linenos">1101</span></a>            <span class="n">u_y_hat</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span> <span class="o">*</span> <span class="n">u_hat</span>
</span><span id="PDESolver-1102"><a href="#PDESolver-1102"><span class="linenos">1102</span></a>            <span class="n">u_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_x_hat</span><span class="p">)</span>
</span><span id="PDESolver-1103"><a href="#PDESolver-1103"><span class="linenos">1103</span></a>            <span class="n">u_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_y_hat</span><span class="p">)</span>
</span><span id="PDESolver-1104"><a href="#PDESolver-1104"><span class="linenos">1104</span></a>    
</span><span id="PDESolver-1105"><a href="#PDESolver-1105"><span class="linenos">1105</span></a>            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">:</span>
</span><span id="PDESolver-1106"><a href="#PDESolver-1106"><span class="linenos">1106</span></a>                <span class="n">term_replaced</span> <span class="o">=</span> <span class="n">term</span>
</span><span id="PDESolver-1107"><a href="#PDESolver-1107"><span class="linenos">1107</span></a>                <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">Derivative</span><span class="p">):</span>
</span><span id="PDESolver-1108"><a href="#PDESolver-1108"><span class="linenos">1108</span></a>                    <span class="k">for</span> <span class="n">deriv</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Derivative</span><span class="p">):</span>
</span><span id="PDESolver-1109"><a href="#PDESolver-1109"><span class="linenos">1109</span></a>                        <span class="k">if</span> <span class="n">deriv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
</span><span id="PDESolver-1110"><a href="#PDESolver-1110"><span class="linenos">1110</span></a>                            <span class="n">term_replaced</span> <span class="o">=</span> <span class="n">term_replaced</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;u_x&#39;</span><span class="p">))</span>
</span><span id="PDESolver-1111"><a href="#PDESolver-1111"><span class="linenos">1111</span></a>                        <span class="k">elif</span> <span class="n">deriv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
</span><span id="PDESolver-1112"><a href="#PDESolver-1112"><span class="linenos">1112</span></a>                            <span class="n">term_replaced</span> <span class="o">=</span> <span class="n">term_replaced</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;u_y&#39;</span><span class="p">))</span>
</span><span id="PDESolver-1113"><a href="#PDESolver-1113"><span class="linenos">1113</span></a>                <span class="n">term_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_eq</span><span class="p">,</span> <span class="s1">&#39;u_x&#39;</span><span class="p">,</span> <span class="s1">&#39;u_y&#39;</span><span class="p">),</span> <span class="n">term_replaced</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1114"><a href="#PDESolver-1114"><span class="linenos">1114</span></a>                <span class="k">if</span> <span class="n">is_v</span><span class="p">:</span>
</span><span id="PDESolver-1115"><a href="#PDESolver-1115"><span class="linenos">1115</span></a>                    <span class="n">nonlinear_term</span> <span class="o">+=</span> <span class="n">term_func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">,</span> <span class="n">u_x</span><span class="p">,</span> <span class="n">u_y</span><span class="p">)</span>
</span><span id="PDESolver-1116"><a href="#PDESolver-1116"><span class="linenos">1116</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1117"><a href="#PDESolver-1117"><span class="linenos">1117</span></a>                    <span class="n">nonlinear_term</span> <span class="o">+=</span> <span class="n">term_func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_x</span><span class="p">,</span> <span class="n">u_y</span><span class="p">)</span>
</span><span id="PDESolver-1118"><a href="#PDESolver-1118"><span class="linenos">1118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1119"><a href="#PDESolver-1119"><span class="linenos">1119</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported spatial dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1120"><a href="#PDESolver-1120"><span class="linenos">1120</span></a>        
</span><span id="PDESolver-1121"><a href="#PDESolver-1121"><span class="linenos">1121</span></a>        <span class="k">return</span> <span class="n">nonlinear_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="PDESolver-1122"><a href="#PDESolver-1122"><span class="linenos">1122</span></a>
</span><span id="PDESolver-1123"><a href="#PDESolver-1123"><span class="linenos">1123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_symbol_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-1124"><a href="#PDESolver-1124"><span class="linenos">1124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1125"><a href="#PDESolver-1125"><span class="linenos">1125</span></a><span class="sd">        Precompute and store evaluated pseudo-differential operator symbols for spectral methods.</span>
</span><span id="PDESolver-1126"><a href="#PDESolver-1126"><span class="linenos">1126</span></a>
</span><span id="PDESolver-1127"><a href="#PDESolver-1127"><span class="linenos">1127</span></a><span class="sd">        This method evaluates all pseudo-differential operators (ψOp) present in the PDE</span>
</span><span id="PDESolver-1128"><a href="#PDESolver-1128"><span class="linenos">1128</span></a><span class="sd">        over the spatial and frequency grids, scales them by their respective coefficients,</span>
</span><span id="PDESolver-1129"><a href="#PDESolver-1129"><span class="linenos">1129</span></a><span class="sd">        and combines them into a single composite symbol used in time-stepping and inversion.</span>
</span><span id="PDESolver-1130"><a href="#PDESolver-1130"><span class="linenos">1130</span></a>
</span><span id="PDESolver-1131"><a href="#PDESolver-1131"><span class="linenos">1131</span></a><span class="sd">        The evaluation is performed via the `evaluate` method of each PseudoDifferentialOperator,</span>
</span><span id="PDESolver-1132"><a href="#PDESolver-1132"><span class="linenos">1132</span></a><span class="sd">        which computes p(x, ξ) or p(x, y, ξ, η) numerically over the current grid configuration.</span>
</span><span id="PDESolver-1133"><a href="#PDESolver-1133"><span class="linenos">1133</span></a>
</span><span id="PDESolver-1134"><a href="#PDESolver-1134"><span class="linenos">1134</span></a><span class="sd">        Side Effects:</span>
</span><span id="PDESolver-1135"><a href="#PDESolver-1135"><span class="linenos">1135</span></a><span class="sd">            self.precomputed_symbols : list of (coeff, symbol_array)</span>
</span><span id="PDESolver-1136"><a href="#PDESolver-1136"><span class="linenos">1136</span></a><span class="sd">                Each tuple contains a coefficient and its evaluated symbol on the grid.</span>
</span><span id="PDESolver-1137"><a href="#PDESolver-1137"><span class="linenos">1137</span></a><span class="sd">            self.combined_symbol : np.ndarray</span>
</span><span id="PDESolver-1138"><a href="#PDESolver-1138"><span class="linenos">1138</span></a><span class="sd">                Sum of all scaled symbol arrays: ∑(coeffₖ * ψₖ(x, ξ))</span>
</span><span id="PDESolver-1139"><a href="#PDESolver-1139"><span class="linenos">1139</span></a>
</span><span id="PDESolver-1140"><a href="#PDESolver-1140"><span class="linenos">1140</span></a><span class="sd">        Raises:</span>
</span><span id="PDESolver-1141"><a href="#PDESolver-1141"><span class="linenos">1141</span></a><span class="sd">            ValueError: If the spatial dimension is not 1D or 2D.</span>
</span><span id="PDESolver-1142"><a href="#PDESolver-1142"><span class="linenos">1142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1143"><a href="#PDESolver-1143"><span class="linenos">1143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_symbols</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-1144"><a href="#PDESolver-1144"><span class="linenos">1144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combined_symbol</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1145"><a href="#PDESolver-1145"><span class="linenos">1145</span></a>        <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">psi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="p">:</span>
</span><span id="PDESolver-1146"><a href="#PDESolver-1146"><span class="linenos">1146</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1147"><a href="#PDESolver-1147"><span class="linenos">1147</span></a>                <span class="n">raw</span> <span class="o">=</span> <span class="n">psi</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PDESolver-1148"><a href="#PDESolver-1148"><span class="linenos">1148</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1149"><a href="#PDESolver-1149"><span class="linenos">1149</span></a>                <span class="n">raw</span> <span class="o">=</span> <span class="n">psi</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-1150"><a href="#PDESolver-1150"><span class="linenos">1150</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1151"><a href="#PDESolver-1151"><span class="linenos">1151</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported spatial dimension.&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1152"><a href="#PDESolver-1152"><span class="linenos">1152</span></a>            <span class="n">raw_flat</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="PDESolver-1153"><a href="#PDESolver-1153"><span class="linenos">1153</span></a>            <span class="n">converted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">complex</span><span class="p">(</span><span class="n">N</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">raw_flat</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-1154"><a href="#PDESolver-1154"><span class="linenos">1154</span></a>            <span class="n">raw_eval</span> <span class="o">=</span> <span class="n">converted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="PDESolver-1155"><a href="#PDESolver-1155"><span class="linenos">1155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_symbols</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">raw_eval</span><span class="p">))</span>
</span><span id="PDESolver-1156"><a href="#PDESolver-1156"><span class="linenos">1156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combined_symbol</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">coeff</span> <span class="o">*</span> <span class="n">sym</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_symbols</span><span class="p">))</span>
</span><span id="PDESolver-1157"><a href="#PDESolver-1157"><span class="linenos">1157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combined_symbol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combined_symbol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-1158"><a href="#PDESolver-1158"><span class="linenos">1158</span></a>
</span><span id="PDESolver-1159"><a href="#PDESolver-1159"><span class="linenos">1159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_total_symbol_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-1160"><a href="#PDESolver-1160"><span class="linenos">1160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1161"><a href="#PDESolver-1161"><span class="linenos">1161</span></a><span class="sd">        Compute the total pseudo-differential symbol expression from all pseudo_terms.</span>
</span><span id="PDESolver-1162"><a href="#PDESolver-1162"><span class="linenos">1162</span></a>
</span><span id="PDESolver-1163"><a href="#PDESolver-1163"><span class="linenos">1163</span></a><span class="sd">        This method constructs the full symbol of the pseudo-differential operator</span>
</span><span id="PDESolver-1164"><a href="#PDESolver-1164"><span class="linenos">1164</span></a><span class="sd">        by summing up all coefficient-weighted symbolic expressions.</span>
</span><span id="PDESolver-1165"><a href="#PDESolver-1165"><span class="linenos">1165</span></a>
</span><span id="PDESolver-1166"><a href="#PDESolver-1166"><span class="linenos">1166</span></a><span class="sd">        The result is cached in self.symbol_expr to avoid recomputation.</span>
</span><span id="PDESolver-1167"><a href="#PDESolver-1167"><span class="linenos">1167</span></a>
</span><span id="PDESolver-1168"><a href="#PDESolver-1168"><span class="linenos">1168</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1169"><a href="#PDESolver-1169"><span class="linenos">1169</span></a><span class="sd">            sympy.Expr: The combined symbol expression, representing the full</span>
</span><span id="PDESolver-1170"><a href="#PDESolver-1170"><span class="linenos">1170</span></a><span class="sd">                        pseudo-differential operator in symbolic form.</span>
</span><span id="PDESolver-1171"><a href="#PDESolver-1171"><span class="linenos">1171</span></a>
</span><span id="PDESolver-1172"><a href="#PDESolver-1172"><span class="linenos">1172</span></a><span class="sd">        Example:</span>
</span><span id="PDESolver-1173"><a href="#PDESolver-1173"><span class="linenos">1173</span></a><span class="sd">            Given pseudo_terms = [(2, ξ²), (1, x·ξ)], this returns 2·ξ² + x·ξ.</span>
</span><span id="PDESolver-1174"><a href="#PDESolver-1174"><span class="linenos">1174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1175"><a href="#PDESolver-1175"><span class="linenos">1175</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_symbol_expr&#39;</span><span class="p">):</span>
</span><span id="PDESolver-1176"><a href="#PDESolver-1176"><span class="linenos">1176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symbol_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff</span> <span class="o">*</span> <span class="n">expr</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">)</span>
</span><span id="PDESolver-1177"><a href="#PDESolver-1177"><span class="linenos">1177</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_expr</span>
</span><span id="PDESolver-1178"><a href="#PDESolver-1178"><span class="linenos">1178</span></a>
</span><span id="PDESolver-1179"><a href="#PDESolver-1179"><span class="linenos">1179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_symbol_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
</span><span id="PDESolver-1180"><a href="#PDESolver-1180"><span class="linenos">1180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1181"><a href="#PDESolver-1181"><span class="linenos">1181</span></a><span class="sd">        Build a numerical evaluation function from a symbolic pseudo-differential operator expression.</span>
</span><span id="PDESolver-1182"><a href="#PDESolver-1182"><span class="linenos">1182</span></a><span class="sd">    </span>
</span><span id="PDESolver-1183"><a href="#PDESolver-1183"><span class="linenos">1183</span></a><span class="sd">        This method converts a symbolic expression representing a pseudo-differential operator into</span>
</span><span id="PDESolver-1184"><a href="#PDESolver-1184"><span class="linenos">1184</span></a><span class="sd">        a callable NumPy-compatible function. The function accepts spatial and frequency variables</span>
</span><span id="PDESolver-1185"><a href="#PDESolver-1185"><span class="linenos">1185</span></a><span class="sd">        depending on the dimensionality of the problem.</span>
</span><span id="PDESolver-1186"><a href="#PDESolver-1186"><span class="linenos">1186</span></a><span class="sd">    </span>
</span><span id="PDESolver-1187"><a href="#PDESolver-1187"><span class="linenos">1187</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1188"><a href="#PDESolver-1188"><span class="linenos">1188</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-1189"><a href="#PDESolver-1189"><span class="linenos">1189</span></a><span class="sd">        expr : sympy expression</span>
</span><span id="PDESolver-1190"><a href="#PDESolver-1190"><span class="linenos">1190</span></a><span class="sd">            A SymPy expression representing the symbol of the pseudo-differential operator. It may depend on spatial variables (x, y) and frequency variables (xi, eta).</span>
</span><span id="PDESolver-1191"><a href="#PDESolver-1191"><span class="linenos">1191</span></a><span class="sd">    </span>
</span><span id="PDESolver-1192"><a href="#PDESolver-1192"><span class="linenos">1192</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1193"><a href="#PDESolver-1193"><span class="linenos">1193</span></a><span class="sd">            function : A lambdified function that takes:</span>
</span><span id="PDESolver-1194"><a href="#PDESolver-1194"><span class="linenos">1194</span></a><span class="sd">            </span>
</span><span id="PDESolver-1195"><a href="#PDESolver-1195"><span class="linenos">1195</span></a><span class="sd">                - In 1D: `(x, xi)` — spatial coordinate and frequency.</span>
</span><span id="PDESolver-1196"><a href="#PDESolver-1196"><span class="linenos">1196</span></a><span class="sd">                - In 2D: `(x, y, xi, eta)` — spatial coordinates and frequencies.</span>
</span><span id="PDESolver-1197"><a href="#PDESolver-1197"><span class="linenos">1197</span></a><span class="sd">                </span>
</span><span id="PDESolver-1198"><a href="#PDESolver-1198"><span class="linenos">1198</span></a><span class="sd">              Returns a NumPy array of evaluated symbol values over input grids.</span>
</span><span id="PDESolver-1199"><a href="#PDESolver-1199"><span class="linenos">1199</span></a><span class="sd">    </span>
</span><span id="PDESolver-1200"><a href="#PDESolver-1200"><span class="linenos">1200</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-1201"><a href="#PDESolver-1201"><span class="linenos">1201</span></a><span class="sd">            - Uses `lambdify` from SymPy with the `&#39;numpy&#39;` backend for efficient vectorized evaluation.</span>
</span><span id="PDESolver-1202"><a href="#PDESolver-1202"><span class="linenos">1202</span></a><span class="sd">            - Real variable assumptions are enforced to ensure proper behavior in numerical contexts.</span>
</span><span id="PDESolver-1203"><a href="#PDESolver-1203"><span class="linenos">1203</span></a><span class="sd">            - Used internally by methods like `apply_psiOp`, `evaluate`, and visualization tools.</span>
</span><span id="PDESolver-1204"><a href="#PDESolver-1204"><span class="linenos">1204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1205"><a href="#PDESolver-1205"><span class="linenos">1205</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1206"><a href="#PDESolver-1206"><span class="linenos">1206</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-1207"><a href="#PDESolver-1207"><span class="linenos">1207</span></a>            <span class="k">return</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1208"><a href="#PDESolver-1208"><span class="linenos">1208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1209"><a href="#PDESolver-1209"><span class="linenos">1209</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x y xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-1210"><a href="#PDESolver-1210"><span class="linenos">1210</span></a>            <span class="k">return</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1211"><a href="#PDESolver-1211"><span class="linenos">1211</span></a>
</span><span id="PDESolver-1212"><a href="#PDESolver-1212"><span class="linenos">1212</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_psiOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver-1213"><a href="#PDESolver-1213"><span class="linenos">1213</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1214"><a href="#PDESolver-1214"><span class="linenos">1214</span></a><span class="sd">        Apply the pseudo-differential operator to the input field u.</span>
</span><span id="PDESolver-1215"><a href="#PDESolver-1215"><span class="linenos">1215</span></a><span class="sd">    </span>
</span><span id="PDESolver-1216"><a href="#PDESolver-1216"><span class="linenos">1216</span></a><span class="sd">        This method dispatches the application of the pseudo-differential operator based on:</span>
</span><span id="PDESolver-1217"><a href="#PDESolver-1217"><span class="linenos">1217</span></a><span class="sd">        </span>
</span><span id="PDESolver-1218"><a href="#PDESolver-1218"><span class="linenos">1218</span></a><span class="sd">        - Whether the symbol is spatially dependent (x/y)</span>
</span><span id="PDESolver-1219"><a href="#PDESolver-1219"><span class="linenos">1219</span></a><span class="sd">        - The boundary condition in use (periodic or dirichlet)</span>
</span><span id="PDESolver-1220"><a href="#PDESolver-1220"><span class="linenos">1220</span></a><span class="sd">    </span>
</span><span id="PDESolver-1221"><a href="#PDESolver-1221"><span class="linenos">1221</span></a><span class="sd">        Supported operations:</span>
</span><span id="PDESolver-1222"><a href="#PDESolver-1222"><span class="linenos">1222</span></a><span class="sd">        </span>
</span><span id="PDESolver-1223"><a href="#PDESolver-1223"><span class="linenos">1223</span></a><span class="sd">        - Constant-coefficient symbols: applied via Fourier multiplication.</span>
</span><span id="PDESolver-1224"><a href="#PDESolver-1224"><span class="linenos">1224</span></a><span class="sd">        - Spatially varying symbols: applied via Kohn–Nirenberg quantization.</span>
</span><span id="PDESolver-1225"><a href="#PDESolver-1225"><span class="linenos">1225</span></a><span class="sd">        - Dirichlet boundary conditions: handled with non-periodic convolution-like quantization.</span>
</span><span id="PDESolver-1226"><a href="#PDESolver-1226"><span class="linenos">1226</span></a><span class="sd">    </span>
</span><span id="PDESolver-1227"><a href="#PDESolver-1227"><span class="linenos">1227</span></a><span class="sd">        Dispatch Logic:\n</span>
</span><span id="PDESolver-1228"><a href="#PDESolver-1228"><span class="linenos">1228</span></a><span class="sd">        if not self.is_spatial: u ↦ Op(p)(D) ⋅ u = 𝓕⁻¹[ p(ξ) ⋅ 𝓕(u) ]\n</span>
</span><span id="PDESolver-1229"><a href="#PDESolver-1229"><span class="linenos">1229</span></a><span class="sd">        elif periodic: u ↦ Op(p)(x,D) ⋅ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ based of FFT (quicker)\n</span>
</span><span id="PDESolver-1230"><a href="#PDESolver-1230"><span class="linenos">1230</span></a><span class="sd">        elif dirichlet: u ↦ Op(p)(x,D) ⋅ u ≈ u ≈ ∫ eᶦˣᶿ p(x, ξ) 𝓕(u)(ξ) dξ (slower)\n</span>
</span><span id="PDESolver-1231"><a href="#PDESolver-1231"><span class="linenos">1231</span></a><span class="sd">        </span>
</span><span id="PDESolver-1232"><a href="#PDESolver-1232"><span class="linenos">1232</span></a><span class="sd">        This method delegates to the apply() method of each </span>
</span><span id="PDESolver-1233"><a href="#PDESolver-1233"><span class="linenos">1233</span></a><span class="sd">        PseudoDifferentialOperator instance.</span>
</span><span id="PDESolver-1234"><a href="#PDESolver-1234"><span class="linenos">1234</span></a><span class="sd">        </span>
</span><span id="PDESolver-1235"><a href="#PDESolver-1235"><span class="linenos">1235</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1236"><a href="#PDESolver-1236"><span class="linenos">1236</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-1237"><a href="#PDESolver-1237"><span class="linenos">1237</span></a><span class="sd">        u : ndarray</span>
</span><span id="PDESolver-1238"><a href="#PDESolver-1238"><span class="linenos">1238</span></a><span class="sd">            Function to which operators are applied</span>
</span><span id="PDESolver-1239"><a href="#PDESolver-1239"><span class="linenos">1239</span></a><span class="sd">            </span>
</span><span id="PDESolver-1240"><a href="#PDESolver-1240"><span class="linenos">1240</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver-1241"><a href="#PDESolver-1241"><span class="linenos">1241</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-1242"><a href="#PDESolver-1242"><span class="linenos">1242</span></a><span class="sd">        ndarray</span>
</span><span id="PDESolver-1243"><a href="#PDESolver-1243"><span class="linenos">1243</span></a><span class="sd">            Result of applying all operators with their coefficients</span>
</span><span id="PDESolver-1244"><a href="#PDESolver-1244"><span class="linenos">1244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1245"><a href="#PDESolver-1245"><span class="linenos">1245</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;psi_ops&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="p">:</span>
</span><span id="PDESolver-1246"><a href="#PDESolver-1246"><span class="linenos">1246</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No pseudo-differential operators defined&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1247"><a href="#PDESolver-1247"><span class="linenos">1247</span></a>        
</span><span id="PDESolver-1248"><a href="#PDESolver-1248"><span class="linenos">1248</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
</span><span id="PDESolver-1249"><a href="#PDESolver-1249"><span class="linenos">1249</span></a>        
</span><span id="PDESolver-1250"><a href="#PDESolver-1250"><span class="linenos">1250</span></a>        <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">psi_op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="p">:</span>
</span><span id="PDESolver-1251"><a href="#PDESolver-1251"><span class="linenos">1251</span></a>            <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
</span><span id="PDESolver-1252"><a href="#PDESolver-1252"><span class="linenos">1252</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1253"><a href="#PDESolver-1253"><span class="linenos">1253</span></a>                <span class="n">contribution</span> <span class="o">=</span> <span class="n">psi_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="PDESolver-1254"><a href="#PDESolver-1254"><span class="linenos">1254</span></a>                    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PDESolver-1255"><a href="#PDESolver-1255"><span class="linenos">1255</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver-1256"><a href="#PDESolver-1256"><span class="linenos">1256</span></a>                    <span class="n">kx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver-1257"><a href="#PDESolver-1257"><span class="linenos">1257</span></a>                    <span class="n">boundary_condition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">,</span>
</span><span id="PDESolver-1258"><a href="#PDESolver-1258"><span class="linenos">1258</span></a>                    <span class="n">dealiasing_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-1259"><a href="#PDESolver-1259"><span class="linenos">1259</span></a>                <span class="p">)</span>
</span><span id="PDESolver-1260"><a href="#PDESolver-1260"><span class="linenos">1260</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1261"><a href="#PDESolver-1261"><span class="linenos">1261</span></a>                <span class="n">contribution</span> <span class="o">=</span> <span class="n">psi_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="PDESolver-1262"><a href="#PDESolver-1262"><span class="linenos">1262</span></a>                    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
</span><span id="PDESolver-1263"><a href="#PDESolver-1263"><span class="linenos">1263</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver-1264"><a href="#PDESolver-1264"><span class="linenos">1264</span></a>                    <span class="n">kx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver-1265"><a href="#PDESolver-1265"><span class="linenos">1265</span></a>                    <span class="n">y_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">,</span>
</span><span id="PDESolver-1266"><a href="#PDESolver-1266"><span class="linenos">1266</span></a>                    <span class="n">ky</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">,</span>
</span><span id="PDESolver-1267"><a href="#PDESolver-1267"><span class="linenos">1267</span></a>                    <span class="n">boundary_condition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">,</span>
</span><span id="PDESolver-1268"><a href="#PDESolver-1268"><span class="linenos">1268</span></a>                    <span class="n">dealiasing_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-1269"><a href="#PDESolver-1269"><span class="linenos">1269</span></a>                <span class="p">)</span>
</span><span id="PDESolver-1270"><a href="#PDESolver-1270"><span class="linenos">1270</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1271"><a href="#PDESolver-1271"><span class="linenos">1271</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1272"><a href="#PDESolver-1272"><span class="linenos">1272</span></a>            
</span><span id="PDESolver-1273"><a href="#PDESolver-1273"><span class="linenos">1273</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">contribution</span>
</span><span id="PDESolver-1274"><a href="#PDESolver-1274"><span class="linenos">1274</span></a>        
</span><span id="PDESolver-1275"><a href="#PDESolver-1275"><span class="linenos">1275</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="PDESolver-1276"><a href="#PDESolver-1276"><span class="linenos">1276</span></a>
</span><span id="PDESolver-1277"><a href="#PDESolver-1277"><span class="linenos">1277</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_step_order1_with_psi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_contribution</span><span class="p">):</span>
</span><span id="PDESolver-1278"><a href="#PDESolver-1278"><span class="linenos">1278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1279"><a href="#PDESolver-1279"><span class="linenos">1279</span></a><span class="sd">        Perform one time step of a first-order evolution using a pseudo-differential operator.</span>
</span><span id="PDESolver-1280"><a href="#PDESolver-1280"><span class="linenos">1280</span></a><span class="sd">    </span>
</span><span id="PDESolver-1281"><a href="#PDESolver-1281"><span class="linenos">1281</span></a><span class="sd">        This method updates the solution field using an exponential integrator or explicit Euler scheme,</span>
</span><span id="PDESolver-1282"><a href="#PDESolver-1282"><span class="linenos">1282</span></a><span class="sd">        depending on boundary conditions and the structure of the pseudo-differential symbol.</span>
</span><span id="PDESolver-1283"><a href="#PDESolver-1283"><span class="linenos">1283</span></a><span class="sd">        It supports:</span>
</span><span id="PDESolver-1284"><a href="#PDESolver-1284"><span class="linenos">1284</span></a><span class="sd">        - Linear dynamics via pseudo-differential operator L (possibly nonlocal)</span>
</span><span id="PDESolver-1285"><a href="#PDESolver-1285"><span class="linenos">1285</span></a><span class="sd">        - Nonlinear terms computed via spectral differentiation</span>
</span><span id="PDESolver-1286"><a href="#PDESolver-1286"><span class="linenos">1286</span></a><span class="sd">        - External source contributions</span>
</span><span id="PDESolver-1287"><a href="#PDESolver-1287"><span class="linenos">1287</span></a><span class="sd">    </span>
</span><span id="PDESolver-1288"><a href="#PDESolver-1288"><span class="linenos">1288</span></a><span class="sd">        The update follows **three distinct computational paths**:</span>
</span><span id="PDESolver-1289"><a href="#PDESolver-1289"><span class="linenos">1289</span></a><span class="sd">    </span>
</span><span id="PDESolver-1290"><a href="#PDESolver-1290"><span class="linenos">1290</span></a><span class="sd">        1. **Periodic boundaries + diagonalizable symbol**  </span>
</span><span id="PDESolver-1291"><a href="#PDESolver-1291"><span class="linenos">1291</span></a><span class="sd">           Symbol is constant in space → use direct Fourier-based exponential integrator:  </span>
</span><span id="PDESolver-1292"><a href="#PDESolver-1292"><span class="linenos">1292</span></a><span class="sd">               uₙ₊₁ = e⁻ᴸΔᵗ ⋅ uₙ + Δt ⋅ φ₁(−LΔt) ⋅ (N(uₙ) + F)</span>
</span><span id="PDESolver-1293"><a href="#PDESolver-1293"><span class="linenos">1293</span></a><span class="sd">    </span>
</span><span id="PDESolver-1294"><a href="#PDESolver-1294"><span class="linenos">1294</span></a><span class="sd">        2. **Non-diagonalizable but spatially uniform symbol**  </span>
</span><span id="PDESolver-1295"><a href="#PDESolver-1295"><span class="linenos">1295</span></a><span class="sd">           General exponential time differencing of order 1:  </span>
</span><span id="PDESolver-1296"><a href="#PDESolver-1296"><span class="linenos">1296</span></a><span class="sd">               uₙ₊₁ = eᴸΔᵗ ⋅ uₙ + Δt ⋅ φ₁(LΔt) ⋅ (N(uₙ) + F)</span>
</span><span id="PDESolver-1297"><a href="#PDESolver-1297"><span class="linenos">1297</span></a><span class="sd">    </span>
</span><span id="PDESolver-1298"><a href="#PDESolver-1298"><span class="linenos">1298</span></a><span class="sd">        3. **Spatially varying symbol**  </span>
</span><span id="PDESolver-1299"><a href="#PDESolver-1299"><span class="linenos">1299</span></a><span class="sd">           No frequency diagonalization available → use explicit Euler:  </span>
</span><span id="PDESolver-1300"><a href="#PDESolver-1300"><span class="linenos">1300</span></a><span class="sd">               uₙ₊₁ = uₙ + Δt ⋅ (L(uₙ) + N(uₙ) + F)</span>
</span><span id="PDESolver-1301"><a href="#PDESolver-1301"><span class="linenos">1301</span></a><span class="sd">    </span>
</span><span id="PDESolver-1302"><a href="#PDESolver-1302"><span class="linenos">1302</span></a><span class="sd">        where:</span>
</span><span id="PDESolver-1303"><a href="#PDESolver-1303"><span class="linenos">1303</span></a><span class="sd">            L(uₙ) = linear part via pseudo-differential operator</span>
</span><span id="PDESolver-1304"><a href="#PDESolver-1304"><span class="linenos">1304</span></a><span class="sd">            N(uₙ) = nonlinear contribution at current time step</span>
</span><span id="PDESolver-1305"><a href="#PDESolver-1305"><span class="linenos">1305</span></a><span class="sd">            F     = external source term</span>
</span><span id="PDESolver-1306"><a href="#PDESolver-1306"><span class="linenos">1306</span></a><span class="sd">            Δt    = time step size</span>
</span><span id="PDESolver-1307"><a href="#PDESolver-1307"><span class="linenos">1307</span></a><span class="sd">            φ₁(z) = (eᶻ − 1)/z (with safe handling near z=0)</span>
</span><span id="PDESolver-1308"><a href="#PDESolver-1308"><span class="linenos">1308</span></a><span class="sd">    </span>
</span><span id="PDESolver-1309"><a href="#PDESolver-1309"><span class="linenos">1309</span></a><span class="sd">        Boundary conditions are applied after each update to ensure consistency.</span>
</span><span id="PDESolver-1310"><a href="#PDESolver-1310"><span class="linenos">1310</span></a><span class="sd">    </span>
</span><span id="PDESolver-1311"><a href="#PDESolver-1311"><span class="linenos">1311</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1312"><a href="#PDESolver-1312"><span class="linenos">1312</span></a><span class="sd">            source_contribution (np.ndarray): Array representing the external source term at current time step.</span>
</span><span id="PDESolver-1313"><a href="#PDESolver-1313"><span class="linenos">1313</span></a><span class="sd">                                              Must match the spatial dimensions of self.u_prev.</span>
</span><span id="PDESolver-1314"><a href="#PDESolver-1314"><span class="linenos">1314</span></a><span class="sd">    </span>
</span><span id="PDESolver-1315"><a href="#PDESolver-1315"><span class="linenos">1315</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1316"><a href="#PDESolver-1316"><span class="linenos">1316</span></a><span class="sd">            np.ndarray: Updated solution array after one time step.</span>
</span><span id="PDESolver-1317"><a href="#PDESolver-1317"><span class="linenos">1317</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1318"><a href="#PDESolver-1318"><span class="linenos">1318</span></a>        <span class="c1"># Handling null source</span>
</span><span id="PDESolver-1319"><a href="#PDESolver-1319"><span class="linenos">1319</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">source_contribution</span><span class="p">):</span>
</span><span id="PDESolver-1320"><a href="#PDESolver-1320"><span class="linenos">1320</span></a>            <span class="n">source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1321"><a href="#PDESolver-1321"><span class="linenos">1321</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1322"><a href="#PDESolver-1322"><span class="linenos">1322</span></a>            <span class="n">source</span> <span class="o">=</span> <span class="n">source_contribution</span>
</span><span id="PDESolver-1323"><a href="#PDESolver-1323"><span class="linenos">1323</span></a>
</span><span id="PDESolver-1324"><a href="#PDESolver-1324"><span class="linenos">1324</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_spectral_filter</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="PDESolver-1325"><a href="#PDESolver-1325"><span class="linenos">1325</span></a>            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1326"><a href="#PDESolver-1326"><span class="linenos">1326</span></a>                <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1327"><a href="#PDESolver-1327"><span class="linenos">1327</span></a>                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1328"><a href="#PDESolver-1328"><span class="linenos">1328</span></a>                <span class="n">k</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span id="PDESolver-1329"><a href="#PDESolver-1329"><span class="linenos">1329</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">)</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span>
</span><span id="PDESolver-1330"><a href="#PDESolver-1330"><span class="linenos">1330</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
</span><span id="PDESolver-1331"><a href="#PDESolver-1331"><span class="linenos">1331</span></a>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1332"><a href="#PDESolver-1332"><span class="linenos">1332</span></a>                <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1333"><a href="#PDESolver-1333"><span class="linenos">1333</span></a>                <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PDESolver-1334"><a href="#PDESolver-1334"><span class="linenos">1334</span></a>                <span class="n">ky</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">Ny</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="PDESolver-1335"><a href="#PDESolver-1335"><span class="linenos">1335</span></a>                <span class="n">kx</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">Nx</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="PDESolver-1336"><a href="#PDESolver-1336"><span class="linenos">1336</span></a>                <span class="n">k_squared</span> <span class="o">=</span> <span class="n">kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ky</span><span class="o">**</span><span class="mi">2</span>
</span><span id="PDESolver-1337"><a href="#PDESolver-1337"><span class="linenos">1337</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k_squared</span><span class="p">)</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">)</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span>
</span><span id="PDESolver-1338"><a href="#PDESolver-1338"><span class="linenos">1338</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
</span><span id="PDESolver-1339"><a href="#PDESolver-1339"><span class="linenos">1339</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1340"><a href="#PDESolver-1340"><span class="linenos">1340</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D arrays are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1341"><a href="#PDESolver-1341"><span class="linenos">1341</span></a>
</span><span id="PDESolver-1342"><a href="#PDESolver-1342"><span class="linenos">1342</span></a>        <span class="c1"># Recalculate symbol if necessary</span>
</span><span id="PDESolver-1343"><a href="#PDESolver-1343"><span class="linenos">1343</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
</span><span id="PDESolver-1344"><a href="#PDESolver-1344"><span class="linenos">1344</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_symbol_tables</span><span class="p">()</span>  <span class="c1"># Recalculates self.combined_symbol</span>
</span><span id="PDESolver-1345"><a href="#PDESolver-1345"><span class="linenos">1345</span></a>    
</span><span id="PDESolver-1346"><a href="#PDESolver-1346"><span class="linenos">1346</span></a>        <span class="c1"># Case with FFT (symbol diagonalizable in Fourier space)</span>
</span><span id="PDESolver-1347"><a href="#PDESolver-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
</span><span id="PDESolver-1348"><a href="#PDESolver-1348"><span class="linenos">1348</span></a>            <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1349"><a href="#PDESolver-1349"><span class="linenos">1349</span></a>            <span class="n">u_hat</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_symbol</span><span class="p">)</span>
</span><span id="PDESolver-1350"><a href="#PDESolver-1350"><span class="linenos">1350</span></a>            <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-1351"><a href="#PDESolver-1351"><span class="linenos">1351</span></a>            <span class="n">u_symb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-1352"><a href="#PDESolver-1352"><span class="linenos">1352</span></a>            <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1353"><a href="#PDESolver-1353"><span class="linenos">1353</span></a>            <span class="n">u_new</span> <span class="o">=</span> <span class="n">u_symb</span> <span class="o">+</span> <span class="n">u_nl</span> <span class="o">+</span> <span class="n">source</span>
</span><span id="PDESolver-1354"><a href="#PDESolver-1354"><span class="linenos">1354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1355"><a href="#PDESolver-1355"><span class="linenos">1355</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
</span><span id="PDESolver-1356"><a href="#PDESolver-1356"><span class="linenos">1356</span></a>                <span class="c1"># General case with ETD1</span>
</span><span id="PDESolver-1357"><a href="#PDESolver-1357"><span class="linenos">1357</span></a>                <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1358"><a href="#PDESolver-1358"><span class="linenos">1358</span></a>    
</span><span id="PDESolver-1359"><a href="#PDESolver-1359"><span class="linenos">1359</span></a>                <span class="c1"># Calculation of exp(dt * L) and phi1(dt * L)</span>
</span><span id="PDESolver-1360"><a href="#PDESolver-1360"><span class="linenos">1360</span></a>                <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_symbol</span>  <span class="c1"># Uses the updated symbol</span>
</span><span id="PDESolver-1361"><a href="#PDESolver-1361"><span class="linenos">1361</span></a>                <span class="n">exp_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-1362"><a href="#PDESolver-1362"><span class="linenos">1362</span></a>                <span class="n">phi1_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp_L</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-1363"><a href="#PDESolver-1363"><span class="linenos">1363</span></a>                <span class="n">phi1_L</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phi1_L</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Handling division by zero</span>
</span><span id="PDESolver-1364"><a href="#PDESolver-1364"><span class="linenos">1364</span></a>    
</span><span id="PDESolver-1365"><a href="#PDESolver-1365"><span class="linenos">1365</span></a>                <span class="c1"># Fourier transform</span>
</span><span id="PDESolver-1366"><a href="#PDESolver-1366"><span class="linenos">1366</span></a>                <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1367"><a href="#PDESolver-1367"><span class="linenos">1367</span></a>                <span class="n">u_nl_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u_nl</span><span class="p">)</span>
</span><span id="PDESolver-1368"><a href="#PDESolver-1368"><span class="linenos">1368</span></a>                <span class="n">source_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="PDESolver-1369"><a href="#PDESolver-1369"><span class="linenos">1369</span></a>    
</span><span id="PDESolver-1370"><a href="#PDESolver-1370"><span class="linenos">1370</span></a>                <span class="c1"># Assembling the solution in Fourier space</span>
</span><span id="PDESolver-1371"><a href="#PDESolver-1371"><span class="linenos">1371</span></a>                <span class="n">u_hat_new</span> <span class="o">=</span> <span class="n">exp_L</span> <span class="o">*</span> <span class="n">u_hat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">phi1_L</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_nl_hat</span> <span class="o">+</span> <span class="n">source_hat</span><span class="p">)</span>
</span><span id="PDESolver-1372"><a href="#PDESolver-1372"><span class="linenos">1372</span></a>                <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat_new</span><span class="p">)</span>
</span><span id="PDESolver-1373"><a href="#PDESolver-1373"><span class="linenos">1373</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1374"><a href="#PDESolver-1374"><span class="linenos">1374</span></a>                <span class="c1"># if the symbol depends on spatial variables : Euler method</span>
</span><span id="PDESolver-1375"><a href="#PDESolver-1375"><span class="linenos">1375</span></a>                <span class="n">Lu_prev</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_psiOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1376"><a href="#PDESolver-1376"><span class="linenos">1376</span></a>                <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1377"><a href="#PDESolver-1377"><span class="linenos">1377</span></a>                <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">Lu_prev</span> <span class="o">+</span> <span class="n">u_nl</span> <span class="o">+</span> <span class="n">source</span><span class="p">)</span>
</span><span id="PDESolver-1378"><a href="#PDESolver-1378"><span class="linenos">1378</span></a>                <span class="n">u_new</span> <span class="o">=</span> <span class="n">_spectral_filter</span><span class="p">(</span><span class="n">u_new</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_ratio</span><span class="p">)</span>
</span><span id="PDESolver-1379"><a href="#PDESolver-1379"><span class="linenos">1379</span></a>        <span class="c1"># Applying boundary conditions</span>
</span><span id="PDESolver-1380"><a href="#PDESolver-1380"><span class="linenos">1380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
</span><span id="PDESolver-1381"><a href="#PDESolver-1381"><span class="linenos">1381</span></a>        <span class="k">return</span> <span class="n">u_new</span>
</span><span id="PDESolver-1382"><a href="#PDESolver-1382"><span class="linenos">1382</span></a>
</span><span id="PDESolver-1383"><a href="#PDESolver-1383"><span class="linenos">1383</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_step_order2_with_psi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_contribution</span><span class="p">):</span>
</span><span id="PDESolver-1384"><a href="#PDESolver-1384"><span class="linenos">1384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1385"><a href="#PDESolver-1385"><span class="linenos">1385</span></a><span class="sd">        Perform one time step of a second-order time evolution using a pseudo-differential operator.</span>
</span><span id="PDESolver-1386"><a href="#PDESolver-1386"><span class="linenos">1386</span></a><span class="sd">    </span>
</span><span id="PDESolver-1387"><a href="#PDESolver-1387"><span class="linenos">1387</span></a><span class="sd">        This method updates the solution field using a second-order accurate scheme suitable for wave-like equations.</span>
</span><span id="PDESolver-1388"><a href="#PDESolver-1388"><span class="linenos">1388</span></a><span class="sd">        The update includes contributions from:</span>
</span><span id="PDESolver-1389"><a href="#PDESolver-1389"><span class="linenos">1389</span></a><span class="sd">        - Linear dynamics via a pseudo-differential operator (e.g., dispersion or stiffness)</span>
</span><span id="PDESolver-1390"><a href="#PDESolver-1390"><span class="linenos">1390</span></a><span class="sd">        - Nonlinear terms computed via spectral differentiation</span>
</span><span id="PDESolver-1391"><a href="#PDESolver-1391"><span class="linenos">1391</span></a><span class="sd">        - External source contributions</span>
</span><span id="PDESolver-1392"><a href="#PDESolver-1392"><span class="linenos">1392</span></a><span class="sd">    </span>
</span><span id="PDESolver-1393"><a href="#PDESolver-1393"><span class="linenos">1393</span></a><span class="sd">        Discretization follows a leapfrog-style finite difference in time:</span>
</span><span id="PDESolver-1394"><a href="#PDESolver-1394"><span class="linenos">1394</span></a><span class="sd">        </span>
</span><span id="PDESolver-1395"><a href="#PDESolver-1395"><span class="linenos">1395</span></a><span class="sd">            uₙ₊₁ = 2uₙ − uₙ₋₁ + Δt² ⋅ (L(uₙ) + N(uₙ) + F)</span>
</span><span id="PDESolver-1396"><a href="#PDESolver-1396"><span class="linenos">1396</span></a><span class="sd">    </span>
</span><span id="PDESolver-1397"><a href="#PDESolver-1397"><span class="linenos">1397</span></a><span class="sd">        where:</span>
</span><span id="PDESolver-1398"><a href="#PDESolver-1398"><span class="linenos">1398</span></a><span class="sd">            L(uₙ) = linear part evaluated via pseudo-differential operator</span>
</span><span id="PDESolver-1399"><a href="#PDESolver-1399"><span class="linenos">1399</span></a><span class="sd">            N(uₙ) = nonlinear contribution at current time step</span>
</span><span id="PDESolver-1400"><a href="#PDESolver-1400"><span class="linenos">1400</span></a><span class="sd">            F     = external source term at current time step</span>
</span><span id="PDESolver-1401"><a href="#PDESolver-1401"><span class="linenos">1401</span></a><span class="sd">            Δt    = time step size</span>
</span><span id="PDESolver-1402"><a href="#PDESolver-1402"><span class="linenos">1402</span></a><span class="sd">    </span>
</span><span id="PDESolver-1403"><a href="#PDESolver-1403"><span class="linenos">1403</span></a><span class="sd">        Boundary conditions are applied after each update to ensure consistency.</span>
</span><span id="PDESolver-1404"><a href="#PDESolver-1404"><span class="linenos">1404</span></a><span class="sd">    </span>
</span><span id="PDESolver-1405"><a href="#PDESolver-1405"><span class="linenos">1405</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1406"><a href="#PDESolver-1406"><span class="linenos">1406</span></a><span class="sd">            source_contribution (np.ndarray): Array representing the external source term at current time step.</span>
</span><span id="PDESolver-1407"><a href="#PDESolver-1407"><span class="linenos">1407</span></a><span class="sd">                                              Must match the spatial dimensions of self.u_prev.</span>
</span><span id="PDESolver-1408"><a href="#PDESolver-1408"><span class="linenos">1408</span></a><span class="sd">    </span>
</span><span id="PDESolver-1409"><a href="#PDESolver-1409"><span class="linenos">1409</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1410"><a href="#PDESolver-1410"><span class="linenos">1410</span></a><span class="sd">            np.ndarray: Updated solution array after one time step.</span>
</span><span id="PDESolver-1411"><a href="#PDESolver-1411"><span class="linenos">1411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1412"><a href="#PDESolver-1412"><span class="linenos">1412</span></a>        <span class="n">Lu_prev</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_psiOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1413"><a href="#PDESolver-1413"><span class="linenos">1413</span></a>        <span class="n">rhs_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-1414"><a href="#PDESolver-1414"><span class="linenos">1414</span></a>        <span class="n">u_new</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_prev2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Lu_prev</span> <span class="o">+</span> <span class="n">rhs_nl</span> <span class="o">+</span> <span class="n">source_contribution</span><span class="p">)</span>
</span><span id="PDESolver-1415"><a href="#PDESolver-1415"><span class="linenos">1415</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
</span><span id="PDESolver-1416"><a href="#PDESolver-1416"><span class="linenos">1416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u_prev2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span>
</span><span id="PDESolver-1417"><a href="#PDESolver-1417"><span class="linenos">1417</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">u_new</span>
</span><span id="PDESolver-1418"><a href="#PDESolver-1418"><span class="linenos">1418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u_new</span>
</span><span id="PDESolver-1419"><a href="#PDESolver-1419"><span class="linenos">1419</span></a>        <span class="k">return</span> <span class="n">u_new</span>
</span><span id="PDESolver-1420"><a href="#PDESolver-1420"><span class="linenos">1420</span></a>
</span><span id="PDESolver-1421"><a href="#PDESolver-1421"><span class="linenos">1421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-1422"><a href="#PDESolver-1422"><span class="linenos">1422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1423"><a href="#PDESolver-1423"><span class="linenos">1423</span></a><span class="sd">        Solve the partial differential equation numerically using spectral methods.</span>
</span><span id="PDESolver-1424"><a href="#PDESolver-1424"><span class="linenos">1424</span></a><span class="sd">        </span>
</span><span id="PDESolver-1425"><a href="#PDESolver-1425"><span class="linenos">1425</span></a><span class="sd">        This method evolves the solution in time using a combination of:</span>
</span><span id="PDESolver-1426"><a href="#PDESolver-1426"><span class="linenos">1426</span></a><span class="sd">        - Fourier-based linear evolution (with dealiasing)</span>
</span><span id="PDESolver-1427"><a href="#PDESolver-1427"><span class="linenos">1427</span></a><span class="sd">        - Nonlinear term handling via pseudo-spectral evaluation</span>
</span><span id="PDESolver-1428"><a href="#PDESolver-1428"><span class="linenos">1428</span></a><span class="sd">        - Support for pseudo-differential operators (psiOp)</span>
</span><span id="PDESolver-1429"><a href="#PDESolver-1429"><span class="linenos">1429</span></a><span class="sd">        - Source terms and boundary conditions</span>
</span><span id="PDESolver-1430"><a href="#PDESolver-1430"><span class="linenos">1430</span></a><span class="sd">        </span>
</span><span id="PDESolver-1431"><a href="#PDESolver-1431"><span class="linenos">1431</span></a><span class="sd">        The solver supports:</span>
</span><span id="PDESolver-1432"><a href="#PDESolver-1432"><span class="linenos">1432</span></a><span class="sd">        - 1D and 2D spatial domains</span>
</span><span id="PDESolver-1433"><a href="#PDESolver-1433"><span class="linenos">1433</span></a><span class="sd">        - First and second-order time evolution</span>
</span><span id="PDESolver-1434"><a href="#PDESolver-1434"><span class="linenos">1434</span></a><span class="sd">        - Periodic and Dirichlet boundary conditions</span>
</span><span id="PDESolver-1435"><a href="#PDESolver-1435"><span class="linenos">1435</span></a><span class="sd">        - Time-stepping schemes: default, ETD-RK4</span>
</span><span id="PDESolver-1436"><a href="#PDESolver-1436"><span class="linenos">1436</span></a><span class="sd">        </span>
</span><span id="PDESolver-1437"><a href="#PDESolver-1437"><span class="linenos">1437</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1438"><a href="#PDESolver-1438"><span class="linenos">1438</span></a><span class="sd">            list[np.ndarray]: A list of solution arrays at each saved time frame.</span>
</span><span id="PDESolver-1439"><a href="#PDESolver-1439"><span class="linenos">1439</span></a><span class="sd">        </span>
</span><span id="PDESolver-1440"><a href="#PDESolver-1440"><span class="linenos">1440</span></a><span class="sd">        Side Effects:</span>
</span><span id="PDESolver-1441"><a href="#PDESolver-1441"><span class="linenos">1441</span></a><span class="sd">            - Updates self.frames: stores solution snapshots</span>
</span><span id="PDESolver-1442"><a href="#PDESolver-1442"><span class="linenos">1442</span></a><span class="sd">            - Updates self.energy_history: records total energy if enabled</span>
</span><span id="PDESolver-1443"><a href="#PDESolver-1443"><span class="linenos">1443</span></a><span class="sd">            </span>
</span><span id="PDESolver-1444"><a href="#PDESolver-1444"><span class="linenos">1444</span></a><span class="sd">        Algorithm Overview:</span>
</span><span id="PDESolver-1445"><a href="#PDESolver-1445"><span class="linenos">1445</span></a><span class="sd">            For each time step:</span>
</span><span id="PDESolver-1446"><a href="#PDESolver-1446"><span class="linenos">1446</span></a><span class="sd">                1. Evaluate source contributions (if any)</span>
</span><span id="PDESolver-1447"><a href="#PDESolver-1447"><span class="linenos">1447</span></a><span class="sd">                2. Apply time evolution:</span>
</span><span id="PDESolver-1448"><a href="#PDESolver-1448"><span class="linenos">1448</span></a><span class="sd">                    - Order 1:</span>
</span><span id="PDESolver-1449"><a href="#PDESolver-1449"><span class="linenos">1449</span></a><span class="sd">                        - With psiOp: uses step_order1_with_psi</span>
</span><span id="PDESolver-1450"><a href="#PDESolver-1450"><span class="linenos">1450</span></a><span class="sd">                        - With ETD-RK4: exponential time differencing</span>
</span><span id="PDESolver-1451"><a href="#PDESolver-1451"><span class="linenos">1451</span></a><span class="sd">                        - Default: linear + nonlinear update</span>
</span><span id="PDESolver-1452"><a href="#PDESolver-1452"><span class="linenos">1452</span></a><span class="sd">                    - Order 2:</span>
</span><span id="PDESolver-1453"><a href="#PDESolver-1453"><span class="linenos">1453</span></a><span class="sd">                        - With psiOp: uses step_order2_with_psi</span>
</span><span id="PDESolver-1454"><a href="#PDESolver-1454"><span class="linenos">1454</span></a><span class="sd">                        - With ETD-RK4: second-order exponential scheme</span>
</span><span id="PDESolver-1455"><a href="#PDESolver-1455"><span class="linenos">1455</span></a><span class="sd">                        - Default: second-order leapfrog-style update</span>
</span><span id="PDESolver-1456"><a href="#PDESolver-1456"><span class="linenos">1456</span></a><span class="sd">                3. Enforce boundary conditions</span>
</span><span id="PDESolver-1457"><a href="#PDESolver-1457"><span class="linenos">1457</span></a><span class="sd">                4. Save solution snapshot periodically</span>
</span><span id="PDESolver-1458"><a href="#PDESolver-1458"><span class="linenos">1458</span></a><span class="sd">                5. Record energy (for second-order systems without psiOp)</span>
</span><span id="PDESolver-1459"><a href="#PDESolver-1459"><span class="linenos">1459</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1460"><a href="#PDESolver-1460"><span class="linenos">1460</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*******************&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1461"><a href="#PDESolver-1461"><span class="linenos">1461</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* Solving the PDE *&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1462"><a href="#PDESolver-1462"><span class="linenos">1462</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*******************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1463"><a href="#PDESolver-1463"><span class="linenos">1463</span></a>        <span class="n">save_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
</span><span id="PDESolver-1464"><a href="#PDESolver-1464"><span class="linenos">1464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver-1465"><a href="#PDESolver-1465"><span class="linenos">1465</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">):</span>
</span><span id="PDESolver-1466"><a href="#PDESolver-1466"><span class="linenos">1466</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;source_terms&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver-1467"><a href="#PDESolver-1467"><span class="linenos">1467</span></a>                <span class="n">source_contribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="PDESolver-1468"><a href="#PDESolver-1468"><span class="linenos">1468</span></a>                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver-1469"><a href="#PDESolver-1469"><span class="linenos">1469</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-1470"><a href="#PDESolver-1470"><span class="linenos">1470</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1471"><a href="#PDESolver-1471"><span class="linenos">1471</span></a>                            <span class="n">source_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1472"><a href="#PDESolver-1472"><span class="linenos">1472</span></a>                            <span class="n">source_contribution</span> <span class="o">+=</span> <span class="n">source_func</span><span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver-1473"><a href="#PDESolver-1473"><span class="linenos">1473</span></a>                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1474"><a href="#PDESolver-1474"><span class="linenos">1474</span></a>                            <span class="n">source_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1475"><a href="#PDESolver-1475"><span class="linenos">1475</span></a>                            <span class="n">source_contribution</span> <span class="o">+=</span> <span class="n">source_func</span><span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PDESolver-1476"><a href="#PDESolver-1476"><span class="linenos">1476</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PDESolver-1477"><a href="#PDESolver-1477"><span class="linenos">1477</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error evaluating source term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1478"><a href="#PDESolver-1478"><span class="linenos">1478</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1479"><a href="#PDESolver-1479"><span class="linenos">1479</span></a>                <span class="n">source_contribution</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-1480"><a href="#PDESolver-1480"><span class="linenos">1480</span></a>
</span><span id="PDESolver-1481"><a href="#PDESolver-1481"><span class="linenos">1481</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1482"><a href="#PDESolver-1482"><span class="linenos">1482</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-1483"><a href="#PDESolver-1483"><span class="linenos">1483</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_order1_with_psi</span><span class="p">(</span><span class="n">source_contribution</span><span class="p">)</span>
</span><span id="PDESolver-1484"><a href="#PDESolver-1484"><span class="linenos">1484</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time_scheme&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scheme</span> <span class="o">==</span> <span class="s1">&#39;ETD-RK4&#39;</span><span class="p">:</span>
</span><span id="PDESolver-1485"><a href="#PDESolver-1485"><span class="linenos">1485</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_ETD_RK4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1486"><a href="#PDESolver-1486"><span class="linenos">1486</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1487"><a href="#PDESolver-1487"><span class="linenos">1487</span></a>                    <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1488"><a href="#PDESolver-1488"><span class="linenos">1488</span></a>                    <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_L</span>
</span><span id="PDESolver-1489"><a href="#PDESolver-1489"><span class="linenos">1489</span></a>                    <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver-1490"><a href="#PDESolver-1490"><span class="linenos">1490</span></a>                    <span class="n">u_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-1491"><a href="#PDESolver-1491"><span class="linenos">1491</span></a>                    <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">u_lin</span><span class="p">)</span>
</span><span id="PDESolver-1492"><a href="#PDESolver-1492"><span class="linenos">1492</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="n">u_lin</span> <span class="o">+</span> <span class="n">u_nl</span> <span class="o">+</span> <span class="n">source_contribution</span>
</span><span id="PDESolver-1493"><a href="#PDESolver-1493"><span class="linenos">1493</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
</span><span id="PDESolver-1494"><a href="#PDESolver-1494"><span class="linenos">1494</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">u_new</span>
</span><span id="PDESolver-1495"><a href="#PDESolver-1495"><span class="linenos">1495</span></a>
</span><span id="PDESolver-1496"><a href="#PDESolver-1496"><span class="linenos">1496</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1497"><a href="#PDESolver-1497"><span class="linenos">1497</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-1498"><a href="#PDESolver-1498"><span class="linenos">1498</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_order2_with_psi</span><span class="p">(</span><span class="n">source_contribution</span><span class="p">)</span>
</span><span id="PDESolver-1499"><a href="#PDESolver-1499"><span class="linenos">1499</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1500"><a href="#PDESolver-1500"><span class="linenos">1500</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time_scheme&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scheme</span> <span class="o">==</span> <span class="s1">&#39;ETD-RK4&#39;</span><span class="p">:</span>
</span><span id="PDESolver-1501"><a href="#PDESolver-1501"><span class="linenos">1501</span></a>                        <span class="n">u_new</span><span class="p">,</span> <span class="n">v_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_ETD_RK4_order2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">)</span>
</span><span id="PDESolver-1502"><a href="#PDESolver-1502"><span class="linenos">1502</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1503"><a href="#PDESolver-1503"><span class="linenos">1503</span></a>                        <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver-1504"><a href="#PDESolver-1504"><span class="linenos">1504</span></a>                        <span class="n">v_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">)</span>
</span><span id="PDESolver-1505"><a href="#PDESolver-1505"><span class="linenos">1505</span></a>                        <span class="n">u_new_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_omega_dt</span> <span class="o">*</span> <span class="n">u_hat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sin_omega_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_omega</span> <span class="o">*</span> <span class="n">v_hat</span>
</span><span id="PDESolver-1506"><a href="#PDESolver-1506"><span class="linenos">1506</span></a>                        <span class="n">v_new_hat</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_val</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sin_omega_dt</span> <span class="o">*</span> <span class="n">u_hat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_omega_dt</span> <span class="o">*</span> <span class="n">v_hat</span>
</span><span id="PDESolver-1507"><a href="#PDESolver-1507"><span class="linenos">1507</span></a>                        <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_new_hat</span><span class="p">)</span>
</span><span id="PDESolver-1508"><a href="#PDESolver-1508"><span class="linenos">1508</span></a>                        <span class="n">v_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">v_new_hat</span><span class="p">)</span>
</span><span id="PDESolver-1509"><a href="#PDESolver-1509"><span class="linenos">1509</span></a>                        <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-1510"><a href="#PDESolver-1510"><span class="linenos">1510</span></a>                        <span class="n">v_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-1511"><a href="#PDESolver-1511"><span class="linenos">1511</span></a>                        <span class="n">u_new</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_nl</span> <span class="o">+</span> <span class="n">source_contribution</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="PDESolver-1512"><a href="#PDESolver-1512"><span class="linenos">1512</span></a>                        <span class="n">v_new</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_nl</span> <span class="o">+</span> <span class="n">source_contribution</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="PDESolver-1513"><a href="#PDESolver-1513"><span class="linenos">1513</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
</span><span id="PDESolver-1514"><a href="#PDESolver-1514"><span class="linenos">1514</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">v_new</span><span class="p">)</span>
</span><span id="PDESolver-1515"><a href="#PDESolver-1515"><span class="linenos">1515</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">u_new</span>
</span><span id="PDESolver-1516"><a href="#PDESolver-1516"><span class="linenos">1516</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span> <span class="o">=</span> <span class="n">v_new</span>
</span><span id="PDESolver-1517"><a href="#PDESolver-1517"><span class="linenos">1517</span></a>
</span><span id="PDESolver-1518"><a href="#PDESolver-1518"><span class="linenos">1518</span></a>            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">save_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver-1519"><a href="#PDESolver-1519"><span class="linenos">1519</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="PDESolver-1520"><a href="#PDESolver-1520"><span class="linenos">1520</span></a>
</span><span id="PDESolver-1521"><a href="#PDESolver-1521"><span class="linenos">1521</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">):</span>
</span><span id="PDESolver-1522"><a href="#PDESolver-1522"><span class="linenos">1522</span></a>                <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_energy</span><span class="p">()</span>
</span><span id="PDESolver-1523"><a href="#PDESolver-1523"><span class="linenos">1523</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
</span><span id="PDESolver-1524"><a href="#PDESolver-1524"><span class="linenos">1524</span></a>
</span><span id="PDESolver-1525"><a href="#PDESolver-1525"><span class="linenos">1525</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span>  
</span><span id="PDESolver-1526"><a href="#PDESolver-1526"><span class="linenos">1526</span></a>                
</span><span id="PDESolver-1527"><a href="#PDESolver-1527"><span class="linenos">1527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stationary_psiOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="PDESolver-1528"><a href="#PDESolver-1528"><span class="linenos">1528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1529"><a href="#PDESolver-1529"><span class="linenos">1529</span></a><span class="sd">        Solve stationary pseudo-differential equations of the form P[u] = f(x) or P[u] = f(x,y) using asymptotic inversion.</span>
</span><span id="PDESolver-1530"><a href="#PDESolver-1530"><span class="linenos">1530</span></a><span class="sd">    </span>
</span><span id="PDESolver-1531"><a href="#PDESolver-1531"><span class="linenos">1531</span></a><span class="sd">        This method computes the solution to a stationary (time-independent) pseudo-differential equation</span>
</span><span id="PDESolver-1532"><a href="#PDESolver-1532"><span class="linenos">1532</span></a><span class="sd">        where the operator P is defined via symbolic expressions (psiOp). It constructs an asymptotic right inverse R </span>
</span><span id="PDESolver-1533"><a href="#PDESolver-1533"><span class="linenos">1533</span></a><span class="sd">        such that P∘R ≈ Id, then applies it to the source term f using either direct Fourier multiplication </span>
</span><span id="PDESolver-1534"><a href="#PDESolver-1534"><span class="linenos">1534</span></a><span class="sd">        (when the symbol is spatially independent) or Kohn–Nirenberg quantization (when spatial dependence is present).</span>
</span><span id="PDESolver-1535"><a href="#PDESolver-1535"><span class="linenos">1535</span></a><span class="sd">    </span>
</span><span id="PDESolver-1536"><a href="#PDESolver-1536"><span class="linenos">1536</span></a><span class="sd">        The inversion is based on the principal symbol of the operator and its asymptotic expansion up to the given order.</span>
</span><span id="PDESolver-1537"><a href="#PDESolver-1537"><span class="linenos">1537</span></a><span class="sd">        Ellipticity of the symbol is checked numerically before inversion to ensure well-posedness.</span>
</span><span id="PDESolver-1538"><a href="#PDESolver-1538"><span class="linenos">1538</span></a><span class="sd">    </span>
</span><span id="PDESolver-1539"><a href="#PDESolver-1539"><span class="linenos">1539</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1540"><a href="#PDESolver-1540"><span class="linenos">1540</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-1541"><a href="#PDESolver-1541"><span class="linenos">1541</span></a><span class="sd">        order : int, default=3</span>
</span><span id="PDESolver-1542"><a href="#PDESolver-1542"><span class="linenos">1542</span></a><span class="sd">            Order of the asymptotic expansion used to construct the right inverse of the pseudo-differential operator.</span>
</span><span id="PDESolver-1543"><a href="#PDESolver-1543"><span class="linenos">1543</span></a><span class="sd">        method : str, optional</span>
</span><span id="PDESolver-1544"><a href="#PDESolver-1544"><span class="linenos">1544</span></a><span class="sd">            Inversion strategy:</span>
</span><span id="PDESolver-1545"><a href="#PDESolver-1545"><span class="linenos">1545</span></a><span class="sd">            - &#39;diagonal&#39; (default): Fast approximate inversion using diagonal operators in frequency space.</span>
</span><span id="PDESolver-1546"><a href="#PDESolver-1546"><span class="linenos">1546</span></a><span class="sd">            - &#39;full&#39;                : Pointwise exact inversion (slower but more accurate).</span>
</span><span id="PDESolver-1547"><a href="#PDESolver-1547"><span class="linenos">1547</span></a><span class="sd">    </span>
</span><span id="PDESolver-1548"><a href="#PDESolver-1548"><span class="linenos">1548</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver-1549"><a href="#PDESolver-1549"><span class="linenos">1549</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-1550"><a href="#PDESolver-1550"><span class="linenos">1550</span></a><span class="sd">        ndarray</span>
</span><span id="PDESolver-1551"><a href="#PDESolver-1551"><span class="linenos">1551</span></a><span class="sd">            The computed solution u(x) in 1D or u(x, y) in 2D as a NumPy array over the spatial grid.</span>
</span><span id="PDESolver-1552"><a href="#PDESolver-1552"><span class="linenos">1552</span></a><span class="sd">    </span>
</span><span id="PDESolver-1553"><a href="#PDESolver-1553"><span class="linenos">1553</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-1554"><a href="#PDESolver-1554"><span class="linenos">1554</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-1555"><a href="#PDESolver-1555"><span class="linenos">1555</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver-1556"><a href="#PDESolver-1556"><span class="linenos">1556</span></a><span class="sd">            If no pseudo-differential operator (psiOp) is defined.</span>
</span><span id="PDESolver-1557"><a href="#PDESolver-1557"><span class="linenos">1557</span></a><span class="sd">            If linear or nonlinear terms other than psiOp are present.</span>
</span><span id="PDESolver-1558"><a href="#PDESolver-1558"><span class="linenos">1558</span></a><span class="sd">            If the symbol is not elliptic on the grid.</span>
</span><span id="PDESolver-1559"><a href="#PDESolver-1559"><span class="linenos">1559</span></a><span class="sd">            If no source term is provided for the right-hand side.</span>
</span><span id="PDESolver-1560"><a href="#PDESolver-1560"><span class="linenos">1560</span></a><span class="sd">    </span>
</span><span id="PDESolver-1561"><a href="#PDESolver-1561"><span class="linenos">1561</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-1562"><a href="#PDESolver-1562"><span class="linenos">1562</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-1563"><a href="#PDESolver-1563"><span class="linenos">1563</span></a><span class="sd">        - The method assumes the problem is fully stationary: time derivatives must be absent.</span>
</span><span id="PDESolver-1564"><a href="#PDESolver-1564"><span class="linenos">1564</span></a><span class="sd">        - Requires the equation to be purely pseudo-differential (no Op, Derivative, or nonlinear terms).</span>
</span><span id="PDESolver-1565"><a href="#PDESolver-1565"><span class="linenos">1565</span></a><span class="sd">        - Symbol evaluation and inversion are dimension-aware (supports both 1D and 2D problems).</span>
</span><span id="PDESolver-1566"><a href="#PDESolver-1566"><span class="linenos">1566</span></a><span class="sd">        - Supports optimization paths when the symbol does not depend on spatial variables.</span>
</span><span id="PDESolver-1567"><a href="#PDESolver-1567"><span class="linenos">1567</span></a><span class="sd">    </span>
</span><span id="PDESolver-1568"><a href="#PDESolver-1568"><span class="linenos">1568</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver-1569"><a href="#PDESolver-1569"><span class="linenos">1569</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-1570"><a href="#PDESolver-1570"><span class="linenos">1570</span></a><span class="sd">        right_inverse_asymptotic : Constructs the asymptotic inverse of the pseudo-differential operator.</span>
</span><span id="PDESolver-1571"><a href="#PDESolver-1571"><span class="linenos">1571</span></a><span class="sd">        kohn_nirenberg           : Numerical implementation of general pseudo-differential operators.</span>
</span><span id="PDESolver-1572"><a href="#PDESolver-1572"><span class="linenos">1572</span></a><span class="sd">        is_elliptic_numerically  : Verifies numerical ellipticity of the symbol.</span>
</span><span id="PDESolver-1573"><a href="#PDESolver-1573"><span class="linenos">1573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1574"><a href="#PDESolver-1574"><span class="linenos">1574</span></a>
</span><span id="PDESolver-1575"><a href="#PDESolver-1575"><span class="linenos">1575</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1576"><a href="#PDESolver-1576"><span class="linenos">1576</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Solving the stationnary PDE *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1577"><a href="#PDESolver-1577"><span class="linenos">1577</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*******************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1578"><a href="#PDESolver-1578"><span class="linenos">1578</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;boundary condition: &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">)</span>
</span><span id="PDESolver-1579"><a href="#PDESolver-1579"><span class="linenos">1579</span></a>        
</span><span id="PDESolver-1580"><a href="#PDESolver-1580"><span class="linenos">1580</span></a>
</span><span id="PDESolver-1581"><a href="#PDESolver-1581"><span class="linenos">1581</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver-1582"><a href="#PDESolver-1582"><span class="linenos">1582</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only supports problems with psiOp.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1583"><a href="#PDESolver-1583"><span class="linenos">1583</span></a>    
</span><span id="PDESolver-1584"><a href="#PDESolver-1584"><span class="linenos">1584</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">:</span>
</span><span id="PDESolver-1585"><a href="#PDESolver-1585"><span class="linenos">1585</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stationary psiOp problems must be linear and purely pseudo-differential.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1586"><a href="#PDESolver-1586"><span class="linenos">1586</span></a>
</span><span id="PDESolver-1587"><a href="#PDESolver-1587"><span class="linenos">1587</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;periodic&#39;</span><span class="p">,</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">):</span>
</span><span id="PDESolver-1588"><a href="#PDESolver-1588"><span class="linenos">1588</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PDESolver-1589"><a href="#PDESolver-1589"><span class="linenos">1589</span></a>                <span class="s2">&quot;For stationary PDEs, boundary conditions must be explicitly defined. &quot;</span>
</span><span id="PDESolver-1590"><a href="#PDESolver-1590"><span class="linenos">1590</span></a>                <span class="s2">&quot;Supported types are &#39;periodic&#39; and &#39;dirichlet&#39;.&quot;</span>
</span><span id="PDESolver-1591"><a href="#PDESolver-1591"><span class="linenos">1591</span></a>            <span class="p">)</span>    
</span><span id="PDESolver-1592"><a href="#PDESolver-1592"><span class="linenos">1592</span></a>            
</span><span id="PDESolver-1593"><a href="#PDESolver-1593"><span class="linenos">1593</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1594"><a href="#PDESolver-1594"><span class="linenos">1594</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
</span><span id="PDESolver-1595"><a href="#PDESolver-1595"><span class="linenos">1595</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-1596"><a href="#PDESolver-1596"><span class="linenos">1596</span></a>            <span class="n">spatial_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>
</span><span id="PDESolver-1597"><a href="#PDESolver-1597"><span class="linenos">1597</span></a>            <span class="n">freq_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="p">,)</span>
</span><span id="PDESolver-1598"><a href="#PDESolver-1598"><span class="linenos">1598</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">KX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span>
</span><span id="PDESolver-1599"><a href="#PDESolver-1599"><span class="linenos">1599</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1600"><a href="#PDESolver-1600"><span class="linenos">1600</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
</span><span id="PDESolver-1601"><a href="#PDESolver-1601"><span class="linenos">1601</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-1602"><a href="#PDESolver-1602"><span class="linenos">1602</span></a>            <span class="n">spatial_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="PDESolver-1603"><a href="#PDESolver-1603"><span class="linenos">1603</span></a>            <span class="n">freq_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="PDESolver-1604"><a href="#PDESolver-1604"><span class="linenos">1604</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span>
</span><span id="PDESolver-1605"><a href="#PDESolver-1605"><span class="linenos">1605</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1606"><a href="#PDESolver-1606"><span class="linenos">1606</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported spatial dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1607"><a href="#PDESolver-1607"><span class="linenos">1607</span></a>    
</span><span id="PDESolver-1608"><a href="#PDESolver-1608"><span class="linenos">1608</span></a>        <span class="n">total_symbol</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff</span> <span class="o">*</span> <span class="n">psi</span><span class="o">.</span><span class="n">expr</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">psi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="p">)</span>
</span><span id="PDESolver-1609"><a href="#PDESolver-1609"><span class="linenos">1609</span></a>        <span class="n">psi_total</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">total_symbol</span><span class="p">,</span> <span class="n">spatial_vars</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1610"><a href="#PDESolver-1610"><span class="linenos">1610</span></a>    
</span><span id="PDESolver-1611"><a href="#PDESolver-1611"><span class="linenos">1611</span></a>        <span class="c1"># Check ellipticity</span>
</span><span id="PDESolver-1612"><a href="#PDESolver-1612"><span class="linenos">1612</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1613"><a href="#PDESolver-1613"><span class="linenos">1613</span></a>            <span class="n">is_elliptic</span> <span class="o">=</span> <span class="n">psi_total</span><span class="o">.</span><span class="n">is_elliptic_numerically</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">KX</span><span class="p">)</span>
</span><span id="PDESolver-1614"><a href="#PDESolver-1614"><span class="linenos">1614</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1615"><a href="#PDESolver-1615"><span class="linenos">1615</span></a>            <span class="n">is_elliptic</span> <span class="o">=</span> <span class="n">psi_total</span><span class="o">.</span><span class="n">is_elliptic_numerically</span><span class="p">((</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="p">(</span><span class="n">KX</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">KY</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
</span><span id="PDESolver-1616"><a href="#PDESolver-1616"><span class="linenos">1616</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_elliptic</span><span class="p">:</span>
</span><span id="PDESolver-1617"><a href="#PDESolver-1617"><span class="linenos">1617</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;❌ The pseudo-differential symbol is not numerically elliptic on the grid.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1618"><a href="#PDESolver-1618"><span class="linenos">1618</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Elliptic pseudo-differential symbol: inversion allowed.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1619"><a href="#PDESolver-1619"><span class="linenos">1619</span></a>    
</span><span id="PDESolver-1620"><a href="#PDESolver-1620"><span class="linenos">1620</span></a>        <span class="n">R_symbol</span> <span class="o">=</span> <span class="n">psi_total</span><span class="o">.</span><span class="n">right_inverse_asymptotic</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span><span id="PDESolver-1621"><a href="#PDESolver-1621"><span class="linenos">1621</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Right inverse asymptotic symbol:&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1622"><a href="#PDESolver-1622"><span class="linenos">1622</span></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">R_symbol</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver-1623"><a href="#PDESolver-1623"><span class="linenos">1623</span></a>        
</span><span id="PDESolver-1624"><a href="#PDESolver-1624"><span class="linenos">1624</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver-1625"><a href="#PDESolver-1625"><span class="linenos">1625</span></a>        <span class="c1"># FIX: Always lambdify with all variables for consistency</span>
</span><span id="PDESolver-1626"><a href="#PDESolver-1626"><span class="linenos">1626</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver-1627"><a href="#PDESolver-1627"><span class="linenos">1627</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1628"><a href="#PDESolver-1628"><span class="linenos">1628</span></a>            <span class="c1"># Always include both x and xi in the signature</span>
</span><span id="PDESolver-1629"><a href="#PDESolver-1629"><span class="linenos">1629</span></a>            <span class="n">R_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">R_symbol</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1630"><a href="#PDESolver-1630"><span class="linenos">1630</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1631"><a href="#PDESolver-1631"><span class="linenos">1631</span></a>            <span class="c1"># Always include all four variables</span>
</span><span id="PDESolver-1632"><a href="#PDESolver-1632"><span class="linenos">1632</span></a>            <span class="n">R_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">R_symbol</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1633"><a href="#PDESolver-1633"><span class="linenos">1633</span></a>        
</span><span id="PDESolver-1634"><a href="#PDESolver-1634"><span class="linenos">1634</span></a>        <span class="c1"># Prepare right-hand side</span>
</span><span id="PDESolver-1635"><a href="#PDESolver-1635"><span class="linenos">1635</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver-1636"><a href="#PDESolver-1636"><span class="linenos">1636</span></a>            <span class="n">f_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">)</span>
</span><span id="PDESolver-1637"><a href="#PDESolver-1637"><span class="linenos">1637</span></a>            <span class="n">used_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spatial_vars</span> <span class="k">if</span> <span class="n">f_expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
</span><span id="PDESolver-1638"><a href="#PDESolver-1638"><span class="linenos">1638</span></a>            <span class="n">f_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">(</span><span class="n">used_vars</span><span class="p">,</span> <span class="o">-</span><span class="n">f_expr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1639"><a href="#PDESolver-1639"><span class="linenos">1639</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1640"><a href="#PDESolver-1640"><span class="linenos">1640</span></a>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">f_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">)</span> <span class="k">if</span> <span class="n">used_vars</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PDESolver-1641"><a href="#PDESolver-1641"><span class="linenos">1641</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1642"><a href="#PDESolver-1642"><span class="linenos">1642</span></a>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">f_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="k">if</span> <span class="n">used_vars</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver-1643"><a href="#PDESolver-1643"><span class="linenos">1643</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span><span class="p">:</span>
</span><span id="PDESolver-1644"><a href="#PDESolver-1644"><span class="linenos">1644</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Initial condition should be None for stationnary equation.&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1645"><a href="#PDESolver-1645"><span class="linenos">1645</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1646"><a href="#PDESolver-1646"><span class="linenos">1646</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No source term provided to construct the right-hand side.&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1647"><a href="#PDESolver-1647"><span class="linenos">1647</span></a>        
</span><span id="PDESolver-1648"><a href="#PDESolver-1648"><span class="linenos">1648</span></a>        <span class="n">f_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
</span><span id="PDESolver-1649"><a href="#PDESolver-1649"><span class="linenos">1649</span></a>        
</span><span id="PDESolver-1650"><a href="#PDESolver-1650"><span class="linenos">1650</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver-1651"><a href="#PDESolver-1651"><span class="linenos">1651</span></a>        <span class="c1"># Application of the inverse operator</span>
</span><span id="PDESolver-1652"><a href="#PDESolver-1652"><span class="linenos">1652</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver-1653"><a href="#PDESolver-1653"><span class="linenos">1653</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PDESolver-1654"><a href="#PDESolver-1654"><span class="linenos">1654</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1655"><a href="#PDESolver-1655"><span class="linenos">1655</span></a>                <span class="c1"># Check if optimization is possible</span>
</span><span id="PDESolver-1656"><a href="#PDESolver-1656"><span class="linenos">1656</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">R_symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="PDESolver-1657"><a href="#PDESolver-1657"><span class="linenos">1657</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚡ Optimization: symbol independent of x – direct product in Fourier.&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1658"><a href="#PDESolver-1658"><span class="linenos">1658</span></a>                    <span class="c1"># Create wrapper that ignores x</span>
</span><span id="PDESolver-1659"><a href="#PDESolver-1659"><span class="linenos">1659</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">_R_func_optimized</span><span class="p">(</span><span class="n">kx_val</span><span class="p">):</span>
</span><span id="PDESolver-1660"><a href="#PDESolver-1660"><span class="linenos">1660</span></a>                        <span class="k">return</span> <span class="n">R_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">kx_val</span><span class="p">)</span>  <span class="c1"># x=0 since it doesn&#39;t matter</span>
</span><span id="PDESolver-1661"><a href="#PDESolver-1661"><span class="linenos">1661</span></a>                    
</span><span id="PDESolver-1662"><a href="#PDESolver-1662"><span class="linenos">1662</span></a>                    <span class="n">R_vals</span> <span class="o">=</span> <span class="n">_R_func_optimized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span>
</span><span id="PDESolver-1663"><a href="#PDESolver-1663"><span class="linenos">1663</span></a>                    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">R_vals</span> <span class="o">*</span> <span class="n">f_hat</span>
</span><span id="PDESolver-1664"><a href="#PDESolver-1664"><span class="linenos">1664</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-1665"><a href="#PDESolver-1665"><span class="linenos">1665</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1666"><a href="#PDESolver-1666"><span class="linenos">1666</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚙️ 1D Kohn-Nirenberg Quantification&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1667"><a href="#PDESolver-1667"><span class="linenos">1667</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">psiop</span><span class="w"> </span><span class="kn">import</span> <span class="n">kohn_nirenberg_fft</span>
</span><span id="PDESolver-1668"><a href="#PDESolver-1668"><span class="linenos">1668</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_fft</span><span class="p">(</span>
</span><span id="PDESolver-1669"><a href="#PDESolver-1669"><span class="linenos">1669</span></a>                        <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver-1670"><a href="#PDESolver-1670"><span class="linenos">1670</span></a>                        <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span><span class="p">,</span>  <span class="c1"># Now has correct signature (x, xi)</span>
</span><span id="PDESolver-1671"><a href="#PDESolver-1671"><span class="linenos">1671</span></a>                        <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver-1672"><a href="#PDESolver-1672"><span class="linenos">1672</span></a>                        <span class="n">kx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver-1673"><a href="#PDESolver-1673"><span class="linenos">1673</span></a>                        <span class="n">fft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span>
</span><span id="PDESolver-1674"><a href="#PDESolver-1674"><span class="linenos">1674</span></a>                        <span class="n">ifft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">,</span>
</span><span id="PDESolver-1675"><a href="#PDESolver-1675"><span class="linenos">1675</span></a>                        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="PDESolver-1676"><a href="#PDESolver-1676"><span class="linenos">1676</span></a>                    <span class="p">)</span>
</span><span id="PDESolver-1677"><a href="#PDESolver-1677"><span class="linenos">1677</span></a>                    
</span><span id="PDESolver-1678"><a href="#PDESolver-1678"><span class="linenos">1678</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1679"><a href="#PDESolver-1679"><span class="linenos">1679</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">R_symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">R_symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
</span><span id="PDESolver-1680"><a href="#PDESolver-1680"><span class="linenos">1680</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚡ Optimization: Symbol independent of x and y – direct product in 2D Fourier.&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1681"><a href="#PDESolver-1681"><span class="linenos">1681</span></a>                    <span class="c1"># Create wrapper that ignores x, y</span>
</span><span id="PDESolver-1682"><a href="#PDESolver-1682"><span class="linenos">1682</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">_R_func_optimized</span><span class="p">(</span><span class="n">kx_val</span><span class="p">,</span> <span class="n">ky_val</span><span class="p">):</span>
</span><span id="PDESolver-1683"><a href="#PDESolver-1683"><span class="linenos">1683</span></a>                        <span class="k">return</span> <span class="n">R_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">kx_val</span><span class="p">,</span> <span class="n">ky_val</span><span class="p">)</span>
</span><span id="PDESolver-1684"><a href="#PDESolver-1684"><span class="linenos">1684</span></a>                    
</span><span id="PDESolver-1685"><a href="#PDESolver-1685"><span class="linenos">1685</span></a>                    <span class="n">R_vals</span> <span class="o">=</span> <span class="n">_R_func_optimized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-1686"><a href="#PDESolver-1686"><span class="linenos">1686</span></a>                    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">R_vals</span> <span class="o">*</span> <span class="n">f_hat</span>
</span><span id="PDESolver-1687"><a href="#PDESolver-1687"><span class="linenos">1687</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver-1688"><a href="#PDESolver-1688"><span class="linenos">1688</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1689"><a href="#PDESolver-1689"><span class="linenos">1689</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚙️ 2D Kohn-Nirenberg Quantification&#39;</span><span class="p">)</span>
</span><span id="PDESolver-1690"><a href="#PDESolver-1690"><span class="linenos">1690</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">psiop</span><span class="w"> </span><span class="kn">import</span> <span class="n">kohn_nirenberg_fft</span>
</span><span id="PDESolver-1691"><a href="#PDESolver-1691"><span class="linenos">1691</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_fft</span><span class="p">(</span>
</span><span id="PDESolver-1692"><a href="#PDESolver-1692"><span class="linenos">1692</span></a>                        <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver-1693"><a href="#PDESolver-1693"><span class="linenos">1693</span></a>                        <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span><span class="p">,</span>  <span class="c1"># Now has correct signature (x, y, xi, eta)</span>
</span><span id="PDESolver-1694"><a href="#PDESolver-1694"><span class="linenos">1694</span></a>                        <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver-1695"><a href="#PDESolver-1695"><span class="linenos">1695</span></a>                        <span class="n">kx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver-1696"><a href="#PDESolver-1696"><span class="linenos">1696</span></a>                        <span class="n">fft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span>
</span><span id="PDESolver-1697"><a href="#PDESolver-1697"><span class="linenos">1697</span></a>                        <span class="n">ifft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">,</span>
</span><span id="PDESolver-1698"><a href="#PDESolver-1698"><span class="linenos">1698</span></a>                        <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="PDESolver-1699"><a href="#PDESolver-1699"><span class="linenos">1699</span></a>                        <span class="n">y_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">,</span>
</span><span id="PDESolver-1700"><a href="#PDESolver-1700"><span class="linenos">1700</span></a>                        <span class="n">ky</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ky</span>
</span><span id="PDESolver-1701"><a href="#PDESolver-1701"><span class="linenos">1701</span></a>                    <span class="p">)</span>
</span><span id="PDESolver-1702"><a href="#PDESolver-1702"><span class="linenos">1702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>
</span><span id="PDESolver-1703"><a href="#PDESolver-1703"><span class="linenos">1703</span></a>            <span class="k">return</span> <span class="n">u</span>
</span><span id="PDESolver-1704"><a href="#PDESolver-1704"><span class="linenos">1704</span></a>            
</span><span id="PDESolver-1705"><a href="#PDESolver-1705"><span class="linenos">1705</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">:</span>
</span><span id="PDESolver-1706"><a href="#PDESolver-1706"><span class="linenos">1706</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">psiop</span><span class="w"> </span><span class="kn">import</span> <span class="n">kohn_nirenberg_nonperiodic</span>
</span><span id="PDESolver-1707"><a href="#PDESolver-1707"><span class="linenos">1707</span></a>            
</span><span id="PDESolver-1708"><a href="#PDESolver-1708"><span class="linenos">1708</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1709"><a href="#PDESolver-1709"><span class="linenos">1709</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PDESolver-1710"><a href="#PDESolver-1710"><span class="linenos">1710</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver-1711"><a href="#PDESolver-1711"><span class="linenos">1711</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver-1712"><a href="#PDESolver-1712"><span class="linenos">1712</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver-1713"><a href="#PDESolver-1713"><span class="linenos">1713</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span>  <span class="c1"># Now has correct signature (x, xi)</span>
</span><span id="PDESolver-1714"><a href="#PDESolver-1714"><span class="linenos">1714</span></a>                <span class="p">)</span>
</span><span id="PDESolver-1715"><a href="#PDESolver-1715"><span class="linenos">1715</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1716"><a href="#PDESolver-1716"><span class="linenos">1716</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PDESolver-1717"><a href="#PDESolver-1717"><span class="linenos">1717</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver-1718"><a href="#PDESolver-1718"><span class="linenos">1718</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">),</span>
</span><span id="PDESolver-1719"><a href="#PDESolver-1719"><span class="linenos">1719</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">),</span>
</span><span id="PDESolver-1720"><a href="#PDESolver-1720"><span class="linenos">1720</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span>  <span class="c1"># Now has correct signature (x, y, xi, eta)</span>
</span><span id="PDESolver-1721"><a href="#PDESolver-1721"><span class="linenos">1721</span></a>                <span class="p">)</span>
</span><span id="PDESolver-1722"><a href="#PDESolver-1722"><span class="linenos">1722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>
</span><span id="PDESolver-1723"><a href="#PDESolver-1723"><span class="linenos">1723</span></a>            <span class="k">return</span> <span class="n">u</span>
</span><span id="PDESolver-1724"><a href="#PDESolver-1724"><span class="linenos">1724</span></a>        
</span><span id="PDESolver-1725"><a href="#PDESolver-1725"><span class="linenos">1725</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1726"><a href="#PDESolver-1726"><span class="linenos">1726</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid boundary condition &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="si">}</span><span class="s2">&#39;. Supported types are &#39;periodic&#39; and &#39;dirichlet&#39;.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1727"><a href="#PDESolver-1727"><span class="linenos">1727</span></a>        
</span><span id="PDESolver-1728"><a href="#PDESolver-1728"><span class="linenos">1728</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_step_ETD_RK4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver-1729"><a href="#PDESolver-1729"><span class="linenos">1729</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1730"><a href="#PDESolver-1730"><span class="linenos">1730</span></a><span class="sd">        Perform one Exponential Time Differencing Runge-Kutta of 4th order (ETD-RK4) time step </span>
</span><span id="PDESolver-1731"><a href="#PDESolver-1731"><span class="linenos">1731</span></a><span class="sd">        for first-order in time PDEs of the form:</span>
</span><span id="PDESolver-1732"><a href="#PDESolver-1732"><span class="linenos">1732</span></a><span class="sd">        </span>
</span><span id="PDESolver-1733"><a href="#PDESolver-1733"><span class="linenos">1733</span></a><span class="sd">            ∂ₜu = L u + N(u)</span>
</span><span id="PDESolver-1734"><a href="#PDESolver-1734"><span class="linenos">1734</span></a><span class="sd">        </span>
</span><span id="PDESolver-1735"><a href="#PDESolver-1735"><span class="linenos">1735</span></a><span class="sd">        where L is a linear operator (possibly nonlocal or pseudo-differential), and N is a </span>
</span><span id="PDESolver-1736"><a href="#PDESolver-1736"><span class="linenos">1736</span></a><span class="sd">        nonlinear term treated via pseudo-spectral methods. This method evaluates the </span>
</span><span id="PDESolver-1737"><a href="#PDESolver-1737"><span class="linenos">1737</span></a><span class="sd">        exponential integrator up to fourth-order accuracy in time.</span>
</span><span id="PDESolver-1738"><a href="#PDESolver-1738"><span class="linenos">1738</span></a><span class="sd">    </span>
</span><span id="PDESolver-1739"><a href="#PDESolver-1739"><span class="linenos">1739</span></a><span class="sd">        The ETD-RK4 scheme uses four stages to approximate the integral of the variation-of-constants formula:</span>
</span><span id="PDESolver-1740"><a href="#PDESolver-1740"><span class="linenos">1740</span></a><span class="sd">        </span>
</span><span id="PDESolver-1741"><a href="#PDESolver-1741"><span class="linenos">1741</span></a><span class="sd">            uⁿ⁺¹ = e^(L Δt) uⁿ + Δt ∫₀¹ e^(L Δt (1 - τ)) φ(N(u(τ))) dτ</span>
</span><span id="PDESolver-1742"><a href="#PDESolver-1742"><span class="linenos">1742</span></a><span class="sd">        </span>
</span><span id="PDESolver-1743"><a href="#PDESolver-1743"><span class="linenos">1743</span></a><span class="sd">        where φ denotes the nonlinear contributions evaluated at intermediate stages.</span>
</span><span id="PDESolver-1744"><a href="#PDESolver-1744"><span class="linenos">1744</span></a><span class="sd">    </span>
</span><span id="PDESolver-1745"><a href="#PDESolver-1745"><span class="linenos">1745</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1746"><a href="#PDESolver-1746"><span class="linenos">1746</span></a><span class="sd">            u (np.ndarray): Current solution in real space (physical grid values).</span>
</span><span id="PDESolver-1747"><a href="#PDESolver-1747"><span class="linenos">1747</span></a><span class="sd">    </span>
</span><span id="PDESolver-1748"><a href="#PDESolver-1748"><span class="linenos">1748</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1749"><a href="#PDESolver-1749"><span class="linenos">1749</span></a><span class="sd">            np.ndarray: Updated solution in real space after one ETD-RK4 time step.</span>
</span><span id="PDESolver-1750"><a href="#PDESolver-1750"><span class="linenos">1750</span></a><span class="sd">    </span>
</span><span id="PDESolver-1751"><a href="#PDESolver-1751"><span class="linenos">1751</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-1752"><a href="#PDESolver-1752"><span class="linenos">1752</span></a><span class="sd">        - The linear part L is diagonal in Fourier space and precomputed as self.L(k).</span>
</span><span id="PDESolver-1753"><a href="#PDESolver-1753"><span class="linenos">1753</span></a><span class="sd">        - Nonlinear terms are evaluated in physical space and transformed via FFT.</span>
</span><span id="PDESolver-1754"><a href="#PDESolver-1754"><span class="linenos">1754</span></a><span class="sd">        - The functions φ₁(z) and φ₂(z) are entire functions arising from the ETD scheme:</span>
</span><span id="PDESolver-1755"><a href="#PDESolver-1755"><span class="linenos">1755</span></a><span class="sd">          </span>
</span><span id="PDESolver-1756"><a href="#PDESolver-1756"><span class="linenos">1756</span></a><span class="sd">              φ₁(z) = (eᶻ - 1)/z   if z ≠ 0</span>
</span><span id="PDESolver-1757"><a href="#PDESolver-1757"><span class="linenos">1757</span></a><span class="sd">                     = 1            if z = 0</span>
</span><span id="PDESolver-1758"><a href="#PDESolver-1758"><span class="linenos">1758</span></a><span class="sd">    </span>
</span><span id="PDESolver-1759"><a href="#PDESolver-1759"><span class="linenos">1759</span></a><span class="sd">              φ₂(z) = (eᶻ - 1 - z)/z²   if z ≠ 0</span>
</span><span id="PDESolver-1760"><a href="#PDESolver-1760"><span class="linenos">1760</span></a><span class="sd">                     = ½              if z = 0</span>
</span><span id="PDESolver-1761"><a href="#PDESolver-1761"><span class="linenos">1761</span></a><span class="sd">    </span>
</span><span id="PDESolver-1762"><a href="#PDESolver-1762"><span class="linenos">1762</span></a><span class="sd">        - This implementation assumes periodic boundary conditions and uses spectral differentiation via FFT.</span>
</span><span id="PDESolver-1763"><a href="#PDESolver-1763"><span class="linenos">1763</span></a><span class="sd">        - See Hochbruck &amp; Ostermann (2010) for theoretical background on exponential integrators.</span>
</span><span id="PDESolver-1764"><a href="#PDESolver-1764"><span class="linenos">1764</span></a><span class="sd">    </span>
</span><span id="PDESolver-1765"><a href="#PDESolver-1765"><span class="linenos">1765</span></a><span class="sd">        See Also:</span>
</span><span id="PDESolver-1766"><a href="#PDESolver-1766"><span class="linenos">1766</span></a><span class="sd">            step_ETD_RK4_order2 : For second-order in time equations.</span>
</span><span id="PDESolver-1767"><a href="#PDESolver-1767"><span class="linenos">1767</span></a><span class="sd">            psiOp_apply           : For applying pseudo-differential operators.</span>
</span><span id="PDESolver-1768"><a href="#PDESolver-1768"><span class="linenos">1768</span></a><span class="sd">            apply_nonlinear      : For handling nonlinear terms in the PDE.</span>
</span><span id="PDESolver-1769"><a href="#PDESolver-1769"><span class="linenos">1769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1770"><a href="#PDESolver-1770"><span class="linenos">1770</span></a>        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="PDESolver-1771"><a href="#PDESolver-1771"><span class="linenos">1771</span></a>        <span class="n">L_fft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-1772"><a href="#PDESolver-1772"><span class="linenos">1772</span></a>    
</span><span id="PDESolver-1773"><a href="#PDESolver-1773"><span class="linenos">1773</span></a>        <span class="n">E</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">L_fft</span><span class="p">)</span>
</span><span id="PDESolver-1774"><a href="#PDESolver-1774"><span class="linenos">1774</span></a>        <span class="n">E2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">L_fft</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-1775"><a href="#PDESolver-1775"><span class="linenos">1775</span></a>    
</span><span id="PDESolver-1776"><a href="#PDESolver-1776"><span class="linenos">1776</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">phi1</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
</span><span id="PDESolver-1777"><a href="#PDESolver-1777"><span class="linenos">1777</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="PDESolver-1778"><a href="#PDESolver-1778"><span class="linenos">1778</span></a>    
</span><span id="PDESolver-1779"><a href="#PDESolver-1779"><span class="linenos">1779</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">phi2</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
</span><span id="PDESolver-1780"><a href="#PDESolver-1780"><span class="linenos">1780</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span id="PDESolver-1781"><a href="#PDESolver-1781"><span class="linenos">1781</span></a>    
</span><span id="PDESolver-1782"><a href="#PDESolver-1782"><span class="linenos">1782</span></a>        <span class="n">phi1_dtL</span> <span class="o">=</span> <span class="n">phi1</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">L_fft</span><span class="p">)</span>
</span><span id="PDESolver-1783"><a href="#PDESolver-1783"><span class="linenos">1783</span></a>        <span class="n">phi2_dtL</span> <span class="o">=</span> <span class="n">phi2</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">L_fft</span><span class="p">)</span>
</span><span id="PDESolver-1784"><a href="#PDESolver-1784"><span class="linenos">1784</span></a>    
</span><span id="PDESolver-1785"><a href="#PDESolver-1785"><span class="linenos">1785</span></a>        <span class="n">fft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span>
</span><span id="PDESolver-1786"><a href="#PDESolver-1786"><span class="linenos">1786</span></a>        <span class="n">ifft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span>
</span><span id="PDESolver-1787"><a href="#PDESolver-1787"><span class="linenos">1787</span></a>    
</span><span id="PDESolver-1788"><a href="#PDESolver-1788"><span class="linenos">1788</span></a>        <span class="n">u_hat</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1789"><a href="#PDESolver-1789"><span class="linenos">1789</span></a>        <span class="n">N1</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
</span><span id="PDESolver-1790"><a href="#PDESolver-1790"><span class="linenos">1790</span></a>    
</span><span id="PDESolver-1791"><a href="#PDESolver-1791"><span class="linenos">1791</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">E2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_hat</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">N1</span> <span class="o">*</span> <span class="n">phi1_dtL</span><span class="p">))</span>
</span><span id="PDESolver-1792"><a href="#PDESolver-1792"><span class="linenos">1792</span></a>        <span class="n">N2</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</span><span id="PDESolver-1793"><a href="#PDESolver-1793"><span class="linenos">1793</span></a>    
</span><span id="PDESolver-1794"><a href="#PDESolver-1794"><span class="linenos">1794</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">E2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_hat</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">N2</span> <span class="o">*</span> <span class="n">phi1_dtL</span><span class="p">))</span>
</span><span id="PDESolver-1795"><a href="#PDESolver-1795"><span class="linenos">1795</span></a>        <span class="n">N3</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</span><span id="PDESolver-1796"><a href="#PDESolver-1796"><span class="linenos">1796</span></a>    
</span><span id="PDESolver-1797"><a href="#PDESolver-1797"><span class="linenos">1797</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">E</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_hat</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">N3</span> <span class="o">*</span> <span class="n">phi1_dtL</span><span class="p">))</span>
</span><span id="PDESolver-1798"><a href="#PDESolver-1798"><span class="linenos">1798</span></a>        <span class="n">N4</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="PDESolver-1799"><a href="#PDESolver-1799"><span class="linenos">1799</span></a>    
</span><span id="PDESolver-1800"><a href="#PDESolver-1800"><span class="linenos">1800</span></a>        <span class="n">u_new_hat</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">u_hat</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="PDESolver-1801"><a href="#PDESolver-1801"><span class="linenos">1801</span></a>            <span class="n">N1</span> <span class="o">*</span> <span class="n">phi1_dtL</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N3</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi2_dtL</span> <span class="o">+</span> <span class="n">N4</span> <span class="o">*</span> <span class="n">phi1_dtL</span>
</span><span id="PDESolver-1802"><a href="#PDESolver-1802"><span class="linenos">1802</span></a>        <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
</span><span id="PDESolver-1803"><a href="#PDESolver-1803"><span class="linenos">1803</span></a>    
</span><span id="PDESolver-1804"><a href="#PDESolver-1804"><span class="linenos">1804</span></a>        <span class="k">return</span> <span class="n">ifft</span><span class="p">(</span><span class="n">u_new_hat</span><span class="p">)</span>
</span><span id="PDESolver-1805"><a href="#PDESolver-1805"><span class="linenos">1805</span></a>
</span><span id="PDESolver-1806"><a href="#PDESolver-1806"><span class="linenos">1806</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_step_ETD_RK4_order2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="PDESolver-1807"><a href="#PDESolver-1807"><span class="linenos">1807</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1808"><a href="#PDESolver-1808"><span class="linenos">1808</span></a><span class="sd">        Perform one time step of the Exponential Time Differencing Runge-Kutta 4th-order (ETD-RK4) scheme for second-order PDEs.</span>
</span><span id="PDESolver-1809"><a href="#PDESolver-1809"><span class="linenos">1809</span></a><span class="sd">    </span>
</span><span id="PDESolver-1810"><a href="#PDESolver-1810"><span class="linenos">1810</span></a><span class="sd">        This method evolves the solution u and its time derivative v forward in time by one step using the ETD-RK4 integrator. </span>
</span><span id="PDESolver-1811"><a href="#PDESolver-1811"><span class="linenos">1811</span></a><span class="sd">        It is designed for systems of the form:</span>
</span><span id="PDESolver-1812"><a href="#PDESolver-1812"><span class="linenos">1812</span></a><span class="sd">        </span>
</span><span id="PDESolver-1813"><a href="#PDESolver-1813"><span class="linenos">1813</span></a><span class="sd">            ∂ₜ²u = L u + N(u)</span>
</span><span id="PDESolver-1814"><a href="#PDESolver-1814"><span class="linenos">1814</span></a><span class="sd">            </span>
</span><span id="PDESolver-1815"><a href="#PDESolver-1815"><span class="linenos">1815</span></a><span class="sd">        where L is a linear operator and N is a nonlinear term computed via self._apply_nonlinear.</span>
</span><span id="PDESolver-1816"><a href="#PDESolver-1816"><span class="linenos">1816</span></a><span class="sd">        </span>
</span><span id="PDESolver-1817"><a href="#PDESolver-1817"><span class="linenos">1817</span></a><span class="sd">        The exponential integrator handles the linear part exactly in Fourier space, while the nonlinear terms are integrated </span>
</span><span id="PDESolver-1818"><a href="#PDESolver-1818"><span class="linenos">1818</span></a><span class="sd">        using a fourth-order Runge-Kutta-like approach. This ensures high accuracy and stability for stiff systems.</span>
</span><span id="PDESolver-1819"><a href="#PDESolver-1819"><span class="linenos">1819</span></a><span class="sd">    </span>
</span><span id="PDESolver-1820"><a href="#PDESolver-1820"><span class="linenos">1820</span></a><span class="sd">        Parameters:</span>
</span><span id="PDESolver-1821"><a href="#PDESolver-1821"><span class="linenos">1821</span></a><span class="sd">            u (np.ndarray): Current solution array in real space.</span>
</span><span id="PDESolver-1822"><a href="#PDESolver-1822"><span class="linenos">1822</span></a><span class="sd">            v (np.ndarray): Current time derivative of the solution (∂ₜu) in real space.</span>
</span><span id="PDESolver-1823"><a href="#PDESolver-1823"><span class="linenos">1823</span></a><span class="sd">    </span>
</span><span id="PDESolver-1824"><a href="#PDESolver-1824"><span class="linenos">1824</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1825"><a href="#PDESolver-1825"><span class="linenos">1825</span></a><span class="sd">            tuple: (u_new, v_new), updated solution and its time derivative after one time step.</span>
</span><span id="PDESolver-1826"><a href="#PDESolver-1826"><span class="linenos">1826</span></a><span class="sd">    </span>
</span><span id="PDESolver-1827"><a href="#PDESolver-1827"><span class="linenos">1827</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-1828"><a href="#PDESolver-1828"><span class="linenos">1828</span></a><span class="sd">            - Assumes periodic boundary conditions and uses FFT-based spectral methods.</span>
</span><span id="PDESolver-1829"><a href="#PDESolver-1829"><span class="linenos">1829</span></a><span class="sd">            - Handles both 1D and 2D problems seamlessly.</span>
</span><span id="PDESolver-1830"><a href="#PDESolver-1830"><span class="linenos">1830</span></a><span class="sd">            - Uses phi functions to compute exponential integrators efficiently.</span>
</span><span id="PDESolver-1831"><a href="#PDESolver-1831"><span class="linenos">1831</span></a><span class="sd">            - Suitable for wave equations and other second-order evolution equations with stiffness.</span>
</span><span id="PDESolver-1832"><a href="#PDESolver-1832"><span class="linenos">1832</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1833"><a href="#PDESolver-1833"><span class="linenos">1833</span></a>        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="PDESolver-1834"><a href="#PDESolver-1834"><span class="linenos">1834</span></a>    
</span><span id="PDESolver-1835"><a href="#PDESolver-1835"><span class="linenos">1835</span></a>        <span class="n">L_fft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-1836"><a href="#PDESolver-1836"><span class="linenos">1836</span></a>        <span class="n">fft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span>
</span><span id="PDESolver-1837"><a href="#PDESolver-1837"><span class="linenos">1837</span></a>        <span class="n">ifft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span>
</span><span id="PDESolver-1838"><a href="#PDESolver-1838"><span class="linenos">1838</span></a>    
</span><span id="PDESolver-1839"><a href="#PDESolver-1839"><span class="linenos">1839</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">rhs</span><span class="p">(</span><span class="n">u_val</span><span class="p">):</span>
</span><span id="PDESolver-1840"><a href="#PDESolver-1840"><span class="linenos">1840</span></a>            <span class="k">return</span> <span class="n">ifft</span><span class="p">(</span><span class="n">L_fft</span> <span class="o">*</span> <span class="n">fft</span><span class="p">(</span><span class="n">u_val</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">u_val</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver-1841"><a href="#PDESolver-1841"><span class="linenos">1841</span></a>    
</span><span id="PDESolver-1842"><a href="#PDESolver-1842"><span class="linenos">1842</span></a>        <span class="c1"># Stage A</span>
</span><span id="PDESolver-1843"><a href="#PDESolver-1843"><span class="linenos">1843</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-1844"><a href="#PDESolver-1844"><span class="linenos">1844</span></a>        <span class="n">ua</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">v</span>
</span><span id="PDESolver-1845"><a href="#PDESolver-1845"><span class="linenos">1845</span></a>        <span class="n">va</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">A</span>
</span><span id="PDESolver-1846"><a href="#PDESolver-1846"><span class="linenos">1846</span></a>    
</span><span id="PDESolver-1847"><a href="#PDESolver-1847"><span class="linenos">1847</span></a>        <span class="c1"># Stage B</span>
</span><span id="PDESolver-1848"><a href="#PDESolver-1848"><span class="linenos">1848</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">(</span><span class="n">ua</span><span class="p">)</span>
</span><span id="PDESolver-1849"><a href="#PDESolver-1849"><span class="linenos">1849</span></a>        <span class="n">ub</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">va</span>
</span><span id="PDESolver-1850"><a href="#PDESolver-1850"><span class="linenos">1850</span></a>        <span class="n">vb</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">B</span>
</span><span id="PDESolver-1851"><a href="#PDESolver-1851"><span class="linenos">1851</span></a>    
</span><span id="PDESolver-1852"><a href="#PDESolver-1852"><span class="linenos">1852</span></a>        <span class="c1"># Stage C</span>
</span><span id="PDESolver-1853"><a href="#PDESolver-1853"><span class="linenos">1853</span></a>        <span class="n">C</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
</span><span id="PDESolver-1854"><a href="#PDESolver-1854"><span class="linenos">1854</span></a>        <span class="n">uc</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">vb</span>
</span><span id="PDESolver-1855"><a href="#PDESolver-1855"><span class="linenos">1855</span></a>    
</span><span id="PDESolver-1856"><a href="#PDESolver-1856"><span class="linenos">1856</span></a>        <span class="c1"># Stage D</span>
</span><span id="PDESolver-1857"><a href="#PDESolver-1857"><span class="linenos">1857</span></a>        <span class="n">D</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">(</span><span class="n">uc</span><span class="p">)</span>
</span><span id="PDESolver-1858"><a href="#PDESolver-1858"><span class="linenos">1858</span></a>    
</span><span id="PDESolver-1859"><a href="#PDESolver-1859"><span class="linenos">1859</span></a>        <span class="c1"># Final update</span>
</span><span id="PDESolver-1860"><a href="#PDESolver-1860"><span class="linenos">1860</span></a>        <span class="n">u_new</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">C</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span>
</span><span id="PDESolver-1861"><a href="#PDESolver-1861"><span class="linenos">1861</span></a>        <span class="n">v_new</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">C</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span>
</span><span id="PDESolver-1862"><a href="#PDESolver-1862"><span class="linenos">1862</span></a>    
</span><span id="PDESolver-1863"><a href="#PDESolver-1863"><span class="linenos">1863</span></a>        <span class="k">return</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">v_new</span>
</span><span id="PDESolver-1864"><a href="#PDESolver-1864"><span class="linenos">1864</span></a>
</span><span id="PDESolver-1865"><a href="#PDESolver-1865"><span class="linenos">1865</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_cfl_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-1866"><a href="#PDESolver-1866"><span class="linenos">1866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1867"><a href="#PDESolver-1867"><span class="linenos">1867</span></a><span class="sd">        Check the CFL (Courant–Friedrichs–Lewymann) condition based on group velocity </span>
</span><span id="PDESolver-1868"><a href="#PDESolver-1868"><span class="linenos">1868</span></a><span class="sd">        for second-order time-dependent PDEs.</span>
</span><span id="PDESolver-1869"><a href="#PDESolver-1869"><span class="linenos">1869</span></a><span class="sd">    </span>
</span><span id="PDESolver-1870"><a href="#PDESolver-1870"><span class="linenos">1870</span></a><span class="sd">        This method verifies whether the chosen time step dt satisfies the numerical stability </span>
</span><span id="PDESolver-1871"><a href="#PDESolver-1871"><span class="linenos">1871</span></a><span class="sd">        condition derived from the maximum wave propagation speed in the system. It supports both </span>
</span><span id="PDESolver-1872"><a href="#PDESolver-1872"><span class="linenos">1872</span></a><span class="sd">        1D and 2D problems, with or without a symbolic dispersion relation ω(k).</span>
</span><span id="PDESolver-1873"><a href="#PDESolver-1873"><span class="linenos">1873</span></a><span class="sd">    </span>
</span><span id="PDESolver-1874"><a href="#PDESolver-1874"><span class="linenos">1874</span></a><span class="sd">        The CFL condition ensures that information does not propagate further than one grid cell </span>
</span><span id="PDESolver-1875"><a href="#PDESolver-1875"><span class="linenos">1875</span></a><span class="sd">        per time step. A safety factor of 0.5 is applied by default to ensure robustness.</span>
</span><span id="PDESolver-1876"><a href="#PDESolver-1876"><span class="linenos">1876</span></a><span class="sd">    </span>
</span><span id="PDESolver-1877"><a href="#PDESolver-1877"><span class="linenos">1877</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-1878"><a href="#PDESolver-1878"><span class="linenos">1878</span></a><span class="sd">        </span>
</span><span id="PDESolver-1879"><a href="#PDESolver-1879"><span class="linenos">1879</span></a><span class="sd">        - In 1D, the group velocity v₉(k) = dω/dk is used to compute the maximum wave speed.</span>
</span><span id="PDESolver-1880"><a href="#PDESolver-1880"><span class="linenos">1880</span></a><span class="sd">        - In 2D, the x- and y-directional group velocities are evaluated independently.</span>
</span><span id="PDESolver-1881"><a href="#PDESolver-1881"><span class="linenos">1881</span></a><span class="sd">        - If no dispersion relation is available, the imaginary part of the linear operator L(k) </span>
</span><span id="PDESolver-1882"><a href="#PDESolver-1882"><span class="linenos">1882</span></a><span class="sd">          is used as an approximation for wave speed.</span>
</span><span id="PDESolver-1883"><a href="#PDESolver-1883"><span class="linenos">1883</span></a><span class="sd">    </span>
</span><span id="PDESolver-1884"><a href="#PDESolver-1884"><span class="linenos">1884</span></a><span class="sd">        Raises:</span>
</span><span id="PDESolver-1885"><a href="#PDESolver-1885"><span class="linenos">1885</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-1886"><a href="#PDESolver-1886"><span class="linenos">1886</span></a><span class="sd">        NotImplementedError: </span>
</span><span id="PDESolver-1887"><a href="#PDESolver-1887"><span class="linenos">1887</span></a><span class="sd">            If the spatial dimension is not 1D or 2D.</span>
</span><span id="PDESolver-1888"><a href="#PDESolver-1888"><span class="linenos">1888</span></a><span class="sd">    </span>
</span><span id="PDESolver-1889"><a href="#PDESolver-1889"><span class="linenos">1889</span></a><span class="sd">        Prints:</span>
</span><span id="PDESolver-1890"><a href="#PDESolver-1890"><span class="linenos">1890</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-1891"><a href="#PDESolver-1891"><span class="linenos">1891</span></a><span class="sd">        Warning message if the current time step dt exceeds the CFL-stable limit.</span>
</span><span id="PDESolver-1892"><a href="#PDESolver-1892"><span class="linenos">1892</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1893"><a href="#PDESolver-1893"><span class="linenos">1893</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*****************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1894"><a href="#PDESolver-1894"><span class="linenos">1894</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* CFL condition *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1895"><a href="#PDESolver-1895"><span class="linenos">1895</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*****************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1896"><a href="#PDESolver-1896"><span class="linenos">1896</span></a>
</span><span id="PDESolver-1897"><a href="#PDESolver-1897"><span class="linenos">1897</span></a>        <span class="n">cfl_factor</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Safety factor</span>
</span><span id="PDESolver-1898"><a href="#PDESolver-1898"><span class="linenos">1898</span></a>        
</span><span id="PDESolver-1899"><a href="#PDESolver-1899"><span class="linenos">1899</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-1900"><a href="#PDESolver-1900"><span class="linenos">1900</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;omega&#39;</span><span class="p">):</span>
</span><span id="PDESolver-1901"><a href="#PDESolver-1901"><span class="linenos">1901</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span>
</span><span id="PDESolver-1902"><a href="#PDESolver-1902"><span class="linenos">1902</span></a>                <span class="n">omega_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">(</span><span class="n">k_vals</span><span class="p">))</span>
</span><span id="PDESolver-1903"><a href="#PDESolver-1903"><span class="linenos">1903</span></a>                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
</span><span id="PDESolver-1904"><a href="#PDESolver-1904"><span class="linenos">1904</span></a>                    <span class="n">v_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">omega_vals</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-1905"><a href="#PDESolver-1905"><span class="linenos">1905</span></a>                <span class="n">max_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_group</span><span class="p">))</span>
</span><span id="PDESolver-1906"><a href="#PDESolver-1906"><span class="linenos">1906</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1907"><a href="#PDESolver-1907"><span class="linenos">1907</span></a>                <span class="n">max_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">))))</span>
</span><span id="PDESolver-1908"><a href="#PDESolver-1908"><span class="linenos">1908</span></a>            
</span><span id="PDESolver-1909"><a href="#PDESolver-1909"><span class="linenos">1909</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
</span><span id="PDESolver-1910"><a href="#PDESolver-1910"><span class="linenos">1910</span></a>            <span class="n">cfl_limit</span> <span class="o">=</span> <span class="n">cfl_factor</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">max_speed</span> <span class="k">if</span> <span class="n">max_speed</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="PDESolver-1911"><a href="#PDESolver-1911"><span class="linenos">1911</span></a>            
</span><span id="PDESolver-1912"><a href="#PDESolver-1912"><span class="linenos">1912</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="n">cfl_limit</span><span class="p">:</span>
</span><span id="PDESolver-1913"><a href="#PDESolver-1913"><span class="linenos">1913</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CFL condition violated: dt = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2">, max allowed dt = </span><span class="si">{</span><span class="n">cfl_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1914"><a href="#PDESolver-1914"><span class="linenos">1914</span></a>    
</span><span id="PDESolver-1915"><a href="#PDESolver-1915"><span class="linenos">1915</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-1916"><a href="#PDESolver-1916"><span class="linenos">1916</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;omega&#39;</span><span class="p">):</span>
</span><span id="PDESolver-1917"><a href="#PDESolver-1917"><span class="linenos">1917</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span>
</span><span id="PDESolver-1918"><a href="#PDESolver-1918"><span class="linenos">1918</span></a>                <span class="n">omega_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="PDESolver-1919"><a href="#PDESolver-1919"><span class="linenos">1919</span></a>                <span class="n">omega_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">))</span>
</span><span id="PDESolver-1920"><a href="#PDESolver-1920"><span class="linenos">1920</span></a>                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
</span><span id="PDESolver-1921"><a href="#PDESolver-1921"><span class="linenos">1921</span></a>                    <span class="n">v_group_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">omega_x</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-1922"><a href="#PDESolver-1922"><span class="linenos">1922</span></a>                    <span class="n">v_group_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">omega_y</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-1923"><a href="#PDESolver-1923"><span class="linenos">1923</span></a>                <span class="n">max_speed_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_group_x</span><span class="p">))</span>
</span><span id="PDESolver-1924"><a href="#PDESolver-1924"><span class="linenos">1924</span></a>                <span class="n">max_speed_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_group_y</span><span class="p">))</span>
</span><span id="PDESolver-1925"><a href="#PDESolver-1925"><span class="linenos">1925</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1926"><a href="#PDESolver-1926"><span class="linenos">1926</span></a>                <span class="n">max_speed_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))))</span>
</span><span id="PDESolver-1927"><a href="#PDESolver-1927"><span class="linenos">1927</span></a>                <span class="n">max_speed_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">))))</span>
</span><span id="PDESolver-1928"><a href="#PDESolver-1928"><span class="linenos">1928</span></a>            
</span><span id="PDESolver-1929"><a href="#PDESolver-1929"><span class="linenos">1929</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
</span><span id="PDESolver-1930"><a href="#PDESolver-1930"><span class="linenos">1930</span></a>            <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span>
</span><span id="PDESolver-1931"><a href="#PDESolver-1931"><span class="linenos">1931</span></a>            <span class="n">cfl_limit</span> <span class="o">=</span> <span class="n">cfl_factor</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_speed_x</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">max_speed_y</span> <span class="o">/</span> <span class="n">dy</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_speed_x</span> <span class="o">+</span> <span class="n">max_speed_y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="PDESolver-1932"><a href="#PDESolver-1932"><span class="linenos">1932</span></a>            
</span><span id="PDESolver-1933"><a href="#PDESolver-1933"><span class="linenos">1933</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="n">cfl_limit</span><span class="p">:</span>
</span><span id="PDESolver-1934"><a href="#PDESolver-1934"><span class="linenos">1934</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CFL condition violated: dt = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2">, max allowed dt = </span><span class="si">{</span><span class="n">cfl_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1935"><a href="#PDESolver-1935"><span class="linenos">1935</span></a>    
</span><span id="PDESolver-1936"><a href="#PDESolver-1936"><span class="linenos">1936</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1937"><a href="#PDESolver-1937"><span class="linenos">1937</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D problems are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1938"><a href="#PDESolver-1938"><span class="linenos">1938</span></a>
</span><span id="PDESolver-1939"><a href="#PDESolver-1939"><span class="linenos">1939</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_symbol_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PDESolver-1940"><a href="#PDESolver-1940"><span class="linenos">1940</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-1941"><a href="#PDESolver-1941"><span class="linenos">1941</span></a><span class="sd">        Check strict analytic conditions on the linear symbol self.L_symbolic:</span>
</span><span id="PDESolver-1942"><a href="#PDESolver-1942"><span class="linenos">1942</span></a><span class="sd">            This method evaluates three key properties of the Fourier multiplier </span>
</span><span id="PDESolver-1943"><a href="#PDESolver-1943"><span class="linenos">1943</span></a><span class="sd">            symbol a(k) = self.L(k), which are crucial for well-posedness, stability,</span>
</span><span id="PDESolver-1944"><a href="#PDESolver-1944"><span class="linenos">1944</span></a><span class="sd">            and numerical efficiency. The checks apply to both 1D and 2D cases.</span>
</span><span id="PDESolver-1945"><a href="#PDESolver-1945"><span class="linenos">1945</span></a><span class="sd">        </span>
</span><span id="PDESolver-1946"><a href="#PDESolver-1946"><span class="linenos">1946</span></a><span class="sd">        Conditions checked:</span>
</span><span id="PDESolver-1947"><a href="#PDESolver-1947"><span class="linenos">1947</span></a><span class="sd">        ------------------</span>
</span><span id="PDESolver-1948"><a href="#PDESolver-1948"><span class="linenos">1948</span></a><span class="sd">        1. **Stability condition**: Re(a(k)) ≤ 0 for all k ≠ 0</span>
</span><span id="PDESolver-1949"><a href="#PDESolver-1949"><span class="linenos">1949</span></a><span class="sd">           Ensures that the system does not exhibit exponential growth in time.</span>
</span><span id="PDESolver-1950"><a href="#PDESolver-1950"><span class="linenos">1950</span></a><span class="sd">    </span>
</span><span id="PDESolver-1951"><a href="#PDESolver-1951"><span class="linenos">1951</span></a><span class="sd">        2. **Dissipation condition**: Re(a(k)) ≤ -δ |k|² for large |k|</span>
</span><span id="PDESolver-1952"><a href="#PDESolver-1952"><span class="linenos">1952</span></a><span class="sd">           Ensures sufficient damping at high frequencies to avoid oscillatory instability.</span>
</span><span id="PDESolver-1953"><a href="#PDESolver-1953"><span class="linenos">1953</span></a><span class="sd">    </span>
</span><span id="PDESolver-1954"><a href="#PDESolver-1954"><span class="linenos">1954</span></a><span class="sd">        3. **Growth condition**: |a(k)| ≤ C (1 + |k|)^m with m ≤ 4</span>
</span><span id="PDESolver-1955"><a href="#PDESolver-1955"><span class="linenos">1955</span></a><span class="sd">           Ensures that the symbol does not grow too rapidly with frequency, </span>
</span><span id="PDESolver-1956"><a href="#PDESolver-1956"><span class="linenos">1956</span></a><span class="sd">           which would otherwise cause numerical instability or unphysical amplification.</span>
</span><span id="PDESolver-1957"><a href="#PDESolver-1957"><span class="linenos">1957</span></a><span class="sd">    </span>
</span><span id="PDESolver-1958"><a href="#PDESolver-1958"><span class="linenos">1958</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-1959"><a href="#PDESolver-1959"><span class="linenos">1959</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-1960"><a href="#PDESolver-1960"><span class="linenos">1960</span></a><span class="sd">        k_range : tuple or None, optional</span>
</span><span id="PDESolver-1961"><a href="#PDESolver-1961"><span class="linenos">1961</span></a><span class="sd">            Specifies the range of frequencies to test in the form (k_min, k_max, N).</span>
</span><span id="PDESolver-1962"><a href="#PDESolver-1962"><span class="linenos">1962</span></a><span class="sd">            If None, defaults are used: [-10, 10] with 500 points in 1D, or [-10, 10] </span>
</span><span id="PDESolver-1963"><a href="#PDESolver-1963"><span class="linenos">1963</span></a><span class="sd">            with 100 points per axis in 2D.</span>
</span><span id="PDESolver-1964"><a href="#PDESolver-1964"><span class="linenos">1964</span></a><span class="sd">    </span>
</span><span id="PDESolver-1965"><a href="#PDESolver-1965"><span class="linenos">1965</span></a><span class="sd">        verbose : bool, default=True</span>
</span><span id="PDESolver-1966"><a href="#PDESolver-1966"><span class="linenos">1966</span></a><span class="sd">            If True, prints detailed results of each condition check.</span>
</span><span id="PDESolver-1967"><a href="#PDESolver-1967"><span class="linenos">1967</span></a><span class="sd">    </span>
</span><span id="PDESolver-1968"><a href="#PDESolver-1968"><span class="linenos">1968</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver-1969"><a href="#PDESolver-1969"><span class="linenos">1969</span></a><span class="sd">        --------</span>
</span><span id="PDESolver-1970"><a href="#PDESolver-1970"><span class="linenos">1970</span></a><span class="sd">        None</span>
</span><span id="PDESolver-1971"><a href="#PDESolver-1971"><span class="linenos">1971</span></a><span class="sd">            Output is printed directly to the console for interpretability.</span>
</span><span id="PDESolver-1972"><a href="#PDESolver-1972"><span class="linenos">1972</span></a><span class="sd">    </span>
</span><span id="PDESolver-1973"><a href="#PDESolver-1973"><span class="linenos">1973</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-1974"><a href="#PDESolver-1974"><span class="linenos">1974</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-1975"><a href="#PDESolver-1975"><span class="linenos">1975</span></a><span class="sd">        - In 2D, the radial frequency |k| = √(kx² + ky²) is used for comparisons.</span>
</span><span id="PDESolver-1976"><a href="#PDESolver-1976"><span class="linenos">1976</span></a><span class="sd">        - The dissipation threshold assumes δ = 0.01 and p = 2 by default.</span>
</span><span id="PDESolver-1977"><a href="#PDESolver-1977"><span class="linenos">1977</span></a><span class="sd">        - The growth ratio is compared against |k|⁴; values above 100 indicate rapid growth.</span>
</span><span id="PDESolver-1978"><a href="#PDESolver-1978"><span class="linenos">1978</span></a><span class="sd">        - This function is typically called during solver setup or analysis phase.</span>
</span><span id="PDESolver-1979"><a href="#PDESolver-1979"><span class="linenos">1979</span></a><span class="sd">    </span>
</span><span id="PDESolver-1980"><a href="#PDESolver-1980"><span class="linenos">1980</span></a><span class="sd">        See Also:</span>
</span><span id="PDESolver-1981"><a href="#PDESolver-1981"><span class="linenos">1981</span></a><span class="sd">        ---------</span>
</span><span id="PDESolver-1982"><a href="#PDESolver-1982"><span class="linenos">1982</span></a><span class="sd">        analyze_wave_propagation : For further symbolic and numerical analysis of dispersion.</span>
</span><span id="PDESolver-1983"><a href="#PDESolver-1983"><span class="linenos">1983</span></a><span class="sd">        plot_symbol : Visualizes the symbol&#39;s behavior over the frequency domain.</span>
</span><span id="PDESolver-1984"><a href="#PDESolver-1984"><span class="linenos">1984</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-1985"><a href="#PDESolver-1985"><span class="linenos">1985</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">********************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1986"><a href="#PDESolver-1986"><span class="linenos">1986</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Symbol condition *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1987"><a href="#PDESolver-1987"><span class="linenos">1987</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;********************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-1988"><a href="#PDESolver-1988"><span class="linenos">1988</span></a>
</span><span id="PDESolver-1989"><a href="#PDESolver-1989"><span class="linenos">1989</span></a>    
</span><span id="PDESolver-1990"><a href="#PDESolver-1990"><span class="linenos">1990</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>    
</span><span id="PDESolver-1991"><a href="#PDESolver-1991"><span class="linenos">1991</span></a>            <span class="k">if</span> <span class="n">k_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-1992"><a href="#PDESolver-1992"><span class="linenos">1992</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
</span><span id="PDESolver-1993"><a href="#PDESolver-1993"><span class="linenos">1993</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-1994"><a href="#PDESolver-1994"><span class="linenos">1994</span></a>                <span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">k_range</span>
</span><span id="PDESolver-1995"><a href="#PDESolver-1995"><span class="linenos">1995</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span id="PDESolver-1996"><a href="#PDESolver-1996"><span class="linenos">1996</span></a>    
</span><span id="PDESolver-1997"><a href="#PDESolver-1997"><span class="linenos">1997</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-1998"><a href="#PDESolver-1998"><span class="linenos">1998</span></a>            <span class="n">k_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-1999"><a href="#PDESolver-1999"><span class="linenos">1999</span></a>    
</span><span id="PDESolver-2000"><a href="#PDESolver-2000"><span class="linenos">2000</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2001"><a href="#PDESolver-2001"><span class="linenos">2001</span></a>            <span class="k">if</span> <span class="n">k_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2002"><a href="#PDESolver-2002"><span class="linenos">2002</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="PDESolver-2003"><a href="#PDESolver-2003"><span class="linenos">2003</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2004"><a href="#PDESolver-2004"><span class="linenos">2004</span></a>                <span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">k_range</span>
</span><span id="PDESolver-2005"><a href="#PDESolver-2005"><span class="linenos">2005</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span id="PDESolver-2006"><a href="#PDESolver-2006"><span class="linenos">2006</span></a>    
</span><span id="PDESolver-2007"><a href="#PDESolver-2007"><span class="linenos">2007</span></a>            <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-2008"><a href="#PDESolver-2008"><span class="linenos">2008</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-2009"><a href="#PDESolver-2009"><span class="linenos">2009</span></a>            <span class="n">k_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">KX</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">KY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2010"><a href="#PDESolver-2010"><span class="linenos">2010</span></a>    
</span><span id="PDESolver-2011"><a href="#PDESolver-2011"><span class="linenos">2011</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2012"><a href="#PDESolver-2012"><span class="linenos">2012</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D dimensions are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2013"><a href="#PDESolver-2013"><span class="linenos">2013</span></a>
</span><span id="PDESolver-2014"><a href="#PDESolver-2014"><span class="linenos">2014</span></a>    
</span><span id="PDESolver-2015"><a href="#PDESolver-2015"><span class="linenos">2015</span></a>        <span class="n">re_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2016"><a href="#PDESolver-2016"><span class="linenos">2016</span></a>        <span class="n">abs_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2017"><a href="#PDESolver-2017"><span class="linenos">2017</span></a>    
</span><span id="PDESolver-2018"><a href="#PDESolver-2018"><span class="linenos">2018</span></a>        <span class="c1"># === Condition 1: Stability</span>
</span><span id="PDESolver-2019"><a href="#PDESolver-2019"><span class="linenos">2019</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">re_vals</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">):</span>
</span><span id="PDESolver-2020"><a href="#PDESolver-2020"><span class="linenos">2020</span></a>            <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">re_vals</span><span class="p">)</span>
</span><span id="PDESolver-2021"><a href="#PDESolver-2021"><span class="linenos">2021</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2022"><a href="#PDESolver-2022"><span class="linenos">2022</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Stability violated: max Re(a(k)) = </span><span class="si">{</span><span class="n">max_pos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2023"><a href="#PDESolver-2023"><span class="linenos">2023</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unstable symbol: Re(a(k)) &gt; 0&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2024"><a href="#PDESolver-2024"><span class="linenos">2024</span></a>        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2025"><a href="#PDESolver-2025"><span class="linenos">2025</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Spectral stability satisfied: Re(a(k)) ≤ 0&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2026"><a href="#PDESolver-2026"><span class="linenos">2026</span></a>    
</span><span id="PDESolver-2027"><a href="#PDESolver-2027"><span class="linenos">2027</span></a>        <span class="c1"># === Condition 2: Dissipation</span>
</span><span id="PDESolver-2028"><a href="#PDESolver-2028"><span class="linenos">2028</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">k_abs</span> <span class="o">&gt;</span> <span class="mi">2</span>
</span><span id="PDESolver-2029"><a href="#PDESolver-2029"><span class="linenos">2029</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
</span><span id="PDESolver-2030"><a href="#PDESolver-2030"><span class="linenos">2030</span></a>            <span class="n">re_decay</span> <span class="o">=</span> <span class="n">re_vals</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="PDESolver-2031"><a href="#PDESolver-2031"><span class="linenos">2031</span></a>            <span class="n">expected_decay</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">k_abs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="PDESolver-2032"><a href="#PDESolver-2032"><span class="linenos">2032</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">re_decay</span> <span class="o">&gt;</span> <span class="n">expected_decay</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">):</span>
</span><span id="PDESolver-2033"><a href="#PDESolver-2033"><span class="linenos">2033</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2034"><a href="#PDESolver-2034"><span class="linenos">2034</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Insufficient high-frequency dissipation&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2035"><a href="#PDESolver-2035"><span class="linenos">2035</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2036"><a href="#PDESolver-2036"><span class="linenos">2036</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2037"><a href="#PDESolver-2037"><span class="linenos">2037</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Proper high-frequency dissipation&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2038"><a href="#PDESolver-2038"><span class="linenos">2038</span></a>    
</span><span id="PDESolver-2039"><a href="#PDESolver-2039"><span class="linenos">2039</span></a>        <span class="c1"># === Condition 3: Growth</span>
</span><span id="PDESolver-2040"><a href="#PDESolver-2040"><span class="linenos">2040</span></a>        <span class="n">growth_ratio</span> <span class="o">=</span> <span class="n">abs_vals</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k_abs</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>
</span><span id="PDESolver-2041"><a href="#PDESolver-2041"><span class="linenos">2041</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">growth_ratio</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="PDESolver-2042"><a href="#PDESolver-2042"><span class="linenos">2042</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2043"><a href="#PDESolver-2043"><span class="linenos">2043</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Symbol grows rapidly: |a(k)| ≳ |k|^4&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2044"><a href="#PDESolver-2044"><span class="linenos">2044</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2045"><a href="#PDESolver-2045"><span class="linenos">2045</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2046"><a href="#PDESolver-2046"><span class="linenos">2046</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Reasonable spectral growth&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2047"><a href="#PDESolver-2047"><span class="linenos">2047</span></a>    
</span><span id="PDESolver-2048"><a href="#PDESolver-2048"><span class="linenos">2048</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PDESolver-2049"><a href="#PDESolver-2049"><span class="linenos">2049</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✔ Symbol analysis completed.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2050"><a href="#PDESolver-2050"><span class="linenos">2050</span></a>
</span><span id="PDESolver-2051"><a href="#PDESolver-2051"><span class="linenos">2051</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_wave_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-2052"><a href="#PDESolver-2052"><span class="linenos">2052</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2053"><a href="#PDESolver-2053"><span class="linenos">2053</span></a><span class="sd">        Perform a detailed analysis of wave propagation characteristics based on the dispersion relation ω(k).</span>
</span><span id="PDESolver-2054"><a href="#PDESolver-2054"><span class="linenos">2054</span></a><span class="sd">    </span>
</span><span id="PDESolver-2055"><a href="#PDESolver-2055"><span class="linenos">2055</span></a><span class="sd">        This method visualizes key wave properties in both 1D and 2D settings:</span>
</span><span id="PDESolver-2056"><a href="#PDESolver-2056"><span class="linenos">2056</span></a><span class="sd">        </span>
</span><span id="PDESolver-2057"><a href="#PDESolver-2057"><span class="linenos">2057</span></a><span class="sd">        - Dispersion relation: ω(k)</span>
</span><span id="PDESolver-2058"><a href="#PDESolver-2058"><span class="linenos">2058</span></a><span class="sd">        - Phase velocity: v_p(k) = ω(k)/|k|</span>
</span><span id="PDESolver-2059"><a href="#PDESolver-2059"><span class="linenos">2059</span></a><span class="sd">        - Group velocity: v_g(k) = ∇ₖ ω(k)</span>
</span><span id="PDESolver-2060"><a href="#PDESolver-2060"><span class="linenos">2060</span></a><span class="sd">        - Anisotropy in 2D (via magnitude of group velocity)</span>
</span><span id="PDESolver-2061"><a href="#PDESolver-2061"><span class="linenos">2061</span></a><span class="sd">    </span>
</span><span id="PDESolver-2062"><a href="#PDESolver-2062"><span class="linenos">2062</span></a><span class="sd">        The symbolic dispersion relation &#39;omega_symbolic&#39; must be defined beforehand.</span>
</span><span id="PDESolver-2063"><a href="#PDESolver-2063"><span class="linenos">2063</span></a><span class="sd">        This is typically available only for second-order-in-time equations.</span>
</span><span id="PDESolver-2064"><a href="#PDESolver-2064"><span class="linenos">2064</span></a><span class="sd">    </span>
</span><span id="PDESolver-2065"><a href="#PDESolver-2065"><span class="linenos">2065</span></a><span class="sd">        In 1D:</span>
</span><span id="PDESolver-2066"><a href="#PDESolver-2066"><span class="linenos">2066</span></a><span class="sd">            Plots ω(k), v_p(k), and v_g(k) over a range of k values.</span>
</span><span id="PDESolver-2067"><a href="#PDESolver-2067"><span class="linenos">2067</span></a><span class="sd">    </span>
</span><span id="PDESolver-2068"><a href="#PDESolver-2068"><span class="linenos">2068</span></a><span class="sd">        In 2D:</span>
</span><span id="PDESolver-2069"><a href="#PDESolver-2069"><span class="linenos">2069</span></a><span class="sd">            Displays heatmaps of ω(kx, ky), v_p(kx, ky), and |v_g(kx, ky)| over a 2D wavenumber grid.</span>
</span><span id="PDESolver-2070"><a href="#PDESolver-2070"><span class="linenos">2070</span></a><span class="sd">    </span>
</span><span id="PDESolver-2071"><a href="#PDESolver-2071"><span class="linenos">2071</span></a><span class="sd">        Raises:</span>
</span><span id="PDESolver-2072"><a href="#PDESolver-2072"><span class="linenos">2072</span></a><span class="sd">            AttributeError: If &#39;omega_symbolic&#39; is not defined, the method exits gracefully with a message.</span>
</span><span id="PDESolver-2073"><a href="#PDESolver-2073"><span class="linenos">2073</span></a><span class="sd">    </span>
</span><span id="PDESolver-2074"><a href="#PDESolver-2074"><span class="linenos">2074</span></a><span class="sd">        Side Effects:</span>
</span><span id="PDESolver-2075"><a href="#PDESolver-2075"><span class="linenos">2075</span></a><span class="sd">            Generates and displays matplotlib plots.</span>
</span><span id="PDESolver-2076"><a href="#PDESolver-2076"><span class="linenos">2076</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2077"><a href="#PDESolver-2077"><span class="linenos">2077</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*****************************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2078"><a href="#PDESolver-2078"><span class="linenos">2078</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Wave propagation analysis *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2079"><a href="#PDESolver-2079"><span class="linenos">2079</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*****************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2080"><a href="#PDESolver-2080"><span class="linenos">2080</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;omega_symbolic&#39;</span><span class="p">):</span>
</span><span id="PDESolver-2081"><a href="#PDESolver-2081"><span class="linenos">2081</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ omega_symbolic not defined. Only available for 2nd order in time.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2082"><a href="#PDESolver-2082"><span class="linenos">2082</span></a>            <span class="k">return</span>
</span><span id="PDESolver-2083"><a href="#PDESolver-2083"><span class="linenos">2083</span></a>    
</span><span id="PDESolver-2084"><a href="#PDESolver-2084"><span class="linenos">2084</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2085"><a href="#PDESolver-2085"><span class="linenos">2085</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2086"><a href="#PDESolver-2086"><span class="linenos">2086</span></a>            <span class="n">omega_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_symbolic</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2087"><a href="#PDESolver-2087"><span class="linenos">2087</span></a>    
</span><span id="PDESolver-2088"><a href="#PDESolver-2088"><span class="linenos">2088</span></a>            <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="PDESolver-2089"><a href="#PDESolver-2089"><span class="linenos">2089</span></a>            <span class="n">omega_vals</span> <span class="o">=</span> <span class="n">omega_func</span><span class="p">(</span><span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-2090"><a href="#PDESolver-2090"><span class="linenos">2090</span></a>    
</span><span id="PDESolver-2091"><a href="#PDESolver-2091"><span class="linenos">2091</span></a>            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
</span><span id="PDESolver-2092"><a href="#PDESolver-2092"><span class="linenos">2092</span></a>                <span class="n">v_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">k_vals</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">omega_vals</span> <span class="o">/</span> <span class="n">k_vals</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="PDESolver-2093"><a href="#PDESolver-2093"><span class="linenos">2093</span></a>    
</span><span id="PDESolver-2094"><a href="#PDESolver-2094"><span class="linenos">2094</span></a>            <span class="n">dk</span> <span class="o">=</span> <span class="n">k_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2095"><a href="#PDESolver-2095"><span class="linenos">2095</span></a>            <span class="n">v_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">omega_vals</span><span class="p">,</span> <span class="n">dk</span><span class="p">)</span>
</span><span id="PDESolver-2096"><a href="#PDESolver-2096"><span class="linenos">2096</span></a>    
</span><span id="PDESolver-2097"><a href="#PDESolver-2097"><span class="linenos">2097</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver-2098"><a href="#PDESolver-2098"><span class="linenos">2098</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">omega_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\omega(k)$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2099"><a href="#PDESolver-2099"><span class="linenos">2099</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">v_phase</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$v_p(k)$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2100"><a href="#PDESolver-2100"><span class="linenos">2100</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">v_group</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$v_g(k)$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2101"><a href="#PDESolver-2101"><span class="linenos">2101</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;1D Wave Propagation Analysis&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2102"><a href="#PDESolver-2102"><span class="linenos">2102</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2103"><a href="#PDESolver-2103"><span class="linenos">2103</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="PDESolver-2104"><a href="#PDESolver-2104"><span class="linenos">2104</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver-2105"><a href="#PDESolver-2105"><span class="linenos">2105</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2106"><a href="#PDESolver-2106"><span class="linenos">2106</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2107"><a href="#PDESolver-2107"><span class="linenos">2107</span></a>    
</span><span id="PDESolver-2108"><a href="#PDESolver-2108"><span class="linenos">2108</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2109"><a href="#PDESolver-2109"><span class="linenos">2109</span></a>            <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_symbols</span>
</span><span id="PDESolver-2110"><a href="#PDESolver-2110"><span class="linenos">2110</span></a>            <span class="n">omega_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_symbolic</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2111"><a href="#PDESolver-2111"><span class="linenos">2111</span></a>    
</span><span id="PDESolver-2112"><a href="#PDESolver-2112"><span class="linenos">2112</span></a>            <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="PDESolver-2113"><a href="#PDESolver-2113"><span class="linenos">2113</span></a>            <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-2114"><a href="#PDESolver-2114"><span class="linenos">2114</span></a>            <span class="n">K_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">KX</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">KY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2115"><a href="#PDESolver-2115"><span class="linenos">2115</span></a>            <span class="n">K_mag</span><span class="p">[</span><span class="n">K_mag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>  <span class="c1"># Avoid division by 0</span>
</span><span id="PDESolver-2116"><a href="#PDESolver-2116"><span class="linenos">2116</span></a>    
</span><span id="PDESolver-2117"><a href="#PDESolver-2117"><span class="linenos">2117</span></a>            <span class="n">omega_vals</span> <span class="o">=</span> <span class="n">omega_func</span><span class="p">(</span><span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-2118"><a href="#PDESolver-2118"><span class="linenos">2118</span></a>            <span class="n">v_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">omega_vals</span><span class="p">)</span> <span class="o">/</span> <span class="n">K_mag</span>
</span><span id="PDESolver-2119"><a href="#PDESolver-2119"><span class="linenos">2119</span></a>    
</span><span id="PDESolver-2120"><a href="#PDESolver-2120"><span class="linenos">2120</span></a>            <span class="n">dk</span> <span class="o">=</span> <span class="n">k_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2121"><a href="#PDESolver-2121"><span class="linenos">2121</span></a>            <span class="n">domega_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">omega_vals</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PDESolver-2122"><a href="#PDESolver-2122"><span class="linenos">2122</span></a>            <span class="n">domega_dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">omega_vals</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PDESolver-2123"><a href="#PDESolver-2123"><span class="linenos">2123</span></a>            <span class="n">v_group_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">domega_dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">domega_dy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2124"><a href="#PDESolver-2124"><span class="linenos">2124</span></a>    
</span><span id="PDESolver-2125"><a href="#PDESolver-2125"><span class="linenos">2125</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver-2126"><a href="#PDESolver-2126"><span class="linenos">2126</span></a>            <span class="n">im0</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">omega_vals</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
</span><span id="PDESolver-2127"><a href="#PDESolver-2127"><span class="linenos">2127</span></a>                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2128"><a href="#PDESolver-2128"><span class="linenos">2128</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\omega(k_x, k_y)$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2129"><a href="#PDESolver-2129"><span class="linenos">2129</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PDESolver-2130"><a href="#PDESolver-2130"><span class="linenos">2130</span></a>    
</span><span id="PDESolver-2131"><a href="#PDESolver-2131"><span class="linenos">2131</span></a>            <span class="n">im1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v_phase</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
</span><span id="PDESolver-2132"><a href="#PDESolver-2132"><span class="linenos">2132</span></a>                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2133"><a href="#PDESolver-2133"><span class="linenos">2133</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_p(k_x, k_y)$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2134"><a href="#PDESolver-2134"><span class="linenos">2134</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PDESolver-2135"><a href="#PDESolver-2135"><span class="linenos">2135</span></a>    
</span><span id="PDESolver-2136"><a href="#PDESolver-2136"><span class="linenos">2136</span></a>            <span class="n">im2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v_group_norm</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
</span><span id="PDESolver-2137"><a href="#PDESolver-2137"><span class="linenos">2137</span></a>                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2138"><a href="#PDESolver-2138"><span class="linenos">2138</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$|v_g(k_x, k_y)|$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2139"><a href="#PDESolver-2139"><span class="linenos">2139</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="PDESolver-2140"><a href="#PDESolver-2140"><span class="linenos">2140</span></a>    
</span><span id="PDESolver-2141"><a href="#PDESolver-2141"><span class="linenos">2141</span></a>            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
</span><span id="PDESolver-2142"><a href="#PDESolver-2142"><span class="linenos">2142</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k_x$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2143"><a href="#PDESolver-2143"><span class="linenos">2143</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k_y$&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2144"><a href="#PDESolver-2144"><span class="linenos">2144</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2145"><a href="#PDESolver-2145"><span class="linenos">2145</span></a>    
</span><span id="PDESolver-2146"><a href="#PDESolver-2146"><span class="linenos">2146</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2147"><a href="#PDESolver-2147"><span class="linenos">2147</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2148"><a href="#PDESolver-2148"><span class="linenos">2148</span></a>    
</span><span id="PDESolver-2149"><a href="#PDESolver-2149"><span class="linenos">2149</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2150"><a href="#PDESolver-2150"><span class="linenos">2150</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Only 1D and 2D wave analysis supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2151"><a href="#PDESolver-2151"><span class="linenos">2151</span></a>        
</span><span id="PDESolver-2152"><a href="#PDESolver-2152"><span class="linenos">2152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="n">k_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">):</span>
</span><span id="PDESolver-2153"><a href="#PDESolver-2153"><span class="linenos">2153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2154"><a href="#PDESolver-2154"><span class="linenos">2154</span></a><span class="sd">        Visualize the spectral symbol L(k) or L(kx, ky) in 1D or 2D.</span>
</span><span id="PDESolver-2155"><a href="#PDESolver-2155"><span class="linenos">2155</span></a><span class="sd">    </span>
</span><span id="PDESolver-2156"><a href="#PDESolver-2156"><span class="linenos">2156</span></a><span class="sd">        This method plots the linear operator&#39;s symbolic Fourier representation </span>
</span><span id="PDESolver-2157"><a href="#PDESolver-2157"><span class="linenos">2157</span></a><span class="sd">        either as a function of a single wavenumber k (1D), or two wavenumbers </span>
</span><span id="PDESolver-2158"><a href="#PDESolver-2158"><span class="linenos">2158</span></a><span class="sd">        kx and ky (2D). The user can choose to display the real part, imaginary part, </span>
</span><span id="PDESolver-2159"><a href="#PDESolver-2159"><span class="linenos">2159</span></a><span class="sd">        or absolute value of the symbol.</span>
</span><span id="PDESolver-2160"><a href="#PDESolver-2160"><span class="linenos">2160</span></a><span class="sd">    </span>
</span><span id="PDESolver-2161"><a href="#PDESolver-2161"><span class="linenos">2161</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-2162"><a href="#PDESolver-2162"><span class="linenos">2162</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-2163"><a href="#PDESolver-2163"><span class="linenos">2163</span></a><span class="sd">        component : str {&#39;abs&#39;, &#39;re&#39;, &#39;im&#39;}</span>
</span><span id="PDESolver-2164"><a href="#PDESolver-2164"><span class="linenos">2164</span></a><span class="sd">            Component of the symbol to visualize:</span>
</span><span id="PDESolver-2165"><a href="#PDESolver-2165"><span class="linenos">2165</span></a><span class="sd">            </span>
</span><span id="PDESolver-2166"><a href="#PDESolver-2166"><span class="linenos">2166</span></a><span class="sd">                - &#39;abs&#39; : absolute value |a(k)|</span>
</span><span id="PDESolver-2167"><a href="#PDESolver-2167"><span class="linenos">2167</span></a><span class="sd">                - &#39;re&#39;  : real part Re[a(k)]</span>
</span><span id="PDESolver-2168"><a href="#PDESolver-2168"><span class="linenos">2168</span></a><span class="sd">                - &#39;im&#39;  : imaginary part Im[a(k)]</span>
</span><span id="PDESolver-2169"><a href="#PDESolver-2169"><span class="linenos">2169</span></a><span class="sd">                </span>
</span><span id="PDESolver-2170"><a href="#PDESolver-2170"><span class="linenos">2170</span></a><span class="sd">        k_range : tuple (kmin, kmax, N), optional</span>
</span><span id="PDESolver-2171"><a href="#PDESolver-2171"><span class="linenos">2171</span></a><span class="sd">            Wavenumber range for evaluation:</span>
</span><span id="PDESolver-2172"><a href="#PDESolver-2172"><span class="linenos">2172</span></a><span class="sd">            </span>
</span><span id="PDESolver-2173"><a href="#PDESolver-2173"><span class="linenos">2173</span></a><span class="sd">                - kmin: minimum wavenumber</span>
</span><span id="PDESolver-2174"><a href="#PDESolver-2174"><span class="linenos">2174</span></a><span class="sd">                - kmax: maximum wavenumber</span>
</span><span id="PDESolver-2175"><a href="#PDESolver-2175"><span class="linenos">2175</span></a><span class="sd">                - N: number of sampling points</span>
</span><span id="PDESolver-2176"><a href="#PDESolver-2176"><span class="linenos">2176</span></a><span class="sd">                </span>
</span><span id="PDESolver-2177"><a href="#PDESolver-2177"><span class="linenos">2177</span></a><span class="sd">            If None, defaults to [-10, 10] with high resolution.</span>
</span><span id="PDESolver-2178"><a href="#PDESolver-2178"><span class="linenos">2178</span></a><span class="sd">        cmap : str, optional</span>
</span><span id="PDESolver-2179"><a href="#PDESolver-2179"><span class="linenos">2179</span></a><span class="sd">            Colormap used for 2D surface plots. Default is &#39;viridis&#39;.</span>
</span><span id="PDESolver-2180"><a href="#PDESolver-2180"><span class="linenos">2180</span></a><span class="sd">    </span>
</span><span id="PDESolver-2181"><a href="#PDESolver-2181"><span class="linenos">2181</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-2182"><a href="#PDESolver-2182"><span class="linenos">2182</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-2183"><a href="#PDESolver-2183"><span class="linenos">2183</span></a><span class="sd">            ValueError: If the spatial dimension is not 1D or 2D.</span>
</span><span id="PDESolver-2184"><a href="#PDESolver-2184"><span class="linenos">2184</span></a><span class="sd">    </span>
</span><span id="PDESolver-2185"><a href="#PDESolver-2185"><span class="linenos">2185</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-2186"><a href="#PDESolver-2186"><span class="linenos">2186</span></a><span class="sd">            - In 1D, the symbol is plotted using a standard 2D line plot.</span>
</span><span id="PDESolver-2187"><a href="#PDESolver-2187"><span class="linenos">2187</span></a><span class="sd">            - In 2D, a 3D surface plot is generated with color-mapped height.</span>
</span><span id="PDESolver-2188"><a href="#PDESolver-2188"><span class="linenos">2188</span></a><span class="sd">            - Symbol evaluation uses self.L(k), which must be defined and callable.</span>
</span><span id="PDESolver-2189"><a href="#PDESolver-2189"><span class="linenos">2189</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2190"><a href="#PDESolver-2190"><span class="linenos">2190</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2191"><a href="#PDESolver-2191"><span class="linenos">2191</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Symbol plotting *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2192"><a href="#PDESolver-2192"><span class="linenos">2192</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*******************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2193"><a href="#PDESolver-2193"><span class="linenos">2193</span></a>        
</span><span id="PDESolver-2194"><a href="#PDESolver-2194"><span class="linenos">2194</span></a>        <span class="k">assert</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="s2">&quot;im&quot;</span><span class="p">),</span> <span class="s2">&quot;component must be &#39;abs&#39;, &#39;re&#39; or &#39;im&#39;&quot;</span>
</span><span id="PDESolver-2195"><a href="#PDESolver-2195"><span class="linenos">2195</span></a>        
</span><span id="PDESolver-2196"><a href="#PDESolver-2196"><span class="linenos">2196</span></a>    
</span><span id="PDESolver-2197"><a href="#PDESolver-2197"><span class="linenos">2197</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2198"><a href="#PDESolver-2198"><span class="linenos">2198</span></a>            <span class="k">if</span> <span class="n">k_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2199"><a href="#PDESolver-2199"><span class="linenos">2199</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="PDESolver-2200"><a href="#PDESolver-2200"><span class="linenos">2200</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2201"><a href="#PDESolver-2201"><span class="linenos">2201</span></a>                <span class="n">kmin</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">k_range</span>
</span><span id="PDESolver-2202"><a href="#PDESolver-2202"><span class="linenos">2202</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">kmin</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span id="PDESolver-2203"><a href="#PDESolver-2203"><span class="linenos">2203</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-2204"><a href="#PDESolver-2204"><span class="linenos">2204</span></a>    
</span><span id="PDESolver-2205"><a href="#PDESolver-2205"><span class="linenos">2205</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
</span><span id="PDESolver-2206"><a href="#PDESolver-2206"><span class="linenos">2206</span></a>                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2207"><a href="#PDESolver-2207"><span class="linenos">2207</span></a>                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Re[a(k)]&quot;</span>
</span><span id="PDESolver-2208"><a href="#PDESolver-2208"><span class="linenos">2208</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;im&quot;</span><span class="p">:</span>
</span><span id="PDESolver-2209"><a href="#PDESolver-2209"><span class="linenos">2209</span></a>                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2210"><a href="#PDESolver-2210"><span class="linenos">2210</span></a>                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Im[a(k)]&quot;</span>
</span><span id="PDESolver-2211"><a href="#PDESolver-2211"><span class="linenos">2211</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2212"><a href="#PDESolver-2212"><span class="linenos">2212</span></a>                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2213"><a href="#PDESolver-2213"><span class="linenos">2213</span></a>                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;|a(k)|&quot;</span>
</span><span id="PDESolver-2214"><a href="#PDESolver-2214"><span class="linenos">2214</span></a>    
</span><span id="PDESolver-2215"><a href="#PDESolver-2215"><span class="linenos">2215</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
</span><span id="PDESolver-2216"><a href="#PDESolver-2216"><span class="linenos">2216</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2217"><a href="#PDESolver-2217"><span class="linenos">2217</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="PDESolver-2218"><a href="#PDESolver-2218"><span class="linenos">2218</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spectral symbol: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2219"><a href="#PDESolver-2219"><span class="linenos">2219</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-2220"><a href="#PDESolver-2220"><span class="linenos">2220</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2221"><a href="#PDESolver-2221"><span class="linenos">2221</span></a>    
</span><span id="PDESolver-2222"><a href="#PDESolver-2222"><span class="linenos">2222</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2223"><a href="#PDESolver-2223"><span class="linenos">2223</span></a>            <span class="k">if</span> <span class="n">k_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2224"><a href="#PDESolver-2224"><span class="linenos">2224</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
</span><span id="PDESolver-2225"><a href="#PDESolver-2225"><span class="linenos">2225</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2226"><a href="#PDESolver-2226"><span class="linenos">2226</span></a>                <span class="n">kmin</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">k_range</span>
</span><span id="PDESolver-2227"><a href="#PDESolver-2227"><span class="linenos">2227</span></a>                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">kmin</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span id="PDESolver-2228"><a href="#PDESolver-2228"><span class="linenos">2228</span></a>    
</span><span id="PDESolver-2229"><a href="#PDESolver-2229"><span class="linenos">2229</span></a>            <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span> <span class="n">k_vals</span><span class="p">)</span>
</span><span id="PDESolver-2230"><a href="#PDESolver-2230"><span class="linenos">2230</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-2231"><a href="#PDESolver-2231"><span class="linenos">2231</span></a>    
</span><span id="PDESolver-2232"><a href="#PDESolver-2232"><span class="linenos">2232</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
</span><span id="PDESolver-2233"><a href="#PDESolver-2233"><span class="linenos">2233</span></a>                <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2234"><a href="#PDESolver-2234"><span class="linenos">2234</span></a>                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Re[a(kx, ky)]&quot;</span>
</span><span id="PDESolver-2235"><a href="#PDESolver-2235"><span class="linenos">2235</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;im&quot;</span><span class="p">:</span>
</span><span id="PDESolver-2236"><a href="#PDESolver-2236"><span class="linenos">2236</span></a>                <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2237"><a href="#PDESolver-2237"><span class="linenos">2237</span></a>                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Im[a(kx, ky)]&quot;</span>
</span><span id="PDESolver-2238"><a href="#PDESolver-2238"><span class="linenos">2238</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2239"><a href="#PDESolver-2239"><span class="linenos">2239</span></a>                <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
</span><span id="PDESolver-2240"><a href="#PDESolver-2240"><span class="linenos">2240</span></a>                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;|a(kx, ky)|&quot;</span>
</span><span id="PDESolver-2241"><a href="#PDESolver-2241"><span class="linenos">2241</span></a>    
</span><span id="PDESolver-2242"><a href="#PDESolver-2242"><span class="linenos">2242</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver-2243"><a href="#PDESolver-2243"><span class="linenos">2243</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2244"><a href="#PDESolver-2244"><span class="linenos">2244</span></a>        
</span><span id="PDESolver-2245"><a href="#PDESolver-2245"><span class="linenos">2245</span></a>            <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">KX</span><span class="p">,</span> <span class="n">KY</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-2246"><a href="#PDESolver-2246"><span class="linenos">2246</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="PDESolver-2247"><a href="#PDESolver-2247"><span class="linenos">2247</span></a>        
</span><span id="PDESolver-2248"><a href="#PDESolver-2248"><span class="linenos">2248</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;kx&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2249"><a href="#PDESolver-2249"><span class="linenos">2249</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ky&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2250"><a href="#PDESolver-2250"><span class="linenos">2250</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="PDESolver-2251"><a href="#PDESolver-2251"><span class="linenos">2251</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2D spectral symbol: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2252"><a href="#PDESolver-2252"><span class="linenos">2252</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2253"><a href="#PDESolver-2253"><span class="linenos">2253</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2254"><a href="#PDESolver-2254"><span class="linenos">2254</span></a>    
</span><span id="PDESolver-2255"><a href="#PDESolver-2255"><span class="linenos">2255</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2256"><a href="#PDESolver-2256"><span class="linenos">2256</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2257"><a href="#PDESolver-2257"><span class="linenos">2257</span></a>
</span><span id="PDESolver-2258"><a href="#PDESolver-2258"><span class="linenos">2258</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver-2259"><a href="#PDESolver-2259"><span class="linenos">2259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2260"><a href="#PDESolver-2260"><span class="linenos">2260</span></a><span class="sd">        Compute the total energy of the wave equation solution for second-order temporal PDEs. </span>
</span><span id="PDESolver-2261"><a href="#PDESolver-2261"><span class="linenos">2261</span></a><span class="sd">        The energy is defined as:</span>
</span><span id="PDESolver-2262"><a href="#PDESolver-2262"><span class="linenos">2262</span></a><span class="sd">            E(t) = 1/2 ∫ [ (∂ₜu)² + |L¹ᐟ²u|² ] dx</span>
</span><span id="PDESolver-2263"><a href="#PDESolver-2263"><span class="linenos">2263</span></a><span class="sd">        where L is the linear operator associated with the spatial part of the PDE,</span>
</span><span id="PDESolver-2264"><a href="#PDESolver-2264"><span class="linenos">2264</span></a><span class="sd">        and L¹ᐟ² denotes its square root in Fourier space.</span>
</span><span id="PDESolver-2265"><a href="#PDESolver-2265"><span class="linenos">2265</span></a><span class="sd">    </span>
</span><span id="PDESolver-2266"><a href="#PDESolver-2266"><span class="linenos">2266</span></a><span class="sd">        This method supports both 1D and 2D problems and is only meaningful when </span>
</span><span id="PDESolver-2267"><a href="#PDESolver-2267"><span class="linenos">2267</span></a><span class="sd">        self.temporal_order == 2 (second-order time derivative).</span>
</span><span id="PDESolver-2268"><a href="#PDESolver-2268"><span class="linenos">2268</span></a><span class="sd">    </span>
</span><span id="PDESolver-2269"><a href="#PDESolver-2269"><span class="linenos">2269</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver-2270"><a href="#PDESolver-2270"><span class="linenos">2270</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-2271"><a href="#PDESolver-2271"><span class="linenos">2271</span></a><span class="sd">        float or None: </span>
</span><span id="PDESolver-2272"><a href="#PDESolver-2272"><span class="linenos">2272</span></a><span class="sd">            Total energy at current time step. Returns None if the temporal order is not 2 or if no valid velocity data (v_prev) is available.</span>
</span><span id="PDESolver-2273"><a href="#PDESolver-2273"><span class="linenos">2273</span></a><span class="sd">    </span>
</span><span id="PDESolver-2274"><a href="#PDESolver-2274"><span class="linenos">2274</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-2275"><a href="#PDESolver-2275"><span class="linenos">2275</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-2276"><a href="#PDESolver-2276"><span class="linenos">2276</span></a><span class="sd">        - Uses FFT-based spectral differentiation to compute the spatial contributions.</span>
</span><span id="PDESolver-2277"><a href="#PDESolver-2277"><span class="linenos">2277</span></a><span class="sd">        - Assumes periodic boundary conditions.</span>
</span><span id="PDESolver-2278"><a href="#PDESolver-2278"><span class="linenos">2278</span></a><span class="sd">        - Handles both real and complex-valued solutions.</span>
</span><span id="PDESolver-2279"><a href="#PDESolver-2279"><span class="linenos">2279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2280"><a href="#PDESolver-2280"><span class="linenos">2280</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2281"><a href="#PDESolver-2281"><span class="linenos">2281</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PDESolver-2282"><a href="#PDESolver-2282"><span class="linenos">2282</span></a>    
</span><span id="PDESolver-2283"><a href="#PDESolver-2283"><span class="linenos">2283</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span>
</span><span id="PDESolver-2284"><a href="#PDESolver-2284"><span class="linenos">2284</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span>
</span><span id="PDESolver-2285"><a href="#PDESolver-2285"><span class="linenos">2285</span></a>    
</span><span id="PDESolver-2286"><a href="#PDESolver-2286"><span class="linenos">2286</span></a>        <span class="c1"># Fourier transform of u</span>
</span><span id="PDESolver-2287"><a href="#PDESolver-2287"><span class="linenos">2287</span></a>        <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2288"><a href="#PDESolver-2288"><span class="linenos">2288</span></a>    
</span><span id="PDESolver-2289"><a href="#PDESolver-2289"><span class="linenos">2289</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2290"><a href="#PDESolver-2290"><span class="linenos">2290</span></a>            <span class="c1"># 1D case</span>
</span><span id="PDESolver-2291"><a href="#PDESolver-2291"><span class="linenos">2291</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span>
</span><span id="PDESolver-2292"><a href="#PDESolver-2292"><span class="linenos">2292</span></a>            <span class="n">sqrt_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_vals</span><span class="p">))</span>
</span><span id="PDESolver-2293"><a href="#PDESolver-2293"><span class="linenos">2293</span></a>            <span class="n">Lu_hat</span> <span class="o">=</span> <span class="n">sqrt_L</span> <span class="o">*</span> <span class="n">u_hat</span>  <span class="c1"># Apply sqrt(|L(k)|) in Fourier space</span>
</span><span id="PDESolver-2294"><a href="#PDESolver-2294"><span class="linenos">2294</span></a>            <span class="n">Lu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Lu_hat</span><span class="p">)</span>
</span><span id="PDESolver-2295"><a href="#PDESolver-2295"><span class="linenos">2295</span></a>    
</span><span id="PDESolver-2296"><a href="#PDESolver-2296"><span class="linenos">2296</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
</span><span id="PDESolver-2297"><a href="#PDESolver-2297"><span class="linenos">2297</span></a>            <span class="n">energy_density</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2298"><a href="#PDESolver-2298"><span class="linenos">2298</span></a>            <span class="n">total_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_density</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
</span><span id="PDESolver-2299"><a href="#PDESolver-2299"><span class="linenos">2299</span></a>    
</span><span id="PDESolver-2300"><a href="#PDESolver-2300"><span class="linenos">2300</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2301"><a href="#PDESolver-2301"><span class="linenos">2301</span></a>            <span class="c1"># 2D case</span>
</span><span id="PDESolver-2302"><a href="#PDESolver-2302"><span class="linenos">2302</span></a>            <span class="n">L_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver-2303"><a href="#PDESolver-2303"><span class="linenos">2303</span></a>            <span class="n">sqrt_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_vals</span><span class="p">))</span>
</span><span id="PDESolver-2304"><a href="#PDESolver-2304"><span class="linenos">2304</span></a>            <span class="n">Lu_hat</span> <span class="o">=</span> <span class="n">sqrt_L</span> <span class="o">*</span> <span class="n">u_hat</span>
</span><span id="PDESolver-2305"><a href="#PDESolver-2305"><span class="linenos">2305</span></a>            <span class="n">Lu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Lu_hat</span><span class="p">)</span>
</span><span id="PDESolver-2306"><a href="#PDESolver-2306"><span class="linenos">2306</span></a>    
</span><span id="PDESolver-2307"><a href="#PDESolver-2307"><span class="linenos">2307</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
</span><span id="PDESolver-2308"><a href="#PDESolver-2308"><span class="linenos">2308</span></a>            <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span>
</span><span id="PDESolver-2309"><a href="#PDESolver-2309"><span class="linenos">2309</span></a>            <span class="n">energy_density</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2310"><a href="#PDESolver-2310"><span class="linenos">2310</span></a>            <span class="n">total_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_density</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
</span><span id="PDESolver-2311"><a href="#PDESolver-2311"><span class="linenos">2311</span></a>    
</span><span id="PDESolver-2312"><a href="#PDESolver-2312"><span class="linenos">2312</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2313"><a href="#PDESolver-2313"><span class="linenos">2313</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported dimension for u.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2314"><a href="#PDESolver-2314"><span class="linenos">2314</span></a>    
</span><span id="PDESolver-2315"><a href="#PDESolver-2315"><span class="linenos">2315</span></a>        <span class="k">return</span> <span class="n">total_energy</span>
</span><span id="PDESolver-2316"><a href="#PDESolver-2316"><span class="linenos">2316</span></a>
</span><span id="PDESolver-2317"><a href="#PDESolver-2317"><span class="linenos">2317</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PDESolver-2318"><a href="#PDESolver-2318"><span class="linenos">2318</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2319"><a href="#PDESolver-2319"><span class="linenos">2319</span></a><span class="sd">        Plot the time evolution of the total energy for wave equations. </span>
</span><span id="PDESolver-2320"><a href="#PDESolver-2320"><span class="linenos">2320</span></a><span class="sd">        Visualizes the energy computed during simulation for both 1D and 2D cases. </span>
</span><span id="PDESolver-2321"><a href="#PDESolver-2321"><span class="linenos">2321</span></a><span class="sd">        Requires temporal_order=2 and prior execution of compute_energy() during solve().</span>
</span><span id="PDESolver-2322"><a href="#PDESolver-2322"><span class="linenos">2322</span></a><span class="sd">        </span>
</span><span id="PDESolver-2323"><a href="#PDESolver-2323"><span class="linenos">2323</span></a><span class="sd">        Parameters:</span>
</span><span id="PDESolver-2324"><a href="#PDESolver-2324"><span class="linenos">2324</span></a><span class="sd">            log : bool</span>
</span><span id="PDESolver-2325"><a href="#PDESolver-2325"><span class="linenos">2325</span></a><span class="sd">                If True, displays energy on a logarithmic scale to highlight exponential decay/growth.</span>
</span><span id="PDESolver-2326"><a href="#PDESolver-2326"><span class="linenos">2326</span></a><span class="sd">        </span>
</span><span id="PDESolver-2327"><a href="#PDESolver-2327"><span class="linenos">2327</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver-2328"><a href="#PDESolver-2328"><span class="linenos">2328</span></a><span class="sd">            - Energy is defined as E(t) = 1/2 ∫ [ (∂ₜu)² + |L¹⸍²u|² ] dx</span>
</span><span id="PDESolver-2329"><a href="#PDESolver-2329"><span class="linenos">2329</span></a><span class="sd">            - Only available if energy monitoring was activated in solve()</span>
</span><span id="PDESolver-2330"><a href="#PDESolver-2330"><span class="linenos">2330</span></a><span class="sd">            - Automatically skips plotting if no energy data is available</span>
</span><span id="PDESolver-2331"><a href="#PDESolver-2331"><span class="linenos">2331</span></a><span class="sd">        </span>
</span><span id="PDESolver-2332"><a href="#PDESolver-2332"><span class="linenos">2332</span></a><span class="sd">        Displays:</span>
</span><span id="PDESolver-2333"><a href="#PDESolver-2333"><span class="linenos">2333</span></a><span class="sd">            - Time vs. Total Energy plot with grid and legend</span>
</span><span id="PDESolver-2334"><a href="#PDESolver-2334"><span class="linenos">2334</span></a><span class="sd">            - Appropriate axis labels and dimensional context (1D/2D)</span>
</span><span id="PDESolver-2335"><a href="#PDESolver-2335"><span class="linenos">2335</span></a><span class="sd">            - Logarithmic or linear scaling based on input parameter</span>
</span><span id="PDESolver-2336"><a href="#PDESolver-2336"><span class="linenos">2336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2337"><a href="#PDESolver-2337"><span class="linenos">2337</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;energy_history&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">:</span>
</span><span id="PDESolver-2338"><a href="#PDESolver-2338"><span class="linenos">2338</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No energy data recorded. Call compute_energy() within solve().&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2339"><a href="#PDESolver-2339"><span class="linenos">2339</span></a>            <span class="k">return</span>
</span><span id="PDESolver-2340"><a href="#PDESolver-2340"><span class="linenos">2340</span></a>    
</span><span id="PDESolver-2341"><a href="#PDESolver-2341"><span class="linenos">2341</span></a>        <span class="c1"># Time vector for plotting</span>
</span><span id="PDESolver-2342"><a href="#PDESolver-2342"><span class="linenos">2342</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">))</span>
</span><span id="PDESolver-2343"><a href="#PDESolver-2343"><span class="linenos">2343</span></a>    
</span><span id="PDESolver-2344"><a href="#PDESolver-2344"><span class="linenos">2344</span></a>        <span class="c1"># Create the figure</span>
</span><span id="PDESolver-2345"><a href="#PDESolver-2345"><span class="linenos">2345</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="PDESolver-2346"><a href="#PDESolver-2346"><span class="linenos">2346</span></a>        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
</span><span id="PDESolver-2347"><a href="#PDESolver-2347"><span class="linenos">2347</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Energy (log scale)&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2348"><a href="#PDESolver-2348"><span class="linenos">2348</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2349"><a href="#PDESolver-2349"><span class="linenos">2349</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2350"><a href="#PDESolver-2350"><span class="linenos">2350</span></a>    
</span><span id="PDESolver-2351"><a href="#PDESolver-2351"><span class="linenos">2351</span></a>        <span class="c1"># Axis labels and title</span>
</span><span id="PDESolver-2352"><a href="#PDESolver-2352"><span class="linenos">2352</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2353"><a href="#PDESolver-2353"><span class="linenos">2353</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total energy&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2354"><a href="#PDESolver-2354"><span class="linenos">2354</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Energy evolution (</span><span class="si">{}</span><span class="s2">D)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
</span><span id="PDESolver-2355"><a href="#PDESolver-2355"><span class="linenos">2355</span></a>    
</span><span id="PDESolver-2356"><a href="#PDESolver-2356"><span class="linenos">2356</span></a>        <span class="c1"># Display options</span>
</span><span id="PDESolver-2357"><a href="#PDESolver-2357"><span class="linenos">2357</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-2358"><a href="#PDESolver-2358"><span class="linenos">2358</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver-2359"><a href="#PDESolver-2359"><span class="linenos">2359</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2360"><a href="#PDESolver-2360"><span class="linenos">2360</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2361"><a href="#PDESolver-2361"><span class="linenos">2361</span></a>
</span><span id="PDESolver-2362"><a href="#PDESolver-2362"><span class="linenos">2362</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_stationary_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="PDESolver-2363"><a href="#PDESolver-2363"><span class="linenos">2363</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2364"><a href="#PDESolver-2364"><span class="linenos">2364</span></a><span class="sd">        Display the stationary solution computed by solve_stationary_psiOp.</span>
</span><span id="PDESolver-2365"><a href="#PDESolver-2365"><span class="linenos">2365</span></a>
</span><span id="PDESolver-2366"><a href="#PDESolver-2366"><span class="linenos">2366</span></a><span class="sd">        This method visualizes the solution of a pseudo-differential equation </span>
</span><span id="PDESolver-2367"><a href="#PDESolver-2367"><span class="linenos">2367</span></a><span class="sd">        solved in stationary mode. It supports both 1D and 2D spatial domains, </span>
</span><span id="PDESolver-2368"><a href="#PDESolver-2368"><span class="linenos">2368</span></a><span class="sd">        with options to display different components of the solution (real, </span>
</span><span id="PDESolver-2369"><a href="#PDESolver-2369"><span class="linenos">2369</span></a><span class="sd">        imaginary, absolute value, or phase).</span>
</span><span id="PDESolver-2370"><a href="#PDESolver-2370"><span class="linenos">2370</span></a>
</span><span id="PDESolver-2371"><a href="#PDESolver-2371"><span class="linenos">2371</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-2372"><a href="#PDESolver-2372"><span class="linenos">2372</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-2373"><a href="#PDESolver-2373"><span class="linenos">2373</span></a><span class="sd">        u : ndarray, optional</span>
</span><span id="PDESolver-2374"><a href="#PDESolver-2374"><span class="linenos">2374</span></a><span class="sd">            Precomputed solution array. If None, calls solve_stationary_psiOp() </span>
</span><span id="PDESolver-2375"><a href="#PDESolver-2375"><span class="linenos">2375</span></a><span class="sd">            to compute the solution.</span>
</span><span id="PDESolver-2376"><a href="#PDESolver-2376"><span class="linenos">2376</span></a><span class="sd">        component : str, optional {&#39;real&#39;, &#39;imag&#39;, &#39;abs&#39;, &#39;angle&#39;}</span>
</span><span id="PDESolver-2377"><a href="#PDESolver-2377"><span class="linenos">2377</span></a><span class="sd">            Component of the complex-valued solution to display:</span>
</span><span id="PDESolver-2378"><a href="#PDESolver-2378"><span class="linenos">2378</span></a><span class="sd">            - &#39;real&#39;: Real part</span>
</span><span id="PDESolver-2379"><a href="#PDESolver-2379"><span class="linenos">2379</span></a><span class="sd">            - &#39;imag&#39;: Imaginary part</span>
</span><span id="PDESolver-2380"><a href="#PDESolver-2380"><span class="linenos">2380</span></a><span class="sd">            - &#39;abs&#39; : Absolute value (modulus)</span>
</span><span id="PDESolver-2381"><a href="#PDESolver-2381"><span class="linenos">2381</span></a><span class="sd">            - &#39;angle&#39; : Phase (argument)</span>
</span><span id="PDESolver-2382"><a href="#PDESolver-2382"><span class="linenos">2382</span></a><span class="sd">        cmap : str, optional</span>
</span><span id="PDESolver-2383"><a href="#PDESolver-2383"><span class="linenos">2383</span></a><span class="sd">            Colormap used for 2D visualization (default: &#39;viridis&#39;).</span>
</span><span id="PDESolver-2384"><a href="#PDESolver-2384"><span class="linenos">2384</span></a>
</span><span id="PDESolver-2385"><a href="#PDESolver-2385"><span class="linenos">2385</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-2386"><a href="#PDESolver-2386"><span class="linenos">2386</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-2387"><a href="#PDESolver-2387"><span class="linenos">2387</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver-2388"><a href="#PDESolver-2388"><span class="linenos">2388</span></a><span class="sd">            If an invalid component is specified or if the spatial dimension </span>
</span><span id="PDESolver-2389"><a href="#PDESolver-2389"><span class="linenos">2389</span></a><span class="sd">            is not supported (only 1D and 2D are implemented).</span>
</span><span id="PDESolver-2390"><a href="#PDESolver-2390"><span class="linenos">2390</span></a>
</span><span id="PDESolver-2391"><a href="#PDESolver-2391"><span class="linenos">2391</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-2392"><a href="#PDESolver-2392"><span class="linenos">2392</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-2393"><a href="#PDESolver-2393"><span class="linenos">2393</span></a><span class="sd">        - In 1D, the solution is displayed using a standard line plot.</span>
</span><span id="PDESolver-2394"><a href="#PDESolver-2394"><span class="linenos">2394</span></a><span class="sd">        - In 2D, the solution is visualized as a 3D surface plot.</span>
</span><span id="PDESolver-2395"><a href="#PDESolver-2395"><span class="linenos">2395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2396"><a href="#PDESolver-2396"><span class="linenos">2396</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_component</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver-2397"><a href="#PDESolver-2397"><span class="linenos">2397</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2398"><a href="#PDESolver-2398"><span class="linenos">2398</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2399"><a href="#PDESolver-2399"><span class="linenos">2399</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2400"><a href="#PDESolver-2400"><span class="linenos">2400</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2401"><a href="#PDESolver-2401"><span class="linenos">2401</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2402"><a href="#PDESolver-2402"><span class="linenos">2402</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2403"><a href="#PDESolver-2403"><span class="linenos">2403</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2404"><a href="#PDESolver-2404"><span class="linenos">2404</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2405"><a href="#PDESolver-2405"><span class="linenos">2405</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2406"><a href="#PDESolver-2406"><span class="linenos">2406</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid component&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2407"><a href="#PDESolver-2407"><span class="linenos">2407</span></a>                
</span><span id="PDESolver-2408"><a href="#PDESolver-2408"><span class="linenos">2408</span></a>        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2409"><a href="#PDESolver-2409"><span class="linenos">2409</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_stationary_psiOp</span><span class="p">()</span>
</span><span id="PDESolver-2410"><a href="#PDESolver-2410"><span class="linenos">2410</span></a>
</span><span id="PDESolver-2411"><a href="#PDESolver-2411"><span class="linenos">2411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2412"><a href="#PDESolver-2412"><span class="linenos">2412</span></a>            <span class="c1"># Plot the solution in 1D</span>
</span><span id="PDESolver-2413"><a href="#PDESolver-2413"><span class="linenos">2413</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="PDESolver-2414"><a href="#PDESolver-2414"><span class="linenos">2414</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">get_component</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2415"><a href="#PDESolver-2415"><span class="linenos">2415</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2416"><a href="#PDESolver-2416"><span class="linenos">2416</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2417"><a href="#PDESolver-2417"><span class="linenos">2417</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stationary solution (1D)&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2418"><a href="#PDESolver-2418"><span class="linenos">2418</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver-2419"><a href="#PDESolver-2419"><span class="linenos">2419</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver-2420"><a href="#PDESolver-2420"><span class="linenos">2420</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2421"><a href="#PDESolver-2421"><span class="linenos">2421</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2422"><a href="#PDESolver-2422"><span class="linenos">2422</span></a>    
</span><span id="PDESolver-2423"><a href="#PDESolver-2423"><span class="linenos">2423</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2424"><a href="#PDESolver-2424"><span class="linenos">2424</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver-2425"><a href="#PDESolver-2425"><span class="linenos">2425</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2426"><a href="#PDESolver-2426"><span class="linenos">2426</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2427"><a href="#PDESolver-2427"><span class="linenos">2427</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2428"><a href="#PDESolver-2428"><span class="linenos">2428</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2429"><a href="#PDESolver-2429"><span class="linenos">2429</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stationary solution (2D)&#39;</span><span class="p">)</span>    
</span><span id="PDESolver-2430"><a href="#PDESolver-2430"><span class="linenos">2430</span></a>            <span class="n">data0</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2431"><a href="#PDESolver-2431"><span class="linenos">2431</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2432"><a href="#PDESolver-2432"><span class="linenos">2432</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2433"><a href="#PDESolver-2433"><span class="linenos">2433</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2434"><a href="#PDESolver-2434"><span class="linenos">2434</span></a>    
</span><span id="PDESolver-2435"><a href="#PDESolver-2435"><span class="linenos">2435</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2436"><a href="#PDESolver-2436"><span class="linenos">2436</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D display are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2437"><a href="#PDESolver-2437"><span class="linenos">2437</span></a>
</span><span id="PDESolver-2438"><a href="#PDESolver-2438"><span class="linenos">2438</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">animate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">):</span>
</span><span id="PDESolver-2439"><a href="#PDESolver-2439"><span class="linenos">2439</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2440"><a href="#PDESolver-2440"><span class="linenos">2440</span></a><span class="sd">        Create an animated plot of the solution evolution over time.</span>
</span><span id="PDESolver-2441"><a href="#PDESolver-2441"><span class="linenos">2441</span></a><span class="sd">    </span>
</span><span id="PDESolver-2442"><a href="#PDESolver-2442"><span class="linenos">2442</span></a><span class="sd">        This method generates a dynamic visualization of the stored solution frames</span>
</span><span id="PDESolver-2443"><a href="#PDESolver-2443"><span class="linenos">2443</span></a><span class="sd">        `self.frames`. It supports:</span>
</span><span id="PDESolver-2444"><a href="#PDESolver-2444"><span class="linenos">2444</span></a><span class="sd">          - 1D line animation (unchanged),</span>
</span><span id="PDESolver-2445"><a href="#PDESolver-2445"><span class="linenos">2445</span></a><span class="sd">          - 2D surface animation (original behavior, &#39;surface&#39;),</span>
</span><span id="PDESolver-2446"><a href="#PDESolver-2446"><span class="linenos">2446</span></a><span class="sd">          - 2D image animation using imshow (new, &#39;imshow&#39;) which is faster and</span>
</span><span id="PDESolver-2447"><a href="#PDESolver-2447"><span class="linenos">2447</span></a><span class="sd">            often clearer for large grids.</span>
</span><span id="PDESolver-2448"><a href="#PDESolver-2448"><span class="linenos">2448</span></a><span class="sd">    </span>
</span><span id="PDESolver-2449"><a href="#PDESolver-2449"><span class="linenos">2449</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-2450"><a href="#PDESolver-2450"><span class="linenos">2450</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-2451"><a href="#PDESolver-2451"><span class="linenos">2451</span></a><span class="sd">        component : str, optional, one of {&#39;real&#39;, &#39;imag&#39;, &#39;abs&#39;, &#39;angle&#39;}</span>
</span><span id="PDESolver-2452"><a href="#PDESolver-2452"><span class="linenos">2452</span></a><span class="sd">            Which component of the complex field to visualize:</span>
</span><span id="PDESolver-2453"><a href="#PDESolver-2453"><span class="linenos">2453</span></a><span class="sd">              - &#39;real&#39;  : Re(u)</span>
</span><span id="PDESolver-2454"><a href="#PDESolver-2454"><span class="linenos">2454</span></a><span class="sd">              - &#39;imag&#39;  : Im(u)</span>
</span><span id="PDESolver-2455"><a href="#PDESolver-2455"><span class="linenos">2455</span></a><span class="sd">              - &#39;abs&#39;   : |u|</span>
</span><span id="PDESolver-2456"><a href="#PDESolver-2456"><span class="linenos">2456</span></a><span class="sd">              - &#39;angle&#39; : arg(u)</span>
</span><span id="PDESolver-2457"><a href="#PDESolver-2457"><span class="linenos">2457</span></a><span class="sd">            Default is &#39;abs&#39;.</span>
</span><span id="PDESolver-2458"><a href="#PDESolver-2458"><span class="linenos">2458</span></a><span class="sd">    </span>
</span><span id="PDESolver-2459"><a href="#PDESolver-2459"><span class="linenos">2459</span></a><span class="sd">        overlay : str or None, optional, one of {&#39;contour&#39;, &#39;front&#39;, None}</span>
</span><span id="PDESolver-2460"><a href="#PDESolver-2460"><span class="linenos">2460</span></a><span class="sd">            For 2D modes only. If None, no overlay is drawn.</span>
</span><span id="PDESolver-2461"><a href="#PDESolver-2461"><span class="linenos">2461</span></a><span class="sd">              - &#39;contour&#39; : draw contour lines on top (or beneath for 3D surface)</span>
</span><span id="PDESolver-2462"><a href="#PDESolver-2462"><span class="linenos">2462</span></a><span class="sd">              - &#39;front&#39;   : detect and mark wavefronts using gradient maxima</span>
</span><span id="PDESolver-2463"><a href="#PDESolver-2463"><span class="linenos">2463</span></a><span class="sd">            Default is &#39;contour&#39;.</span>
</span><span id="PDESolver-2464"><a href="#PDESolver-2464"><span class="linenos">2464</span></a><span class="sd">    </span>
</span><span id="PDESolver-2465"><a href="#PDESolver-2465"><span class="linenos">2465</span></a><span class="sd">        mode : str, optional, one of {&#39;surface&#39;, &#39;imshow&#39;}</span>
</span><span id="PDESolver-2466"><a href="#PDESolver-2466"><span class="linenos">2466</span></a><span class="sd">            2D rendering mode. &#39;surface&#39; keeps the original 3D surface plot.</span>
</span><span id="PDESolver-2467"><a href="#PDESolver-2467"><span class="linenos">2467</span></a><span class="sd">            &#39;imshow&#39; draws a 2D raster (faster, often more readable).</span>
</span><span id="PDESolver-2468"><a href="#PDESolver-2468"><span class="linenos">2468</span></a><span class="sd">            Default is &#39;surface&#39; for backward compatibility.</span>
</span><span id="PDESolver-2469"><a href="#PDESolver-2469"><span class="linenos">2469</span></a><span class="sd">    </span>
</span><span id="PDESolver-2470"><a href="#PDESolver-2470"><span class="linenos">2470</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver-2471"><a href="#PDESolver-2471"><span class="linenos">2471</span></a><span class="sd">        -------</span>
</span><span id="PDESolver-2472"><a href="#PDESolver-2472"><span class="linenos">2472</span></a><span class="sd">        FuncAnimation</span>
</span><span id="PDESolver-2473"><a href="#PDESolver-2473"><span class="linenos">2473</span></a><span class="sd">            A Matplotlib `FuncAnimation` instance (you can display it in a notebook</span>
</span><span id="PDESolver-2474"><a href="#PDESolver-2474"><span class="linenos">2474</span></a><span class="sd">            or save it to file).</span>
</span><span id="PDESolver-2475"><a href="#PDESolver-2475"><span class="linenos">2475</span></a><span class="sd">    </span>
</span><span id="PDESolver-2476"><a href="#PDESolver-2476"><span class="linenos">2476</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-2477"><a href="#PDESolver-2477"><span class="linenos">2477</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-2478"><a href="#PDESolver-2478"><span class="linenos">2478</span></a><span class="sd">        - The method uses the same time-mapping logic as before (linear sampling of</span>
</span><span id="PDESolver-2479"><a href="#PDESolver-2479"><span class="linenos">2479</span></a><span class="sd">          stored frames to animation frames).</span>
</span><span id="PDESolver-2480"><a href="#PDESolver-2480"><span class="linenos">2480</span></a><span class="sd">        - For &#39;angle&#39; the color scale is fixed between -π and π.</span>
</span><span id="PDESolver-2481"><a href="#PDESolver-2481"><span class="linenos">2481</span></a><span class="sd">        - For other components, color scaling is by default dynamically adapted per</span>
</span><span id="PDESolver-2482"><a href="#PDESolver-2482"><span class="linenos">2482</span></a><span class="sd">          frame in &#39;imshow&#39; mode (this avoids extreme clipping if amplitudes vary).</span>
</span><span id="PDESolver-2483"><a href="#PDESolver-2483"><span class="linenos">2483</span></a><span class="sd">        - Overlays are updated cleanly: previous contour/scatter artists are removed</span>
</span><span id="PDESolver-2484"><a href="#PDESolver-2484"><span class="linenos">2484</span></a><span class="sd">          before drawing the next frame to avoid memory/visual accumulation.</span>
</span><span id="PDESolver-2485"><a href="#PDESolver-2485"><span class="linenos">2485</span></a><span class="sd">        - Animation interval is 50 ms per frame (unchanged).</span>
</span><span id="PDESolver-2486"><a href="#PDESolver-2486"><span class="linenos">2486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2487"><a href="#PDESolver-2487"><span class="linenos">2487</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_component</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver-2488"><a href="#PDESolver-2488"><span class="linenos">2488</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2489"><a href="#PDESolver-2489"><span class="linenos">2489</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2490"><a href="#PDESolver-2490"><span class="linenos">2490</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2491"><a href="#PDESolver-2491"><span class="linenos">2491</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2492"><a href="#PDESolver-2492"><span class="linenos">2492</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2493"><a href="#PDESolver-2493"><span class="linenos">2493</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2494"><a href="#PDESolver-2494"><span class="linenos">2494</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2495"><a href="#PDESolver-2495"><span class="linenos">2495</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver-2496"><a href="#PDESolver-2496"><span class="linenos">2496</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2497"><a href="#PDESolver-2497"><span class="linenos">2497</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid component: choose &#39;real&#39;,&#39;imag&#39;,&#39;abs&#39; or &#39;angle&#39;&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2498"><a href="#PDESolver-2498"><span class="linenos">2498</span></a>    
</span><span id="PDESolver-2499"><a href="#PDESolver-2499"><span class="linenos">2499</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*********************&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2500"><a href="#PDESolver-2500"><span class="linenos">2500</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Solution plotting *&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2501"><a href="#PDESolver-2501"><span class="linenos">2501</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2502"><a href="#PDESolver-2502"><span class="linenos">2502</span></a>    
</span><span id="PDESolver-2503"><a href="#PDESolver-2503"><span class="linenos">2503</span></a>        <span class="c1"># === Calculate time vector of stored frames ===</span>
</span><span id="PDESolver-2504"><a href="#PDESolver-2504"><span class="linenos">2504</span></a>        <span class="n">save_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
</span><span id="PDESolver-2505"><a href="#PDESolver-2505"><span class="linenos">2505</span></a>        <span class="n">frame_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">save_interval</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver-2506"><a href="#PDESolver-2506"><span class="linenos">2506</span></a>    
</span><span id="PDESolver-2507"><a href="#PDESolver-2507"><span class="linenos">2507</span></a>        <span class="c1"># === Target times for animation ===</span>
</span><span id="PDESolver-2508"><a href="#PDESolver-2508"><span class="linenos">2508</span></a>        <span class="n">target_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2509"><a href="#PDESolver-2509"><span class="linenos">2509</span></a>    
</span><span id="PDESolver-2510"><a href="#PDESolver-2510"><span class="linenos">2510</span></a>        <span class="c1"># Map target times to nearest frame indices</span>
</span><span id="PDESolver-2511"><a href="#PDESolver-2511"><span class="linenos">2511</span></a>        <span class="n">frame_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_times</span><span class="p">]</span>
</span><span id="PDESolver-2512"><a href="#PDESolver-2512"><span class="linenos">2512</span></a>    
</span><span id="PDESolver-2513"><a href="#PDESolver-2513"><span class="linenos">2513</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver-2514"><a href="#PDESolver-2514"><span class="linenos">2514</span></a>        <span class="c1"># 1D case (unchanged logic)</span>
</span><span id="PDESolver-2515"><a href="#PDESolver-2515"><span class="linenos">2515</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver-2516"><a href="#PDESolver-2516"><span class="linenos">2516</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2517"><a href="#PDESolver-2517"><span class="linenos">2517</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="PDESolver-2518"><a href="#PDESolver-2518"><span class="linenos">2518</span></a>            <span class="n">initial</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PDESolver-2519"><a href="#PDESolver-2519"><span class="linenos">2519</span></a>            <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span> <span class="k">else</span> <span class="n">initial</span><span class="p">)</span>
</span><span id="PDESolver-2520"><a href="#PDESolver-2520"><span class="linenos">2520</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">initial</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">initial</span><span class="p">))</span>
</span><span id="PDESolver-2521"><a href="#PDESolver-2521"><span class="linenos">2521</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2522"><a href="#PDESolver-2522"><span class="linenos">2522</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2523"><a href="#PDESolver-2523"><span class="linenos">2523</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Initial condition&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2524"><a href="#PDESolver-2524"><span class="linenos">2524</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2525"><a href="#PDESolver-2525"><span class="linenos">2525</span></a>    
</span><span id="PDESolver-2526"><a href="#PDESolver-2526"><span class="linenos">2526</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_update_1d</span><span class="p">(</span><span class="n">frame_number</span><span class="p">):</span>
</span><span id="PDESolver-2527"><a href="#PDESolver-2527"><span class="linenos">2527</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_indices</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver-2528"><a href="#PDESolver-2528"><span class="linenos">2528</span></a>                <span class="n">ydata</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
</span><span id="PDESolver-2529"><a href="#PDESolver-2529"><span class="linenos">2529</span></a>                <span class="n">ydata_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span> <span class="k">else</span> <span class="n">ydata</span>
</span><span id="PDESolver-2530"><a href="#PDESolver-2530"><span class="linenos">2530</span></a>                <span class="n">line</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata_real</span><span class="p">)</span>
</span><span id="PDESolver-2531"><a href="#PDESolver-2531"><span class="linenos">2531</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ydata_real</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ydata_real</span><span class="p">))</span>
</span><span id="PDESolver-2532"><a href="#PDESolver-2532"><span class="linenos">2532</span></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">target_times</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver-2533"><a href="#PDESolver-2533"><span class="linenos">2533</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t = </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2534"><a href="#PDESolver-2534"><span class="linenos">2534</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">line</span><span class="p">,)</span>
</span><span id="PDESolver-2535"><a href="#PDESolver-2535"><span class="linenos">2535</span></a>    
</span><span id="PDESolver-2536"><a href="#PDESolver-2536"><span class="linenos">2536</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update_1d</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_times</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PDESolver-2537"><a href="#PDESolver-2537"><span class="linenos">2537</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PDESolver-2538"><a href="#PDESolver-2538"><span class="linenos">2538</span></a>    
</span><span id="PDESolver-2539"><a href="#PDESolver-2539"><span class="linenos">2539</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver-2540"><a href="#PDESolver-2540"><span class="linenos">2540</span></a>        <span class="c1"># 2D case</span>
</span><span id="PDESolver-2541"><a href="#PDESolver-2541"><span class="linenos">2541</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver-2542"><a href="#PDESolver-2542"><span class="linenos">2542</span></a>        <span class="c1"># Validate mode</span>
</span><span id="PDESolver-2543"><a href="#PDESolver-2543"><span class="linenos">2543</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span> <span class="s1">&#39;imshow&#39;</span><span class="p">):</span>
</span><span id="PDESolver-2544"><a href="#PDESolver-2544"><span class="linenos">2544</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mode: choose &#39;surface&#39; or &#39;imshow&#39;&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2545"><a href="#PDESolver-2545"><span class="linenos">2545</span></a>    
</span><span id="PDESolver-2546"><a href="#PDESolver-2546"><span class="linenos">2546</span></a>        <span class="c1"># Common data</span>
</span><span id="PDESolver-2547"><a href="#PDESolver-2547"><span class="linenos">2547</span></a>        <span class="n">data0</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PDESolver-2548"><a href="#PDESolver-2548"><span class="linenos">2548</span></a>    
</span><span id="PDESolver-2549"><a href="#PDESolver-2549"><span class="linenos">2549</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2550"><a href="#PDESolver-2550"><span class="linenos">2550</span></a>            <span class="c1"># original surface behavior, but ensure clean updates</span>
</span><span id="PDESolver-2551"><a href="#PDESolver-2551"><span class="linenos">2551</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="PDESolver-2552"><a href="#PDESolver-2552"><span class="linenos">2552</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2553"><a href="#PDESolver-2553"><span class="linenos">2553</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2554"><a href="#PDESolver-2554"><span class="linenos">2554</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2555"><a href="#PDESolver-2555"><span class="linenos">2555</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2556"><a href="#PDESolver-2556"><span class="linenos">2556</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">labelpad</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver-2557"><a href="#PDESolver-2557"><span class="linenos">2557</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Initial condition&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2558"><a href="#PDESolver-2558"><span class="linenos">2558</span></a>    
</span><span id="PDESolver-2559"><a href="#PDESolver-2559"><span class="linenos">2559</span></a>            <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2560"><a href="#PDESolver-2560"><span class="linenos">2560</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2561"><a href="#PDESolver-2561"><span class="linenos">2561</span></a>    
</span><span id="PDESolver-2562"><a href="#PDESolver-2562"><span class="linenos">2562</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_update_surface</span><span class="p">(</span><span class="n">frame_number</span><span class="p">):</span>
</span><span id="PDESolver-2563"><a href="#PDESolver-2563"><span class="linenos">2563</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_indices</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver-2564"><a href="#PDESolver-2564"><span class="linenos">2564</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
</span><span id="PDESolver-2565"><a href="#PDESolver-2565"><span class="linenos">2565</span></a>                <span class="n">z_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">current_data</span><span class="p">))</span>
</span><span id="PDESolver-2566"><a href="#PDESolver-2566"><span class="linenos">2566</span></a>    
</span><span id="PDESolver-2567"><a href="#PDESolver-2567"><span class="linenos">2567</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="PDESolver-2568"><a href="#PDESolver-2568"><span class="linenos">2568</span></a>                <span class="n">surf_obj</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span>
</span><span id="PDESolver-2569"><a href="#PDESolver-2569"><span class="linenos">2569</span></a>                                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
</span><span id="PDESolver-2570"><a href="#PDESolver-2570"><span class="linenos">2570</span></a>                                           <span class="n">vmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
</span><span id="PDESolver-2571"><a href="#PDESolver-2571"><span class="linenos">2571</span></a>                                           <span class="n">vmax</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="PDESolver-2572"><a href="#PDESolver-2572"><span class="linenos">2572</span></a>                <span class="c1"># overlays</span>
</span><span id="PDESolver-2573"><a href="#PDESolver-2573"><span class="linenos">2573</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2574"><a href="#PDESolver-2574"><span class="linenos">2574</span></a>                    <span class="c1"># place contours slightly below the surface (use offset)</span>
</span><span id="PDESolver-2575"><a href="#PDESolver-2575"><span class="linenos">2575</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-2576"><a href="#PDESolver-2576"><span class="linenos">2576</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">z_offset</span><span class="p">)</span>
</span><span id="PDESolver-2577"><a href="#PDESolver-2577"><span class="linenos">2577</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver-2578"><a href="#PDESolver-2578"><span class="linenos">2578</span></a>                        <span class="c1"># fallback: simple contour without offset if not supported</span>
</span><span id="PDESolver-2579"><a href="#PDESolver-2579"><span class="linenos">2579</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2580"><a href="#PDESolver-2580"><span class="linenos">2580</span></a>    
</span><span id="PDESolver-2581"><a href="#PDESolver-2581"><span class="linenos">2581</span></a>                <span class="k">elif</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;front&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2582"><a href="#PDESolver-2582"><span class="linenos">2582</span></a>                    <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2583"><a href="#PDESolver-2583"><span class="linenos">2583</span></a>                    <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2584"><a href="#PDESolver-2584"><span class="linenos">2584</span></a>                    <span class="c1"># numpy.gradient: axis0 -&gt; y spacing, axis1 -&gt; x spacing</span>
</span><span id="PDESolver-2585"><a href="#PDESolver-2585"><span class="linenos">2585</span></a>                    <span class="n">du_dy</span><span class="p">,</span> <span class="n">du_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="PDESolver-2586"><a href="#PDESolver-2586"><span class="linenos">2586</span></a>                    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">du_dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">du_dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2587"><a href="#PDESolver-2587"><span class="linenos">2587</span></a>                    <span class="n">local_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_norm</span> <span class="o">==</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver-2588"><a href="#PDESolver-2588"><span class="linenos">2588</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver-2589"><a href="#PDESolver-2589"><span class="linenos">2589</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">grad_norm</span><span class="p">[</span><span class="n">local_max</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span>
</span><span id="PDESolver-2590"><a href="#PDESolver-2590"><span class="linenos">2590</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2591"><a href="#PDESolver-2591"><span class="linenos">2591</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">local_max</span><span class="p">))</span>
</span><span id="PDESolver-2592"><a href="#PDESolver-2592"><span class="linenos">2592</span></a>                    <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
</span><span id="PDESolver-2593"><a href="#PDESolver-2593"><span class="linenos">2593</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span>
</span><span id="PDESolver-2594"><a href="#PDESolver-2594"><span class="linenos">2594</span></a>                               <span class="n">z_offset</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">local_max</span><span class="p">]),</span>
</span><span id="PDESolver-2595"><a href="#PDESolver-2595"><span class="linenos">2595</span></a>                               <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="PDESolver-2596"><a href="#PDESolver-2596"><span class="linenos">2596</span></a>    
</span><span id="PDESolver-2597"><a href="#PDESolver-2597"><span class="linenos">2597</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2598"><a href="#PDESolver-2598"><span class="linenos">2598</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2599"><a href="#PDESolver-2599"><span class="linenos">2599</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2600"><a href="#PDESolver-2600"><span class="linenos">2600</span></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">target_times</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver-2601"><a href="#PDESolver-2601"><span class="linenos">2601</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution at t = </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2602"><a href="#PDESolver-2602"><span class="linenos">2602</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">surf_obj</span><span class="p">,)</span>
</span><span id="PDESolver-2603"><a href="#PDESolver-2603"><span class="linenos">2603</span></a>    
</span><span id="PDESolver-2604"><a href="#PDESolver-2604"><span class="linenos">2604</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update_surface</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_times</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PDESolver-2605"><a href="#PDESolver-2605"><span class="linenos">2605</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PDESolver-2606"><a href="#PDESolver-2606"><span class="linenos">2606</span></a>    
</span><span id="PDESolver-2607"><a href="#PDESolver-2607"><span class="linenos">2607</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># mode == &#39;imshow&#39;</span>
</span><span id="PDESolver-2608"><a href="#PDESolver-2608"><span class="linenos">2608</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver-2609"><a href="#PDESolver-2609"><span class="linenos">2609</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2610"><a href="#PDESolver-2610"><span class="linenos">2610</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2611"><a href="#PDESolver-2611"><span class="linenos">2611</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Initial condition&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2612"><a href="#PDESolver-2612"><span class="linenos">2612</span></a>    
</span><span id="PDESolver-2613"><a href="#PDESolver-2613"><span class="linenos">2613</span></a>            <span class="c1"># extent uses physical coordinates so axes show real x/y values</span>
</span><span id="PDESolver-2614"><a href="#PDESolver-2614"><span class="linenos">2614</span></a>            <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="PDESolver-2615"><a href="#PDESolver-2615"><span class="linenos">2615</span></a>    
</span><span id="PDESolver-2616"><a href="#PDESolver-2616"><span class="linenos">2616</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2617"><a href="#PDESolver-2617"><span class="linenos">2617</span></a>                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="PDESolver-2618"><a href="#PDESolver-2618"><span class="linenos">2618</span></a>                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;twilight&#39;</span>
</span><span id="PDESolver-2619"><a href="#PDESolver-2619"><span class="linenos">2619</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2620"><a href="#PDESolver-2620"><span class="linenos">2620</span></a>                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data0</span><span class="p">)</span>
</span><span id="PDESolver-2621"><a href="#PDESolver-2621"><span class="linenos">2621</span></a>                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>
</span><span id="PDESolver-2622"><a href="#PDESolver-2622"><span class="linenos">2622</span></a>    
</span><span id="PDESolver-2623"><a href="#PDESolver-2623"><span class="linenos">2623</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data0</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="PDESolver-2624"><a href="#PDESolver-2624"><span class="linenos">2624</span></a>                           <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2625"><a href="#PDESolver-2625"><span class="linenos">2625</span></a>            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="PDESolver-2626"><a href="#PDESolver-2626"><span class="linenos">2626</span></a>            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2"> of u&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2627"><a href="#PDESolver-2627"><span class="linenos">2627</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2628"><a href="#PDESolver-2628"><span class="linenos">2628</span></a>    
</span><span id="PDESolver-2629"><a href="#PDESolver-2629"><span class="linenos">2629</span></a>            <span class="c1"># containers for dynamic overlay artists (stored on function object)</span>
</span><span id="PDESolver-2630"><a href="#PDESolver-2630"><span class="linenos">2630</span></a>            <span class="c1"># update_im.contour_art and update_im.scatter_art will be created dynamically</span>
</span><span id="PDESolver-2631"><a href="#PDESolver-2631"><span class="linenos">2631</span></a>    
</span><span id="PDESolver-2632"><a href="#PDESolver-2632"><span class="linenos">2632</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_update_im</span><span class="p">(</span><span class="n">frame_number</span><span class="p">):</span>
</span><span id="PDESolver-2633"><a href="#PDESolver-2633"><span class="linenos">2633</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_indices</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver-2634"><a href="#PDESolver-2634"><span class="linenos">2634</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
</span><span id="PDESolver-2635"><a href="#PDESolver-2635"><span class="linenos">2635</span></a>    
</span><span id="PDESolver-2636"><a href="#PDESolver-2636"><span class="linenos">2636</span></a>                <span class="c1"># update raster</span>
</span><span id="PDESolver-2637"><a href="#PDESolver-2637"><span class="linenos">2637</span></a>                <span class="n">im</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
</span><span id="PDESolver-2638"><a href="#PDESolver-2638"><span class="linenos">2638</span></a>                <span class="k">if</span> <span class="n">component</span> <span class="o">!=</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2639"><a href="#PDESolver-2639"><span class="linenos">2639</span></a>                    <span class="c1"># dynamic per-frame scaling (keeps contrast when amplitude varies)</span>
</span><span id="PDESolver-2640"><a href="#PDESolver-2640"><span class="linenos">2640</span></a>                    <span class="n">cmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
</span><span id="PDESolver-2641"><a href="#PDESolver-2641"><span class="linenos">2641</span></a>                    <span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
</span><span id="PDESolver-2642"><a href="#PDESolver-2642"><span class="linenos">2642</span></a>                    <span class="c1"># avoid identical vmin==vmax</span>
</span><span id="PDESolver-2643"><a href="#PDESolver-2643"><span class="linenos">2643</span></a>                    <span class="k">if</span> <span class="n">cmax</span> <span class="o">&gt;</span> <span class="n">cmin</span><span class="p">:</span>
</span><span id="PDESolver-2644"><a href="#PDESolver-2644"><span class="linenos">2644</span></a>                        <span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="p">)</span>
</span><span id="PDESolver-2645"><a href="#PDESolver-2645"><span class="linenos">2645</span></a>    
</span><span id="PDESolver-2646"><a href="#PDESolver-2646"><span class="linenos">2646</span></a>                <span class="c1"># remove previous contour if exists</span>
</span><span id="PDESolver-2647"><a href="#PDESolver-2647"><span class="linenos">2647</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2648"><a href="#PDESolver-2648"><span class="linenos">2648</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;contour_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2649"><a href="#PDESolver-2649"><span class="linenos">2649</span></a>                        <span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
</span><span id="PDESolver-2650"><a href="#PDESolver-2650"><span class="linenos">2650</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-2651"><a href="#PDESolver-2651"><span class="linenos">2651</span></a>                                <span class="n">coll</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span id="PDESolver-2652"><a href="#PDESolver-2652"><span class="linenos">2652</span></a>                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver-2653"><a href="#PDESolver-2653"><span class="linenos">2653</span></a>                                <span class="k">pass</span>
</span><span id="PDESolver-2654"><a href="#PDESolver-2654"><span class="linenos">2654</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver-2655"><a href="#PDESolver-2655"><span class="linenos">2655</span></a>                    <span class="c1"># draw new contours (use meshgrid coords)</span>
</span><span id="PDESolver-2656"><a href="#PDESolver-2656"><span class="linenos">2656</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-2657"><a href="#PDESolver-2657"><span class="linenos">2657</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2658"><a href="#PDESolver-2658"><span class="linenos">2658</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver-2659"><a href="#PDESolver-2659"><span class="linenos">2659</span></a>                        <span class="c1"># fallback: contour with axis coordinates (x_grid, y_grid)</span>
</span><span id="PDESolver-2660"><a href="#PDESolver-2660"><span class="linenos">2660</span></a>                        <span class="n">Xc</span><span class="p">,</span> <span class="n">Yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">)</span>
</span><span id="PDESolver-2661"><a href="#PDESolver-2661"><span class="linenos">2661</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">Yc</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2662"><a href="#PDESolver-2662"><span class="linenos">2662</span></a>    
</span><span id="PDESolver-2663"><a href="#PDESolver-2663"><span class="linenos">2663</span></a>                <span class="c1"># remove previous scatter if exists</span>
</span><span id="PDESolver-2664"><a href="#PDESolver-2664"><span class="linenos">2664</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;front&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2665"><a href="#PDESolver-2665"><span class="linenos">2665</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;scatter_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2666"><a href="#PDESolver-2666"><span class="linenos">2666</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver-2667"><a href="#PDESolver-2667"><span class="linenos">2667</span></a>                            <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span id="PDESolver-2668"><a href="#PDESolver-2668"><span class="linenos">2668</span></a>                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver-2669"><a href="#PDESolver-2669"><span class="linenos">2669</span></a>                            <span class="k">pass</span>
</span><span id="PDESolver-2670"><a href="#PDESolver-2670"><span class="linenos">2670</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver-2671"><a href="#PDESolver-2671"><span class="linenos">2671</span></a>    
</span><span id="PDESolver-2672"><a href="#PDESolver-2672"><span class="linenos">2672</span></a>                    <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2673"><a href="#PDESolver-2673"><span class="linenos">2673</span></a>                    <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver-2674"><a href="#PDESolver-2674"><span class="linenos">2674</span></a>                    <span class="n">du_dy</span><span class="p">,</span> <span class="n">du_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="PDESolver-2675"><a href="#PDESolver-2675"><span class="linenos">2675</span></a>                    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">du_dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">du_dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2676"><a href="#PDESolver-2676"><span class="linenos">2676</span></a>                    <span class="n">local_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_norm</span> <span class="o">==</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver-2677"><a href="#PDESolver-2677"><span class="linenos">2677</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver-2678"><a href="#PDESolver-2678"><span class="linenos">2678</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">grad_norm</span><span class="p">[</span><span class="n">local_max</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span>
</span><span id="PDESolver-2679"><a href="#PDESolver-2679"><span class="linenos">2679</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2680"><a href="#PDESolver-2680"><span class="linenos">2680</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">local_max</span><span class="p">))</span>
</span><span id="PDESolver-2681"><a href="#PDESolver-2681"><span class="linenos">2681</span></a>                    <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
</span><span id="PDESolver-2682"><a href="#PDESolver-2682"><span class="linenos">2682</span></a>                    <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span>
</span><span id="PDESolver-2683"><a href="#PDESolver-2683"><span class="linenos">2683</span></a>                                                       <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="PDESolver-2684"><a href="#PDESolver-2684"><span class="linenos">2684</span></a>    
</span><span id="PDESolver-2685"><a href="#PDESolver-2685"><span class="linenos">2685</span></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">target_times</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver-2686"><a href="#PDESolver-2686"><span class="linenos">2686</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution at t = </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2687"><a href="#PDESolver-2687"><span class="linenos">2687</span></a>                <span class="c1"># return main image plus any overlay artists present so Matplotlib can redraw them</span>
</span><span id="PDESolver-2688"><a href="#PDESolver-2688"><span class="linenos">2688</span></a>                <span class="n">artists</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="p">]</span>
</span><span id="PDESolver-2689"><a href="#PDESolver-2689"><span class="linenos">2689</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;contour_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2690"><a href="#PDESolver-2690"><span class="linenos">2690</span></a>                    <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>
</span><span id="PDESolver-2691"><a href="#PDESolver-2691"><span class="linenos">2691</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;front&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;scatter_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2692"><a href="#PDESolver-2692"><span class="linenos">2692</span></a>                    <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span><span class="p">)</span>
</span><span id="PDESolver-2693"><a href="#PDESolver-2693"><span class="linenos">2693</span></a>                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">artists</span><span class="p">)</span>
</span><span id="PDESolver-2694"><a href="#PDESolver-2694"><span class="linenos">2694</span></a>    
</span><span id="PDESolver-2695"><a href="#PDESolver-2695"><span class="linenos">2695</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update_im</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_times</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PDESolver-2696"><a href="#PDESolver-2696"><span class="linenos">2696</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PDESolver-2697"><a href="#PDESolver-2697"><span class="linenos">2697</span></a>
</span><span id="PDESolver-2698"><a href="#PDESolver-2698"><span class="linenos">2698</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_exact</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;real&#39;</span><span class="p">):</span>
</span><span id="PDESolver-2699"><a href="#PDESolver-2699"><span class="linenos">2699</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver-2700"><a href="#PDESolver-2700"><span class="linenos">2700</span></a><span class="sd">        Test the solver against an exact solution.</span>
</span><span id="PDESolver-2701"><a href="#PDESolver-2701"><span class="linenos">2701</span></a>
</span><span id="PDESolver-2702"><a href="#PDESolver-2702"><span class="linenos">2702</span></a><span class="sd">        This method quantitatively compares the numerical solution with a provided exact solution </span>
</span><span id="PDESolver-2703"><a href="#PDESolver-2703"><span class="linenos">2703</span></a><span class="sd">        at a specified time using either relative or absolute error norms. It supports both </span>
</span><span id="PDESolver-2704"><a href="#PDESolver-2704"><span class="linenos">2704</span></a><span class="sd">        stationary and time-dependent problems in 1D and 2D. If enabled, it also generates plots </span>
</span><span id="PDESolver-2705"><a href="#PDESolver-2705"><span class="linenos">2705</span></a><span class="sd">        of the solution, exact solution, and pointwise error.</span>
</span><span id="PDESolver-2706"><a href="#PDESolver-2706"><span class="linenos">2706</span></a>
</span><span id="PDESolver-2707"><a href="#PDESolver-2707"><span class="linenos">2707</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver-2708"><a href="#PDESolver-2708"><span class="linenos">2708</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver-2709"><a href="#PDESolver-2709"><span class="linenos">2709</span></a><span class="sd">        u_exact : callable</span>
</span><span id="PDESolver-2710"><a href="#PDESolver-2710"><span class="linenos">2710</span></a><span class="sd">            Exact solution function taking spatial coordinates and optionally time as arguments.</span>
</span><span id="PDESolver-2711"><a href="#PDESolver-2711"><span class="linenos">2711</span></a><span class="sd">        t_eval : float, optional</span>
</span><span id="PDESolver-2712"><a href="#PDESolver-2712"><span class="linenos">2712</span></a><span class="sd">            Time at which to compare solutions. For non-stationary problems, defaults to final time Lt.</span>
</span><span id="PDESolver-2713"><a href="#PDESolver-2713"><span class="linenos">2713</span></a><span class="sd">            Ignored for stationary problems.</span>
</span><span id="PDESolver-2714"><a href="#PDESolver-2714"><span class="linenos">2714</span></a><span class="sd">        norm : str {&#39;relative&#39;, &#39;absolute&#39;}</span>
</span><span id="PDESolver-2715"><a href="#PDESolver-2715"><span class="linenos">2715</span></a><span class="sd">            Type of error norm used in comparison.</span>
</span><span id="PDESolver-2716"><a href="#PDESolver-2716"><span class="linenos">2716</span></a><span class="sd">        threshold : float</span>
</span><span id="PDESolver-2717"><a href="#PDESolver-2717"><span class="linenos">2717</span></a><span class="sd">            Acceptable error threshold; raises an assertion if exceeded.</span>
</span><span id="PDESolver-2718"><a href="#PDESolver-2718"><span class="linenos">2718</span></a><span class="sd">        plot : bool</span>
</span><span id="PDESolver-2719"><a href="#PDESolver-2719"><span class="linenos">2719</span></a><span class="sd">            Whether to display visual comparison plots (default: True).</span>
</span><span id="PDESolver-2720"><a href="#PDESolver-2720"><span class="linenos">2720</span></a><span class="sd">        component : str {&#39;real&#39;, &#39;imag&#39;, &#39;abs&#39;}</span>
</span><span id="PDESolver-2721"><a href="#PDESolver-2721"><span class="linenos">2721</span></a><span class="sd">            Component of the solution to compare and visualize.</span>
</span><span id="PDESolver-2722"><a href="#PDESolver-2722"><span class="linenos">2722</span></a>
</span><span id="PDESolver-2723"><a href="#PDESolver-2723"><span class="linenos">2723</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver-2724"><a href="#PDESolver-2724"><span class="linenos">2724</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-2725"><a href="#PDESolver-2725"><span class="linenos">2725</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver-2726"><a href="#PDESolver-2726"><span class="linenos">2726</span></a><span class="sd">            If unsupported dimension is encountered or requested evaluation time exceeds simulation duration.</span>
</span><span id="PDESolver-2727"><a href="#PDESolver-2727"><span class="linenos">2727</span></a><span class="sd">        AssertionError</span>
</span><span id="PDESolver-2728"><a href="#PDESolver-2728"><span class="linenos">2728</span></a><span class="sd">            If computed error exceeds the given threshold.</span>
</span><span id="PDESolver-2729"><a href="#PDESolver-2729"><span class="linenos">2729</span></a>
</span><span id="PDESolver-2730"><a href="#PDESolver-2730"><span class="linenos">2730</span></a><span class="sd">        Prints</span>
</span><span id="PDESolver-2731"><a href="#PDESolver-2731"><span class="linenos">2731</span></a><span class="sd">        ------</span>
</span><span id="PDESolver-2732"><a href="#PDESolver-2732"><span class="linenos">2732</span></a><span class="sd">        - Information about the closest available frame to the requested evaluation time.</span>
</span><span id="PDESolver-2733"><a href="#PDESolver-2733"><span class="linenos">2733</span></a><span class="sd">        - Computed error value and comparison to threshold.</span>
</span><span id="PDESolver-2734"><a href="#PDESolver-2734"><span class="linenos">2734</span></a>
</span><span id="PDESolver-2735"><a href="#PDESolver-2735"><span class="linenos">2735</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver-2736"><a href="#PDESolver-2736"><span class="linenos">2736</span></a><span class="sd">        -----</span>
</span><span id="PDESolver-2737"><a href="#PDESolver-2737"><span class="linenos">2737</span></a><span class="sd">        - For time-dependent problems, the solution is extracted from precomputed frames.</span>
</span><span id="PDESolver-2738"><a href="#PDESolver-2738"><span class="linenos">2738</span></a><span class="sd">        - Plots are adapted to spatial dimension: line plots for 1D, image plots for 2D.</span>
</span><span id="PDESolver-2739"><a href="#PDESolver-2739"><span class="linenos">2739</span></a><span class="sd">        - The method ensures consistent handling of real, imaginary, and magnitude components.</span>
</span><span id="PDESolver-2740"><a href="#PDESolver-2740"><span class="linenos">2740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver-2741"><a href="#PDESolver-2741"><span class="linenos">2741</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver-2742"><a href="#PDESolver-2742"><span class="linenos">2742</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing a stationary solution.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2743"><a href="#PDESolver-2743"><span class="linenos">2743</span></a>            <span class="n">u_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
</span><span id="PDESolver-2744"><a href="#PDESolver-2744"><span class="linenos">2744</span></a>    
</span><span id="PDESolver-2745"><a href="#PDESolver-2745"><span class="linenos">2745</span></a>            <span class="c1"># Compute exact solution</span>
</span><span id="PDESolver-2746"><a href="#PDESolver-2746"><span class="linenos">2746</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2747"><a href="#PDESolver-2747"><span class="linenos">2747</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver-2748"><a href="#PDESolver-2748"><span class="linenos">2748</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2749"><a href="#PDESolver-2749"><span class="linenos">2749</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PDESolver-2750"><a href="#PDESolver-2750"><span class="linenos">2750</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2751"><a href="#PDESolver-2751"><span class="linenos">2751</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2752"><a href="#PDESolver-2752"><span class="linenos">2752</span></a>            <span class="n">actual_t</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver-2753"><a href="#PDESolver-2753"><span class="linenos">2753</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2754"><a href="#PDESolver-2754"><span class="linenos">2754</span></a>            <span class="k">if</span> <span class="n">t_eval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver-2755"><a href="#PDESolver-2755"><span class="linenos">2755</span></a>                <span class="n">t_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span>
</span><span id="PDESolver-2756"><a href="#PDESolver-2756"><span class="linenos">2756</span></a>    
</span><span id="PDESolver-2757"><a href="#PDESolver-2757"><span class="linenos">2757</span></a>            <span class="n">save_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
</span><span id="PDESolver-2758"><a href="#PDESolver-2758"><span class="linenos">2758</span></a>            <span class="n">frame_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">save_interval</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver-2759"><a href="#PDESolver-2759"><span class="linenos">2759</span></a>            <span class="n">frame_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">-</span> <span class="n">t_eval</span><span class="p">))</span>
</span><span id="PDESolver-2760"><a href="#PDESolver-2760"><span class="linenos">2760</span></a>            <span class="n">actual_t</span> <span class="o">=</span> <span class="n">frame_times</span><span class="p">[</span><span class="n">frame_index</span><span class="p">]</span>
</span><span id="PDESolver-2761"><a href="#PDESolver-2761"><span class="linenos">2761</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closest available time to t_eval=</span><span class="si">{</span><span class="n">t_eval</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">actual_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2762"><a href="#PDESolver-2762"><span class="linenos">2762</span></a>    
</span><span id="PDESolver-2763"><a href="#PDESolver-2763"><span class="linenos">2763</span></a>            <span class="k">if</span> <span class="n">frame_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">):</span>
</span><span id="PDESolver-2764"><a href="#PDESolver-2764"><span class="linenos">2764</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time t = </span><span class="si">{</span><span class="n">t_eval</span><span class="si">}</span><span class="s2"> exceeds simulation duration.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2765"><a href="#PDESolver-2765"><span class="linenos">2765</span></a>    
</span><span id="PDESolver-2766"><a href="#PDESolver-2766"><span class="linenos">2766</span></a>            <span class="n">u_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame_index</span><span class="p">]</span>
</span><span id="PDESolver-2767"><a href="#PDESolver-2767"><span class="linenos">2767</span></a>    
</span><span id="PDESolver-2768"><a href="#PDESolver-2768"><span class="linenos">2768</span></a>            <span class="c1"># Compute exact solution at the actual time</span>
</span><span id="PDESolver-2769"><a href="#PDESolver-2769"><span class="linenos">2769</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2770"><a href="#PDESolver-2770"><span class="linenos">2770</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">actual_t</span><span class="p">)</span>
</span><span id="PDESolver-2771"><a href="#PDESolver-2771"><span class="linenos">2771</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver-2772"><a href="#PDESolver-2772"><span class="linenos">2772</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">actual_t</span><span class="p">)</span>
</span><span id="PDESolver-2773"><a href="#PDESolver-2773"><span class="linenos">2773</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2774"><a href="#PDESolver-2774"><span class="linenos">2774</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2775"><a href="#PDESolver-2775"><span class="linenos">2775</span></a>    
</span><span id="PDESolver-2776"><a href="#PDESolver-2776"><span class="linenos">2776</span></a>        <span class="c1"># Select component</span>
</span><span id="PDESolver-2777"><a href="#PDESolver-2777"><span class="linenos">2777</span></a>        <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2778"><a href="#PDESolver-2778"><span class="linenos">2778</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_num</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver-2779"><a href="#PDESolver-2779"><span class="linenos">2779</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver-2780"><a href="#PDESolver-2780"><span class="linenos">2780</span></a>        <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2781"><a href="#PDESolver-2781"><span class="linenos">2781</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u_num</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver-2782"><a href="#PDESolver-2782"><span class="linenos">2782</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver-2783"><a href="#PDESolver-2783"><span class="linenos">2783</span></a>        <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2784"><a href="#PDESolver-2784"><span class="linenos">2784</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_num</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver-2785"><a href="#PDESolver-2785"><span class="linenos">2785</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver-2786"><a href="#PDESolver-2786"><span class="linenos">2786</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2787"><a href="#PDESolver-2787"><span class="linenos">2787</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid component.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2788"><a href="#PDESolver-2788"><span class="linenos">2788</span></a>    
</span><span id="PDESolver-2789"><a href="#PDESolver-2789"><span class="linenos">2789</span></a>        <span class="c1"># Compute error</span>
</span><span id="PDESolver-2790"><a href="#PDESolver-2790"><span class="linenos">2790</span></a>        <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;relative&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2791"><a href="#PDESolver-2791"><span class="linenos">2791</span></a>            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
</span><span id="PDESolver-2792"><a href="#PDESolver-2792"><span class="linenos">2792</span></a>        <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;absolute&#39;</span><span class="p">:</span>
</span><span id="PDESolver-2793"><a href="#PDESolver-2793"><span class="linenos">2793</span></a>            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
</span><span id="PDESolver-2794"><a href="#PDESolver-2794"><span class="linenos">2794</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2795"><a href="#PDESolver-2795"><span class="linenos">2795</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown norm type.&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2796"><a href="#PDESolver-2796"><span class="linenos">2796</span></a>    
</span><span id="PDESolver-2797"><a href="#PDESolver-2797"><span class="linenos">2797</span></a>        <span class="n">label_time</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">actual_t</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">actual_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="PDESolver-2798"><a href="#PDESolver-2798"><span class="linenos">2798</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test error </span><span class="si">{</span><span class="n">label_time</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2799"><a href="#PDESolver-2799"><span class="linenos">2799</span></a>        <span class="k">assert</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error too large </span><span class="si">{</span><span class="n">label_time</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PDESolver-2800"><a href="#PDESolver-2800"><span class="linenos">2800</span></a>    
</span><span id="PDESolver-2801"><a href="#PDESolver-2801"><span class="linenos">2801</span></a>        <span class="c1"># Plot</span>
</span><span id="PDESolver-2802"><a href="#PDESolver-2802"><span class="linenos">2802</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
</span><span id="PDESolver-2803"><a href="#PDESolver-2803"><span class="linenos">2803</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver-2804"><a href="#PDESolver-2804"><span class="linenos">2804</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver-2805"><a href="#PDESolver-2805"><span class="linenos">2805</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PDESolver-2806"><a href="#PDESolver-2806"><span class="linenos">2806</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_num</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Numerical&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2807"><a href="#PDESolver-2807"><span class="linenos">2807</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_ex</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Exact&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2808"><a href="#PDESolver-2808"><span class="linenos">2808</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution </span><span class="si">{</span><span class="n">label_time</span><span class="si">}</span><span class="s1">, error = </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2809"><a href="#PDESolver-2809"><span class="linenos">2809</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver-2810"><a href="#PDESolver-2810"><span class="linenos">2810</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="PDESolver-2811"><a href="#PDESolver-2811"><span class="linenos">2811</span></a>    
</span><span id="PDESolver-2812"><a href="#PDESolver-2812"><span class="linenos">2812</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2813"><a href="#PDESolver-2813"><span class="linenos">2813</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2814"><a href="#PDESolver-2814"><span class="linenos">2814</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Absolute Error&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2815"><a href="#PDESolver-2815"><span class="linenos">2815</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="PDESolver-2816"><a href="#PDESolver-2816"><span class="linenos">2816</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2817"><a href="#PDESolver-2817"><span class="linenos">2817</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2818"><a href="#PDESolver-2818"><span class="linenos">2818</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver-2819"><a href="#PDESolver-2819"><span class="linenos">2819</span></a>                <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
</span><span id="PDESolver-2820"><a href="#PDESolver-2820"><span class="linenos">2820</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver-2821"><a href="#PDESolver-2821"><span class="linenos">2821</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PDESolver-2822"><a href="#PDESolver-2822"><span class="linenos">2822</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Numerical Solution&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2823"><a href="#PDESolver-2823"><span class="linenos">2823</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_num</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2824"><a href="#PDESolver-2824"><span class="linenos">2824</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="PDESolver-2825"><a href="#PDESolver-2825"><span class="linenos">2825</span></a>    
</span><span id="PDESolver-2826"><a href="#PDESolver-2826"><span class="linenos">2826</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver-2827"><a href="#PDESolver-2827"><span class="linenos">2827</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Exact Solution&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2828"><a href="#PDESolver-2828"><span class="linenos">2828</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_ex</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2829"><a href="#PDESolver-2829"><span class="linenos">2829</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="PDESolver-2830"><a href="#PDESolver-2830"><span class="linenos">2830</span></a>    
</span><span id="PDESolver-2831"><a href="#PDESolver-2831"><span class="linenos">2831</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="PDESolver-2832"><a href="#PDESolver-2832"><span class="linenos">2832</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error (Norm = </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PDESolver-2833"><a href="#PDESolver-2833"><span class="linenos">2833</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PDESolver-2834"><a href="#PDESolver-2834"><span class="linenos">2834</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="PDESolver-2835"><a href="#PDESolver-2835"><span class="linenos">2835</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver-2836"><a href="#PDESolver-2836"><span class="linenos">2836</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver-2837"><a href="#PDESolver-2837"><span class="linenos">2837</span></a>
</span><span id="PDESolver-2838"><a href="#PDESolver-2838"><span class="linenos">2838</span></a>        <span class="k">return</span> <span class="n">error</span>
</span></pre></div>


            <div class="docstring"><p>A partial differential equation (PDE) solver based on <strong>spectral methods</strong> using Fourier transforms.</p>

<p>This solver supports symbolic specification of PDEs via SymPy and numerical solution using high-order spectral techniques. 
It is designed for both <strong>linear and nonlinear time-dependent PDEs</strong>, as well as <strong>stationary pseudo-differential problems</strong>.</p>

<h2 id="key-features">Key Features:</h2>

<ul>
<li>Symbolic PDE parsing using SymPy expressions</li>
<li>1D and 2D spatial domains with periodic boundary conditions</li>
<li>Fourier-based spectral discretization with dealiasing</li>
<li>Temporal integration schemes:
<ul>
<li>Default exponential time stepping</li>
<li>ETD-RK4 (Exponential Time Differencing Runge-Kutta of 4th order)</li>
</ul></li>
<li>Nonlinear terms handled through pseudo-spectral evaluation</li>
<li>Built-in tools for:
<ul>
<li>Visualization of solutions and error surfaces</li>
<li>Symbol analysis of linear and pseudo-differential operators</li>
<li>Microlocal analysis (e.g., Hamiltonian flows)</li>
<li>CFL condition checking and numerical stability diagnostics</li>
</ul></li>
</ul>

<h2 id="supported-operators">Supported Operators:</h2>

<ul>
<li>Linear differential and pseudo-differential operators</li>
<li>Nonlinear terms up to second order in derivatives</li>
<li>Symbolic operator composition and adjoints</li>
<li>Asymptotic inversion of elliptic operators for stationary problems</li>
</ul>

<h2 id="example-usage">Example Usage:</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">PDESolver</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;t x&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">t</span><span class="p">),</span> <span class="n">diff</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">_initial</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span> <span class="o">=</span> <span class="n">PDESolver</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">Lx</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">Lt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">initial_condition</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ani</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">animate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">HTML</span><span class="p">(</span><span class="n">ani</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span>  <span class="c1"># Display animation in Jupyter notebook</span>
</code></pre>
</div>
</div>


                            <div id="PDESolver.__init__" class="classattr">
                                        <input id="PDESolver.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PDESolver</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">equation</span>, </span><span class="param"><span class="n">time_scheme</span><span class="o">=</span><span class="s1">&#39;default&#39;</span>, </span><span class="param"><span class="n">dealiasing_ratio</span><span class="o">=</span><span class="mf">0.6666666666666666</span></span>)</span>

                <label class="view-source-button" for="PDESolver.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.__init__-70"><a href="#PDESolver.__init__-70"><span class="linenos"> 70</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">time_scheme</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">dealiasing_ratio</span><span class="o">=</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
</span><span id="PDESolver.__init__-71"><a href="#PDESolver.__init__-71"><span class="linenos"> 71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.__init__-72"><a href="#PDESolver.__init__-72"><span class="linenos"> 72</span></a><span class="sd">        Initialize the PDE solver with a given equation.</span>
</span><span id="PDESolver.__init__-73"><a href="#PDESolver.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="PDESolver.__init__-74"><a href="#PDESolver.__init__-74"><span class="linenos"> 74</span></a><span class="sd">        This method analyzes the input partial differential equation (PDE), </span>
</span><span id="PDESolver.__init__-75"><a href="#PDESolver.__init__-75"><span class="linenos"> 75</span></a><span class="sd">        identifies the unknown function and its dependencies, determines whether </span>
</span><span id="PDESolver.__init__-76"><a href="#PDESolver.__init__-76"><span class="linenos"> 76</span></a><span class="sd">        the problem is stationary or time-dependent, and prepares symbolic and </span>
</span><span id="PDESolver.__init__-77"><a href="#PDESolver.__init__-77"><span class="linenos"> 77</span></a><span class="sd">        numerical structures for solving in spectral space.</span>
</span><span id="PDESolver.__init__-78"><a href="#PDESolver.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="PDESolver.__init__-79"><a href="#PDESolver.__init__-79"><span class="linenos"> 79</span></a><span class="sd">        Supported features:</span>
</span><span id="PDESolver.__init__-80"><a href="#PDESolver.__init__-80"><span class="linenos"> 80</span></a><span class="sd">        </span>
</span><span id="PDESolver.__init__-81"><a href="#PDESolver.__init__-81"><span class="linenos"> 81</span></a><span class="sd">        - 1D and 2D problems</span>
</span><span id="PDESolver.__init__-82"><a href="#PDESolver.__init__-82"><span class="linenos"> 82</span></a><span class="sd">        - Time-dependent and stationary equations</span>
</span><span id="PDESolver.__init__-83"><a href="#PDESolver.__init__-83"><span class="linenos"> 83</span></a><span class="sd">        - Linear and nonlinear terms</span>
</span><span id="PDESolver.__init__-84"><a href="#PDESolver.__init__-84"><span class="linenos"> 84</span></a><span class="sd">        - Pseudo-differential operators via `psiOp`</span>
</span><span id="PDESolver.__init__-85"><a href="#PDESolver.__init__-85"><span class="linenos"> 85</span></a><span class="sd">        - Source terms and boundary conditions</span>
</span><span id="PDESolver.__init__-86"><a href="#PDESolver.__init__-86"><span class="linenos"> 86</span></a>
</span><span id="PDESolver.__init__-87"><a href="#PDESolver.__init__-87"><span class="linenos"> 87</span></a><span class="sd">        The equation is parsed to extract linear, nonlinear, source, and </span>
</span><span id="PDESolver.__init__-88"><a href="#PDESolver.__init__-88"><span class="linenos"> 88</span></a><span class="sd">        pseudo-differential components. Symbolic manipulation is used to derive </span>
</span><span id="PDESolver.__init__-89"><a href="#PDESolver.__init__-89"><span class="linenos"> 89</span></a><span class="sd">        the Fourier representation of linear operators when applicable.</span>
</span><span id="PDESolver.__init__-90"><a href="#PDESolver.__init__-90"><span class="linenos"> 90</span></a>
</span><span id="PDESolver.__init__-91"><a href="#PDESolver.__init__-91"><span class="linenos"> 91</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver.__init__-92"><a href="#PDESolver.__init__-92"><span class="linenos"> 92</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver.__init__-93"><a href="#PDESolver.__init__-93"><span class="linenos"> 93</span></a><span class="sd">        equation : sympy.Eq </span>
</span><span id="PDESolver.__init__-94"><a href="#PDESolver.__init__-94"><span class="linenos"> 94</span></a><span class="sd">            The PDE expressed as a SymPy equation.</span>
</span><span id="PDESolver.__init__-95"><a href="#PDESolver.__init__-95"><span class="linenos"> 95</span></a><span class="sd">        time_scheme : str</span>
</span><span id="PDESolver.__init__-96"><a href="#PDESolver.__init__-96"><span class="linenos"> 96</span></a><span class="sd">            Temporal integration scheme: </span>
</span><span id="PDESolver.__init__-97"><a href="#PDESolver.__init__-97"><span class="linenos"> 97</span></a><span class="sd">                - &#39;default&#39; for exponential </span>
</span><span id="PDESolver.__init__-98"><a href="#PDESolver.__init__-98"><span class="linenos"> 98</span></a><span class="sd">                - time-stepping or &#39;ETD-RK4&#39; for fourth-order exponential </span>
</span><span id="PDESolver.__init__-99"><a href="#PDESolver.__init__-99"><span class="linenos"> 99</span></a><span class="sd">                - time differencing Runge–Kutta.</span>
</span><span id="PDESolver.__init__-100"><a href="#PDESolver.__init__-100"><span class="linenos">100</span></a><span class="sd">        dealiasing_ratio : float</span>
</span><span id="PDESolver.__init__-101"><a href="#PDESolver.__init__-101"><span class="linenos">101</span></a><span class="sd">            Fraction of high-frequency modes to zero out </span>
</span><span id="PDESolver.__init__-102"><a href="#PDESolver.__init__-102"><span class="linenos">102</span></a><span class="sd">            during dealiasing (e.g., 2/3 for standard truncation).</span>
</span><span id="PDESolver.__init__-103"><a href="#PDESolver.__init__-103"><span class="linenos">103</span></a>
</span><span id="PDESolver.__init__-104"><a href="#PDESolver.__init__-104"><span class="linenos">104</span></a><span class="sd">        Attributes initialized:</span>
</span><span id="PDESolver.__init__-105"><a href="#PDESolver.__init__-105"><span class="linenos">105</span></a><span class="sd">        </span>
</span><span id="PDESolver.__init__-106"><a href="#PDESolver.__init__-106"><span class="linenos">106</span></a><span class="sd">        - self.u: the unknown function (e.g., u(t, x))</span>
</span><span id="PDESolver.__init__-107"><a href="#PDESolver.__init__-107"><span class="linenos">107</span></a><span class="sd">        - self.dim: spatial dimension (1 or 2)</span>
</span><span id="PDESolver.__init__-108"><a href="#PDESolver.__init__-108"><span class="linenos">108</span></a><span class="sd">        - self.spatial_vars: list of spatial variables (e.g., [x] or [x, y])</span>
</span><span id="PDESolver.__init__-109"><a href="#PDESolver.__init__-109"><span class="linenos">109</span></a><span class="sd">        - self.is_stationary: boolean indicating if the problem is stationary</span>
</span><span id="PDESolver.__init__-110"><a href="#PDESolver.__init__-110"><span class="linenos">110</span></a><span class="sd">        - self.linear_terms: dictionary mapping derivative orders to coefficients</span>
</span><span id="PDESolver.__init__-111"><a href="#PDESolver.__init__-111"><span class="linenos">111</span></a><span class="sd">        - self.nonlinear_terms: list of nonlinear expressions</span>
</span><span id="PDESolver.__init__-112"><a href="#PDESolver.__init__-112"><span class="linenos">112</span></a><span class="sd">        - self.source_terms: list of source functions</span>
</span><span id="PDESolver.__init__-113"><a href="#PDESolver.__init__-113"><span class="linenos">113</span></a><span class="sd">        - self.pseudo_terms: list of pseudo-differential operator expressions</span>
</span><span id="PDESolver.__init__-114"><a href="#PDESolver.__init__-114"><span class="linenos">114</span></a><span class="sd">        - self.has_psi: boolean indicating presence of pseudo-differential operators</span>
</span><span id="PDESolver.__init__-115"><a href="#PDESolver.__init__-115"><span class="linenos">115</span></a><span class="sd">        - self.fft / self.ifft: appropriate FFT routines based on spatial dimension</span>
</span><span id="PDESolver.__init__-116"><a href="#PDESolver.__init__-116"><span class="linenos">116</span></a><span class="sd">        - self.kx, self.ky: symbolic wavenumber variables for Fourier space</span>
</span><span id="PDESolver.__init__-117"><a href="#PDESolver.__init__-117"><span class="linenos">117</span></a>
</span><span id="PDESolver.__init__-118"><a href="#PDESolver.__init__-118"><span class="linenos">118</span></a><span class="sd">        Raises:</span>
</span><span id="PDESolver.__init__-119"><a href="#PDESolver.__init__-119"><span class="linenos">119</span></a><span class="sd">            ValueError: If the equation does not contain exactly one unknown function,</span>
</span><span id="PDESolver.__init__-120"><a href="#PDESolver.__init__-120"><span class="linenos">120</span></a><span class="sd">                        if unsupported dimensions are detected, or invalid dependencies.</span>
</span><span id="PDESolver.__init__-121"><a href="#PDESolver.__init__-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.__init__-122"><a href="#PDESolver.__init__-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_scheme</span> <span class="o">=</span> <span class="n">time_scheme</span> <span class="c1"># &#39;default&#39;  or &#39;ETD-RK4&#39;</span>
</span><span id="PDESolver.__init__-123"><a href="#PDESolver.__init__-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_ratio</span> <span class="o">=</span> <span class="n">dealiasing_ratio</span>
</span><span id="PDESolver.__init__-124"><a href="#PDESolver.__init__-124"><span class="linenos">124</span></a>        
</span><span id="PDESolver.__init__-125"><a href="#PDESolver.__init__-125"><span class="linenos">125</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*********************************&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-126"><a href="#PDESolver.__init__-126"><span class="linenos">126</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Partial differential equation *&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-127"><a href="#PDESolver.__init__-127"><span class="linenos">127</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-128"><a href="#PDESolver.__init__-128"><span class="linenos">128</span></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver.__init__-129"><a href="#PDESolver.__init__-129"><span class="linenos">129</span></a>        
</span><span id="PDESolver.__init__-130"><a href="#PDESolver.__init__-130"><span class="linenos">130</span></a>        <span class="c1"># Extract symbols and function from the equation</span>
</span><span id="PDESolver.__init__-131"><a href="#PDESolver.__init__-131"><span class="linenos">131</span></a>        <span class="n">functions</span> <span class="o">=</span> <span class="n">equation</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Function</span><span class="p">)</span>
</span><span id="PDESolver.__init__-132"><a href="#PDESolver.__init__-132"><span class="linenos">132</span></a>        
</span><span id="PDESolver.__init__-133"><a href="#PDESolver.__init__-133"><span class="linenos">133</span></a>        <span class="c1"># Ignore the wrappers psiOp and Op</span>
</span><span id="PDESolver.__init__-134"><a href="#PDESolver.__init__-134"><span class="linenos">134</span></a>        <span class="n">excluded_wrappers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psiOp&#39;</span><span class="p">,</span> <span class="s1">&#39;Op&#39;</span><span class="p">}</span>
</span><span id="PDESolver.__init__-135"><a href="#PDESolver.__init__-135"><span class="linenos">135</span></a>        
</span><span id="PDESolver.__init__-136"><a href="#PDESolver.__init__-136"><span class="linenos">136</span></a>        <span class="c1"># Extract the candidate fonctions (excluding wrappers)</span>
</span><span id="PDESolver.__init__-137"><a href="#PDESolver.__init__-137"><span class="linenos">137</span></a>        <span class="n">candidate_functions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PDESolver.__init__-138"><a href="#PDESolver.__init__-138"><span class="linenos">138</span></a>            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span> 
</span><span id="PDESolver.__init__-139"><a href="#PDESolver.__init__-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_wrappers</span>
</span><span id="PDESolver.__init__-140"><a href="#PDESolver.__init__-140"><span class="linenos">140</span></a>        <span class="p">]</span>
</span><span id="PDESolver.__init__-141"><a href="#PDESolver.__init__-141"><span class="linenos">141</span></a>        
</span><span id="PDESolver.__init__-142"><a href="#PDESolver.__init__-142"><span class="linenos">142</span></a>        <span class="c1"># Keep only user functions (u(x), u(x, t), etc.)</span>
</span><span id="PDESolver.__init__-143"><a href="#PDESolver.__init__-143"><span class="linenos">143</span></a>        <span class="n">candidate_functions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PDESolver.__init__-144"><a href="#PDESolver.__init__-144"><span class="linenos">144</span></a>            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span>
</span><span id="PDESolver.__init__-145"><a href="#PDESolver.__init__-145"><span class="linenos">145</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">AppliedUndef</span><span class="p">)</span>
</span><span id="PDESolver.__init__-146"><a href="#PDESolver.__init__-146"><span class="linenos">146</span></a>        <span class="p">]</span>
</span><span id="PDESolver.__init__-147"><a href="#PDESolver.__init__-147"><span class="linenos">147</span></a>        
</span><span id="PDESolver.__init__-148"><a href="#PDESolver.__init__-148"><span class="linenos">148</span></a>        <span class="c1"># Stationary detection: no dependence on t</span>
</span><span id="PDESolver.__init__-149"><a href="#PDESolver.__init__-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="PDESolver.__init__-150"><a href="#PDESolver.__init__-150"><span class="linenos">150</span></a>            <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span><span id="PDESolver.__init__-151"><a href="#PDESolver.__init__-151"><span class="linenos">151</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">candidate_functions</span>
</span><span id="PDESolver.__init__-152"><a href="#PDESolver.__init__-152"><span class="linenos">152</span></a>        <span class="p">)</span>
</span><span id="PDESolver.__init__-153"><a href="#PDESolver.__init__-153"><span class="linenos">153</span></a>        
</span><span id="PDESolver.__init__-154"><a href="#PDESolver.__init__-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_functions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.__init__-155"><a href="#PDESolver.__init__-155"><span class="linenos">155</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;candidate_functions :&quot;</span><span class="p">,</span> <span class="n">candidate_functions</span><span class="p">)</span>
</span><span id="PDESolver.__init__-156"><a href="#PDESolver.__init__-156"><span class="linenos">156</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The equation must contain exactly one unknown function&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-157"><a href="#PDESolver.__init__-157"><span class="linenos">157</span></a>        
</span><span id="PDESolver.__init__-158"><a href="#PDESolver.__init__-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">candidate_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.__init__-159"><a href="#PDESolver.__init__-159"><span class="linenos">159</span></a>
</span><span id="PDESolver.__init__-160"><a href="#PDESolver.__init__-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">u_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
</span><span id="PDESolver.__init__-161"><a href="#PDESolver.__init__-161"><span class="linenos">161</span></a>
</span><span id="PDESolver.__init__-162"><a href="#PDESolver.__init__-162"><span class="linenos">162</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">args</span>
</span><span id="PDESolver.__init__-163"><a href="#PDESolver.__init__-163"><span class="linenos">163</span></a>        
</span><span id="PDESolver.__init__-164"><a href="#PDESolver.__init__-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver.__init__-165"><a href="#PDESolver.__init__-165"><span class="linenos">165</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="PDESolver.__init__-166"><a href="#PDESolver.__init__-166"><span class="linenos">166</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stationary problems must depend on 1 or 2 spatial variables&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-167"><a href="#PDESolver.__init__-167"><span class="linenos">167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span> <span class="o">=</span> <span class="n">args</span>
</span><span id="PDESolver.__init__-168"><a href="#PDESolver.__init__-168"><span class="linenos">168</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.__init__-169"><a href="#PDESolver.__init__-169"><span class="linenos">169</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="PDESolver.__init__-170"><a href="#PDESolver.__init__-170"><span class="linenos">170</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The function must depend on t and at least one spatial variable (x [, y])&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-171"><a href="#PDESolver.__init__-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.__init__-172"><a href="#PDESolver.__init__-172"><span class="linenos">172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="PDESolver.__init__-173"><a href="#PDESolver.__init__-173"><span class="linenos">173</span></a>
</span><span id="PDESolver.__init__-174"><a href="#PDESolver.__init__-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">)</span>
</span><span id="PDESolver.__init__-175"><a href="#PDESolver.__init__-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.__init__-176"><a href="#PDESolver.__init__-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.__init__-177"><a href="#PDESolver.__init__-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver.__init__-178"><a href="#PDESolver.__init__-178"><span class="linenos">178</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.__init__-179"><a href="#PDESolver.__init__-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span>
</span><span id="PDESolver.__init__-180"><a href="#PDESolver.__init__-180"><span class="linenos">180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.__init__-181"><a href="#PDESolver.__init__-181"><span class="linenos">181</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D problems are supported.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-182"><a href="#PDESolver.__init__-182"><span class="linenos">182</span></a>
</span><span id="PDESolver.__init__-183"><a href="#PDESolver.__init__-183"><span class="linenos">183</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.__init__-184"><a href="#PDESolver.__init__-184"><span class="linenos">184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver.__init__-185"><a href="#PDESolver.__init__-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver.__init__-186"><a href="#PDESolver.__init__-186"><span class="linenos">186</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.__init__-187"><a href="#PDESolver.__init__-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver.__init__-188"><a href="#PDESolver.__init__-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ifft2</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">FFT_WORKERS</span><span class="p">)</span>
</span><span id="PDESolver.__init__-189"><a href="#PDESolver.__init__-189"><span class="linenos">189</span></a>            
</span><span id="PDESolver.__init__-190"><a href="#PDESolver.__init__-190"><span class="linenos">190</span></a>        <span class="c1"># Parse the equation</span>
</span><span id="PDESolver.__init__-191"><a href="#PDESolver.__init__-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PDESolver.__init__-192"><a href="#PDESolver.__init__-192"><span class="linenos">192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.__init__-193"><a href="#PDESolver.__init__-193"><span class="linenos">193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.__init__-194"><a href="#PDESolver.__init__-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.__init__-195"><a href="#PDESolver.__init__-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.__init__-196"><a href="#PDESolver.__init__-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Order of the temporal derivative</span>
</span><span id="PDESolver.__init__-197"><a href="#PDESolver.__init__-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equation</span><span class="p">(</span><span class="n">equation</span><span class="p">)</span>
</span><span id="PDESolver.__init__-198"><a href="#PDESolver.__init__-198"><span class="linenos">198</span></a>        <span class="c1"># flag : pseudo‑differential operator present ?</span>
</span><span id="PDESolver.__init__-199"><a href="#PDESolver.__init__-199"><span class="linenos">199</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">)</span>
</span><span id="PDESolver.__init__-200"><a href="#PDESolver.__init__-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver.__init__-201"><a href="#PDESolver.__init__-201"><span class="linenos">201</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚠️  Pseudo‑differential operator detected: all other linear terms have been rejected.&#39;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-202"><a href="#PDESolver.__init__-202"><span class="linenos">202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PDESolver.__init__-203"><a href="#PDESolver.__init__-203"><span class="linenos">203</span></a>            <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver.__init__-204"><a href="#PDESolver.__init__-204"><span class="linenos">204</span></a>                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
</span><span id="PDESolver.__init__-205"><a href="#PDESolver.__init__-205"><span class="linenos">205</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PDESolver.__init__-206"><a href="#PDESolver.__init__-206"><span class="linenos">206</span></a>                    <span class="k">break</span>
</span><span id="PDESolver.__init__-207"><a href="#PDESolver.__init__-207"><span class="linenos">207</span></a>    
</span><span id="PDESolver.__init__-208"><a href="#PDESolver.__init__-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.__init__-209"><a href="#PDESolver.__init__-209"><span class="linenos">209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">kx</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;kx&#39;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-210"><a href="#PDESolver.__init__-210"><span class="linenos">210</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.__init__-211"><a href="#PDESolver.__init__-211"><span class="linenos">211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;kx ky&#39;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-212"><a href="#PDESolver.__init__-212"><span class="linenos">212</span></a>    
</span><span id="PDESolver.__init__-213"><a href="#PDESolver.__init__-213"><span class="linenos">213</span></a>        <span class="c1"># Compute linear operator</span>
</span><span id="PDESolver.__init__-214"><a href="#PDESolver.__init__-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver.__init__-215"><a href="#PDESolver.__init__-215"><span class="linenos">215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_linear_operator</span><span class="p">()</span>
</span><span id="PDESolver.__init__-216"><a href="#PDESolver.__init__-216"><span class="linenos">216</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.__init__-217"><a href="#PDESolver.__init__-217"><span class="linenos">217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.__init__-218"><a href="#PDESolver.__init__-218"><span class="linenos">218</span></a>            <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">sym_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_terms</span><span class="p">:</span>
</span><span id="PDESolver.__init__-219"><a href="#PDESolver.__init__-219"><span class="linenos">219</span></a>                <span class="n">psi</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">sym_expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
</span><span id="PDESolver.__init__-220"><a href="#PDESolver.__init__-220"><span class="linenos">220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the PDE solver with a given equation.</p>

<p>This method analyzes the input partial differential equation (PDE), 
identifies the unknown function and its dependencies, determines whether 
the problem is stationary or time-dependent, and prepares symbolic and 
numerical structures for solving in spectral space.</p>

<p>Supported features:</p>

<ul>
<li>1D and 2D problems</li>
<li>Time-dependent and stationary equations</li>
<li>Linear and nonlinear terms</li>
<li>Pseudo-differential operators via <code>psiOp</code></li>
<li>Source terms and boundary conditions</li>
</ul>

<p>The equation is parsed to extract linear, nonlinear, source, and 
pseudo-differential components. Symbolic manipulation is used to derive 
the Fourier representation of linear operators when applicable.</p>

<h2 id="parameters">Parameters</h2>

<p>equation : sympy.Eq 
    The PDE expressed as a SymPy equation.
time_scheme : str
    Temporal integration scheme: 
        - 'default' for exponential 
        - time-stepping or 'ETD-RK4' for fourth-order exponential 
        - time differencing Runge–Kutta.
dealiasing_ratio : float
    Fraction of high-frequency modes to zero out 
    during dealiasing (e.g., 2/3 for standard truncation).</p>

<p>Attributes initialized:</p>

<ul>
<li>self.u: the unknown function (e.g., u(t, x))</li>
<li>self.dim: spatial dimension (1 or 2)</li>
<li>self.spatial_vars: list of spatial variables (e.g., <input type="checkbox" class="task-list-item-checkbox" checked disabled> or [x, y])</li>
<li>self.is_stationary: boolean indicating if the problem is stationary</li>
<li>self.linear_terms: dictionary mapping derivative orders to coefficients</li>
<li>self.nonlinear_terms: list of nonlinear expressions</li>
<li>self.source_terms: list of source functions</li>
<li>self.pseudo_terms: list of pseudo-differential operator expressions</li>
<li>self.has_psi: boolean indicating presence of pseudo-differential operators</li>
<li>self.fft / self.ifft: appropriate FFT routines based on spatial dimension</li>
<li>self.kx, self.ky: symbolic wavenumber variables for Fourier space</li>
</ul>

<p>Raises:
    ValueError: If the equation does not contain exactly one unknown function,
                if unsupported dimensions are detected, or invalid dependencies.</p>
</div>


                            </div>
                            <div id="PDESolver.time_scheme" class="classattr">
                                <div class="attr variable">
            <span class="name">time_scheme</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.time_scheme"></a>
    
    

                            </div>
                            <div id="PDESolver.dealiasing_ratio" class="classattr">
                                <div class="attr variable">
            <span class="name">dealiasing_ratio</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.dealiasing_ratio"></a>
    
    

                            </div>
                            <div id="PDESolver.is_stationary" class="classattr">
                                <div class="attr variable">
            <span class="name">is_stationary</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.is_stationary"></a>
    
    

                            </div>
                            <div id="PDESolver.u" class="classattr">
                                <div class="attr variable">
            <span class="name">u</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.u"></a>
    
    

                            </div>
                            <div id="PDESolver.u_eq" class="classattr">
                                <div class="attr variable">
            <span class="name">u_eq</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.u_eq"></a>
    
    

                            </div>
                            <div id="PDESolver.dim" class="classattr">
                                <div class="attr variable">
            <span class="name">dim</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.dim"></a>
    
    

                            </div>
                            <div id="PDESolver.linear_terms" class="classattr">
                                <div class="attr variable">
            <span class="name">linear_terms</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.linear_terms"></a>
    
    

                            </div>
                            <div id="PDESolver.nonlinear_terms" class="classattr">
                                <div class="attr variable">
            <span class="name">nonlinear_terms</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.nonlinear_terms"></a>
    
    

                            </div>
                            <div id="PDESolver.symbol_terms" class="classattr">
                                <div class="attr variable">
            <span class="name">symbol_terms</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.symbol_terms"></a>
    
    

                            </div>
                            <div id="PDESolver.source_terms" class="classattr">
                                <div class="attr variable">
            <span class="name">source_terms</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.source_terms"></a>
    
    

                            </div>
                            <div id="PDESolver.pseudo_terms" class="classattr">
                                <div class="attr variable">
            <span class="name">pseudo_terms</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.pseudo_terms"></a>
    
    

                            </div>
                            <div id="PDESolver.temporal_order" class="classattr">
                                <div class="attr variable">
            <span class="name">temporal_order</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.temporal_order"></a>
    
    

                            </div>
                            <div id="PDESolver.has_psi" class="classattr">
                                <div class="attr variable">
            <span class="name">has_psi</span>

        
    </div>
    <a class="headerlink" href="#PDESolver.has_psi"></a>
    
    

                            </div>
                            <div id="PDESolver.setup" class="classattr">
                                        <input id="PDESolver.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">Lx</span>,</span><span class="param">	<span class="n">Ly</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">Nx</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">Ny</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">Lt</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">Nt</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span>,</span><span class="param">	<span class="n">initial_condition</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">initial_velocity</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.setup-559"><a href="#PDESolver.setup-559"><span class="linenos">559</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">boundary_condition</span><span class="o">=</span><span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
</span><span id="PDESolver.setup-560"><a href="#PDESolver.setup-560"><span class="linenos">560</span></a>              <span class="n">initial_condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PDESolver.setup-561"><a href="#PDESolver.setup-561"><span class="linenos">561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.setup-562"><a href="#PDESolver.setup-562"><span class="linenos">562</span></a><span class="sd">        Configure the spatial/temporal grid and initialize the solution field.</span>
</span><span id="PDESolver.setup-563"><a href="#PDESolver.setup-563"><span class="linenos">563</span></a><span class="sd">    </span>
</span><span id="PDESolver.setup-564"><a href="#PDESolver.setup-564"><span class="linenos">564</span></a><span class="sd">        This method sets up the computational domain, initializes spatial and temporal grids,</span>
</span><span id="PDESolver.setup-565"><a href="#PDESolver.setup-565"><span class="linenos">565</span></a><span class="sd">        applies boundary conditions, and prepares symbolic and numerical operators.</span>
</span><span id="PDESolver.setup-566"><a href="#PDESolver.setup-566"><span class="linenos">566</span></a><span class="sd">        It also performs essential analyses such as:</span>
</span><span id="PDESolver.setup-567"><a href="#PDESolver.setup-567"><span class="linenos">567</span></a><span class="sd">        </span>
</span><span id="PDESolver.setup-568"><a href="#PDESolver.setup-568"><span class="linenos">568</span></a><span class="sd">            - CFL condition verification (for stability)</span>
</span><span id="PDESolver.setup-569"><a href="#PDESolver.setup-569"><span class="linenos">569</span></a><span class="sd">            - Symbol analysis (e.g., dispersion relation, regularity)</span>
</span><span id="PDESolver.setup-570"><a href="#PDESolver.setup-570"><span class="linenos">570</span></a><span class="sd">            - Wave propagation analysis for second-order equations</span>
</span><span id="PDESolver.setup-571"><a href="#PDESolver.setup-571"><span class="linenos">571</span></a><span class="sd">    </span>
</span><span id="PDESolver.setup-572"><a href="#PDESolver.setup-572"><span class="linenos">572</span></a><span class="sd">        If pseudo-differential operators (ψOp) are present, symbolic analysis is skipped</span>
</span><span id="PDESolver.setup-573"><a href="#PDESolver.setup-573"><span class="linenos">573</span></a><span class="sd">        in favor of interactive exploration via `interactive_symbol_analysis`.</span>
</span><span id="PDESolver.setup-574"><a href="#PDESolver.setup-574"><span class="linenos">574</span></a><span class="sd">    </span>
</span><span id="PDESolver.setup-575"><a href="#PDESolver.setup-575"><span class="linenos">575</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver.setup-576"><a href="#PDESolver.setup-576"><span class="linenos">576</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver.setup-577"><a href="#PDESolver.setup-577"><span class="linenos">577</span></a><span class="sd">        Lx : float</span>
</span><span id="PDESolver.setup-578"><a href="#PDESolver.setup-578"><span class="linenos">578</span></a><span class="sd">            Size of the spatial domain along x-axis.</span>
</span><span id="PDESolver.setup-579"><a href="#PDESolver.setup-579"><span class="linenos">579</span></a><span class="sd">        Ly : float, optional</span>
</span><span id="PDESolver.setup-580"><a href="#PDESolver.setup-580"><span class="linenos">580</span></a><span class="sd">            Size of the spatial domain along y-axis (for 2D problems).</span>
</span><span id="PDESolver.setup-581"><a href="#PDESolver.setup-581"><span class="linenos">581</span></a><span class="sd">        Nx : int</span>
</span><span id="PDESolver.setup-582"><a href="#PDESolver.setup-582"><span class="linenos">582</span></a><span class="sd">            Number of spatial points along x-axis.</span>
</span><span id="PDESolver.setup-583"><a href="#PDESolver.setup-583"><span class="linenos">583</span></a><span class="sd">        Ny : int, optional</span>
</span><span id="PDESolver.setup-584"><a href="#PDESolver.setup-584"><span class="linenos">584</span></a><span class="sd">            Number of spatial points along y-axis (for 2D problems).</span>
</span><span id="PDESolver.setup-585"><a href="#PDESolver.setup-585"><span class="linenos">585</span></a><span class="sd">        Lt : float, default=1.0</span>
</span><span id="PDESolver.setup-586"><a href="#PDESolver.setup-586"><span class="linenos">586</span></a><span class="sd">            Total simulation time.</span>
</span><span id="PDESolver.setup-587"><a href="#PDESolver.setup-587"><span class="linenos">587</span></a><span class="sd">        Nt : int, default=100</span>
</span><span id="PDESolver.setup-588"><a href="#PDESolver.setup-588"><span class="linenos">588</span></a><span class="sd">            Number of time steps.</span>
</span><span id="PDESolver.setup-589"><a href="#PDESolver.setup-589"><span class="linenos">589</span></a><span class="sd">        initial_condition : callable</span>
</span><span id="PDESolver.setup-590"><a href="#PDESolver.setup-590"><span class="linenos">590</span></a><span class="sd">            Function returning the initial state u(x, 0) or u(x, y, 0).</span>
</span><span id="PDESolver.setup-591"><a href="#PDESolver.setup-591"><span class="linenos">591</span></a><span class="sd">        initial_velocity : callable, optional</span>
</span><span id="PDESolver.setup-592"><a href="#PDESolver.setup-592"><span class="linenos">592</span></a><span class="sd">            Function returning the initial time derivative ∂ₜu(x, 0) or ∂ₜu(x, y, 0),</span>
</span><span id="PDESolver.setup-593"><a href="#PDESolver.setup-593"><span class="linenos">593</span></a><span class="sd">            required for second-order equations.</span>
</span><span id="PDESolver.setup-594"><a href="#PDESolver.setup-594"><span class="linenos">594</span></a><span class="sd">        n_frames : int, default=100</span>
</span><span id="PDESolver.setup-595"><a href="#PDESolver.setup-595"><span class="linenos">595</span></a><span class="sd">            Number of time frames to store during simulation for visualization or output.</span>
</span><span id="PDESolver.setup-596"><a href="#PDESolver.setup-596"><span class="linenos">596</span></a><span class="sd">    </span>
</span><span id="PDESolver.setup-597"><a href="#PDESolver.setup-597"><span class="linenos">597</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver.setup-598"><a href="#PDESolver.setup-598"><span class="linenos">598</span></a><span class="sd">        ------</span>
</span><span id="PDESolver.setup-599"><a href="#PDESolver.setup-599"><span class="linenos">599</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver.setup-600"><a href="#PDESolver.setup-600"><span class="linenos">600</span></a><span class="sd">            If mandatory parameters are missing (e.g., Nx not given in 1D, Ly/Ny not given in 2D).</span>
</span><span id="PDESolver.setup-601"><a href="#PDESolver.setup-601"><span class="linenos">601</span></a><span class="sd">    </span>
</span><span id="PDESolver.setup-602"><a href="#PDESolver.setup-602"><span class="linenos">602</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver.setup-603"><a href="#PDESolver.setup-603"><span class="linenos">603</span></a><span class="sd">        -----</span>
</span><span id="PDESolver.setup-604"><a href="#PDESolver.setup-604"><span class="linenos">604</span></a><span class="sd">        - The spatial discretization assumes periodic boundary conditions by default.</span>
</span><span id="PDESolver.setup-605"><a href="#PDESolver.setup-605"><span class="linenos">605</span></a><span class="sd">        - Fourier transforms are computed using real-to-complex FFTs (`scipy.fft.fft`, `fft2`).</span>
</span><span id="PDESolver.setup-606"><a href="#PDESolver.setup-606"><span class="linenos">606</span></a><span class="sd">        - Frequency arrays (`KX`, `KY`) are defined following standard spectral conventions.</span>
</span><span id="PDESolver.setup-607"><a href="#PDESolver.setup-607"><span class="linenos">607</span></a><span class="sd">        - Dealiasing is applied using a sharp cutoff filter at a fraction of the maximum frequency.</span>
</span><span id="PDESolver.setup-608"><a href="#PDESolver.setup-608"><span class="linenos">608</span></a><span class="sd">        - For second-order equations, initial acceleration is derived from the governing operator.</span>
</span><span id="PDESolver.setup-609"><a href="#PDESolver.setup-609"><span class="linenos">609</span></a><span class="sd">        - Symbolic analysis includes plotting of the symbol&#39;s real/imaginary/absolute values</span>
</span><span id="PDESolver.setup-610"><a href="#PDESolver.setup-610"><span class="linenos">610</span></a><span class="sd">          and dispersion relation.</span>
</span><span id="PDESolver.setup-611"><a href="#PDESolver.setup-611"><span class="linenos">611</span></a><span class="sd">    </span>
</span><span id="PDESolver.setup-612"><a href="#PDESolver.setup-612"><span class="linenos">612</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver.setup-613"><a href="#PDESolver.setup-613"><span class="linenos">613</span></a><span class="sd">        --------</span>
</span><span id="PDESolver.setup-614"><a href="#PDESolver.setup-614"><span class="linenos">614</span></a><span class="sd">        setup_1D : Sets up internal variables for one-dimensional problems.</span>
</span><span id="PDESolver.setup-615"><a href="#PDESolver.setup-615"><span class="linenos">615</span></a><span class="sd">        setup_2D : Sets up internal variables for two-dimensional problems.</span>
</span><span id="PDESolver.setup-616"><a href="#PDESolver.setup-616"><span class="linenos">616</span></a><span class="sd">        initialize_conditions : Applies initial data and enforces compatibility.</span>
</span><span id="PDESolver.setup-617"><a href="#PDESolver.setup-617"><span class="linenos">617</span></a><span class="sd">        check_cfl_condition : Verifies time step against stability constraints.</span>
</span><span id="PDESolver.setup-618"><a href="#PDESolver.setup-618"><span class="linenos">618</span></a><span class="sd">        plot_symbol : Visualizes the linear operator’s symbol in frequency space.</span>
</span><span id="PDESolver.setup-619"><a href="#PDESolver.setup-619"><span class="linenos">619</span></a><span class="sd">        analyze_wave_propagation : Analyzes group velocity.</span>
</span><span id="PDESolver.setup-620"><a href="#PDESolver.setup-620"><span class="linenos">620</span></a><span class="sd">        interactive_symbol_analysis : Interactive tools for ψOp-based equations.</span>
</span><span id="PDESolver.setup-621"><a href="#PDESolver.setup-621"><span class="linenos">621</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.setup-622"><a href="#PDESolver.setup-622"><span class="linenos">622</span></a>        
</span><span id="PDESolver.setup-623"><a href="#PDESolver.setup-623"><span class="linenos">623</span></a>        <span class="c1"># Temporal parameters</span>
</span><span id="PDESolver.setup-624"><a href="#PDESolver.setup-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">Lt</span><span class="p">,</span> <span class="n">Nt</span>
</span><span id="PDESolver.setup-625"><a href="#PDESolver.setup-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Lt</span> <span class="o">/</span> <span class="n">Nt</span>
</span><span id="PDESolver.setup-626"><a href="#PDESolver.setup-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_frames</span>
</span><span id="PDESolver.setup-627"><a href="#PDESolver.setup-627"><span class="linenos">627</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.setup-628"><a href="#PDESolver.setup-628"><span class="linenos">628</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span> <span class="o">=</span> <span class="n">initial_condition</span>
</span><span id="PDESolver.setup-629"><a href="#PDESolver.setup-629"><span class="linenos">629</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">=</span> <span class="n">boundary_condition</span>
</span><span id="PDESolver.setup-630"><a href="#PDESolver.setup-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
</span><span id="PDESolver.setup-631"><a href="#PDESolver.setup-631"><span class="linenos">631</span></a>
</span><span id="PDESolver.setup-632"><a href="#PDESolver.setup-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver.setup-633"><a href="#PDESolver.setup-633"><span class="linenos">633</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PDESolver.setup-634"><a href="#PDESolver.setup-634"><span class="linenos">634</span></a>                <span class="s2">&quot;Dirichlet boundary conditions require the equation to be defined via a pseudo-differential operator (psiOp). &quot;</span>
</span><span id="PDESolver.setup-635"><a href="#PDESolver.setup-635"><span class="linenos">635</span></a>                <span class="s2">&quot;Please provide an equation involving psiOp for non-periodic boundary treatment.&quot;</span>
</span><span id="PDESolver.setup-636"><a href="#PDESolver.setup-636"><span class="linenos">636</span></a>            <span class="p">)</span>
</span><span id="PDESolver.setup-637"><a href="#PDESolver.setup-637"><span class="linenos">637</span></a>    
</span><span id="PDESolver.setup-638"><a href="#PDESolver.setup-638"><span class="linenos">638</span></a>        <span class="c1"># Dimension checks</span>
</span><span id="PDESolver.setup-639"><a href="#PDESolver.setup-639"><span class="linenos">639</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.setup-640"><a href="#PDESolver.setup-640"><span class="linenos">640</span></a>            <span class="k">if</span> <span class="n">Nx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.setup-641"><a href="#PDESolver.setup-641"><span class="linenos">641</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nx must be specified in 1D.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.setup-642"><a href="#PDESolver.setup-642"><span class="linenos">642</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_1D</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span>
</span><span id="PDESolver.setup-643"><a href="#PDESolver.setup-643"><span class="linenos">643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.setup-644"><a href="#PDESolver.setup-644"><span class="linenos">644</span></a>            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Ly</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
</span><span id="PDESolver.setup-645"><a href="#PDESolver.setup-645"><span class="linenos">645</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In 2D, Ly and Ny must be provided.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.setup-646"><a href="#PDESolver.setup-646"><span class="linenos">646</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_2D</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
</span><span id="PDESolver.setup-647"><a href="#PDESolver.setup-647"><span class="linenos">647</span></a>    
</span><span id="PDESolver.setup-648"><a href="#PDESolver.setup-648"><span class="linenos">648</span></a>        <span class="c1"># Initialization of solution and velocities</span>
</span><span id="PDESolver.setup-649"><a href="#PDESolver.setup-649"><span class="linenos">649</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver.setup-650"><a href="#PDESolver.setup-650"><span class="linenos">650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_conditions</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">initial_velocity</span><span class="p">)</span>
</span><span id="PDESolver.setup-651"><a href="#PDESolver.setup-651"><span class="linenos">651</span></a>            
</span><span id="PDESolver.setup-652"><a href="#PDESolver.setup-652"><span class="linenos">652</span></a>        <span class="c1"># Symbol analysis if present</span>
</span><span id="PDESolver.setup-653"><a href="#PDESolver.setup-653"><span class="linenos">653</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver.setup-654"><a href="#PDESolver.setup-654"><span class="linenos">654</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ For psiOp, use interactive_symbol_analysis.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.setup-655"><a href="#PDESolver.setup-655"><span class="linenos">655</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.setup-656"><a href="#PDESolver.setup-656"><span class="linenos">656</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_symbolic</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver.setup-657"><a href="#PDESolver.setup-657"><span class="linenos">657</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Linear operator is null.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.setup-658"><a href="#PDESolver.setup-658"><span class="linenos">658</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.setup-659"><a href="#PDESolver.setup-659"><span class="linenos">659</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_check_cfl_condition</span><span class="p">()</span>
</span><span id="PDESolver.setup-660"><a href="#PDESolver.setup-660"><span class="linenos">660</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_check_symbol_conditions</span><span class="p">()</span>
</span><span id="PDESolver.setup-661"><a href="#PDESolver.setup-661"><span class="linenos">661</span></a>                <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="PDESolver.setup-662"><a href="#PDESolver.setup-662"><span class="linenos">662</span></a>                	<span class="bp">self</span><span class="o">.</span><span class="n">_plot_symbol</span><span class="p">()</span>
</span><span id="PDESolver.setup-663"><a href="#PDESolver.setup-663"><span class="linenos">663</span></a>                	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.setup-664"><a href="#PDESolver.setup-664"><span class="linenos">664</span></a>                		<span class="bp">self</span><span class="o">.</span><span class="n">_analyze_wave_propagation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Configure the spatial/temporal grid and initialize the solution field.</p>

<p>This method sets up the computational domain, initializes spatial and temporal grids,
applies boundary conditions, and prepares symbolic and numerical operators.
It also performs essential analyses such as:</p>

<pre><code>- CFL condition verification (for stability)
- Symbol analysis (e.g., dispersion relation, regularity)
- Wave propagation analysis for second-order equations
</code></pre>

<p>If pseudo-differential operators (ψOp) are present, symbolic analysis is skipped
in favor of interactive exploration via <code>interactive_symbol_analysis</code>.</p>

<h2 id="parameters">Parameters</h2>

<p>Lx : float
    Size of the spatial domain along x-axis.
Ly : float, optional
    Size of the spatial domain along y-axis (for 2D problems).
Nx : int
    Number of spatial points along x-axis.
Ny : int, optional
    Number of spatial points along y-axis (for 2D problems).
Lt : float, default=1.0
    Total simulation time.
Nt : int, default=100
    Number of time steps.
initial_condition : callable
    Function returning the initial state u(x, 0) or u(x, y, 0).
initial_velocity : callable, optional
    Function returning the initial time derivative ∂ₜu(x, 0) or ∂ₜu(x, y, 0),
    required for second-order equations.
n_frames : int, default=100
    Number of time frames to store during simulation for visualization or output.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If mandatory parameters are missing (e.g., Nx not given in 1D, Ly/Ny not given in 2D).</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The spatial discretization assumes periodic boundary conditions by default.</li>
<li>Fourier transforms are computed using real-to-complex FFTs (<code>scipy.fft.fft</code>, <code>fft2</code>).</li>
<li>Frequency arrays (<code>KX</code>, <code>KY</code>) are defined following standard spectral conventions.</li>
<li>Dealiasing is applied using a sharp cutoff filter at a fraction of the maximum frequency.</li>
<li>For second-order equations, initial acceleration is derived from the governing operator.</li>
<li>Symbolic analysis includes plotting of the symbol's real/imaginary/absolute values
and dispersion relation.</li>
</ul>

<h2 id="see-also">See Also</h2>

<p>setup_1D : Sets up internal variables for one-dimensional problems.
setup_2D : Sets up internal variables for two-dimensional problems.
initialize_conditions : Applies initial data and enforces compatibility.
check_cfl_condition : Verifies time step against stability constraints.
plot_symbol : Visualizes the linear operator’s symbol in frequency space.
analyze_wave_propagation : Analyzes group velocity.
interactive_symbol_analysis : Interactive tools for ψOp-based equations.</p>
</div>


                            </div>
                            <div id="PDESolver.solve" class="classattr">
                                        <input id="PDESolver.solve-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">solve</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.solve-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.solve"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.solve-1421"><a href="#PDESolver.solve-1421"><span class="linenos">1421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PDESolver.solve-1422"><a href="#PDESolver.solve-1422"><span class="linenos">1422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.solve-1423"><a href="#PDESolver.solve-1423"><span class="linenos">1423</span></a><span class="sd">        Solve the partial differential equation numerically using spectral methods.</span>
</span><span id="PDESolver.solve-1424"><a href="#PDESolver.solve-1424"><span class="linenos">1424</span></a><span class="sd">        </span>
</span><span id="PDESolver.solve-1425"><a href="#PDESolver.solve-1425"><span class="linenos">1425</span></a><span class="sd">        This method evolves the solution in time using a combination of:</span>
</span><span id="PDESolver.solve-1426"><a href="#PDESolver.solve-1426"><span class="linenos">1426</span></a><span class="sd">        - Fourier-based linear evolution (with dealiasing)</span>
</span><span id="PDESolver.solve-1427"><a href="#PDESolver.solve-1427"><span class="linenos">1427</span></a><span class="sd">        - Nonlinear term handling via pseudo-spectral evaluation</span>
</span><span id="PDESolver.solve-1428"><a href="#PDESolver.solve-1428"><span class="linenos">1428</span></a><span class="sd">        - Support for pseudo-differential operators (psiOp)</span>
</span><span id="PDESolver.solve-1429"><a href="#PDESolver.solve-1429"><span class="linenos">1429</span></a><span class="sd">        - Source terms and boundary conditions</span>
</span><span id="PDESolver.solve-1430"><a href="#PDESolver.solve-1430"><span class="linenos">1430</span></a><span class="sd">        </span>
</span><span id="PDESolver.solve-1431"><a href="#PDESolver.solve-1431"><span class="linenos">1431</span></a><span class="sd">        The solver supports:</span>
</span><span id="PDESolver.solve-1432"><a href="#PDESolver.solve-1432"><span class="linenos">1432</span></a><span class="sd">        - 1D and 2D spatial domains</span>
</span><span id="PDESolver.solve-1433"><a href="#PDESolver.solve-1433"><span class="linenos">1433</span></a><span class="sd">        - First and second-order time evolution</span>
</span><span id="PDESolver.solve-1434"><a href="#PDESolver.solve-1434"><span class="linenos">1434</span></a><span class="sd">        - Periodic and Dirichlet boundary conditions</span>
</span><span id="PDESolver.solve-1435"><a href="#PDESolver.solve-1435"><span class="linenos">1435</span></a><span class="sd">        - Time-stepping schemes: default, ETD-RK4</span>
</span><span id="PDESolver.solve-1436"><a href="#PDESolver.solve-1436"><span class="linenos">1436</span></a><span class="sd">        </span>
</span><span id="PDESolver.solve-1437"><a href="#PDESolver.solve-1437"><span class="linenos">1437</span></a><span class="sd">        Returns:</span>
</span><span id="PDESolver.solve-1438"><a href="#PDESolver.solve-1438"><span class="linenos">1438</span></a><span class="sd">            list[np.ndarray]: A list of solution arrays at each saved time frame.</span>
</span><span id="PDESolver.solve-1439"><a href="#PDESolver.solve-1439"><span class="linenos">1439</span></a><span class="sd">        </span>
</span><span id="PDESolver.solve-1440"><a href="#PDESolver.solve-1440"><span class="linenos">1440</span></a><span class="sd">        Side Effects:</span>
</span><span id="PDESolver.solve-1441"><a href="#PDESolver.solve-1441"><span class="linenos">1441</span></a><span class="sd">            - Updates self.frames: stores solution snapshots</span>
</span><span id="PDESolver.solve-1442"><a href="#PDESolver.solve-1442"><span class="linenos">1442</span></a><span class="sd">            - Updates self.energy_history: records total energy if enabled</span>
</span><span id="PDESolver.solve-1443"><a href="#PDESolver.solve-1443"><span class="linenos">1443</span></a><span class="sd">            </span>
</span><span id="PDESolver.solve-1444"><a href="#PDESolver.solve-1444"><span class="linenos">1444</span></a><span class="sd">        Algorithm Overview:</span>
</span><span id="PDESolver.solve-1445"><a href="#PDESolver.solve-1445"><span class="linenos">1445</span></a><span class="sd">            For each time step:</span>
</span><span id="PDESolver.solve-1446"><a href="#PDESolver.solve-1446"><span class="linenos">1446</span></a><span class="sd">                1. Evaluate source contributions (if any)</span>
</span><span id="PDESolver.solve-1447"><a href="#PDESolver.solve-1447"><span class="linenos">1447</span></a><span class="sd">                2. Apply time evolution:</span>
</span><span id="PDESolver.solve-1448"><a href="#PDESolver.solve-1448"><span class="linenos">1448</span></a><span class="sd">                    - Order 1:</span>
</span><span id="PDESolver.solve-1449"><a href="#PDESolver.solve-1449"><span class="linenos">1449</span></a><span class="sd">                        - With psiOp: uses step_order1_with_psi</span>
</span><span id="PDESolver.solve-1450"><a href="#PDESolver.solve-1450"><span class="linenos">1450</span></a><span class="sd">                        - With ETD-RK4: exponential time differencing</span>
</span><span id="PDESolver.solve-1451"><a href="#PDESolver.solve-1451"><span class="linenos">1451</span></a><span class="sd">                        - Default: linear + nonlinear update</span>
</span><span id="PDESolver.solve-1452"><a href="#PDESolver.solve-1452"><span class="linenos">1452</span></a><span class="sd">                    - Order 2:</span>
</span><span id="PDESolver.solve-1453"><a href="#PDESolver.solve-1453"><span class="linenos">1453</span></a><span class="sd">                        - With psiOp: uses step_order2_with_psi</span>
</span><span id="PDESolver.solve-1454"><a href="#PDESolver.solve-1454"><span class="linenos">1454</span></a><span class="sd">                        - With ETD-RK4: second-order exponential scheme</span>
</span><span id="PDESolver.solve-1455"><a href="#PDESolver.solve-1455"><span class="linenos">1455</span></a><span class="sd">                        - Default: second-order leapfrog-style update</span>
</span><span id="PDESolver.solve-1456"><a href="#PDESolver.solve-1456"><span class="linenos">1456</span></a><span class="sd">                3. Enforce boundary conditions</span>
</span><span id="PDESolver.solve-1457"><a href="#PDESolver.solve-1457"><span class="linenos">1457</span></a><span class="sd">                4. Save solution snapshot periodically</span>
</span><span id="PDESolver.solve-1458"><a href="#PDESolver.solve-1458"><span class="linenos">1458</span></a><span class="sd">                5. Record energy (for second-order systems without psiOp)</span>
</span><span id="PDESolver.solve-1459"><a href="#PDESolver.solve-1459"><span class="linenos">1459</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.solve-1460"><a href="#PDESolver.solve-1460"><span class="linenos">1460</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*******************&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve-1461"><a href="#PDESolver.solve-1461"><span class="linenos">1461</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* Solving the PDE *&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve-1462"><a href="#PDESolver.solve-1462"><span class="linenos">1462</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*******************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve-1463"><a href="#PDESolver.solve-1463"><span class="linenos">1463</span></a>        <span class="n">save_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
</span><span id="PDESolver.solve-1464"><a href="#PDESolver.solve-1464"><span class="linenos">1464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PDESolver.solve-1465"><a href="#PDESolver.solve-1465"><span class="linenos">1465</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">):</span>
</span><span id="PDESolver.solve-1466"><a href="#PDESolver.solve-1466"><span class="linenos">1466</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;source_terms&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver.solve-1467"><a href="#PDESolver.solve-1467"><span class="linenos">1467</span></a>                <span class="n">source_contribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="PDESolver.solve-1468"><a href="#PDESolver.solve-1468"><span class="linenos">1468</span></a>                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver.solve-1469"><a href="#PDESolver.solve-1469"><span class="linenos">1469</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver.solve-1470"><a href="#PDESolver.solve-1470"><span class="linenos">1470</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve-1471"><a href="#PDESolver.solve-1471"><span class="linenos">1471</span></a>                            <span class="n">source_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve-1472"><a href="#PDESolver.solve-1472"><span class="linenos">1472</span></a>                            <span class="n">source_contribution</span> <span class="o">+=</span> <span class="n">source_func</span><span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver.solve-1473"><a href="#PDESolver.solve-1473"><span class="linenos">1473</span></a>                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.solve-1474"><a href="#PDESolver.solve-1474"><span class="linenos">1474</span></a>                            <span class="n">source_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve-1475"><a href="#PDESolver.solve-1475"><span class="linenos">1475</span></a>                            <span class="n">source_contribution</span> <span class="o">+=</span> <span class="n">source_func</span><span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PDESolver.solve-1476"><a href="#PDESolver.solve-1476"><span class="linenos">1476</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="PDESolver.solve-1477"><a href="#PDESolver.solve-1477"><span class="linenos">1477</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error evaluating source term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve-1478"><a href="#PDESolver.solve-1478"><span class="linenos">1478</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve-1479"><a href="#PDESolver.solve-1479"><span class="linenos">1479</span></a>                <span class="n">source_contribution</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver.solve-1480"><a href="#PDESolver.solve-1480"><span class="linenos">1480</span></a>
</span><span id="PDESolver.solve-1481"><a href="#PDESolver.solve-1481"><span class="linenos">1481</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve-1482"><a href="#PDESolver.solve-1482"><span class="linenos">1482</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver.solve-1483"><a href="#PDESolver.solve-1483"><span class="linenos">1483</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_order1_with_psi</span><span class="p">(</span><span class="n">source_contribution</span><span class="p">)</span>
</span><span id="PDESolver.solve-1484"><a href="#PDESolver.solve-1484"><span class="linenos">1484</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time_scheme&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scheme</span> <span class="o">==</span> <span class="s1">&#39;ETD-RK4&#39;</span><span class="p">:</span>
</span><span id="PDESolver.solve-1485"><a href="#PDESolver.solve-1485"><span class="linenos">1485</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_ETD_RK4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver.solve-1486"><a href="#PDESolver.solve-1486"><span class="linenos">1486</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve-1487"><a href="#PDESolver.solve-1487"><span class="linenos">1487</span></a>                    <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver.solve-1488"><a href="#PDESolver.solve-1488"><span class="linenos">1488</span></a>                    <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_L</span>
</span><span id="PDESolver.solve-1489"><a href="#PDESolver.solve-1489"><span class="linenos">1489</span></a>                    <span class="n">u_hat</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dealiasing_mask</span>
</span><span id="PDESolver.solve-1490"><a href="#PDESolver.solve-1490"><span class="linenos">1490</span></a>                    <span class="n">u_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver.solve-1491"><a href="#PDESolver.solve-1491"><span class="linenos">1491</span></a>                    <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="n">u_lin</span><span class="p">)</span>
</span><span id="PDESolver.solve-1492"><a href="#PDESolver.solve-1492"><span class="linenos">1492</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="n">u_lin</span> <span class="o">+</span> <span class="n">u_nl</span> <span class="o">+</span> <span class="n">source_contribution</span>
</span><span id="PDESolver.solve-1493"><a href="#PDESolver.solve-1493"><span class="linenos">1493</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
</span><span id="PDESolver.solve-1494"><a href="#PDESolver.solve-1494"><span class="linenos">1494</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">u_new</span>
</span><span id="PDESolver.solve-1495"><a href="#PDESolver.solve-1495"><span class="linenos">1495</span></a>
</span><span id="PDESolver.solve-1496"><a href="#PDESolver.solve-1496"><span class="linenos">1496</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.solve-1497"><a href="#PDESolver.solve-1497"><span class="linenos">1497</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver.solve-1498"><a href="#PDESolver.solve-1498"><span class="linenos">1498</span></a>                    <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_order2_with_psi</span><span class="p">(</span><span class="n">source_contribution</span><span class="p">)</span>
</span><span id="PDESolver.solve-1499"><a href="#PDESolver.solve-1499"><span class="linenos">1499</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve-1500"><a href="#PDESolver.solve-1500"><span class="linenos">1500</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time_scheme&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scheme</span> <span class="o">==</span> <span class="s1">&#39;ETD-RK4&#39;</span><span class="p">:</span>
</span><span id="PDESolver.solve-1501"><a href="#PDESolver.solve-1501"><span class="linenos">1501</span></a>                        <span class="n">u_new</span><span class="p">,</span> <span class="n">v_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_ETD_RK4_order2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">)</span>
</span><span id="PDESolver.solve-1502"><a href="#PDESolver.solve-1502"><span class="linenos">1502</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve-1503"><a href="#PDESolver.solve-1503"><span class="linenos">1503</span></a>                        <span class="n">u_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">)</span>
</span><span id="PDESolver.solve-1504"><a href="#PDESolver.solve-1504"><span class="linenos">1504</span></a>                        <span class="n">v_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">)</span>
</span><span id="PDESolver.solve-1505"><a href="#PDESolver.solve-1505"><span class="linenos">1505</span></a>                        <span class="n">u_new_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_omega_dt</span> <span class="o">*</span> <span class="n">u_hat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sin_omega_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_omega</span> <span class="o">*</span> <span class="n">v_hat</span>
</span><span id="PDESolver.solve-1506"><a href="#PDESolver.solve-1506"><span class="linenos">1506</span></a>                        <span class="n">v_new_hat</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_val</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sin_omega_dt</span> <span class="o">*</span> <span class="n">u_hat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_omega_dt</span> <span class="o">*</span> <span class="n">v_hat</span>
</span><span id="PDESolver.solve-1507"><a href="#PDESolver.solve-1507"><span class="linenos">1507</span></a>                        <span class="n">u_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_new_hat</span><span class="p">)</span>
</span><span id="PDESolver.solve-1508"><a href="#PDESolver.solve-1508"><span class="linenos">1508</span></a>                        <span class="n">v_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">v_new_hat</span><span class="p">)</span>
</span><span id="PDESolver.solve-1509"><a href="#PDESolver.solve-1509"><span class="linenos">1509</span></a>                        <span class="n">u_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PDESolver.solve-1510"><a href="#PDESolver.solve-1510"><span class="linenos">1510</span></a>                        <span class="n">v_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span><span class="p">,</span> <span class="n">is_v</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver.solve-1511"><a href="#PDESolver.solve-1511"><span class="linenos">1511</span></a>                        <span class="n">u_new</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_nl</span> <span class="o">+</span> <span class="n">source_contribution</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="PDESolver.solve-1512"><a href="#PDESolver.solve-1512"><span class="linenos">1512</span></a>                        <span class="n">v_new</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_nl</span> <span class="o">+</span> <span class="n">source_contribution</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="PDESolver.solve-1513"><a href="#PDESolver.solve-1513"><span class="linenos">1513</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
</span><span id="PDESolver.solve-1514"><a href="#PDESolver.solve-1514"><span class="linenos">1514</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_boundary</span><span class="p">(</span><span class="n">v_new</span><span class="p">)</span>
</span><span id="PDESolver.solve-1515"><a href="#PDESolver.solve-1515"><span class="linenos">1515</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span> <span class="o">=</span> <span class="n">u_new</span>
</span><span id="PDESolver.solve-1516"><a href="#PDESolver.solve-1516"><span class="linenos">1516</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">v_prev</span> <span class="o">=</span> <span class="n">v_new</span>
</span><span id="PDESolver.solve-1517"><a href="#PDESolver.solve-1517"><span class="linenos">1517</span></a>
</span><span id="PDESolver.solve-1518"><a href="#PDESolver.solve-1518"><span class="linenos">1518</span></a>            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">save_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver.solve-1519"><a href="#PDESolver.solve-1519"><span class="linenos">1519</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_prev</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="PDESolver.solve-1520"><a href="#PDESolver.solve-1520"><span class="linenos">1520</span></a>
</span><span id="PDESolver.solve-1521"><a href="#PDESolver.solve-1521"><span class="linenos">1521</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">):</span>
</span><span id="PDESolver.solve-1522"><a href="#PDESolver.solve-1522"><span class="linenos">1522</span></a>                <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_energy</span><span class="p">()</span>
</span><span id="PDESolver.solve-1523"><a href="#PDESolver.solve-1523"><span class="linenos">1523</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
</span><span id="PDESolver.solve-1524"><a href="#PDESolver.solve-1524"><span class="linenos">1524</span></a>
</span><span id="PDESolver.solve-1525"><a href="#PDESolver.solve-1525"><span class="linenos">1525</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span>  
</span></pre></div>


            <div class="docstring"><p>Solve the partial differential equation numerically using spectral methods.</p>

<p>This method evolves the solution in time using a combination of:</p>

<ul>
<li>Fourier-based linear evolution (with dealiasing)</li>
<li>Nonlinear term handling via pseudo-spectral evaluation</li>
<li>Support for pseudo-differential operators (psiOp)</li>
<li>Source terms and boundary conditions</li>
</ul>

<p>The solver supports:</p>

<ul>
<li>1D and 2D spatial domains</li>
<li>First and second-order time evolution</li>
<li>Periodic and Dirichlet boundary conditions</li>
<li>Time-stepping schemes: default, ETD-RK4</li>
</ul>

<p>Returns:
    list[np.ndarray]: A list of solution arrays at each saved time frame.</p>

<p>Side Effects:
    - Updates self.frames: stores solution snapshots
    - Updates self.energy_history: records total energy if enabled</p>

<p>Algorithm Overview:
    For each time step:
        1. Evaluate source contributions (if any)
        2. Apply time evolution:
            - Order 1:
                - With psiOp: uses step_order1_with_psi
                - With ETD-RK4: exponential time differencing
                - Default: linear + nonlinear update
            - Order 2:
                - With psiOp: uses step_order2_with_psi
                - With ETD-RK4: second-order exponential scheme
                - Default: second-order leapfrog-style update
        3. Enforce boundary conditions
        4. Save solution snapshot periodically
        5. Record energy (for second-order systems without psiOp)</p>
</div>


                            </div>
                            <div id="PDESolver.solve_stationary_psiOp" class="classattr">
                                        <input id="PDESolver.solve_stationary_psiOp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">solve_stationary_psiOp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">order</span><span class="o">=</span><span class="mi">3</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.solve_stationary_psiOp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.solve_stationary_psiOp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.solve_stationary_psiOp-1527"><a href="#PDESolver.solve_stationary_psiOp-1527"><span class="linenos">1527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stationary_psiOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="PDESolver.solve_stationary_psiOp-1528"><a href="#PDESolver.solve_stationary_psiOp-1528"><span class="linenos">1528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.solve_stationary_psiOp-1529"><a href="#PDESolver.solve_stationary_psiOp-1529"><span class="linenos">1529</span></a><span class="sd">        Solve stationary pseudo-differential equations of the form P[u] = f(x) or P[u] = f(x,y) using asymptotic inversion.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1530"><a href="#PDESolver.solve_stationary_psiOp-1530"><span class="linenos">1530</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1531"><a href="#PDESolver.solve_stationary_psiOp-1531"><span class="linenos">1531</span></a><span class="sd">        This method computes the solution to a stationary (time-independent) pseudo-differential equation</span>
</span><span id="PDESolver.solve_stationary_psiOp-1532"><a href="#PDESolver.solve_stationary_psiOp-1532"><span class="linenos">1532</span></a><span class="sd">        where the operator P is defined via symbolic expressions (psiOp). It constructs an asymptotic right inverse R </span>
</span><span id="PDESolver.solve_stationary_psiOp-1533"><a href="#PDESolver.solve_stationary_psiOp-1533"><span class="linenos">1533</span></a><span class="sd">        such that P∘R ≈ Id, then applies it to the source term f using either direct Fourier multiplication </span>
</span><span id="PDESolver.solve_stationary_psiOp-1534"><a href="#PDESolver.solve_stationary_psiOp-1534"><span class="linenos">1534</span></a><span class="sd">        (when the symbol is spatially independent) or Kohn–Nirenberg quantization (when spatial dependence is present).</span>
</span><span id="PDESolver.solve_stationary_psiOp-1535"><a href="#PDESolver.solve_stationary_psiOp-1535"><span class="linenos">1535</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1536"><a href="#PDESolver.solve_stationary_psiOp-1536"><span class="linenos">1536</span></a><span class="sd">        The inversion is based on the principal symbol of the operator and its asymptotic expansion up to the given order.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1537"><a href="#PDESolver.solve_stationary_psiOp-1537"><span class="linenos">1537</span></a><span class="sd">        Ellipticity of the symbol is checked numerically before inversion to ensure well-posedness.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1538"><a href="#PDESolver.solve_stationary_psiOp-1538"><span class="linenos">1538</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1539"><a href="#PDESolver.solve_stationary_psiOp-1539"><span class="linenos">1539</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver.solve_stationary_psiOp-1540"><a href="#PDESolver.solve_stationary_psiOp-1540"><span class="linenos">1540</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver.solve_stationary_psiOp-1541"><a href="#PDESolver.solve_stationary_psiOp-1541"><span class="linenos">1541</span></a><span class="sd">        order : int, default=3</span>
</span><span id="PDESolver.solve_stationary_psiOp-1542"><a href="#PDESolver.solve_stationary_psiOp-1542"><span class="linenos">1542</span></a><span class="sd">            Order of the asymptotic expansion used to construct the right inverse of the pseudo-differential operator.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1543"><a href="#PDESolver.solve_stationary_psiOp-1543"><span class="linenos">1543</span></a><span class="sd">        method : str, optional</span>
</span><span id="PDESolver.solve_stationary_psiOp-1544"><a href="#PDESolver.solve_stationary_psiOp-1544"><span class="linenos">1544</span></a><span class="sd">            Inversion strategy:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1545"><a href="#PDESolver.solve_stationary_psiOp-1545"><span class="linenos">1545</span></a><span class="sd">            - &#39;diagonal&#39; (default): Fast approximate inversion using diagonal operators in frequency space.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1546"><a href="#PDESolver.solve_stationary_psiOp-1546"><span class="linenos">1546</span></a><span class="sd">            - &#39;full&#39;                : Pointwise exact inversion (slower but more accurate).</span>
</span><span id="PDESolver.solve_stationary_psiOp-1547"><a href="#PDESolver.solve_stationary_psiOp-1547"><span class="linenos">1547</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1548"><a href="#PDESolver.solve_stationary_psiOp-1548"><span class="linenos">1548</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver.solve_stationary_psiOp-1549"><a href="#PDESolver.solve_stationary_psiOp-1549"><span class="linenos">1549</span></a><span class="sd">        -------</span>
</span><span id="PDESolver.solve_stationary_psiOp-1550"><a href="#PDESolver.solve_stationary_psiOp-1550"><span class="linenos">1550</span></a><span class="sd">        ndarray</span>
</span><span id="PDESolver.solve_stationary_psiOp-1551"><a href="#PDESolver.solve_stationary_psiOp-1551"><span class="linenos">1551</span></a><span class="sd">            The computed solution u(x) in 1D or u(x, y) in 2D as a NumPy array over the spatial grid.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1552"><a href="#PDESolver.solve_stationary_psiOp-1552"><span class="linenos">1552</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1553"><a href="#PDESolver.solve_stationary_psiOp-1553"><span class="linenos">1553</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver.solve_stationary_psiOp-1554"><a href="#PDESolver.solve_stationary_psiOp-1554"><span class="linenos">1554</span></a><span class="sd">        ------</span>
</span><span id="PDESolver.solve_stationary_psiOp-1555"><a href="#PDESolver.solve_stationary_psiOp-1555"><span class="linenos">1555</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver.solve_stationary_psiOp-1556"><a href="#PDESolver.solve_stationary_psiOp-1556"><span class="linenos">1556</span></a><span class="sd">            If no pseudo-differential operator (psiOp) is defined.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1557"><a href="#PDESolver.solve_stationary_psiOp-1557"><span class="linenos">1557</span></a><span class="sd">            If linear or nonlinear terms other than psiOp are present.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1558"><a href="#PDESolver.solve_stationary_psiOp-1558"><span class="linenos">1558</span></a><span class="sd">            If the symbol is not elliptic on the grid.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1559"><a href="#PDESolver.solve_stationary_psiOp-1559"><span class="linenos">1559</span></a><span class="sd">            If no source term is provided for the right-hand side.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1560"><a href="#PDESolver.solve_stationary_psiOp-1560"><span class="linenos">1560</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1561"><a href="#PDESolver.solve_stationary_psiOp-1561"><span class="linenos">1561</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver.solve_stationary_psiOp-1562"><a href="#PDESolver.solve_stationary_psiOp-1562"><span class="linenos">1562</span></a><span class="sd">        -----</span>
</span><span id="PDESolver.solve_stationary_psiOp-1563"><a href="#PDESolver.solve_stationary_psiOp-1563"><span class="linenos">1563</span></a><span class="sd">        - The method assumes the problem is fully stationary: time derivatives must be absent.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1564"><a href="#PDESolver.solve_stationary_psiOp-1564"><span class="linenos">1564</span></a><span class="sd">        - Requires the equation to be purely pseudo-differential (no Op, Derivative, or nonlinear terms).</span>
</span><span id="PDESolver.solve_stationary_psiOp-1565"><a href="#PDESolver.solve_stationary_psiOp-1565"><span class="linenos">1565</span></a><span class="sd">        - Symbol evaluation and inversion are dimension-aware (supports both 1D and 2D problems).</span>
</span><span id="PDESolver.solve_stationary_psiOp-1566"><a href="#PDESolver.solve_stationary_psiOp-1566"><span class="linenos">1566</span></a><span class="sd">        - Supports optimization paths when the symbol does not depend on spatial variables.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1567"><a href="#PDESolver.solve_stationary_psiOp-1567"><span class="linenos">1567</span></a><span class="sd">    </span>
</span><span id="PDESolver.solve_stationary_psiOp-1568"><a href="#PDESolver.solve_stationary_psiOp-1568"><span class="linenos">1568</span></a><span class="sd">        See Also</span>
</span><span id="PDESolver.solve_stationary_psiOp-1569"><a href="#PDESolver.solve_stationary_psiOp-1569"><span class="linenos">1569</span></a><span class="sd">        --------</span>
</span><span id="PDESolver.solve_stationary_psiOp-1570"><a href="#PDESolver.solve_stationary_psiOp-1570"><span class="linenos">1570</span></a><span class="sd">        right_inverse_asymptotic : Constructs the asymptotic inverse of the pseudo-differential operator.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1571"><a href="#PDESolver.solve_stationary_psiOp-1571"><span class="linenos">1571</span></a><span class="sd">        kohn_nirenberg           : Numerical implementation of general pseudo-differential operators.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1572"><a href="#PDESolver.solve_stationary_psiOp-1572"><span class="linenos">1572</span></a><span class="sd">        is_elliptic_numerically  : Verifies numerical ellipticity of the symbol.</span>
</span><span id="PDESolver.solve_stationary_psiOp-1573"><a href="#PDESolver.solve_stationary_psiOp-1573"><span class="linenos">1573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.solve_stationary_psiOp-1574"><a href="#PDESolver.solve_stationary_psiOp-1574"><span class="linenos">1574</span></a>
</span><span id="PDESolver.solve_stationary_psiOp-1575"><a href="#PDESolver.solve_stationary_psiOp-1575"><span class="linenos">1575</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1576"><a href="#PDESolver.solve_stationary_psiOp-1576"><span class="linenos">1576</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Solving the stationnary PDE *&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1577"><a href="#PDESolver.solve_stationary_psiOp-1577"><span class="linenos">1577</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*******************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1578"><a href="#PDESolver.solve_stationary_psiOp-1578"><span class="linenos">1578</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;boundary condition: &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1579"><a href="#PDESolver.solve_stationary_psiOp-1579"><span class="linenos">1579</span></a>        
</span><span id="PDESolver.solve_stationary_psiOp-1580"><a href="#PDESolver.solve_stationary_psiOp-1580"><span class="linenos">1580</span></a>
</span><span id="PDESolver.solve_stationary_psiOp-1581"><a href="#PDESolver.solve_stationary_psiOp-1581"><span class="linenos">1581</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_psi</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1582"><a href="#PDESolver.solve_stationary_psiOp-1582"><span class="linenos">1582</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only supports problems with psiOp.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1583"><a href="#PDESolver.solve_stationary_psiOp-1583"><span class="linenos">1583</span></a>    
</span><span id="PDESolver.solve_stationary_psiOp-1584"><a href="#PDESolver.solve_stationary_psiOp-1584"><span class="linenos">1584</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_terms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_terms</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1585"><a href="#PDESolver.solve_stationary_psiOp-1585"><span class="linenos">1585</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stationary psiOp problems must be linear and purely pseudo-differential.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1586"><a href="#PDESolver.solve_stationary_psiOp-1586"><span class="linenos">1586</span></a>
</span><span id="PDESolver.solve_stationary_psiOp-1587"><a href="#PDESolver.solve_stationary_psiOp-1587"><span class="linenos">1587</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;periodic&#39;</span><span class="p">,</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">):</span>
</span><span id="PDESolver.solve_stationary_psiOp-1588"><a href="#PDESolver.solve_stationary_psiOp-1588"><span class="linenos">1588</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PDESolver.solve_stationary_psiOp-1589"><a href="#PDESolver.solve_stationary_psiOp-1589"><span class="linenos">1589</span></a>                <span class="s2">&quot;For stationary PDEs, boundary conditions must be explicitly defined. &quot;</span>
</span><span id="PDESolver.solve_stationary_psiOp-1590"><a href="#PDESolver.solve_stationary_psiOp-1590"><span class="linenos">1590</span></a>                <span class="s2">&quot;Supported types are &#39;periodic&#39; and &#39;dirichlet&#39;.&quot;</span>
</span><span id="PDESolver.solve_stationary_psiOp-1591"><a href="#PDESolver.solve_stationary_psiOp-1591"><span class="linenos">1591</span></a>            <span class="p">)</span>    
</span><span id="PDESolver.solve_stationary_psiOp-1592"><a href="#PDESolver.solve_stationary_psiOp-1592"><span class="linenos">1592</span></a>            
</span><span id="PDESolver.solve_stationary_psiOp-1593"><a href="#PDESolver.solve_stationary_psiOp-1593"><span class="linenos">1593</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1594"><a href="#PDESolver.solve_stationary_psiOp-1594"><span class="linenos">1594</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
</span><span id="PDESolver.solve_stationary_psiOp-1595"><a href="#PDESolver.solve_stationary_psiOp-1595"><span class="linenos">1595</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1596"><a href="#PDESolver.solve_stationary_psiOp-1596"><span class="linenos">1596</span></a>            <span class="n">spatial_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1597"><a href="#PDESolver.solve_stationary_psiOp-1597"><span class="linenos">1597</span></a>            <span class="n">freq_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="p">,)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1598"><a href="#PDESolver.solve_stationary_psiOp-1598"><span class="linenos">1598</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">KX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span>
</span><span id="PDESolver.solve_stationary_psiOp-1599"><a href="#PDESolver.solve_stationary_psiOp-1599"><span class="linenos">1599</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1600"><a href="#PDESolver.solve_stationary_psiOp-1600"><span class="linenos">1600</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
</span><span id="PDESolver.solve_stationary_psiOp-1601"><a href="#PDESolver.solve_stationary_psiOp-1601"><span class="linenos">1601</span></a>            <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;xi eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1602"><a href="#PDESolver.solve_stationary_psiOp-1602"><span class="linenos">1602</span></a>            <span class="n">spatial_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1603"><a href="#PDESolver.solve_stationary_psiOp-1603"><span class="linenos">1603</span></a>            <span class="n">freq_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1604"><a href="#PDESolver.solve_stationary_psiOp-1604"><span class="linenos">1604</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">KX</span><span class="p">,</span> <span class="n">KY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span>
</span><span id="PDESolver.solve_stationary_psiOp-1605"><a href="#PDESolver.solve_stationary_psiOp-1605"><span class="linenos">1605</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1606"><a href="#PDESolver.solve_stationary_psiOp-1606"><span class="linenos">1606</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported spatial dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1607"><a href="#PDESolver.solve_stationary_psiOp-1607"><span class="linenos">1607</span></a>    
</span><span id="PDESolver.solve_stationary_psiOp-1608"><a href="#PDESolver.solve_stationary_psiOp-1608"><span class="linenos">1608</span></a>        <span class="n">total_symbol</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff</span> <span class="o">*</span> <span class="n">psi</span><span class="o">.</span><span class="n">expr</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">psi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_ops</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1609"><a href="#PDESolver.solve_stationary_psiOp-1609"><span class="linenos">1609</span></a>        <span class="n">psi_total</span> <span class="o">=</span> <span class="n">PseudoDifferentialOperator</span><span class="p">(</span><span class="n">total_symbol</span><span class="p">,</span> <span class="n">spatial_vars</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1610"><a href="#PDESolver.solve_stationary_psiOp-1610"><span class="linenos">1610</span></a>    
</span><span id="PDESolver.solve_stationary_psiOp-1611"><a href="#PDESolver.solve_stationary_psiOp-1611"><span class="linenos">1611</span></a>        <span class="c1"># Check ellipticity</span>
</span><span id="PDESolver.solve_stationary_psiOp-1612"><a href="#PDESolver.solve_stationary_psiOp-1612"><span class="linenos">1612</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1613"><a href="#PDESolver.solve_stationary_psiOp-1613"><span class="linenos">1613</span></a>            <span class="n">is_elliptic</span> <span class="o">=</span> <span class="n">psi_total</span><span class="o">.</span><span class="n">is_elliptic_numerically</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">KX</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1614"><a href="#PDESolver.solve_stationary_psiOp-1614"><span class="linenos">1614</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1615"><a href="#PDESolver.solve_stationary_psiOp-1615"><span class="linenos">1615</span></a>            <span class="n">is_elliptic</span> <span class="o">=</span> <span class="n">psi_total</span><span class="o">.</span><span class="n">is_elliptic_numerically</span><span class="p">((</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="p">(</span><span class="n">KX</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">KY</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
</span><span id="PDESolver.solve_stationary_psiOp-1616"><a href="#PDESolver.solve_stationary_psiOp-1616"><span class="linenos">1616</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_elliptic</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1617"><a href="#PDESolver.solve_stationary_psiOp-1617"><span class="linenos">1617</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;❌ The pseudo-differential symbol is not numerically elliptic on the grid.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1618"><a href="#PDESolver.solve_stationary_psiOp-1618"><span class="linenos">1618</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Elliptic pseudo-differential symbol: inversion allowed.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1619"><a href="#PDESolver.solve_stationary_psiOp-1619"><span class="linenos">1619</span></a>    
</span><span id="PDESolver.solve_stationary_psiOp-1620"><a href="#PDESolver.solve_stationary_psiOp-1620"><span class="linenos">1620</span></a>        <span class="n">R_symbol</span> <span class="o">=</span> <span class="n">psi_total</span><span class="o">.</span><span class="n">right_inverse_asymptotic</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1621"><a href="#PDESolver.solve_stationary_psiOp-1621"><span class="linenos">1621</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Right inverse asymptotic symbol:&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1622"><a href="#PDESolver.solve_stationary_psiOp-1622"><span class="linenos">1622</span></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">R_symbol</span><span class="p">,</span> <span class="n">num_columns</span><span class="o">=</span><span class="n">NUM_COLS</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1623"><a href="#PDESolver.solve_stationary_psiOp-1623"><span class="linenos">1623</span></a>        
</span><span id="PDESolver.solve_stationary_psiOp-1624"><a href="#PDESolver.solve_stationary_psiOp-1624"><span class="linenos">1624</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver.solve_stationary_psiOp-1625"><a href="#PDESolver.solve_stationary_psiOp-1625"><span class="linenos">1625</span></a>        <span class="c1"># FIX: Always lambdify with all variables for consistency</span>
</span><span id="PDESolver.solve_stationary_psiOp-1626"><a href="#PDESolver.solve_stationary_psiOp-1626"><span class="linenos">1626</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver.solve_stationary_psiOp-1627"><a href="#PDESolver.solve_stationary_psiOp-1627"><span class="linenos">1627</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1628"><a href="#PDESolver.solve_stationary_psiOp-1628"><span class="linenos">1628</span></a>            <span class="c1"># Always include both x and xi in the signature</span>
</span><span id="PDESolver.solve_stationary_psiOp-1629"><a href="#PDESolver.solve_stationary_psiOp-1629"><span class="linenos">1629</span></a>            <span class="n">R_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> <span class="n">R_symbol</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1630"><a href="#PDESolver.solve_stationary_psiOp-1630"><span class="linenos">1630</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1631"><a href="#PDESolver.solve_stationary_psiOp-1631"><span class="linenos">1631</span></a>            <span class="c1"># Always include all four variables</span>
</span><span id="PDESolver.solve_stationary_psiOp-1632"><a href="#PDESolver.solve_stationary_psiOp-1632"><span class="linenos">1632</span></a>            <span class="n">R_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span> <span class="n">R_symbol</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1633"><a href="#PDESolver.solve_stationary_psiOp-1633"><span class="linenos">1633</span></a>        
</span><span id="PDESolver.solve_stationary_psiOp-1634"><a href="#PDESolver.solve_stationary_psiOp-1634"><span class="linenos">1634</span></a>        <span class="c1"># Prepare right-hand side</span>
</span><span id="PDESolver.solve_stationary_psiOp-1635"><a href="#PDESolver.solve_stationary_psiOp-1635"><span class="linenos">1635</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1636"><a href="#PDESolver.solve_stationary_psiOp-1636"><span class="linenos">1636</span></a>            <span class="n">f_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_terms</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1637"><a href="#PDESolver.solve_stationary_psiOp-1637"><span class="linenos">1637</span></a>            <span class="n">used_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spatial_vars</span> <span class="k">if</span> <span class="n">f_expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
</span><span id="PDESolver.solve_stationary_psiOp-1638"><a href="#PDESolver.solve_stationary_psiOp-1638"><span class="linenos">1638</span></a>            <span class="n">f_func</span> <span class="o">=</span> <span class="n">lambdify</span><span class="p">(</span><span class="n">used_vars</span><span class="p">,</span> <span class="o">-</span><span class="n">f_expr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1639"><a href="#PDESolver.solve_stationary_psiOp-1639"><span class="linenos">1639</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1640"><a href="#PDESolver.solve_stationary_psiOp-1640"><span class="linenos">1640</span></a>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">f_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">)</span> <span class="k">if</span> <span class="n">used_vars</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1641"><a href="#PDESolver.solve_stationary_psiOp-1641"><span class="linenos">1641</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1642"><a href="#PDESolver.solve_stationary_psiOp-1642"><span class="linenos">1642</span></a>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">f_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="k">if</span> <span class="n">used_vars</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1643"><a href="#PDESolver.solve_stationary_psiOp-1643"><span class="linenos">1643</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1644"><a href="#PDESolver.solve_stationary_psiOp-1644"><span class="linenos">1644</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Initial condition should be None for stationnary equation.&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1645"><a href="#PDESolver.solve_stationary_psiOp-1645"><span class="linenos">1645</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1646"><a href="#PDESolver.solve_stationary_psiOp-1646"><span class="linenos">1646</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No source term provided to construct the right-hand side.&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1647"><a href="#PDESolver.solve_stationary_psiOp-1647"><span class="linenos">1647</span></a>        
</span><span id="PDESolver.solve_stationary_psiOp-1648"><a href="#PDESolver.solve_stationary_psiOp-1648"><span class="linenos">1648</span></a>        <span class="n">f_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1649"><a href="#PDESolver.solve_stationary_psiOp-1649"><span class="linenos">1649</span></a>        
</span><span id="PDESolver.solve_stationary_psiOp-1650"><a href="#PDESolver.solve_stationary_psiOp-1650"><span class="linenos">1650</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver.solve_stationary_psiOp-1651"><a href="#PDESolver.solve_stationary_psiOp-1651"><span class="linenos">1651</span></a>        <span class="c1"># Application of the inverse operator</span>
</span><span id="PDESolver.solve_stationary_psiOp-1652"><a href="#PDESolver.solve_stationary_psiOp-1652"><span class="linenos">1652</span></a>        <span class="c1"># ========================================================================</span>
</span><span id="PDESolver.solve_stationary_psiOp-1653"><a href="#PDESolver.solve_stationary_psiOp-1653"><span class="linenos">1653</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1654"><a href="#PDESolver.solve_stationary_psiOp-1654"><span class="linenos">1654</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1655"><a href="#PDESolver.solve_stationary_psiOp-1655"><span class="linenos">1655</span></a>                <span class="c1"># Check if optimization is possible</span>
</span><span id="PDESolver.solve_stationary_psiOp-1656"><a href="#PDESolver.solve_stationary_psiOp-1656"><span class="linenos">1656</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">R_symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="PDESolver.solve_stationary_psiOp-1657"><a href="#PDESolver.solve_stationary_psiOp-1657"><span class="linenos">1657</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚡ Optimization: symbol independent of x – direct product in Fourier.&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1658"><a href="#PDESolver.solve_stationary_psiOp-1658"><span class="linenos">1658</span></a>                    <span class="c1"># Create wrapper that ignores x</span>
</span><span id="PDESolver.solve_stationary_psiOp-1659"><a href="#PDESolver.solve_stationary_psiOp-1659"><span class="linenos">1659</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">_R_func_optimized</span><span class="p">(</span><span class="n">kx_val</span><span class="p">):</span>
</span><span id="PDESolver.solve_stationary_psiOp-1660"><a href="#PDESolver.solve_stationary_psiOp-1660"><span class="linenos">1660</span></a>                        <span class="k">return</span> <span class="n">R_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">kx_val</span><span class="p">)</span>  <span class="c1"># x=0 since it doesn&#39;t matter</span>
</span><span id="PDESolver.solve_stationary_psiOp-1661"><a href="#PDESolver.solve_stationary_psiOp-1661"><span class="linenos">1661</span></a>                    
</span><span id="PDESolver.solve_stationary_psiOp-1662"><a href="#PDESolver.solve_stationary_psiOp-1662"><span class="linenos">1662</span></a>                    <span class="n">R_vals</span> <span class="o">=</span> <span class="n">_R_func_optimized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1663"><a href="#PDESolver.solve_stationary_psiOp-1663"><span class="linenos">1663</span></a>                    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">R_vals</span> <span class="o">*</span> <span class="n">f_hat</span>
</span><span id="PDESolver.solve_stationary_psiOp-1664"><a href="#PDESolver.solve_stationary_psiOp-1664"><span class="linenos">1664</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1665"><a href="#PDESolver.solve_stationary_psiOp-1665"><span class="linenos">1665</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1666"><a href="#PDESolver.solve_stationary_psiOp-1666"><span class="linenos">1666</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚙️ 1D Kohn-Nirenberg Quantification&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1667"><a href="#PDESolver.solve_stationary_psiOp-1667"><span class="linenos">1667</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">psiop</span><span class="w"> </span><span class="kn">import</span> <span class="n">kohn_nirenberg_fft</span>
</span><span id="PDESolver.solve_stationary_psiOp-1668"><a href="#PDESolver.solve_stationary_psiOp-1668"><span class="linenos">1668</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_fft</span><span class="p">(</span>
</span><span id="PDESolver.solve_stationary_psiOp-1669"><a href="#PDESolver.solve_stationary_psiOp-1669"><span class="linenos">1669</span></a>                        <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1670"><a href="#PDESolver.solve_stationary_psiOp-1670"><span class="linenos">1670</span></a>                        <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span><span class="p">,</span>  <span class="c1"># Now has correct signature (x, xi)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1671"><a href="#PDESolver.solve_stationary_psiOp-1671"><span class="linenos">1671</span></a>                        <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1672"><a href="#PDESolver.solve_stationary_psiOp-1672"><span class="linenos">1672</span></a>                        <span class="n">kx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1673"><a href="#PDESolver.solve_stationary_psiOp-1673"><span class="linenos">1673</span></a>                        <span class="n">fft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1674"><a href="#PDESolver.solve_stationary_psiOp-1674"><span class="linenos">1674</span></a>                        <span class="n">ifft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1675"><a href="#PDESolver.solve_stationary_psiOp-1675"><span class="linenos">1675</span></a>                        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="PDESolver.solve_stationary_psiOp-1676"><a href="#PDESolver.solve_stationary_psiOp-1676"><span class="linenos">1676</span></a>                    <span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1677"><a href="#PDESolver.solve_stationary_psiOp-1677"><span class="linenos">1677</span></a>                    
</span><span id="PDESolver.solve_stationary_psiOp-1678"><a href="#PDESolver.solve_stationary_psiOp-1678"><span class="linenos">1678</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1679"><a href="#PDESolver.solve_stationary_psiOp-1679"><span class="linenos">1679</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">R_symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">R_symbol</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
</span><span id="PDESolver.solve_stationary_psiOp-1680"><a href="#PDESolver.solve_stationary_psiOp-1680"><span class="linenos">1680</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚡ Optimization: Symbol independent of x and y – direct product in 2D Fourier.&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1681"><a href="#PDESolver.solve_stationary_psiOp-1681"><span class="linenos">1681</span></a>                    <span class="c1"># Create wrapper that ignores x, y</span>
</span><span id="PDESolver.solve_stationary_psiOp-1682"><a href="#PDESolver.solve_stationary_psiOp-1682"><span class="linenos">1682</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">_R_func_optimized</span><span class="p">(</span><span class="n">kx_val</span><span class="p">,</span> <span class="n">ky_val</span><span class="p">):</span>
</span><span id="PDESolver.solve_stationary_psiOp-1683"><a href="#PDESolver.solve_stationary_psiOp-1683"><span class="linenos">1683</span></a>                        <span class="k">return</span> <span class="n">R_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">kx_val</span><span class="p">,</span> <span class="n">ky_val</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1684"><a href="#PDESolver.solve_stationary_psiOp-1684"><span class="linenos">1684</span></a>                    
</span><span id="PDESolver.solve_stationary_psiOp-1685"><a href="#PDESolver.solve_stationary_psiOp-1685"><span class="linenos">1685</span></a>                    <span class="n">R_vals</span> <span class="o">=</span> <span class="n">_R_func_optimized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KY</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1686"><a href="#PDESolver.solve_stationary_psiOp-1686"><span class="linenos">1686</span></a>                    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">R_vals</span> <span class="o">*</span> <span class="n">f_hat</span>
</span><span id="PDESolver.solve_stationary_psiOp-1687"><a href="#PDESolver.solve_stationary_psiOp-1687"><span class="linenos">1687</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1688"><a href="#PDESolver.solve_stationary_psiOp-1688"><span class="linenos">1688</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1689"><a href="#PDESolver.solve_stationary_psiOp-1689"><span class="linenos">1689</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;⚙️ 2D Kohn-Nirenberg Quantification&#39;</span><span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1690"><a href="#PDESolver.solve_stationary_psiOp-1690"><span class="linenos">1690</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">psiop</span><span class="w"> </span><span class="kn">import</span> <span class="n">kohn_nirenberg_fft</span>
</span><span id="PDESolver.solve_stationary_psiOp-1691"><a href="#PDESolver.solve_stationary_psiOp-1691"><span class="linenos">1691</span></a>                    <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_fft</span><span class="p">(</span>
</span><span id="PDESolver.solve_stationary_psiOp-1692"><a href="#PDESolver.solve_stationary_psiOp-1692"><span class="linenos">1692</span></a>                        <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1693"><a href="#PDESolver.solve_stationary_psiOp-1693"><span class="linenos">1693</span></a>                        <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span><span class="p">,</span>  <span class="c1"># Now has correct signature (x, y, xi, eta)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1694"><a href="#PDESolver.solve_stationary_psiOp-1694"><span class="linenos">1694</span></a>                        <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1695"><a href="#PDESolver.solve_stationary_psiOp-1695"><span class="linenos">1695</span></a>                        <span class="n">kx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1696"><a href="#PDESolver.solve_stationary_psiOp-1696"><span class="linenos">1696</span></a>                        <span class="n">fft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1697"><a href="#PDESolver.solve_stationary_psiOp-1697"><span class="linenos">1697</span></a>                        <span class="n">ifft_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifft</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1698"><a href="#PDESolver.solve_stationary_psiOp-1698"><span class="linenos">1698</span></a>                        <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1699"><a href="#PDESolver.solve_stationary_psiOp-1699"><span class="linenos">1699</span></a>                        <span class="n">y_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1700"><a href="#PDESolver.solve_stationary_psiOp-1700"><span class="linenos">1700</span></a>                        <span class="n">ky</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ky</span>
</span><span id="PDESolver.solve_stationary_psiOp-1701"><a href="#PDESolver.solve_stationary_psiOp-1701"><span class="linenos">1701</span></a>                    <span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1702"><a href="#PDESolver.solve_stationary_psiOp-1702"><span class="linenos">1702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>
</span><span id="PDESolver.solve_stationary_psiOp-1703"><a href="#PDESolver.solve_stationary_psiOp-1703"><span class="linenos">1703</span></a>            <span class="k">return</span> <span class="n">u</span>
</span><span id="PDESolver.solve_stationary_psiOp-1704"><a href="#PDESolver.solve_stationary_psiOp-1704"><span class="linenos">1704</span></a>            
</span><span id="PDESolver.solve_stationary_psiOp-1705"><a href="#PDESolver.solve_stationary_psiOp-1705"><span class="linenos">1705</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1706"><a href="#PDESolver.solve_stationary_psiOp-1706"><span class="linenos">1706</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">psiop</span><span class="w"> </span><span class="kn">import</span> <span class="n">kohn_nirenberg_nonperiodic</span>
</span><span id="PDESolver.solve_stationary_psiOp-1707"><a href="#PDESolver.solve_stationary_psiOp-1707"><span class="linenos">1707</span></a>            
</span><span id="PDESolver.solve_stationary_psiOp-1708"><a href="#PDESolver.solve_stationary_psiOp-1708"><span class="linenos">1708</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1709"><a href="#PDESolver.solve_stationary_psiOp-1709"><span class="linenos">1709</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PDESolver.solve_stationary_psiOp-1710"><a href="#PDESolver.solve_stationary_psiOp-1710"><span class="linenos">1710</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1711"><a href="#PDESolver.solve_stationary_psiOp-1711"><span class="linenos">1711</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1712"><a href="#PDESolver.solve_stationary_psiOp-1712"><span class="linenos">1712</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1713"><a href="#PDESolver.solve_stationary_psiOp-1713"><span class="linenos">1713</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span>  <span class="c1"># Now has correct signature (x, xi)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1714"><a href="#PDESolver.solve_stationary_psiOp-1714"><span class="linenos">1714</span></a>                <span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1715"><a href="#PDESolver.solve_stationary_psiOp-1715"><span class="linenos">1715</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1716"><a href="#PDESolver.solve_stationary_psiOp-1716"><span class="linenos">1716</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="n">kohn_nirenberg_nonperiodic</span><span class="p">(</span>
</span><span id="PDESolver.solve_stationary_psiOp-1717"><a href="#PDESolver.solve_stationary_psiOp-1717"><span class="linenos">1717</span></a>                    <span class="n">u_vals</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
</span><span id="PDESolver.solve_stationary_psiOp-1718"><a href="#PDESolver.solve_stationary_psiOp-1718"><span class="linenos">1718</span></a>                    <span class="n">x_grid</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">),</span>
</span><span id="PDESolver.solve_stationary_psiOp-1719"><a href="#PDESolver.solve_stationary_psiOp-1719"><span class="linenos">1719</span></a>                    <span class="n">xi_grid</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">),</span>
</span><span id="PDESolver.solve_stationary_psiOp-1720"><a href="#PDESolver.solve_stationary_psiOp-1720"><span class="linenos">1720</span></a>                    <span class="n">symbol_func</span><span class="o">=</span><span class="n">R_func</span>  <span class="c1"># Now has correct signature (x, y, xi, eta)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1721"><a href="#PDESolver.solve_stationary_psiOp-1721"><span class="linenos">1721</span></a>                <span class="p">)</span>
</span><span id="PDESolver.solve_stationary_psiOp-1722"><a href="#PDESolver.solve_stationary_psiOp-1722"><span class="linenos">1722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>
</span><span id="PDESolver.solve_stationary_psiOp-1723"><a href="#PDESolver.solve_stationary_psiOp-1723"><span class="linenos">1723</span></a>            <span class="k">return</span> <span class="n">u</span>
</span><span id="PDESolver.solve_stationary_psiOp-1724"><a href="#PDESolver.solve_stationary_psiOp-1724"><span class="linenos">1724</span></a>        
</span><span id="PDESolver.solve_stationary_psiOp-1725"><a href="#PDESolver.solve_stationary_psiOp-1725"><span class="linenos">1725</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.solve_stationary_psiOp-1726"><a href="#PDESolver.solve_stationary_psiOp-1726"><span class="linenos">1726</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid boundary condition &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="si">}</span><span class="s2">&#39;. Supported types are &#39;periodic&#39; and &#39;dirichlet&#39;.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Solve stationary pseudo-differential equations of the form P[u] = f(x) or P[u] = f(x,y) using asymptotic inversion.</p>

<p>This method computes the solution to a stationary (time-independent) pseudo-differential equation
where the operator P is defined via symbolic expressions (psiOp). It constructs an asymptotic right inverse R 
such that P∘R ≈ Id, then applies it to the source term f using either direct Fourier multiplication 
(when the symbol is spatially independent) or Kohn–Nirenberg quantization (when spatial dependence is present).</p>

<p>The inversion is based on the principal symbol of the operator and its asymptotic expansion up to the given order.
Ellipticity of the symbol is checked numerically before inversion to ensure well-posedness.</p>

<h2 id="parameters">Parameters</h2>

<p>order : int, default=3
    Order of the asymptotic expansion used to construct the right inverse of the pseudo-differential operator.
method : str, optional
    Inversion strategy:
    - 'diagonal' (default): Fast approximate inversion using diagonal operators in frequency space.
    - 'full'                : Pointwise exact inversion (slower but more accurate).</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    The computed solution u(x) in 1D or u(x, y) in 2D as a NumPy array over the spatial grid.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If no pseudo-differential operator (psiOp) is defined.
    If linear or nonlinear terms other than psiOp are present.
    If the symbol is not elliptic on the grid.
    If no source term is provided for the right-hand side.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The method assumes the problem is fully stationary: time derivatives must be absent.</li>
<li>Requires the equation to be purely pseudo-differential (no Op, Derivative, or nonlinear terms).</li>
<li>Symbol evaluation and inversion are dimension-aware (supports both 1D and 2D problems).</li>
<li>Supports optimization paths when the symbol does not depend on spatial variables.</li>
</ul>

<h2 id="see-also">See Also</h2>

<p>right_inverse_asymptotic : Constructs the asymptotic inverse of the pseudo-differential operator.
kohn_nirenberg           : Numerical implementation of general pseudo-differential operators.
is_elliptic_numerically  : Verifies numerical ellipticity of the symbol.</p>
</div>


                            </div>
                            <div id="PDESolver.plot_energy" class="classattr">
                                        <input id="PDESolver.plot_energy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_energy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">log</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.plot_energy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.plot_energy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.plot_energy-2317"><a href="#PDESolver.plot_energy-2317"><span class="linenos">2317</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PDESolver.plot_energy-2318"><a href="#PDESolver.plot_energy-2318"><span class="linenos">2318</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.plot_energy-2319"><a href="#PDESolver.plot_energy-2319"><span class="linenos">2319</span></a><span class="sd">        Plot the time evolution of the total energy for wave equations. </span>
</span><span id="PDESolver.plot_energy-2320"><a href="#PDESolver.plot_energy-2320"><span class="linenos">2320</span></a><span class="sd">        Visualizes the energy computed during simulation for both 1D and 2D cases. </span>
</span><span id="PDESolver.plot_energy-2321"><a href="#PDESolver.plot_energy-2321"><span class="linenos">2321</span></a><span class="sd">        Requires temporal_order=2 and prior execution of compute_energy() during solve().</span>
</span><span id="PDESolver.plot_energy-2322"><a href="#PDESolver.plot_energy-2322"><span class="linenos">2322</span></a><span class="sd">        </span>
</span><span id="PDESolver.plot_energy-2323"><a href="#PDESolver.plot_energy-2323"><span class="linenos">2323</span></a><span class="sd">        Parameters:</span>
</span><span id="PDESolver.plot_energy-2324"><a href="#PDESolver.plot_energy-2324"><span class="linenos">2324</span></a><span class="sd">            log : bool</span>
</span><span id="PDESolver.plot_energy-2325"><a href="#PDESolver.plot_energy-2325"><span class="linenos">2325</span></a><span class="sd">                If True, displays energy on a logarithmic scale to highlight exponential decay/growth.</span>
</span><span id="PDESolver.plot_energy-2326"><a href="#PDESolver.plot_energy-2326"><span class="linenos">2326</span></a><span class="sd">        </span>
</span><span id="PDESolver.plot_energy-2327"><a href="#PDESolver.plot_energy-2327"><span class="linenos">2327</span></a><span class="sd">        Notes:</span>
</span><span id="PDESolver.plot_energy-2328"><a href="#PDESolver.plot_energy-2328"><span class="linenos">2328</span></a><span class="sd">            - Energy is defined as E(t) = 1/2 ∫ [ (∂ₜu)² + |L¹⸍²u|² ] dx</span>
</span><span id="PDESolver.plot_energy-2329"><a href="#PDESolver.plot_energy-2329"><span class="linenos">2329</span></a><span class="sd">            - Only available if energy monitoring was activated in solve()</span>
</span><span id="PDESolver.plot_energy-2330"><a href="#PDESolver.plot_energy-2330"><span class="linenos">2330</span></a><span class="sd">            - Automatically skips plotting if no energy data is available</span>
</span><span id="PDESolver.plot_energy-2331"><a href="#PDESolver.plot_energy-2331"><span class="linenos">2331</span></a><span class="sd">        </span>
</span><span id="PDESolver.plot_energy-2332"><a href="#PDESolver.plot_energy-2332"><span class="linenos">2332</span></a><span class="sd">        Displays:</span>
</span><span id="PDESolver.plot_energy-2333"><a href="#PDESolver.plot_energy-2333"><span class="linenos">2333</span></a><span class="sd">            - Time vs. Total Energy plot with grid and legend</span>
</span><span id="PDESolver.plot_energy-2334"><a href="#PDESolver.plot_energy-2334"><span class="linenos">2334</span></a><span class="sd">            - Appropriate axis labels and dimensional context (1D/2D)</span>
</span><span id="PDESolver.plot_energy-2335"><a href="#PDESolver.plot_energy-2335"><span class="linenos">2335</span></a><span class="sd">            - Logarithmic or linear scaling based on input parameter</span>
</span><span id="PDESolver.plot_energy-2336"><a href="#PDESolver.plot_energy-2336"><span class="linenos">2336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.plot_energy-2337"><a href="#PDESolver.plot_energy-2337"><span class="linenos">2337</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;energy_history&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">:</span>
</span><span id="PDESolver.plot_energy-2338"><a href="#PDESolver.plot_energy-2338"><span class="linenos">2338</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No energy data recorded. Call compute_energy() within solve().&quot;</span><span class="p">)</span>
</span><span id="PDESolver.plot_energy-2339"><a href="#PDESolver.plot_energy-2339"><span class="linenos">2339</span></a>            <span class="k">return</span>
</span><span id="PDESolver.plot_energy-2340"><a href="#PDESolver.plot_energy-2340"><span class="linenos">2340</span></a>    
</span><span id="PDESolver.plot_energy-2341"><a href="#PDESolver.plot_energy-2341"><span class="linenos">2341</span></a>        <span class="c1"># Time vector for plotting</span>
</span><span id="PDESolver.plot_energy-2342"><a href="#PDESolver.plot_energy-2342"><span class="linenos">2342</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">))</span>
</span><span id="PDESolver.plot_energy-2343"><a href="#PDESolver.plot_energy-2343"><span class="linenos">2343</span></a>    
</span><span id="PDESolver.plot_energy-2344"><a href="#PDESolver.plot_energy-2344"><span class="linenos">2344</span></a>        <span class="c1"># Create the figure</span>
</span><span id="PDESolver.plot_energy-2345"><a href="#PDESolver.plot_energy-2345"><span class="linenos">2345</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="PDESolver.plot_energy-2346"><a href="#PDESolver.plot_energy-2346"><span class="linenos">2346</span></a>        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
</span><span id="PDESolver.plot_energy-2347"><a href="#PDESolver.plot_energy-2347"><span class="linenos">2347</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Energy (log scale)&quot;</span><span class="p">)</span>
</span><span id="PDESolver.plot_energy-2348"><a href="#PDESolver.plot_energy-2348"><span class="linenos">2348</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.plot_energy-2349"><a href="#PDESolver.plot_energy-2349"><span class="linenos">2349</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_history</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
</span><span id="PDESolver.plot_energy-2350"><a href="#PDESolver.plot_energy-2350"><span class="linenos">2350</span></a>    
</span><span id="PDESolver.plot_energy-2351"><a href="#PDESolver.plot_energy-2351"><span class="linenos">2351</span></a>        <span class="c1"># Axis labels and title</span>
</span><span id="PDESolver.plot_energy-2352"><a href="#PDESolver.plot_energy-2352"><span class="linenos">2352</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="PDESolver.plot_energy-2353"><a href="#PDESolver.plot_energy-2353"><span class="linenos">2353</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total energy&quot;</span><span class="p">)</span>
</span><span id="PDESolver.plot_energy-2354"><a href="#PDESolver.plot_energy-2354"><span class="linenos">2354</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Energy evolution (</span><span class="si">{}</span><span class="s2">D)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
</span><span id="PDESolver.plot_energy-2355"><a href="#PDESolver.plot_energy-2355"><span class="linenos">2355</span></a>    
</span><span id="PDESolver.plot_energy-2356"><a href="#PDESolver.plot_energy-2356"><span class="linenos">2356</span></a>        <span class="c1"># Display options</span>
</span><span id="PDESolver.plot_energy-2357"><a href="#PDESolver.plot_energy-2357"><span class="linenos">2357</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver.plot_energy-2358"><a href="#PDESolver.plot_energy-2358"><span class="linenos">2358</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver.plot_energy-2359"><a href="#PDESolver.plot_energy-2359"><span class="linenos">2359</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.plot_energy-2360"><a href="#PDESolver.plot_energy-2360"><span class="linenos">2360</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the time evolution of the total energy for wave equations. 
Visualizes the energy computed during simulation for both 1D and 2D cases. 
Requires temporal_order=2 and prior execution of compute_energy() during solve().</p>

<p>Parameters:
    log : bool
        If True, displays energy on a logarithmic scale to highlight exponential decay/growth.</p>

<p>Notes:
    - Energy is defined as E(t) = 1/2 ∫ [ (∂ₜu)² + |L¹⸍²u|² ] dx
    - Only available if energy monitoring was activated in solve()
    - Automatically skips plotting if no energy data is available</p>

<p>Displays:
    - Time vs. Total Energy plot with grid and legend
    - Appropriate axis labels and dimensional context (1D/2D)
    - Logarithmic or linear scaling based on input parameter</p>
</div>


                            </div>
                            <div id="PDESolver.show_stationary_solution" class="classattr">
                                        <input id="PDESolver.show_stationary_solution-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">show_stationary_solution</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">u</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">component</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span>, </span><span class="param"><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.show_stationary_solution-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.show_stationary_solution"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.show_stationary_solution-2362"><a href="#PDESolver.show_stationary_solution-2362"><span class="linenos">2362</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_stationary_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="PDESolver.show_stationary_solution-2363"><a href="#PDESolver.show_stationary_solution-2363"><span class="linenos">2363</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.show_stationary_solution-2364"><a href="#PDESolver.show_stationary_solution-2364"><span class="linenos">2364</span></a><span class="sd">        Display the stationary solution computed by solve_stationary_psiOp.</span>
</span><span id="PDESolver.show_stationary_solution-2365"><a href="#PDESolver.show_stationary_solution-2365"><span class="linenos">2365</span></a>
</span><span id="PDESolver.show_stationary_solution-2366"><a href="#PDESolver.show_stationary_solution-2366"><span class="linenos">2366</span></a><span class="sd">        This method visualizes the solution of a pseudo-differential equation </span>
</span><span id="PDESolver.show_stationary_solution-2367"><a href="#PDESolver.show_stationary_solution-2367"><span class="linenos">2367</span></a><span class="sd">        solved in stationary mode. It supports both 1D and 2D spatial domains, </span>
</span><span id="PDESolver.show_stationary_solution-2368"><a href="#PDESolver.show_stationary_solution-2368"><span class="linenos">2368</span></a><span class="sd">        with options to display different components of the solution (real, </span>
</span><span id="PDESolver.show_stationary_solution-2369"><a href="#PDESolver.show_stationary_solution-2369"><span class="linenos">2369</span></a><span class="sd">        imaginary, absolute value, or phase).</span>
</span><span id="PDESolver.show_stationary_solution-2370"><a href="#PDESolver.show_stationary_solution-2370"><span class="linenos">2370</span></a>
</span><span id="PDESolver.show_stationary_solution-2371"><a href="#PDESolver.show_stationary_solution-2371"><span class="linenos">2371</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver.show_stationary_solution-2372"><a href="#PDESolver.show_stationary_solution-2372"><span class="linenos">2372</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver.show_stationary_solution-2373"><a href="#PDESolver.show_stationary_solution-2373"><span class="linenos">2373</span></a><span class="sd">        u : ndarray, optional</span>
</span><span id="PDESolver.show_stationary_solution-2374"><a href="#PDESolver.show_stationary_solution-2374"><span class="linenos">2374</span></a><span class="sd">            Precomputed solution array. If None, calls solve_stationary_psiOp() </span>
</span><span id="PDESolver.show_stationary_solution-2375"><a href="#PDESolver.show_stationary_solution-2375"><span class="linenos">2375</span></a><span class="sd">            to compute the solution.</span>
</span><span id="PDESolver.show_stationary_solution-2376"><a href="#PDESolver.show_stationary_solution-2376"><span class="linenos">2376</span></a><span class="sd">        component : str, optional {&#39;real&#39;, &#39;imag&#39;, &#39;abs&#39;, &#39;angle&#39;}</span>
</span><span id="PDESolver.show_stationary_solution-2377"><a href="#PDESolver.show_stationary_solution-2377"><span class="linenos">2377</span></a><span class="sd">            Component of the complex-valued solution to display:</span>
</span><span id="PDESolver.show_stationary_solution-2378"><a href="#PDESolver.show_stationary_solution-2378"><span class="linenos">2378</span></a><span class="sd">            - &#39;real&#39;: Real part</span>
</span><span id="PDESolver.show_stationary_solution-2379"><a href="#PDESolver.show_stationary_solution-2379"><span class="linenos">2379</span></a><span class="sd">            - &#39;imag&#39;: Imaginary part</span>
</span><span id="PDESolver.show_stationary_solution-2380"><a href="#PDESolver.show_stationary_solution-2380"><span class="linenos">2380</span></a><span class="sd">            - &#39;abs&#39; : Absolute value (modulus)</span>
</span><span id="PDESolver.show_stationary_solution-2381"><a href="#PDESolver.show_stationary_solution-2381"><span class="linenos">2381</span></a><span class="sd">            - &#39;angle&#39; : Phase (argument)</span>
</span><span id="PDESolver.show_stationary_solution-2382"><a href="#PDESolver.show_stationary_solution-2382"><span class="linenos">2382</span></a><span class="sd">        cmap : str, optional</span>
</span><span id="PDESolver.show_stationary_solution-2383"><a href="#PDESolver.show_stationary_solution-2383"><span class="linenos">2383</span></a><span class="sd">            Colormap used for 2D visualization (default: &#39;viridis&#39;).</span>
</span><span id="PDESolver.show_stationary_solution-2384"><a href="#PDESolver.show_stationary_solution-2384"><span class="linenos">2384</span></a>
</span><span id="PDESolver.show_stationary_solution-2385"><a href="#PDESolver.show_stationary_solution-2385"><span class="linenos">2385</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver.show_stationary_solution-2386"><a href="#PDESolver.show_stationary_solution-2386"><span class="linenos">2386</span></a><span class="sd">        ------</span>
</span><span id="PDESolver.show_stationary_solution-2387"><a href="#PDESolver.show_stationary_solution-2387"><span class="linenos">2387</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver.show_stationary_solution-2388"><a href="#PDESolver.show_stationary_solution-2388"><span class="linenos">2388</span></a><span class="sd">            If an invalid component is specified or if the spatial dimension </span>
</span><span id="PDESolver.show_stationary_solution-2389"><a href="#PDESolver.show_stationary_solution-2389"><span class="linenos">2389</span></a><span class="sd">            is not supported (only 1D and 2D are implemented).</span>
</span><span id="PDESolver.show_stationary_solution-2390"><a href="#PDESolver.show_stationary_solution-2390"><span class="linenos">2390</span></a>
</span><span id="PDESolver.show_stationary_solution-2391"><a href="#PDESolver.show_stationary_solution-2391"><span class="linenos">2391</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver.show_stationary_solution-2392"><a href="#PDESolver.show_stationary_solution-2392"><span class="linenos">2392</span></a><span class="sd">        -----</span>
</span><span id="PDESolver.show_stationary_solution-2393"><a href="#PDESolver.show_stationary_solution-2393"><span class="linenos">2393</span></a><span class="sd">        - In 1D, the solution is displayed using a standard line plot.</span>
</span><span id="PDESolver.show_stationary_solution-2394"><a href="#PDESolver.show_stationary_solution-2394"><span class="linenos">2394</span></a><span class="sd">        - In 2D, the solution is visualized as a 3D surface plot.</span>
</span><span id="PDESolver.show_stationary_solution-2395"><a href="#PDESolver.show_stationary_solution-2395"><span class="linenos">2395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.show_stationary_solution-2396"><a href="#PDESolver.show_stationary_solution-2396"><span class="linenos">2396</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_component</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver.show_stationary_solution-2397"><a href="#PDESolver.show_stationary_solution-2397"><span class="linenos">2397</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2398"><a href="#PDESolver.show_stationary_solution-2398"><span class="linenos">2398</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2399"><a href="#PDESolver.show_stationary_solution-2399"><span class="linenos">2399</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2400"><a href="#PDESolver.show_stationary_solution-2400"><span class="linenos">2400</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2401"><a href="#PDESolver.show_stationary_solution-2401"><span class="linenos">2401</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2402"><a href="#PDESolver.show_stationary_solution-2402"><span class="linenos">2402</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2403"><a href="#PDESolver.show_stationary_solution-2403"><span class="linenos">2403</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2404"><a href="#PDESolver.show_stationary_solution-2404"><span class="linenos">2404</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2405"><a href="#PDESolver.show_stationary_solution-2405"><span class="linenos">2405</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2406"><a href="#PDESolver.show_stationary_solution-2406"><span class="linenos">2406</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid component&quot;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2407"><a href="#PDESolver.show_stationary_solution-2407"><span class="linenos">2407</span></a>                
</span><span id="PDESolver.show_stationary_solution-2408"><a href="#PDESolver.show_stationary_solution-2408"><span class="linenos">2408</span></a>        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2409"><a href="#PDESolver.show_stationary_solution-2409"><span class="linenos">2409</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_stationary_psiOp</span><span class="p">()</span>
</span><span id="PDESolver.show_stationary_solution-2410"><a href="#PDESolver.show_stationary_solution-2410"><span class="linenos">2410</span></a>
</span><span id="PDESolver.show_stationary_solution-2411"><a href="#PDESolver.show_stationary_solution-2411"><span class="linenos">2411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2412"><a href="#PDESolver.show_stationary_solution-2412"><span class="linenos">2412</span></a>            <span class="c1"># Plot the solution in 1D</span>
</span><span id="PDESolver.show_stationary_solution-2413"><a href="#PDESolver.show_stationary_solution-2413"><span class="linenos">2413</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="PDESolver.show_stationary_solution-2414"><a href="#PDESolver.show_stationary_solution-2414"><span class="linenos">2414</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">get_component</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2415"><a href="#PDESolver.show_stationary_solution-2415"><span class="linenos">2415</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2416"><a href="#PDESolver.show_stationary_solution-2416"><span class="linenos">2416</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2417"><a href="#PDESolver.show_stationary_solution-2417"><span class="linenos">2417</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stationary solution (1D)&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2418"><a href="#PDESolver.show_stationary_solution-2418"><span class="linenos">2418</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2419"><a href="#PDESolver.show_stationary_solution-2419"><span class="linenos">2419</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver.show_stationary_solution-2420"><a href="#PDESolver.show_stationary_solution-2420"><span class="linenos">2420</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.show_stationary_solution-2421"><a href="#PDESolver.show_stationary_solution-2421"><span class="linenos">2421</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver.show_stationary_solution-2422"><a href="#PDESolver.show_stationary_solution-2422"><span class="linenos">2422</span></a>    
</span><span id="PDESolver.show_stationary_solution-2423"><a href="#PDESolver.show_stationary_solution-2423"><span class="linenos">2423</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2424"><a href="#PDESolver.show_stationary_solution-2424"><span class="linenos">2424</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver.show_stationary_solution-2425"><a href="#PDESolver.show_stationary_solution-2425"><span class="linenos">2425</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2426"><a href="#PDESolver.show_stationary_solution-2426"><span class="linenos">2426</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2427"><a href="#PDESolver.show_stationary_solution-2427"><span class="linenos">2427</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2428"><a href="#PDESolver.show_stationary_solution-2428"><span class="linenos">2428</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2429"><a href="#PDESolver.show_stationary_solution-2429"><span class="linenos">2429</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stationary solution (2D)&#39;</span><span class="p">)</span>    
</span><span id="PDESolver.show_stationary_solution-2430"><a href="#PDESolver.show_stationary_solution-2430"><span class="linenos">2430</span></a>            <span class="n">data0</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2431"><a href="#PDESolver.show_stationary_solution-2431"><span class="linenos">2431</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver.show_stationary_solution-2432"><a href="#PDESolver.show_stationary_solution-2432"><span class="linenos">2432</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.show_stationary_solution-2433"><a href="#PDESolver.show_stationary_solution-2433"><span class="linenos">2433</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver.show_stationary_solution-2434"><a href="#PDESolver.show_stationary_solution-2434"><span class="linenos">2434</span></a>    
</span><span id="PDESolver.show_stationary_solution-2435"><a href="#PDESolver.show_stationary_solution-2435"><span class="linenos">2435</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.show_stationary_solution-2436"><a href="#PDESolver.show_stationary_solution-2436"><span class="linenos">2436</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D display are supported.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Display the stationary solution computed by solve_stationary_psiOp.</p>

<p>This method visualizes the solution of a pseudo-differential equation 
solved in stationary mode. It supports both 1D and 2D spatial domains, 
with options to display different components of the solution (real, 
imaginary, absolute value, or phase).</p>

<h2 id="parameters">Parameters</h2>

<p>u : ndarray, optional
    Precomputed solution array. If None, calls solve_stationary_psiOp() 
    to compute the solution.
component : str, optional {'real', 'imag', 'abs', 'angle'}
    Component of the complex-valued solution to display:
    - 'real': Real part
    - 'imag': Imaginary part
    - 'abs' : Absolute value (modulus)
    - 'angle' : Phase (argument)
cmap : str, optional
    Colormap used for 2D visualization (default: 'viridis').</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If an invalid component is specified or if the spatial dimension 
    is not supported (only 1D and 2D are implemented).</p>

<h2 id="notes">Notes</h2>

<ul>
<li>In 1D, the solution is displayed using a standard line plot.</li>
<li>In 2D, the solution is visualized as a 3D surface plot.</li>
</ul>
</div>


                            </div>
                            <div id="PDESolver.animate" class="classattr">
                                        <input id="PDESolver.animate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">animate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">component</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span>, </span><span class="param"><span class="n">overlay</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.animate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.animate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.animate-2438"><a href="#PDESolver.animate-2438"><span class="linenos">2438</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">animate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">):</span>
</span><span id="PDESolver.animate-2439"><a href="#PDESolver.animate-2439"><span class="linenos">2439</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.animate-2440"><a href="#PDESolver.animate-2440"><span class="linenos">2440</span></a><span class="sd">        Create an animated plot of the solution evolution over time.</span>
</span><span id="PDESolver.animate-2441"><a href="#PDESolver.animate-2441"><span class="linenos">2441</span></a><span class="sd">    </span>
</span><span id="PDESolver.animate-2442"><a href="#PDESolver.animate-2442"><span class="linenos">2442</span></a><span class="sd">        This method generates a dynamic visualization of the stored solution frames</span>
</span><span id="PDESolver.animate-2443"><a href="#PDESolver.animate-2443"><span class="linenos">2443</span></a><span class="sd">        `self.frames`. It supports:</span>
</span><span id="PDESolver.animate-2444"><a href="#PDESolver.animate-2444"><span class="linenos">2444</span></a><span class="sd">          - 1D line animation (unchanged),</span>
</span><span id="PDESolver.animate-2445"><a href="#PDESolver.animate-2445"><span class="linenos">2445</span></a><span class="sd">          - 2D surface animation (original behavior, &#39;surface&#39;),</span>
</span><span id="PDESolver.animate-2446"><a href="#PDESolver.animate-2446"><span class="linenos">2446</span></a><span class="sd">          - 2D image animation using imshow (new, &#39;imshow&#39;) which is faster and</span>
</span><span id="PDESolver.animate-2447"><a href="#PDESolver.animate-2447"><span class="linenos">2447</span></a><span class="sd">            often clearer for large grids.</span>
</span><span id="PDESolver.animate-2448"><a href="#PDESolver.animate-2448"><span class="linenos">2448</span></a><span class="sd">    </span>
</span><span id="PDESolver.animate-2449"><a href="#PDESolver.animate-2449"><span class="linenos">2449</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver.animate-2450"><a href="#PDESolver.animate-2450"><span class="linenos">2450</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver.animate-2451"><a href="#PDESolver.animate-2451"><span class="linenos">2451</span></a><span class="sd">        component : str, optional, one of {&#39;real&#39;, &#39;imag&#39;, &#39;abs&#39;, &#39;angle&#39;}</span>
</span><span id="PDESolver.animate-2452"><a href="#PDESolver.animate-2452"><span class="linenos">2452</span></a><span class="sd">            Which component of the complex field to visualize:</span>
</span><span id="PDESolver.animate-2453"><a href="#PDESolver.animate-2453"><span class="linenos">2453</span></a><span class="sd">              - &#39;real&#39;  : Re(u)</span>
</span><span id="PDESolver.animate-2454"><a href="#PDESolver.animate-2454"><span class="linenos">2454</span></a><span class="sd">              - &#39;imag&#39;  : Im(u)</span>
</span><span id="PDESolver.animate-2455"><a href="#PDESolver.animate-2455"><span class="linenos">2455</span></a><span class="sd">              - &#39;abs&#39;   : |u|</span>
</span><span id="PDESolver.animate-2456"><a href="#PDESolver.animate-2456"><span class="linenos">2456</span></a><span class="sd">              - &#39;angle&#39; : arg(u)</span>
</span><span id="PDESolver.animate-2457"><a href="#PDESolver.animate-2457"><span class="linenos">2457</span></a><span class="sd">            Default is &#39;abs&#39;.</span>
</span><span id="PDESolver.animate-2458"><a href="#PDESolver.animate-2458"><span class="linenos">2458</span></a><span class="sd">    </span>
</span><span id="PDESolver.animate-2459"><a href="#PDESolver.animate-2459"><span class="linenos">2459</span></a><span class="sd">        overlay : str or None, optional, one of {&#39;contour&#39;, &#39;front&#39;, None}</span>
</span><span id="PDESolver.animate-2460"><a href="#PDESolver.animate-2460"><span class="linenos">2460</span></a><span class="sd">            For 2D modes only. If None, no overlay is drawn.</span>
</span><span id="PDESolver.animate-2461"><a href="#PDESolver.animate-2461"><span class="linenos">2461</span></a><span class="sd">              - &#39;contour&#39; : draw contour lines on top (or beneath for 3D surface)</span>
</span><span id="PDESolver.animate-2462"><a href="#PDESolver.animate-2462"><span class="linenos">2462</span></a><span class="sd">              - &#39;front&#39;   : detect and mark wavefronts using gradient maxima</span>
</span><span id="PDESolver.animate-2463"><a href="#PDESolver.animate-2463"><span class="linenos">2463</span></a><span class="sd">            Default is &#39;contour&#39;.</span>
</span><span id="PDESolver.animate-2464"><a href="#PDESolver.animate-2464"><span class="linenos">2464</span></a><span class="sd">    </span>
</span><span id="PDESolver.animate-2465"><a href="#PDESolver.animate-2465"><span class="linenos">2465</span></a><span class="sd">        mode : str, optional, one of {&#39;surface&#39;, &#39;imshow&#39;}</span>
</span><span id="PDESolver.animate-2466"><a href="#PDESolver.animate-2466"><span class="linenos">2466</span></a><span class="sd">            2D rendering mode. &#39;surface&#39; keeps the original 3D surface plot.</span>
</span><span id="PDESolver.animate-2467"><a href="#PDESolver.animate-2467"><span class="linenos">2467</span></a><span class="sd">            &#39;imshow&#39; draws a 2D raster (faster, often more readable).</span>
</span><span id="PDESolver.animate-2468"><a href="#PDESolver.animate-2468"><span class="linenos">2468</span></a><span class="sd">            Default is &#39;surface&#39; for backward compatibility.</span>
</span><span id="PDESolver.animate-2469"><a href="#PDESolver.animate-2469"><span class="linenos">2469</span></a><span class="sd">    </span>
</span><span id="PDESolver.animate-2470"><a href="#PDESolver.animate-2470"><span class="linenos">2470</span></a><span class="sd">        Returns</span>
</span><span id="PDESolver.animate-2471"><a href="#PDESolver.animate-2471"><span class="linenos">2471</span></a><span class="sd">        -------</span>
</span><span id="PDESolver.animate-2472"><a href="#PDESolver.animate-2472"><span class="linenos">2472</span></a><span class="sd">        FuncAnimation</span>
</span><span id="PDESolver.animate-2473"><a href="#PDESolver.animate-2473"><span class="linenos">2473</span></a><span class="sd">            A Matplotlib `FuncAnimation` instance (you can display it in a notebook</span>
</span><span id="PDESolver.animate-2474"><a href="#PDESolver.animate-2474"><span class="linenos">2474</span></a><span class="sd">            or save it to file).</span>
</span><span id="PDESolver.animate-2475"><a href="#PDESolver.animate-2475"><span class="linenos">2475</span></a><span class="sd">    </span>
</span><span id="PDESolver.animate-2476"><a href="#PDESolver.animate-2476"><span class="linenos">2476</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver.animate-2477"><a href="#PDESolver.animate-2477"><span class="linenos">2477</span></a><span class="sd">        -----</span>
</span><span id="PDESolver.animate-2478"><a href="#PDESolver.animate-2478"><span class="linenos">2478</span></a><span class="sd">        - The method uses the same time-mapping logic as before (linear sampling of</span>
</span><span id="PDESolver.animate-2479"><a href="#PDESolver.animate-2479"><span class="linenos">2479</span></a><span class="sd">          stored frames to animation frames).</span>
</span><span id="PDESolver.animate-2480"><a href="#PDESolver.animate-2480"><span class="linenos">2480</span></a><span class="sd">        - For &#39;angle&#39; the color scale is fixed between -π and π.</span>
</span><span id="PDESolver.animate-2481"><a href="#PDESolver.animate-2481"><span class="linenos">2481</span></a><span class="sd">        - For other components, color scaling is by default dynamically adapted per</span>
</span><span id="PDESolver.animate-2482"><a href="#PDESolver.animate-2482"><span class="linenos">2482</span></a><span class="sd">          frame in &#39;imshow&#39; mode (this avoids extreme clipping if amplitudes vary).</span>
</span><span id="PDESolver.animate-2483"><a href="#PDESolver.animate-2483"><span class="linenos">2483</span></a><span class="sd">        - Overlays are updated cleanly: previous contour/scatter artists are removed</span>
</span><span id="PDESolver.animate-2484"><a href="#PDESolver.animate-2484"><span class="linenos">2484</span></a><span class="sd">          before drawing the next frame to avoid memory/visual accumulation.</span>
</span><span id="PDESolver.animate-2485"><a href="#PDESolver.animate-2485"><span class="linenos">2485</span></a><span class="sd">        - Animation interval is 50 ms per frame (unchanged).</span>
</span><span id="PDESolver.animate-2486"><a href="#PDESolver.animate-2486"><span class="linenos">2486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.animate-2487"><a href="#PDESolver.animate-2487"><span class="linenos">2487</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_component</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
</span><span id="PDESolver.animate-2488"><a href="#PDESolver.animate-2488"><span class="linenos">2488</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2489"><a href="#PDESolver.animate-2489"><span class="linenos">2489</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.animate-2490"><a href="#PDESolver.animate-2490"><span class="linenos">2490</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2491"><a href="#PDESolver.animate-2491"><span class="linenos">2491</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.animate-2492"><a href="#PDESolver.animate-2492"><span class="linenos">2492</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2493"><a href="#PDESolver.animate-2493"><span class="linenos">2493</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.animate-2494"><a href="#PDESolver.animate-2494"><span class="linenos">2494</span></a>            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2495"><a href="#PDESolver.animate-2495"><span class="linenos">2495</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="PDESolver.animate-2496"><a href="#PDESolver.animate-2496"><span class="linenos">2496</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.animate-2497"><a href="#PDESolver.animate-2497"><span class="linenos">2497</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid component: choose &#39;real&#39;,&#39;imag&#39;,&#39;abs&#39; or &#39;angle&#39;&quot;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2498"><a href="#PDESolver.animate-2498"><span class="linenos">2498</span></a>    
</span><span id="PDESolver.animate-2499"><a href="#PDESolver.animate-2499"><span class="linenos">2499</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*********************&quot;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2500"><a href="#PDESolver.animate-2500"><span class="linenos">2500</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Solution plotting *&quot;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2501"><a href="#PDESolver.animate-2501"><span class="linenos">2501</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2502"><a href="#PDESolver.animate-2502"><span class="linenos">2502</span></a>    
</span><span id="PDESolver.animate-2503"><a href="#PDESolver.animate-2503"><span class="linenos">2503</span></a>        <span class="c1"># === Calculate time vector of stored frames ===</span>
</span><span id="PDESolver.animate-2504"><a href="#PDESolver.animate-2504"><span class="linenos">2504</span></a>        <span class="n">save_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
</span><span id="PDESolver.animate-2505"><a href="#PDESolver.animate-2505"><span class="linenos">2505</span></a>        <span class="n">frame_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">save_interval</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver.animate-2506"><a href="#PDESolver.animate-2506"><span class="linenos">2506</span></a>    
</span><span id="PDESolver.animate-2507"><a href="#PDESolver.animate-2507"><span class="linenos">2507</span></a>        <span class="c1"># === Target times for animation ===</span>
</span><span id="PDESolver.animate-2508"><a href="#PDESolver.animate-2508"><span class="linenos">2508</span></a>        <span class="n">target_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver.animate-2509"><a href="#PDESolver.animate-2509"><span class="linenos">2509</span></a>    
</span><span id="PDESolver.animate-2510"><a href="#PDESolver.animate-2510"><span class="linenos">2510</span></a>        <span class="c1"># Map target times to nearest frame indices</span>
</span><span id="PDESolver.animate-2511"><a href="#PDESolver.animate-2511"><span class="linenos">2511</span></a>        <span class="n">frame_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_times</span><span class="p">]</span>
</span><span id="PDESolver.animate-2512"><a href="#PDESolver.animate-2512"><span class="linenos">2512</span></a>    
</span><span id="PDESolver.animate-2513"><a href="#PDESolver.animate-2513"><span class="linenos">2513</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver.animate-2514"><a href="#PDESolver.animate-2514"><span class="linenos">2514</span></a>        <span class="c1"># 1D case (unchanged logic)</span>
</span><span id="PDESolver.animate-2515"><a href="#PDESolver.animate-2515"><span class="linenos">2515</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver.animate-2516"><a href="#PDESolver.animate-2516"><span class="linenos">2516</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.animate-2517"><a href="#PDESolver.animate-2517"><span class="linenos">2517</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="PDESolver.animate-2518"><a href="#PDESolver.animate-2518"><span class="linenos">2518</span></a>            <span class="n">initial</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PDESolver.animate-2519"><a href="#PDESolver.animate-2519"><span class="linenos">2519</span></a>            <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span> <span class="k">else</span> <span class="n">initial</span><span class="p">)</span>
</span><span id="PDESolver.animate-2520"><a href="#PDESolver.animate-2520"><span class="linenos">2520</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">initial</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">initial</span><span class="p">))</span>
</span><span id="PDESolver.animate-2521"><a href="#PDESolver.animate-2521"><span class="linenos">2521</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2522"><a href="#PDESolver.animate-2522"><span class="linenos">2522</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2523"><a href="#PDESolver.animate-2523"><span class="linenos">2523</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Initial condition&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2524"><a href="#PDESolver.animate-2524"><span class="linenos">2524</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.animate-2525"><a href="#PDESolver.animate-2525"><span class="linenos">2525</span></a>    
</span><span id="PDESolver.animate-2526"><a href="#PDESolver.animate-2526"><span class="linenos">2526</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_update_1d</span><span class="p">(</span><span class="n">frame_number</span><span class="p">):</span>
</span><span id="PDESolver.animate-2527"><a href="#PDESolver.animate-2527"><span class="linenos">2527</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_indices</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver.animate-2528"><a href="#PDESolver.animate-2528"><span class="linenos">2528</span></a>                <span class="n">ydata</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
</span><span id="PDESolver.animate-2529"><a href="#PDESolver.animate-2529"><span class="linenos">2529</span></a>                <span class="n">ydata_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span> <span class="k">else</span> <span class="n">ydata</span>
</span><span id="PDESolver.animate-2530"><a href="#PDESolver.animate-2530"><span class="linenos">2530</span></a>                <span class="n">line</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata_real</span><span class="p">)</span>
</span><span id="PDESolver.animate-2531"><a href="#PDESolver.animate-2531"><span class="linenos">2531</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ydata_real</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ydata_real</span><span class="p">))</span>
</span><span id="PDESolver.animate-2532"><a href="#PDESolver.animate-2532"><span class="linenos">2532</span></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">target_times</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver.animate-2533"><a href="#PDESolver.animate-2533"><span class="linenos">2533</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t = </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2534"><a href="#PDESolver.animate-2534"><span class="linenos">2534</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">line</span><span class="p">,)</span>
</span><span id="PDESolver.animate-2535"><a href="#PDESolver.animate-2535"><span class="linenos">2535</span></a>    
</span><span id="PDESolver.animate-2536"><a href="#PDESolver.animate-2536"><span class="linenos">2536</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update_1d</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_times</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PDESolver.animate-2537"><a href="#PDESolver.animate-2537"><span class="linenos">2537</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PDESolver.animate-2538"><a href="#PDESolver.animate-2538"><span class="linenos">2538</span></a>    
</span><span id="PDESolver.animate-2539"><a href="#PDESolver.animate-2539"><span class="linenos">2539</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver.animate-2540"><a href="#PDESolver.animate-2540"><span class="linenos">2540</span></a>        <span class="c1"># 2D case</span>
</span><span id="PDESolver.animate-2541"><a href="#PDESolver.animate-2541"><span class="linenos">2541</span></a>        <span class="c1"># -------------------------</span>
</span><span id="PDESolver.animate-2542"><a href="#PDESolver.animate-2542"><span class="linenos">2542</span></a>        <span class="c1"># Validate mode</span>
</span><span id="PDESolver.animate-2543"><a href="#PDESolver.animate-2543"><span class="linenos">2543</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span> <span class="s1">&#39;imshow&#39;</span><span class="p">):</span>
</span><span id="PDESolver.animate-2544"><a href="#PDESolver.animate-2544"><span class="linenos">2544</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mode: choose &#39;surface&#39; or &#39;imshow&#39;&quot;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2545"><a href="#PDESolver.animate-2545"><span class="linenos">2545</span></a>    
</span><span id="PDESolver.animate-2546"><a href="#PDESolver.animate-2546"><span class="linenos">2546</span></a>        <span class="c1"># Common data</span>
</span><span id="PDESolver.animate-2547"><a href="#PDESolver.animate-2547"><span class="linenos">2547</span></a>        <span class="n">data0</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="PDESolver.animate-2548"><a href="#PDESolver.animate-2548"><span class="linenos">2548</span></a>    
</span><span id="PDESolver.animate-2549"><a href="#PDESolver.animate-2549"><span class="linenos">2549</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2550"><a href="#PDESolver.animate-2550"><span class="linenos">2550</span></a>            <span class="c1"># original surface behavior, but ensure clean updates</span>
</span><span id="PDESolver.animate-2551"><a href="#PDESolver.animate-2551"><span class="linenos">2551</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="PDESolver.animate-2552"><a href="#PDESolver.animate-2552"><span class="linenos">2552</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2553"><a href="#PDESolver.animate-2553"><span class="linenos">2553</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2554"><a href="#PDESolver.animate-2554"><span class="linenos">2554</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2555"><a href="#PDESolver.animate-2555"><span class="linenos">2555</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2556"><a href="#PDESolver.animate-2556"><span class="linenos">2556</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">labelpad</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PDESolver.animate-2557"><a href="#PDESolver.animate-2557"><span class="linenos">2557</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Initial condition&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2558"><a href="#PDESolver.animate-2558"><span class="linenos">2558</span></a>    
</span><span id="PDESolver.animate-2559"><a href="#PDESolver.animate-2559"><span class="linenos">2559</span></a>            <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">data0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2560"><a href="#PDESolver.animate-2560"><span class="linenos">2560</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.animate-2561"><a href="#PDESolver.animate-2561"><span class="linenos">2561</span></a>    
</span><span id="PDESolver.animate-2562"><a href="#PDESolver.animate-2562"><span class="linenos">2562</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_update_surface</span><span class="p">(</span><span class="n">frame_number</span><span class="p">):</span>
</span><span id="PDESolver.animate-2563"><a href="#PDESolver.animate-2563"><span class="linenos">2563</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_indices</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver.animate-2564"><a href="#PDESolver.animate-2564"><span class="linenos">2564</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
</span><span id="PDESolver.animate-2565"><a href="#PDESolver.animate-2565"><span class="linenos">2565</span></a>                <span class="n">z_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">current_data</span><span class="p">))</span>
</span><span id="PDESolver.animate-2566"><a href="#PDESolver.animate-2566"><span class="linenos">2566</span></a>    
</span><span id="PDESolver.animate-2567"><a href="#PDESolver.animate-2567"><span class="linenos">2567</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="PDESolver.animate-2568"><a href="#PDESolver.animate-2568"><span class="linenos">2568</span></a>                <span class="n">surf_obj</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span>
</span><span id="PDESolver.animate-2569"><a href="#PDESolver.animate-2569"><span class="linenos">2569</span></a>                                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
</span><span id="PDESolver.animate-2570"><a href="#PDESolver.animate-2570"><span class="linenos">2570</span></a>                                           <span class="n">vmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
</span><span id="PDESolver.animate-2571"><a href="#PDESolver.animate-2571"><span class="linenos">2571</span></a>                                           <span class="n">vmax</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="PDESolver.animate-2572"><a href="#PDESolver.animate-2572"><span class="linenos">2572</span></a>                <span class="c1"># overlays</span>
</span><span id="PDESolver.animate-2573"><a href="#PDESolver.animate-2573"><span class="linenos">2573</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2574"><a href="#PDESolver.animate-2574"><span class="linenos">2574</span></a>                    <span class="c1"># place contours slightly below the surface (use offset)</span>
</span><span id="PDESolver.animate-2575"><a href="#PDESolver.animate-2575"><span class="linenos">2575</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver.animate-2576"><a href="#PDESolver.animate-2576"><span class="linenos">2576</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">z_offset</span><span class="p">)</span>
</span><span id="PDESolver.animate-2577"><a href="#PDESolver.animate-2577"><span class="linenos">2577</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver.animate-2578"><a href="#PDESolver.animate-2578"><span class="linenos">2578</span></a>                        <span class="c1"># fallback: simple contour without offset if not supported</span>
</span><span id="PDESolver.animate-2579"><a href="#PDESolver.animate-2579"><span class="linenos">2579</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2580"><a href="#PDESolver.animate-2580"><span class="linenos">2580</span></a>    
</span><span id="PDESolver.animate-2581"><a href="#PDESolver.animate-2581"><span class="linenos">2581</span></a>                <span class="k">elif</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;front&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2582"><a href="#PDESolver.animate-2582"><span class="linenos">2582</span></a>                    <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.animate-2583"><a href="#PDESolver.animate-2583"><span class="linenos">2583</span></a>                    <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.animate-2584"><a href="#PDESolver.animate-2584"><span class="linenos">2584</span></a>                    <span class="c1"># numpy.gradient: axis0 -&gt; y spacing, axis1 -&gt; x spacing</span>
</span><span id="PDESolver.animate-2585"><a href="#PDESolver.animate-2585"><span class="linenos">2585</span></a>                    <span class="n">du_dy</span><span class="p">,</span> <span class="n">du_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="PDESolver.animate-2586"><a href="#PDESolver.animate-2586"><span class="linenos">2586</span></a>                    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">du_dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">du_dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver.animate-2587"><a href="#PDESolver.animate-2587"><span class="linenos">2587</span></a>                    <span class="n">local_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_norm</span> <span class="o">==</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver.animate-2588"><a href="#PDESolver.animate-2588"><span class="linenos">2588</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver.animate-2589"><a href="#PDESolver.animate-2589"><span class="linenos">2589</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">grad_norm</span><span class="p">[</span><span class="n">local_max</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span>
</span><span id="PDESolver.animate-2590"><a href="#PDESolver.animate-2590"><span class="linenos">2590</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.animate-2591"><a href="#PDESolver.animate-2591"><span class="linenos">2591</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">local_max</span><span class="p">))</span>
</span><span id="PDESolver.animate-2592"><a href="#PDESolver.animate-2592"><span class="linenos">2592</span></a>                    <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
</span><span id="PDESolver.animate-2593"><a href="#PDESolver.animate-2593"><span class="linenos">2593</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span>
</span><span id="PDESolver.animate-2594"><a href="#PDESolver.animate-2594"><span class="linenos">2594</span></a>                               <span class="n">z_offset</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">local_max</span><span class="p">]),</span>
</span><span id="PDESolver.animate-2595"><a href="#PDESolver.animate-2595"><span class="linenos">2595</span></a>                               <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="PDESolver.animate-2596"><a href="#PDESolver.animate-2596"><span class="linenos">2596</span></a>    
</span><span id="PDESolver.animate-2597"><a href="#PDESolver.animate-2597"><span class="linenos">2597</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2598"><a href="#PDESolver.animate-2598"><span class="linenos">2598</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2599"><a href="#PDESolver.animate-2599"><span class="linenos">2599</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> of u&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2600"><a href="#PDESolver.animate-2600"><span class="linenos">2600</span></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">target_times</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver.animate-2601"><a href="#PDESolver.animate-2601"><span class="linenos">2601</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution at t = </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2602"><a href="#PDESolver.animate-2602"><span class="linenos">2602</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">surf_obj</span><span class="p">,)</span>
</span><span id="PDESolver.animate-2603"><a href="#PDESolver.animate-2603"><span class="linenos">2603</span></a>    
</span><span id="PDESolver.animate-2604"><a href="#PDESolver.animate-2604"><span class="linenos">2604</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update_surface</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_times</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PDESolver.animate-2605"><a href="#PDESolver.animate-2605"><span class="linenos">2605</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span><span id="PDESolver.animate-2606"><a href="#PDESolver.animate-2606"><span class="linenos">2606</span></a>    
</span><span id="PDESolver.animate-2607"><a href="#PDESolver.animate-2607"><span class="linenos">2607</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># mode == &#39;imshow&#39;</span>
</span><span id="PDESolver.animate-2608"><a href="#PDESolver.animate-2608"><span class="linenos">2608</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver.animate-2609"><a href="#PDESolver.animate-2609"><span class="linenos">2609</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2610"><a href="#PDESolver.animate-2610"><span class="linenos">2610</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2611"><a href="#PDESolver.animate-2611"><span class="linenos">2611</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Initial condition&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2612"><a href="#PDESolver.animate-2612"><span class="linenos">2612</span></a>    
</span><span id="PDESolver.animate-2613"><a href="#PDESolver.animate-2613"><span class="linenos">2613</span></a>            <span class="c1"># extent uses physical coordinates so axes show real x/y values</span>
</span><span id="PDESolver.animate-2614"><a href="#PDESolver.animate-2614"><span class="linenos">2614</span></a>            <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="PDESolver.animate-2615"><a href="#PDESolver.animate-2615"><span class="linenos">2615</span></a>    
</span><span id="PDESolver.animate-2616"><a href="#PDESolver.animate-2616"><span class="linenos">2616</span></a>            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2617"><a href="#PDESolver.animate-2617"><span class="linenos">2617</span></a>                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="PDESolver.animate-2618"><a href="#PDESolver.animate-2618"><span class="linenos">2618</span></a>                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;twilight&#39;</span>
</span><span id="PDESolver.animate-2619"><a href="#PDESolver.animate-2619"><span class="linenos">2619</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.animate-2620"><a href="#PDESolver.animate-2620"><span class="linenos">2620</span></a>                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data0</span><span class="p">)</span>
</span><span id="PDESolver.animate-2621"><a href="#PDESolver.animate-2621"><span class="linenos">2621</span></a>                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>
</span><span id="PDESolver.animate-2622"><a href="#PDESolver.animate-2622"><span class="linenos">2622</span></a>    
</span><span id="PDESolver.animate-2623"><a href="#PDESolver.animate-2623"><span class="linenos">2623</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data0</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="PDESolver.animate-2624"><a href="#PDESolver.animate-2624"><span class="linenos">2624</span></a>                           <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2625"><a href="#PDESolver.animate-2625"><span class="linenos">2625</span></a>            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="PDESolver.animate-2626"><a href="#PDESolver.animate-2626"><span class="linenos">2626</span></a>            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2"> of u&quot;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2627"><a href="#PDESolver.animate-2627"><span class="linenos">2627</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.animate-2628"><a href="#PDESolver.animate-2628"><span class="linenos">2628</span></a>    
</span><span id="PDESolver.animate-2629"><a href="#PDESolver.animate-2629"><span class="linenos">2629</span></a>            <span class="c1"># containers for dynamic overlay artists (stored on function object)</span>
</span><span id="PDESolver.animate-2630"><a href="#PDESolver.animate-2630"><span class="linenos">2630</span></a>            <span class="c1"># update_im.contour_art and update_im.scatter_art will be created dynamically</span>
</span><span id="PDESolver.animate-2631"><a href="#PDESolver.animate-2631"><span class="linenos">2631</span></a>    
</span><span id="PDESolver.animate-2632"><a href="#PDESolver.animate-2632"><span class="linenos">2632</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_update_im</span><span class="p">(</span><span class="n">frame_number</span><span class="p">):</span>
</span><span id="PDESolver.animate-2633"><a href="#PDESolver.animate-2633"><span class="linenos">2633</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_indices</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver.animate-2634"><a href="#PDESolver.animate-2634"><span class="linenos">2634</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="n">get_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
</span><span id="PDESolver.animate-2635"><a href="#PDESolver.animate-2635"><span class="linenos">2635</span></a>    
</span><span id="PDESolver.animate-2636"><a href="#PDESolver.animate-2636"><span class="linenos">2636</span></a>                <span class="c1"># update raster</span>
</span><span id="PDESolver.animate-2637"><a href="#PDESolver.animate-2637"><span class="linenos">2637</span></a>                <span class="n">im</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
</span><span id="PDESolver.animate-2638"><a href="#PDESolver.animate-2638"><span class="linenos">2638</span></a>                <span class="k">if</span> <span class="n">component</span> <span class="o">!=</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2639"><a href="#PDESolver.animate-2639"><span class="linenos">2639</span></a>                    <span class="c1"># dynamic per-frame scaling (keeps contrast when amplitude varies)</span>
</span><span id="PDESolver.animate-2640"><a href="#PDESolver.animate-2640"><span class="linenos">2640</span></a>                    <span class="n">cmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
</span><span id="PDESolver.animate-2641"><a href="#PDESolver.animate-2641"><span class="linenos">2641</span></a>                    <span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
</span><span id="PDESolver.animate-2642"><a href="#PDESolver.animate-2642"><span class="linenos">2642</span></a>                    <span class="c1"># avoid identical vmin==vmax</span>
</span><span id="PDESolver.animate-2643"><a href="#PDESolver.animate-2643"><span class="linenos">2643</span></a>                    <span class="k">if</span> <span class="n">cmax</span> <span class="o">&gt;</span> <span class="n">cmin</span><span class="p">:</span>
</span><span id="PDESolver.animate-2644"><a href="#PDESolver.animate-2644"><span class="linenos">2644</span></a>                        <span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="p">)</span>
</span><span id="PDESolver.animate-2645"><a href="#PDESolver.animate-2645"><span class="linenos">2645</span></a>    
</span><span id="PDESolver.animate-2646"><a href="#PDESolver.animate-2646"><span class="linenos">2646</span></a>                <span class="c1"># remove previous contour if exists</span>
</span><span id="PDESolver.animate-2647"><a href="#PDESolver.animate-2647"><span class="linenos">2647</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2648"><a href="#PDESolver.animate-2648"><span class="linenos">2648</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;contour_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.animate-2649"><a href="#PDESolver.animate-2649"><span class="linenos">2649</span></a>                        <span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
</span><span id="PDESolver.animate-2650"><a href="#PDESolver.animate-2650"><span class="linenos">2650</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver.animate-2651"><a href="#PDESolver.animate-2651"><span class="linenos">2651</span></a>                                <span class="n">coll</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span id="PDESolver.animate-2652"><a href="#PDESolver.animate-2652"><span class="linenos">2652</span></a>                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver.animate-2653"><a href="#PDESolver.animate-2653"><span class="linenos">2653</span></a>                                <span class="k">pass</span>
</span><span id="PDESolver.animate-2654"><a href="#PDESolver.animate-2654"><span class="linenos">2654</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver.animate-2655"><a href="#PDESolver.animate-2655"><span class="linenos">2655</span></a>                    <span class="c1"># draw new contours (use meshgrid coords)</span>
</span><span id="PDESolver.animate-2656"><a href="#PDESolver.animate-2656"><span class="linenos">2656</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver.animate-2657"><a href="#PDESolver.animate-2657"><span class="linenos">2657</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2658"><a href="#PDESolver.animate-2658"><span class="linenos">2658</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver.animate-2659"><a href="#PDESolver.animate-2659"><span class="linenos">2659</span></a>                        <span class="c1"># fallback: contour with axis coordinates (x_grid, y_grid)</span>
</span><span id="PDESolver.animate-2660"><a href="#PDESolver.animate-2660"><span class="linenos">2660</span></a>                        <span class="n">Xc</span><span class="p">,</span> <span class="n">Yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">)</span>
</span><span id="PDESolver.animate-2661"><a href="#PDESolver.animate-2661"><span class="linenos">2661</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">Yc</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2662"><a href="#PDESolver.animate-2662"><span class="linenos">2662</span></a>    
</span><span id="PDESolver.animate-2663"><a href="#PDESolver.animate-2663"><span class="linenos">2663</span></a>                <span class="c1"># remove previous scatter if exists</span>
</span><span id="PDESolver.animate-2664"><a href="#PDESolver.animate-2664"><span class="linenos">2664</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;front&#39;</span><span class="p">:</span>
</span><span id="PDESolver.animate-2665"><a href="#PDESolver.animate-2665"><span class="linenos">2665</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;scatter_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.animate-2666"><a href="#PDESolver.animate-2666"><span class="linenos">2666</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="PDESolver.animate-2667"><a href="#PDESolver.animate-2667"><span class="linenos">2667</span></a>                            <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span id="PDESolver.animate-2668"><a href="#PDESolver.animate-2668"><span class="linenos">2668</span></a>                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="PDESolver.animate-2669"><a href="#PDESolver.animate-2669"><span class="linenos">2669</span></a>                            <span class="k">pass</span>
</span><span id="PDESolver.animate-2670"><a href="#PDESolver.animate-2670"><span class="linenos">2670</span></a>                        <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver.animate-2671"><a href="#PDESolver.animate-2671"><span class="linenos">2671</span></a>    
</span><span id="PDESolver.animate-2672"><a href="#PDESolver.animate-2672"><span class="linenos">2672</span></a>                    <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.animate-2673"><a href="#PDESolver.animate-2673"><span class="linenos">2673</span></a>                    <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PDESolver.animate-2674"><a href="#PDESolver.animate-2674"><span class="linenos">2674</span></a>                    <span class="n">du_dy</span><span class="p">,</span> <span class="n">du_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="PDESolver.animate-2675"><a href="#PDESolver.animate-2675"><span class="linenos">2675</span></a>                    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">du_dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">du_dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver.animate-2676"><a href="#PDESolver.animate-2676"><span class="linenos">2676</span></a>                    <span class="n">local_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_norm</span> <span class="o">==</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver.animate-2677"><a href="#PDESolver.animate-2677"><span class="linenos">2677</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PDESolver.animate-2678"><a href="#PDESolver.animate-2678"><span class="linenos">2678</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">grad_norm</span><span class="p">[</span><span class="n">local_max</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span>
</span><span id="PDESolver.animate-2679"><a href="#PDESolver.animate-2679"><span class="linenos">2679</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.animate-2680"><a href="#PDESolver.animate-2680"><span class="linenos">2680</span></a>                        <span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">local_max</span><span class="p">))</span>
</span><span id="PDESolver.animate-2681"><a href="#PDESolver.animate-2681"><span class="linenos">2681</span></a>                    <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
</span><span id="PDESolver.animate-2682"><a href="#PDESolver.animate-2682"><span class="linenos">2682</span></a>                    <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">local_max</span><span class="p">],</span>
</span><span id="PDESolver.animate-2683"><a href="#PDESolver.animate-2683"><span class="linenos">2683</span></a>                                                       <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="PDESolver.animate-2684"><a href="#PDESolver.animate-2684"><span class="linenos">2684</span></a>    
</span><span id="PDESolver.animate-2685"><a href="#PDESolver.animate-2685"><span class="linenos">2685</span></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">target_times</span><span class="p">[</span><span class="n">frame_number</span><span class="p">]</span>
</span><span id="PDESolver.animate-2686"><a href="#PDESolver.animate-2686"><span class="linenos">2686</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution at t = </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver.animate-2687"><a href="#PDESolver.animate-2687"><span class="linenos">2687</span></a>                <span class="c1"># return main image plus any overlay artists present so Matplotlib can redraw them</span>
</span><span id="PDESolver.animate-2688"><a href="#PDESolver.animate-2688"><span class="linenos">2688</span></a>                <span class="n">artists</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="p">]</span>
</span><span id="PDESolver.animate-2689"><a href="#PDESolver.animate-2689"><span class="linenos">2689</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;contour_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.animate-2690"><a href="#PDESolver.animate-2690"><span class="linenos">2690</span></a>                    <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">update_im</span><span class="o">.</span><span class="n">contour_art</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>
</span><span id="PDESolver.animate-2691"><a href="#PDESolver.animate-2691"><span class="linenos">2691</span></a>                <span class="k">if</span> <span class="n">overlay</span> <span class="o">==</span> <span class="s1">&#39;front&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_im</span><span class="p">,</span> <span class="s1">&#39;scatter_art&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.animate-2692"><a href="#PDESolver.animate-2692"><span class="linenos">2692</span></a>                    <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_im</span><span class="o">.</span><span class="n">scatter_art</span><span class="p">)</span>
</span><span id="PDESolver.animate-2693"><a href="#PDESolver.animate-2693"><span class="linenos">2693</span></a>                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">artists</span><span class="p">)</span>
</span><span id="PDESolver.animate-2694"><a href="#PDESolver.animate-2694"><span class="linenos">2694</span></a>    
</span><span id="PDESolver.animate-2695"><a href="#PDESolver.animate-2695"><span class="linenos">2695</span></a>            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update_im</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_times</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="PDESolver.animate-2696"><a href="#PDESolver.animate-2696"><span class="linenos">2696</span></a>            <span class="k">return</span> <span class="n">ani</span>
</span></pre></div>


            <div class="docstring"><p>Create an animated plot of the solution evolution over time.</p>

<p>This method generates a dynamic visualization of the stored solution frames
<code>self.frames</code>. It supports:</p>

<ul>
<li>1D line animation (unchanged),</li>
<li>2D surface animation (original behavior, 'surface'),</li>
<li>2D image animation using imshow (new, 'imshow') which is faster and
often clearer for large grids.</li>
</ul>

<h2 id="parameters">Parameters</h2>

<p>component : str, optional, one of {'real', 'imag', 'abs', 'angle'}
    Which component of the complex field to visualize:
      - 'real'  : Re(u)
      - 'imag'  : Im(u)
      - 'abs'   : |u|
      - 'angle' : arg(u)
    Default is 'abs'.</p>

<p>overlay : str or None, optional, one of {'contour', 'front', None}
    For 2D modes only. If None, no overlay is drawn.
      - 'contour' : draw contour lines on top (or beneath for 3D surface)
      - 'front'   : detect and mark wavefronts using gradient maxima
    Default is 'contour'.</p>

<p>mode : str, optional, one of {'surface', 'imshow'}
    2D rendering mode. 'surface' keeps the original 3D surface plot.
    'imshow' draws a 2D raster (faster, often more readable).
    Default is 'surface' for backward compatibility.</p>

<h2 id="returns">Returns</h2>

<p>FuncAnimation
    A Matplotlib <code>FuncAnimation</code> instance (you can display it in a notebook
    or save it to file).</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The method uses the same time-mapping logic as before (linear sampling of
stored frames to animation frames).</li>
<li>For 'angle' the color scale is fixed between -π and π.</li>
<li>For other components, color scaling is by default dynamically adapted per
frame in 'imshow' mode (this avoids extreme clipping if amplitudes vary).</li>
<li>Overlays are updated cleanly: previous contour/scatter artists are removed
before drawing the next frame to avoid memory/visual accumulation.</li>
<li>Animation interval is 50 ms per frame (unchanged).</li>
</ul>
</div>


                            </div>
                            <div id="PDESolver.test" class="classattr">
                                        <input id="PDESolver.test-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u_exact</span>,</span><span class="param">	<span class="n">t_eval</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">norm</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span>,</span><span class="param">	<span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span>,</span><span class="param">	<span class="n">component</span><span class="o">=</span><span class="s1">&#39;real&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PDESolver.test-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PDESolver.test"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PDESolver.test-2698"><a href="#PDESolver.test-2698"><span class="linenos">2698</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_exact</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;real&#39;</span><span class="p">):</span>
</span><span id="PDESolver.test-2699"><a href="#PDESolver.test-2699"><span class="linenos">2699</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PDESolver.test-2700"><a href="#PDESolver.test-2700"><span class="linenos">2700</span></a><span class="sd">        Test the solver against an exact solution.</span>
</span><span id="PDESolver.test-2701"><a href="#PDESolver.test-2701"><span class="linenos">2701</span></a>
</span><span id="PDESolver.test-2702"><a href="#PDESolver.test-2702"><span class="linenos">2702</span></a><span class="sd">        This method quantitatively compares the numerical solution with a provided exact solution </span>
</span><span id="PDESolver.test-2703"><a href="#PDESolver.test-2703"><span class="linenos">2703</span></a><span class="sd">        at a specified time using either relative or absolute error norms. It supports both </span>
</span><span id="PDESolver.test-2704"><a href="#PDESolver.test-2704"><span class="linenos">2704</span></a><span class="sd">        stationary and time-dependent problems in 1D and 2D. If enabled, it also generates plots </span>
</span><span id="PDESolver.test-2705"><a href="#PDESolver.test-2705"><span class="linenos">2705</span></a><span class="sd">        of the solution, exact solution, and pointwise error.</span>
</span><span id="PDESolver.test-2706"><a href="#PDESolver.test-2706"><span class="linenos">2706</span></a>
</span><span id="PDESolver.test-2707"><a href="#PDESolver.test-2707"><span class="linenos">2707</span></a><span class="sd">        Parameters</span>
</span><span id="PDESolver.test-2708"><a href="#PDESolver.test-2708"><span class="linenos">2708</span></a><span class="sd">        ----------</span>
</span><span id="PDESolver.test-2709"><a href="#PDESolver.test-2709"><span class="linenos">2709</span></a><span class="sd">        u_exact : callable</span>
</span><span id="PDESolver.test-2710"><a href="#PDESolver.test-2710"><span class="linenos">2710</span></a><span class="sd">            Exact solution function taking spatial coordinates and optionally time as arguments.</span>
</span><span id="PDESolver.test-2711"><a href="#PDESolver.test-2711"><span class="linenos">2711</span></a><span class="sd">        t_eval : float, optional</span>
</span><span id="PDESolver.test-2712"><a href="#PDESolver.test-2712"><span class="linenos">2712</span></a><span class="sd">            Time at which to compare solutions. For non-stationary problems, defaults to final time Lt.</span>
</span><span id="PDESolver.test-2713"><a href="#PDESolver.test-2713"><span class="linenos">2713</span></a><span class="sd">            Ignored for stationary problems.</span>
</span><span id="PDESolver.test-2714"><a href="#PDESolver.test-2714"><span class="linenos">2714</span></a><span class="sd">        norm : str {&#39;relative&#39;, &#39;absolute&#39;}</span>
</span><span id="PDESolver.test-2715"><a href="#PDESolver.test-2715"><span class="linenos">2715</span></a><span class="sd">            Type of error norm used in comparison.</span>
</span><span id="PDESolver.test-2716"><a href="#PDESolver.test-2716"><span class="linenos">2716</span></a><span class="sd">        threshold : float</span>
</span><span id="PDESolver.test-2717"><a href="#PDESolver.test-2717"><span class="linenos">2717</span></a><span class="sd">            Acceptable error threshold; raises an assertion if exceeded.</span>
</span><span id="PDESolver.test-2718"><a href="#PDESolver.test-2718"><span class="linenos">2718</span></a><span class="sd">        plot : bool</span>
</span><span id="PDESolver.test-2719"><a href="#PDESolver.test-2719"><span class="linenos">2719</span></a><span class="sd">            Whether to display visual comparison plots (default: True).</span>
</span><span id="PDESolver.test-2720"><a href="#PDESolver.test-2720"><span class="linenos">2720</span></a><span class="sd">        component : str {&#39;real&#39;, &#39;imag&#39;, &#39;abs&#39;}</span>
</span><span id="PDESolver.test-2721"><a href="#PDESolver.test-2721"><span class="linenos">2721</span></a><span class="sd">            Component of the solution to compare and visualize.</span>
</span><span id="PDESolver.test-2722"><a href="#PDESolver.test-2722"><span class="linenos">2722</span></a>
</span><span id="PDESolver.test-2723"><a href="#PDESolver.test-2723"><span class="linenos">2723</span></a><span class="sd">        Raises</span>
</span><span id="PDESolver.test-2724"><a href="#PDESolver.test-2724"><span class="linenos">2724</span></a><span class="sd">        ------</span>
</span><span id="PDESolver.test-2725"><a href="#PDESolver.test-2725"><span class="linenos">2725</span></a><span class="sd">        ValueError</span>
</span><span id="PDESolver.test-2726"><a href="#PDESolver.test-2726"><span class="linenos">2726</span></a><span class="sd">            If unsupported dimension is encountered or requested evaluation time exceeds simulation duration.</span>
</span><span id="PDESolver.test-2727"><a href="#PDESolver.test-2727"><span class="linenos">2727</span></a><span class="sd">        AssertionError</span>
</span><span id="PDESolver.test-2728"><a href="#PDESolver.test-2728"><span class="linenos">2728</span></a><span class="sd">            If computed error exceeds the given threshold.</span>
</span><span id="PDESolver.test-2729"><a href="#PDESolver.test-2729"><span class="linenos">2729</span></a>
</span><span id="PDESolver.test-2730"><a href="#PDESolver.test-2730"><span class="linenos">2730</span></a><span class="sd">        Prints</span>
</span><span id="PDESolver.test-2731"><a href="#PDESolver.test-2731"><span class="linenos">2731</span></a><span class="sd">        ------</span>
</span><span id="PDESolver.test-2732"><a href="#PDESolver.test-2732"><span class="linenos">2732</span></a><span class="sd">        - Information about the closest available frame to the requested evaluation time.</span>
</span><span id="PDESolver.test-2733"><a href="#PDESolver.test-2733"><span class="linenos">2733</span></a><span class="sd">        - Computed error value and comparison to threshold.</span>
</span><span id="PDESolver.test-2734"><a href="#PDESolver.test-2734"><span class="linenos">2734</span></a>
</span><span id="PDESolver.test-2735"><a href="#PDESolver.test-2735"><span class="linenos">2735</span></a><span class="sd">        Notes</span>
</span><span id="PDESolver.test-2736"><a href="#PDESolver.test-2736"><span class="linenos">2736</span></a><span class="sd">        -----</span>
</span><span id="PDESolver.test-2737"><a href="#PDESolver.test-2737"><span class="linenos">2737</span></a><span class="sd">        - For time-dependent problems, the solution is extracted from precomputed frames.</span>
</span><span id="PDESolver.test-2738"><a href="#PDESolver.test-2738"><span class="linenos">2738</span></a><span class="sd">        - Plots are adapted to spatial dimension: line plots for 1D, image plots for 2D.</span>
</span><span id="PDESolver.test-2739"><a href="#PDESolver.test-2739"><span class="linenos">2739</span></a><span class="sd">        - The method ensures consistent handling of real, imaginary, and magnitude components.</span>
</span><span id="PDESolver.test-2740"><a href="#PDESolver.test-2740"><span class="linenos">2740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PDESolver.test-2741"><a href="#PDESolver.test-2741"><span class="linenos">2741</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stationary</span><span class="p">:</span>
</span><span id="PDESolver.test-2742"><a href="#PDESolver.test-2742"><span class="linenos">2742</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing a stationary solution.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2743"><a href="#PDESolver.test-2743"><span class="linenos">2743</span></a>            <span class="n">u_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
</span><span id="PDESolver.test-2744"><a href="#PDESolver.test-2744"><span class="linenos">2744</span></a>    
</span><span id="PDESolver.test-2745"><a href="#PDESolver.test-2745"><span class="linenos">2745</span></a>            <span class="c1"># Compute exact solution</span>
</span><span id="PDESolver.test-2746"><a href="#PDESolver.test-2746"><span class="linenos">2746</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.test-2747"><a href="#PDESolver.test-2747"><span class="linenos">2747</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</span><span id="PDESolver.test-2748"><a href="#PDESolver.test-2748"><span class="linenos">2748</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.test-2749"><a href="#PDESolver.test-2749"><span class="linenos">2749</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
</span><span id="PDESolver.test-2750"><a href="#PDESolver.test-2750"><span class="linenos">2750</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.test-2751"><a href="#PDESolver.test-2751"><span class="linenos">2751</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2752"><a href="#PDESolver.test-2752"><span class="linenos">2752</span></a>            <span class="n">actual_t</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PDESolver.test-2753"><a href="#PDESolver.test-2753"><span class="linenos">2753</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.test-2754"><a href="#PDESolver.test-2754"><span class="linenos">2754</span></a>            <span class="k">if</span> <span class="n">t_eval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PDESolver.test-2755"><a href="#PDESolver.test-2755"><span class="linenos">2755</span></a>                <span class="n">t_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span>
</span><span id="PDESolver.test-2756"><a href="#PDESolver.test-2756"><span class="linenos">2756</span></a>    
</span><span id="PDESolver.test-2757"><a href="#PDESolver.test-2757"><span class="linenos">2757</span></a>            <span class="n">save_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
</span><span id="PDESolver.test-2758"><a href="#PDESolver.test-2758"><span class="linenos">2758</span></a>            <span class="n">frame_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">save_interval</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</span><span id="PDESolver.test-2759"><a href="#PDESolver.test-2759"><span class="linenos">2759</span></a>            <span class="n">frame_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_times</span> <span class="o">-</span> <span class="n">t_eval</span><span class="p">))</span>
</span><span id="PDESolver.test-2760"><a href="#PDESolver.test-2760"><span class="linenos">2760</span></a>            <span class="n">actual_t</span> <span class="o">=</span> <span class="n">frame_times</span><span class="p">[</span><span class="n">frame_index</span><span class="p">]</span>
</span><span id="PDESolver.test-2761"><a href="#PDESolver.test-2761"><span class="linenos">2761</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closest available time to t_eval=</span><span class="si">{</span><span class="n">t_eval</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">actual_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2762"><a href="#PDESolver.test-2762"><span class="linenos">2762</span></a>    
</span><span id="PDESolver.test-2763"><a href="#PDESolver.test-2763"><span class="linenos">2763</span></a>            <span class="k">if</span> <span class="n">frame_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">):</span>
</span><span id="PDESolver.test-2764"><a href="#PDESolver.test-2764"><span class="linenos">2764</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time t = </span><span class="si">{</span><span class="n">t_eval</span><span class="si">}</span><span class="s2"> exceeds simulation duration.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2765"><a href="#PDESolver.test-2765"><span class="linenos">2765</span></a>    
</span><span id="PDESolver.test-2766"><a href="#PDESolver.test-2766"><span class="linenos">2766</span></a>            <span class="n">u_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">frame_index</span><span class="p">]</span>
</span><span id="PDESolver.test-2767"><a href="#PDESolver.test-2767"><span class="linenos">2767</span></a>    
</span><span id="PDESolver.test-2768"><a href="#PDESolver.test-2768"><span class="linenos">2768</span></a>            <span class="c1"># Compute exact solution at the actual time</span>
</span><span id="PDESolver.test-2769"><a href="#PDESolver.test-2769"><span class="linenos">2769</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.test-2770"><a href="#PDESolver.test-2770"><span class="linenos">2770</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">actual_t</span><span class="p">)</span>
</span><span id="PDESolver.test-2771"><a href="#PDESolver.test-2771"><span class="linenos">2771</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PDESolver.test-2772"><a href="#PDESolver.test-2772"><span class="linenos">2772</span></a>                <span class="n">u_ex</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">actual_t</span><span class="p">)</span>
</span><span id="PDESolver.test-2773"><a href="#PDESolver.test-2773"><span class="linenos">2773</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.test-2774"><a href="#PDESolver.test-2774"><span class="linenos">2774</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported dimension.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2775"><a href="#PDESolver.test-2775"><span class="linenos">2775</span></a>    
</span><span id="PDESolver.test-2776"><a href="#PDESolver.test-2776"><span class="linenos">2776</span></a>        <span class="c1"># Select component</span>
</span><span id="PDESolver.test-2777"><a href="#PDESolver.test-2777"><span class="linenos">2777</span></a>        <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
</span><span id="PDESolver.test-2778"><a href="#PDESolver.test-2778"><span class="linenos">2778</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_num</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver.test-2779"><a href="#PDESolver.test-2779"><span class="linenos">2779</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver.test-2780"><a href="#PDESolver.test-2780"><span class="linenos">2780</span></a>        <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
</span><span id="PDESolver.test-2781"><a href="#PDESolver.test-2781"><span class="linenos">2781</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u_num</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver.test-2782"><a href="#PDESolver.test-2782"><span class="linenos">2782</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver.test-2783"><a href="#PDESolver.test-2783"><span class="linenos">2783</span></a>        <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
</span><span id="PDESolver.test-2784"><a href="#PDESolver.test-2784"><span class="linenos">2784</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_num</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver.test-2785"><a href="#PDESolver.test-2785"><span class="linenos">2785</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_ex</span><span class="p">)</span>
</span><span id="PDESolver.test-2786"><a href="#PDESolver.test-2786"><span class="linenos">2786</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.test-2787"><a href="#PDESolver.test-2787"><span class="linenos">2787</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid component.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2788"><a href="#PDESolver.test-2788"><span class="linenos">2788</span></a>    
</span><span id="PDESolver.test-2789"><a href="#PDESolver.test-2789"><span class="linenos">2789</span></a>        <span class="c1"># Compute error</span>
</span><span id="PDESolver.test-2790"><a href="#PDESolver.test-2790"><span class="linenos">2790</span></a>        <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;relative&#39;</span><span class="p">:</span>
</span><span id="PDESolver.test-2791"><a href="#PDESolver.test-2791"><span class="linenos">2791</span></a>            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
</span><span id="PDESolver.test-2792"><a href="#PDESolver.test-2792"><span class="linenos">2792</span></a>        <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;absolute&#39;</span><span class="p">:</span>
</span><span id="PDESolver.test-2793"><a href="#PDESolver.test-2793"><span class="linenos">2793</span></a>            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
</span><span id="PDESolver.test-2794"><a href="#PDESolver.test-2794"><span class="linenos">2794</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.test-2795"><a href="#PDESolver.test-2795"><span class="linenos">2795</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown norm type.&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2796"><a href="#PDESolver.test-2796"><span class="linenos">2796</span></a>    
</span><span id="PDESolver.test-2797"><a href="#PDESolver.test-2797"><span class="linenos">2797</span></a>        <span class="n">label_time</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">actual_t</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">actual_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="PDESolver.test-2798"><a href="#PDESolver.test-2798"><span class="linenos">2798</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test error </span><span class="si">{</span><span class="n">label_time</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2799"><a href="#PDESolver.test-2799"><span class="linenos">2799</span></a>        <span class="k">assert</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error too large </span><span class="si">{</span><span class="n">label_time</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PDESolver.test-2800"><a href="#PDESolver.test-2800"><span class="linenos">2800</span></a>    
</span><span id="PDESolver.test-2801"><a href="#PDESolver.test-2801"><span class="linenos">2801</span></a>        <span class="c1"># Plot</span>
</span><span id="PDESolver.test-2802"><a href="#PDESolver.test-2802"><span class="linenos">2802</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
</span><span id="PDESolver.test-2803"><a href="#PDESolver.test-2803"><span class="linenos">2803</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PDESolver.test-2804"><a href="#PDESolver.test-2804"><span class="linenos">2804</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="PDESolver.test-2805"><a href="#PDESolver.test-2805"><span class="linenos">2805</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PDESolver.test-2806"><a href="#PDESolver.test-2806"><span class="linenos">2806</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_num</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Numerical&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2807"><a href="#PDESolver.test-2807"><span class="linenos">2807</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">u_ex</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Exact&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2808"><a href="#PDESolver.test-2808"><span class="linenos">2808</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution </span><span class="si">{</span><span class="n">label_time</span><span class="si">}</span><span class="s1">, error = </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2809"><a href="#PDESolver.test-2809"><span class="linenos">2809</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="PDESolver.test-2810"><a href="#PDESolver.test-2810"><span class="linenos">2810</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="PDESolver.test-2811"><a href="#PDESolver.test-2811"><span class="linenos">2811</span></a>    
</span><span id="PDESolver.test-2812"><a href="#PDESolver.test-2812"><span class="linenos">2812</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver.test-2813"><a href="#PDESolver.test-2813"><span class="linenos">2813</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2814"><a href="#PDESolver.test-2814"><span class="linenos">2814</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Absolute Error&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2815"><a href="#PDESolver.test-2815"><span class="linenos">2815</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="PDESolver.test-2816"><a href="#PDESolver.test-2816"><span class="linenos">2816</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.test-2817"><a href="#PDESolver.test-2817"><span class="linenos">2817</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver.test-2818"><a href="#PDESolver.test-2818"><span class="linenos">2818</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PDESolver.test-2819"><a href="#PDESolver.test-2819"><span class="linenos">2819</span></a>                <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
</span><span id="PDESolver.test-2820"><a href="#PDESolver.test-2820"><span class="linenos">2820</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="PDESolver.test-2821"><a href="#PDESolver.test-2821"><span class="linenos">2821</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PDESolver.test-2822"><a href="#PDESolver.test-2822"><span class="linenos">2822</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Numerical Solution&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2823"><a href="#PDESolver.test-2823"><span class="linenos">2823</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_num</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2824"><a href="#PDESolver.test-2824"><span class="linenos">2824</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="PDESolver.test-2825"><a href="#PDESolver.test-2825"><span class="linenos">2825</span></a>    
</span><span id="PDESolver.test-2826"><a href="#PDESolver.test-2826"><span class="linenos">2826</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PDESolver.test-2827"><a href="#PDESolver.test-2827"><span class="linenos">2827</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Exact Solution&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2828"><a href="#PDESolver.test-2828"><span class="linenos">2828</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_ex</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2829"><a href="#PDESolver.test-2829"><span class="linenos">2829</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="PDESolver.test-2830"><a href="#PDESolver.test-2830"><span class="linenos">2830</span></a>    
</span><span id="PDESolver.test-2831"><a href="#PDESolver.test-2831"><span class="linenos">2831</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="PDESolver.test-2832"><a href="#PDESolver.test-2832"><span class="linenos">2832</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error (Norm = </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="PDESolver.test-2833"><a href="#PDESolver.test-2833"><span class="linenos">2833</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
</span><span id="PDESolver.test-2834"><a href="#PDESolver.test-2834"><span class="linenos">2834</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="PDESolver.test-2835"><a href="#PDESolver.test-2835"><span class="linenos">2835</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="PDESolver.test-2836"><a href="#PDESolver.test-2836"><span class="linenos">2836</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="PDESolver.test-2837"><a href="#PDESolver.test-2837"><span class="linenos">2837</span></a>
</span><span id="PDESolver.test-2838"><a href="#PDESolver.test-2838"><span class="linenos">2838</span></a>        <span class="k">return</span> <span class="n">error</span>
</span></pre></div>


            <div class="docstring"><p>Test the solver against an exact solution.</p>

<p>This method quantitatively compares the numerical solution with a provided exact solution 
at a specified time using either relative or absolute error norms. It supports both 
stationary and time-dependent problems in 1D and 2D. If enabled, it also generates plots 
of the solution, exact solution, and pointwise error.</p>

<h2 id="parameters">Parameters</h2>

<p>u_exact : callable
    Exact solution function taking spatial coordinates and optionally time as arguments.
t_eval : float, optional
    Time at which to compare solutions. For non-stationary problems, defaults to final time Lt.
    Ignored for stationary problems.
norm : str {'relative', 'absolute'}
    Type of error norm used in comparison.
threshold : float
    Acceptable error threshold; raises an assertion if exceeded.
plot : bool
    Whether to display visual comparison plots (default: True).
component : str {'real', 'imag', 'abs'}
    Component of the solution to compare and visualize.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If unsupported dimension is encountered or requested evaluation time exceeds simulation duration.
AssertionError
    If computed error exceeds the given threshold.</p>

<h2 id="prints">Prints</h2>

<ul>
<li>Information about the closest available frame to the requested evaluation time.</li>
<li>Computed error value and comparison to threshold.</li>
</ul>

<h2 id="notes">Notes</h2>

<ul>
<li>For time-dependent problems, the solution is extracted from precomputed frames.</li>
<li>Plots are adapted to spatial dimension: line plots for 1D, image plots for 2D.</li>
<li>The method ensures consistent handling of real, imaginary, and magnitude components.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="LagrangianHamiltonianConverter">
                            <input id="LagrangianHamiltonianConverter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LagrangianHamiltonianConverter</span>:

                <label class="view-source-button" for="LagrangianHamiltonianConverter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LagrangianHamiltonianConverter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LagrangianHamiltonianConverter-37"><a href="#LagrangianHamiltonianConverter-37"><span class="linenos"> 37</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LagrangianHamiltonianConverter</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-38"><a href="#LagrangianHamiltonianConverter-38"><span class="linenos"> 38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-39"><a href="#LagrangianHamiltonianConverter-39"><span class="linenos"> 39</span></a><span class="sd">    Bidirectional converter between Lagrangian and Hamiltonian (Legendre transform),</span>
</span><span id="LagrangianHamiltonianConverter-40"><a href="#LagrangianHamiltonianConverter-40"><span class="linenos"> 40</span></a><span class="sd">    with optional Legendre–Fenchel (convex conjugate) support and robust numeric fallback.</span>
</span><span id="LagrangianHamiltonianConverter-41"><a href="#LagrangianHamiltonianConverter-41"><span class="linenos"> 41</span></a>
</span><span id="LagrangianHamiltonianConverter-42"><a href="#LagrangianHamiltonianConverter-42"><span class="linenos"> 42</span></a><span class="sd">    Main API:</span>
</span><span id="LagrangianHamiltonianConverter-43"><a href="#LagrangianHamiltonianConverter-43"><span class="linenos"> 43</span></a><span class="sd">      L_to_H(L_expr, coords, u, p_vars, return_symbol_only=False, force=False,</span>
</span><span id="LagrangianHamiltonianConverter-44"><a href="#LagrangianHamiltonianConverter-44"><span class="linenos"> 44</span></a><span class="sd">             method=&quot;legendre&quot;, fenchel_opts=None)</span>
</span><span id="LagrangianHamiltonianConverter-45"><a href="#LagrangianHamiltonianConverter-45"><span class="linenos"> 45</span></a>
</span><span id="LagrangianHamiltonianConverter-46"><a href="#LagrangianHamiltonianConverter-46"><span class="linenos"> 46</span></a><span class="sd">        - method: &quot;legendre&quot; (default), &quot;fenchel_symbolic&quot;, &quot;fenchel_numeric&quot;</span>
</span><span id="LagrangianHamiltonianConverter-47"><a href="#LagrangianHamiltonianConverter-47"><span class="linenos"> 47</span></a><span class="sd">        - If method == &quot;fenchel_numeric&quot; returns (H_repr, xi_vars, numeric_callable)</span>
</span><span id="LagrangianHamiltonianConverter-48"><a href="#LagrangianHamiltonianConverter-48"><span class="linenos"> 48</span></a><span class="sd">          otherwise returns (H_expr, xi_vars)</span>
</span><span id="LagrangianHamiltonianConverter-49"><a href="#LagrangianHamiltonianConverter-49"><span class="linenos"> 49</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-50"><a href="#LagrangianHamiltonianConverter-50"><span class="linenos"> 50</span></a>
</span><span id="LagrangianHamiltonianConverter-51"><a href="#LagrangianHamiltonianConverter-51"><span class="linenos"> 51</span></a>    <span class="n">_numeric_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LagrangianHamiltonianConverter-52"><a href="#LagrangianHamiltonianConverter-52"><span class="linenos"> 52</span></a>
</span><span id="LagrangianHamiltonianConverter-53"><a href="#LagrangianHamiltonianConverter-53"><span class="linenos"> 53</span></a>    <span class="c1"># --------------------</span>
</span><span id="LagrangianHamiltonianConverter-54"><a href="#LagrangianHamiltonianConverter-54"><span class="linenos"> 54</span></a>    <span class="c1"># Utilities</span>
</span><span id="LagrangianHamiltonianConverter-55"><a href="#LagrangianHamiltonianConverter-55"><span class="linenos"> 55</span></a>    <span class="c1"># --------------------</span>
</span><span id="LagrangianHamiltonianConverter-56"><a href="#LagrangianHamiltonianConverter-56"><span class="linenos"> 56</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter-57"><a href="#LagrangianHamiltonianConverter-57"><span class="linenos"> 57</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_quadratic_in_p</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-58"><a href="#LagrangianHamiltonianConverter-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-59"><a href="#LagrangianHamiltonianConverter-59"><span class="linenos"> 59</span></a><span class="sd">        Robust test: returns True only if L_expr is polynomial of degree ≤ 2 in each p_var.</span>
</span><span id="LagrangianHamiltonianConverter-60"><a href="#LagrangianHamiltonianConverter-60"><span class="linenos"> 60</span></a><span class="sd">        Falls back to False for non-polynomial expressions (Abs, sqrt, etc.).</span>
</span><span id="LagrangianHamiltonianConverter-61"><a href="#LagrangianHamiltonianConverter-61"><span class="linenos"> 61</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-62"><a href="#LagrangianHamiltonianConverter-62"><span class="linenos"> 62</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_vars</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-63"><a href="#LagrangianHamiltonianConverter-63"><span class="linenos"> 63</span></a>            <span class="c1"># Quick test: is L polynomial in p?</span>
</span><span id="LagrangianHamiltonianConverter-64"><a href="#LagrangianHamiltonianConverter-64"><span class="linenos"> 64</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">is_polynomial</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-65"><a href="#LagrangianHamiltonianConverter-65"><span class="linenos"> 65</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="LagrangianHamiltonianConverter-66"><a href="#LagrangianHamiltonianConverter-66"><span class="linenos"> 66</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-67"><a href="#LagrangianHamiltonianConverter-67"><span class="linenos"> 67</span></a>                <span class="n">deg</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-68"><a href="#LagrangianHamiltonianConverter-68"><span class="linenos"> 68</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-69"><a href="#LagrangianHamiltonianConverter-69"><span class="linenos"> 69</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="LagrangianHamiltonianConverter-70"><a href="#LagrangianHamiltonianConverter-70"><span class="linenos"> 70</span></a>            <span class="k">if</span> <span class="n">deg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">deg</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-71"><a href="#LagrangianHamiltonianConverter-71"><span class="linenos"> 71</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="LagrangianHamiltonianConverter-72"><a href="#LagrangianHamiltonianConverter-72"><span class="linenos"> 72</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="LagrangianHamiltonianConverter-73"><a href="#LagrangianHamiltonianConverter-73"><span class="linenos"> 73</span></a>
</span><span id="LagrangianHamiltonianConverter-74"><a href="#LagrangianHamiltonianConverter-74"><span class="linenos"> 74</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter-75"><a href="#LagrangianHamiltonianConverter-75"><span class="linenos"> 75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_quadratic_legendre</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-76"><a href="#LagrangianHamiltonianConverter-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-77"><a href="#LagrangianHamiltonianConverter-77"><span class="linenos"> 77</span></a><span class="sd">        Analytic Legendre transform for quadratic L: L = 1/2 p^T A p + b^T p + c</span>
</span><span id="LagrangianHamiltonianConverter-78"><a href="#LagrangianHamiltonianConverter-78"><span class="linenos"> 78</span></a><span class="sd">        Returns (H_expr, sol_map) and raises ValueError if Hessian singular.</span>
</span><span id="LagrangianHamiltonianConverter-79"><a href="#LagrangianHamiltonianConverter-79"><span class="linenos"> 79</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-80"><a href="#LagrangianHamiltonianConverter-80"><span class="linenos"> 80</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([[</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_i</span><span class="p">),</span> <span class="n">p_j</span><span class="p">)</span> <span class="k">for</span> <span class="n">p_j</span> <span class="ow">in</span> <span class="n">p_vars</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="n">p_vars</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-81"><a href="#LagrangianHamiltonianConverter-81"><span class="linenos"> 81</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_vars</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-82"><a href="#LagrangianHamiltonianConverter-82"><span class="linenos"> 82</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-83"><a href="#LagrangianHamiltonianConverter-83"><span class="linenos"> 83</span></a>            <span class="n">A_inv</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
</span><span id="LagrangianHamiltonianConverter-84"><a href="#LagrangianHamiltonianConverter-84"><span class="linenos"> 84</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-85"><a href="#LagrangianHamiltonianConverter-85"><span class="linenos"> 85</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quadratic analytic path: Hessian A is singular (non-invertible).&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-86"><a href="#LagrangianHamiltonianConverter-86"><span class="linenos"> 86</span></a>        <span class="n">subs_zero</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_vars</span><span class="p">}</span>
</span><span id="LagrangianHamiltonianConverter-87"><a href="#LagrangianHamiltonianConverter-87"><span class="linenos"> 87</span></a>        <span class="n">b_vec</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">subs_zero</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-88"><a href="#LagrangianHamiltonianConverter-88"><span class="linenos"> 88</span></a>        <span class="n">xi_vec</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-89"><a href="#LagrangianHamiltonianConverter-89"><span class="linenos"> 89</span></a>        <span class="n">p_solution_vec</span> <span class="o">=</span> <span class="n">A_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi_vec</span> <span class="o">-</span> <span class="n">b_vec</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-90"><a href="#LagrangianHamiltonianConverter-90"><span class="linenos"> 90</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">p_solution_vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter-91"><a href="#LagrangianHamiltonianConverter-91"><span class="linenos"> 91</span></a>        <span class="n">H_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sol</span><span class="p">[</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">)))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-92"><a href="#LagrangianHamiltonianConverter-92"><span class="linenos"> 92</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">H_expr</span><span class="p">),</span> <span class="n">sol</span>
</span><span id="LagrangianHamiltonianConverter-93"><a href="#LagrangianHamiltonianConverter-93"><span class="linenos"> 93</span></a>
</span><span id="LagrangianHamiltonianConverter-94"><a href="#LagrangianHamiltonianConverter-94"><span class="linenos"> 94</span></a>    <span class="c1"># ----------------------------</span>
</span><span id="LagrangianHamiltonianConverter-95"><a href="#LagrangianHamiltonianConverter-95"><span class="linenos"> 95</span></a>    <span class="c1"># Numeric Legendre-Fenchel helpers</span>
</span><span id="LagrangianHamiltonianConverter-96"><a href="#LagrangianHamiltonianConverter-96"><span class="linenos"> 96</span></a>    <span class="c1"># ----------------------------</span>
</span><span id="LagrangianHamiltonianConverter-97"><a href="#LagrangianHamiltonianConverter-97"><span class="linenos"> 97</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter-98"><a href="#LagrangianHamiltonianConverter-98"><span class="linenos"> 98</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_legendre_fenchel_1d_numeric_callable</span><span class="p">(</span><span class="n">L_func</span><span class="p">,</span> <span class="n">p_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">n_grid</span><span class="o">=</span><span class="mi">2001</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter-99"><a href="#LagrangianHamiltonianConverter-99"><span class="linenos"> 99</span></a>                                             <span class="n">scipy_multistart</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-100"><a href="#LagrangianHamiltonianConverter-100"><span class="linenos">100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-101"><a href="#LagrangianHamiltonianConverter-101"><span class="linenos">101</span></a><span class="sd">        Return a callable H_numeric(xi) = sup_p (xi*p - L(p)) for 1D L_func(p).</span>
</span><span id="LagrangianHamiltonianConverter-102"><a href="#LagrangianHamiltonianConverter-102"><span class="linenos">102</span></a><span class="sd">        - L_func: callable p -&gt; L(p)</span>
</span><span id="LagrangianHamiltonianConverter-103"><a href="#LagrangianHamiltonianConverter-103"><span class="linenos">103</span></a><span class="sd">        - mode: &quot;auto&quot; | &quot;scipy&quot; | &quot;grid&quot;</span>
</span><span id="LagrangianHamiltonianConverter-104"><a href="#LagrangianHamiltonianConverter-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-105"><a href="#LagrangianHamiltonianConverter-105"><span class="linenos">105</span></a>        <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">p_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-106"><a href="#LagrangianHamiltonianConverter-106"><span class="linenos">106</span></a>
</span><span id="LagrangianHamiltonianConverter-107"><a href="#LagrangianHamiltonianConverter-107"><span class="linenos">107</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_compute_by_grid</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-108"><a href="#LagrangianHamiltonianConverter-108"><span class="linenos">108</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_grid</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-109"><a href="#LagrangianHamiltonianConverter-109"><span class="linenos">109</span></a>            <span class="n">Lvals</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">L_func</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-110"><a href="#LagrangianHamiltonianConverter-110"><span class="linenos">110</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">grid</span> <span class="o">-</span> <span class="n">Lvals</span>
</span><span id="LagrangianHamiltonianConverter-111"><a href="#LagrangianHamiltonianConverter-111"><span class="linenos">111</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-112"><a href="#LagrangianHamiltonianConverter-112"><span class="linenos">112</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-113"><a href="#LagrangianHamiltonianConverter-113"><span class="linenos">113</span></a>
</span><span id="LagrangianHamiltonianConverter-114"><a href="#LagrangianHamiltonianConverter-114"><span class="linenos">114</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_compute_by_scipy</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-115"><a href="#LagrangianHamiltonianConverter-115"><span class="linenos">115</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">_HAS_SCIPY</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-116"><a href="#LagrangianHamiltonianConverter-116"><span class="linenos">116</span></a>                <span class="k">return</span> <span class="n">_compute_by_grid</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-117"><a href="#LagrangianHamiltonianConverter-117"><span class="linenos">117</span></a>
</span><span id="LagrangianHamiltonianConverter-118"><a href="#LagrangianHamiltonianConverter-118"><span class="linenos">118</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">negS</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-119"><a href="#LagrangianHamiltonianConverter-119"><span class="linenos">119</span></a>                <span class="n">p0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-120"><a href="#LagrangianHamiltonianConverter-120"><span class="linenos">120</span></a>                <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">p0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_func</span><span class="p">(</span><span class="n">p0</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter-121"><a href="#LagrangianHamiltonianConverter-121"><span class="linenos">121</span></a>
</span><span id="LagrangianHamiltonianConverter-122"><a href="#LagrangianHamiltonianConverter-122"><span class="linenos">122</span></a>            <span class="n">best_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">_math</span><span class="o">.</span><span class="n">inf</span>
</span><span id="LagrangianHamiltonianConverter-123"><a href="#LagrangianHamiltonianConverter-123"><span class="linenos">123</span></a>            <span class="n">best_p</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter-124"><a href="#LagrangianHamiltonianConverter-124"><span class="linenos">124</span></a>            <span class="n">inits</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">scipy_multistart</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter-125"><a href="#LagrangianHamiltonianConverter-125"><span class="linenos">125</span></a>            <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">inits</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-126"><a href="#LagrangianHamiltonianConverter-126"><span class="linenos">126</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-127"><a href="#LagrangianHamiltonianConverter-127"><span class="linenos">127</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">_optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">negS</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x0</span><span class="p">)],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-128"><a href="#LagrangianHamiltonianConverter-128"><span class="linenos">128</span></a>                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-129"><a href="#LagrangianHamiltonianConverter-129"><span class="linenos">129</span></a>                        <span class="n">pstar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-130"><a href="#LagrangianHamiltonianConverter-130"><span class="linenos">130</span></a>                        <span class="n">sval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">pstar</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_func</span><span class="p">(</span><span class="n">pstar</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter-131"><a href="#LagrangianHamiltonianConverter-131"><span class="linenos">131</span></a>                        <span class="k">if</span> <span class="n">sval</span> <span class="o">&gt;</span> <span class="n">best_val</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-132"><a href="#LagrangianHamiltonianConverter-132"><span class="linenos">132</span></a>                            <span class="n">best_val</span> <span class="o">=</span> <span class="n">sval</span>
</span><span id="LagrangianHamiltonianConverter-133"><a href="#LagrangianHamiltonianConverter-133"><span class="linenos">133</span></a>                            <span class="n">best_p</span> <span class="o">=</span> <span class="n">pstar</span>
</span><span id="LagrangianHamiltonianConverter-134"><a href="#LagrangianHamiltonianConverter-134"><span class="linenos">134</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-135"><a href="#LagrangianHamiltonianConverter-135"><span class="linenos">135</span></a>                    <span class="k">continue</span>
</span><span id="LagrangianHamiltonianConverter-136"><a href="#LagrangianHamiltonianConverter-136"><span class="linenos">136</span></a>            <span class="k">if</span> <span class="n">best_p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-137"><a href="#LagrangianHamiltonianConverter-137"><span class="linenos">137</span></a>                <span class="k">return</span> <span class="n">_compute_by_grid</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-138"><a href="#LagrangianHamiltonianConverter-138"><span class="linenos">138</span></a>            <span class="k">return</span> <span class="n">best_val</span><span class="p">,</span> <span class="n">best_p</span>
</span><span id="LagrangianHamiltonianConverter-139"><a href="#LagrangianHamiltonianConverter-139"><span class="linenos">139</span></a>
</span><span id="LagrangianHamiltonianConverter-140"><a href="#LagrangianHamiltonianConverter-140"><span class="linenos">140</span></a>        <span class="n">compute</span> <span class="o">=</span> <span class="n">_compute_by_scipy</span> <span class="k">if</span> <span class="p">(</span><span class="n">_HAS_SCIPY</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;grid&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">_compute_by_grid</span>
</span><span id="LagrangianHamiltonianConverter-141"><a href="#LagrangianHamiltonianConverter-141"><span class="linenos">141</span></a>
</span><span id="LagrangianHamiltonianConverter-142"><a href="#LagrangianHamiltonianConverter-142"><span class="linenos">142</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">H_numeric</span><span class="p">(</span><span class="n">xi_in</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-143"><a href="#LagrangianHamiltonianConverter-143"><span class="linenos">143</span></a>            <span class="n">xi_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xi_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-144"><a href="#LagrangianHamiltonianConverter-144"><span class="linenos">144</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">xi_arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-145"><a href="#LagrangianHamiltonianConverter-145"><span class="linenos">145</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xi_arr</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-146"><a href="#LagrangianHamiltonianConverter-146"><span class="linenos">146</span></a>                <span class="n">val</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-147"><a href="#LagrangianHamiltonianConverter-147"><span class="linenos">147</span></a>                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="LagrangianHamiltonianConverter-148"><a href="#LagrangianHamiltonianConverter-148"><span class="linenos">148</span></a>            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xi_in</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-149"><a href="#LagrangianHamiltonianConverter-149"><span class="linenos">149</span></a>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-150"><a href="#LagrangianHamiltonianConverter-150"><span class="linenos">150</span></a>            <span class="k">return</span> <span class="n">out</span>
</span><span id="LagrangianHamiltonianConverter-151"><a href="#LagrangianHamiltonianConverter-151"><span class="linenos">151</span></a>
</span><span id="LagrangianHamiltonianConverter-152"><a href="#LagrangianHamiltonianConverter-152"><span class="linenos">152</span></a>        <span class="k">return</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter-153"><a href="#LagrangianHamiltonianConverter-153"><span class="linenos">153</span></a>
</span><span id="LagrangianHamiltonianConverter-154"><a href="#LagrangianHamiltonianConverter-154"><span class="linenos">154</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter-155"><a href="#LagrangianHamiltonianConverter-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_legendre_fenchel_nd_numeric_callable</span><span class="p">(</span><span class="n">L_func</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">p_bounds</span><span class="p">,</span> <span class="n">n_grid_per_dim</span><span class="o">=</span><span class="mi">41</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter-156"><a href="#LagrangianHamiltonianConverter-156"><span class="linenos">156</span></a>                                              <span class="n">scipy_multistart</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">multistart_restarts</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-157"><a href="#LagrangianHamiltonianConverter-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-158"><a href="#LagrangianHamiltonianConverter-158"><span class="linenos">158</span></a><span class="sd">        Return callable H_numeric(xi_vector) approximating sup_p (xi·p - L(p)) for dim&gt;=2.</span>
</span><span id="LagrangianHamiltonianConverter-159"><a href="#LagrangianHamiltonianConverter-159"><span class="linenos">159</span></a><span class="sd">        - L_func: callable p_vector -&gt; L(p)</span>
</span><span id="LagrangianHamiltonianConverter-160"><a href="#LagrangianHamiltonianConverter-160"><span class="linenos">160</span></a><span class="sd">        - p_bounds: tuple/list of per-dimension bounds</span>
</span><span id="LagrangianHamiltonianConverter-161"><a href="#LagrangianHamiltonianConverter-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-162"><a href="#LagrangianHamiltonianConverter-162"><span class="linenos">162</span></a>        <span class="n">pmin_list</span><span class="p">,</span> <span class="n">pmax_list</span> <span class="o">=</span> <span class="n">p_bounds</span>
</span><span id="LagrangianHamiltonianConverter-163"><a href="#LagrangianHamiltonianConverter-163"><span class="linenos">163</span></a>        <span class="n">pmin</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pmin_list</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter-164"><a href="#LagrangianHamiltonianConverter-164"><span class="linenos">164</span></a>        <span class="n">pmax</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pmax_list</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter-165"><a href="#LagrangianHamiltonianConverter-165"><span class="linenos">165</span></a>
</span><span id="LagrangianHamiltonianConverter-166"><a href="#LagrangianHamiltonianConverter-166"><span class="linenos">166</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">compute_by_grid</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-167"><a href="#LagrangianHamiltonianConverter-167"><span class="linenos">167</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
</span><span id="LagrangianHamiltonianConverter-168"><a href="#LagrangianHamiltonianConverter-168"><span class="linenos">168</span></a>            <span class="n">grids</span> <span class="o">=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pmin</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">pmax</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_grid_per_dim</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter-169"><a href="#LagrangianHamiltonianConverter-169"><span class="linenos">169</span></a>            <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="n">_math</span><span class="o">.</span><span class="n">inf</span>
</span><span id="LagrangianHamiltonianConverter-170"><a href="#LagrangianHamiltonianConverter-170"><span class="linenos">170</span></a>            <span class="n">best_p</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter-171"><a href="#LagrangianHamiltonianConverter-171"><span class="linenos">171</span></a>            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">grids</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-172"><a href="#LagrangianHamiltonianConverter-172"><span class="linenos">172</span></a>                <span class="n">pt_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-173"><a href="#LagrangianHamiltonianConverter-173"><span class="linenos">173</span></a>                <span class="n">sval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">,</span> <span class="n">pt_arr</span><span class="p">)</span> <span class="o">-</span> <span class="n">L_func</span><span class="p">(</span><span class="n">pt_arr</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-174"><a href="#LagrangianHamiltonianConverter-174"><span class="linenos">174</span></a>                <span class="k">if</span> <span class="n">sval</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-175"><a href="#LagrangianHamiltonianConverter-175"><span class="linenos">175</span></a>                    <span class="n">best</span> <span class="o">=</span> <span class="n">sval</span>
</span><span id="LagrangianHamiltonianConverter-176"><a href="#LagrangianHamiltonianConverter-176"><span class="linenos">176</span></a>                    <span class="n">best_p</span> <span class="o">=</span> <span class="n">pt_arr</span>
</span><span id="LagrangianHamiltonianConverter-177"><a href="#LagrangianHamiltonianConverter-177"><span class="linenos">177</span></a>            <span class="k">return</span> <span class="n">best</span><span class="p">,</span> <span class="n">best_p</span>
</span><span id="LagrangianHamiltonianConverter-178"><a href="#LagrangianHamiltonianConverter-178"><span class="linenos">178</span></a>
</span><span id="LagrangianHamiltonianConverter-179"><a href="#LagrangianHamiltonianConverter-179"><span class="linenos">179</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">compute_by_scipy</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-180"><a href="#LagrangianHamiltonianConverter-180"><span class="linenos">180</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">_HAS_SCIPY</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-181"><a href="#LagrangianHamiltonianConverter-181"><span class="linenos">181</span></a>                <span class="k">return</span> <span class="n">compute_by_grid</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-182"><a href="#LagrangianHamiltonianConverter-182"><span class="linenos">182</span></a>
</span><span id="LagrangianHamiltonianConverter-183"><a href="#LagrangianHamiltonianConverter-183"><span class="linenos">183</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">negS</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-184"><a href="#LagrangianHamiltonianConverter-184"><span class="linenos">184</span></a>                <span class="n">p</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-185"><a href="#LagrangianHamiltonianConverter-185"><span class="linenos">185</span></a>                <span class="k">return</span> <span class="o">-</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_func</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter-186"><a href="#LagrangianHamiltonianConverter-186"><span class="linenos">186</span></a>
</span><span id="LagrangianHamiltonianConverter-187"><a href="#LagrangianHamiltonianConverter-187"><span class="linenos">187</span></a>            <span class="n">best_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">_math</span><span class="o">.</span><span class="n">inf</span>
</span><span id="LagrangianHamiltonianConverter-188"><a href="#LagrangianHamiltonianConverter-188"><span class="linenos">188</span></a>            <span class="n">best_p</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter-189"><a href="#LagrangianHamiltonianConverter-189"><span class="linenos">189</span></a>            <span class="n">center</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">pmin</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">pmax</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-190"><a href="#LagrangianHamiltonianConverter-190"><span class="linenos">190</span></a>            <span class="n">rng</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-191"><a href="#LagrangianHamiltonianConverter-191"><span class="linenos">191</span></a>            <span class="n">inits</span> <span class="o">=</span> <span class="p">[</span><span class="n">center</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter-192"><a href="#LagrangianHamiltonianConverter-192"><span class="linenos">192</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">multistart_restarts</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-193"><a href="#LagrangianHamiltonianConverter-193"><span class="linenos">193</span></a>                <span class="n">r</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-194"><a href="#LagrangianHamiltonianConverter-194"><span class="linenos">194</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pmin</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pmax</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmin</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-195"><a href="#LagrangianHamiltonianConverter-195"><span class="linenos">195</span></a>                <span class="n">inits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-196"><a href="#LagrangianHamiltonianConverter-196"><span class="linenos">196</span></a>            <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">inits</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-197"><a href="#LagrangianHamiltonianConverter-197"><span class="linenos">197</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-198"><a href="#LagrangianHamiltonianConverter-198"><span class="linenos">198</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">_optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">negS</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="nb">tuple</span><span class="p">((</span><span class="n">pmin</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">pmax</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)),</span>
</span><span id="LagrangianHamiltonianConverter-199"><a href="#LagrangianHamiltonianConverter-199"><span class="linenos">199</span></a>                                             <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-200"><a href="#LagrangianHamiltonianConverter-200"><span class="linenos">200</span></a>                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-201"><a href="#LagrangianHamiltonianConverter-201"><span class="linenos">201</span></a>                        <span class="n">pstar</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-202"><a href="#LagrangianHamiltonianConverter-202"><span class="linenos">202</span></a>                        <span class="n">sval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">,</span> <span class="n">pstar</span><span class="p">)</span> <span class="o">-</span> <span class="n">L_func</span><span class="p">(</span><span class="n">pstar</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-203"><a href="#LagrangianHamiltonianConverter-203"><span class="linenos">203</span></a>                        <span class="k">if</span> <span class="n">sval</span> <span class="o">&gt;</span> <span class="n">best_val</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-204"><a href="#LagrangianHamiltonianConverter-204"><span class="linenos">204</span></a>                            <span class="n">best_val</span> <span class="o">=</span> <span class="n">sval</span>
</span><span id="LagrangianHamiltonianConverter-205"><a href="#LagrangianHamiltonianConverter-205"><span class="linenos">205</span></a>                            <span class="n">best_p</span> <span class="o">=</span> <span class="n">pstar</span>
</span><span id="LagrangianHamiltonianConverter-206"><a href="#LagrangianHamiltonianConverter-206"><span class="linenos">206</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-207"><a href="#LagrangianHamiltonianConverter-207"><span class="linenos">207</span></a>                    <span class="k">continue</span>
</span><span id="LagrangianHamiltonianConverter-208"><a href="#LagrangianHamiltonianConverter-208"><span class="linenos">208</span></a>            <span class="k">if</span> <span class="n">best_p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-209"><a href="#LagrangianHamiltonianConverter-209"><span class="linenos">209</span></a>                <span class="k">return</span> <span class="n">compute_by_grid</span><span class="p">(</span><span class="n">xi_vec</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-210"><a href="#LagrangianHamiltonianConverter-210"><span class="linenos">210</span></a>            <span class="k">return</span> <span class="n">best_val</span><span class="p">,</span> <span class="n">best_p</span>
</span><span id="LagrangianHamiltonianConverter-211"><a href="#LagrangianHamiltonianConverter-211"><span class="linenos">211</span></a>
</span><span id="LagrangianHamiltonianConverter-212"><a href="#LagrangianHamiltonianConverter-212"><span class="linenos">212</span></a>        <span class="n">compute</span> <span class="o">=</span> <span class="n">compute_by_scipy</span> <span class="k">if</span> <span class="p">(</span><span class="n">_HAS_SCIPY</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;grid&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">compute_by_grid</span>
</span><span id="LagrangianHamiltonianConverter-213"><a href="#LagrangianHamiltonianConverter-213"><span class="linenos">213</span></a>
</span><span id="LagrangianHamiltonianConverter-214"><a href="#LagrangianHamiltonianConverter-214"><span class="linenos">214</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">H_numeric</span><span class="p">(</span><span class="n">xi_in</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-215"><a href="#LagrangianHamiltonianConverter-215"><span class="linenos">215</span></a>            <span class="n">xi_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">xi_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-216"><a href="#LagrangianHamiltonianConverter-216"><span class="linenos">216</span></a>            <span class="k">if</span> <span class="n">xi_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dim</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-217"><a href="#LagrangianHamiltonianConverter-217"><span class="linenos">217</span></a>                <span class="n">xi_arr</span> <span class="o">=</span> <span class="n">xi_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-218"><a href="#LagrangianHamiltonianConverter-218"><span class="linenos">218</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xi_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-219"><a href="#LagrangianHamiltonianConverter-219"><span class="linenos">219</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xivec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xi_arr</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-220"><a href="#LagrangianHamiltonianConverter-220"><span class="linenos">220</span></a>                <span class="n">val</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">xivec</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-221"><a href="#LagrangianHamiltonianConverter-221"><span class="linenos">221</span></a>                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="LagrangianHamiltonianConverter-222"><a href="#LagrangianHamiltonianConverter-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-223"><a href="#LagrangianHamiltonianConverter-223"><span class="linenos">223</span></a>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-224"><a href="#LagrangianHamiltonianConverter-224"><span class="linenos">224</span></a>            <span class="k">return</span> <span class="n">out</span>
</span><span id="LagrangianHamiltonianConverter-225"><a href="#LagrangianHamiltonianConverter-225"><span class="linenos">225</span></a>
</span><span id="LagrangianHamiltonianConverter-226"><a href="#LagrangianHamiltonianConverter-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter-227"><a href="#LagrangianHamiltonianConverter-227"><span class="linenos">227</span></a>
</span><span id="LagrangianHamiltonianConverter-228"><a href="#LagrangianHamiltonianConverter-228"><span class="linenos">228</span></a>    <span class="c1"># ----------------------------</span>
</span><span id="LagrangianHamiltonianConverter-229"><a href="#LagrangianHamiltonianConverter-229"><span class="linenos">229</span></a>    <span class="c1"># Main methods</span>
</span><span id="LagrangianHamiltonianConverter-230"><a href="#LagrangianHamiltonianConverter-230"><span class="linenos">230</span></a>    <span class="c1"># ----------------------------</span>
</span><span id="LagrangianHamiltonianConverter-231"><a href="#LagrangianHamiltonianConverter-231"><span class="linenos">231</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter-232"><a href="#LagrangianHamiltonianConverter-232"><span class="linenos">232</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">L_to_H</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="n">return_symbol_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter-233"><a href="#LagrangianHamiltonianConverter-233"><span class="linenos">233</span></a>               <span class="n">method</span><span class="o">=</span><span class="s2">&quot;legendre&quot;</span><span class="p">,</span> <span class="n">fenchel_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-234"><a href="#LagrangianHamiltonianConverter-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-235"><a href="#LagrangianHamiltonianConverter-235"><span class="linenos">235</span></a><span class="sd">        Convert L(x,u,p) -&gt; H(x,u,xi) with options for generalized Legendre (Fenchel).</span>
</span><span id="LagrangianHamiltonianConverter-236"><a href="#LagrangianHamiltonianConverter-236"><span class="linenos">236</span></a>
</span><span id="LagrangianHamiltonianConverter-237"><a href="#LagrangianHamiltonianConverter-237"><span class="linenos">237</span></a><span class="sd">        Parameters:</span>
</span><span id="LagrangianHamiltonianConverter-238"><a href="#LagrangianHamiltonianConverter-238"><span class="linenos">238</span></a><span class="sd">          - method: &quot;legendre&quot; (default), &quot;fenchel_symbolic&quot;, &quot;fenchel_numeric&quot;</span>
</span><span id="LagrangianHamiltonianConverter-239"><a href="#LagrangianHamiltonianConverter-239"><span class="linenos">239</span></a><span class="sd">          - fenchel_opts: dict with options for numeric fenchel</span>
</span><span id="LagrangianHamiltonianConverter-240"><a href="#LagrangianHamiltonianConverter-240"><span class="linenos">240</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-241"><a href="#LagrangianHamiltonianConverter-241"><span class="linenos">241</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-242"><a href="#LagrangianHamiltonianConverter-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-243"><a href="#LagrangianHamiltonianConverter-243"><span class="linenos">243</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
</span><span id="LagrangianHamiltonianConverter-244"><a href="#LagrangianHamiltonianConverter-244"><span class="linenos">244</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-245"><a href="#LagrangianHamiltonianConverter-245"><span class="linenos">245</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-246"><a href="#LagrangianHamiltonianConverter-246"><span class="linenos">246</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-247"><a href="#LagrangianHamiltonianConverter-247"><span class="linenos">247</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D dimensions are supported.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-248"><a href="#LagrangianHamiltonianConverter-248"><span class="linenos">248</span></a>
</span><span id="LagrangianHamiltonianConverter-249"><a href="#LagrangianHamiltonianConverter-249"><span class="linenos">249</span></a>        <span class="c1"># Quadratic fast-path (symbolic)</span>
</span><span id="LagrangianHamiltonianConverter-250"><a href="#LagrangianHamiltonianConverter-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;legendre&quot;</span><span class="p">,</span> <span class="s2">&quot;fenchel_symbolic&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_is_quadratic_in_p</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-251"><a href="#LagrangianHamiltonianConverter-251"><span class="linenos">251</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-252"><a href="#LagrangianHamiltonianConverter-252"><span class="linenos">252</span></a>                <span class="n">H_expr</span><span class="p">,</span> <span class="n">sol</span> <span class="o">=</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_quadratic_legendre</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-253"><a href="#LagrangianHamiltonianConverter-253"><span class="linenos">253</span></a>                <span class="k">if</span> <span class="n">return_symbol_only</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-254"><a href="#LagrangianHamiltonianConverter-254"><span class="linenos">254</span></a>                    <span class="n">H_expr</span> <span class="o">=</span> <span class="n">H_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-255"><a href="#LagrangianHamiltonianConverter-255"><span class="linenos">255</span></a>                <span class="k">return</span> <span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span>
</span><span id="LagrangianHamiltonianConverter-256"><a href="#LagrangianHamiltonianConverter-256"><span class="linenos">256</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-257"><a href="#LagrangianHamiltonianConverter-257"><span class="linenos">257</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;legendre&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-258"><a href="#LagrangianHamiltonianConverter-258"><span class="linenos">258</span></a>                    <span class="k">raise</span>
</span><span id="LagrangianHamiltonianConverter-259"><a href="#LagrangianHamiltonianConverter-259"><span class="linenos">259</span></a>
</span><span id="LagrangianHamiltonianConverter-260"><a href="#LagrangianHamiltonianConverter-260"><span class="linenos">260</span></a>        <span class="c1"># CLASSICAL LEGENDRE</span>
</span><span id="LagrangianHamiltonianConverter-261"><a href="#LagrangianHamiltonianConverter-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;legendre&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-262"><a href="#LagrangianHamiltonianConverter-262"><span class="linenos">262</span></a>            <span class="n">H_p</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter-263"><a href="#LagrangianHamiltonianConverter-263"><span class="linenos">263</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-264"><a href="#LagrangianHamiltonianConverter-264"><span class="linenos">264</span></a>                <span class="n">H_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-265"><a href="#LagrangianHamiltonianConverter-265"><span class="linenos">265</span></a>                <span class="n">det_H</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">H_p</span><span class="o">.</span><span class="n">det</span><span class="p">())</span>
</span><span id="LagrangianHamiltonianConverter-266"><a href="#LagrangianHamiltonianConverter-266"><span class="linenos">266</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-267"><a href="#LagrangianHamiltonianConverter-267"><span class="linenos">267</span></a>                <span class="n">det_H</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter-268"><a href="#LagrangianHamiltonianConverter-268"><span class="linenos">268</span></a>
</span><span id="LagrangianHamiltonianConverter-269"><a href="#LagrangianHamiltonianConverter-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="n">det_H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">det_H</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-270"><a href="#LagrangianHamiltonianConverter-270"><span class="linenos">270</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Legendre transform not invertible: Hessian singular. Use force=True or Fenchel method.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-271"><a href="#LagrangianHamiltonianConverter-271"><span class="linenos">271</span></a>            <span class="k">if</span> <span class="n">det_H</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-272"><a href="#LagrangianHamiltonianConverter-272"><span class="linenos">272</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to verify Hessian determinant symbolically. Use force=True to attempt solve().&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-273"><a href="#LagrangianHamiltonianConverter-273"><span class="linenos">273</span></a>
</span><span id="LagrangianHamiltonianConverter-274"><a href="#LagrangianHamiltonianConverter-274"><span class="linenos">274</span></a>            <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter-275"><a href="#LagrangianHamiltonianConverter-275"><span class="linenos">275</span></a>            <span class="n">sol_list</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-276"><a href="#LagrangianHamiltonianConverter-276"><span class="linenos">276</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-277"><a href="#LagrangianHamiltonianConverter-277"><span class="linenos">277</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-278"><a href="#LagrangianHamiltonianConverter-278"><span class="linenos">278</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to solve symbolic Legendre relations. Use force=True or Fenchel fallback.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-279"><a href="#LagrangianHamiltonianConverter-279"><span class="linenos">279</span></a>            <span class="k">if</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-280"><a href="#LagrangianHamiltonianConverter-280"><span class="linenos">280</span></a>                <span class="n">sol</span> <span class="o">=</span> <span class="n">sol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter-281"><a href="#LagrangianHamiltonianConverter-281"><span class="linenos">281</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-282"><a href="#LagrangianHamiltonianConverter-282"><span class="linenos">282</span></a>                    <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter-283"><a href="#LagrangianHamiltonianConverter-283"><span class="linenos">283</span></a>                <span class="n">H_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sol</span><span class="p">[</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-284"><a href="#LagrangianHamiltonianConverter-284"><span class="linenos">284</span></a>                <span class="n">H_expr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">H_expr</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-285"><a href="#LagrangianHamiltonianConverter-285"><span class="linenos">285</span></a>                <span class="k">if</span> <span class="n">return_symbol_only</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-286"><a href="#LagrangianHamiltonianConverter-286"><span class="linenos">286</span></a>                    <span class="n">H_expr</span> <span class="o">=</span> <span class="n">H_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-287"><a href="#LagrangianHamiltonianConverter-287"><span class="linenos">287</span></a>                <span class="k">return</span> <span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span>
</span><span id="LagrangianHamiltonianConverter-288"><a href="#LagrangianHamiltonianConverter-288"><span class="linenos">288</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Legendre inversion failed even with solve().&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-289"><a href="#LagrangianHamiltonianConverter-289"><span class="linenos">289</span></a>
</span><span id="LagrangianHamiltonianConverter-290"><a href="#LagrangianHamiltonianConverter-290"><span class="linenos">290</span></a>        <span class="c1"># FENCHEL: symbolic attempt</span>
</span><span id="LagrangianHamiltonianConverter-291"><a href="#LagrangianHamiltonianConverter-291"><span class="linenos">291</span></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="LagrangianHamiltonianConverter-292"><a href="#LagrangianHamiltonianConverter-292"><span class="linenos">292</span></a>        <span class="c1">#  Prevent symbolic Fenchel when L is non-differentiable</span>
</span><span id="LagrangianHamiltonianConverter-293"><a href="#LagrangianHamiltonianConverter-293"><span class="linenos">293</span></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="LagrangianHamiltonianConverter-294"><a href="#LagrangianHamiltonianConverter-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fenchel_symbolic&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-295"><a href="#LagrangianHamiltonianConverter-295"><span class="linenos">295</span></a>            <span class="k">if</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter-296"><a href="#LagrangianHamiltonianConverter-296"><span class="linenos">296</span></a>                <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_vars</span>
</span><span id="LagrangianHamiltonianConverter-297"><a href="#LagrangianHamiltonianConverter-297"><span class="linenos">297</span></a>            <span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-298"><a href="#LagrangianHamiltonianConverter-298"><span class="linenos">298</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter-299"><a href="#LagrangianHamiltonianConverter-299"><span class="linenos">299</span></a>                    <span class="s2">&quot;Symbolic Fenchel not possible for nonsmooth L (Abs, sign). &quot;</span>
</span><span id="LagrangianHamiltonianConverter-300"><a href="#LagrangianHamiltonianConverter-300"><span class="linenos">300</span></a>                    <span class="s2">&quot;Use method=&#39;fenchel_numeric&#39; instead.&quot;</span>
</span><span id="LagrangianHamiltonianConverter-301"><a href="#LagrangianHamiltonianConverter-301"><span class="linenos">301</span></a>                <span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-302"><a href="#LagrangianHamiltonianConverter-302"><span class="linenos">302</span></a>
</span><span id="LagrangianHamiltonianConverter-303"><a href="#LagrangianHamiltonianConverter-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fenchel_symbolic&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-304"><a href="#LagrangianHamiltonianConverter-304"><span class="linenos">304</span></a>            <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter-305"><a href="#LagrangianHamiltonianConverter-305"><span class="linenos">305</span></a>            <span class="n">sol_list</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-306"><a href="#LagrangianHamiltonianConverter-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-307"><a href="#LagrangianHamiltonianConverter-307"><span class="linenos">307</span></a>                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LagrangianHamiltonianConverter-308"><a href="#LagrangianHamiltonianConverter-308"><span class="linenos">308</span></a>                <span class="k">for</span> <span class="n">sol</span> <span class="ow">in</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-309"><a href="#LagrangianHamiltonianConverter-309"><span class="linenos">309</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-310"><a href="#LagrangianHamiltonianConverter-310"><span class="linenos">310</span></a>                        <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter-311"><a href="#LagrangianHamiltonianConverter-311"><span class="linenos">311</span></a>                    <span class="n">S_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sol</span><span class="p">[</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-312"><a href="#LagrangianHamiltonianConverter-312"><span class="linenos">312</span></a>                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">S_expr</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-313"><a href="#LagrangianHamiltonianConverter-313"><span class="linenos">313</span></a>                <span class="n">H_candidates</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="o">*</span><span class="n">candidates</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter-314"><a href="#LagrangianHamiltonianConverter-314"><span class="linenos">314</span></a>                <span class="k">if</span> <span class="n">return_symbol_only</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-315"><a href="#LagrangianHamiltonianConverter-315"><span class="linenos">315</span></a>                    <span class="n">H_candidates</span> <span class="o">=</span> <span class="n">H_candidates</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-316"><a href="#LagrangianHamiltonianConverter-316"><span class="linenos">316</span></a>                <span class="k">return</span> <span class="n">H_candidates</span><span class="p">,</span> <span class="n">xi_vars</span>
</span><span id="LagrangianHamiltonianConverter-317"><a href="#LagrangianHamiltonianConverter-317"><span class="linenos">317</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symbolic Fenchel conjugate not found; use method=&#39;fenchel_numeric&#39; for numeric computation.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-318"><a href="#LagrangianHamiltonianConverter-318"><span class="linenos">318</span></a>
</span><span id="LagrangianHamiltonianConverter-319"><a href="#LagrangianHamiltonianConverter-319"><span class="linenos">319</span></a>        <span class="c1"># FENCHEL: numeric path</span>
</span><span id="LagrangianHamiltonianConverter-320"><a href="#LagrangianHamiltonianConverter-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fenchel_numeric&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-321"><a href="#LagrangianHamiltonianConverter-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="n">fenchel_opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-322"><a href="#LagrangianHamiltonianConverter-322"><span class="linenos">322</span></a>                <span class="n">fenchel_opts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LagrangianHamiltonianConverter-323"><a href="#LagrangianHamiltonianConverter-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-324"><a href="#LagrangianHamiltonianConverter-324"><span class="linenos">324</span></a>                <span class="n">p_bounds</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_bounds&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-325"><a href="#LagrangianHamiltonianConverter-325"><span class="linenos">325</span></a>                <span class="n">n_grid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_grid&quot;</span><span class="p">,</span> <span class="mi">2001</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-326"><a href="#LagrangianHamiltonianConverter-326"><span class="linenos">326</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-327"><a href="#LagrangianHamiltonianConverter-327"><span class="linenos">327</span></a>                <span class="n">scipy_multistart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scipy_multistart&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-328"><a href="#LagrangianHamiltonianConverter-328"><span class="linenos">328</span></a>
</span><span id="LagrangianHamiltonianConverter-329"><a href="#LagrangianHamiltonianConverter-329"><span class="linenos">329</span></a>                <span class="c1"># Build numeric L_func (try lambdify)</span>
</span><span id="LagrangianHamiltonianConverter-330"><a href="#LagrangianHamiltonianConverter-330"><span class="linenos">330</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-331"><a href="#LagrangianHamiltonianConverter-331"><span class="linenos">331</span></a>                    <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-332"><a href="#LagrangianHamiltonianConverter-332"><span class="linenos">332</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">L_func_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-333"><a href="#LagrangianHamiltonianConverter-333"><span class="linenos">333</span></a>                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-334"><a href="#LagrangianHamiltonianConverter-334"><span class="linenos">334</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-335"><a href="#LagrangianHamiltonianConverter-335"><span class="linenos">335</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-336"><a href="#LagrangianHamiltonianConverter-336"><span class="linenos">336</span></a>                        <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-337"><a href="#LagrangianHamiltonianConverter-337"><span class="linenos">337</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-338"><a href="#LagrangianHamiltonianConverter-338"><span class="linenos">338</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-339"><a href="#LagrangianHamiltonianConverter-339"><span class="linenos">339</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-340"><a href="#LagrangianHamiltonianConverter-340"><span class="linenos">340</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-341"><a href="#LagrangianHamiltonianConverter-341"><span class="linenos">341</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">N</span><span class="p">(</span><span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">p</span><span class="p">})))</span>
</span><span id="LagrangianHamiltonianConverter-342"><a href="#LagrangianHamiltonianConverter-342"><span class="linenos">342</span></a>
</span><span id="LagrangianHamiltonianConverter-343"><a href="#LagrangianHamiltonianConverter-343"><span class="linenos">343</span></a>                <span class="n">H_numeric</span> <span class="o">=</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_legendre_fenchel_1d_numeric_callable</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter-344"><a href="#LagrangianHamiltonianConverter-344"><span class="linenos">344</span></a>                    <span class="n">L_func_scalar</span><span class="p">,</span> <span class="n">p_bounds</span><span class="o">=</span><span class="n">p_bounds</span><span class="p">,</span> <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter-345"><a href="#LagrangianHamiltonianConverter-345"><span class="linenos">345</span></a>                    <span class="n">scipy_multistart</span><span class="o">=</span><span class="n">scipy_multistart</span>
</span><span id="LagrangianHamiltonianConverter-346"><a href="#LagrangianHamiltonianConverter-346"><span class="linenos">346</span></a>                <span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-347"><a href="#LagrangianHamiltonianConverter-347"><span class="linenos">347</span></a>                <span class="n">H_func</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;H_numeric&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-348"><a href="#LagrangianHamiltonianConverter-348"><span class="linenos">348</span></a>                <span class="n">H_repr</span> <span class="o">=</span> <span class="n">H_func</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter-349"><a href="#LagrangianHamiltonianConverter-349"><span class="linenos">349</span></a>                <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_numeric_cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">H_repr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter-350"><a href="#LagrangianHamiltonianConverter-350"><span class="linenos">350</span></a>                <span class="k">return</span> <span class="n">H_repr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter-351"><a href="#LagrangianHamiltonianConverter-351"><span class="linenos">351</span></a>
</span><span id="LagrangianHamiltonianConverter-352"><a href="#LagrangianHamiltonianConverter-352"><span class="linenos">352</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-353"><a href="#LagrangianHamiltonianConverter-353"><span class="linenos">353</span></a>                <span class="c1"># dim == 2</span>
</span><span id="LagrangianHamiltonianConverter-354"><a href="#LagrangianHamiltonianConverter-354"><span class="linenos">354</span></a>                <span class="n">p_bounds</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_bounds&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)])</span>
</span><span id="LagrangianHamiltonianConverter-355"><a href="#LagrangianHamiltonianConverter-355"><span class="linenos">355</span></a>                <span class="n">n_grid_per_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_grid_per_dim&quot;</span><span class="p">,</span> <span class="mi">41</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-356"><a href="#LagrangianHamiltonianConverter-356"><span class="linenos">356</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-357"><a href="#LagrangianHamiltonianConverter-357"><span class="linenos">357</span></a>                <span class="n">scipy_multistart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scipy_multistart&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-358"><a href="#LagrangianHamiltonianConverter-358"><span class="linenos">358</span></a>                <span class="n">multistart_restarts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multistart_restarts&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-359"><a href="#LagrangianHamiltonianConverter-359"><span class="linenos">359</span></a>
</span><span id="LagrangianHamiltonianConverter-360"><a href="#LagrangianHamiltonianConverter-360"><span class="linenos">360</span></a>                <span class="n">f_lamb</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter-361"><a href="#LagrangianHamiltonianConverter-361"><span class="linenos">361</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-362"><a href="#LagrangianHamiltonianConverter-362"><span class="linenos">362</span></a>                    <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-363"><a href="#LagrangianHamiltonianConverter-363"><span class="linenos">363</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">L_func_nd</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-364"><a href="#LagrangianHamiltonianConverter-364"><span class="linenos">364</span></a>                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="LagrangianHamiltonianConverter-365"><a href="#LagrangianHamiltonianConverter-365"><span class="linenos">365</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-366"><a href="#LagrangianHamiltonianConverter-366"><span class="linenos">366</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-367"><a href="#LagrangianHamiltonianConverter-367"><span class="linenos">367</span></a>                        <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">p_vars</span><span class="p">,),</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-368"><a href="#LagrangianHamiltonianConverter-368"><span class="linenos">368</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_nd</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-369"><a href="#LagrangianHamiltonianConverter-369"><span class="linenos">369</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter-370"><a href="#LagrangianHamiltonianConverter-370"><span class="linenos">370</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-371"><a href="#LagrangianHamiltonianConverter-371"><span class="linenos">371</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_nd</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-372"><a href="#LagrangianHamiltonianConverter-372"><span class="linenos">372</span></a>                            <span class="n">subs_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>
</span><span id="LagrangianHamiltonianConverter-373"><a href="#LagrangianHamiltonianConverter-373"><span class="linenos">373</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">N</span><span class="p">(</span><span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">subs_map</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter-374"><a href="#LagrangianHamiltonianConverter-374"><span class="linenos">374</span></a>
</span><span id="LagrangianHamiltonianConverter-375"><a href="#LagrangianHamiltonianConverter-375"><span class="linenos">375</span></a>                <span class="n">H_numeric</span> <span class="o">=</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_legendre_fenchel_nd_numeric_callable</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter-376"><a href="#LagrangianHamiltonianConverter-376"><span class="linenos">376</span></a>                    <span class="n">L_func_nd</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_bounds</span><span class="o">=</span><span class="p">(</span><span class="n">p_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="LagrangianHamiltonianConverter-377"><a href="#LagrangianHamiltonianConverter-377"><span class="linenos">377</span></a>                    <span class="n">n_grid_per_dim</span><span class="o">=</span><span class="n">n_grid_per_dim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter-378"><a href="#LagrangianHamiltonianConverter-378"><span class="linenos">378</span></a>                    <span class="n">scipy_multistart</span><span class="o">=</span><span class="n">scipy_multistart</span><span class="p">,</span> <span class="n">multistart_restarts</span><span class="o">=</span><span class="n">multistart_restarts</span>
</span><span id="LagrangianHamiltonianConverter-379"><a href="#LagrangianHamiltonianConverter-379"><span class="linenos">379</span></a>                <span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-380"><a href="#LagrangianHamiltonianConverter-380"><span class="linenos">380</span></a>                <span class="n">H_func</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;H_numeric&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-381"><a href="#LagrangianHamiltonianConverter-381"><span class="linenos">381</span></a>                <span class="n">H_repr</span> <span class="o">=</span> <span class="n">H_func</span><span class="p">(</span><span class="o">*</span><span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-382"><a href="#LagrangianHamiltonianConverter-382"><span class="linenos">382</span></a>                <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_numeric_cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">H_repr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter-383"><a href="#LagrangianHamiltonianConverter-383"><span class="linenos">383</span></a>                <span class="k">return</span> <span class="n">H_repr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter-384"><a href="#LagrangianHamiltonianConverter-384"><span class="linenos">384</span></a>
</span><span id="LagrangianHamiltonianConverter-385"><a href="#LagrangianHamiltonianConverter-385"><span class="linenos">385</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown method &#39;</span><span class="si">{}</span><span class="s2">&#39;. Choose &#39;legendre&#39;, &#39;fenchel_symbolic&#39; or &#39;fenchel_numeric&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-386"><a href="#LagrangianHamiltonianConverter-386"><span class="linenos">386</span></a>
</span><span id="LagrangianHamiltonianConverter-387"><a href="#LagrangianHamiltonianConverter-387"><span class="linenos">387</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter-388"><a href="#LagrangianHamiltonianConverter-388"><span class="linenos">388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">H_to_L</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-389"><a href="#LagrangianHamiltonianConverter-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-390"><a href="#LagrangianHamiltonianConverter-390"><span class="linenos">390</span></a><span class="sd">        Inverse Legendre (classical). Does not attempt Fenchel inverse.</span>
</span><span id="LagrangianHamiltonianConverter-391"><a href="#LagrangianHamiltonianConverter-391"><span class="linenos">391</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter-392"><a href="#LagrangianHamiltonianConverter-392"><span class="linenos">392</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-393"><a href="#LagrangianHamiltonianConverter-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-394"><a href="#LagrangianHamiltonianConverter-394"><span class="linenos">394</span></a>            <span class="n">p_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
</span><span id="LagrangianHamiltonianConverter-395"><a href="#LagrangianHamiltonianConverter-395"><span class="linenos">395</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-396"><a href="#LagrangianHamiltonianConverter-396"><span class="linenos">396</span></a>            <span class="n">p_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p_x&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p_y&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter-397"><a href="#LagrangianHamiltonianConverter-397"><span class="linenos">397</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-398"><a href="#LagrangianHamiltonianConverter-398"><span class="linenos">398</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D are supported.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-399"><a href="#LagrangianHamiltonianConverter-399"><span class="linenos">399</span></a>
</span><span id="LagrangianHamiltonianConverter-400"><a href="#LagrangianHamiltonianConverter-400"><span class="linenos">400</span></a>        <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter-401"><a href="#LagrangianHamiltonianConverter-401"><span class="linenos">401</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-402"><a href="#LagrangianHamiltonianConverter-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-403"><a href="#LagrangianHamiltonianConverter-403"><span class="linenos">403</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-404"><a href="#LagrangianHamiltonianConverter-404"><span class="linenos">404</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to symbolically solve p = ∂H/∂ξ for ξ. Use force=True.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-405"><a href="#LagrangianHamiltonianConverter-405"><span class="linenos">405</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-406"><a href="#LagrangianHamiltonianConverter-406"><span class="linenos">406</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-407"><a href="#LagrangianHamiltonianConverter-407"><span class="linenos">407</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inverse Legendre transform failed; cannot find ξ(p).&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-408"><a href="#LagrangianHamiltonianConverter-408"><span class="linenos">408</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">sol</span>
</span><span id="LagrangianHamiltonianConverter-409"><a href="#LagrangianHamiltonianConverter-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-410"><a href="#LagrangianHamiltonianConverter-410"><span class="linenos">410</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter-411"><a href="#LagrangianHamiltonianConverter-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-412"><a href="#LagrangianHamiltonianConverter-412"><span class="linenos">412</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sol</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter-413"><a href="#LagrangianHamiltonianConverter-413"><span class="linenos">413</span></a>                <span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter-414"><a href="#LagrangianHamiltonianConverter-414"><span class="linenos">414</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter-415"><a href="#LagrangianHamiltonianConverter-415"><span class="linenos">415</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected output from solve(); cannot construct ξ(p).&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-416"><a href="#LagrangianHamiltonianConverter-416"><span class="linenos">416</span></a>        <span class="n">L_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="n">H_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter-417"><a href="#LagrangianHamiltonianConverter-417"><span class="linenos">417</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">L_expr</span><span class="p">),</span> <span class="n">p_vars</span>
</span></pre></div>


            <div class="docstring"><p>Bidirectional converter between Lagrangian and Hamiltonian (Legendre transform),
with optional Legendre–Fenchel (convex conjugate) support and robust numeric fallback.</p>

<p>Main API:
  L_to_H(L_expr, coords, u, p_vars, return_symbol_only=False, force=False,
         method="legendre", fenchel_opts=None)</p>

<pre><code>- method: "legendre" (default), "fenchel_symbolic", "fenchel_numeric"
- If method == "fenchel_numeric" returns (H_repr, xi_vars, numeric_callable)
  otherwise returns (H_expr, xi_vars)
</code></pre>
</div>


                            <div id="LagrangianHamiltonianConverter.L_to_H" class="classattr">
                                        <input id="LagrangianHamiltonianConverter.L_to_H-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">L_to_H</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">L_expr</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">u</span>,</span><span class="param">	<span class="n">p_vars</span>,</span><span class="param">	<span class="n">return_symbol_only</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">force</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">method</span><span class="o">=</span><span class="s1">&#39;legendre&#39;</span>,</span><span class="param">	<span class="n">fenchel_opts</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LagrangianHamiltonianConverter.L_to_H-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LagrangianHamiltonianConverter.L_to_H"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LagrangianHamiltonianConverter.L_to_H-231"><a href="#LagrangianHamiltonianConverter.L_to_H-231"><span class="linenos">231</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-232"><a href="#LagrangianHamiltonianConverter.L_to_H-232"><span class="linenos">232</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">L_to_H</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="n">return_symbol_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-233"><a href="#LagrangianHamiltonianConverter.L_to_H-233"><span class="linenos">233</span></a>               <span class="n">method</span><span class="o">=</span><span class="s2">&quot;legendre&quot;</span><span class="p">,</span> <span class="n">fenchel_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-234"><a href="#LagrangianHamiltonianConverter.L_to_H-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-235"><a href="#LagrangianHamiltonianConverter.L_to_H-235"><span class="linenos">235</span></a><span class="sd">        Convert L(x,u,p) -&gt; H(x,u,xi) with options for generalized Legendre (Fenchel).</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-236"><a href="#LagrangianHamiltonianConverter.L_to_H-236"><span class="linenos">236</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-237"><a href="#LagrangianHamiltonianConverter.L_to_H-237"><span class="linenos">237</span></a><span class="sd">        Parameters:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-238"><a href="#LagrangianHamiltonianConverter.L_to_H-238"><span class="linenos">238</span></a><span class="sd">          - method: &quot;legendre&quot; (default), &quot;fenchel_symbolic&quot;, &quot;fenchel_numeric&quot;</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-239"><a href="#LagrangianHamiltonianConverter.L_to_H-239"><span class="linenos">239</span></a><span class="sd">          - fenchel_opts: dict with options for numeric fenchel</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-240"><a href="#LagrangianHamiltonianConverter.L_to_H-240"><span class="linenos">240</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-241"><a href="#LagrangianHamiltonianConverter.L_to_H-241"><span class="linenos">241</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-242"><a href="#LagrangianHamiltonianConverter.L_to_H-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-243"><a href="#LagrangianHamiltonianConverter.L_to_H-243"><span class="linenos">243</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-244"><a href="#LagrangianHamiltonianConverter.L_to_H-244"><span class="linenos">244</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-245"><a href="#LagrangianHamiltonianConverter.L_to_H-245"><span class="linenos">245</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-246"><a href="#LagrangianHamiltonianConverter.L_to_H-246"><span class="linenos">246</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-247"><a href="#LagrangianHamiltonianConverter.L_to_H-247"><span class="linenos">247</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D dimensions are supported.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-248"><a href="#LagrangianHamiltonianConverter.L_to_H-248"><span class="linenos">248</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-249"><a href="#LagrangianHamiltonianConverter.L_to_H-249"><span class="linenos">249</span></a>        <span class="c1"># Quadratic fast-path (symbolic)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-250"><a href="#LagrangianHamiltonianConverter.L_to_H-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;legendre&quot;</span><span class="p">,</span> <span class="s2">&quot;fenchel_symbolic&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_is_quadratic_in_p</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-251"><a href="#LagrangianHamiltonianConverter.L_to_H-251"><span class="linenos">251</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-252"><a href="#LagrangianHamiltonianConverter.L_to_H-252"><span class="linenos">252</span></a>                <span class="n">H_expr</span><span class="p">,</span> <span class="n">sol</span> <span class="o">=</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_quadratic_legendre</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-253"><a href="#LagrangianHamiltonianConverter.L_to_H-253"><span class="linenos">253</span></a>                <span class="k">if</span> <span class="n">return_symbol_only</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-254"><a href="#LagrangianHamiltonianConverter.L_to_H-254"><span class="linenos">254</span></a>                    <span class="n">H_expr</span> <span class="o">=</span> <span class="n">H_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-255"><a href="#LagrangianHamiltonianConverter.L_to_H-255"><span class="linenos">255</span></a>                <span class="k">return</span> <span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-256"><a href="#LagrangianHamiltonianConverter.L_to_H-256"><span class="linenos">256</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-257"><a href="#LagrangianHamiltonianConverter.L_to_H-257"><span class="linenos">257</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;legendre&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-258"><a href="#LagrangianHamiltonianConverter.L_to_H-258"><span class="linenos">258</span></a>                    <span class="k">raise</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-259"><a href="#LagrangianHamiltonianConverter.L_to_H-259"><span class="linenos">259</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-260"><a href="#LagrangianHamiltonianConverter.L_to_H-260"><span class="linenos">260</span></a>        <span class="c1"># CLASSICAL LEGENDRE</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-261"><a href="#LagrangianHamiltonianConverter.L_to_H-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;legendre&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-262"><a href="#LagrangianHamiltonianConverter.L_to_H-262"><span class="linenos">262</span></a>            <span class="n">H_p</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-263"><a href="#LagrangianHamiltonianConverter.L_to_H-263"><span class="linenos">263</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-264"><a href="#LagrangianHamiltonianConverter.L_to_H-264"><span class="linenos">264</span></a>                <span class="n">H_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-265"><a href="#LagrangianHamiltonianConverter.L_to_H-265"><span class="linenos">265</span></a>                <span class="n">det_H</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">H_p</span><span class="o">.</span><span class="n">det</span><span class="p">())</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-266"><a href="#LagrangianHamiltonianConverter.L_to_H-266"><span class="linenos">266</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-267"><a href="#LagrangianHamiltonianConverter.L_to_H-267"><span class="linenos">267</span></a>                <span class="n">det_H</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-268"><a href="#LagrangianHamiltonianConverter.L_to_H-268"><span class="linenos">268</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-269"><a href="#LagrangianHamiltonianConverter.L_to_H-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="n">det_H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">det_H</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-270"><a href="#LagrangianHamiltonianConverter.L_to_H-270"><span class="linenos">270</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Legendre transform not invertible: Hessian singular. Use force=True or Fenchel method.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-271"><a href="#LagrangianHamiltonianConverter.L_to_H-271"><span class="linenos">271</span></a>            <span class="k">if</span> <span class="n">det_H</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-272"><a href="#LagrangianHamiltonianConverter.L_to_H-272"><span class="linenos">272</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to verify Hessian determinant symbolically. Use force=True to attempt solve().&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-273"><a href="#LagrangianHamiltonianConverter.L_to_H-273"><span class="linenos">273</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-274"><a href="#LagrangianHamiltonianConverter.L_to_H-274"><span class="linenos">274</span></a>            <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-275"><a href="#LagrangianHamiltonianConverter.L_to_H-275"><span class="linenos">275</span></a>            <span class="n">sol_list</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-276"><a href="#LagrangianHamiltonianConverter.L_to_H-276"><span class="linenos">276</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-277"><a href="#LagrangianHamiltonianConverter.L_to_H-277"><span class="linenos">277</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-278"><a href="#LagrangianHamiltonianConverter.L_to_H-278"><span class="linenos">278</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to solve symbolic Legendre relations. Use force=True or Fenchel fallback.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-279"><a href="#LagrangianHamiltonianConverter.L_to_H-279"><span class="linenos">279</span></a>            <span class="k">if</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-280"><a href="#LagrangianHamiltonianConverter.L_to_H-280"><span class="linenos">280</span></a>                <span class="n">sol</span> <span class="o">=</span> <span class="n">sol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-281"><a href="#LagrangianHamiltonianConverter.L_to_H-281"><span class="linenos">281</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-282"><a href="#LagrangianHamiltonianConverter.L_to_H-282"><span class="linenos">282</span></a>                    <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-283"><a href="#LagrangianHamiltonianConverter.L_to_H-283"><span class="linenos">283</span></a>                <span class="n">H_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">sol</span><span class="p">[</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-284"><a href="#LagrangianHamiltonianConverter.L_to_H-284"><span class="linenos">284</span></a>                <span class="n">H_expr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">H_expr</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-285"><a href="#LagrangianHamiltonianConverter.L_to_H-285"><span class="linenos">285</span></a>                <span class="k">if</span> <span class="n">return_symbol_only</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-286"><a href="#LagrangianHamiltonianConverter.L_to_H-286"><span class="linenos">286</span></a>                    <span class="n">H_expr</span> <span class="o">=</span> <span class="n">H_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-287"><a href="#LagrangianHamiltonianConverter.L_to_H-287"><span class="linenos">287</span></a>                <span class="k">return</span> <span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-288"><a href="#LagrangianHamiltonianConverter.L_to_H-288"><span class="linenos">288</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Legendre inversion failed even with solve().&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-289"><a href="#LagrangianHamiltonianConverter.L_to_H-289"><span class="linenos">289</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-290"><a href="#LagrangianHamiltonianConverter.L_to_H-290"><span class="linenos">290</span></a>        <span class="c1"># FENCHEL: symbolic attempt</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-291"><a href="#LagrangianHamiltonianConverter.L_to_H-291"><span class="linenos">291</span></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-292"><a href="#LagrangianHamiltonianConverter.L_to_H-292"><span class="linenos">292</span></a>        <span class="c1">#  Prevent symbolic Fenchel when L is non-differentiable</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-293"><a href="#LagrangianHamiltonianConverter.L_to_H-293"><span class="linenos">293</span></a>        <span class="c1"># -----------------------------------------------------</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-294"><a href="#LagrangianHamiltonianConverter.L_to_H-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fenchel_symbolic&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-295"><a href="#LagrangianHamiltonianConverter.L_to_H-295"><span class="linenos">295</span></a>            <span class="k">if</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-296"><a href="#LagrangianHamiltonianConverter.L_to_H-296"><span class="linenos">296</span></a>                <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_vars</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-297"><a href="#LagrangianHamiltonianConverter.L_to_H-297"><span class="linenos">297</span></a>            <span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-298"><a href="#LagrangianHamiltonianConverter.L_to_H-298"><span class="linenos">298</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-299"><a href="#LagrangianHamiltonianConverter.L_to_H-299"><span class="linenos">299</span></a>                    <span class="s2">&quot;Symbolic Fenchel not possible for nonsmooth L (Abs, sign). &quot;</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-300"><a href="#LagrangianHamiltonianConverter.L_to_H-300"><span class="linenos">300</span></a>                    <span class="s2">&quot;Use method=&#39;fenchel_numeric&#39; instead.&quot;</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-301"><a href="#LagrangianHamiltonianConverter.L_to_H-301"><span class="linenos">301</span></a>                <span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-302"><a href="#LagrangianHamiltonianConverter.L_to_H-302"><span class="linenos">302</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-303"><a href="#LagrangianHamiltonianConverter.L_to_H-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fenchel_symbolic&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-304"><a href="#LagrangianHamiltonianConverter.L_to_H-304"><span class="linenos">304</span></a>            <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_expr</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-305"><a href="#LagrangianHamiltonianConverter.L_to_H-305"><span class="linenos">305</span></a>            <span class="n">sol_list</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">p_vars</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-306"><a href="#LagrangianHamiltonianConverter.L_to_H-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-307"><a href="#LagrangianHamiltonianConverter.L_to_H-307"><span class="linenos">307</span></a>                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-308"><a href="#LagrangianHamiltonianConverter.L_to_H-308"><span class="linenos">308</span></a>                <span class="k">for</span> <span class="n">sol</span> <span class="ow">in</span> <span class="n">sol_list</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-309"><a href="#LagrangianHamiltonianConverter.L_to_H-309"><span class="linenos">309</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-310"><a href="#LagrangianHamiltonianConverter.L_to_H-310"><span class="linenos">310</span></a>                        <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-311"><a href="#LagrangianHamiltonianConverter.L_to_H-311"><span class="linenos">311</span></a>                    <span class="n">S_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sol</span><span class="p">[</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-312"><a href="#LagrangianHamiltonianConverter.L_to_H-312"><span class="linenos">312</span></a>                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">S_expr</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-313"><a href="#LagrangianHamiltonianConverter.L_to_H-313"><span class="linenos">313</span></a>                <span class="n">H_candidates</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="o">*</span><span class="n">candidates</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-314"><a href="#LagrangianHamiltonianConverter.L_to_H-314"><span class="linenos">314</span></a>                <span class="k">if</span> <span class="n">return_symbol_only</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-315"><a href="#LagrangianHamiltonianConverter.L_to_H-315"><span class="linenos">315</span></a>                    <span class="n">H_candidates</span> <span class="o">=</span> <span class="n">H_candidates</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-316"><a href="#LagrangianHamiltonianConverter.L_to_H-316"><span class="linenos">316</span></a>                <span class="k">return</span> <span class="n">H_candidates</span><span class="p">,</span> <span class="n">xi_vars</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-317"><a href="#LagrangianHamiltonianConverter.L_to_H-317"><span class="linenos">317</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symbolic Fenchel conjugate not found; use method=&#39;fenchel_numeric&#39; for numeric computation.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-318"><a href="#LagrangianHamiltonianConverter.L_to_H-318"><span class="linenos">318</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-319"><a href="#LagrangianHamiltonianConverter.L_to_H-319"><span class="linenos">319</span></a>        <span class="c1"># FENCHEL: numeric path</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-320"><a href="#LagrangianHamiltonianConverter.L_to_H-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fenchel_numeric&quot;</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-321"><a href="#LagrangianHamiltonianConverter.L_to_H-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="n">fenchel_opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-322"><a href="#LagrangianHamiltonianConverter.L_to_H-322"><span class="linenos">322</span></a>                <span class="n">fenchel_opts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-323"><a href="#LagrangianHamiltonianConverter.L_to_H-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-324"><a href="#LagrangianHamiltonianConverter.L_to_H-324"><span class="linenos">324</span></a>                <span class="n">p_bounds</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_bounds&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-325"><a href="#LagrangianHamiltonianConverter.L_to_H-325"><span class="linenos">325</span></a>                <span class="n">n_grid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_grid&quot;</span><span class="p">,</span> <span class="mi">2001</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-326"><a href="#LagrangianHamiltonianConverter.L_to_H-326"><span class="linenos">326</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-327"><a href="#LagrangianHamiltonianConverter.L_to_H-327"><span class="linenos">327</span></a>                <span class="n">scipy_multistart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scipy_multistart&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-328"><a href="#LagrangianHamiltonianConverter.L_to_H-328"><span class="linenos">328</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-329"><a href="#LagrangianHamiltonianConverter.L_to_H-329"><span class="linenos">329</span></a>                <span class="c1"># Build numeric L_func (try lambdify)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-330"><a href="#LagrangianHamiltonianConverter.L_to_H-330"><span class="linenos">330</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-331"><a href="#LagrangianHamiltonianConverter.L_to_H-331"><span class="linenos">331</span></a>                    <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-332"><a href="#LagrangianHamiltonianConverter.L_to_H-332"><span class="linenos">332</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">L_func_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-333"><a href="#LagrangianHamiltonianConverter.L_to_H-333"><span class="linenos">333</span></a>                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-334"><a href="#LagrangianHamiltonianConverter.L_to_H-334"><span class="linenos">334</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-335"><a href="#LagrangianHamiltonianConverter.L_to_H-335"><span class="linenos">335</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-336"><a href="#LagrangianHamiltonianConverter.L_to_H-336"><span class="linenos">336</span></a>                        <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-337"><a href="#LagrangianHamiltonianConverter.L_to_H-337"><span class="linenos">337</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-338"><a href="#LagrangianHamiltonianConverter.L_to_H-338"><span class="linenos">338</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-339"><a href="#LagrangianHamiltonianConverter.L_to_H-339"><span class="linenos">339</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-340"><a href="#LagrangianHamiltonianConverter.L_to_H-340"><span class="linenos">340</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_scalar</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-341"><a href="#LagrangianHamiltonianConverter.L_to_H-341"><span class="linenos">341</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">N</span><span class="p">(</span><span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">p</span><span class="p">})))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-342"><a href="#LagrangianHamiltonianConverter.L_to_H-342"><span class="linenos">342</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-343"><a href="#LagrangianHamiltonianConverter.L_to_H-343"><span class="linenos">343</span></a>                <span class="n">H_numeric</span> <span class="o">=</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_legendre_fenchel_1d_numeric_callable</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-344"><a href="#LagrangianHamiltonianConverter.L_to_H-344"><span class="linenos">344</span></a>                    <span class="n">L_func_scalar</span><span class="p">,</span> <span class="n">p_bounds</span><span class="o">=</span><span class="n">p_bounds</span><span class="p">,</span> <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-345"><a href="#LagrangianHamiltonianConverter.L_to_H-345"><span class="linenos">345</span></a>                    <span class="n">scipy_multistart</span><span class="o">=</span><span class="n">scipy_multistart</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-346"><a href="#LagrangianHamiltonianConverter.L_to_H-346"><span class="linenos">346</span></a>                <span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-347"><a href="#LagrangianHamiltonianConverter.L_to_H-347"><span class="linenos">347</span></a>                <span class="n">H_func</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;H_numeric&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-348"><a href="#LagrangianHamiltonianConverter.L_to_H-348"><span class="linenos">348</span></a>                <span class="n">H_repr</span> <span class="o">=</span> <span class="n">H_func</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-349"><a href="#LagrangianHamiltonianConverter.L_to_H-349"><span class="linenos">349</span></a>                <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_numeric_cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">H_repr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-350"><a href="#LagrangianHamiltonianConverter.L_to_H-350"><span class="linenos">350</span></a>                <span class="k">return</span> <span class="n">H_repr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-351"><a href="#LagrangianHamiltonianConverter.L_to_H-351"><span class="linenos">351</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-352"><a href="#LagrangianHamiltonianConverter.L_to_H-352"><span class="linenos">352</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-353"><a href="#LagrangianHamiltonianConverter.L_to_H-353"><span class="linenos">353</span></a>                <span class="c1"># dim == 2</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-354"><a href="#LagrangianHamiltonianConverter.L_to_H-354"><span class="linenos">354</span></a>                <span class="n">p_bounds</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_bounds&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)])</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-355"><a href="#LagrangianHamiltonianConverter.L_to_H-355"><span class="linenos">355</span></a>                <span class="n">n_grid_per_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_grid_per_dim&quot;</span><span class="p">,</span> <span class="mi">41</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-356"><a href="#LagrangianHamiltonianConverter.L_to_H-356"><span class="linenos">356</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-357"><a href="#LagrangianHamiltonianConverter.L_to_H-357"><span class="linenos">357</span></a>                <span class="n">scipy_multistart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scipy_multistart&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-358"><a href="#LagrangianHamiltonianConverter.L_to_H-358"><span class="linenos">358</span></a>                <span class="n">multistart_restarts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fenchel_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multistart_restarts&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-359"><a href="#LagrangianHamiltonianConverter.L_to_H-359"><span class="linenos">359</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-360"><a href="#LagrangianHamiltonianConverter.L_to_H-360"><span class="linenos">360</span></a>                <span class="n">f_lamb</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-361"><a href="#LagrangianHamiltonianConverter.L_to_H-361"><span class="linenos">361</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-362"><a href="#LagrangianHamiltonianConverter.L_to_H-362"><span class="linenos">362</span></a>                    <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">p_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-363"><a href="#LagrangianHamiltonianConverter.L_to_H-363"><span class="linenos">363</span></a>                    <span class="k">def</span><span class="w"> </span><span class="nf">L_func_nd</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-364"><a href="#LagrangianHamiltonianConverter.L_to_H-364"><span class="linenos">364</span></a>                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-365"><a href="#LagrangianHamiltonianConverter.L_to_H-365"><span class="linenos">365</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-366"><a href="#LagrangianHamiltonianConverter.L_to_H-366"><span class="linenos">366</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-367"><a href="#LagrangianHamiltonianConverter.L_to_H-367"><span class="linenos">367</span></a>                        <span class="n">f_lamb</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">p_vars</span><span class="p">,),</span> <span class="n">L_expr</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-368"><a href="#LagrangianHamiltonianConverter.L_to_H-368"><span class="linenos">368</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_nd</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-369"><a href="#LagrangianHamiltonianConverter.L_to_H-369"><span class="linenos">369</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_lamb</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-370"><a href="#LagrangianHamiltonianConverter.L_to_H-370"><span class="linenos">370</span></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-371"><a href="#LagrangianHamiltonianConverter.L_to_H-371"><span class="linenos">371</span></a>                        <span class="k">def</span><span class="w"> </span><span class="nf">L_func_nd</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-372"><a href="#LagrangianHamiltonianConverter.L_to_H-372"><span class="linenos">372</span></a>                            <span class="n">subs_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-373"><a href="#LagrangianHamiltonianConverter.L_to_H-373"><span class="linenos">373</span></a>                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">N</span><span class="p">(</span><span class="n">L_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">subs_map</span><span class="p">)))</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-374"><a href="#LagrangianHamiltonianConverter.L_to_H-374"><span class="linenos">374</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-375"><a href="#LagrangianHamiltonianConverter.L_to_H-375"><span class="linenos">375</span></a>                <span class="n">H_numeric</span> <span class="o">=</span> <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_legendre_fenchel_nd_numeric_callable</span><span class="p">(</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-376"><a href="#LagrangianHamiltonianConverter.L_to_H-376"><span class="linenos">376</span></a>                    <span class="n">L_func_nd</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_bounds</span><span class="o">=</span><span class="p">(</span><span class="n">p_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-377"><a href="#LagrangianHamiltonianConverter.L_to_H-377"><span class="linenos">377</span></a>                    <span class="n">n_grid_per_dim</span><span class="o">=</span><span class="n">n_grid_per_dim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-378"><a href="#LagrangianHamiltonianConverter.L_to_H-378"><span class="linenos">378</span></a>                    <span class="n">scipy_multistart</span><span class="o">=</span><span class="n">scipy_multistart</span><span class="p">,</span> <span class="n">multistart_restarts</span><span class="o">=</span><span class="n">multistart_restarts</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-379"><a href="#LagrangianHamiltonianConverter.L_to_H-379"><span class="linenos">379</span></a>                <span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-380"><a href="#LagrangianHamiltonianConverter.L_to_H-380"><span class="linenos">380</span></a>                <span class="n">H_func</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;H_numeric&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-381"><a href="#LagrangianHamiltonianConverter.L_to_H-381"><span class="linenos">381</span></a>                <span class="n">H_repr</span> <span class="o">=</span> <span class="n">H_func</span><span class="p">(</span><span class="o">*</span><span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-382"><a href="#LagrangianHamiltonianConverter.L_to_H-382"><span class="linenos">382</span></a>                <span class="n">LagrangianHamiltonianConverter</span><span class="o">.</span><span class="n">_numeric_cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">H_repr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-383"><a href="#LagrangianHamiltonianConverter.L_to_H-383"><span class="linenos">383</span></a>                <span class="k">return</span> <span class="n">H_repr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="n">H_numeric</span>
</span><span id="LagrangianHamiltonianConverter.L_to_H-384"><a href="#LagrangianHamiltonianConverter.L_to_H-384"><span class="linenos">384</span></a>
</span><span id="LagrangianHamiltonianConverter.L_to_H-385"><a href="#LagrangianHamiltonianConverter.L_to_H-385"><span class="linenos">385</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown method &#39;</span><span class="si">{}</span><span class="s2">&#39;. Choose &#39;legendre&#39;, &#39;fenchel_symbolic&#39; or &#39;fenchel_numeric&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Convert L(x,u,p) -> H(x,u,xi) with options for generalized Legendre (Fenchel).</p>

<p>Parameters:</p>

<ul>
<li>method: "legendre" (default), "fenchel_symbolic", "fenchel_numeric"</li>
<li>fenchel_opts: dict with options for numeric fenchel</li>
</ul>
</div>


                            </div>
                            <div id="LagrangianHamiltonianConverter.H_to_L" class="classattr">
                                        <input id="LagrangianHamiltonianConverter.H_to_L-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">H_to_L</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">H_expr</span>, </span><span class="param"><span class="n">coords</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">xi_vars</span>, </span><span class="param"><span class="n">force</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LagrangianHamiltonianConverter.H_to_L-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LagrangianHamiltonianConverter.H_to_L"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LagrangianHamiltonianConverter.H_to_L-387"><a href="#LagrangianHamiltonianConverter.H_to_L-387"><span class="linenos">387</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-388"><a href="#LagrangianHamiltonianConverter.H_to_L-388"><span class="linenos">388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">H_to_L</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-389"><a href="#LagrangianHamiltonianConverter.H_to_L-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-390"><a href="#LagrangianHamiltonianConverter.H_to_L-390"><span class="linenos">390</span></a><span class="sd">        Inverse Legendre (classical). Does not attempt Fenchel inverse.</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-391"><a href="#LagrangianHamiltonianConverter.H_to_L-391"><span class="linenos">391</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-392"><a href="#LagrangianHamiltonianConverter.H_to_L-392"><span class="linenos">392</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-393"><a href="#LagrangianHamiltonianConverter.H_to_L-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-394"><a href="#LagrangianHamiltonianConverter.H_to_L-394"><span class="linenos">394</span></a>            <span class="n">p_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-395"><a href="#LagrangianHamiltonianConverter.H_to_L-395"><span class="linenos">395</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-396"><a href="#LagrangianHamiltonianConverter.H_to_L-396"><span class="linenos">396</span></a>            <span class="n">p_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p_x&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p_y&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-397"><a href="#LagrangianHamiltonianConverter.H_to_L-397"><span class="linenos">397</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-398"><a href="#LagrangianHamiltonianConverter.H_to_L-398"><span class="linenos">398</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D are supported.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-399"><a href="#LagrangianHamiltonianConverter.H_to_L-399"><span class="linenos">399</span></a>
</span><span id="LagrangianHamiltonianConverter.H_to_L-400"><a href="#LagrangianHamiltonianConverter.H_to_L-400"><span class="linenos">400</span></a>        <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-401"><a href="#LagrangianHamiltonianConverter.H_to_L-401"><span class="linenos">401</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-402"><a href="#LagrangianHamiltonianConverter.H_to_L-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-403"><a href="#LagrangianHamiltonianConverter.H_to_L-403"><span class="linenos">403</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-404"><a href="#LagrangianHamiltonianConverter.H_to_L-404"><span class="linenos">404</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to symbolically solve p = ∂H/∂ξ for ξ. Use force=True.&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-405"><a href="#LagrangianHamiltonianConverter.H_to_L-405"><span class="linenos">405</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-406"><a href="#LagrangianHamiltonianConverter.H_to_L-406"><span class="linenos">406</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-407"><a href="#LagrangianHamiltonianConverter.H_to_L-407"><span class="linenos">407</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inverse Legendre transform failed; cannot find ξ(p).&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-408"><a href="#LagrangianHamiltonianConverter.H_to_L-408"><span class="linenos">408</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">sol</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-409"><a href="#LagrangianHamiltonianConverter.H_to_L-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-410"><a href="#LagrangianHamiltonianConverter.H_to_L-410"><span class="linenos">410</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">))}</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-411"><a href="#LagrangianHamiltonianConverter.H_to_L-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-412"><a href="#LagrangianHamiltonianConverter.H_to_L-412"><span class="linenos">412</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sol</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-413"><a href="#LagrangianHamiltonianConverter.H_to_L-413"><span class="linenos">413</span></a>                <span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-414"><a href="#LagrangianHamiltonianConverter.H_to_L-414"><span class="linenos">414</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-415"><a href="#LagrangianHamiltonianConverter.H_to_L-415"><span class="linenos">415</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected output from solve(); cannot construct ξ(p).&quot;</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-416"><a href="#LagrangianHamiltonianConverter.H_to_L-416"><span class="linenos">416</span></a>        <span class="n">L_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="n">xi_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">p_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="n">H_expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
</span><span id="LagrangianHamiltonianConverter.H_to_L-417"><a href="#LagrangianHamiltonianConverter.H_to_L-417"><span class="linenos">417</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">L_expr</span><span class="p">),</span> <span class="n">p_vars</span>
</span></pre></div>


            <div class="docstring"><p>Inverse Legendre (classical). Does not attempt Fenchel inverse.</p>
</div>


                            </div>
                </section>
                <section id="HamiltonianSymbolicConverter">
                            <input id="HamiltonianSymbolicConverter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HamiltonianSymbolicConverter</span>:

                <label class="view-source-button" for="HamiltonianSymbolicConverter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HamiltonianSymbolicConverter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HamiltonianSymbolicConverter-423"><a href="#HamiltonianSymbolicConverter-423"><span class="linenos">423</span></a><span class="k">class</span><span class="w"> </span><span class="nc">HamiltonianSymbolicConverter</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-424"><a href="#HamiltonianSymbolicConverter-424"><span class="linenos">424</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HamiltonianSymbolicConverter-425"><a href="#HamiltonianSymbolicConverter-425"><span class="linenos">425</span></a><span class="sd">    Symbolic converter between Hamiltonians and formal PDEs (psiOp).</span>
</span><span id="HamiltonianSymbolicConverter-426"><a href="#HamiltonianSymbolicConverter-426"><span class="linenos">426</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HamiltonianSymbolicConverter-427"><a href="#HamiltonianSymbolicConverter-427"><span class="linenos">427</span></a>
</span><span id="HamiltonianSymbolicConverter-428"><a href="#HamiltonianSymbolicConverter-428"><span class="linenos">428</span></a>    <span class="nd">@staticmethod</span>
</span><span id="HamiltonianSymbolicConverter-429"><a href="#HamiltonianSymbolicConverter-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decompose_hamiltonian</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter-430"><a href="#HamiltonianSymbolicConverter-430"><span class="linenos">430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HamiltonianSymbolicConverter-431"><a href="#HamiltonianSymbolicConverter-431"><span class="linenos">431</span></a><span class="sd">        Decomposes the Hamiltonian into polynomial (local) and non-polynomial (nonlocal) parts.</span>
</span><span id="HamiltonianSymbolicConverter-432"><a href="#HamiltonianSymbolicConverter-432"><span class="linenos">432</span></a><span class="sd">        The heuristic treats terms containing sqrt, Abs, or sign as nonlocal.</span>
</span><span id="HamiltonianSymbolicConverter-433"><a href="#HamiltonianSymbolicConverter-433"><span class="linenos">433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HamiltonianSymbolicConverter-434"><a href="#HamiltonianSymbolicConverter-434"><span class="linenos">434</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">xi_vars</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="p">(</span><span class="n">xi_vars</span><span class="p">,)</span>
</span><span id="HamiltonianSymbolicConverter-435"><a href="#HamiltonianSymbolicConverter-435"><span class="linenos">435</span></a>        <span class="n">poly_terms</span><span class="p">,</span> <span class="n">nonlocal_terms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="HamiltonianSymbolicConverter-436"><a href="#HamiltonianSymbolicConverter-436"><span class="linenos">436</span></a>        <span class="n">H_expand</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">H_expr</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-437"><a href="#HamiltonianSymbolicConverter-437"><span class="linenos">437</span></a>        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">H_expand</span><span class="o">.</span><span class="n">as_ordered_terms</span><span class="p">():</span>
</span><span id="HamiltonianSymbolicConverter-438"><a href="#HamiltonianSymbolicConverter-438"><span class="linenos">438</span></a>            <span class="c1"># Heuristic: treat terms containing sqrt/Abs/sign as nonlocal explicitly</span>
</span><span id="HamiltonianSymbolicConverter-439"><a href="#HamiltonianSymbolicConverter-439"><span class="linenos">439</span></a>            <span class="c1"># Check if the *current* &#39;term&#39; (from the outer loop) has these functions.</span>
</span><span id="HamiltonianSymbolicConverter-440"><a href="#HamiltonianSymbolicConverter-440"><span class="linenos">440</span></a>            <span class="c1"># The original code had a scoping bug in the &#39;any&#39; statement.</span>
</span><span id="HamiltonianSymbolicConverter-441"><a href="#HamiltonianSymbolicConverter-441"><span class="linenos">441</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">func</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">free_symbols</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">])</span> <span class="ow">or</span> \
</span><span id="HamiltonianSymbolicConverter-442"><a href="#HamiltonianSymbolicConverter-442"><span class="linenos">442</span></a>               <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter-443"><a href="#HamiltonianSymbolicConverter-443"><span class="linenos">443</span></a>                <span class="c1"># Alternative and more robust check:</span>
</span><span id="HamiltonianSymbolicConverter-444"><a href="#HamiltonianSymbolicConverter-444"><span class="linenos">444</span></a>                <span class="c1"># This checks if the specific &#39;term&#39; object contains the specified functions.</span>
</span><span id="HamiltonianSymbolicConverter-445"><a href="#HamiltonianSymbolicConverter-445"><span class="linenos">445</span></a>                <span class="n">nonlocal_terms</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="HamiltonianSymbolicConverter-446"><a href="#HamiltonianSymbolicConverter-446"><span class="linenos">446</span></a>            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">is_polynomial</span><span class="p">(</span><span class="n">xi_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi_i</span> <span class="ow">in</span> <span class="n">xi</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter-447"><a href="#HamiltonianSymbolicConverter-447"><span class="linenos">447</span></a>                <span class="n">poly_terms</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="HamiltonianSymbolicConverter-448"><a href="#HamiltonianSymbolicConverter-448"><span class="linenos">448</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-449"><a href="#HamiltonianSymbolicConverter-449"><span class="linenos">449</span></a>                <span class="n">nonlocal_terms</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="HamiltonianSymbolicConverter-450"><a href="#HamiltonianSymbolicConverter-450"><span class="linenos">450</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">poly_terms</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">nonlocal_terms</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-451"><a href="#HamiltonianSymbolicConverter-451"><span class="linenos">451</span></a>
</span><span id="HamiltonianSymbolicConverter-452"><a href="#HamiltonianSymbolicConverter-452"><span class="linenos">452</span></a>    <span class="nd">@classmethod</span>
</span><span id="HamiltonianSymbolicConverter-453"><a href="#HamiltonianSymbolicConverter-453"><span class="linenos">453</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hamiltonian_to_symbolic_pde</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">H_expr</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;schrodinger&quot;</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter-454"><a href="#HamiltonianSymbolicConverter-454"><span class="linenos">454</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-455"><a href="#HamiltonianSymbolicConverter-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-456"><a href="#HamiltonianSymbolicConverter-456"><span class="linenos">456</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;xi&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
</span><span id="HamiltonianSymbolicConverter-457"><a href="#HamiltonianSymbolicConverter-457"><span class="linenos">457</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-458"><a href="#HamiltonianSymbolicConverter-458"><span class="linenos">458</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;xi&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="HamiltonianSymbolicConverter-459"><a href="#HamiltonianSymbolicConverter-459"><span class="linenos">459</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-460"><a href="#HamiltonianSymbolicConverter-460"><span class="linenos">460</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D Hamiltonians are supported.&quot;</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-461"><a href="#HamiltonianSymbolicConverter-461"><span class="linenos">461</span></a>
</span><span id="HamiltonianSymbolicConverter-462"><a href="#HamiltonianSymbolicConverter-462"><span class="linenos">462</span></a>        <span class="n">H_poly</span><span class="p">,</span> <span class="n">H_nonlocal</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">decompose_hamiltonian</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-463"><a href="#HamiltonianSymbolicConverter-463"><span class="linenos">463</span></a>        <span class="n">H_total</span> <span class="o">=</span> <span class="n">H_poly</span> <span class="o">+</span> <span class="n">H_nonlocal</span>
</span><span id="HamiltonianSymbolicConverter-464"><a href="#HamiltonianSymbolicConverter-464"><span class="linenos">464</span></a>        <span class="n">psiOp_H_u</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;psiOp&quot;</span><span class="p">)(</span><span class="n">H_total</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-465"><a href="#HamiltonianSymbolicConverter-465"><span class="linenos">465</span></a>
</span><span id="HamiltonianSymbolicConverter-466"><a href="#HamiltonianSymbolicConverter-466"><span class="linenos">466</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stationary&quot;</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-467"><a href="#HamiltonianSymbolicConverter-467"><span class="linenos">467</span></a>            <span class="n">E</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-468"><a href="#HamiltonianSymbolicConverter-468"><span class="linenos">468</span></a>            <span class="n">pde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">psiOp_H_u</span><span class="p">,</span> <span class="n">E</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-469"><a href="#HamiltonianSymbolicConverter-469"><span class="linenos">469</span></a>            <span class="n">formal</span> <span class="o">=</span> <span class="s2">&quot;ψOp(H, u) = E u&quot;</span>
</span><span id="HamiltonianSymbolicConverter-470"><a href="#HamiltonianSymbolicConverter-470"><span class="linenos">470</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;schrodinger&quot;</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-471"><a href="#HamiltonianSymbolicConverter-471"><span class="linenos">471</span></a>            <span class="n">pde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">I</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">Derivative</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">psiOp_H_u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-472"><a href="#HamiltonianSymbolicConverter-472"><span class="linenos">472</span></a>            <span class="n">formal</span> <span class="o">=</span> <span class="s2">&quot;i ∂_t u = ψOp(H, u)&quot;</span>
</span><span id="HamiltonianSymbolicConverter-473"><a href="#HamiltonianSymbolicConverter-473"><span class="linenos">473</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;wave&quot;</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-474"><a href="#HamiltonianSymbolicConverter-474"><span class="linenos">474</span></a>            <span class="n">pde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Derivative</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="n">psiOp_H_u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-475"><a href="#HamiltonianSymbolicConverter-475"><span class="linenos">475</span></a>            <span class="n">formal</span> <span class="o">=</span> <span class="s2">&quot;∂_</span><span class="si">{tt}</span><span class="s2"> u + ψOp(H, u) = 0&quot;</span>
</span><span id="HamiltonianSymbolicConverter-476"><a href="#HamiltonianSymbolicConverter-476"><span class="linenos">476</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter-477"><a href="#HamiltonianSymbolicConverter-477"><span class="linenos">477</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be one of: &#39;stationary&#39;, &#39;schrodinger&#39;, &#39;wave&#39;.&quot;</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-478"><a href="#HamiltonianSymbolicConverter-478"><span class="linenos">478</span></a>
</span><span id="HamiltonianSymbolicConverter-479"><a href="#HamiltonianSymbolicConverter-479"><span class="linenos">479</span></a>        <span class="n">coord_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-480"><a href="#HamiltonianSymbolicConverter-480"><span class="linenos">480</span></a>        <span class="n">xi_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter-481"><a href="#HamiltonianSymbolicConverter-481"><span class="linenos">481</span></a>        <span class="n">formal</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   (H = H(</span><span class="si">{</span><span class="n">coord_str</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">xi_str</span><span class="si">}</span><span class="s2">))&quot;</span>
</span><span id="HamiltonianSymbolicConverter-482"><a href="#HamiltonianSymbolicConverter-482"><span class="linenos">482</span></a>
</span><span id="HamiltonianSymbolicConverter-483"><a href="#HamiltonianSymbolicConverter-483"><span class="linenos">483</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="HamiltonianSymbolicConverter-484"><a href="#HamiltonianSymbolicConverter-484"><span class="linenos">484</span></a>            <span class="s2">&quot;pde&quot;</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">pde</span><span class="p">),</span>
</span><span id="HamiltonianSymbolicConverter-485"><a href="#HamiltonianSymbolicConverter-485"><span class="linenos">485</span></a>            <span class="s2">&quot;H_poly&quot;</span><span class="p">:</span> <span class="n">H_poly</span><span class="p">,</span>
</span><span id="HamiltonianSymbolicConverter-486"><a href="#HamiltonianSymbolicConverter-486"><span class="linenos">486</span></a>            <span class="s2">&quot;H_nonlocal&quot;</span><span class="p">:</span> <span class="n">H_nonlocal</span><span class="p">,</span>
</span><span id="HamiltonianSymbolicConverter-487"><a href="#HamiltonianSymbolicConverter-487"><span class="linenos">487</span></a>            <span class="s2">&quot;formal_string&quot;</span><span class="p">:</span> <span class="n">formal</span><span class="p">,</span>
</span><span id="HamiltonianSymbolicConverter-488"><a href="#HamiltonianSymbolicConverter-488"><span class="linenos">488</span></a>            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span>
</span><span id="HamiltonianSymbolicConverter-489"><a href="#HamiltonianSymbolicConverter-489"><span class="linenos">489</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Symbolic converter between Hamiltonians and formal PDEs (psiOp).</p>
</div>


                            <div id="HamiltonianSymbolicConverter.decompose_hamiltonian" class="classattr">
                                        <input id="HamiltonianSymbolicConverter.decompose_hamiltonian-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">decompose_hamiltonian</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">H_expr</span>, </span><span class="param"><span class="n">xi_vars</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="HamiltonianSymbolicConverter.decompose_hamiltonian-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HamiltonianSymbolicConverter.decompose_hamiltonian"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-428"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-428"><span class="linenos">428</span></a>    <span class="nd">@staticmethod</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-429"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decompose_hamiltonian</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-430"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-430"><span class="linenos">430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-431"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-431"><span class="linenos">431</span></a><span class="sd">        Decomposes the Hamiltonian into polynomial (local) and non-polynomial (nonlocal) parts.</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-432"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-432"><span class="linenos">432</span></a><span class="sd">        The heuristic treats terms containing sqrt, Abs, or sign as nonlocal.</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-433"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-433"><span class="linenos">433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-434"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-434"><span class="linenos">434</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">xi_vars</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xi_vars</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="p">(</span><span class="n">xi_vars</span><span class="p">,)</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-435"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-435"><span class="linenos">435</span></a>        <span class="n">poly_terms</span><span class="p">,</span> <span class="n">nonlocal_terms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-436"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-436"><span class="linenos">436</span></a>        <span class="n">H_expand</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">H_expr</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-437"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-437"><span class="linenos">437</span></a>        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">H_expand</span><span class="o">.</span><span class="n">as_ordered_terms</span><span class="p">():</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-438"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-438"><span class="linenos">438</span></a>            <span class="c1"># Heuristic: treat terms containing sqrt/Abs/sign as nonlocal explicitly</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-439"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-439"><span class="linenos">439</span></a>            <span class="c1"># Check if the *current* &#39;term&#39; (from the outer loop) has these functions.</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-440"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-440"><span class="linenos">440</span></a>            <span class="c1"># The original code had a scoping bug in the &#39;any&#39; statement.</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-441"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-441"><span class="linenos">441</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">func</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">free_symbols</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">])</span> <span class="ow">or</span> \
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-442"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-442"><span class="linenos">442</span></a>               <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Abs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">sign</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-443"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-443"><span class="linenos">443</span></a>                <span class="c1"># Alternative and more robust check:</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-444"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-444"><span class="linenos">444</span></a>                <span class="c1"># This checks if the specific &#39;term&#39; object contains the specified functions.</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-445"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-445"><span class="linenos">445</span></a>                <span class="n">nonlocal_terms</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-446"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-446"><span class="linenos">446</span></a>            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">is_polynomial</span><span class="p">(</span><span class="n">xi_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi_i</span> <span class="ow">in</span> <span class="n">xi</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-447"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-447"><span class="linenos">447</span></a>                <span class="n">poly_terms</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-448"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-448"><span class="linenos">448</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-449"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-449"><span class="linenos">449</span></a>                <span class="n">nonlocal_terms</span> <span class="o">+=</span> <span class="n">term</span>
</span><span id="HamiltonianSymbolicConverter.decompose_hamiltonian-450"><a href="#HamiltonianSymbolicConverter.decompose_hamiltonian-450"><span class="linenos">450</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">poly_terms</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">nonlocal_terms</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Decomposes the Hamiltonian into polynomial (local) and non-polynomial (nonlocal) parts.
The heuristic treats terms containing sqrt, Abs, or sign as nonlocal.</p>
</div>


                            </div>
                            <div id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde" class="classattr">
                                        <input id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">hamiltonian_to_symbolic_pde</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">H_expr</span>, </span><span class="param"><span class="n">coords</span>, </span><span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;schrodinger&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-452"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-452"><span class="linenos">452</span></a>    <span class="nd">@classmethod</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-453"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-453"><span class="linenos">453</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hamiltonian_to_symbolic_pde</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">H_expr</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;schrodinger&quot;</span><span class="p">):</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-454"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-454"><span class="linenos">454</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-455"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-456"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-456"><span class="linenos">456</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;xi&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-457"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-457"><span class="linenos">457</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-458"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-458"><span class="linenos">458</span></a>            <span class="n">xi_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;xi&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-459"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-459"><span class="linenos">459</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-460"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-460"><span class="linenos">460</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D and 2D Hamiltonians are supported.&quot;</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-461"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-461"><span class="linenos">461</span></a>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-462"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-462"><span class="linenos">462</span></a>        <span class="n">H_poly</span><span class="p">,</span> <span class="n">H_nonlocal</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">decompose_hamiltonian</span><span class="p">(</span><span class="n">H_expr</span><span class="p">,</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-463"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-463"><span class="linenos">463</span></a>        <span class="n">H_total</span> <span class="o">=</span> <span class="n">H_poly</span> <span class="o">+</span> <span class="n">H_nonlocal</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-464"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-464"><span class="linenos">464</span></a>        <span class="n">psiOp_H_u</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;psiOp&quot;</span><span class="p">)(</span><span class="n">H_total</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-465"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-465"><span class="linenos">465</span></a>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-466"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-466"><span class="linenos">466</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stationary&quot;</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-467"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-467"><span class="linenos">467</span></a>            <span class="n">E</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-468"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-468"><span class="linenos">468</span></a>            <span class="n">pde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">psiOp_H_u</span><span class="p">,</span> <span class="n">E</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-469"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-469"><span class="linenos">469</span></a>            <span class="n">formal</span> <span class="o">=</span> <span class="s2">&quot;ψOp(H, u) = E u&quot;</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-470"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-470"><span class="linenos">470</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;schrodinger&quot;</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-471"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-471"><span class="linenos">471</span></a>            <span class="n">pde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">I</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">Derivative</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">psiOp_H_u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-472"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-472"><span class="linenos">472</span></a>            <span class="n">formal</span> <span class="o">=</span> <span class="s2">&quot;i ∂_t u = ψOp(H, u)&quot;</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-473"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-473"><span class="linenos">473</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;wave&quot;</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-474"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-474"><span class="linenos">474</span></a>            <span class="n">pde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Derivative</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="n">psiOp_H_u</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-475"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-475"><span class="linenos">475</span></a>            <span class="n">formal</span> <span class="o">=</span> <span class="s2">&quot;∂_</span><span class="si">{tt}</span><span class="s2"> u + ψOp(H, u) = 0&quot;</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-476"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-476"><span class="linenos">476</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-477"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-477"><span class="linenos">477</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be one of: &#39;stationary&#39;, &#39;schrodinger&#39;, &#39;wave&#39;.&quot;</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-478"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-478"><span class="linenos">478</span></a>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-479"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-479"><span class="linenos">479</span></a>        <span class="n">coord_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-480"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-480"><span class="linenos">480</span></a>        <span class="n">xi_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xi_vars</span><span class="p">)</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-481"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-481"><span class="linenos">481</span></a>        <span class="n">formal</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   (H = H(</span><span class="si">{</span><span class="n">coord_str</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">xi_str</span><span class="si">}</span><span class="s2">))&quot;</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-482"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-482"><span class="linenos">482</span></a>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-483"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-483"><span class="linenos">483</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-484"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-484"><span class="linenos">484</span></a>            <span class="s2">&quot;pde&quot;</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">pde</span><span class="p">),</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-485"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-485"><span class="linenos">485</span></a>            <span class="s2">&quot;H_poly&quot;</span><span class="p">:</span> <span class="n">H_poly</span><span class="p">,</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-486"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-486"><span class="linenos">486</span></a>            <span class="s2">&quot;H_nonlocal&quot;</span><span class="p">:</span> <span class="n">H_nonlocal</span><span class="p">,</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-487"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-487"><span class="linenos">487</span></a>            <span class="s2">&quot;formal_string&quot;</span><span class="p">:</span> <span class="n">formal</span><span class="p">,</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-488"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-488"><span class="linenos">488</span></a>            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span>
</span><span id="HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-489"><a href="#HamiltonianSymbolicConverter.hamiltonian_to_symbolic_pde-489"><span class="linenos">489</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="SymbolGeometry">
                            <input id="SymbolGeometry-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SymbolGeometry</span>:

                <label class="view-source-button" for="SymbolGeometry-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry-101"><a href="#SymbolGeometry-101"><span class="linenos">101</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SymbolGeometry</span><span class="p">:</span>
</span><span id="SymbolGeometry-102"><a href="#SymbolGeometry-102"><span class="linenos">102</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-103"><a href="#SymbolGeometry-103"><span class="linenos">103</span></a><span class="sd">    Analyzes the geometric structure of a symbol H(x, ξ)</span>
</span><span id="SymbolGeometry-104"><a href="#SymbolGeometry-104"><span class="linenos">104</span></a><span class="sd">    </span>
</span><span id="SymbolGeometry-105"><a href="#SymbolGeometry-105"><span class="linenos">105</span></a><span class="sd">    This class computes:</span>
</span><span id="SymbolGeometry-106"><a href="#SymbolGeometry-106"><span class="linenos">106</span></a><span class="sd">    - Hamiltonian flow (geodesics)</span>
</span><span id="SymbolGeometry-107"><a href="#SymbolGeometry-107"><span class="linenos">107</span></a><span class="sd">    - Jacobian (focusing)</span>
</span><span id="SymbolGeometry-108"><a href="#SymbolGeometry-108"><span class="linenos">108</span></a><span class="sd">    - Caustics (singularities)</span>
</span><span id="SymbolGeometry-109"><a href="#SymbolGeometry-109"><span class="linenos">109</span></a><span class="sd">    - Periodic orbits</span>
</span><span id="SymbolGeometry-110"><a href="#SymbolGeometry-110"><span class="linenos">110</span></a><span class="sd">    - Semiclassical spectrum</span>
</span><span id="SymbolGeometry-111"><a href="#SymbolGeometry-111"><span class="linenos">111</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-112"><a href="#SymbolGeometry-112"><span class="linenos">112</span></a>    
</span><span id="SymbolGeometry-113"><a href="#SymbolGeometry-113"><span class="linenos">113</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">x_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">xi_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">):</span>
</span><span id="SymbolGeometry-114"><a href="#SymbolGeometry-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-115"><a href="#SymbolGeometry-115"><span class="linenos">115</span></a><span class="sd">        Initialize with a symbolic Hamiltonian</span>
</span><span id="SymbolGeometry-116"><a href="#SymbolGeometry-116"><span class="linenos">116</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-117"><a href="#SymbolGeometry-117"><span class="linenos">117</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry-118"><a href="#SymbolGeometry-118"><span class="linenos">118</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry-119"><a href="#SymbolGeometry-119"><span class="linenos">119</span></a><span class="sd">        symbol : sympy expression</span>
</span><span id="SymbolGeometry-120"><a href="#SymbolGeometry-120"><span class="linenos">120</span></a><span class="sd">            The Hamiltonian H(x, ξ)</span>
</span><span id="SymbolGeometry-121"><a href="#SymbolGeometry-121"><span class="linenos">121</span></a><span class="sd">        x_sym, xi_sym : sympy symbols</span>
</span><span id="SymbolGeometry-122"><a href="#SymbolGeometry-122"><span class="linenos">122</span></a><span class="sd">            Position and momentum variables</span>
</span><span id="SymbolGeometry-123"><a href="#SymbolGeometry-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-124"><a href="#SymbolGeometry-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="SymbolGeometry-125"><a href="#SymbolGeometry-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span> <span class="o">=</span> <span class="n">x_sym</span>
</span><span id="SymbolGeometry-126"><a href="#SymbolGeometry-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span> <span class="o">=</span> <span class="n">xi_sym</span>
</span><span id="SymbolGeometry-127"><a href="#SymbolGeometry-127"><span class="linenos">127</span></a>        
</span><span id="SymbolGeometry-128"><a href="#SymbolGeometry-128"><span class="linenos">128</span></a>        <span class="c1"># Compute derivatives symbolically (DRY principle)</span>
</span><span id="SymbolGeometry-129"><a href="#SymbolGeometry-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_derivatives</span><span class="p">()</span>
</span><span id="SymbolGeometry-130"><a href="#SymbolGeometry-130"><span class="linenos">130</span></a>        
</span><span id="SymbolGeometry-131"><a href="#SymbolGeometry-131"><span class="linenos">131</span></a>        <span class="c1"># Convert to numerical functions (cached)</span>
</span><span id="SymbolGeometry-132"><a href="#SymbolGeometry-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lambdify_functions</span><span class="p">()</span>
</span><span id="SymbolGeometry-133"><a href="#SymbolGeometry-133"><span class="linenos">133</span></a>    
</span><span id="SymbolGeometry-134"><a href="#SymbolGeometry-134"><span class="linenos">134</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SymbolGeometry-135"><a href="#SymbolGeometry-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute all necessary derivatives (DRY)&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-136"><a href="#SymbolGeometry-136"><span class="linenos">136</span></a>        <span class="n">dH_x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry-137"><a href="#SymbolGeometry-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dx</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_x</span><span class="p">)</span>
</span><span id="SymbolGeometry-138"><a href="#SymbolGeometry-138"><span class="linenos">138</span></a>        <span class="n">dH_xi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry-139"><a href="#SymbolGeometry-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_xi</span><span class="p">)</span>
</span><span id="SymbolGeometry-140"><a href="#SymbolGeometry-140"><span class="linenos">140</span></a>        <span class="n">d2H_x2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry-141"><a href="#SymbolGeometry-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dx2</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_x2</span><span class="p">)</span>        
</span><span id="SymbolGeometry-142"><a href="#SymbolGeometry-142"><span class="linenos">142</span></a>        <span class="n">d2H_xi2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry-143"><a href="#SymbolGeometry-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxi2</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xi2</span><span class="p">)</span>        
</span><span id="SymbolGeometry-144"><a href="#SymbolGeometry-144"><span class="linenos">144</span></a>        <span class="n">d2H_xxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry-145"><a href="#SymbolGeometry-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xxi</span><span class="p">)</span>
</span><span id="SymbolGeometry-146"><a href="#SymbolGeometry-146"><span class="linenos">146</span></a>    
</span><span id="SymbolGeometry-147"><a href="#SymbolGeometry-147"><span class="linenos">147</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_lambdify_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SymbolGeometry-148"><a href="#SymbolGeometry-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert symbolic expressions to numerical functions (DRY)&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-149"><a href="#SymbolGeometry-149"><span class="linenos">149</span></a>        <span class="n">vars_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry-150"><a href="#SymbolGeometry-150"><span class="linenos">150</span></a>        
</span><span id="SymbolGeometry-151"><a href="#SymbolGeometry-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">f_H</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">vars_tuple</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="SymbolGeometry-152"><a href="#SymbolGeometry-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">vars_tuple</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dH_dx</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="SymbolGeometry-153"><a href="#SymbolGeometry-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">vars_tuple</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="SymbolGeometry-154"><a href="#SymbolGeometry-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dx2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">vars_tuple</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dx2</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="SymbolGeometry-155"><a href="#SymbolGeometry-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxi2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">vars_tuple</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxi2</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="SymbolGeometry-156"><a href="#SymbolGeometry-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxdxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">vars_tuple</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</span><span id="SymbolGeometry-157"><a href="#SymbolGeometry-157"><span class="linenos">157</span></a>    
</span><span id="SymbolGeometry-158"><a href="#SymbolGeometry-158"><span class="linenos">158</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_geodesic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SymbolGeometry-159"><a href="#SymbolGeometry-159"><span class="linenos">159</span></a>                        <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Geodesic</span><span class="p">:</span>
</span><span id="SymbolGeometry-160"><a href="#SymbolGeometry-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-161"><a href="#SymbolGeometry-161"><span class="linenos">161</span></a><span class="sd">        Compute geodesic with Jacobian (for caustics detection)</span>
</span><span id="SymbolGeometry-162"><a href="#SymbolGeometry-162"><span class="linenos">162</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-163"><a href="#SymbolGeometry-163"><span class="linenos">163</span></a><span class="sd">        Solves the augmented system:</span>
</span><span id="SymbolGeometry-164"><a href="#SymbolGeometry-164"><span class="linenos">164</span></a><span class="sd">        dx/dt = ∂H/∂ξ</span>
</span><span id="SymbolGeometry-165"><a href="#SymbolGeometry-165"><span class="linenos">165</span></a><span class="sd">        dξ/dt = -∂H/∂x</span>
</span><span id="SymbolGeometry-166"><a href="#SymbolGeometry-166"><span class="linenos">166</span></a><span class="sd">        dJ/dt = ∂²H/∂ξ² J + ∂²H/∂x∂ξ K  (variational equation)</span>
</span><span id="SymbolGeometry-167"><a href="#SymbolGeometry-167"><span class="linenos">167</span></a><span class="sd">        dK/dt = -∂²H/∂x∂ξ J - ∂²H/∂x² K</span>
</span><span id="SymbolGeometry-168"><a href="#SymbolGeometry-168"><span class="linenos">168</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-169"><a href="#SymbolGeometry-169"><span class="linenos">169</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry-170"><a href="#SymbolGeometry-170"><span class="linenos">170</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry-171"><a href="#SymbolGeometry-171"><span class="linenos">171</span></a><span class="sd">        x0, xi0 : float</span>
</span><span id="SymbolGeometry-172"><a href="#SymbolGeometry-172"><span class="linenos">172</span></a><span class="sd">            Initial conditions</span>
</span><span id="SymbolGeometry-173"><a href="#SymbolGeometry-173"><span class="linenos">173</span></a><span class="sd">        t_max : float</span>
</span><span id="SymbolGeometry-174"><a href="#SymbolGeometry-174"><span class="linenos">174</span></a><span class="sd">            Final time</span>
</span><span id="SymbolGeometry-175"><a href="#SymbolGeometry-175"><span class="linenos">175</span></a><span class="sd">        n_points : int</span>
</span><span id="SymbolGeometry-176"><a href="#SymbolGeometry-176"><span class="linenos">176</span></a><span class="sd">            Number of points</span>
</span><span id="SymbolGeometry-177"><a href="#SymbolGeometry-177"><span class="linenos">177</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry-178"><a href="#SymbolGeometry-178"><span class="linenos">178</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry-179"><a href="#SymbolGeometry-179"><span class="linenos">179</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry-180"><a href="#SymbolGeometry-180"><span class="linenos">180</span></a><span class="sd">        Geodesic</span>
</span><span id="SymbolGeometry-181"><a href="#SymbolGeometry-181"><span class="linenos">181</span></a><span class="sd">            Complete geodesic information</span>
</span><span id="SymbolGeometry-182"><a href="#SymbolGeometry-182"><span class="linenos">182</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-183"><a href="#SymbolGeometry-183"><span class="linenos">183</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">system</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="SymbolGeometry-184"><a href="#SymbolGeometry-184"><span class="linenos">184</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">z</span>
</span><span id="SymbolGeometry-185"><a href="#SymbolGeometry-185"><span class="linenos">185</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry-186"><a href="#SymbolGeometry-186"><span class="linenos">186</span></a>                <span class="c1"># Hamilton equations</span>
</span><span id="SymbolGeometry-187"><a href="#SymbolGeometry-187"><span class="linenos">187</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dxi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-188"><a href="#SymbolGeometry-188"><span class="linenos">188</span></a>                <span class="n">dxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-189"><a href="#SymbolGeometry-189"><span class="linenos">189</span></a>                
</span><span id="SymbolGeometry-190"><a href="#SymbolGeometry-190"><span class="linenos">190</span></a>                <span class="c1"># Variational equations (Jacobian evolution)</span>
</span><span id="SymbolGeometry-191"><a href="#SymbolGeometry-191"><span class="linenos">191</span></a>                <span class="n">d2H_dxi2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxi2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-192"><a href="#SymbolGeometry-192"><span class="linenos">192</span></a>                <span class="n">d2H_dxdxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxdxi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-193"><a href="#SymbolGeometry-193"><span class="linenos">193</span></a>                <span class="n">d2H_dx2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dx2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-194"><a href="#SymbolGeometry-194"><span class="linenos">194</span></a>                
</span><span id="SymbolGeometry-195"><a href="#SymbolGeometry-195"><span class="linenos">195</span></a>                <span class="n">dJ</span> <span class="o">=</span> <span class="n">d2H_dxi2</span> <span class="o">*</span> <span class="n">J</span> <span class="o">+</span> <span class="n">d2H_dxdxi</span> <span class="o">*</span> <span class="n">K</span>
</span><span id="SymbolGeometry-196"><a href="#SymbolGeometry-196"><span class="linenos">196</span></a>                <span class="n">dK</span> <span class="o">=</span> <span class="o">-</span><span class="n">d2H_dxdxi</span> <span class="o">*</span> <span class="n">J</span> <span class="o">-</span> <span class="n">d2H_dx2</span> <span class="o">*</span> <span class="n">K</span>
</span><span id="SymbolGeometry-197"><a href="#SymbolGeometry-197"><span class="linenos">197</span></a>                
</span><span id="SymbolGeometry-198"><a href="#SymbolGeometry-198"><span class="linenos">198</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dxi</span><span class="p">,</span> <span class="n">dJ</span><span class="p">,</span> <span class="n">dK</span><span class="p">]</span>
</span><span id="SymbolGeometry-199"><a href="#SymbolGeometry-199"><span class="linenos">199</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry-200"><a href="#SymbolGeometry-200"><span class="linenos">200</span></a>                <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry-201"><a href="#SymbolGeometry-201"><span class="linenos">201</span></a>        
</span><span id="SymbolGeometry-202"><a href="#SymbolGeometry-202"><span class="linenos">202</span></a>        <span class="c1"># Initial conditions: J(0)=0, K(0)=1 (standard initial condition)</span>
</span><span id="SymbolGeometry-203"><a href="#SymbolGeometry-203"><span class="linenos">203</span></a>        <span class="n">z0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span><span id="SymbolGeometry-204"><a href="#SymbolGeometry-204"><span class="linenos">204</span></a>        
</span><span id="SymbolGeometry-205"><a href="#SymbolGeometry-205"><span class="linenos">205</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
</span><span id="SymbolGeometry-206"><a href="#SymbolGeometry-206"><span class="linenos">206</span></a>            <span class="n">system</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span>
</span><span id="SymbolGeometry-207"><a href="#SymbolGeometry-207"><span class="linenos">207</span></a>            <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_points</span><span class="p">),</span>
</span><span id="SymbolGeometry-208"><a href="#SymbolGeometry-208"><span class="linenos">208</span></a>            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;DOP853&#39;</span><span class="p">,</span>
</span><span id="SymbolGeometry-209"><a href="#SymbolGeometry-209"><span class="linenos">209</span></a>            <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span>
</span><span id="SymbolGeometry-210"><a href="#SymbolGeometry-210"><span class="linenos">210</span></a>        <span class="p">)</span>
</span><span id="SymbolGeometry-211"><a href="#SymbolGeometry-211"><span class="linenos">211</span></a>        
</span><span id="SymbolGeometry-212"><a href="#SymbolGeometry-212"><span class="linenos">212</span></a>        <span class="c1"># Compute energy along trajectory</span>
</span><span id="SymbolGeometry-213"><a href="#SymbolGeometry-213"><span class="linenos">213</span></a>        <span class="n">H_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">f_H</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> 
</span><span id="SymbolGeometry-214"><a href="#SymbolGeometry-214"><span class="linenos">214</span></a>                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">))])</span>
</span><span id="SymbolGeometry-215"><a href="#SymbolGeometry-215"><span class="linenos">215</span></a>        
</span><span id="SymbolGeometry-216"><a href="#SymbolGeometry-216"><span class="linenos">216</span></a>        <span class="k">return</span> <span class="n">Geodesic</span><span class="p">(</span>
</span><span id="SymbolGeometry-217"><a href="#SymbolGeometry-217"><span class="linenos">217</span></a>            <span class="n">t</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="SymbolGeometry-218"><a href="#SymbolGeometry-218"><span class="linenos">218</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="SymbolGeometry-219"><a href="#SymbolGeometry-219"><span class="linenos">219</span></a>            <span class="n">xi</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="SymbolGeometry-220"><a href="#SymbolGeometry-220"><span class="linenos">220</span></a>            <span class="n">H</span><span class="o">=</span><span class="n">H_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry-221"><a href="#SymbolGeometry-221"><span class="linenos">221</span></a>            <span class="n">J</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="SymbolGeometry-222"><a href="#SymbolGeometry-222"><span class="linenos">222</span></a>            <span class="n">K</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="SymbolGeometry-223"><a href="#SymbolGeometry-223"><span class="linenos">223</span></a>        <span class="p">)</span>
</span><span id="SymbolGeometry-224"><a href="#SymbolGeometry-224"><span class="linenos">224</span></a>    
</span><span id="SymbolGeometry-225"><a href="#SymbolGeometry-225"><span class="linenos">225</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_periodic_orbits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SymbolGeometry-226"><a href="#SymbolGeometry-226"><span class="linenos">226</span></a>                            <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry-227"><a href="#SymbolGeometry-227"><span class="linenos">227</span></a>                            <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry-228"><a href="#SymbolGeometry-228"><span class="linenos">228</span></a>                            <span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="SymbolGeometry-229"><a href="#SymbolGeometry-229"><span class="linenos">229</span></a>                            <span class="n">tol_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">]:</span>
</span><span id="SymbolGeometry-230"><a href="#SymbolGeometry-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-231"><a href="#SymbolGeometry-231"><span class="linenos">231</span></a><span class="sd">        Find periodic orbits at fixed energy</span>
</span><span id="SymbolGeometry-232"><a href="#SymbolGeometry-232"><span class="linenos">232</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-233"><a href="#SymbolGeometry-233"><span class="linenos">233</span></a><span class="sd">        Strategy: Sample energy surface H(x,ξ)=E and look for closed orbits</span>
</span><span id="SymbolGeometry-234"><a href="#SymbolGeometry-234"><span class="linenos">234</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-235"><a href="#SymbolGeometry-235"><span class="linenos">235</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry-236"><a href="#SymbolGeometry-236"><span class="linenos">236</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry-237"><a href="#SymbolGeometry-237"><span class="linenos">237</span></a><span class="sd">        energy : float</span>
</span><span id="SymbolGeometry-238"><a href="#SymbolGeometry-238"><span class="linenos">238</span></a><span class="sd">            Target energy level</span>
</span><span id="SymbolGeometry-239"><a href="#SymbolGeometry-239"><span class="linenos">239</span></a><span class="sd">        x_range, xi_range : tuple</span>
</span><span id="SymbolGeometry-240"><a href="#SymbolGeometry-240"><span class="linenos">240</span></a><span class="sd">            Search domain</span>
</span><span id="SymbolGeometry-241"><a href="#SymbolGeometry-241"><span class="linenos">241</span></a><span class="sd">        n_attempts : int</span>
</span><span id="SymbolGeometry-242"><a href="#SymbolGeometry-242"><span class="linenos">242</span></a><span class="sd">            Number of initial conditions to try</span>
</span><span id="SymbolGeometry-243"><a href="#SymbolGeometry-243"><span class="linenos">243</span></a><span class="sd">        tol_period : float</span>
</span><span id="SymbolGeometry-244"><a href="#SymbolGeometry-244"><span class="linenos">244</span></a><span class="sd">            Tolerance for periodicity detection</span>
</span><span id="SymbolGeometry-245"><a href="#SymbolGeometry-245"><span class="linenos">245</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry-246"><a href="#SymbolGeometry-246"><span class="linenos">246</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry-247"><a href="#SymbolGeometry-247"><span class="linenos">247</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry-248"><a href="#SymbolGeometry-248"><span class="linenos">248</span></a><span class="sd">        list of PeriodicOrbit</span>
</span><span id="SymbolGeometry-249"><a href="#SymbolGeometry-249"><span class="linenos">249</span></a><span class="sd">            Found periodic orbits</span>
</span><span id="SymbolGeometry-250"><a href="#SymbolGeometry-250"><span class="linenos">250</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-251"><a href="#SymbolGeometry-251"><span class="linenos">251</span></a>        <span class="n">orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry-252"><a href="#SymbolGeometry-252"><span class="linenos">252</span></a>        <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_attempts</span><span class="p">)))</span>
</span><span id="SymbolGeometry-253"><a href="#SymbolGeometry-253"><span class="linenos">253</span></a>        
</span><span id="SymbolGeometry-254"><a href="#SymbolGeometry-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">x0_test</span> <span class="ow">in</span> <span class="n">x_samples</span><span class="p">:</span>
</span><span id="SymbolGeometry-255"><a href="#SymbolGeometry-255"><span class="linenos">255</span></a>            <span class="c1"># Solve H(x0, ξ0) = E for ξ0</span>
</span><span id="SymbolGeometry-256"><a href="#SymbolGeometry-256"><span class="linenos">256</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">energy_eq</span><span class="p">(</span><span class="n">xi0</span><span class="p">):</span>
</span><span id="SymbolGeometry-257"><a href="#SymbolGeometry-257"><span class="linenos">257</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry-258"><a href="#SymbolGeometry-258"><span class="linenos">258</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_H</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span> <span class="o">-</span> <span class="n">energy</span>
</span><span id="SymbolGeometry-259"><a href="#SymbolGeometry-259"><span class="linenos">259</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry-260"><a href="#SymbolGeometry-260"><span class="linenos">260</span></a>                    <span class="k">return</span> <span class="mf">1e10</span>
</span><span id="SymbolGeometry-261"><a href="#SymbolGeometry-261"><span class="linenos">261</span></a>            
</span><span id="SymbolGeometry-262"><a href="#SymbolGeometry-262"><span class="linenos">262</span></a>            <span class="n">xi_guesses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolGeometry-263"><a href="#SymbolGeometry-263"><span class="linenos">263</span></a>            
</span><span id="SymbolGeometry-264"><a href="#SymbolGeometry-264"><span class="linenos">264</span></a>            <span class="k">for</span> <span class="n">xi_guess</span> <span class="ow">in</span> <span class="n">xi_guesses</span><span class="p">:</span>
</span><span id="SymbolGeometry-265"><a href="#SymbolGeometry-265"><span class="linenos">265</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry-266"><a href="#SymbolGeometry-266"><span class="linenos">266</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">energy_eq</span><span class="p">,</span> <span class="n">xi_guess</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SymbolGeometry-267"><a href="#SymbolGeometry-267"><span class="linenos">267</span></a>                    
</span><span id="SymbolGeometry-268"><a href="#SymbolGeometry-268"><span class="linenos">268</span></a>                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check convergence</span>
</span><span id="SymbolGeometry-269"><a href="#SymbolGeometry-269"><span class="linenos">269</span></a>                        <span class="k">continue</span>
</span><span id="SymbolGeometry-270"><a href="#SymbolGeometry-270"><span class="linenos">270</span></a>                    
</span><span id="SymbolGeometry-271"><a href="#SymbolGeometry-271"><span class="linenos">271</span></a>                    <span class="n">xi0</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry-272"><a href="#SymbolGeometry-272"><span class="linenos">272</span></a>                    
</span><span id="SymbolGeometry-273"><a href="#SymbolGeometry-273"><span class="linenos">273</span></a>                    <span class="c1"># Verify we&#39;re on energy surface</span>
</span><span id="SymbolGeometry-274"><a href="#SymbolGeometry-274"><span class="linenos">274</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_H</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
</span><span id="SymbolGeometry-275"><a href="#SymbolGeometry-275"><span class="linenos">275</span></a>                        <span class="k">continue</span>
</span><span id="SymbolGeometry-276"><a href="#SymbolGeometry-276"><span class="linenos">276</span></a>                    
</span><span id="SymbolGeometry-277"><a href="#SymbolGeometry-277"><span class="linenos">277</span></a>                    <span class="c1"># Integrate to detect periodicity</span>
</span><span id="SymbolGeometry-278"><a href="#SymbolGeometry-278"><span class="linenos">278</span></a>                    <span class="n">T_max</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="SymbolGeometry-279"><a href="#SymbolGeometry-279"><span class="linenos">279</span></a>                    <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">T_max</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
</span><span id="SymbolGeometry-280"><a href="#SymbolGeometry-280"><span class="linenos">280</span></a>                    
</span><span id="SymbolGeometry-281"><a href="#SymbolGeometry-281"><span class="linenos">281</span></a>                    <span class="c1"># Find returns to initial point</span>
</span><span id="SymbolGeometry-282"><a href="#SymbolGeometry-282"><span class="linenos">282</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0_test</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span> <span class="o">-</span> <span class="n">xi0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry-283"><a href="#SymbolGeometry-283"><span class="linenos">283</span></a>                    
</span><span id="SymbolGeometry-284"><a href="#SymbolGeometry-284"><span class="linenos">284</span></a>                    <span class="c1"># Find local minima (except t=0)</span>
</span><span id="SymbolGeometry-285"><a href="#SymbolGeometry-285"><span class="linenos">285</span></a>                    <span class="n">minima_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry-286"><a href="#SymbolGeometry-286"><span class="linenos">286</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">):</span>
</span><span id="SymbolGeometry-287"><a href="#SymbolGeometry-287"><span class="linenos">287</span></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> 
</span><span id="SymbolGeometry-288"><a href="#SymbolGeometry-288"><span class="linenos">288</span></a>                            <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
</span><span id="SymbolGeometry-289"><a href="#SymbolGeometry-289"><span class="linenos">289</span></a>                            <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol_period</span><span class="p">):</span>
</span><span id="SymbolGeometry-290"><a href="#SymbolGeometry-290"><span class="linenos">290</span></a>                            <span class="n">minima_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="SymbolGeometry-291"><a href="#SymbolGeometry-291"><span class="linenos">291</span></a>                    
</span><span id="SymbolGeometry-292"><a href="#SymbolGeometry-292"><span class="linenos">292</span></a>                    <span class="k">if</span> <span class="n">minima_idx</span><span class="p">:</span>
</span><span id="SymbolGeometry-293"><a href="#SymbolGeometry-293"><span class="linenos">293</span></a>                        <span class="n">idx_period</span> <span class="o">=</span> <span class="n">minima_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry-294"><a href="#SymbolGeometry-294"><span class="linenos">294</span></a>                        <span class="n">period</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_period</span><span class="p">]</span>
</span><span id="SymbolGeometry-295"><a href="#SymbolGeometry-295"><span class="linenos">295</span></a>                        
</span><span id="SymbolGeometry-296"><a href="#SymbolGeometry-296"><span class="linenos">296</span></a>                        <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">distances</span><span class="p">[</span><span class="n">idx_period</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol_period</span><span class="p">:</span>
</span><span id="SymbolGeometry-297"><a href="#SymbolGeometry-297"><span class="linenos">297</span></a>                            <span class="c1"># Compute action S = ∮ ξ dx</span>
</span><span id="SymbolGeometry-298"><a href="#SymbolGeometry-298"><span class="linenos">298</span></a>                            <span class="n">x_cycle</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">idx_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry-299"><a href="#SymbolGeometry-299"><span class="linenos">299</span></a>                            <span class="n">xi_cycle</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[:</span><span class="n">idx_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry-300"><a href="#SymbolGeometry-300"><span class="linenos">300</span></a>                            <span class="n">t_cycle</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="n">idx_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry-301"><a href="#SymbolGeometry-301"><span class="linenos">301</span></a>                            
</span><span id="SymbolGeometry-302"><a href="#SymbolGeometry-302"><span class="linenos">302</span></a>                            <span class="n">dx_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_cycle</span><span class="p">,</span> <span class="n">t_cycle</span><span class="p">)</span>
</span><span id="SymbolGeometry-303"><a href="#SymbolGeometry-303"><span class="linenos">303</span></a>                            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">xi_cycle</span> <span class="o">*</span> <span class="n">dx_dt</span><span class="p">,</span> <span class="n">t_cycle</span><span class="p">)</span>
</span><span id="SymbolGeometry-304"><a href="#SymbolGeometry-304"><span class="linenos">304</span></a>                            
</span><span id="SymbolGeometry-305"><a href="#SymbolGeometry-305"><span class="linenos">305</span></a>                            <span class="c1"># Compute stability (Lyapunov exponent)</span>
</span><span id="SymbolGeometry-306"><a href="#SymbolGeometry-306"><span class="linenos">306</span></a>                            <span class="n">stability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_stability</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</span><span id="SymbolGeometry-307"><a href="#SymbolGeometry-307"><span class="linenos">307</span></a>                            
</span><span id="SymbolGeometry-308"><a href="#SymbolGeometry-308"><span class="linenos">308</span></a>                            <span class="n">orbits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PeriodicOrbit</span><span class="p">(</span>
</span><span id="SymbolGeometry-309"><a href="#SymbolGeometry-309"><span class="linenos">309</span></a>                                <span class="n">x0</span><span class="o">=</span><span class="n">x0_test</span><span class="p">,</span>
</span><span id="SymbolGeometry-310"><a href="#SymbolGeometry-310"><span class="linenos">310</span></a>                                <span class="n">xi0</span><span class="o">=</span><span class="n">xi0</span><span class="p">,</span>
</span><span id="SymbolGeometry-311"><a href="#SymbolGeometry-311"><span class="linenos">311</span></a>                                <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
</span><span id="SymbolGeometry-312"><a href="#SymbolGeometry-312"><span class="linenos">312</span></a>                                <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
</span><span id="SymbolGeometry-313"><a href="#SymbolGeometry-313"><span class="linenos">313</span></a>                                <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
</span><span id="SymbolGeometry-314"><a href="#SymbolGeometry-314"><span class="linenos">314</span></a>                                <span class="n">stability</span><span class="o">=</span><span class="n">stability</span><span class="p">,</span>
</span><span id="SymbolGeometry-315"><a href="#SymbolGeometry-315"><span class="linenos">315</span></a>                                <span class="n">x_cycle</span><span class="o">=</span><span class="n">x_cycle</span><span class="p">,</span>
</span><span id="SymbolGeometry-316"><a href="#SymbolGeometry-316"><span class="linenos">316</span></a>                                <span class="n">xi_cycle</span><span class="o">=</span><span class="n">xi_cycle</span><span class="p">,</span>
</span><span id="SymbolGeometry-317"><a href="#SymbolGeometry-317"><span class="linenos">317</span></a>                                <span class="n">t_cycle</span><span class="o">=</span><span class="n">t_cycle</span>
</span><span id="SymbolGeometry-318"><a href="#SymbolGeometry-318"><span class="linenos">318</span></a>                            <span class="p">))</span>
</span><span id="SymbolGeometry-319"><a href="#SymbolGeometry-319"><span class="linenos">319</span></a>                
</span><span id="SymbolGeometry-320"><a href="#SymbolGeometry-320"><span class="linenos">320</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry-321"><a href="#SymbolGeometry-321"><span class="linenos">321</span></a>                    <span class="k">continue</span>
</span><span id="SymbolGeometry-322"><a href="#SymbolGeometry-322"><span class="linenos">322</span></a>        
</span><span id="SymbolGeometry-323"><a href="#SymbolGeometry-323"><span class="linenos">323</span></a>        <span class="c1"># Remove duplicates</span>
</span><span id="SymbolGeometry-324"><a href="#SymbolGeometry-324"><span class="linenos">324</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_duplicate_orbits</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span><span id="SymbolGeometry-325"><a href="#SymbolGeometry-325"><span class="linenos">325</span></a>    
</span><span id="SymbolGeometry-326"><a href="#SymbolGeometry-326"><span class="linenos">326</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SymbolGeometry-327"><a href="#SymbolGeometry-327"><span class="linenos">327</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Lyapunov exponent (orbit stability)&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-328"><a href="#SymbolGeometry-328"><span class="linenos">328</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">linearized_system</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="SymbolGeometry-329"><a href="#SymbolGeometry-329"><span class="linenos">329</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dxi</span> <span class="o">=</span> <span class="n">z</span>
</span><span id="SymbolGeometry-330"><a href="#SymbolGeometry-330"><span class="linenos">330</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry-331"><a href="#SymbolGeometry-331"><span class="linenos">331</span></a>                <span class="n">vx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dxi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-332"><a href="#SymbolGeometry-332"><span class="linenos">332</span></a>                <span class="n">vxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-333"><a href="#SymbolGeometry-333"><span class="linenos">333</span></a>                
</span><span id="SymbolGeometry-334"><a href="#SymbolGeometry-334"><span class="linenos">334</span></a>                <span class="c1"># Linearization</span>
</span><span id="SymbolGeometry-335"><a href="#SymbolGeometry-335"><span class="linenos">335</span></a>                <span class="n">A12</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxi2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-336"><a href="#SymbolGeometry-336"><span class="linenos">336</span></a>                <span class="n">A21</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxdxi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry-337"><a href="#SymbolGeometry-337"><span class="linenos">337</span></a>                
</span><span id="SymbolGeometry-338"><a href="#SymbolGeometry-338"><span class="linenos">338</span></a>                <span class="n">ddx</span> <span class="o">=</span> <span class="n">A12</span> <span class="o">*</span> <span class="n">dxi</span>
</span><span id="SymbolGeometry-339"><a href="#SymbolGeometry-339"><span class="linenos">339</span></a>                <span class="n">ddxi</span> <span class="o">=</span> <span class="n">A21</span> <span class="o">*</span> <span class="n">dx</span>
</span><span id="SymbolGeometry-340"><a href="#SymbolGeometry-340"><span class="linenos">340</span></a>                
</span><span id="SymbolGeometry-341"><a href="#SymbolGeometry-341"><span class="linenos">341</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">vxi</span><span class="p">,</span> <span class="n">ddx</span><span class="p">,</span> <span class="n">ddxi</span><span class="p">]</span>
</span><span id="SymbolGeometry-342"><a href="#SymbolGeometry-342"><span class="linenos">342</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry-343"><a href="#SymbolGeometry-343"><span class="linenos">343</span></a>                <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry-344"><a href="#SymbolGeometry-344"><span class="linenos">344</span></a>        
</span><span id="SymbolGeometry-345"><a href="#SymbolGeometry-345"><span class="linenos">345</span></a>        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="SymbolGeometry-346"><a href="#SymbolGeometry-346"><span class="linenos">346</span></a>        <span class="n">z0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry-347"><a href="#SymbolGeometry-347"><span class="linenos">347</span></a>        
</span><span id="SymbolGeometry-348"><a href="#SymbolGeometry-348"><span class="linenos">348</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">linearized_system</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;DOP853&#39;</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
</span><span id="SymbolGeometry-349"><a href="#SymbolGeometry-349"><span class="linenos">349</span></a>        
</span><span id="SymbolGeometry-350"><a href="#SymbolGeometry-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SymbolGeometry-351"><a href="#SymbolGeometry-351"><span class="linenos">351</span></a>            <span class="n">perturbation_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry-352"><a href="#SymbolGeometry-352"><span class="linenos">352</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">perturbation_final</span> <span class="o">/</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">/</span> <span class="n">T</span>
</span><span id="SymbolGeometry-353"><a href="#SymbolGeometry-353"><span class="linenos">353</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SymbolGeometry-354"><a href="#SymbolGeometry-354"><span class="linenos">354</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="SymbolGeometry-355"><a href="#SymbolGeometry-355"><span class="linenos">355</span></a>    
</span><span id="SymbolGeometry-356"><a href="#SymbolGeometry-356"><span class="linenos">356</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_duplicate_orbits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">]:</span>
</span><span id="SymbolGeometry-357"><a href="#SymbolGeometry-357"><span class="linenos">357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove duplicate periodic orbits&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-358"><a href="#SymbolGeometry-358"><span class="linenos">358</span></a>        <span class="n">unique</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry-359"><a href="#SymbolGeometry-359"><span class="linenos">359</span></a>        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits</span><span class="p">:</span>
</span><span id="SymbolGeometry-360"><a href="#SymbolGeometry-360"><span class="linenos">360</span></a>            <span class="n">is_duplicate</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SymbolGeometry-361"><a href="#SymbolGeometry-361"><span class="linenos">361</span></a>            <span class="k">for</span> <span class="n">orb_unique</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
</span><span id="SymbolGeometry-362"><a href="#SymbolGeometry-362"><span class="linenos">362</span></a>                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="n">orb_unique</span><span class="o">.</span><span class="n">period</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span>
</span><span id="SymbolGeometry-363"><a href="#SymbolGeometry-363"><span class="linenos">363</span></a>                    <span class="nb">abs</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="o">-</span> <span class="n">orb_unique</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">):</span>
</span><span id="SymbolGeometry-364"><a href="#SymbolGeometry-364"><span class="linenos">364</span></a>                    <span class="n">is_duplicate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SymbolGeometry-365"><a href="#SymbolGeometry-365"><span class="linenos">365</span></a>                    <span class="k">break</span>
</span><span id="SymbolGeometry-366"><a href="#SymbolGeometry-366"><span class="linenos">366</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_duplicate</span><span class="p">:</span>
</span><span id="SymbolGeometry-367"><a href="#SymbolGeometry-367"><span class="linenos">367</span></a>                <span class="n">unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb</span><span class="p">)</span>
</span><span id="SymbolGeometry-368"><a href="#SymbolGeometry-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="n">unique</span>
</span><span id="SymbolGeometry-369"><a href="#SymbolGeometry-369"><span class="linenos">369</span></a>    
</span><span id="SymbolGeometry-370"><a href="#SymbolGeometry-370"><span class="linenos">370</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gutzwiller_trace_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">],</span>
</span><span id="SymbolGeometry-371"><a href="#SymbolGeometry-371"><span class="linenos">371</span></a>                                 <span class="n">t_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="SymbolGeometry-372"><a href="#SymbolGeometry-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-373"><a href="#SymbolGeometry-373"><span class="linenos">373</span></a><span class="sd">        Gutzwiller trace formula (semiclassical)</span>
</span><span id="SymbolGeometry-374"><a href="#SymbolGeometry-374"><span class="linenos">374</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-375"><a href="#SymbolGeometry-375"><span class="linenos">375</span></a><span class="sd">        Tr[exp(-iHt/ℏ)] ≈ Σ_γ A_γ exp(iS_γ/ℏ - iπμ_γ/2)</span>
</span><span id="SymbolGeometry-376"><a href="#SymbolGeometry-376"><span class="linenos">376</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-377"><a href="#SymbolGeometry-377"><span class="linenos">377</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry-378"><a href="#SymbolGeometry-378"><span class="linenos">378</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry-379"><a href="#SymbolGeometry-379"><span class="linenos">379</span></a><span class="sd">        periodic_orbits : list</span>
</span><span id="SymbolGeometry-380"><a href="#SymbolGeometry-380"><span class="linenos">380</span></a><span class="sd">            List of periodic orbits</span>
</span><span id="SymbolGeometry-381"><a href="#SymbolGeometry-381"><span class="linenos">381</span></a><span class="sd">        t_values : array</span>
</span><span id="SymbolGeometry-382"><a href="#SymbolGeometry-382"><span class="linenos">382</span></a><span class="sd">            Time values</span>
</span><span id="SymbolGeometry-383"><a href="#SymbolGeometry-383"><span class="linenos">383</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolGeometry-384"><a href="#SymbolGeometry-384"><span class="linenos">384</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolGeometry-385"><a href="#SymbolGeometry-385"><span class="linenos">385</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry-386"><a href="#SymbolGeometry-386"><span class="linenos">386</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry-387"><a href="#SymbolGeometry-387"><span class="linenos">387</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry-388"><a href="#SymbolGeometry-388"><span class="linenos">388</span></a><span class="sd">        array</span>
</span><span id="SymbolGeometry-389"><a href="#SymbolGeometry-389"><span class="linenos">389</span></a><span class="sd">            Trace as function of time</span>
</span><span id="SymbolGeometry-390"><a href="#SymbolGeometry-390"><span class="linenos">390</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-391"><a href="#SymbolGeometry-391"><span class="linenos">391</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
</span><span id="SymbolGeometry-392"><a href="#SymbolGeometry-392"><span class="linenos">392</span></a>        
</span><span id="SymbolGeometry-393"><a href="#SymbolGeometry-393"><span class="linenos">393</span></a>        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolGeometry-394"><a href="#SymbolGeometry-394"><span class="linenos">394</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">period</span>
</span><span id="SymbolGeometry-395"><a href="#SymbolGeometry-395"><span class="linenos">395</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">action</span>
</span><span id="SymbolGeometry-396"><a href="#SymbolGeometry-396"><span class="linenos">396</span></a>            <span class="n">lambda_stab</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">stability</span>
</span><span id="SymbolGeometry-397"><a href="#SymbolGeometry-397"><span class="linenos">397</span></a>            
</span><span id="SymbolGeometry-398"><a href="#SymbolGeometry-398"><span class="linenos">398</span></a>            <span class="c1"># ✅ CORRECTION 1 : Plus de répétitions (jusqu&#39;à 10)</span>
</span><span id="SymbolGeometry-399"><a href="#SymbolGeometry-399"><span class="linenos">399</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># 1 → 11 (au lieu de 5)</span>
</span><span id="SymbolGeometry-400"><a href="#SymbolGeometry-400"><span class="linenos">400</span></a>                <span class="n">T_k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">T</span>
</span><span id="SymbolGeometry-401"><a href="#SymbolGeometry-401"><span class="linenos">401</span></a>                <span class="n">S_k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">S</span>
</span><span id="SymbolGeometry-402"><a href="#SymbolGeometry-402"><span class="linenos">402</span></a>                
</span><span id="SymbolGeometry-403"><a href="#SymbolGeometry-403"><span class="linenos">403</span></a>                <span class="c1"># Stability factor</span>
</span><span id="SymbolGeometry-404"><a href="#SymbolGeometry-404"><span class="linenos">404</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lambda_stab</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lambda_stab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
</span><span id="SymbolGeometry-405"><a href="#SymbolGeometry-405"><span class="linenos">405</span></a>                    <span class="n">det_factor</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">lambda_stab</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
</span><span id="SymbolGeometry-406"><a href="#SymbolGeometry-406"><span class="linenos">406</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SymbolGeometry-407"><a href="#SymbolGeometry-407"><span class="linenos">407</span></a>                    <span class="n">det_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SymbolGeometry-408"><a href="#SymbolGeometry-408"><span class="linenos">408</span></a>                
</span><span id="SymbolGeometry-409"><a href="#SymbolGeometry-409"><span class="linenos">409</span></a>                <span class="k">if</span> <span class="n">det_factor</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="SymbolGeometry-410"><a href="#SymbolGeometry-410"><span class="linenos">410</span></a>                    <span class="n">det_factor</span> <span class="o">=</span> <span class="mf">1e-10</span>  <span class="c1"># Évite division par zéro</span>
</span><span id="SymbolGeometry-411"><a href="#SymbolGeometry-411"><span class="linenos">411</span></a>                
</span><span id="SymbolGeometry-412"><a href="#SymbolGeometry-412"><span class="linenos">412</span></a>                <span class="c1"># ✅ CORRECTION 2 : Amplitude normalisée</span>
</span><span id="SymbolGeometry-413"><a href="#SymbolGeometry-413"><span class="linenos">413</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">det_factor</span><span class="p">)</span>
</span><span id="SymbolGeometry-414"><a href="#SymbolGeometry-414"><span class="linenos">414</span></a>                
</span><span id="SymbolGeometry-415"><a href="#SymbolGeometry-415"><span class="linenos">415</span></a>                <span class="c1"># Maslov index (0 pour oscillateur harmonique)</span>
</span><span id="SymbolGeometry-416"><a href="#SymbolGeometry-416"><span class="linenos">416</span></a>                <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SymbolGeometry-417"><a href="#SymbolGeometry-417"><span class="linenos">417</span></a>                
</span><span id="SymbolGeometry-418"><a href="#SymbolGeometry-418"><span class="linenos">418</span></a>                <span class="c1"># ✅ CORRECTION 3 : Pic delta au lieu de sinc</span>
</span><span id="SymbolGeometry-419"><a href="#SymbolGeometry-419"><span class="linenos">419</span></a>                <span class="c1"># Utiliser une gaussienne étroite centrée sur T_k</span>
</span><span id="SymbolGeometry-420"><a href="#SymbolGeometry-420"><span class="linenos">420</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">*</span> <span class="mf">0.05</span>  <span class="c1"># Largeur 5% de la période</span>
</span><span id="SymbolGeometry-421"><a href="#SymbolGeometry-421"><span class="linenos">421</span></a>                <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">t_values</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="SymbolGeometry-422"><a href="#SymbolGeometry-422"><span class="linenos">422</span></a>                <span class="n">gauss</span> <span class="o">/=</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>  <span class="c1"># Normalisation</span>
</span><span id="SymbolGeometry-423"><a href="#SymbolGeometry-423"><span class="linenos">423</span></a>                
</span><span id="SymbolGeometry-424"><a href="#SymbolGeometry-424"><span class="linenos">424</span></a>                <span class="n">phase</span> <span class="o">=</span> <span class="n">S_k</span> <span class="o">/</span> <span class="n">hbar</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="SymbolGeometry-425"><a href="#SymbolGeometry-425"><span class="linenos">425</span></a>                <span class="n">contribution</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">gauss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phase</span><span class="p">)</span>
</span><span id="SymbolGeometry-426"><a href="#SymbolGeometry-426"><span class="linenos">426</span></a>                
</span><span id="SymbolGeometry-427"><a href="#SymbolGeometry-427"><span class="linenos">427</span></a>                <span class="c1"># ✅ CORRECTION 4 : Facteur d&#39;amortissement pour grandes répétitions</span>
</span><span id="SymbolGeometry-428"><a href="#SymbolGeometry-428"><span class="linenos">428</span></a>                <span class="n">damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># Atténue les contributions lointaines</span>
</span><span id="SymbolGeometry-429"><a href="#SymbolGeometry-429"><span class="linenos">429</span></a>                <span class="n">trace</span> <span class="o">+=</span> <span class="n">contribution</span> <span class="o">*</span> <span class="n">damping</span>
</span><span id="SymbolGeometry-430"><a href="#SymbolGeometry-430"><span class="linenos">430</span></a>        
</span><span id="SymbolGeometry-431"><a href="#SymbolGeometry-431"><span class="linenos">431</span></a>        <span class="k">return</span> <span class="n">trace</span>
</span><span id="SymbolGeometry-432"><a href="#SymbolGeometry-432"><span class="linenos">432</span></a>    
</span><span id="SymbolGeometry-433"><a href="#SymbolGeometry-433"><span class="linenos">433</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">semiclassical_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">],</span>
</span><span id="SymbolGeometry-434"><a href="#SymbolGeometry-434"><span class="linenos">434</span></a>                              <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
</span><span id="SymbolGeometry-435"><a href="#SymbolGeometry-435"><span class="linenos">435</span></a>                              <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Spectrum</span><span class="p">:</span>  <span class="c1"># ✅ 1000 → 4000</span>
</span><span id="SymbolGeometry-436"><a href="#SymbolGeometry-436"><span class="linenos">436</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry-437"><a href="#SymbolGeometry-437"><span class="linenos">437</span></a><span class="sd">        Extract semiclassical spectrum via Fourier transform of trace</span>
</span><span id="SymbolGeometry-438"><a href="#SymbolGeometry-438"><span class="linenos">438</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry-439"><a href="#SymbolGeometry-439"><span class="linenos">439</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry-440"><a href="#SymbolGeometry-440"><span class="linenos">440</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry-441"><a href="#SymbolGeometry-441"><span class="linenos">441</span></a><span class="sd">        periodic_orbits : list</span>
</span><span id="SymbolGeometry-442"><a href="#SymbolGeometry-442"><span class="linenos">442</span></a><span class="sd">            Periodic orbits</span>
</span><span id="SymbolGeometry-443"><a href="#SymbolGeometry-443"><span class="linenos">443</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolGeometry-444"><a href="#SymbolGeometry-444"><span class="linenos">444</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolGeometry-445"><a href="#SymbolGeometry-445"><span class="linenos">445</span></a><span class="sd">        resolution : int</span>
</span><span id="SymbolGeometry-446"><a href="#SymbolGeometry-446"><span class="linenos">446</span></a><span class="sd">            Number of points</span>
</span><span id="SymbolGeometry-447"><a href="#SymbolGeometry-447"><span class="linenos">447</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry-448"><a href="#SymbolGeometry-448"><span class="linenos">448</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry-449"><a href="#SymbolGeometry-449"><span class="linenos">449</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry-450"><a href="#SymbolGeometry-450"><span class="linenos">450</span></a><span class="sd">        Spectrum</span>
</span><span id="SymbolGeometry-451"><a href="#SymbolGeometry-451"><span class="linenos">451</span></a><span class="sd">            Spectral information</span>
</span><span id="SymbolGeometry-452"><a href="#SymbolGeometry-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>        
</span><span id="SymbolGeometry-453"><a href="#SymbolGeometry-453"><span class="linenos">453</span></a>        <span class="c1"># ✅ Temps d&#39;intégration plus long</span>
</span><span id="SymbolGeometry-454"><a href="#SymbolGeometry-454"><span class="linenos">454</span></a>        <span class="n">t_max</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">/</span> <span class="n">hbar</span>  <span class="c1"># 50 → 200</span>
</span><span id="SymbolGeometry-455"><a href="#SymbolGeometry-455"><span class="linenos">455</span></a>        <span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="SymbolGeometry-456"><a href="#SymbolGeometry-456"><span class="linenos">456</span></a>        
</span><span id="SymbolGeometry-457"><a href="#SymbolGeometry-457"><span class="linenos">457</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gutzwiller_trace_formula</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">t_values</span><span class="p">,</span> <span class="n">hbar</span><span class="p">)</span>
</span><span id="SymbolGeometry-458"><a href="#SymbolGeometry-458"><span class="linenos">458</span></a>        
</span><span id="SymbolGeometry-459"><a href="#SymbolGeometry-459"><span class="linenos">459</span></a>        <span class="c1"># Fourier transform: t → E</span>
</span><span id="SymbolGeometry-460"><a href="#SymbolGeometry-460"><span class="linenos">460</span></a>        <span class="n">energies_fft</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">),</span> <span class="n">d</span><span class="o">=</span><span class="n">t_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hbar</span>
</span><span id="SymbolGeometry-461"><a href="#SymbolGeometry-461"><span class="linenos">461</span></a>        <span class="n">spectrum_fft</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</span><span id="SymbolGeometry-462"><a href="#SymbolGeometry-462"><span class="linenos">462</span></a>        
</span><span id="SymbolGeometry-463"><a href="#SymbolGeometry-463"><span class="linenos">463</span></a>        <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span>
</span><span id="SymbolGeometry-464"><a href="#SymbolGeometry-464"><span class="linenos">464</span></a>            <span class="n">energies</span><span class="o">=</span><span class="n">energies_fft</span><span class="p">,</span>
</span><span id="SymbolGeometry-465"><a href="#SymbolGeometry-465"><span class="linenos">465</span></a>            <span class="n">intensity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum_fft</span><span class="p">),</span>
</span><span id="SymbolGeometry-466"><a href="#SymbolGeometry-466"><span class="linenos">466</span></a>            <span class="n">trace_t</span><span class="o">=</span><span class="n">t_values</span><span class="p">,</span>
</span><span id="SymbolGeometry-467"><a href="#SymbolGeometry-467"><span class="linenos">467</span></a>            <span class="n">trace</span><span class="o">=</span><span class="n">trace</span>
</span><span id="SymbolGeometry-468"><a href="#SymbolGeometry-468"><span class="linenos">468</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Analyzes the geometric structure of a symbol H(x, ξ)</p>

<p>This class computes:</p>

<ul>
<li>Hamiltonian flow (geodesics)</li>
<li>Jacobian (focusing)</li>
<li>Caustics (singularities)</li>
<li>Periodic orbits</li>
<li>Semiclassical spectrum</li>
</ul>
</div>


                            <div id="SymbolGeometry.__init__" class="classattr">
                                        <input id="SymbolGeometry.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SymbolGeometry</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">symbol</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expr</span>,</span><span class="param">	<span class="n">x_sym</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">xi_sym</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span></span>)</span>

                <label class="view-source-button" for="SymbolGeometry.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry.__init__-113"><a href="#SymbolGeometry.__init__-113"><span class="linenos">113</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">x_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">xi_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">):</span>
</span><span id="SymbolGeometry.__init__-114"><a href="#SymbolGeometry.__init__-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.__init__-115"><a href="#SymbolGeometry.__init__-115"><span class="linenos">115</span></a><span class="sd">        Initialize with a symbolic Hamiltonian</span>
</span><span id="SymbolGeometry.__init__-116"><a href="#SymbolGeometry.__init__-116"><span class="linenos">116</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.__init__-117"><a href="#SymbolGeometry.__init__-117"><span class="linenos">117</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry.__init__-118"><a href="#SymbolGeometry.__init__-118"><span class="linenos">118</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry.__init__-119"><a href="#SymbolGeometry.__init__-119"><span class="linenos">119</span></a><span class="sd">        symbol : sympy expression</span>
</span><span id="SymbolGeometry.__init__-120"><a href="#SymbolGeometry.__init__-120"><span class="linenos">120</span></a><span class="sd">            The Hamiltonian H(x, ξ)</span>
</span><span id="SymbolGeometry.__init__-121"><a href="#SymbolGeometry.__init__-121"><span class="linenos">121</span></a><span class="sd">        x_sym, xi_sym : sympy symbols</span>
</span><span id="SymbolGeometry.__init__-122"><a href="#SymbolGeometry.__init__-122"><span class="linenos">122</span></a><span class="sd">            Position and momentum variables</span>
</span><span id="SymbolGeometry.__init__-123"><a href="#SymbolGeometry.__init__-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.__init__-124"><a href="#SymbolGeometry.__init__-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="SymbolGeometry.__init__-125"><a href="#SymbolGeometry.__init__-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span> <span class="o">=</span> <span class="n">x_sym</span>
</span><span id="SymbolGeometry.__init__-126"><a href="#SymbolGeometry.__init__-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span> <span class="o">=</span> <span class="n">xi_sym</span>
</span><span id="SymbolGeometry.__init__-127"><a href="#SymbolGeometry.__init__-127"><span class="linenos">127</span></a>        
</span><span id="SymbolGeometry.__init__-128"><a href="#SymbolGeometry.__init__-128"><span class="linenos">128</span></a>        <span class="c1"># Compute derivatives symbolically (DRY principle)</span>
</span><span id="SymbolGeometry.__init__-129"><a href="#SymbolGeometry.__init__-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_derivatives</span><span class="p">()</span>
</span><span id="SymbolGeometry.__init__-130"><a href="#SymbolGeometry.__init__-130"><span class="linenos">130</span></a>        
</span><span id="SymbolGeometry.__init__-131"><a href="#SymbolGeometry.__init__-131"><span class="linenos">131</span></a>        <span class="c1"># Convert to numerical functions (cached)</span>
</span><span id="SymbolGeometry.__init__-132"><a href="#SymbolGeometry.__init__-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lambdify_functions</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize with a symbolic Hamiltonian</p>

<h2 id="parameters">Parameters</h2>

<p>symbol : sympy expression
    The Hamiltonian H(x, ξ)
x_sym, xi_sym : sympy symbols
    Position and momentum variables</p>
</div>


                            </div>
                            <div id="SymbolGeometry.H" class="classattr">
                                <div class="attr variable">
            <span class="name">H</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry.H"></a>
    
    

                            </div>
                            <div id="SymbolGeometry.x_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">x_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry.x_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry.xi_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">xi_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry.xi_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry.compute_geodesic" class="classattr">
                                        <input id="SymbolGeometry.compute_geodesic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_geodesic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x0</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span></span><span class="return-annotation">) -> <span class="n">src</span><span class="o">.</span><span class="n">geometry_1d</span><span class="o">.</span><span class="n">Geodesic</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry.compute_geodesic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry.compute_geodesic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry.compute_geodesic-158"><a href="#SymbolGeometry.compute_geodesic-158"><span class="linenos">158</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_geodesic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SymbolGeometry.compute_geodesic-159"><a href="#SymbolGeometry.compute_geodesic-159"><span class="linenos">159</span></a>                        <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Geodesic</span><span class="p">:</span>
</span><span id="SymbolGeometry.compute_geodesic-160"><a href="#SymbolGeometry.compute_geodesic-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.compute_geodesic-161"><a href="#SymbolGeometry.compute_geodesic-161"><span class="linenos">161</span></a><span class="sd">        Compute geodesic with Jacobian (for caustics detection)</span>
</span><span id="SymbolGeometry.compute_geodesic-162"><a href="#SymbolGeometry.compute_geodesic-162"><span class="linenos">162</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.compute_geodesic-163"><a href="#SymbolGeometry.compute_geodesic-163"><span class="linenos">163</span></a><span class="sd">        Solves the augmented system:</span>
</span><span id="SymbolGeometry.compute_geodesic-164"><a href="#SymbolGeometry.compute_geodesic-164"><span class="linenos">164</span></a><span class="sd">        dx/dt = ∂H/∂ξ</span>
</span><span id="SymbolGeometry.compute_geodesic-165"><a href="#SymbolGeometry.compute_geodesic-165"><span class="linenos">165</span></a><span class="sd">        dξ/dt = -∂H/∂x</span>
</span><span id="SymbolGeometry.compute_geodesic-166"><a href="#SymbolGeometry.compute_geodesic-166"><span class="linenos">166</span></a><span class="sd">        dJ/dt = ∂²H/∂ξ² J + ∂²H/∂x∂ξ K  (variational equation)</span>
</span><span id="SymbolGeometry.compute_geodesic-167"><a href="#SymbolGeometry.compute_geodesic-167"><span class="linenos">167</span></a><span class="sd">        dK/dt = -∂²H/∂x∂ξ J - ∂²H/∂x² K</span>
</span><span id="SymbolGeometry.compute_geodesic-168"><a href="#SymbolGeometry.compute_geodesic-168"><span class="linenos">168</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.compute_geodesic-169"><a href="#SymbolGeometry.compute_geodesic-169"><span class="linenos">169</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry.compute_geodesic-170"><a href="#SymbolGeometry.compute_geodesic-170"><span class="linenos">170</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry.compute_geodesic-171"><a href="#SymbolGeometry.compute_geodesic-171"><span class="linenos">171</span></a><span class="sd">        x0, xi0 : float</span>
</span><span id="SymbolGeometry.compute_geodesic-172"><a href="#SymbolGeometry.compute_geodesic-172"><span class="linenos">172</span></a><span class="sd">            Initial conditions</span>
</span><span id="SymbolGeometry.compute_geodesic-173"><a href="#SymbolGeometry.compute_geodesic-173"><span class="linenos">173</span></a><span class="sd">        t_max : float</span>
</span><span id="SymbolGeometry.compute_geodesic-174"><a href="#SymbolGeometry.compute_geodesic-174"><span class="linenos">174</span></a><span class="sd">            Final time</span>
</span><span id="SymbolGeometry.compute_geodesic-175"><a href="#SymbolGeometry.compute_geodesic-175"><span class="linenos">175</span></a><span class="sd">        n_points : int</span>
</span><span id="SymbolGeometry.compute_geodesic-176"><a href="#SymbolGeometry.compute_geodesic-176"><span class="linenos">176</span></a><span class="sd">            Number of points</span>
</span><span id="SymbolGeometry.compute_geodesic-177"><a href="#SymbolGeometry.compute_geodesic-177"><span class="linenos">177</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry.compute_geodesic-178"><a href="#SymbolGeometry.compute_geodesic-178"><span class="linenos">178</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry.compute_geodesic-179"><a href="#SymbolGeometry.compute_geodesic-179"><span class="linenos">179</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry.compute_geodesic-180"><a href="#SymbolGeometry.compute_geodesic-180"><span class="linenos">180</span></a><span class="sd">        Geodesic</span>
</span><span id="SymbolGeometry.compute_geodesic-181"><a href="#SymbolGeometry.compute_geodesic-181"><span class="linenos">181</span></a><span class="sd">            Complete geodesic information</span>
</span><span id="SymbolGeometry.compute_geodesic-182"><a href="#SymbolGeometry.compute_geodesic-182"><span class="linenos">182</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.compute_geodesic-183"><a href="#SymbolGeometry.compute_geodesic-183"><span class="linenos">183</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">system</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="SymbolGeometry.compute_geodesic-184"><a href="#SymbolGeometry.compute_geodesic-184"><span class="linenos">184</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">z</span>
</span><span id="SymbolGeometry.compute_geodesic-185"><a href="#SymbolGeometry.compute_geodesic-185"><span class="linenos">185</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry.compute_geodesic-186"><a href="#SymbolGeometry.compute_geodesic-186"><span class="linenos">186</span></a>                <span class="c1"># Hamilton equations</span>
</span><span id="SymbolGeometry.compute_geodesic-187"><a href="#SymbolGeometry.compute_geodesic-187"><span class="linenos">187</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dxi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry.compute_geodesic-188"><a href="#SymbolGeometry.compute_geodesic-188"><span class="linenos">188</span></a>                <span class="n">dxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f_dH_dx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry.compute_geodesic-189"><a href="#SymbolGeometry.compute_geodesic-189"><span class="linenos">189</span></a>                
</span><span id="SymbolGeometry.compute_geodesic-190"><a href="#SymbolGeometry.compute_geodesic-190"><span class="linenos">190</span></a>                <span class="c1"># Variational equations (Jacobian evolution)</span>
</span><span id="SymbolGeometry.compute_geodesic-191"><a href="#SymbolGeometry.compute_geodesic-191"><span class="linenos">191</span></a>                <span class="n">d2H_dxi2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxi2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry.compute_geodesic-192"><a href="#SymbolGeometry.compute_geodesic-192"><span class="linenos">192</span></a>                <span class="n">d2H_dxdxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dxdxi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry.compute_geodesic-193"><a href="#SymbolGeometry.compute_geodesic-193"><span class="linenos">193</span></a>                <span class="n">d2H_dx2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_d2H_dx2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
</span><span id="SymbolGeometry.compute_geodesic-194"><a href="#SymbolGeometry.compute_geodesic-194"><span class="linenos">194</span></a>                
</span><span id="SymbolGeometry.compute_geodesic-195"><a href="#SymbolGeometry.compute_geodesic-195"><span class="linenos">195</span></a>                <span class="n">dJ</span> <span class="o">=</span> <span class="n">d2H_dxi2</span> <span class="o">*</span> <span class="n">J</span> <span class="o">+</span> <span class="n">d2H_dxdxi</span> <span class="o">*</span> <span class="n">K</span>
</span><span id="SymbolGeometry.compute_geodesic-196"><a href="#SymbolGeometry.compute_geodesic-196"><span class="linenos">196</span></a>                <span class="n">dK</span> <span class="o">=</span> <span class="o">-</span><span class="n">d2H_dxdxi</span> <span class="o">*</span> <span class="n">J</span> <span class="o">-</span> <span class="n">d2H_dx2</span> <span class="o">*</span> <span class="n">K</span>
</span><span id="SymbolGeometry.compute_geodesic-197"><a href="#SymbolGeometry.compute_geodesic-197"><span class="linenos">197</span></a>                
</span><span id="SymbolGeometry.compute_geodesic-198"><a href="#SymbolGeometry.compute_geodesic-198"><span class="linenos">198</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dxi</span><span class="p">,</span> <span class="n">dJ</span><span class="p">,</span> <span class="n">dK</span><span class="p">]</span>
</span><span id="SymbolGeometry.compute_geodesic-199"><a href="#SymbolGeometry.compute_geodesic-199"><span class="linenos">199</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry.compute_geodesic-200"><a href="#SymbolGeometry.compute_geodesic-200"><span class="linenos">200</span></a>                <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry.compute_geodesic-201"><a href="#SymbolGeometry.compute_geodesic-201"><span class="linenos">201</span></a>        
</span><span id="SymbolGeometry.compute_geodesic-202"><a href="#SymbolGeometry.compute_geodesic-202"><span class="linenos">202</span></a>        <span class="c1"># Initial conditions: J(0)=0, K(0)=1 (standard initial condition)</span>
</span><span id="SymbolGeometry.compute_geodesic-203"><a href="#SymbolGeometry.compute_geodesic-203"><span class="linenos">203</span></a>        <span class="n">z0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span><span id="SymbolGeometry.compute_geodesic-204"><a href="#SymbolGeometry.compute_geodesic-204"><span class="linenos">204</span></a>        
</span><span id="SymbolGeometry.compute_geodesic-205"><a href="#SymbolGeometry.compute_geodesic-205"><span class="linenos">205</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
</span><span id="SymbolGeometry.compute_geodesic-206"><a href="#SymbolGeometry.compute_geodesic-206"><span class="linenos">206</span></a>            <span class="n">system</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span>
</span><span id="SymbolGeometry.compute_geodesic-207"><a href="#SymbolGeometry.compute_geodesic-207"><span class="linenos">207</span></a>            <span class="n">t_eval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_points</span><span class="p">),</span>
</span><span id="SymbolGeometry.compute_geodesic-208"><a href="#SymbolGeometry.compute_geodesic-208"><span class="linenos">208</span></a>            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;DOP853&#39;</span><span class="p">,</span>
</span><span id="SymbolGeometry.compute_geodesic-209"><a href="#SymbolGeometry.compute_geodesic-209"><span class="linenos">209</span></a>            <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span>
</span><span id="SymbolGeometry.compute_geodesic-210"><a href="#SymbolGeometry.compute_geodesic-210"><span class="linenos">210</span></a>        <span class="p">)</span>
</span><span id="SymbolGeometry.compute_geodesic-211"><a href="#SymbolGeometry.compute_geodesic-211"><span class="linenos">211</span></a>        
</span><span id="SymbolGeometry.compute_geodesic-212"><a href="#SymbolGeometry.compute_geodesic-212"><span class="linenos">212</span></a>        <span class="c1"># Compute energy along trajectory</span>
</span><span id="SymbolGeometry.compute_geodesic-213"><a href="#SymbolGeometry.compute_geodesic-213"><span class="linenos">213</span></a>        <span class="n">H_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">f_H</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> 
</span><span id="SymbolGeometry.compute_geodesic-214"><a href="#SymbolGeometry.compute_geodesic-214"><span class="linenos">214</span></a>                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">))])</span>
</span><span id="SymbolGeometry.compute_geodesic-215"><a href="#SymbolGeometry.compute_geodesic-215"><span class="linenos">215</span></a>        
</span><span id="SymbolGeometry.compute_geodesic-216"><a href="#SymbolGeometry.compute_geodesic-216"><span class="linenos">216</span></a>        <span class="k">return</span> <span class="n">Geodesic</span><span class="p">(</span>
</span><span id="SymbolGeometry.compute_geodesic-217"><a href="#SymbolGeometry.compute_geodesic-217"><span class="linenos">217</span></a>            <span class="n">t</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="SymbolGeometry.compute_geodesic-218"><a href="#SymbolGeometry.compute_geodesic-218"><span class="linenos">218</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="SymbolGeometry.compute_geodesic-219"><a href="#SymbolGeometry.compute_geodesic-219"><span class="linenos">219</span></a>            <span class="n">xi</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="SymbolGeometry.compute_geodesic-220"><a href="#SymbolGeometry.compute_geodesic-220"><span class="linenos">220</span></a>            <span class="n">H</span><span class="o">=</span><span class="n">H_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry.compute_geodesic-221"><a href="#SymbolGeometry.compute_geodesic-221"><span class="linenos">221</span></a>            <span class="n">J</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="SymbolGeometry.compute_geodesic-222"><a href="#SymbolGeometry.compute_geodesic-222"><span class="linenos">222</span></a>            <span class="n">K</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="SymbolGeometry.compute_geodesic-223"><a href="#SymbolGeometry.compute_geodesic-223"><span class="linenos">223</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute geodesic with Jacobian (for caustics detection)</p>

<p>Solves the augmented system:
dx/dt = ∂H/∂ξ
dξ/dt = -∂H/∂x
dJ/dt = ∂²H/∂ξ² J + ∂²H/∂x∂ξ K  (variational equation)
dK/dt = -∂²H/∂x∂ξ J - ∂²H/∂x² K</p>

<h2 id="parameters">Parameters</h2>

<p>x0, xi0 : float
    Initial conditions
t_max : float
    Final time
n_points : int
    Number of points</p>

<h2 id="returns">Returns</h2>

<p>Geodesic
    Complete geodesic information</p>
</div>


                            </div>
                            <div id="SymbolGeometry.find_periodic_orbits" class="classattr">
                                        <input id="SymbolGeometry.find_periodic_orbits-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_periodic_orbits</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">tol_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_1d</span><span class="o">.</span><span class="n">PeriodicOrbit</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry.find_periodic_orbits-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry.find_periodic_orbits"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry.find_periodic_orbits-225"><a href="#SymbolGeometry.find_periodic_orbits-225"><span class="linenos">225</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_periodic_orbits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SymbolGeometry.find_periodic_orbits-226"><a href="#SymbolGeometry.find_periodic_orbits-226"><span class="linenos">226</span></a>                            <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry.find_periodic_orbits-227"><a href="#SymbolGeometry.find_periodic_orbits-227"><span class="linenos">227</span></a>                            <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry.find_periodic_orbits-228"><a href="#SymbolGeometry.find_periodic_orbits-228"><span class="linenos">228</span></a>                            <span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-229"><a href="#SymbolGeometry.find_periodic_orbits-229"><span class="linenos">229</span></a>                            <span class="n">tol_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">]:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-230"><a href="#SymbolGeometry.find_periodic_orbits-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.find_periodic_orbits-231"><a href="#SymbolGeometry.find_periodic_orbits-231"><span class="linenos">231</span></a><span class="sd">        Find periodic orbits at fixed energy</span>
</span><span id="SymbolGeometry.find_periodic_orbits-232"><a href="#SymbolGeometry.find_periodic_orbits-232"><span class="linenos">232</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.find_periodic_orbits-233"><a href="#SymbolGeometry.find_periodic_orbits-233"><span class="linenos">233</span></a><span class="sd">        Strategy: Sample energy surface H(x,ξ)=E and look for closed orbits</span>
</span><span id="SymbolGeometry.find_periodic_orbits-234"><a href="#SymbolGeometry.find_periodic_orbits-234"><span class="linenos">234</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.find_periodic_orbits-235"><a href="#SymbolGeometry.find_periodic_orbits-235"><span class="linenos">235</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry.find_periodic_orbits-236"><a href="#SymbolGeometry.find_periodic_orbits-236"><span class="linenos">236</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry.find_periodic_orbits-237"><a href="#SymbolGeometry.find_periodic_orbits-237"><span class="linenos">237</span></a><span class="sd">        energy : float</span>
</span><span id="SymbolGeometry.find_periodic_orbits-238"><a href="#SymbolGeometry.find_periodic_orbits-238"><span class="linenos">238</span></a><span class="sd">            Target energy level</span>
</span><span id="SymbolGeometry.find_periodic_orbits-239"><a href="#SymbolGeometry.find_periodic_orbits-239"><span class="linenos">239</span></a><span class="sd">        x_range, xi_range : tuple</span>
</span><span id="SymbolGeometry.find_periodic_orbits-240"><a href="#SymbolGeometry.find_periodic_orbits-240"><span class="linenos">240</span></a><span class="sd">            Search domain</span>
</span><span id="SymbolGeometry.find_periodic_orbits-241"><a href="#SymbolGeometry.find_periodic_orbits-241"><span class="linenos">241</span></a><span class="sd">        n_attempts : int</span>
</span><span id="SymbolGeometry.find_periodic_orbits-242"><a href="#SymbolGeometry.find_periodic_orbits-242"><span class="linenos">242</span></a><span class="sd">            Number of initial conditions to try</span>
</span><span id="SymbolGeometry.find_periodic_orbits-243"><a href="#SymbolGeometry.find_periodic_orbits-243"><span class="linenos">243</span></a><span class="sd">        tol_period : float</span>
</span><span id="SymbolGeometry.find_periodic_orbits-244"><a href="#SymbolGeometry.find_periodic_orbits-244"><span class="linenos">244</span></a><span class="sd">            Tolerance for periodicity detection</span>
</span><span id="SymbolGeometry.find_periodic_orbits-245"><a href="#SymbolGeometry.find_periodic_orbits-245"><span class="linenos">245</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry.find_periodic_orbits-246"><a href="#SymbolGeometry.find_periodic_orbits-246"><span class="linenos">246</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry.find_periodic_orbits-247"><a href="#SymbolGeometry.find_periodic_orbits-247"><span class="linenos">247</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry.find_periodic_orbits-248"><a href="#SymbolGeometry.find_periodic_orbits-248"><span class="linenos">248</span></a><span class="sd">        list of PeriodicOrbit</span>
</span><span id="SymbolGeometry.find_periodic_orbits-249"><a href="#SymbolGeometry.find_periodic_orbits-249"><span class="linenos">249</span></a><span class="sd">            Found periodic orbits</span>
</span><span id="SymbolGeometry.find_periodic_orbits-250"><a href="#SymbolGeometry.find_periodic_orbits-250"><span class="linenos">250</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.find_periodic_orbits-251"><a href="#SymbolGeometry.find_periodic_orbits-251"><span class="linenos">251</span></a>        <span class="n">orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-252"><a href="#SymbolGeometry.find_periodic_orbits-252"><span class="linenos">252</span></a>        <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_attempts</span><span class="p">)))</span>
</span><span id="SymbolGeometry.find_periodic_orbits-253"><a href="#SymbolGeometry.find_periodic_orbits-253"><span class="linenos">253</span></a>        
</span><span id="SymbolGeometry.find_periodic_orbits-254"><a href="#SymbolGeometry.find_periodic_orbits-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">x0_test</span> <span class="ow">in</span> <span class="n">x_samples</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-255"><a href="#SymbolGeometry.find_periodic_orbits-255"><span class="linenos">255</span></a>            <span class="c1"># Solve H(x0, ξ0) = E for ξ0</span>
</span><span id="SymbolGeometry.find_periodic_orbits-256"><a href="#SymbolGeometry.find_periodic_orbits-256"><span class="linenos">256</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">energy_eq</span><span class="p">(</span><span class="n">xi0</span><span class="p">):</span>
</span><span id="SymbolGeometry.find_periodic_orbits-257"><a href="#SymbolGeometry.find_periodic_orbits-257"><span class="linenos">257</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-258"><a href="#SymbolGeometry.find_periodic_orbits-258"><span class="linenos">258</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_H</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span> <span class="o">-</span> <span class="n">energy</span>
</span><span id="SymbolGeometry.find_periodic_orbits-259"><a href="#SymbolGeometry.find_periodic_orbits-259"><span class="linenos">259</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-260"><a href="#SymbolGeometry.find_periodic_orbits-260"><span class="linenos">260</span></a>                    <span class="k">return</span> <span class="mf">1e10</span>
</span><span id="SymbolGeometry.find_periodic_orbits-261"><a href="#SymbolGeometry.find_periodic_orbits-261"><span class="linenos">261</span></a>            
</span><span id="SymbolGeometry.find_periodic_orbits-262"><a href="#SymbolGeometry.find_periodic_orbits-262"><span class="linenos">262</span></a>            <span class="n">xi_guesses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-263"><a href="#SymbolGeometry.find_periodic_orbits-263"><span class="linenos">263</span></a>            
</span><span id="SymbolGeometry.find_periodic_orbits-264"><a href="#SymbolGeometry.find_periodic_orbits-264"><span class="linenos">264</span></a>            <span class="k">for</span> <span class="n">xi_guess</span> <span class="ow">in</span> <span class="n">xi_guesses</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-265"><a href="#SymbolGeometry.find_periodic_orbits-265"><span class="linenos">265</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-266"><a href="#SymbolGeometry.find_periodic_orbits-266"><span class="linenos">266</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">energy_eq</span><span class="p">,</span> <span class="n">xi_guess</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-267"><a href="#SymbolGeometry.find_periodic_orbits-267"><span class="linenos">267</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-268"><a href="#SymbolGeometry.find_periodic_orbits-268"><span class="linenos">268</span></a>                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check convergence</span>
</span><span id="SymbolGeometry.find_periodic_orbits-269"><a href="#SymbolGeometry.find_periodic_orbits-269"><span class="linenos">269</span></a>                        <span class="k">continue</span>
</span><span id="SymbolGeometry.find_periodic_orbits-270"><a href="#SymbolGeometry.find_periodic_orbits-270"><span class="linenos">270</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-271"><a href="#SymbolGeometry.find_periodic_orbits-271"><span class="linenos">271</span></a>                    <span class="n">xi0</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-272"><a href="#SymbolGeometry.find_periodic_orbits-272"><span class="linenos">272</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-273"><a href="#SymbolGeometry.find_periodic_orbits-273"><span class="linenos">273</span></a>                    <span class="c1"># Verify we&#39;re on energy surface</span>
</span><span id="SymbolGeometry.find_periodic_orbits-274"><a href="#SymbolGeometry.find_periodic_orbits-274"><span class="linenos">274</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_H</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">)</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-275"><a href="#SymbolGeometry.find_periodic_orbits-275"><span class="linenos">275</span></a>                        <span class="k">continue</span>
</span><span id="SymbolGeometry.find_periodic_orbits-276"><a href="#SymbolGeometry.find_periodic_orbits-276"><span class="linenos">276</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-277"><a href="#SymbolGeometry.find_periodic_orbits-277"><span class="linenos">277</span></a>                    <span class="c1"># Integrate to detect periodicity</span>
</span><span id="SymbolGeometry.find_periodic_orbits-278"><a href="#SymbolGeometry.find_periodic_orbits-278"><span class="linenos">278</span></a>                    <span class="n">T_max</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="SymbolGeometry.find_periodic_orbits-279"><a href="#SymbolGeometry.find_periodic_orbits-279"><span class="linenos">279</span></a>                    <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">T_max</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-280"><a href="#SymbolGeometry.find_periodic_orbits-280"><span class="linenos">280</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-281"><a href="#SymbolGeometry.find_periodic_orbits-281"><span class="linenos">281</span></a>                    <span class="c1"># Find returns to initial point</span>
</span><span id="SymbolGeometry.find_periodic_orbits-282"><a href="#SymbolGeometry.find_periodic_orbits-282"><span class="linenos">282</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0_test</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span> <span class="o">-</span> <span class="n">xi0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-283"><a href="#SymbolGeometry.find_periodic_orbits-283"><span class="linenos">283</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-284"><a href="#SymbolGeometry.find_periodic_orbits-284"><span class="linenos">284</span></a>                    <span class="c1"># Find local minima (except t=0)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-285"><a href="#SymbolGeometry.find_periodic_orbits-285"><span class="linenos">285</span></a>                    <span class="n">minima_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-286"><a href="#SymbolGeometry.find_periodic_orbits-286"><span class="linenos">286</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">):</span>
</span><span id="SymbolGeometry.find_periodic_orbits-287"><a href="#SymbolGeometry.find_periodic_orbits-287"><span class="linenos">287</span></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> 
</span><span id="SymbolGeometry.find_periodic_orbits-288"><a href="#SymbolGeometry.find_periodic_orbits-288"><span class="linenos">288</span></a>                            <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
</span><span id="SymbolGeometry.find_periodic_orbits-289"><a href="#SymbolGeometry.find_periodic_orbits-289"><span class="linenos">289</span></a>                            <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol_period</span><span class="p">):</span>
</span><span id="SymbolGeometry.find_periodic_orbits-290"><a href="#SymbolGeometry.find_periodic_orbits-290"><span class="linenos">290</span></a>                            <span class="n">minima_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-291"><a href="#SymbolGeometry.find_periodic_orbits-291"><span class="linenos">291</span></a>                    
</span><span id="SymbolGeometry.find_periodic_orbits-292"><a href="#SymbolGeometry.find_periodic_orbits-292"><span class="linenos">292</span></a>                    <span class="k">if</span> <span class="n">minima_idx</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-293"><a href="#SymbolGeometry.find_periodic_orbits-293"><span class="linenos">293</span></a>                        <span class="n">idx_period</span> <span class="o">=</span> <span class="n">minima_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-294"><a href="#SymbolGeometry.find_periodic_orbits-294"><span class="linenos">294</span></a>                        <span class="n">period</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_period</span><span class="p">]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-295"><a href="#SymbolGeometry.find_periodic_orbits-295"><span class="linenos">295</span></a>                        
</span><span id="SymbolGeometry.find_periodic_orbits-296"><a href="#SymbolGeometry.find_periodic_orbits-296"><span class="linenos">296</span></a>                        <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">distances</span><span class="p">[</span><span class="n">idx_period</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol_period</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-297"><a href="#SymbolGeometry.find_periodic_orbits-297"><span class="linenos">297</span></a>                            <span class="c1"># Compute action S = ∮ ξ dx</span>
</span><span id="SymbolGeometry.find_periodic_orbits-298"><a href="#SymbolGeometry.find_periodic_orbits-298"><span class="linenos">298</span></a>                            <span class="n">x_cycle</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">idx_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-299"><a href="#SymbolGeometry.find_periodic_orbits-299"><span class="linenos">299</span></a>                            <span class="n">xi_cycle</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[:</span><span class="n">idx_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-300"><a href="#SymbolGeometry.find_periodic_orbits-300"><span class="linenos">300</span></a>                            <span class="n">t_cycle</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="n">idx_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry.find_periodic_orbits-301"><a href="#SymbolGeometry.find_periodic_orbits-301"><span class="linenos">301</span></a>                            
</span><span id="SymbolGeometry.find_periodic_orbits-302"><a href="#SymbolGeometry.find_periodic_orbits-302"><span class="linenos">302</span></a>                            <span class="n">dx_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_cycle</span><span class="p">,</span> <span class="n">t_cycle</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-303"><a href="#SymbolGeometry.find_periodic_orbits-303"><span class="linenos">303</span></a>                            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">xi_cycle</span> <span class="o">*</span> <span class="n">dx_dt</span><span class="p">,</span> <span class="n">t_cycle</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-304"><a href="#SymbolGeometry.find_periodic_orbits-304"><span class="linenos">304</span></a>                            
</span><span id="SymbolGeometry.find_periodic_orbits-305"><a href="#SymbolGeometry.find_periodic_orbits-305"><span class="linenos">305</span></a>                            <span class="c1"># Compute stability (Lyapunov exponent)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-306"><a href="#SymbolGeometry.find_periodic_orbits-306"><span class="linenos">306</span></a>                            <span class="n">stability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_stability</span><span class="p">(</span><span class="n">x0_test</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</span><span id="SymbolGeometry.find_periodic_orbits-307"><a href="#SymbolGeometry.find_periodic_orbits-307"><span class="linenos">307</span></a>                            
</span><span id="SymbolGeometry.find_periodic_orbits-308"><a href="#SymbolGeometry.find_periodic_orbits-308"><span class="linenos">308</span></a>                            <span class="n">orbits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PeriodicOrbit</span><span class="p">(</span>
</span><span id="SymbolGeometry.find_periodic_orbits-309"><a href="#SymbolGeometry.find_periodic_orbits-309"><span class="linenos">309</span></a>                                <span class="n">x0</span><span class="o">=</span><span class="n">x0_test</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-310"><a href="#SymbolGeometry.find_periodic_orbits-310"><span class="linenos">310</span></a>                                <span class="n">xi0</span><span class="o">=</span><span class="n">xi0</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-311"><a href="#SymbolGeometry.find_periodic_orbits-311"><span class="linenos">311</span></a>                                <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-312"><a href="#SymbolGeometry.find_periodic_orbits-312"><span class="linenos">312</span></a>                                <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-313"><a href="#SymbolGeometry.find_periodic_orbits-313"><span class="linenos">313</span></a>                                <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-314"><a href="#SymbolGeometry.find_periodic_orbits-314"><span class="linenos">314</span></a>                                <span class="n">stability</span><span class="o">=</span><span class="n">stability</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-315"><a href="#SymbolGeometry.find_periodic_orbits-315"><span class="linenos">315</span></a>                                <span class="n">x_cycle</span><span class="o">=</span><span class="n">x_cycle</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-316"><a href="#SymbolGeometry.find_periodic_orbits-316"><span class="linenos">316</span></a>                                <span class="n">xi_cycle</span><span class="o">=</span><span class="n">xi_cycle</span><span class="p">,</span>
</span><span id="SymbolGeometry.find_periodic_orbits-317"><a href="#SymbolGeometry.find_periodic_orbits-317"><span class="linenos">317</span></a>                                <span class="n">t_cycle</span><span class="o">=</span><span class="n">t_cycle</span>
</span><span id="SymbolGeometry.find_periodic_orbits-318"><a href="#SymbolGeometry.find_periodic_orbits-318"><span class="linenos">318</span></a>                            <span class="p">))</span>
</span><span id="SymbolGeometry.find_periodic_orbits-319"><a href="#SymbolGeometry.find_periodic_orbits-319"><span class="linenos">319</span></a>                
</span><span id="SymbolGeometry.find_periodic_orbits-320"><a href="#SymbolGeometry.find_periodic_orbits-320"><span class="linenos">320</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry.find_periodic_orbits-321"><a href="#SymbolGeometry.find_periodic_orbits-321"><span class="linenos">321</span></a>                    <span class="k">continue</span>
</span><span id="SymbolGeometry.find_periodic_orbits-322"><a href="#SymbolGeometry.find_periodic_orbits-322"><span class="linenos">322</span></a>        
</span><span id="SymbolGeometry.find_periodic_orbits-323"><a href="#SymbolGeometry.find_periodic_orbits-323"><span class="linenos">323</span></a>        <span class="c1"># Remove duplicates</span>
</span><span id="SymbolGeometry.find_periodic_orbits-324"><a href="#SymbolGeometry.find_periodic_orbits-324"><span class="linenos">324</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_duplicate_orbits</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find periodic orbits at fixed energy</p>

<p>Strategy: Sample energy surface H(x,ξ)=E and look for closed orbits</p>

<h2 id="parameters">Parameters</h2>

<p>energy : float
    Target energy level
x_range, xi_range : tuple
    Search domain
n_attempts : int
    Number of initial conditions to try
tol_period : float
    Tolerance for periodicity detection</p>

<h2 id="returns">Returns</h2>

<p>list of PeriodicOrbit
    Found periodic orbits</p>
</div>


                            </div>
                            <div id="SymbolGeometry.gutzwiller_trace_formula" class="classattr">
                                        <input id="SymbolGeometry.gutzwiller_trace_formula-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gutzwiller_trace_formula</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_1d</span><span class="o">.</span><span class="n">PeriodicOrbit</span><span class="p">]</span>,</span><span class="param">	<span class="n">t_values</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry.gutzwiller_trace_formula-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry.gutzwiller_trace_formula"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry.gutzwiller_trace_formula-370"><a href="#SymbolGeometry.gutzwiller_trace_formula-370"><span class="linenos">370</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gutzwiller_trace_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">],</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-371"><a href="#SymbolGeometry.gutzwiller_trace_formula-371"><span class="linenos">371</span></a>                                 <span class="n">t_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-372"><a href="#SymbolGeometry.gutzwiller_trace_formula-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-373"><a href="#SymbolGeometry.gutzwiller_trace_formula-373"><span class="linenos">373</span></a><span class="sd">        Gutzwiller trace formula (semiclassical)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-374"><a href="#SymbolGeometry.gutzwiller_trace_formula-374"><span class="linenos">374</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-375"><a href="#SymbolGeometry.gutzwiller_trace_formula-375"><span class="linenos">375</span></a><span class="sd">        Tr[exp(-iHt/ℏ)] ≈ Σ_γ A_γ exp(iS_γ/ℏ - iπμ_γ/2)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-376"><a href="#SymbolGeometry.gutzwiller_trace_formula-376"><span class="linenos">376</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-377"><a href="#SymbolGeometry.gutzwiller_trace_formula-377"><span class="linenos">377</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-378"><a href="#SymbolGeometry.gutzwiller_trace_formula-378"><span class="linenos">378</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-379"><a href="#SymbolGeometry.gutzwiller_trace_formula-379"><span class="linenos">379</span></a><span class="sd">        periodic_orbits : list</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-380"><a href="#SymbolGeometry.gutzwiller_trace_formula-380"><span class="linenos">380</span></a><span class="sd">            List of periodic orbits</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-381"><a href="#SymbolGeometry.gutzwiller_trace_formula-381"><span class="linenos">381</span></a><span class="sd">        t_values : array</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-382"><a href="#SymbolGeometry.gutzwiller_trace_formula-382"><span class="linenos">382</span></a><span class="sd">            Time values</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-383"><a href="#SymbolGeometry.gutzwiller_trace_formula-383"><span class="linenos">383</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-384"><a href="#SymbolGeometry.gutzwiller_trace_formula-384"><span class="linenos">384</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-385"><a href="#SymbolGeometry.gutzwiller_trace_formula-385"><span class="linenos">385</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-386"><a href="#SymbolGeometry.gutzwiller_trace_formula-386"><span class="linenos">386</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-387"><a href="#SymbolGeometry.gutzwiller_trace_formula-387"><span class="linenos">387</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-388"><a href="#SymbolGeometry.gutzwiller_trace_formula-388"><span class="linenos">388</span></a><span class="sd">        array</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-389"><a href="#SymbolGeometry.gutzwiller_trace_formula-389"><span class="linenos">389</span></a><span class="sd">            Trace as function of time</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-390"><a href="#SymbolGeometry.gutzwiller_trace_formula-390"><span class="linenos">390</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-391"><a href="#SymbolGeometry.gutzwiller_trace_formula-391"><span class="linenos">391</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-392"><a href="#SymbolGeometry.gutzwiller_trace_formula-392"><span class="linenos">392</span></a>        
</span><span id="SymbolGeometry.gutzwiller_trace_formula-393"><a href="#SymbolGeometry.gutzwiller_trace_formula-393"><span class="linenos">393</span></a>        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-394"><a href="#SymbolGeometry.gutzwiller_trace_formula-394"><span class="linenos">394</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">period</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-395"><a href="#SymbolGeometry.gutzwiller_trace_formula-395"><span class="linenos">395</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">action</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-396"><a href="#SymbolGeometry.gutzwiller_trace_formula-396"><span class="linenos">396</span></a>            <span class="n">lambda_stab</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">stability</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-397"><a href="#SymbolGeometry.gutzwiller_trace_formula-397"><span class="linenos">397</span></a>            
</span><span id="SymbolGeometry.gutzwiller_trace_formula-398"><a href="#SymbolGeometry.gutzwiller_trace_formula-398"><span class="linenos">398</span></a>            <span class="c1"># ✅ CORRECTION 1 : Plus de répétitions (jusqu&#39;à 10)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-399"><a href="#SymbolGeometry.gutzwiller_trace_formula-399"><span class="linenos">399</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># 1 → 11 (au lieu de 5)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-400"><a href="#SymbolGeometry.gutzwiller_trace_formula-400"><span class="linenos">400</span></a>                <span class="n">T_k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">T</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-401"><a href="#SymbolGeometry.gutzwiller_trace_formula-401"><span class="linenos">401</span></a>                <span class="n">S_k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">S</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-402"><a href="#SymbolGeometry.gutzwiller_trace_formula-402"><span class="linenos">402</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-403"><a href="#SymbolGeometry.gutzwiller_trace_formula-403"><span class="linenos">403</span></a>                <span class="c1"># Stability factor</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-404"><a href="#SymbolGeometry.gutzwiller_trace_formula-404"><span class="linenos">404</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lambda_stab</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lambda_stab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-405"><a href="#SymbolGeometry.gutzwiller_trace_formula-405"><span class="linenos">405</span></a>                    <span class="n">det_factor</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">lambda_stab</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-406"><a href="#SymbolGeometry.gutzwiller_trace_formula-406"><span class="linenos">406</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-407"><a href="#SymbolGeometry.gutzwiller_trace_formula-407"><span class="linenos">407</span></a>                    <span class="n">det_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-408"><a href="#SymbolGeometry.gutzwiller_trace_formula-408"><span class="linenos">408</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-409"><a href="#SymbolGeometry.gutzwiller_trace_formula-409"><span class="linenos">409</span></a>                <span class="k">if</span> <span class="n">det_factor</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-410"><a href="#SymbolGeometry.gutzwiller_trace_formula-410"><span class="linenos">410</span></a>                    <span class="n">det_factor</span> <span class="o">=</span> <span class="mf">1e-10</span>  <span class="c1"># Évite division par zéro</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-411"><a href="#SymbolGeometry.gutzwiller_trace_formula-411"><span class="linenos">411</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-412"><a href="#SymbolGeometry.gutzwiller_trace_formula-412"><span class="linenos">412</span></a>                <span class="c1"># ✅ CORRECTION 2 : Amplitude normalisée</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-413"><a href="#SymbolGeometry.gutzwiller_trace_formula-413"><span class="linenos">413</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">det_factor</span><span class="p">)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-414"><a href="#SymbolGeometry.gutzwiller_trace_formula-414"><span class="linenos">414</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-415"><a href="#SymbolGeometry.gutzwiller_trace_formula-415"><span class="linenos">415</span></a>                <span class="c1"># Maslov index (0 pour oscillateur harmonique)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-416"><a href="#SymbolGeometry.gutzwiller_trace_formula-416"><span class="linenos">416</span></a>                <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-417"><a href="#SymbolGeometry.gutzwiller_trace_formula-417"><span class="linenos">417</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-418"><a href="#SymbolGeometry.gutzwiller_trace_formula-418"><span class="linenos">418</span></a>                <span class="c1"># ✅ CORRECTION 3 : Pic delta au lieu de sinc</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-419"><a href="#SymbolGeometry.gutzwiller_trace_formula-419"><span class="linenos">419</span></a>                <span class="c1"># Utiliser une gaussienne étroite centrée sur T_k</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-420"><a href="#SymbolGeometry.gutzwiller_trace_formula-420"><span class="linenos">420</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">*</span> <span class="mf">0.05</span>  <span class="c1"># Largeur 5% de la période</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-421"><a href="#SymbolGeometry.gutzwiller_trace_formula-421"><span class="linenos">421</span></a>                <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">t_values</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-422"><a href="#SymbolGeometry.gutzwiller_trace_formula-422"><span class="linenos">422</span></a>                <span class="n">gauss</span> <span class="o">/=</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>  <span class="c1"># Normalisation</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-423"><a href="#SymbolGeometry.gutzwiller_trace_formula-423"><span class="linenos">423</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-424"><a href="#SymbolGeometry.gutzwiller_trace_formula-424"><span class="linenos">424</span></a>                <span class="n">phase</span> <span class="o">=</span> <span class="n">S_k</span> <span class="o">/</span> <span class="n">hbar</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-425"><a href="#SymbolGeometry.gutzwiller_trace_formula-425"><span class="linenos">425</span></a>                <span class="n">contribution</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">gauss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phase</span><span class="p">)</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-426"><a href="#SymbolGeometry.gutzwiller_trace_formula-426"><span class="linenos">426</span></a>                
</span><span id="SymbolGeometry.gutzwiller_trace_formula-427"><a href="#SymbolGeometry.gutzwiller_trace_formula-427"><span class="linenos">427</span></a>                <span class="c1"># ✅ CORRECTION 4 : Facteur d&#39;amortissement pour grandes répétitions</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-428"><a href="#SymbolGeometry.gutzwiller_trace_formula-428"><span class="linenos">428</span></a>                <span class="n">damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># Atténue les contributions lointaines</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-429"><a href="#SymbolGeometry.gutzwiller_trace_formula-429"><span class="linenos">429</span></a>                <span class="n">trace</span> <span class="o">+=</span> <span class="n">contribution</span> <span class="o">*</span> <span class="n">damping</span>
</span><span id="SymbolGeometry.gutzwiller_trace_formula-430"><a href="#SymbolGeometry.gutzwiller_trace_formula-430"><span class="linenos">430</span></a>        
</span><span id="SymbolGeometry.gutzwiller_trace_formula-431"><a href="#SymbolGeometry.gutzwiller_trace_formula-431"><span class="linenos">431</span></a>        <span class="k">return</span> <span class="n">trace</span>
</span></pre></div>


            <div class="docstring"><p>Gutzwiller trace formula (semiclassical)</p>

<p>Tr[exp(-iHt/ℏ)] ≈ Σ_γ A_γ exp(iS_γ/ℏ - iπμ_γ/2)</p>

<h2 id="parameters">Parameters</h2>

<p>periodic_orbits : list
    List of periodic orbits
t_values : array
    Time values
hbar : float
    Reduced Planck constant</p>

<h2 id="returns">Returns</h2>

<p>array
    Trace as function of time</p>
</div>


                            </div>
                            <div id="SymbolGeometry.semiclassical_spectrum" class="classattr">
                                        <input id="SymbolGeometry.semiclassical_spectrum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">semiclassical_spectrum</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_1d</span><span class="o">.</span><span class="n">PeriodicOrbit</span><span class="p">]</span>,</span><span class="param">	<span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span></span><span class="return-annotation">) -> <span class="n">src</span><span class="o">.</span><span class="n">geometry_1d</span><span class="o">.</span><span class="n">Spectrum</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry.semiclassical_spectrum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry.semiclassical_spectrum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry.semiclassical_spectrum-433"><a href="#SymbolGeometry.semiclassical_spectrum-433"><span class="linenos">433</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">semiclassical_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">],</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-434"><a href="#SymbolGeometry.semiclassical_spectrum-434"><span class="linenos">434</span></a>                              <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
</span><span id="SymbolGeometry.semiclassical_spectrum-435"><a href="#SymbolGeometry.semiclassical_spectrum-435"><span class="linenos">435</span></a>                              <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Spectrum</span><span class="p">:</span>  <span class="c1"># ✅ 1000 → 4000</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-436"><a href="#SymbolGeometry.semiclassical_spectrum-436"><span class="linenos">436</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-437"><a href="#SymbolGeometry.semiclassical_spectrum-437"><span class="linenos">437</span></a><span class="sd">        Extract semiclassical spectrum via Fourier transform of trace</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-438"><a href="#SymbolGeometry.semiclassical_spectrum-438"><span class="linenos">438</span></a><span class="sd">        </span>
</span><span id="SymbolGeometry.semiclassical_spectrum-439"><a href="#SymbolGeometry.semiclassical_spectrum-439"><span class="linenos">439</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-440"><a href="#SymbolGeometry.semiclassical_spectrum-440"><span class="linenos">440</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-441"><a href="#SymbolGeometry.semiclassical_spectrum-441"><span class="linenos">441</span></a><span class="sd">        periodic_orbits : list</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-442"><a href="#SymbolGeometry.semiclassical_spectrum-442"><span class="linenos">442</span></a><span class="sd">            Periodic orbits</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-443"><a href="#SymbolGeometry.semiclassical_spectrum-443"><span class="linenos">443</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-444"><a href="#SymbolGeometry.semiclassical_spectrum-444"><span class="linenos">444</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-445"><a href="#SymbolGeometry.semiclassical_spectrum-445"><span class="linenos">445</span></a><span class="sd">        resolution : int</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-446"><a href="#SymbolGeometry.semiclassical_spectrum-446"><span class="linenos">446</span></a><span class="sd">            Number of points</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-447"><a href="#SymbolGeometry.semiclassical_spectrum-447"><span class="linenos">447</span></a><span class="sd">            </span>
</span><span id="SymbolGeometry.semiclassical_spectrum-448"><a href="#SymbolGeometry.semiclassical_spectrum-448"><span class="linenos">448</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-449"><a href="#SymbolGeometry.semiclassical_spectrum-449"><span class="linenos">449</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-450"><a href="#SymbolGeometry.semiclassical_spectrum-450"><span class="linenos">450</span></a><span class="sd">        Spectrum</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-451"><a href="#SymbolGeometry.semiclassical_spectrum-451"><span class="linenos">451</span></a><span class="sd">            Spectral information</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-452"><a href="#SymbolGeometry.semiclassical_spectrum-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>        
</span><span id="SymbolGeometry.semiclassical_spectrum-453"><a href="#SymbolGeometry.semiclassical_spectrum-453"><span class="linenos">453</span></a>        <span class="c1"># ✅ Temps d&#39;intégration plus long</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-454"><a href="#SymbolGeometry.semiclassical_spectrum-454"><span class="linenos">454</span></a>        <span class="n">t_max</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">/</span> <span class="n">hbar</span>  <span class="c1"># 50 → 200</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-455"><a href="#SymbolGeometry.semiclassical_spectrum-455"><span class="linenos">455</span></a>        <span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-456"><a href="#SymbolGeometry.semiclassical_spectrum-456"><span class="linenos">456</span></a>        
</span><span id="SymbolGeometry.semiclassical_spectrum-457"><a href="#SymbolGeometry.semiclassical_spectrum-457"><span class="linenos">457</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gutzwiller_trace_formula</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">t_values</span><span class="p">,</span> <span class="n">hbar</span><span class="p">)</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-458"><a href="#SymbolGeometry.semiclassical_spectrum-458"><span class="linenos">458</span></a>        
</span><span id="SymbolGeometry.semiclassical_spectrum-459"><a href="#SymbolGeometry.semiclassical_spectrum-459"><span class="linenos">459</span></a>        <span class="c1"># Fourier transform: t → E</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-460"><a href="#SymbolGeometry.semiclassical_spectrum-460"><span class="linenos">460</span></a>        <span class="n">energies_fft</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">),</span> <span class="n">d</span><span class="o">=</span><span class="n">t_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hbar</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-461"><a href="#SymbolGeometry.semiclassical_spectrum-461"><span class="linenos">461</span></a>        <span class="n">spectrum_fft</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-462"><a href="#SymbolGeometry.semiclassical_spectrum-462"><span class="linenos">462</span></a>        
</span><span id="SymbolGeometry.semiclassical_spectrum-463"><a href="#SymbolGeometry.semiclassical_spectrum-463"><span class="linenos">463</span></a>        <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-464"><a href="#SymbolGeometry.semiclassical_spectrum-464"><span class="linenos">464</span></a>            <span class="n">energies</span><span class="o">=</span><span class="n">energies_fft</span><span class="p">,</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-465"><a href="#SymbolGeometry.semiclassical_spectrum-465"><span class="linenos">465</span></a>            <span class="n">intensity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum_fft</span><span class="p">),</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-466"><a href="#SymbolGeometry.semiclassical_spectrum-466"><span class="linenos">466</span></a>            <span class="n">trace_t</span><span class="o">=</span><span class="n">t_values</span><span class="p">,</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-467"><a href="#SymbolGeometry.semiclassical_spectrum-467"><span class="linenos">467</span></a>            <span class="n">trace</span><span class="o">=</span><span class="n">trace</span>
</span><span id="SymbolGeometry.semiclassical_spectrum-468"><a href="#SymbolGeometry.semiclassical_spectrum-468"><span class="linenos">468</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Extract semiclassical spectrum via Fourier transform of trace</p>

<h2 id="parameters">Parameters</h2>

<p>periodic_orbits : list
    Periodic orbits
hbar : float
    Reduced Planck constant
resolution : int
    Number of points</p>

<h2 id="returns">Returns</h2>

<p>Spectrum
    Spectral information</p>
</div>


                            </div>
                </section>
                <section id="SymbolVisualizer">
                            <input id="SymbolVisualizer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SymbolVisualizer</span>:

                <label class="view-source-button" for="SymbolVisualizer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolVisualizer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolVisualizer-474"><a href="#SymbolVisualizer-474"><span class="linenos">474</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SymbolVisualizer</span><span class="p">:</span>
</span><span id="SymbolVisualizer-475"><a href="#SymbolVisualizer-475"><span class="linenos">475</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-476"><a href="#SymbolVisualizer-476"><span class="linenos">476</span></a><span class="sd">    Comprehensive visualization of symbol geometry</span>
</span><span id="SymbolVisualizer-477"><a href="#SymbolVisualizer-477"><span class="linenos">477</span></a><span class="sd">    </span>
</span><span id="SymbolVisualizer-478"><a href="#SymbolVisualizer-478"><span class="linenos">478</span></a><span class="sd">    Produces 15 panels showing:</span>
</span><span id="SymbolVisualizer-479"><a href="#SymbolVisualizer-479"><span class="linenos">479</span></a><span class="sd">    1. Hamiltonian surface (3D)</span>
</span><span id="SymbolVisualizer-480"><a href="#SymbolVisualizer-480"><span class="linenos">480</span></a><span class="sd">    2. Energy level sets (phase space foliation)</span>
</span><span id="SymbolVisualizer-481"><a href="#SymbolVisualizer-481"><span class="linenos">481</span></a><span class="sd">    3. Hamiltonian vector field</span>
</span><span id="SymbolVisualizer-482"><a href="#SymbolVisualizer-482"><span class="linenos">482</span></a><span class="sd">    4. Group velocity ∂H/∂ξ</span>
</span><span id="SymbolVisualizer-483"><a href="#SymbolVisualizer-483"><span class="linenos">483</span></a><span class="sd">    5. Spatial projection (caustics)</span>
</span><span id="SymbolVisualizer-484"><a href="#SymbolVisualizer-484"><span class="linenos">484</span></a><span class="sd">    6. Jacobian (focusing measure)</span>
</span><span id="SymbolVisualizer-485"><a href="#SymbolVisualizer-485"><span class="linenos">485</span></a><span class="sd">    7. Curvature (focusing tendency)</span>
</span><span id="SymbolVisualizer-486"><a href="#SymbolVisualizer-486"><span class="linenos">486</span></a><span class="sd">    8. Energy conservation</span>
</span><span id="SymbolVisualizer-487"><a href="#SymbolVisualizer-487"><span class="linenos">487</span></a><span class="sd">    9. Periodic orbits (phase space)</span>
</span><span id="SymbolVisualizer-488"><a href="#SymbolVisualizer-488"><span class="linenos">488</span></a><span class="sd">    10. Period-energy diagram</span>
</span><span id="SymbolVisualizer-489"><a href="#SymbolVisualizer-489"><span class="linenos">489</span></a><span class="sd">    11. EBK quantization</span>
</span><span id="SymbolVisualizer-490"><a href="#SymbolVisualizer-490"><span class="linenos">490</span></a><span class="sd">    12. Trace formula</span>
</span><span id="SymbolVisualizer-491"><a href="#SymbolVisualizer-491"><span class="linenos">491</span></a><span class="sd">    13. Semiclassical spectrum</span>
</span><span id="SymbolVisualizer-492"><a href="#SymbolVisualizer-492"><span class="linenos">492</span></a><span class="sd">    14. Orbit stability</span>
</span><span id="SymbolVisualizer-493"><a href="#SymbolVisualizer-493"><span class="linenos">493</span></a><span class="sd">    15. Level spacing distribution</span>
</span><span id="SymbolVisualizer-494"><a href="#SymbolVisualizer-494"><span class="linenos">494</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-495"><a href="#SymbolVisualizer-495"><span class="linenos">495</span></a>    
</span><span id="SymbolVisualizer-496"><a href="#SymbolVisualizer-496"><span class="linenos">496</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">SymbolGeometry</span><span class="p">):</span>
</span><span id="SymbolVisualizer-497"><a href="#SymbolVisualizer-497"><span class="linenos">497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-498"><a href="#SymbolVisualizer-498"><span class="linenos">498</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolVisualizer-499"><a href="#SymbolVisualizer-499"><span class="linenos">499</span></a><span class="sd">        ----------</span>
</span><span id="SymbolVisualizer-500"><a href="#SymbolVisualizer-500"><span class="linenos">500</span></a><span class="sd">        geometry : SymbolGeometry</span>
</span><span id="SymbolVisualizer-501"><a href="#SymbolVisualizer-501"><span class="linenos">501</span></a><span class="sd">            Initialized geometry engine</span>
</span><span id="SymbolVisualizer-502"><a href="#SymbolVisualizer-502"><span class="linenos">502</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-503"><a href="#SymbolVisualizer-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">geometry</span>
</span><span id="SymbolVisualizer-504"><a href="#SymbolVisualizer-504"><span class="linenos">504</span></a>    
</span><span id="SymbolVisualizer-505"><a href="#SymbolVisualizer-505"><span class="linenos">505</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="SymbolVisualizer-506"><a href="#SymbolVisualizer-506"><span class="linenos">506</span></a>                          <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer-507"><a href="#SymbolVisualizer-507"><span class="linenos">507</span></a>                          <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer-508"><a href="#SymbolVisualizer-508"><span class="linenos">508</span></a>                          <span class="n">geodesics_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span>
</span><span id="SymbolVisualizer-509"><a href="#SymbolVisualizer-509"><span class="linenos">509</span></a>                          <span class="n">E_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SymbolVisualizer-510"><a href="#SymbolVisualizer-510"><span class="linenos">510</span></a>                          <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="SymbolVisualizer-511"><a href="#SymbolVisualizer-511"><span class="linenos">511</span></a>                          <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="SymbolVisualizer-512"><a href="#SymbolVisualizer-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-513"><a href="#SymbolVisualizer-513"><span class="linenos">513</span></a><span class="sd">        Create complete geometric atlas</span>
</span><span id="SymbolVisualizer-514"><a href="#SymbolVisualizer-514"><span class="linenos">514</span></a><span class="sd">        </span>
</span><span id="SymbolVisualizer-515"><a href="#SymbolVisualizer-515"><span class="linenos">515</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolVisualizer-516"><a href="#SymbolVisualizer-516"><span class="linenos">516</span></a><span class="sd">        ----------</span>
</span><span id="SymbolVisualizer-517"><a href="#SymbolVisualizer-517"><span class="linenos">517</span></a><span class="sd">        x_range, xi_range : tuple</span>
</span><span id="SymbolVisualizer-518"><a href="#SymbolVisualizer-518"><span class="linenos">518</span></a><span class="sd">            Domain limits</span>
</span><span id="SymbolVisualizer-519"><a href="#SymbolVisualizer-519"><span class="linenos">519</span></a><span class="sd">        geodesics_params : list of tuples</span>
</span><span id="SymbolVisualizer-520"><a href="#SymbolVisualizer-520"><span class="linenos">520</span></a><span class="sd">            Each tuple: (x0, xi0, t_max, color)</span>
</span><span id="SymbolVisualizer-521"><a href="#SymbolVisualizer-521"><span class="linenos">521</span></a><span class="sd">        E_range : tuple, optional</span>
</span><span id="SymbolVisualizer-522"><a href="#SymbolVisualizer-522"><span class="linenos">522</span></a><span class="sd">            Energy range for spectral analysis</span>
</span><span id="SymbolVisualizer-523"><a href="#SymbolVisualizer-523"><span class="linenos">523</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolVisualizer-524"><a href="#SymbolVisualizer-524"><span class="linenos">524</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolVisualizer-525"><a href="#SymbolVisualizer-525"><span class="linenos">525</span></a><span class="sd">        resolution : int</span>
</span><span id="SymbolVisualizer-526"><a href="#SymbolVisualizer-526"><span class="linenos">526</span></a><span class="sd">            Grid resolution</span>
</span><span id="SymbolVisualizer-527"><a href="#SymbolVisualizer-527"><span class="linenos">527</span></a><span class="sd">            </span>
</span><span id="SymbolVisualizer-528"><a href="#SymbolVisualizer-528"><span class="linenos">528</span></a><span class="sd">        Returns</span>
</span><span id="SymbolVisualizer-529"><a href="#SymbolVisualizer-529"><span class="linenos">529</span></a><span class="sd">        -------</span>
</span><span id="SymbolVisualizer-530"><a href="#SymbolVisualizer-530"><span class="linenos">530</span></a><span class="sd">        fig, geodesics, periodic_orbits, spectrum</span>
</span><span id="SymbolVisualizer-531"><a href="#SymbolVisualizer-531"><span class="linenos">531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-532"><a href="#SymbolVisualizer-532"><span class="linenos">532</span></a>        <span class="c1"># Compute grid</span>
</span><span id="SymbolVisualizer-533"><a href="#SymbolVisualizer-533"><span class="linenos">533</span></a>        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="SymbolVisualizer-534"><a href="#SymbolVisualizer-534"><span class="linenos">534</span></a>        <span class="n">xi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="SymbolVisualizer-535"><a href="#SymbolVisualizer-535"><span class="linenos">535</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">)</span>
</span><span id="SymbolVisualizer-536"><a href="#SymbolVisualizer-536"><span class="linenos">536</span></a>        
</span><span id="SymbolVisualizer-537"><a href="#SymbolVisualizer-537"><span class="linenos">537</span></a>        <span class="c1"># Evaluate Hamiltonian and derivatives on grid</span>
</span><span id="SymbolVisualizer-538"><a href="#SymbolVisualizer-538"><span class="linenos">538</span></a>        <span class="n">grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_grids</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">)</span>
</span><span id="SymbolVisualizer-539"><a href="#SymbolVisualizer-539"><span class="linenos">539</span></a>        
</span><span id="SymbolVisualizer-540"><a href="#SymbolVisualizer-540"><span class="linenos">540</span></a>        <span class="c1"># Compute geodesics</span>
</span><span id="SymbolVisualizer-541"><a href="#SymbolVisualizer-541"><span class="linenos">541</span></a>        <span class="n">geodesics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesics</span><span class="p">(</span><span class="n">geodesics_params</span><span class="p">)</span>
</span><span id="SymbolVisualizer-542"><a href="#SymbolVisualizer-542"><span class="linenos">542</span></a>        
</span><span id="SymbolVisualizer-543"><a href="#SymbolVisualizer-543"><span class="linenos">543</span></a>        <span class="c1"># Find periodic orbits (if E_range specified)</span>
</span><span id="SymbolVisualizer-544"><a href="#SymbolVisualizer-544"><span class="linenos">544</span></a>        <span class="n">periodic_orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer-545"><a href="#SymbolVisualizer-545"><span class="linenos">545</span></a>        <span class="n">spectrum</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SymbolVisualizer-546"><a href="#SymbolVisualizer-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="n">E_range</span><span class="p">:</span>
</span><span id="SymbolVisualizer-547"><a href="#SymbolVisualizer-547"><span class="linenos">547</span></a>            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer-548"><a href="#SymbolVisualizer-548"><span class="linenos">548</span></a>            <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
</span><span id="SymbolVisualizer-549"><a href="#SymbolVisualizer-549"><span class="linenos">549</span></a>                <span class="n">orbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">find_periodic_orbits</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">)</span>
</span><span id="SymbolVisualizer-550"><a href="#SymbolVisualizer-550"><span class="linenos">550</span></a>                <span class="n">periodic_orbits</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span><span id="SymbolVisualizer-551"><a href="#SymbolVisualizer-551"><span class="linenos">551</span></a>            
</span><span id="SymbolVisualizer-552"><a href="#SymbolVisualizer-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolVisualizer-553"><a href="#SymbolVisualizer-553"><span class="linenos">553</span></a>                <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">semiclassical_spectrum</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">hbar</span><span class="p">)</span>
</span><span id="SymbolVisualizer-554"><a href="#SymbolVisualizer-554"><span class="linenos">554</span></a>        
</span><span id="SymbolVisualizer-555"><a href="#SymbolVisualizer-555"><span class="linenos">555</span></a>        <span class="c1"># Create figure</span>
</span><span id="SymbolVisualizer-556"><a href="#SymbolVisualizer-556"><span class="linenos">556</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_figure</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">hbar</span><span class="p">)</span>
</span><span id="SymbolVisualizer-557"><a href="#SymbolVisualizer-557"><span class="linenos">557</span></a>        
</span><span id="SymbolVisualizer-558"><a href="#SymbolVisualizer-558"><span class="linenos">558</span></a>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">spectrum</span>
</span><span id="SymbolVisualizer-559"><a href="#SymbolVisualizer-559"><span class="linenos">559</span></a>    
</span><span id="SymbolVisualizer-560"><a href="#SymbolVisualizer-560"><span class="linenos">560</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Xi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="SymbolVisualizer-561"><a href="#SymbolVisualizer-561"><span class="linenos">561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate all necessary fields on grid (DRY)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-562"><a href="#SymbolVisualizer-562"><span class="linenos">562</span></a>        <span class="n">grids</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SymbolVisualizer-563"><a href="#SymbolVisualizer-563"><span class="linenos">563</span></a>        
</span><span id="SymbolVisualizer-564"><a href="#SymbolVisualizer-564"><span class="linenos">564</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="SymbolVisualizer-565"><a href="#SymbolVisualizer-565"><span class="linenos">565</span></a>            <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">f_H</span><span class="p">),</span>
</span><span id="SymbolVisualizer-566"><a href="#SymbolVisualizer-566"><span class="linenos">566</span></a>            <span class="p">(</span><span class="s1">&#39;dH_dxi&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">f_dH_dxi</span><span class="p">),</span>
</span><span id="SymbolVisualizer-567"><a href="#SymbolVisualizer-567"><span class="linenos">567</span></a>            <span class="p">(</span><span class="s1">&#39;dH_dx&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">f_dH_dx</span><span class="p">),</span>
</span><span id="SymbolVisualizer-568"><a href="#SymbolVisualizer-568"><span class="linenos">568</span></a>            <span class="p">(</span><span class="s1">&#39;d2H_dxdxi&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">f_d2H_dxdxi</span><span class="p">)</span>
</span><span id="SymbolVisualizer-569"><a href="#SymbolVisualizer-569"><span class="linenos">569</span></a>        <span class="p">]:</span>
</span><span id="SymbolVisualizer-570"><a href="#SymbolVisualizer-570"><span class="linenos">570</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SymbolVisualizer-571"><a href="#SymbolVisualizer-571"><span class="linenos">571</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="SymbolVisualizer-572"><a href="#SymbolVisualizer-572"><span class="linenos">572</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="SymbolVisualizer-573"><a href="#SymbolVisualizer-573"><span class="linenos">573</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer-574"><a href="#SymbolVisualizer-574"><span class="linenos">574</span></a>                        <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">Xi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
</span><span id="SymbolVisualizer-575"><a href="#SymbolVisualizer-575"><span class="linenos">575</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolVisualizer-576"><a href="#SymbolVisualizer-576"><span class="linenos">576</span></a>                        <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="SymbolVisualizer-577"><a href="#SymbolVisualizer-577"><span class="linenos">577</span></a>            <span class="n">grids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="SymbolVisualizer-578"><a href="#SymbolVisualizer-578"><span class="linenos">578</span></a>        
</span><span id="SymbolVisualizer-579"><a href="#SymbolVisualizer-579"><span class="linenos">579</span></a>        <span class="k">return</span> <span class="n">grids</span>
</span><span id="SymbolVisualizer-580"><a href="#SymbolVisualizer-580"><span class="linenos">580</span></a>    
</span><span id="SymbolVisualizer-581"><a href="#SymbolVisualizer-581"><span class="linenos">581</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_geodesics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Geodesic</span><span class="p">]:</span>
</span><span id="SymbolVisualizer-582"><a href="#SymbolVisualizer-582"><span class="linenos">582</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute all geodesics&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-583"><a href="#SymbolVisualizer-583"><span class="linenos">583</span></a>        <span class="n">geodesics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer-584"><a href="#SymbolVisualizer-584"><span class="linenos">584</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
</span><span id="SymbolVisualizer-585"><a href="#SymbolVisualizer-585"><span class="linenos">585</span></a>            <span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="SymbolVisualizer-586"><a href="#SymbolVisualizer-586"><span class="linenos">586</span></a>            <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">)</span>
</span><span id="SymbolVisualizer-587"><a href="#SymbolVisualizer-587"><span class="linenos">587</span></a>            <span class="n">geo</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;blue&#39;</span>
</span><span id="SymbolVisualizer-588"><a href="#SymbolVisualizer-588"><span class="linenos">588</span></a>            <span class="n">geodesics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geo</span><span class="p">)</span>
</span><span id="SymbolVisualizer-589"><a href="#SymbolVisualizer-589"><span class="linenos">589</span></a>        <span class="k">return</span> <span class="n">geodesics</span>
</span><span id="SymbolVisualizer-590"><a href="#SymbolVisualizer-590"><span class="linenos">590</span></a>    
</span><span id="SymbolVisualizer-591"><a href="#SymbolVisualizer-591"><span class="linenos">591</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">hbar</span><span class="p">):</span>
</span><span id="SymbolVisualizer-592"><a href="#SymbolVisualizer-592"><span class="linenos">592</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the complete visualization figure&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-593"><a href="#SymbolVisualizer-593"><span class="linenos">593</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>
</span><span id="SymbolVisualizer-594"><a href="#SymbolVisualizer-594"><span class="linenos">594</span></a>        
</span><span id="SymbolVisualizer-595"><a href="#SymbolVisualizer-595"><span class="linenos">595</span></a>        <span class="c1"># Panel 1-8: Geometry</span>
</span><span id="SymbolVisualizer-596"><a href="#SymbolVisualizer-596"><span class="linenos">596</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_hamiltonian_surface</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SymbolVisualizer-597"><a href="#SymbolVisualizer-597"><span class="linenos">597</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_level_sets</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer-598"><a href="#SymbolVisualizer-598"><span class="linenos">598</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_vector_field</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-599"><a href="#SymbolVisualizer-599"><span class="linenos">599</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_group_velocity</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;dH_dxi&#39;</span><span class="p">],</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="SymbolVisualizer-600"><a href="#SymbolVisualizer-600"><span class="linenos">600</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_spatial_projection</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-601"><a href="#SymbolVisualizer-601"><span class="linenos">601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_jacobian</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</span><span id="SymbolVisualizer-602"><a href="#SymbolVisualizer-602"><span class="linenos">602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_curvature</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;d2H_dxdxi&#39;</span><span class="p">],</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</span><span id="SymbolVisualizer-603"><a href="#SymbolVisualizer-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_energy_conservation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer-604"><a href="#SymbolVisualizer-604"><span class="linenos">604</span></a>        
</span><span id="SymbolVisualizer-605"><a href="#SymbolVisualizer-605"><span class="linenos">605</span></a>        <span class="c1"># Panel 9-15: Spectral analysis</span>
</span><span id="SymbolVisualizer-606"><a href="#SymbolVisualizer-606"><span class="linenos">606</span></a>        <span class="k">if</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolVisualizer-607"><a href="#SymbolVisualizer-607"><span class="linenos">607</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_periodic_orbits</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</span><span id="SymbolVisualizer-608"><a href="#SymbolVisualizer-608"><span class="linenos">608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_period_energy</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer-609"><a href="#SymbolVisualizer-609"><span class="linenos">609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_ebk_quantization</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">hbar</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</span><span id="SymbolVisualizer-610"><a href="#SymbolVisualizer-610"><span class="linenos">610</span></a>            
</span><span id="SymbolVisualizer-611"><a href="#SymbolVisualizer-611"><span class="linenos">611</span></a>            <span class="k">if</span> <span class="n">spectrum</span><span class="p">:</span>
</span><span id="SymbolVisualizer-612"><a href="#SymbolVisualizer-612"><span class="linenos">612</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_trace_formula</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</span><span id="SymbolVisualizer-613"><a href="#SymbolVisualizer-613"><span class="linenos">613</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_spectrum</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
</span><span id="SymbolVisualizer-614"><a href="#SymbolVisualizer-614"><span class="linenos">614</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_stability</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
</span><span id="SymbolVisualizer-615"><a href="#SymbolVisualizer-615"><span class="linenos">615</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_level_spacing</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="SymbolVisualizer-616"><a href="#SymbolVisualizer-616"><span class="linenos">616</span></a>        
</span><span id="SymbolVisualizer-617"><a href="#SymbolVisualizer-617"><span class="linenos">617</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Geometric and Semiclassical Atlas: H = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer-618"><a href="#SymbolVisualizer-618"><span class="linenos">618</span></a>                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.995</span><span class="p">)</span>
</span><span id="SymbolVisualizer-619"><a href="#SymbolVisualizer-619"><span class="linenos">619</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>
</span><span id="SymbolVisualizer-620"><a href="#SymbolVisualizer-620"><span class="linenos">620</span></a>
</span><span id="SymbolVisualizer-621"><a href="#SymbolVisualizer-621"><span class="linenos">621</span></a>        
</span><span id="SymbolVisualizer-622"><a href="#SymbolVisualizer-622"><span class="linenos">622</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="SymbolVisualizer-623"><a href="#SymbolVisualizer-623"><span class="linenos">623</span></a>    
</span><span id="SymbolVisualizer-624"><a href="#SymbolVisualizer-624"><span class="linenos">624</span></a>    <span class="c1"># Individual plotting methods (KISS principle: each does one thing)</span>
</span><span id="SymbolVisualizer-625"><a href="#SymbolVisualizer-625"><span class="linenos">625</span></a>    
</span><span id="SymbolVisualizer-626"><a href="#SymbolVisualizer-626"><span class="linenos">626</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_hamiltonian_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">H_grid</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-627"><a href="#SymbolVisualizer-627"><span class="linenos">627</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 1: Hamiltonian surface in 3D&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-628"><a href="#SymbolVisualizer-628"><span class="linenos">628</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-629"><a href="#SymbolVisualizer-629"><span class="linenos">629</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">H_grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
</span><span id="SymbolVisualizer-630"><a href="#SymbolVisualizer-630"><span class="linenos">630</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SymbolVisualizer-631"><a href="#SymbolVisualizer-631"><span class="linenos">631</span></a>        
</span><span id="SymbolVisualizer-632"><a href="#SymbolVisualizer-632"><span class="linenos">632</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-633"><a href="#SymbolVisualizer-633"><span class="linenos">633</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-634"><a href="#SymbolVisualizer-634"><span class="linenos">634</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-635"><a href="#SymbolVisualizer-635"><span class="linenos">635</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="SymbolVisualizer-636"><a href="#SymbolVisualizer-636"><span class="linenos">636</span></a>                       <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer-637"><a href="#SymbolVisualizer-637"><span class="linenos">637</span></a>        
</span><span id="SymbolVisualizer-638"><a href="#SymbolVisualizer-638"><span class="linenos">638</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-639"><a href="#SymbolVisualizer-639"><span class="linenos">639</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-640"><a href="#SymbolVisualizer-640"><span class="linenos">640</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;H(x,ξ)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-641"><a href="#SymbolVisualizer-641"><span class="linenos">641</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hamiltonian Surface</span><span class="se">\n</span><span class="s1">+ Geodesics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-642"><a href="#SymbolVisualizer-642"><span class="linenos">642</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
</span><span id="SymbolVisualizer-643"><a href="#SymbolVisualizer-643"><span class="linenos">643</span></a>        
</span><span id="SymbolVisualizer-644"><a href="#SymbolVisualizer-644"><span class="linenos">644</span></a>        <span class="c1"># 🔧 Ajustements pour taille cohérente</span>
</span><span id="SymbolVisualizer-645"><a href="#SymbolVisualizer-645"><span class="linenos">645</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">))</span>   <span class="c1"># équilibre visuel (x, ξ, H)</span>
</span><span id="SymbolVisualizer-646"><a href="#SymbolVisualizer-646"><span class="linenos">646</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                    <span class="c1"># supprime marges internes</span>
</span><span id="SymbolVisualizer-647"><a href="#SymbolVisualizer-647"><span class="linenos">647</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_proj_type</span><span class="p">(</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>        <span class="c1"># projection orthographique = moins de distorsion</span>
</span><span id="SymbolVisualizer-648"><a href="#SymbolVisualizer-648"><span class="linenos">648</span></a>    
</span><span id="SymbolVisualizer-649"><a href="#SymbolVisualizer-649"><span class="linenos">649</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_level_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">H_grid</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-650"><a href="#SymbolVisualizer-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 2: Energy level sets (symplectic foliation)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-651"><a href="#SymbolVisualizer-651"><span class="linenos">651</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-652"><a href="#SymbolVisualizer-652"><span class="linenos">652</span></a>        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">H_grid</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">H_grid</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolVisualizer-653"><a href="#SymbolVisualizer-653"><span class="linenos">653</span></a>        <span class="n">contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">H_grid</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-654"><a href="#SymbolVisualizer-654"><span class="linenos">654</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer-655"><a href="#SymbolVisualizer-655"><span class="linenos">655</span></a>        
</span><span id="SymbolVisualizer-656"><a href="#SymbolVisualizer-656"><span class="linenos">656</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-657"><a href="#SymbolVisualizer-657"><span class="linenos">657</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-658"><a href="#SymbolVisualizer-658"><span class="linenos">658</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-659"><a href="#SymbolVisualizer-659"><span class="linenos">659</span></a>        
</span><span id="SymbolVisualizer-660"><a href="#SymbolVisualizer-660"><span class="linenos">660</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-661"><a href="#SymbolVisualizer-661"><span class="linenos">661</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-662"><a href="#SymbolVisualizer-662"><span class="linenos">662</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Level Sets H=const</span><span class="se">\n</span><span class="s1">Symplectic Foliation&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-663"><a href="#SymbolVisualizer-663"><span class="linenos">663</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-664"><a href="#SymbolVisualizer-664"><span class="linenos">664</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>     
</span><span id="SymbolVisualizer-665"><a href="#SymbolVisualizer-665"><span class="linenos">665</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>          
</span><span id="SymbolVisualizer-666"><a href="#SymbolVisualizer-666"><span class="linenos">666</span></a>    
</span><span id="SymbolVisualizer-667"><a href="#SymbolVisualizer-667"><span class="linenos">667</span></a>    
</span><span id="SymbolVisualizer-668"><a href="#SymbolVisualizer-668"><span class="linenos">668</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_vector_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-669"><a href="#SymbolVisualizer-669"><span class="linenos">669</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 3: Hamiltonian vector field&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-670"><a href="#SymbolVisualizer-670"><span class="linenos">670</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-671"><a href="#SymbolVisualizer-671"><span class="linenos">671</span></a>        
</span><span id="SymbolVisualizer-672"><a href="#SymbolVisualizer-672"><span class="linenos">672</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolVisualizer-673"><a href="#SymbolVisualizer-673"><span class="linenos">673</span></a>        <span class="n">X_sub</span> <span class="o">=</span> <span class="n">X</span><span class="p">[::</span><span class="n">step</span><span class="p">,</span> <span class="p">::</span><span class="n">step</span><span class="p">]</span>
</span><span id="SymbolVisualizer-674"><a href="#SymbolVisualizer-674"><span class="linenos">674</span></a>        <span class="n">Xi_sub</span> <span class="o">=</span> <span class="n">Xi</span><span class="p">[::</span><span class="n">step</span><span class="p">,</span> <span class="p">::</span><span class="n">step</span><span class="p">]</span>
</span><span id="SymbolVisualizer-675"><a href="#SymbolVisualizer-675"><span class="linenos">675</span></a>        <span class="n">vx</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="s1">&#39;dH_dxi&#39;</span><span class="p">][::</span><span class="n">step</span><span class="p">,</span> <span class="p">::</span><span class="n">step</span><span class="p">]</span>
</span><span id="SymbolVisualizer-676"><a href="#SymbolVisualizer-676"><span class="linenos">676</span></a>        <span class="n">vy</span> <span class="o">=</span> <span class="o">-</span><span class="n">grids</span><span class="p">[</span><span class="s1">&#39;dH_dx&#39;</span><span class="p">][::</span><span class="n">step</span><span class="p">,</span> <span class="p">::</span><span class="n">step</span><span class="p">]</span>
</span><span id="SymbolVisualizer-677"><a href="#SymbolVisualizer-677"><span class="linenos">677</span></a>        
</span><span id="SymbolVisualizer-678"><a href="#SymbolVisualizer-678"><span class="linenos">678</span></a>        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer-679"><a href="#SymbolVisualizer-679"><span class="linenos">679</span></a>        <span class="n">magnitude</span><span class="p">[</span><span class="n">magnitude</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SymbolVisualizer-680"><a href="#SymbolVisualizer-680"><span class="linenos">680</span></a>        
</span><span id="SymbolVisualizer-681"><a href="#SymbolVisualizer-681"><span class="linenos">681</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X_sub</span><span class="p">,</span> <span class="n">Xi_sub</span><span class="p">,</span> <span class="n">vx</span><span class="o">/</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">vy</span><span class="o">/</span><span class="n">magnitude</span><span class="p">,</span>
</span><span id="SymbolVisualizer-682"><a href="#SymbolVisualizer-682"><span class="linenos">682</span></a>                 <span class="n">magnitude</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="SymbolVisualizer-683"><a href="#SymbolVisualizer-683"><span class="linenos">683</span></a>        
</span><span id="SymbolVisualizer-684"><a href="#SymbolVisualizer-684"><span class="linenos">684</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-685"><a href="#SymbolVisualizer-685"><span class="linenos">685</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-686"><a href="#SymbolVisualizer-686"><span class="linenos">686</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-687"><a href="#SymbolVisualizer-687"><span class="linenos">687</span></a>        
</span><span id="SymbolVisualizer-688"><a href="#SymbolVisualizer-688"><span class="linenos">688</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-689"><a href="#SymbolVisualizer-689"><span class="linenos">689</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-690"><a href="#SymbolVisualizer-690"><span class="linenos">690</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hamiltonian Vector Field</span><span class="se">\n</span><span class="s1">(Infinitesimal generator)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-691"><a href="#SymbolVisualizer-691"><span class="linenos">691</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-692"><a href="#SymbolVisualizer-692"><span class="linenos">692</span></a>    
</span><span id="SymbolVisualizer-693"><a href="#SymbolVisualizer-693"><span class="linenos">693</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_group_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">dH_dxi</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-694"><a href="#SymbolVisualizer-694"><span class="linenos">694</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 4: Group velocity ∂H/∂ξ&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-695"><a href="#SymbolVisualizer-695"><span class="linenos">695</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-696"><a href="#SymbolVisualizer-696"><span class="linenos">696</span></a>        
</span><span id="SymbolVisualizer-697"><a href="#SymbolVisualizer-697"><span class="linenos">697</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">dH_dxi</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-698"><a href="#SymbolVisualizer-698"><span class="linenos">698</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;∂H/∂ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-699"><a href="#SymbolVisualizer-699"><span class="linenos">699</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">dH_dxi</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
</span><span id="SymbolVisualizer-700"><a href="#SymbolVisualizer-700"><span class="linenos">700</span></a>                  <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-701"><a href="#SymbolVisualizer-701"><span class="linenos">701</span></a>        
</span><span id="SymbolVisualizer-702"><a href="#SymbolVisualizer-702"><span class="linenos">702</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-703"><a href="#SymbolVisualizer-703"><span class="linenos">703</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer-704"><a href="#SymbolVisualizer-704"><span class="linenos">704</span></a>        
</span><span id="SymbolVisualizer-705"><a href="#SymbolVisualizer-705"><span class="linenos">705</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-706"><a href="#SymbolVisualizer-706"><span class="linenos">706</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-707"><a href="#SymbolVisualizer-707"><span class="linenos">707</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Group Velocity v_g = ∂H/∂ξ</span><span class="se">\n</span><span class="s1">(Wave propagation speed)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-708"><a href="#SymbolVisualizer-708"><span class="linenos">708</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-709"><a href="#SymbolVisualizer-709"><span class="linenos">709</span></a>    
</span><span id="SymbolVisualizer-710"><a href="#SymbolVisualizer-710"><span class="linenos">710</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_spatial_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-711"><a href="#SymbolVisualizer-711"><span class="linenos">711</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 5: Spatial projection (with caustics)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-712"><a href="#SymbolVisualizer-712"><span class="linenos">712</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-713"><a href="#SymbolVisualizer-713"><span class="linenos">713</span></a>        
</span><span id="SymbolVisualizer-714"><a href="#SymbolVisualizer-714"><span class="linenos">714</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-715"><a href="#SymbolVisualizer-715"><span class="linenos">715</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-716"><a href="#SymbolVisualizer-716"><span class="linenos">716</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-717"><a href="#SymbolVisualizer-717"><span class="linenos">717</span></a>            
</span><span id="SymbolVisualizer-718"><a href="#SymbolVisualizer-718"><span class="linenos">718</span></a>            <span class="c1"># Mark caustics</span>
</span><span id="SymbolVisualizer-719"><a href="#SymbolVisualizer-719"><span class="linenos">719</span></a>            <span class="n">caust_idx</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustics</span>
</span><span id="SymbolVisualizer-720"><a href="#SymbolVisualizer-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caust_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SymbolVisualizer-721"><a href="#SymbolVisualizer-721"><span class="linenos">721</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">caust_idx</span><span class="p">],</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">caust_idx</span><span class="p">],</span>
</span><span id="SymbolVisualizer-722"><a href="#SymbolVisualizer-722"><span class="linenos">722</span></a>                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="SymbolVisualizer-723"><a href="#SymbolVisualizer-723"><span class="linenos">723</span></a>                          <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-724"><a href="#SymbolVisualizer-724"><span class="linenos">724</span></a>        
</span><span id="SymbolVisualizer-725"><a href="#SymbolVisualizer-725"><span class="linenos">725</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-726"><a href="#SymbolVisualizer-726"><span class="linenos">726</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-727"><a href="#SymbolVisualizer-727"><span class="linenos">727</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spatial Projection</span><span class="se">\n</span><span class="s1">★ = Caustics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-728"><a href="#SymbolVisualizer-728"><span class="linenos">728</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-729"><a href="#SymbolVisualizer-729"><span class="linenos">729</span></a>    
</span><span id="SymbolVisualizer-730"><a href="#SymbolVisualizer-730"><span class="linenos">730</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-731"><a href="#SymbolVisualizer-731"><span class="linenos">731</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 6: Jacobian (focusing measure)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-732"><a href="#SymbolVisualizer-732"><span class="linenos">732</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-733"><a href="#SymbolVisualizer-733"><span class="linenos">733</span></a>        
</span><span id="SymbolVisualizer-734"><a href="#SymbolVisualizer-734"><span class="linenos">734</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-735"><a href="#SymbolVisualizer-735"><span class="linenos">735</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-736"><a href="#SymbolVisualizer-736"><span class="linenos">736</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-737"><a href="#SymbolVisualizer-737"><span class="linenos">737</span></a>        
</span><span id="SymbolVisualizer-738"><a href="#SymbolVisualizer-738"><span class="linenos">738</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="SymbolVisualizer-739"><a href="#SymbolVisualizer-739"><span class="linenos">739</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-740"><a href="#SymbolVisualizer-740"><span class="linenos">740</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;J = ∂x/∂ξ₀&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-741"><a href="#SymbolVisualizer-741"><span class="linenos">741</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Jacobian (Focusing)</span><span class="se">\n</span><span class="s1">J→0: rays converge&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-742"><a href="#SymbolVisualizer-742"><span class="linenos">742</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-743"><a href="#SymbolVisualizer-743"><span class="linenos">743</span></a>    
</span><span id="SymbolVisualizer-744"><a href="#SymbolVisualizer-744"><span class="linenos">744</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_curvature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-745"><a href="#SymbolVisualizer-745"><span class="linenos">745</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 7: Sectional curvature&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-746"><a href="#SymbolVisualizer-746"><span class="linenos">746</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-747"><a href="#SymbolVisualizer-747"><span class="linenos">747</span></a>        
</span><span id="SymbolVisualizer-748"><a href="#SymbolVisualizer-748"><span class="linenos">748</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">curvature</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-749"><a href="#SymbolVisualizer-749"><span class="linenos">749</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;∂²H/∂x∂ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-750"><a href="#SymbolVisualizer-750"><span class="linenos">750</span></a>        
</span><span id="SymbolVisualizer-751"><a href="#SymbolVisualizer-751"><span class="linenos">751</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-752"><a href="#SymbolVisualizer-752"><span class="linenos">752</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer-753"><a href="#SymbolVisualizer-753"><span class="linenos">753</span></a>        
</span><span id="SymbolVisualizer-754"><a href="#SymbolVisualizer-754"><span class="linenos">754</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-755"><a href="#SymbolVisualizer-755"><span class="linenos">755</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-756"><a href="#SymbolVisualizer-756"><span class="linenos">756</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sectional Curvature</span><span class="se">\n</span><span class="s1">Red&gt;0: focusing | Blue&lt;0: defocusing&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-757"><a href="#SymbolVisualizer-757"><span class="linenos">757</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-758"><a href="#SymbolVisualizer-758"><span class="linenos">758</span></a>    
</span><span id="SymbolVisualizer-759"><a href="#SymbolVisualizer-759"><span class="linenos">759</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_energy_conservation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-760"><a href="#SymbolVisualizer-760"><span class="linenos">760</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 8: Energy conservation (integration quality)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-761"><a href="#SymbolVisualizer-761"><span class="linenos">761</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-762"><a href="#SymbolVisualizer-762"><span class="linenos">762</span></a>        
</span><span id="SymbolVisualizer-763"><a href="#SymbolVisualizer-763"><span class="linenos">763</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer-764"><a href="#SymbolVisualizer-764"><span class="linenos">764</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-765"><a href="#SymbolVisualizer-765"><span class="linenos">765</span></a>            <span class="n">H_variation</span> <span class="o">=</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</span><span id="SymbolVisualizer-766"><a href="#SymbolVisualizer-766"><span class="linenos">766</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">H_variation</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">,</span>
</span><span id="SymbolVisualizer-767"><a href="#SymbolVisualizer-767"><span class="linenos">767</span></a>                       <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;E₀=</span><span class="si">{</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-768"><a href="#SymbolVisualizer-768"><span class="linenos">768</span></a>        
</span><span id="SymbolVisualizer-769"><a href="#SymbolVisualizer-769"><span class="linenos">769</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-770"><a href="#SymbolVisualizer-770"><span class="linenos">770</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|ΔH/H₀|&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-771"><a href="#SymbolVisualizer-771"><span class="linenos">771</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Energy Conservation</span><span class="se">\n</span><span class="s1">(Numerical quality)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-772"><a href="#SymbolVisualizer-772"><span class="linenos">772</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</span><span id="SymbolVisualizer-773"><a href="#SymbolVisualizer-773"><span class="linenos">773</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-774"><a href="#SymbolVisualizer-774"><span class="linenos">774</span></a>    
</span><span id="SymbolVisualizer-775"><a href="#SymbolVisualizer-775"><span class="linenos">775</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_periodic_orbits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">H_grid</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-776"><a href="#SymbolVisualizer-776"><span class="linenos">776</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 9: Periodic orbits in phase space&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-777"><a href="#SymbolVisualizer-777"><span class="linenos">777</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-778"><a href="#SymbolVisualizer-778"><span class="linenos">778</span></a>        
</span><span id="SymbolVisualizer-779"><a href="#SymbolVisualizer-779"><span class="linenos">779</span></a>        <span class="c1"># Energy level sets</span>
</span><span id="SymbolVisualizer-780"><a href="#SymbolVisualizer-780"><span class="linenos">780</span></a>        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">])</span>
</span><span id="SymbolVisualizer-781"><a href="#SymbolVisualizer-781"><span class="linenos">781</span></a>        <span class="n">contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">H_grid</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> 
</span><span id="SymbolVisualizer-782"><a href="#SymbolVisualizer-782"><span class="linenos">782</span></a>                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="SymbolVisualizer-783"><a href="#SymbolVisualizer-783"><span class="linenos">783</span></a>        
</span><span id="SymbolVisualizer-784"><a href="#SymbolVisualizer-784"><span class="linenos">784</span></a>        <span class="c1"># Periodic orbits</span>
</span><span id="SymbolVisualizer-785"><a href="#SymbolVisualizer-785"><span class="linenos">785</span></a>        <span class="n">colors_orb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">)))</span>
</span><span id="SymbolVisualizer-786"><a href="#SymbolVisualizer-786"><span class="linenos">786</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">orb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">):</span>
</span><span id="SymbolVisualizer-787"><a href="#SymbolVisualizer-787"><span class="linenos">787</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">x_cycle</span><span class="p">,</span> <span class="n">orb</span><span class="o">.</span><span class="n">xi_cycle</span><span class="p">,</span> 
</span><span id="SymbolVisualizer-788"><a href="#SymbolVisualizer-788"><span class="linenos">788</span></a>                   <span class="n">color</span><span class="o">=</span><span class="n">colors_orb</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="SymbolVisualizer-789"><a href="#SymbolVisualizer-789"><span class="linenos">789</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">x0</span><span class="p">],</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">xi0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors_orb</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> 
</span><span id="SymbolVisualizer-790"><a href="#SymbolVisualizer-790"><span class="linenos">790</span></a>                      <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer-791"><a href="#SymbolVisualizer-791"><span class="linenos">791</span></a>        
</span><span id="SymbolVisualizer-792"><a href="#SymbolVisualizer-792"><span class="linenos">792</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-793"><a href="#SymbolVisualizer-793"><span class="linenos">793</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-794"><a href="#SymbolVisualizer-794"><span class="linenos">794</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Periodic Orbits</span><span class="se">\n</span><span class="s1">(Phase space)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-795"><a href="#SymbolVisualizer-795"><span class="linenos">795</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-796"><a href="#SymbolVisualizer-796"><span class="linenos">796</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-797"><a href="#SymbolVisualizer-797"><span class="linenos">797</span></a>    
</span><span id="SymbolVisualizer-798"><a href="#SymbolVisualizer-798"><span class="linenos">798</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_period_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-799"><a href="#SymbolVisualizer-799"><span class="linenos">799</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 10: Period-Energy relation&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-800"><a href="#SymbolVisualizer-800"><span class="linenos">800</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-801"><a href="#SymbolVisualizer-801"><span class="linenos">801</span></a>        
</span><span id="SymbolVisualizer-802"><a href="#SymbolVisualizer-802"><span class="linenos">802</span></a>        <span class="n">E_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-803"><a href="#SymbolVisualizer-803"><span class="linenos">803</span></a>        <span class="n">T_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-804"><a href="#SymbolVisualizer-804"><span class="linenos">804</span></a>        <span class="n">S_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-805"><a href="#SymbolVisualizer-805"><span class="linenos">805</span></a>        
</span><span id="SymbolVisualizer-806"><a href="#SymbolVisualizer-806"><span class="linenos">806</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_orb</span><span class="p">,</span> <span class="n">T_orb</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">S_orb</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
</span><span id="SymbolVisualizer-807"><a href="#SymbolVisualizer-807"><span class="linenos">807</span></a>                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-808"><a href="#SymbolVisualizer-808"><span class="linenos">808</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Action S&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-809"><a href="#SymbolVisualizer-809"><span class="linenos">809</span></a>        
</span><span id="SymbolVisualizer-810"><a href="#SymbolVisualizer-810"><span class="linenos">810</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-811"><a href="#SymbolVisualizer-811"><span class="linenos">811</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Period T&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-812"><a href="#SymbolVisualizer-812"><span class="linenos">812</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Period-Energy Diagram</span><span class="se">\n</span><span class="s1">T(E)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-813"><a href="#SymbolVisualizer-813"><span class="linenos">813</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-814"><a href="#SymbolVisualizer-814"><span class="linenos">814</span></a>    
</span><span id="SymbolVisualizer-815"><a href="#SymbolVisualizer-815"><span class="linenos">815</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_ebk_quantization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-816"><a href="#SymbolVisualizer-816"><span class="linenos">816</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 11: EBK quantization (Einstein-Brillouin-Keller)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-817"><a href="#SymbolVisualizer-817"><span class="linenos">817</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-818"><a href="#SymbolVisualizer-818"><span class="linenos">818</span></a>        
</span><span id="SymbolVisualizer-819"><a href="#SymbolVisualizer-819"><span class="linenos">819</span></a>        <span class="n">E_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-820"><a href="#SymbolVisualizer-820"><span class="linenos">820</span></a>        <span class="n">S_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-821"><a href="#SymbolVisualizer-821"><span class="linenos">821</span></a>        <span class="n">T_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-822"><a href="#SymbolVisualizer-822"><span class="linenos">822</span></a>        
</span><span id="SymbolVisualizer-823"><a href="#SymbolVisualizer-823"><span class="linenos">823</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_orb</span><span class="p">,</span> <span class="n">S_orb</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">T_orb</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer-824"><a href="#SymbolVisualizer-824"><span class="linenos">824</span></a>                           <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-825"><a href="#SymbolVisualizer-825"><span class="linenos">825</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Period T&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-826"><a href="#SymbolVisualizer-826"><span class="linenos">826</span></a>        
</span><span id="SymbolVisualizer-827"><a href="#SymbolVisualizer-827"><span class="linenos">827</span></a>        <span class="c1"># EBK quantization rules: S = 2πℏ(n + α)</span>
</span><span id="SymbolVisualizer-828"><a href="#SymbolVisualizer-828"><span class="linenos">828</span></a>        <span class="n">E_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">E_orb</span><span class="p">)</span> <span class="k">if</span> <span class="n">E_orb</span> <span class="k">else</span> <span class="mi">10</span>
</span><span id="SymbolVisualizer-829"><a href="#SymbolVisualizer-829"><span class="linenos">829</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
</span><span id="SymbolVisualizer-830"><a href="#SymbolVisualizer-830"><span class="linenos">830</span></a>            <span class="n">S_quant</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hbar</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># α ≈ 1/4 for 1D</span>
</span><span id="SymbolVisualizer-831"><a href="#SymbolVisualizer-831"><span class="linenos">831</span></a>            <span class="k">if</span> <span class="n">S_quant</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">S_orb</span><span class="p">)</span> <span class="k">if</span> <span class="n">S_orb</span> <span class="k">else</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="SymbolVisualizer-832"><a href="#SymbolVisualizer-832"><span class="linenos">832</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">S_quant</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SymbolVisualizer-833"><a href="#SymbolVisualizer-833"><span class="linenos">833</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">E_orb</span><span class="p">)</span> <span class="k">if</span> <span class="n">E_orb</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S_quant</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer-834"><a href="#SymbolVisualizer-834"><span class="linenos">834</span></a>                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-835"><a href="#SymbolVisualizer-835"><span class="linenos">835</span></a>        
</span><span id="SymbolVisualizer-836"><a href="#SymbolVisualizer-836"><span class="linenos">836</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-837"><a href="#SymbolVisualizer-837"><span class="linenos">837</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Action S&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-838"><a href="#SymbolVisualizer-838"><span class="linenos">838</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EBK Quantization</span><span class="se">\n</span><span class="s1">S = 2πℏ(n+α)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-839"><a href="#SymbolVisualizer-839"><span class="linenos">839</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-840"><a href="#SymbolVisualizer-840"><span class="linenos">840</span></a>    
</span><span id="SymbolVisualizer-841"><a href="#SymbolVisualizer-841"><span class="linenos">841</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_trace_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-842"><a href="#SymbolVisualizer-842"><span class="linenos">842</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 12: Gutzwiller trace formula&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-843"><a href="#SymbolVisualizer-843"><span class="linenos">843</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-844"><a href="#SymbolVisualizer-844"><span class="linenos">844</span></a>        
</span><span id="SymbolVisualizer-845"><a href="#SymbolVisualizer-845"><span class="linenos">845</span></a>        <span class="c1"># Plot only first part for clarity</span>
</span><span id="SymbolVisualizer-846"><a href="#SymbolVisualizer-846"><span class="linenos">846</span></a>        <span class="n">n_plot</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">trace_t</span><span class="p">))</span>
</span><span id="SymbolVisualizer-847"><a href="#SymbolVisualizer-847"><span class="linenos">847</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">trace_t</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">trace</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">]),</span>
</span><span id="SymbolVisualizer-848"><a href="#SymbolVisualizer-848"><span class="linenos">848</span></a>               <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Re[Tr]&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-849"><a href="#SymbolVisualizer-849"><span class="linenos">849</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">trace_t</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">trace</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">]),</span>
</span><span id="SymbolVisualizer-850"><a href="#SymbolVisualizer-850"><span class="linenos">850</span></a>               <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Im[Tr]&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-851"><a href="#SymbolVisualizer-851"><span class="linenos">851</span></a>        
</span><span id="SymbolVisualizer-852"><a href="#SymbolVisualizer-852"><span class="linenos">852</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-853"><a href="#SymbolVisualizer-853"><span class="linenos">853</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tr[exp(-iHt/ℏ)]&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-854"><a href="#SymbolVisualizer-854"><span class="linenos">854</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Gutzwiller Trace Formula</span><span class="se">\n</span><span class="s1">Σ_γ A_γ exp(iS_γ/ℏ)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-855"><a href="#SymbolVisualizer-855"><span class="linenos">855</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="SymbolVisualizer-856"><a href="#SymbolVisualizer-856"><span class="linenos">856</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-857"><a href="#SymbolVisualizer-857"><span class="linenos">857</span></a>    
</span><span id="SymbolVisualizer-858"><a href="#SymbolVisualizer-858"><span class="linenos">858</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-859"><a href="#SymbolVisualizer-859"><span class="linenos">859</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 13: Semiclassical spectrum&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-860"><a href="#SymbolVisualizer-860"><span class="linenos">860</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-861"><a href="#SymbolVisualizer-861"><span class="linenos">861</span></a>        
</span><span id="SymbolVisualizer-862"><a href="#SymbolVisualizer-862"><span class="linenos">862</span></a>        <span class="c1"># Only positive energies</span>
</span><span id="SymbolVisualizer-863"><a href="#SymbolVisualizer-863"><span class="linenos">863</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energies</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="SymbolVisualizer-864"><a href="#SymbolVisualizer-864"><span class="linenos">864</span></a>        <span class="n">E_positive</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="SymbolVisualizer-865"><a href="#SymbolVisualizer-865"><span class="linenos">865</span></a>        <span class="n">I_positive</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="SymbolVisualizer-866"><a href="#SymbolVisualizer-866"><span class="linenos">866</span></a>        
</span><span id="SymbolVisualizer-867"><a href="#SymbolVisualizer-867"><span class="linenos">867</span></a>        <span class="c1"># Detect peaks</span>
</span><span id="SymbolVisualizer-868"><a href="#SymbolVisualizer-868"><span class="linenos">868</span></a>        <span class="n">peaks</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">I_positive</span><span class="p">,</span> 
</span><span id="SymbolVisualizer-869"><a href="#SymbolVisualizer-869"><span class="linenos">869</span></a>                                      <span class="n">height</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I_positive</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="SymbolVisualizer-870"><a href="#SymbolVisualizer-870"><span class="linenos">870</span></a>                                      <span class="n">distance</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolVisualizer-871"><a href="#SymbolVisualizer-871"><span class="linenos">871</span></a>        
</span><span id="SymbolVisualizer-872"><a href="#SymbolVisualizer-872"><span class="linenos">872</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_positive</span><span class="p">,</span> <span class="n">I_positive</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-873"><a href="#SymbolVisualizer-873"><span class="linenos">873</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_positive</span><span class="p">[</span><span class="n">peaks</span><span class="p">],</span> <span class="n">I_positive</span><span class="p">[</span><span class="n">peaks</span><span class="p">],</span>
</span><span id="SymbolVisualizer-874"><a href="#SymbolVisualizer-874"><span class="linenos">874</span></a>               <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Energy levels&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-875"><a href="#SymbolVisualizer-875"><span class="linenos">875</span></a>        
</span><span id="SymbolVisualizer-876"><a href="#SymbolVisualizer-876"><span class="linenos">876</span></a>        <span class="c1"># Annotate first levels</span>
</span><span id="SymbolVisualizer-877"><a href="#SymbolVisualizer-877"><span class="linenos">877</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
</span><span id="SymbolVisualizer-878"><a href="#SymbolVisualizer-878"><span class="linenos">878</span></a>            <span class="n">E_level</span> <span class="o">=</span> <span class="n">E_positive</span><span class="p">[</span><span class="n">peak</span><span class="p">]</span>
</span><span id="SymbolVisualizer-879"><a href="#SymbolVisualizer-879"><span class="linenos">879</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">E_level</span><span class="p">,</span> <span class="n">I_positive</span><span class="p">[</span><span class="n">peak</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;E_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer-880"><a href="#SymbolVisualizer-880"><span class="linenos">880</span></a>                   <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-881"><a href="#SymbolVisualizer-881"><span class="linenos">881</span></a>        
</span><span id="SymbolVisualizer-882"><a href="#SymbolVisualizer-882"><span class="linenos">882</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-883"><a href="#SymbolVisualizer-883"><span class="linenos">883</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spectral density&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-884"><a href="#SymbolVisualizer-884"><span class="linenos">884</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Semiclassical Spectrum</span><span class="se">\n</span><span class="s1">(Fourier transform of trace)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-885"><a href="#SymbolVisualizer-885"><span class="linenos">885</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="SymbolVisualizer-886"><a href="#SymbolVisualizer-886"><span class="linenos">886</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-887"><a href="#SymbolVisualizer-887"><span class="linenos">887</span></a>    
</span><span id="SymbolVisualizer-888"><a href="#SymbolVisualizer-888"><span class="linenos">888</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-889"><a href="#SymbolVisualizer-889"><span class="linenos">889</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 14: Orbit stability (Lyapunov exponents)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-890"><a href="#SymbolVisualizer-890"><span class="linenos">890</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-891"><a href="#SymbolVisualizer-891"><span class="linenos">891</span></a>        
</span><span id="SymbolVisualizer-892"><a href="#SymbolVisualizer-892"><span class="linenos">892</span></a>        <span class="n">stab</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">stability</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-893"><a href="#SymbolVisualizer-893"><span class="linenos">893</span></a>        <span class="n">E_stab</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-894"><a href="#SymbolVisualizer-894"><span class="linenos">894</span></a>        <span class="n">T_stab</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer-895"><a href="#SymbolVisualizer-895"><span class="linenos">895</span></a>        
</span><span id="SymbolVisualizer-896"><a href="#SymbolVisualizer-896"><span class="linenos">896</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_stab</span><span class="p">,</span> <span class="n">stab</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">T_stab</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;autumn&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer-897"><a href="#SymbolVisualizer-897"><span class="linenos">897</span></a>                           <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer-898"><a href="#SymbolVisualizer-898"><span class="linenos">898</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Period T&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-899"><a href="#SymbolVisualizer-899"><span class="linenos">899</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="SymbolVisualizer-900"><a href="#SymbolVisualizer-900"><span class="linenos">900</span></a>                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Marginal stability&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-901"><a href="#SymbolVisualizer-901"><span class="linenos">901</span></a>        
</span><span id="SymbolVisualizer-902"><a href="#SymbolVisualizer-902"><span class="linenos">902</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-903"><a href="#SymbolVisualizer-903"><span class="linenos">903</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Lyapunov exponent λ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-904"><a href="#SymbolVisualizer-904"><span class="linenos">904</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Orbit Stability</span><span class="se">\n</span><span class="s1">λ&gt;0: unstable | λ&lt;0: stable&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-905"><a href="#SymbolVisualizer-905"><span class="linenos">905</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="SymbolVisualizer-906"><a href="#SymbolVisualizer-906"><span class="linenos">906</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer-907"><a href="#SymbolVisualizer-907"><span class="linenos">907</span></a>    
</span><span id="SymbolVisualizer-908"><a href="#SymbolVisualizer-908"><span class="linenos">908</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_level_spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
</span><span id="SymbolVisualizer-909"><a href="#SymbolVisualizer-909"><span class="linenos">909</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Panel 15: Level spacing distribution (integrability test)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer-910"><a href="#SymbolVisualizer-910"><span class="linenos">910</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span>
</span><span id="SymbolVisualizer-911"><a href="#SymbolVisualizer-911"><span class="linenos">911</span></a>        
</span><span id="SymbolVisualizer-912"><a href="#SymbolVisualizer-912"><span class="linenos">912</span></a>        <span class="c1"># Extract energy levels</span>
</span><span id="SymbolVisualizer-913"><a href="#SymbolVisualizer-913"><span class="linenos">913</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energies</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="SymbolVisualizer-914"><a href="#SymbolVisualizer-914"><span class="linenos">914</span></a>        <span class="n">E_positive</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="SymbolVisualizer-915"><a href="#SymbolVisualizer-915"><span class="linenos">915</span></a>        <span class="n">I_positive</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="SymbolVisualizer-916"><a href="#SymbolVisualizer-916"><span class="linenos">916</span></a>        
</span><span id="SymbolVisualizer-917"><a href="#SymbolVisualizer-917"><span class="linenos">917</span></a>        <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">I_positive</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I_positive</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> 
</span><span id="SymbolVisualizer-918"><a href="#SymbolVisualizer-918"><span class="linenos">918</span></a>        
</span><span id="SymbolVisualizer-919"><a href="#SymbolVisualizer-919"><span class="linenos">919</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SymbolVisualizer-920"><a href="#SymbolVisualizer-920"><span class="linenos">920</span></a>            <span class="n">E_levels</span> <span class="o">=</span> <span class="n">E_positive</span><span class="p">[</span><span class="n">peaks</span><span class="p">]</span>
</span><span id="SymbolVisualizer-921"><a href="#SymbolVisualizer-921"><span class="linenos">921</span></a>            <span class="n">spacings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">E_levels</span><span class="p">)</span>
</span><span id="SymbolVisualizer-922"><a href="#SymbolVisualizer-922"><span class="linenos">922</span></a>            
</span><span id="SymbolVisualizer-923"><a href="#SymbolVisualizer-923"><span class="linenos">923</span></a>            <span class="c1"># Normalize spacings</span>
</span><span id="SymbolVisualizer-924"><a href="#SymbolVisualizer-924"><span class="linenos">924</span></a>            <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spacings</span><span class="p">)</span>
</span><span id="SymbolVisualizer-925"><a href="#SymbolVisualizer-925"><span class="linenos">925</span></a>            <span class="n">s_normalized</span> <span class="o">=</span> <span class="n">spacings</span> <span class="o">/</span> <span class="n">s_mean</span>
</span><span id="SymbolVisualizer-926"><a href="#SymbolVisualizer-926"><span class="linenos">926</span></a>            
</span><span id="SymbolVisualizer-927"><a href="#SymbolVisualizer-927"><span class="linenos">927</span></a>            <span class="c1"># Histogram</span>
</span><span id="SymbolVisualizer-928"><a href="#SymbolVisualizer-928"><span class="linenos">928</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">s_normalized</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="SymbolVisualizer-929"><a href="#SymbolVisualizer-929"><span class="linenos">929</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-930"><a href="#SymbolVisualizer-930"><span class="linenos">930</span></a>            
</span><span id="SymbolVisualizer-931"><a href="#SymbolVisualizer-931"><span class="linenos">931</span></a>            <span class="c1"># Theoretical distributions</span>
</span><span id="SymbolVisualizer-932"><a href="#SymbolVisualizer-932"><span class="linenos">932</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s_normalized</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="SymbolVisualizer-933"><a href="#SymbolVisualizer-933"><span class="linenos">933</span></a>            
</span><span id="SymbolVisualizer-934"><a href="#SymbolVisualizer-934"><span class="linenos">934</span></a>            <span class="c1"># Poisson (integrable systems)</span>
</span><span id="SymbolVisualizer-935"><a href="#SymbolVisualizer-935"><span class="linenos">935</span></a>            <span class="n">poisson</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>
</span><span id="SymbolVisualizer-936"><a href="#SymbolVisualizer-936"><span class="linenos">936</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">poisson</span><span class="p">,</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Poisson (integrable)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-937"><a href="#SymbolVisualizer-937"><span class="linenos">937</span></a>            
</span><span id="SymbolVisualizer-938"><a href="#SymbolVisualizer-938"><span class="linenos">938</span></a>            <span class="c1"># Wigner (chaotic systems)</span>
</span><span id="SymbolVisualizer-939"><a href="#SymbolVisualizer-939"><span class="linenos">939</span></a>            <span class="n">wigner</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="SymbolVisualizer-940"><a href="#SymbolVisualizer-940"><span class="linenos">940</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">wigner</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wigner (chaotic)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-941"><a href="#SymbolVisualizer-941"><span class="linenos">941</span></a>            
</span><span id="SymbolVisualizer-942"><a href="#SymbolVisualizer-942"><span class="linenos">942</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Normalized spacing s&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-943"><a href="#SymbolVisualizer-943"><span class="linenos">943</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(s)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-944"><a href="#SymbolVisualizer-944"><span class="linenos">944</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Level Spacing Distribution</span><span class="se">\n</span><span class="s1">Integrable vs Chaotic&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer-945"><a href="#SymbolVisualizer-945"><span class="linenos">945</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="SymbolVisualizer-946"><a href="#SymbolVisualizer-946"><span class="linenos">946</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Comprehensive visualization of symbol geometry</p>

<p>Produces 15 panels showing:</p>

<ol>
<li>Hamiltonian surface (3D)</li>
<li>Energy level sets (phase space foliation)</li>
<li>Hamiltonian vector field</li>
<li>Group velocity ∂H/∂ξ</li>
<li>Spatial projection (caustics)</li>
<li>Jacobian (focusing measure)</li>
<li>Curvature (focusing tendency)</li>
<li>Energy conservation</li>
<li>Periodic orbits (phase space)</li>
<li>Period-energy diagram</li>
<li>EBK quantization</li>
<li>Trace formula</li>
<li>Semiclassical spectrum</li>
<li>Orbit stability</li>
<li>Level spacing distribution</li>
</ol>
</div>


                            <div id="SymbolVisualizer.__init__" class="classattr">
                                        <input id="SymbolVisualizer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SymbolVisualizer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">geometry</span><span class="p">:</span> <span class="n"><a href="#SymbolGeometry">SymbolGeometry</a></span></span>)</span>

                <label class="view-source-button" for="SymbolVisualizer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolVisualizer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolVisualizer.__init__-496"><a href="#SymbolVisualizer.__init__-496"><span class="linenos">496</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">SymbolGeometry</span><span class="p">):</span>
</span><span id="SymbolVisualizer.__init__-497"><a href="#SymbolVisualizer.__init__-497"><span class="linenos">497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer.__init__-498"><a href="#SymbolVisualizer.__init__-498"><span class="linenos">498</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolVisualizer.__init__-499"><a href="#SymbolVisualizer.__init__-499"><span class="linenos">499</span></a><span class="sd">        ----------</span>
</span><span id="SymbolVisualizer.__init__-500"><a href="#SymbolVisualizer.__init__-500"><span class="linenos">500</span></a><span class="sd">        geometry : SymbolGeometry</span>
</span><span id="SymbolVisualizer.__init__-501"><a href="#SymbolVisualizer.__init__-501"><span class="linenos">501</span></a><span class="sd">            Initialized geometry engine</span>
</span><span id="SymbolVisualizer.__init__-502"><a href="#SymbolVisualizer.__init__-502"><span class="linenos">502</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer.__init__-503"><a href="#SymbolVisualizer.__init__-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">geometry</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<p>geometry : SymbolGeometry
    Initialized geometry engine</p>
</div>


                            </div>
                            <div id="SymbolVisualizer.geo" class="classattr">
                                <div class="attr variable">
            <span class="name">geo</span>

        
    </div>
    <a class="headerlink" href="#SymbolVisualizer.geo"></a>
    
    

                            </div>
                            <div id="SymbolVisualizer.visualize_complete" class="classattr">
                                        <input id="SymbolVisualizer.visualize_complete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_complete</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">geodesics_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span>,</span><span class="param">	<span class="n">E_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span></span><span class="return-annotation">) -> <span class="n">Tuple</span>:</span></span>

                <label class="view-source-button" for="SymbolVisualizer.visualize_complete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolVisualizer.visualize_complete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolVisualizer.visualize_complete-505"><a href="#SymbolVisualizer.visualize_complete-505"><span class="linenos">505</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="SymbolVisualizer.visualize_complete-506"><a href="#SymbolVisualizer.visualize_complete-506"><span class="linenos">506</span></a>                          <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer.visualize_complete-507"><a href="#SymbolVisualizer.visualize_complete-507"><span class="linenos">507</span></a>                          <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer.visualize_complete-508"><a href="#SymbolVisualizer.visualize_complete-508"><span class="linenos">508</span></a>                          <span class="n">geodesics_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span>
</span><span id="SymbolVisualizer.visualize_complete-509"><a href="#SymbolVisualizer.visualize_complete-509"><span class="linenos">509</span></a>                          <span class="n">E_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SymbolVisualizer.visualize_complete-510"><a href="#SymbolVisualizer.visualize_complete-510"><span class="linenos">510</span></a>                          <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="SymbolVisualizer.visualize_complete-511"><a href="#SymbolVisualizer.visualize_complete-511"><span class="linenos">511</span></a>                          <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="SymbolVisualizer.visualize_complete-512"><a href="#SymbolVisualizer.visualize_complete-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer.visualize_complete-513"><a href="#SymbolVisualizer.visualize_complete-513"><span class="linenos">513</span></a><span class="sd">        Create complete geometric atlas</span>
</span><span id="SymbolVisualizer.visualize_complete-514"><a href="#SymbolVisualizer.visualize_complete-514"><span class="linenos">514</span></a><span class="sd">        </span>
</span><span id="SymbolVisualizer.visualize_complete-515"><a href="#SymbolVisualizer.visualize_complete-515"><span class="linenos">515</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolVisualizer.visualize_complete-516"><a href="#SymbolVisualizer.visualize_complete-516"><span class="linenos">516</span></a><span class="sd">        ----------</span>
</span><span id="SymbolVisualizer.visualize_complete-517"><a href="#SymbolVisualizer.visualize_complete-517"><span class="linenos">517</span></a><span class="sd">        x_range, xi_range : tuple</span>
</span><span id="SymbolVisualizer.visualize_complete-518"><a href="#SymbolVisualizer.visualize_complete-518"><span class="linenos">518</span></a><span class="sd">            Domain limits</span>
</span><span id="SymbolVisualizer.visualize_complete-519"><a href="#SymbolVisualizer.visualize_complete-519"><span class="linenos">519</span></a><span class="sd">        geodesics_params : list of tuples</span>
</span><span id="SymbolVisualizer.visualize_complete-520"><a href="#SymbolVisualizer.visualize_complete-520"><span class="linenos">520</span></a><span class="sd">            Each tuple: (x0, xi0, t_max, color)</span>
</span><span id="SymbolVisualizer.visualize_complete-521"><a href="#SymbolVisualizer.visualize_complete-521"><span class="linenos">521</span></a><span class="sd">        E_range : tuple, optional</span>
</span><span id="SymbolVisualizer.visualize_complete-522"><a href="#SymbolVisualizer.visualize_complete-522"><span class="linenos">522</span></a><span class="sd">            Energy range for spectral analysis</span>
</span><span id="SymbolVisualizer.visualize_complete-523"><a href="#SymbolVisualizer.visualize_complete-523"><span class="linenos">523</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolVisualizer.visualize_complete-524"><a href="#SymbolVisualizer.visualize_complete-524"><span class="linenos">524</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolVisualizer.visualize_complete-525"><a href="#SymbolVisualizer.visualize_complete-525"><span class="linenos">525</span></a><span class="sd">        resolution : int</span>
</span><span id="SymbolVisualizer.visualize_complete-526"><a href="#SymbolVisualizer.visualize_complete-526"><span class="linenos">526</span></a><span class="sd">            Grid resolution</span>
</span><span id="SymbolVisualizer.visualize_complete-527"><a href="#SymbolVisualizer.visualize_complete-527"><span class="linenos">527</span></a><span class="sd">            </span>
</span><span id="SymbolVisualizer.visualize_complete-528"><a href="#SymbolVisualizer.visualize_complete-528"><span class="linenos">528</span></a><span class="sd">        Returns</span>
</span><span id="SymbolVisualizer.visualize_complete-529"><a href="#SymbolVisualizer.visualize_complete-529"><span class="linenos">529</span></a><span class="sd">        -------</span>
</span><span id="SymbolVisualizer.visualize_complete-530"><a href="#SymbolVisualizer.visualize_complete-530"><span class="linenos">530</span></a><span class="sd">        fig, geodesics, periodic_orbits, spectrum</span>
</span><span id="SymbolVisualizer.visualize_complete-531"><a href="#SymbolVisualizer.visualize_complete-531"><span class="linenos">531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer.visualize_complete-532"><a href="#SymbolVisualizer.visualize_complete-532"><span class="linenos">532</span></a>        <span class="c1"># Compute grid</span>
</span><span id="SymbolVisualizer.visualize_complete-533"><a href="#SymbolVisualizer.visualize_complete-533"><span class="linenos">533</span></a>        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-534"><a href="#SymbolVisualizer.visualize_complete-534"><span class="linenos">534</span></a>        <span class="n">xi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-535"><a href="#SymbolVisualizer.visualize_complete-535"><span class="linenos">535</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">xi_grid</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-536"><a href="#SymbolVisualizer.visualize_complete-536"><span class="linenos">536</span></a>        
</span><span id="SymbolVisualizer.visualize_complete-537"><a href="#SymbolVisualizer.visualize_complete-537"><span class="linenos">537</span></a>        <span class="c1"># Evaluate Hamiltonian and derivatives on grid</span>
</span><span id="SymbolVisualizer.visualize_complete-538"><a href="#SymbolVisualizer.visualize_complete-538"><span class="linenos">538</span></a>        <span class="n">grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_grids</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-539"><a href="#SymbolVisualizer.visualize_complete-539"><span class="linenos">539</span></a>        
</span><span id="SymbolVisualizer.visualize_complete-540"><a href="#SymbolVisualizer.visualize_complete-540"><span class="linenos">540</span></a>        <span class="c1"># Compute geodesics</span>
</span><span id="SymbolVisualizer.visualize_complete-541"><a href="#SymbolVisualizer.visualize_complete-541"><span class="linenos">541</span></a>        <span class="n">geodesics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesics</span><span class="p">(</span><span class="n">geodesics_params</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-542"><a href="#SymbolVisualizer.visualize_complete-542"><span class="linenos">542</span></a>        
</span><span id="SymbolVisualizer.visualize_complete-543"><a href="#SymbolVisualizer.visualize_complete-543"><span class="linenos">543</span></a>        <span class="c1"># Find periodic orbits (if E_range specified)</span>
</span><span id="SymbolVisualizer.visualize_complete-544"><a href="#SymbolVisualizer.visualize_complete-544"><span class="linenos">544</span></a>        <span class="n">periodic_orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer.visualize_complete-545"><a href="#SymbolVisualizer.visualize_complete-545"><span class="linenos">545</span></a>        <span class="n">spectrum</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SymbolVisualizer.visualize_complete-546"><a href="#SymbolVisualizer.visualize_complete-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="n">E_range</span><span class="p">:</span>
</span><span id="SymbolVisualizer.visualize_complete-547"><a href="#SymbolVisualizer.visualize_complete-547"><span class="linenos">547</span></a>            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-548"><a href="#SymbolVisualizer.visualize_complete-548"><span class="linenos">548</span></a>            <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
</span><span id="SymbolVisualizer.visualize_complete-549"><a href="#SymbolVisualizer.visualize_complete-549"><span class="linenos">549</span></a>                <span class="n">orbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">find_periodic_orbits</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-550"><a href="#SymbolVisualizer.visualize_complete-550"><span class="linenos">550</span></a>                <span class="n">periodic_orbits</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-551"><a href="#SymbolVisualizer.visualize_complete-551"><span class="linenos">551</span></a>            
</span><span id="SymbolVisualizer.visualize_complete-552"><a href="#SymbolVisualizer.visualize_complete-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolVisualizer.visualize_complete-553"><a href="#SymbolVisualizer.visualize_complete-553"><span class="linenos">553</span></a>                <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">semiclassical_spectrum</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">hbar</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-554"><a href="#SymbolVisualizer.visualize_complete-554"><span class="linenos">554</span></a>        
</span><span id="SymbolVisualizer.visualize_complete-555"><a href="#SymbolVisualizer.visualize_complete-555"><span class="linenos">555</span></a>        <span class="c1"># Create figure</span>
</span><span id="SymbolVisualizer.visualize_complete-556"><a href="#SymbolVisualizer.visualize_complete-556"><span class="linenos">556</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_figure</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">grids</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">hbar</span><span class="p">)</span>
</span><span id="SymbolVisualizer.visualize_complete-557"><a href="#SymbolVisualizer.visualize_complete-557"><span class="linenos">557</span></a>        
</span><span id="SymbolVisualizer.visualize_complete-558"><a href="#SymbolVisualizer.visualize_complete-558"><span class="linenos">558</span></a>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">spectrum</span>
</span></pre></div>


            <div class="docstring"><p>Create complete geometric atlas</p>

<h2 id="parameters">Parameters</h2>

<p>x_range, xi_range : tuple
    Domain limits
geodesics_params : list of tuples
    Each tuple: (x0, xi0, t_max, color)
E_range : tuple, optional
    Energy range for spectral analysis
hbar : float
    Reduced Planck constant
resolution : int
    Grid resolution</p>

<h2 id="returns">Returns</h2>

<p>fig, geodesics, periodic_orbits, spectrum</p>
</div>


                            </div>
                </section>
                <section id="SpectralAnalysis">
                            <input id="SpectralAnalysis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SpectralAnalysis</span>:

                <label class="view-source-button" for="SpectralAnalysis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpectralAnalysis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpectralAnalysis-953"><a href="#SpectralAnalysis-953"><span class="linenos"> 953</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SpectralAnalysis</span><span class="p">:</span>
</span><span id="SpectralAnalysis-954"><a href="#SpectralAnalysis-954"><span class="linenos"> 954</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-955"><a href="#SpectralAnalysis-955"><span class="linenos"> 955</span></a><span class="sd">    Additional spectral analysis tools</span>
</span><span id="SpectralAnalysis-956"><a href="#SpectralAnalysis-956"><span class="linenos"> 956</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-957"><a href="#SpectralAnalysis-957"><span class="linenos"> 957</span></a>    
</span><span id="SpectralAnalysis-958"><a href="#SpectralAnalysis-958"><span class="linenos"> 958</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SpectralAnalysis-959"><a href="#SpectralAnalysis-959"><span class="linenos"> 959</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weyl_law</span><span class="p">(</span><span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SpectralAnalysis-960"><a href="#SpectralAnalysis-960"><span class="linenos"> 960</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-961"><a href="#SpectralAnalysis-961"><span class="linenos"> 961</span></a><span class="sd">        Weyl&#39;s law: asymptotic density of states</span>
</span><span id="SpectralAnalysis-962"><a href="#SpectralAnalysis-962"><span class="linenos"> 962</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis-963"><a href="#SpectralAnalysis-963"><span class="linenos"> 963</span></a><span class="sd">        N(E) ~ (1/2πℏ)^d × Vol{H(x,p) ≤ E}</span>
</span><span id="SpectralAnalysis-964"><a href="#SpectralAnalysis-964"><span class="linenos"> 964</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis-965"><a href="#SpectralAnalysis-965"><span class="linenos"> 965</span></a><span class="sd">        Parameters</span>
</span><span id="SpectralAnalysis-966"><a href="#SpectralAnalysis-966"><span class="linenos"> 966</span></a><span class="sd">        ----------</span>
</span><span id="SpectralAnalysis-967"><a href="#SpectralAnalysis-967"><span class="linenos"> 967</span></a><span class="sd">        energy : float</span>
</span><span id="SpectralAnalysis-968"><a href="#SpectralAnalysis-968"><span class="linenos"> 968</span></a><span class="sd">            Energy threshold</span>
</span><span id="SpectralAnalysis-969"><a href="#SpectralAnalysis-969"><span class="linenos"> 969</span></a><span class="sd">        dimension : int</span>
</span><span id="SpectralAnalysis-970"><a href="#SpectralAnalysis-970"><span class="linenos"> 970</span></a><span class="sd">            Phase space dimension</span>
</span><span id="SpectralAnalysis-971"><a href="#SpectralAnalysis-971"><span class="linenos"> 971</span></a><span class="sd">        hbar : float</span>
</span><span id="SpectralAnalysis-972"><a href="#SpectralAnalysis-972"><span class="linenos"> 972</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SpectralAnalysis-973"><a href="#SpectralAnalysis-973"><span class="linenos"> 973</span></a><span class="sd">            </span>
</span><span id="SpectralAnalysis-974"><a href="#SpectralAnalysis-974"><span class="linenos"> 974</span></a><span class="sd">        Returns</span>
</span><span id="SpectralAnalysis-975"><a href="#SpectralAnalysis-975"><span class="linenos"> 975</span></a><span class="sd">        -------</span>
</span><span id="SpectralAnalysis-976"><a href="#SpectralAnalysis-976"><span class="linenos"> 976</span></a><span class="sd">        float</span>
</span><span id="SpectralAnalysis-977"><a href="#SpectralAnalysis-977"><span class="linenos"> 977</span></a><span class="sd">            Approximate number of states below energy E</span>
</span><span id="SpectralAnalysis-978"><a href="#SpectralAnalysis-978"><span class="linenos"> 978</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-979"><a href="#SpectralAnalysis-979"><span class="linenos"> 979</span></a>        <span class="c1"># Simplified: assumes phase space volume ~ E^d</span>
</span><span id="SpectralAnalysis-980"><a href="#SpectralAnalysis-980"><span class="linenos"> 980</span></a>        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hbar</span><span class="p">))</span> <span class="o">**</span> <span class="n">dimension</span>
</span><span id="SpectralAnalysis-981"><a href="#SpectralAnalysis-981"><span class="linenos"> 981</span></a>        <span class="k">return</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">energy</span> <span class="o">**</span> <span class="n">dimension</span><span class="p">)</span>
</span><span id="SpectralAnalysis-982"><a href="#SpectralAnalysis-982"><span class="linenos"> 982</span></a>    
</span><span id="SpectralAnalysis-983"><a href="#SpectralAnalysis-983"><span class="linenos"> 983</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SpectralAnalysis-984"><a href="#SpectralAnalysis-984"><span class="linenos"> 984</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_integrability</span><span class="p">(</span><span class="n">spacings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="SpectralAnalysis-985"><a href="#SpectralAnalysis-985"><span class="linenos"> 985</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-986"><a href="#SpectralAnalysis-986"><span class="linenos"> 986</span></a><span class="sd">        Determine if system is integrable or chaotic via level statistics</span>
</span><span id="SpectralAnalysis-987"><a href="#SpectralAnalysis-987"><span class="linenos"> 987</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis-988"><a href="#SpectralAnalysis-988"><span class="linenos"> 988</span></a><span class="sd">        Parameters</span>
</span><span id="SpectralAnalysis-989"><a href="#SpectralAnalysis-989"><span class="linenos"> 989</span></a><span class="sd">        ----------</span>
</span><span id="SpectralAnalysis-990"><a href="#SpectralAnalysis-990"><span class="linenos"> 990</span></a><span class="sd">        spacings : array</span>
</span><span id="SpectralAnalysis-991"><a href="#SpectralAnalysis-991"><span class="linenos"> 991</span></a><span class="sd">            Energy level spacings</span>
</span><span id="SpectralAnalysis-992"><a href="#SpectralAnalysis-992"><span class="linenos"> 992</span></a><span class="sd">            </span>
</span><span id="SpectralAnalysis-993"><a href="#SpectralAnalysis-993"><span class="linenos"> 993</span></a><span class="sd">        Returns</span>
</span><span id="SpectralAnalysis-994"><a href="#SpectralAnalysis-994"><span class="linenos"> 994</span></a><span class="sd">        -------</span>
</span><span id="SpectralAnalysis-995"><a href="#SpectralAnalysis-995"><span class="linenos"> 995</span></a><span class="sd">        dict</span>
</span><span id="SpectralAnalysis-996"><a href="#SpectralAnalysis-996"><span class="linenos"> 996</span></a><span class="sd">            Statistical measures and classification</span>
</span><span id="SpectralAnalysis-997"><a href="#SpectralAnalysis-997"><span class="linenos"> 997</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-998"><a href="#SpectralAnalysis-998"><span class="linenos"> 998</span></a>        <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spacings</span><span class="p">)</span>
</span><span id="SpectralAnalysis-999"><a href="#SpectralAnalysis-999"><span class="linenos"> 999</span></a>        <span class="n">s_normalized</span> <span class="o">=</span> <span class="n">spacings</span> <span class="o">/</span> <span class="n">s_mean</span>
</span><span id="SpectralAnalysis-1000"><a href="#SpectralAnalysis-1000"><span class="linenos">1000</span></a>        
</span><span id="SpectralAnalysis-1001"><a href="#SpectralAnalysis-1001"><span class="linenos">1001</span></a>        <span class="c1"># Brody parameter (0: Poisson, 1: Wigner)</span>
</span><span id="SpectralAnalysis-1002"><a href="#SpectralAnalysis-1002"><span class="linenos">1002</span></a>        <span class="c1"># Fit P(s) = a s^β exp(-b s^(β+1))</span>
</span><span id="SpectralAnalysis-1003"><a href="#SpectralAnalysis-1003"><span class="linenos">1003</span></a>        <span class="c1"># Simplified: use ratio test</span>
</span><span id="SpectralAnalysis-1004"><a href="#SpectralAnalysis-1004"><span class="linenos">1004</span></a>        
</span><span id="SpectralAnalysis-1005"><a href="#SpectralAnalysis-1005"><span class="linenos">1005</span></a>        <span class="c1"># &lt;s²&gt;/&lt;s&gt;² ratio</span>
</span><span id="SpectralAnalysis-1006"><a href="#SpectralAnalysis-1006"><span class="linenos">1006</span></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_normalized</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_normalized</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SpectralAnalysis-1007"><a href="#SpectralAnalysis-1007"><span class="linenos">1007</span></a>        
</span><span id="SpectralAnalysis-1008"><a href="#SpectralAnalysis-1008"><span class="linenos">1008</span></a>        <span class="c1"># Poisson: ratio ≈ 2</span>
</span><span id="SpectralAnalysis-1009"><a href="#SpectralAnalysis-1009"><span class="linenos">1009</span></a>        <span class="c1"># Wigner: ratio ≈ 1.27</span>
</span><span id="SpectralAnalysis-1010"><a href="#SpectralAnalysis-1010"><span class="linenos">1010</span></a>        
</span><span id="SpectralAnalysis-1011"><a href="#SpectralAnalysis-1011"><span class="linenos">1011</span></a>        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">1.7</span><span class="p">:</span>
</span><span id="SpectralAnalysis-1012"><a href="#SpectralAnalysis-1012"><span class="linenos">1012</span></a>            <span class="n">classification</span> <span class="o">=</span> <span class="s2">&quot;Integrable (Poisson-like)&quot;</span>
</span><span id="SpectralAnalysis-1013"><a href="#SpectralAnalysis-1013"><span class="linenos">1013</span></a>        <span class="k">elif</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mf">1.4</span><span class="p">:</span>
</span><span id="SpectralAnalysis-1014"><a href="#SpectralAnalysis-1014"><span class="linenos">1014</span></a>            <span class="n">classification</span> <span class="o">=</span> <span class="s2">&quot;Chaotic (Wigner-like)&quot;</span>
</span><span id="SpectralAnalysis-1015"><a href="#SpectralAnalysis-1015"><span class="linenos">1015</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SpectralAnalysis-1016"><a href="#SpectralAnalysis-1016"><span class="linenos">1016</span></a>            <span class="n">classification</span> <span class="o">=</span> <span class="s2">&quot;Intermediate&quot;</span>
</span><span id="SpectralAnalysis-1017"><a href="#SpectralAnalysis-1017"><span class="linenos">1017</span></a>        
</span><span id="SpectralAnalysis-1018"><a href="#SpectralAnalysis-1018"><span class="linenos">1018</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="SpectralAnalysis-1019"><a href="#SpectralAnalysis-1019"><span class="linenos">1019</span></a>            <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">ratio</span><span class="p">,</span>
</span><span id="SpectralAnalysis-1020"><a href="#SpectralAnalysis-1020"><span class="linenos">1020</span></a>            <span class="s1">&#39;mean_spacing&#39;</span><span class="p">:</span> <span class="n">s_mean</span><span class="p">,</span>
</span><span id="SpectralAnalysis-1021"><a href="#SpectralAnalysis-1021"><span class="linenos">1021</span></a>            <span class="s1">&#39;std_spacing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spacings</span><span class="p">),</span>
</span><span id="SpectralAnalysis-1022"><a href="#SpectralAnalysis-1022"><span class="linenos">1022</span></a>            <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="n">classification</span>
</span><span id="SpectralAnalysis-1023"><a href="#SpectralAnalysis-1023"><span class="linenos">1023</span></a>        <span class="p">}</span>
</span><span id="SpectralAnalysis-1024"><a href="#SpectralAnalysis-1024"><span class="linenos">1024</span></a>
</span><span id="SpectralAnalysis-1025"><a href="#SpectralAnalysis-1025"><span class="linenos">1025</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SpectralAnalysis-1026"><a href="#SpectralAnalysis-1026"><span class="linenos">1026</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">berry_tabor_formula</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">],</span> 
</span><span id="SpectralAnalysis-1027"><a href="#SpectralAnalysis-1027"><span class="linenos">1027</span></a>                           <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SpectralAnalysis-1028"><a href="#SpectralAnalysis-1028"><span class="linenos">1028</span></a>                           <span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># ✅ Fenêtre paramétrable</span>
</span><span id="SpectralAnalysis-1029"><a href="#SpectralAnalysis-1029"><span class="linenos">1029</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-1030"><a href="#SpectralAnalysis-1030"><span class="linenos">1030</span></a><span class="sd">        Berry-Tabor formula for integrable systems</span>
</span><span id="SpectralAnalysis-1031"><a href="#SpectralAnalysis-1031"><span class="linenos">1031</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis-1032"><a href="#SpectralAnalysis-1032"><span class="linenos">1032</span></a><span class="sd">        Smoothed density of states from periodic orbits</span>
</span><span id="SpectralAnalysis-1033"><a href="#SpectralAnalysis-1033"><span class="linenos">1033</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis-1034"><a href="#SpectralAnalysis-1034"><span class="linenos">1034</span></a><span class="sd">        Parameters</span>
</span><span id="SpectralAnalysis-1035"><a href="#SpectralAnalysis-1035"><span class="linenos">1035</span></a><span class="sd">        ----------</span>
</span><span id="SpectralAnalysis-1036"><a href="#SpectralAnalysis-1036"><span class="linenos">1036</span></a><span class="sd">        periodic_orbits : list</span>
</span><span id="SpectralAnalysis-1037"><a href="#SpectralAnalysis-1037"><span class="linenos">1037</span></a><span class="sd">            Periodic orbits</span>
</span><span id="SpectralAnalysis-1038"><a href="#SpectralAnalysis-1038"><span class="linenos">1038</span></a><span class="sd">        energy : float</span>
</span><span id="SpectralAnalysis-1039"><a href="#SpectralAnalysis-1039"><span class="linenos">1039</span></a><span class="sd">            Energy at which to evaluate density</span>
</span><span id="SpectralAnalysis-1040"><a href="#SpectralAnalysis-1040"><span class="linenos">1040</span></a><span class="sd">            </span>
</span><span id="SpectralAnalysis-1041"><a href="#SpectralAnalysis-1041"><span class="linenos">1041</span></a><span class="sd">        Returns</span>
</span><span id="SpectralAnalysis-1042"><a href="#SpectralAnalysis-1042"><span class="linenos">1042</span></a><span class="sd">        -------</span>
</span><span id="SpectralAnalysis-1043"><a href="#SpectralAnalysis-1043"><span class="linenos">1043</span></a><span class="sd">        float</span>
</span><span id="SpectralAnalysis-1044"><a href="#SpectralAnalysis-1044"><span class="linenos">1044</span></a><span class="sd">            Density of states ρ(E)</span>
</span><span id="SpectralAnalysis-1045"><a href="#SpectralAnalysis-1045"><span class="linenos">1045</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis-1046"><a href="#SpectralAnalysis-1046"><span class="linenos">1046</span></a>        <span class="n">density</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SpectralAnalysis-1047"><a href="#SpectralAnalysis-1047"><span class="linenos">1047</span></a>        
</span><span id="SpectralAnalysis-1048"><a href="#SpectralAnalysis-1048"><span class="linenos">1048</span></a>        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SpectralAnalysis-1049"><a href="#SpectralAnalysis-1049"><span class="linenos">1049</span></a>            <span class="c1"># ✅ Contribution gaussienne lissée</span>
</span><span id="SpectralAnalysis-1050"><a href="#SpectralAnalysis-1050"><span class="linenos">1050</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">window</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="SpectralAnalysis-1051"><a href="#SpectralAnalysis-1051"><span class="linenos">1051</span></a>            <span class="n">density</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="SpectralAnalysis-1052"><a href="#SpectralAnalysis-1052"><span class="linenos">1052</span></a>        
</span><span id="SpectralAnalysis-1053"><a href="#SpectralAnalysis-1053"><span class="linenos">1053</span></a>        <span class="k">return</span> <span class="n">density</span> <span class="o">/</span> <span class="p">(</span><span class="n">window</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Additional spectral analysis tools</p>
</div>


                            <div id="SpectralAnalysis.weyl_law" class="classattr">
                                        <input id="SpectralAnalysis.weyl_law-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">weyl_law</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="SpectralAnalysis.weyl_law-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpectralAnalysis.weyl_law"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpectralAnalysis.weyl_law-958"><a href="#SpectralAnalysis.weyl_law-958"><span class="linenos">958</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SpectralAnalysis.weyl_law-959"><a href="#SpectralAnalysis.weyl_law-959"><span class="linenos">959</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weyl_law</span><span class="p">(</span><span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SpectralAnalysis.weyl_law-960"><a href="#SpectralAnalysis.weyl_law-960"><span class="linenos">960</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis.weyl_law-961"><a href="#SpectralAnalysis.weyl_law-961"><span class="linenos">961</span></a><span class="sd">        Weyl&#39;s law: asymptotic density of states</span>
</span><span id="SpectralAnalysis.weyl_law-962"><a href="#SpectralAnalysis.weyl_law-962"><span class="linenos">962</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis.weyl_law-963"><a href="#SpectralAnalysis.weyl_law-963"><span class="linenos">963</span></a><span class="sd">        N(E) ~ (1/2πℏ)^d × Vol{H(x,p) ≤ E}</span>
</span><span id="SpectralAnalysis.weyl_law-964"><a href="#SpectralAnalysis.weyl_law-964"><span class="linenos">964</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis.weyl_law-965"><a href="#SpectralAnalysis.weyl_law-965"><span class="linenos">965</span></a><span class="sd">        Parameters</span>
</span><span id="SpectralAnalysis.weyl_law-966"><a href="#SpectralAnalysis.weyl_law-966"><span class="linenos">966</span></a><span class="sd">        ----------</span>
</span><span id="SpectralAnalysis.weyl_law-967"><a href="#SpectralAnalysis.weyl_law-967"><span class="linenos">967</span></a><span class="sd">        energy : float</span>
</span><span id="SpectralAnalysis.weyl_law-968"><a href="#SpectralAnalysis.weyl_law-968"><span class="linenos">968</span></a><span class="sd">            Energy threshold</span>
</span><span id="SpectralAnalysis.weyl_law-969"><a href="#SpectralAnalysis.weyl_law-969"><span class="linenos">969</span></a><span class="sd">        dimension : int</span>
</span><span id="SpectralAnalysis.weyl_law-970"><a href="#SpectralAnalysis.weyl_law-970"><span class="linenos">970</span></a><span class="sd">            Phase space dimension</span>
</span><span id="SpectralAnalysis.weyl_law-971"><a href="#SpectralAnalysis.weyl_law-971"><span class="linenos">971</span></a><span class="sd">        hbar : float</span>
</span><span id="SpectralAnalysis.weyl_law-972"><a href="#SpectralAnalysis.weyl_law-972"><span class="linenos">972</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SpectralAnalysis.weyl_law-973"><a href="#SpectralAnalysis.weyl_law-973"><span class="linenos">973</span></a><span class="sd">            </span>
</span><span id="SpectralAnalysis.weyl_law-974"><a href="#SpectralAnalysis.weyl_law-974"><span class="linenos">974</span></a><span class="sd">        Returns</span>
</span><span id="SpectralAnalysis.weyl_law-975"><a href="#SpectralAnalysis.weyl_law-975"><span class="linenos">975</span></a><span class="sd">        -------</span>
</span><span id="SpectralAnalysis.weyl_law-976"><a href="#SpectralAnalysis.weyl_law-976"><span class="linenos">976</span></a><span class="sd">        float</span>
</span><span id="SpectralAnalysis.weyl_law-977"><a href="#SpectralAnalysis.weyl_law-977"><span class="linenos">977</span></a><span class="sd">            Approximate number of states below energy E</span>
</span><span id="SpectralAnalysis.weyl_law-978"><a href="#SpectralAnalysis.weyl_law-978"><span class="linenos">978</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis.weyl_law-979"><a href="#SpectralAnalysis.weyl_law-979"><span class="linenos">979</span></a>        <span class="c1"># Simplified: assumes phase space volume ~ E^d</span>
</span><span id="SpectralAnalysis.weyl_law-980"><a href="#SpectralAnalysis.weyl_law-980"><span class="linenos">980</span></a>        <span class="n">prefactor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hbar</span><span class="p">))</span> <span class="o">**</span> <span class="n">dimension</span>
</span><span id="SpectralAnalysis.weyl_law-981"><a href="#SpectralAnalysis.weyl_law-981"><span class="linenos">981</span></a>        <span class="k">return</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">energy</span> <span class="o">**</span> <span class="n">dimension</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Weyl's law: asymptotic density of states</p>

<p>N(E) ~ (1/2πℏ)^d × Vol{H(x,p) ≤ E}</p>

<h2 id="parameters">Parameters</h2>

<p>energy : float
    Energy threshold
dimension : int
    Phase space dimension
hbar : float
    Reduced Planck constant</p>

<h2 id="returns">Returns</h2>

<p>float
    Approximate number of states below energy E</p>
</div>


                            </div>
                            <div id="SpectralAnalysis.analyze_integrability" class="classattr">
                                        <input id="SpectralAnalysis.analyze_integrability-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">analyze_integrability</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">spacings</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="SpectralAnalysis.analyze_integrability-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpectralAnalysis.analyze_integrability"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpectralAnalysis.analyze_integrability-983"><a href="#SpectralAnalysis.analyze_integrability-983"><span class="linenos"> 983</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SpectralAnalysis.analyze_integrability-984"><a href="#SpectralAnalysis.analyze_integrability-984"><span class="linenos"> 984</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_integrability</span><span class="p">(</span><span class="n">spacings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="SpectralAnalysis.analyze_integrability-985"><a href="#SpectralAnalysis.analyze_integrability-985"><span class="linenos"> 985</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis.analyze_integrability-986"><a href="#SpectralAnalysis.analyze_integrability-986"><span class="linenos"> 986</span></a><span class="sd">        Determine if system is integrable or chaotic via level statistics</span>
</span><span id="SpectralAnalysis.analyze_integrability-987"><a href="#SpectralAnalysis.analyze_integrability-987"><span class="linenos"> 987</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis.analyze_integrability-988"><a href="#SpectralAnalysis.analyze_integrability-988"><span class="linenos"> 988</span></a><span class="sd">        Parameters</span>
</span><span id="SpectralAnalysis.analyze_integrability-989"><a href="#SpectralAnalysis.analyze_integrability-989"><span class="linenos"> 989</span></a><span class="sd">        ----------</span>
</span><span id="SpectralAnalysis.analyze_integrability-990"><a href="#SpectralAnalysis.analyze_integrability-990"><span class="linenos"> 990</span></a><span class="sd">        spacings : array</span>
</span><span id="SpectralAnalysis.analyze_integrability-991"><a href="#SpectralAnalysis.analyze_integrability-991"><span class="linenos"> 991</span></a><span class="sd">            Energy level spacings</span>
</span><span id="SpectralAnalysis.analyze_integrability-992"><a href="#SpectralAnalysis.analyze_integrability-992"><span class="linenos"> 992</span></a><span class="sd">            </span>
</span><span id="SpectralAnalysis.analyze_integrability-993"><a href="#SpectralAnalysis.analyze_integrability-993"><span class="linenos"> 993</span></a><span class="sd">        Returns</span>
</span><span id="SpectralAnalysis.analyze_integrability-994"><a href="#SpectralAnalysis.analyze_integrability-994"><span class="linenos"> 994</span></a><span class="sd">        -------</span>
</span><span id="SpectralAnalysis.analyze_integrability-995"><a href="#SpectralAnalysis.analyze_integrability-995"><span class="linenos"> 995</span></a><span class="sd">        dict</span>
</span><span id="SpectralAnalysis.analyze_integrability-996"><a href="#SpectralAnalysis.analyze_integrability-996"><span class="linenos"> 996</span></a><span class="sd">            Statistical measures and classification</span>
</span><span id="SpectralAnalysis.analyze_integrability-997"><a href="#SpectralAnalysis.analyze_integrability-997"><span class="linenos"> 997</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis.analyze_integrability-998"><a href="#SpectralAnalysis.analyze_integrability-998"><span class="linenos"> 998</span></a>        <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spacings</span><span class="p">)</span>
</span><span id="SpectralAnalysis.analyze_integrability-999"><a href="#SpectralAnalysis.analyze_integrability-999"><span class="linenos"> 999</span></a>        <span class="n">s_normalized</span> <span class="o">=</span> <span class="n">spacings</span> <span class="o">/</span> <span class="n">s_mean</span>
</span><span id="SpectralAnalysis.analyze_integrability-1000"><a href="#SpectralAnalysis.analyze_integrability-1000"><span class="linenos">1000</span></a>        
</span><span id="SpectralAnalysis.analyze_integrability-1001"><a href="#SpectralAnalysis.analyze_integrability-1001"><span class="linenos">1001</span></a>        <span class="c1"># Brody parameter (0: Poisson, 1: Wigner)</span>
</span><span id="SpectralAnalysis.analyze_integrability-1002"><a href="#SpectralAnalysis.analyze_integrability-1002"><span class="linenos">1002</span></a>        <span class="c1"># Fit P(s) = a s^β exp(-b s^(β+1))</span>
</span><span id="SpectralAnalysis.analyze_integrability-1003"><a href="#SpectralAnalysis.analyze_integrability-1003"><span class="linenos">1003</span></a>        <span class="c1"># Simplified: use ratio test</span>
</span><span id="SpectralAnalysis.analyze_integrability-1004"><a href="#SpectralAnalysis.analyze_integrability-1004"><span class="linenos">1004</span></a>        
</span><span id="SpectralAnalysis.analyze_integrability-1005"><a href="#SpectralAnalysis.analyze_integrability-1005"><span class="linenos">1005</span></a>        <span class="c1"># &lt;s²&gt;/&lt;s&gt;² ratio</span>
</span><span id="SpectralAnalysis.analyze_integrability-1006"><a href="#SpectralAnalysis.analyze_integrability-1006"><span class="linenos">1006</span></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_normalized</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_normalized</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SpectralAnalysis.analyze_integrability-1007"><a href="#SpectralAnalysis.analyze_integrability-1007"><span class="linenos">1007</span></a>        
</span><span id="SpectralAnalysis.analyze_integrability-1008"><a href="#SpectralAnalysis.analyze_integrability-1008"><span class="linenos">1008</span></a>        <span class="c1"># Poisson: ratio ≈ 2</span>
</span><span id="SpectralAnalysis.analyze_integrability-1009"><a href="#SpectralAnalysis.analyze_integrability-1009"><span class="linenos">1009</span></a>        <span class="c1"># Wigner: ratio ≈ 1.27</span>
</span><span id="SpectralAnalysis.analyze_integrability-1010"><a href="#SpectralAnalysis.analyze_integrability-1010"><span class="linenos">1010</span></a>        
</span><span id="SpectralAnalysis.analyze_integrability-1011"><a href="#SpectralAnalysis.analyze_integrability-1011"><span class="linenos">1011</span></a>        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">1.7</span><span class="p">:</span>
</span><span id="SpectralAnalysis.analyze_integrability-1012"><a href="#SpectralAnalysis.analyze_integrability-1012"><span class="linenos">1012</span></a>            <span class="n">classification</span> <span class="o">=</span> <span class="s2">&quot;Integrable (Poisson-like)&quot;</span>
</span><span id="SpectralAnalysis.analyze_integrability-1013"><a href="#SpectralAnalysis.analyze_integrability-1013"><span class="linenos">1013</span></a>        <span class="k">elif</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mf">1.4</span><span class="p">:</span>
</span><span id="SpectralAnalysis.analyze_integrability-1014"><a href="#SpectralAnalysis.analyze_integrability-1014"><span class="linenos">1014</span></a>            <span class="n">classification</span> <span class="o">=</span> <span class="s2">&quot;Chaotic (Wigner-like)&quot;</span>
</span><span id="SpectralAnalysis.analyze_integrability-1015"><a href="#SpectralAnalysis.analyze_integrability-1015"><span class="linenos">1015</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SpectralAnalysis.analyze_integrability-1016"><a href="#SpectralAnalysis.analyze_integrability-1016"><span class="linenos">1016</span></a>            <span class="n">classification</span> <span class="o">=</span> <span class="s2">&quot;Intermediate&quot;</span>
</span><span id="SpectralAnalysis.analyze_integrability-1017"><a href="#SpectralAnalysis.analyze_integrability-1017"><span class="linenos">1017</span></a>        
</span><span id="SpectralAnalysis.analyze_integrability-1018"><a href="#SpectralAnalysis.analyze_integrability-1018"><span class="linenos">1018</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="SpectralAnalysis.analyze_integrability-1019"><a href="#SpectralAnalysis.analyze_integrability-1019"><span class="linenos">1019</span></a>            <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">ratio</span><span class="p">,</span>
</span><span id="SpectralAnalysis.analyze_integrability-1020"><a href="#SpectralAnalysis.analyze_integrability-1020"><span class="linenos">1020</span></a>            <span class="s1">&#39;mean_spacing&#39;</span><span class="p">:</span> <span class="n">s_mean</span><span class="p">,</span>
</span><span id="SpectralAnalysis.analyze_integrability-1021"><a href="#SpectralAnalysis.analyze_integrability-1021"><span class="linenos">1021</span></a>            <span class="s1">&#39;std_spacing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spacings</span><span class="p">),</span>
</span><span id="SpectralAnalysis.analyze_integrability-1022"><a href="#SpectralAnalysis.analyze_integrability-1022"><span class="linenos">1022</span></a>            <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="n">classification</span>
</span><span id="SpectralAnalysis.analyze_integrability-1023"><a href="#SpectralAnalysis.analyze_integrability-1023"><span class="linenos">1023</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Determine if system is integrable or chaotic via level statistics</p>

<h2 id="parameters">Parameters</h2>

<p>spacings : array
    Energy level spacings</p>

<h2 id="returns">Returns</h2>

<p>dict
    Statistical measures and classification</p>
</div>


                            </div>
                            <div id="SpectralAnalysis.berry_tabor_formula" class="classattr">
                                        <input id="SpectralAnalysis.berry_tabor_formula-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">berry_tabor_formula</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_1d</span><span class="o">.</span><span class="n">PeriodicOrbit</span><span class="p">]</span>,</span><span class="param">	<span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="SpectralAnalysis.berry_tabor_formula-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SpectralAnalysis.berry_tabor_formula"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SpectralAnalysis.berry_tabor_formula-1025"><a href="#SpectralAnalysis.berry_tabor_formula-1025"><span class="linenos">1025</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1026"><a href="#SpectralAnalysis.berry_tabor_formula-1026"><span class="linenos">1026</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">berry_tabor_formula</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit</span><span class="p">],</span> 
</span><span id="SpectralAnalysis.berry_tabor_formula-1027"><a href="#SpectralAnalysis.berry_tabor_formula-1027"><span class="linenos">1027</span></a>                           <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SpectralAnalysis.berry_tabor_formula-1028"><a href="#SpectralAnalysis.berry_tabor_formula-1028"><span class="linenos">1028</span></a>                           <span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># ✅ Fenêtre paramétrable</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1029"><a href="#SpectralAnalysis.berry_tabor_formula-1029"><span class="linenos">1029</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1030"><a href="#SpectralAnalysis.berry_tabor_formula-1030"><span class="linenos">1030</span></a><span class="sd">        Berry-Tabor formula for integrable systems</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1031"><a href="#SpectralAnalysis.berry_tabor_formula-1031"><span class="linenos">1031</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1032"><a href="#SpectralAnalysis.berry_tabor_formula-1032"><span class="linenos">1032</span></a><span class="sd">        Smoothed density of states from periodic orbits</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1033"><a href="#SpectralAnalysis.berry_tabor_formula-1033"><span class="linenos">1033</span></a><span class="sd">        </span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1034"><a href="#SpectralAnalysis.berry_tabor_formula-1034"><span class="linenos">1034</span></a><span class="sd">        Parameters</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1035"><a href="#SpectralAnalysis.berry_tabor_formula-1035"><span class="linenos">1035</span></a><span class="sd">        ----------</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1036"><a href="#SpectralAnalysis.berry_tabor_formula-1036"><span class="linenos">1036</span></a><span class="sd">        periodic_orbits : list</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1037"><a href="#SpectralAnalysis.berry_tabor_formula-1037"><span class="linenos">1037</span></a><span class="sd">            Periodic orbits</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1038"><a href="#SpectralAnalysis.berry_tabor_formula-1038"><span class="linenos">1038</span></a><span class="sd">        energy : float</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1039"><a href="#SpectralAnalysis.berry_tabor_formula-1039"><span class="linenos">1039</span></a><span class="sd">            Energy at which to evaluate density</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1040"><a href="#SpectralAnalysis.berry_tabor_formula-1040"><span class="linenos">1040</span></a><span class="sd">            </span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1041"><a href="#SpectralAnalysis.berry_tabor_formula-1041"><span class="linenos">1041</span></a><span class="sd">        Returns</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1042"><a href="#SpectralAnalysis.berry_tabor_formula-1042"><span class="linenos">1042</span></a><span class="sd">        -------</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1043"><a href="#SpectralAnalysis.berry_tabor_formula-1043"><span class="linenos">1043</span></a><span class="sd">        float</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1044"><a href="#SpectralAnalysis.berry_tabor_formula-1044"><span class="linenos">1044</span></a><span class="sd">            Density of states ρ(E)</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1045"><a href="#SpectralAnalysis.berry_tabor_formula-1045"><span class="linenos">1045</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1046"><a href="#SpectralAnalysis.berry_tabor_formula-1046"><span class="linenos">1046</span></a>        <span class="n">density</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1047"><a href="#SpectralAnalysis.berry_tabor_formula-1047"><span class="linenos">1047</span></a>        
</span><span id="SpectralAnalysis.berry_tabor_formula-1048"><a href="#SpectralAnalysis.berry_tabor_formula-1048"><span class="linenos">1048</span></a>        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1049"><a href="#SpectralAnalysis.berry_tabor_formula-1049"><span class="linenos">1049</span></a>            <span class="c1"># ✅ Contribution gaussienne lissée</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1050"><a href="#SpectralAnalysis.berry_tabor_formula-1050"><span class="linenos">1050</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">window</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1051"><a href="#SpectralAnalysis.berry_tabor_formula-1051"><span class="linenos">1051</span></a>            <span class="n">density</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="SpectralAnalysis.berry_tabor_formula-1052"><a href="#SpectralAnalysis.berry_tabor_formula-1052"><span class="linenos">1052</span></a>        
</span><span id="SpectralAnalysis.berry_tabor_formula-1053"><a href="#SpectralAnalysis.berry_tabor_formula-1053"><span class="linenos">1053</span></a>        <span class="k">return</span> <span class="n">density</span> <span class="o">/</span> <span class="p">(</span><span class="n">window</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Berry-Tabor formula for integrable systems</p>

<p>Smoothed density of states from periodic orbits</p>

<h2 id="parameters">Parameters</h2>

<p>periodic_orbits : list
    Periodic orbits
energy : float
    Energy at which to evaluate density</p>

<h2 id="returns">Returns</h2>

<p>float
    Density of states ρ(E)</p>
</div>


                            </div>
                </section>
                <section id="SymbolGeometry2D">
                            <input id="SymbolGeometry2D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SymbolGeometry2D</span>:

                <label class="view-source-button" for="SymbolGeometry2D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry2D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry2D-140"><a href="#SymbolGeometry2D-140"><span class="linenos">140</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SymbolGeometry2D</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-141"><a href="#SymbolGeometry2D-141"><span class="linenos">141</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-142"><a href="#SymbolGeometry2D-142"><span class="linenos">142</span></a><span class="sd">    Full geometric and semi-classical analysis of a 2D symbol</span>
</span><span id="SymbolGeometry2D-143"><a href="#SymbolGeometry2D-143"><span class="linenos">143</span></a><span class="sd">    H(x, y, ξ, η) with 4D phase space and rigorous caustic treatment</span>
</span><span id="SymbolGeometry2D-144"><a href="#SymbolGeometry2D-144"><span class="linenos">144</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-145"><a href="#SymbolGeometry2D-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> 
</span><span id="SymbolGeometry2D-146"><a href="#SymbolGeometry2D-146"><span class="linenos">146</span></a>                 <span class="n">x_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">y_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-147"><a href="#SymbolGeometry2D-147"><span class="linenos">147</span></a>                 <span class="n">xi_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">eta_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-148"><a href="#SymbolGeometry2D-148"><span class="linenos">148</span></a>                 <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-149"><a href="#SymbolGeometry2D-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-150"><a href="#SymbolGeometry2D-150"><span class="linenos">150</span></a><span class="sd">        Initialization with complete derivative computation for Jacobian evolution</span>
</span><span id="SymbolGeometry2D-151"><a href="#SymbolGeometry2D-151"><span class="linenos">151</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry2D-152"><a href="#SymbolGeometry2D-152"><span class="linenos">152</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry2D-153"><a href="#SymbolGeometry2D-153"><span class="linenos">153</span></a><span class="sd">        symbol : sympy expression</span>
</span><span id="SymbolGeometry2D-154"><a href="#SymbolGeometry2D-154"><span class="linenos">154</span></a><span class="sd">            Hamiltonian H(x, y, ξ, η)</span>
</span><span id="SymbolGeometry2D-155"><a href="#SymbolGeometry2D-155"><span class="linenos">155</span></a><span class="sd">        x_sym, y_sym : sympy symbols</span>
</span><span id="SymbolGeometry2D-156"><a href="#SymbolGeometry2D-156"><span class="linenos">156</span></a><span class="sd">            Position coordinates</span>
</span><span id="SymbolGeometry2D-157"><a href="#SymbolGeometry2D-157"><span class="linenos">157</span></a><span class="sd">        xi_sym, eta_sym : sympy symbols</span>
</span><span id="SymbolGeometry2D-158"><a href="#SymbolGeometry2D-158"><span class="linenos">158</span></a><span class="sd">            Momentum coordinates</span>
</span><span id="SymbolGeometry2D-159"><a href="#SymbolGeometry2D-159"><span class="linenos">159</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolGeometry2D-160"><a href="#SymbolGeometry2D-160"><span class="linenos">160</span></a><span class="sd">            Reduced Planck constant (for quantum aspects)</span>
</span><span id="SymbolGeometry2D-161"><a href="#SymbolGeometry2D-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-162"><a href="#SymbolGeometry2D-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="SymbolGeometry2D-163"><a href="#SymbolGeometry2D-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span> <span class="o">=</span> <span class="n">x_sym</span>
</span><span id="SymbolGeometry2D-164"><a href="#SymbolGeometry2D-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span> <span class="o">=</span> <span class="n">y_sym</span>
</span><span id="SymbolGeometry2D-165"><a href="#SymbolGeometry2D-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span> <span class="o">=</span> <span class="n">xi_sym</span>
</span><span id="SymbolGeometry2D-166"><a href="#SymbolGeometry2D-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span> <span class="o">=</span> <span class="n">eta_sym</span>
</span><span id="SymbolGeometry2D-167"><a href="#SymbolGeometry2D-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">=</span> <span class="n">hbar</span>
</span><span id="SymbolGeometry2D-168"><a href="#SymbolGeometry2D-168"><span class="linenos">168</span></a>            
</span><span id="SymbolGeometry2D-169"><a href="#SymbolGeometry2D-169"><span class="linenos">169</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing 2D geometry engine for H = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="si">}</span><span class="s2"> with ℏ = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hbar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-170"><a href="#SymbolGeometry2D-170"><span class="linenos">170</span></a>        <span class="c1"># --- First derivatives (Hamiltonian vector field) ---</span>
</span><span id="SymbolGeometry2D-171"><a href="#SymbolGeometry2D-171"><span class="linenos">171</span></a>        <span class="n">dH_x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-172"><a href="#SymbolGeometry2D-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_x</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-173"><a href="#SymbolGeometry2D-173"><span class="linenos">173</span></a>        <span class="n">dH_y</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-174"><a href="#SymbolGeometry2D-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_y</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-175"><a href="#SymbolGeometry2D-175"><span class="linenos">175</span></a>        <span class="n">dH_xi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-176"><a href="#SymbolGeometry2D-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_xi</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-177"><a href="#SymbolGeometry2D-177"><span class="linenos">177</span></a>        <span class="n">dH_eta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-178"><a href="#SymbolGeometry2D-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_eta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-179"><a href="#SymbolGeometry2D-179"><span class="linenos">179</span></a>
</span><span id="SymbolGeometry2D-180"><a href="#SymbolGeometry2D-180"><span class="linenos">180</span></a>        <span class="c1"># --- Second derivatives for variational equations ---</span>
</span><span id="SymbolGeometry2D-181"><a href="#SymbolGeometry2D-181"><span class="linenos">181</span></a>        <span class="n">d2H_x2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-182"><a href="#SymbolGeometry2D-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dx2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_x2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-183"><a href="#SymbolGeometry2D-183"><span class="linenos">183</span></a>        <span class="n">d2H_y2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-184"><a href="#SymbolGeometry2D-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dy2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_y2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-185"><a href="#SymbolGeometry2D-185"><span class="linenos">185</span></a>        <span class="n">d2H_xi2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-186"><a href="#SymbolGeometry2D-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxi2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xi2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-187"><a href="#SymbolGeometry2D-187"><span class="linenos">187</span></a>        <span class="n">d2H_eta2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-188"><a href="#SymbolGeometry2D-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_deta2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_eta2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-189"><a href="#SymbolGeometry2D-189"><span class="linenos">189</span></a>        <span class="n">d2H_xy</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-190"><a href="#SymbolGeometry2D-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdy_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xy</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-191"><a href="#SymbolGeometry2D-191"><span class="linenos">191</span></a>        <span class="n">d2H_xxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-192"><a href="#SymbolGeometry2D-192"><span class="linenos">192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xxi</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-193"><a href="#SymbolGeometry2D-193"><span class="linenos">193</span></a>        <span class="n">d2H_xeta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-194"><a href="#SymbolGeometry2D-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdeta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xeta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-195"><a href="#SymbolGeometry2D-195"><span class="linenos">195</span></a>        <span class="n">d2H_yxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-196"><a href="#SymbolGeometry2D-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dydxi_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_yxi</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-197"><a href="#SymbolGeometry2D-197"><span class="linenos">197</span></a>        <span class="n">d2H_yeta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-198"><a href="#SymbolGeometry2D-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dyeta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_yeta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-199"><a href="#SymbolGeometry2D-199"><span class="linenos">199</span></a>        <span class="n">d2H_xieta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-200"><a href="#SymbolGeometry2D-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxideta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xieta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-201"><a href="#SymbolGeometry2D-201"><span class="linenos">201</span></a>        <span class="c1"># --- Hessian for variational equations ---</span>
</span><span id="SymbolGeometry2D-202"><a href="#SymbolGeometry2D-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hessian</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span>
</span><span id="SymbolGeometry2D-203"><a href="#SymbolGeometry2D-203"><span class="linenos">203</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dx2_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdeta_sym</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-204"><a href="#SymbolGeometry2D-204"><span class="linenos">204</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dy2_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dydxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dyeta_sym</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-205"><a href="#SymbolGeometry2D-205"><span class="linenos">205</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dydxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxi2_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxideta_sym</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-206"><a href="#SymbolGeometry2D-206"><span class="linenos">206</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdeta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dyeta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxideta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_deta2_sym</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-207"><a href="#SymbolGeometry2D-207"><span class="linenos">207</span></a>        <span class="p">])</span>
</span><span id="SymbolGeometry2D-208"><a href="#SymbolGeometry2D-208"><span class="linenos">208</span></a>
</span><span id="SymbolGeometry2D-209"><a href="#SymbolGeometry2D-209"><span class="linenos">209</span></a>        <span class="c1"># --- Convert to numerical functions ---</span>
</span><span id="SymbolGeometry2D-210"><a href="#SymbolGeometry2D-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lambdify_functions</span><span class="p">()</span>
</span><span id="SymbolGeometry2D-211"><a href="#SymbolGeometry2D-211"><span class="linenos">211</span></a>  
</span><span id="SymbolGeometry2D-212"><a href="#SymbolGeometry2D-212"><span class="linenos">212</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_safe_lambdify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-213"><a href="#SymbolGeometry2D-213"><span class="linenos">213</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Safe conversion of sympy expressions to numerical functions&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-214"><a href="#SymbolGeometry2D-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Float</span><span class="p">)):</span>
</span><span id="SymbolGeometry2D-215"><a href="#SymbolGeometry2D-215"><span class="linenos">215</span></a>            <span class="n">const_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-216"><a href="#SymbolGeometry2D-216"><span class="linenos">216</span></a>            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">const_val</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-217"><a href="#SymbolGeometry2D-217"><span class="linenos">217</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-218"><a href="#SymbolGeometry2D-218"><span class="linenos">218</span></a>            <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">])</span>
</span><span id="SymbolGeometry2D-219"><a href="#SymbolGeometry2D-219"><span class="linenos">219</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-220"><a href="#SymbolGeometry2D-220"><span class="linenos">220</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: lambdify failed for </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-221"><a href="#SymbolGeometry2D-221"><span class="linenos">221</span></a>            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-222"><a href="#SymbolGeometry2D-222"><span class="linenos">222</span></a>
</span><span id="SymbolGeometry2D-223"><a href="#SymbolGeometry2D-223"><span class="linenos">223</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_lambdify_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-224"><a href="#SymbolGeometry2D-224"><span class="linenos">224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert all symbolic expressions to numerical functions&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-225"><a href="#SymbolGeometry2D-225"><span class="linenos">225</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-226"><a href="#SymbolGeometry2D-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-227"><a href="#SymbolGeometry2D-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-228"><a href="#SymbolGeometry2D-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-229"><a href="#SymbolGeometry2D-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-230"><a href="#SymbolGeometry2D-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-231"><a href="#SymbolGeometry2D-231"><span class="linenos">231</span></a>        <span class="c1"># Hessian functions</span>
</span><span id="SymbolGeometry2D-232"><a href="#SymbolGeometry2D-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">second_derivs_funcs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-233"><a href="#SymbolGeometry2D-233"><span class="linenos">233</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-234"><a href="#SymbolGeometry2D-234"><span class="linenos">234</span></a>            <span class="n">row_funcs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-235"><a href="#SymbolGeometry2D-235"><span class="linenos">235</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-236"><a href="#SymbolGeometry2D-236"><span class="linenos">236</span></a>                <span class="n">row_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_safe_lambdify</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hessian</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
</span><span id="SymbolGeometry2D-237"><a href="#SymbolGeometry2D-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">second_derivs_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_funcs</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-238"><a href="#SymbolGeometry2D-238"><span class="linenos">238</span></a>    
</span><span id="SymbolGeometry2D-239"><a href="#SymbolGeometry2D-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_hamiltonian_system_augmented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-240"><a href="#SymbolGeometry2D-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-241"><a href="#SymbolGeometry2D-241"><span class="linenos">241</span></a><span class="sd">        Augmented Hamiltonian system with variational equations for Jacobian evolution</span>
</span><span id="SymbolGeometry2D-242"><a href="#SymbolGeometry2D-242"><span class="linenos">242</span></a><span class="sd">        State vector z = [x, y, xi, eta, J11, J12, ..., J44] (20 dimensions)</span>
</span><span id="SymbolGeometry2D-243"><a href="#SymbolGeometry2D-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-244"><a href="#SymbolGeometry2D-244"><span class="linenos">244</span></a>        <span class="c1"># Extract position and momentum</span>
</span><span id="SymbolGeometry2D-245"><a href="#SymbolGeometry2D-245"><span class="linenos">245</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-246"><a href="#SymbolGeometry2D-246"><span class="linenos">246</span></a>        <span class="c1"># Extract Jacobian matrix (4x4)</span>
</span><span id="SymbolGeometry2D-247"><a href="#SymbolGeometry2D-247"><span class="linenos">247</span></a>        <span class="n">J</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-248"><a href="#SymbolGeometry2D-248"><span class="linenos">248</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-249"><a href="#SymbolGeometry2D-249"><span class="linenos">249</span></a>            <span class="c1"># Hamilton&#39;s equations</span>
</span><span id="SymbolGeometry2D-250"><a href="#SymbolGeometry2D-250"><span class="linenos">250</span></a>            <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-251"><a href="#SymbolGeometry2D-251"><span class="linenos">251</span></a>            <span class="n">dy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-252"><a href="#SymbolGeometry2D-252"><span class="linenos">252</span></a>            <span class="n">dxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-253"><a href="#SymbolGeometry2D-253"><span class="linenos">253</span></a>            <span class="n">deta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-254"><a href="#SymbolGeometry2D-254"><span class="linenos">254</span></a>            <span class="c1"># Evaluate numerical Hessian</span>
</span><span id="SymbolGeometry2D-255"><a href="#SymbolGeometry2D-255"><span class="linenos">255</span></a>            <span class="n">Hessian_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-256"><a href="#SymbolGeometry2D-256"><span class="linenos">256</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-257"><a href="#SymbolGeometry2D-257"><span class="linenos">257</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-258"><a href="#SymbolGeometry2D-258"><span class="linenos">258</span></a>                    <span class="n">Hessian_num</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_derivs_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-259"><a href="#SymbolGeometry2D-259"><span class="linenos">259</span></a>            <span class="c1"># Symplectic matrix J0</span>
</span><span id="SymbolGeometry2D-260"><a href="#SymbolGeometry2D-260"><span class="linenos">260</span></a>            <span class="n">J0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="SymbolGeometry2D-261"><a href="#SymbolGeometry2D-261"><span class="linenos">261</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-262"><a href="#SymbolGeometry2D-262"><span class="linenos">262</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-263"><a href="#SymbolGeometry2D-263"><span class="linenos">263</span></a>                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-264"><a href="#SymbolGeometry2D-264"><span class="linenos">264</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-265"><a href="#SymbolGeometry2D-265"><span class="linenos">265</span></a>            <span class="p">])</span>
</span><span id="SymbolGeometry2D-266"><a href="#SymbolGeometry2D-266"><span class="linenos">266</span></a>            <span class="c1"># Variational equations: dJ/dt = J @ (J0 @ Hessian)</span>
</span><span id="SymbolGeometry2D-267"><a href="#SymbolGeometry2D-267"><span class="linenos">267</span></a>            <span class="n">dJ_dt</span> <span class="o">=</span> <span class="n">J</span> <span class="o">@</span> <span class="p">(</span><span class="n">J0</span> <span class="o">@</span> <span class="n">Hessian_num</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-268"><a href="#SymbolGeometry2D-268"><span class="linenos">268</span></a>            <span class="c1"># Build derivative vector</span>
</span><span id="SymbolGeometry2D-269"><a href="#SymbolGeometry2D-269"><span class="linenos">269</span></a>            <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-270"><a href="#SymbolGeometry2D-270"><span class="linenos">270</span></a>            <span class="n">dz</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dxi</span><span class="p">,</span> <span class="n">deta</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-271"><a href="#SymbolGeometry2D-271"><span class="linenos">271</span></a>            <span class="n">dz</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">dJ_dt</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="SymbolGeometry2D-272"><a href="#SymbolGeometry2D-272"><span class="linenos">272</span></a>            <span class="k">return</span> <span class="n">dz</span>
</span><span id="SymbolGeometry2D-273"><a href="#SymbolGeometry2D-273"><span class="linenos">273</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-274"><a href="#SymbolGeometry2D-274"><span class="linenos">274</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integration error at t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">, z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-275"><a href="#SymbolGeometry2D-275"><span class="linenos">275</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-276"><a href="#SymbolGeometry2D-276"><span class="linenos">276</span></a>    
</span><span id="SymbolGeometry2D-277"><a href="#SymbolGeometry2D-277"><span class="linenos">277</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_geodesic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SymbolGeometry2D-278"><a href="#SymbolGeometry2D-278"><span class="linenos">278</span></a>                        <span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-279"><a href="#SymbolGeometry2D-279"><span class="linenos">279</span></a>                        <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Geodesic2D</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-280"><a href="#SymbolGeometry2D-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-281"><a href="#SymbolGeometry2D-281"><span class="linenos">281</span></a><span class="sd">        Compute a geodesic with full Jacobian evolution for caustic detection</span>
</span><span id="SymbolGeometry2D-282"><a href="#SymbolGeometry2D-282"><span class="linenos">282</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry2D-283"><a href="#SymbolGeometry2D-283"><span class="linenos">283</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry2D-284"><a href="#SymbolGeometry2D-284"><span class="linenos">284</span></a><span class="sd">        x0, y0 : float</span>
</span><span id="SymbolGeometry2D-285"><a href="#SymbolGeometry2D-285"><span class="linenos">285</span></a><span class="sd">            Initial position</span>
</span><span id="SymbolGeometry2D-286"><a href="#SymbolGeometry2D-286"><span class="linenos">286</span></a><span class="sd">        xi0, eta0 : float</span>
</span><span id="SymbolGeometry2D-287"><a href="#SymbolGeometry2D-287"><span class="linenos">287</span></a><span class="sd">            Initial momentum</span>
</span><span id="SymbolGeometry2D-288"><a href="#SymbolGeometry2D-288"><span class="linenos">288</span></a><span class="sd">        t_max : float</span>
</span><span id="SymbolGeometry2D-289"><a href="#SymbolGeometry2D-289"><span class="linenos">289</span></a><span class="sd">            Final time</span>
</span><span id="SymbolGeometry2D-290"><a href="#SymbolGeometry2D-290"><span class="linenos">290</span></a><span class="sd">        n_points : int</span>
</span><span id="SymbolGeometry2D-291"><a href="#SymbolGeometry2D-291"><span class="linenos">291</span></a><span class="sd">            Number of sampling points</span>
</span><span id="SymbolGeometry2D-292"><a href="#SymbolGeometry2D-292"><span class="linenos">292</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry2D-293"><a href="#SymbolGeometry2D-293"><span class="linenos">293</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry2D-294"><a href="#SymbolGeometry2D-294"><span class="linenos">294</span></a><span class="sd">        Geodesic2D</span>
</span><span id="SymbolGeometry2D-295"><a href="#SymbolGeometry2D-295"><span class="linenos">295</span></a><span class="sd">            Structure containing trajectory and caustic analysis</span>
</span><span id="SymbolGeometry2D-296"><a href="#SymbolGeometry2D-296"><span class="linenos">296</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-297"><a href="#SymbolGeometry2D-297"><span class="linenos">297</span></a>        <span class="c1"># Initial condition: position, momentum + identity Jacobian</span>
</span><span id="SymbolGeometry2D-298"><a href="#SymbolGeometry2D-298"><span class="linenos">298</span></a>        <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-299"><a href="#SymbolGeometry2D-299"><span class="linenos">299</span></a>        <span class="n">z0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-300"><a href="#SymbolGeometry2D-300"><span class="linenos">300</span></a>        <span class="n">z0</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="SymbolGeometry2D-301"><a href="#SymbolGeometry2D-301"><span class="linenos">301</span></a>        <span class="n">t_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-302"><a href="#SymbolGeometry2D-302"><span class="linenos">302</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
</span><span id="SymbolGeometry2D-303"><a href="#SymbolGeometry2D-303"><span class="linenos">303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_hamiltonian_system_augmented</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-304"><a href="#SymbolGeometry2D-304"><span class="linenos">304</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">t_eval</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-305"><a href="#SymbolGeometry2D-305"><span class="linenos">305</span></a>            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;DOP853&#39;</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span>
</span><span id="SymbolGeometry2D-306"><a href="#SymbolGeometry2D-306"><span class="linenos">306</span></a>        <span class="p">)</span>
</span><span id="SymbolGeometry2D-307"><a href="#SymbolGeometry2D-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-308"><a href="#SymbolGeometry2D-308"><span class="linenos">308</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Integration failed for (</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">xi0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">eta0</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-309"><a href="#SymbolGeometry2D-309"><span class="linenos">309</span></a>        <span class="c1"># Extract trajectory data</span>
</span><span id="SymbolGeometry2D-310"><a href="#SymbolGeometry2D-310"><span class="linenos">310</span></a>        <span class="n">x_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-311"><a href="#SymbolGeometry2D-311"><span class="linenos">311</span></a>        <span class="n">y_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-312"><a href="#SymbolGeometry2D-312"><span class="linenos">312</span></a>        <span class="n">xi_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-313"><a href="#SymbolGeometry2D-313"><span class="linenos">313</span></a>        <span class="n">eta_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-314"><a href="#SymbolGeometry2D-314"><span class="linenos">314</span></a>        <span class="c1"># Evaluate energy</span>
</span><span id="SymbolGeometry2D-315"><a href="#SymbolGeometry2D-315"><span class="linenos">315</span></a>        <span class="n">H_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x_traj</span><span class="p">,</span> <span class="n">y_traj</span><span class="p">,</span> <span class="n">xi_traj</span><span class="p">,</span> <span class="n">eta_traj</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-316"><a href="#SymbolGeometry2D-316"><span class="linenos">316</span></a>        <span class="c1"># Extract and reshape Jacobian matrices</span>
</span><span id="SymbolGeometry2D-317"><a href="#SymbolGeometry2D-317"><span class="linenos">317</span></a>        <span class="n">J_mats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-318"><a href="#SymbolGeometry2D-318"><span class="linenos">318</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-319"><a href="#SymbolGeometry2D-319"><span class="linenos">319</span></a>            <span class="n">J_mats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-320"><a href="#SymbolGeometry2D-320"><span class="linenos">320</span></a>        <span class="c1"># Submatrix for caustic detection: ∂(x,y)/∂(ξ₀,η₀)</span>
</span><span id="SymbolGeometry2D-321"><a href="#SymbolGeometry2D-321"><span class="linenos">321</span></a>        <span class="n">caustic_matrix</span> <span class="o">=</span> <span class="n">J_mats</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-322"><a href="#SymbolGeometry2D-322"><span class="linenos">322</span></a>        <span class="c1"># Determinant for caustic detection</span>
</span><span id="SymbolGeometry2D-323"><a href="#SymbolGeometry2D-323"><span class="linenos">323</span></a>        <span class="n">det_caustic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-324"><a href="#SymbolGeometry2D-324"><span class="linenos">324</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-325"><a href="#SymbolGeometry2D-325"><span class="linenos">325</span></a>            <span class="n">det_caustic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">caustic_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolGeometry2D-326"><a href="#SymbolGeometry2D-326"><span class="linenos">326</span></a>        <span class="c1"># Detect caustic indices (sign change)</span>
</span><span id="SymbolGeometry2D-327"><a href="#SymbolGeometry2D-327"><span class="linenos">327</span></a>        <span class="n">caustic_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">det_caustic</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-328"><a href="#SymbolGeometry2D-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="n">Geodesic2D</span><span class="p">(</span>
</span><span id="SymbolGeometry2D-329"><a href="#SymbolGeometry2D-329"><span class="linenos">329</span></a>            <span class="n">t</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-330"><a href="#SymbolGeometry2D-330"><span class="linenos">330</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">x_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-331"><a href="#SymbolGeometry2D-331"><span class="linenos">331</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">y_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-332"><a href="#SymbolGeometry2D-332"><span class="linenos">332</span></a>            <span class="n">xi</span><span class="o">=</span><span class="n">xi_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-333"><a href="#SymbolGeometry2D-333"><span class="linenos">333</span></a>            <span class="n">eta</span><span class="o">=</span><span class="n">eta_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-334"><a href="#SymbolGeometry2D-334"><span class="linenos">334</span></a>            <span class="n">H</span><span class="o">=</span><span class="n">H_vals</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-335"><a href="#SymbolGeometry2D-335"><span class="linenos">335</span></a>            <span class="n">J_full</span><span class="o">=</span><span class="n">J_mats</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-336"><a href="#SymbolGeometry2D-336"><span class="linenos">336</span></a>            <span class="n">det_caustic</span><span class="o">=</span><span class="n">det_caustic</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-337"><a href="#SymbolGeometry2D-337"><span class="linenos">337</span></a>            <span class="n">caustic_indices</span><span class="o">=</span><span class="n">caustic_indices</span>
</span><span id="SymbolGeometry2D-338"><a href="#SymbolGeometry2D-338"><span class="linenos">338</span></a>        <span class="p">)</span>
</span><span id="SymbolGeometry2D-339"><a href="#SymbolGeometry2D-339"><span class="linenos">339</span></a>    
</span><span id="SymbolGeometry2D-340"><a href="#SymbolGeometry2D-340"><span class="linenos">340</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_periodic_orbits_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-341"><a href="#SymbolGeometry2D-341"><span class="linenos">341</span></a>                               <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-342"><a href="#SymbolGeometry2D-342"><span class="linenos">342</span></a>                               <span class="n">y_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-343"><a href="#SymbolGeometry2D-343"><span class="linenos">343</span></a>                               <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-344"><a href="#SymbolGeometry2D-344"><span class="linenos">344</span></a>                               <span class="n">eta_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-345"><a href="#SymbolGeometry2D-345"><span class="linenos">345</span></a>                               <span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit2D</span><span class="p">]:</span>
</span><span id="SymbolGeometry2D-346"><a href="#SymbolGeometry2D-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-347"><a href="#SymbolGeometry2D-347"><span class="linenos">347</span></a><span class="sd">        Search for periodic orbits with Maslov index computation</span>
</span><span id="SymbolGeometry2D-348"><a href="#SymbolGeometry2D-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-349"><a href="#SymbolGeometry2D-349"><span class="linenos">349</span></a>        <span class="n">orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-350"><a href="#SymbolGeometry2D-350"><span class="linenos">350</span></a>        <span class="c1"># Sample configuration space</span>
</span><span id="SymbolGeometry2D-351"><a href="#SymbolGeometry2D-351"><span class="linenos">351</span></a>        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_attempts</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-352"><a href="#SymbolGeometry2D-352"><span class="linenos">352</span></a>        <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-353"><a href="#SymbolGeometry2D-353"><span class="linenos">353</span></a>        <span class="n">y_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-354"><a href="#SymbolGeometry2D-354"><span class="linenos">354</span></a>        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">x_samples</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-355"><a href="#SymbolGeometry2D-355"><span class="linenos">355</span></a>            <span class="k">for</span> <span class="n">y0</span> <span class="ow">in</span> <span class="n">y_samples</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-356"><a href="#SymbolGeometry2D-356"><span class="linenos">356</span></a>                <span class="c1"># Test different momentum directions</span>
</span><span id="SymbolGeometry2D-357"><a href="#SymbolGeometry2D-357"><span class="linenos">357</span></a>                <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-358"><a href="#SymbolGeometry2D-358"><span class="linenos">358</span></a>                <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-359"><a href="#SymbolGeometry2D-359"><span class="linenos">359</span></a>                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-360"><a href="#SymbolGeometry2D-360"><span class="linenos">360</span></a>                        <span class="n">xi0_guess</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-361"><a href="#SymbolGeometry2D-361"><span class="linenos">361</span></a>                        <span class="n">eta0_guess</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-362"><a href="#SymbolGeometry2D-362"><span class="linenos">362</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-363"><a href="#SymbolGeometry2D-363"><span class="linenos">363</span></a>                            <span class="c1"># Energy check</span>
</span><span id="SymbolGeometry2D-364"><a href="#SymbolGeometry2D-364"><span class="linenos">364</span></a>                            <span class="n">E_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-365"><a href="#SymbolGeometry2D-365"><span class="linenos">365</span></a>                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">E_test</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-366"><a href="#SymbolGeometry2D-366"><span class="linenos">366</span></a>                                <span class="k">continue</span>
</span><span id="SymbolGeometry2D-367"><a href="#SymbolGeometry2D-367"><span class="linenos">367</span></a>                            <span class="c1"># Compute geodesic</span>
</span><span id="SymbolGeometry2D-368"><a href="#SymbolGeometry2D-368"><span class="linenos">368</span></a>                            <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-369"><a href="#SymbolGeometry2D-369"><span class="linenos">369</span></a>                            <span class="c1"># Search for return points</span>
</span><span id="SymbolGeometry2D-370"><a href="#SymbolGeometry2D-370"><span class="linenos">370</span></a>                            <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
</span><span id="SymbolGeometry2D-371"><a href="#SymbolGeometry2D-371"><span class="linenos">371</span></a>                                              <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span> <span class="o">-</span> <span class="n">xi0_guess</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span> <span class="o">-</span> <span class="n">eta0_guess</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-372"><a href="#SymbolGeometry2D-372"><span class="linenos">372</span></a>                            <span class="n">minima</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-373"><a href="#SymbolGeometry2D-373"><span class="linenos">373</span></a>                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-374"><a href="#SymbolGeometry2D-374"><span class="linenos">374</span></a>                                <span class="k">if</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
</span><span id="SymbolGeometry2D-375"><a href="#SymbolGeometry2D-375"><span class="linenos">375</span></a>                                    <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
</span><span id="SymbolGeometry2D-376"><a href="#SymbolGeometry2D-376"><span class="linenos">376</span></a>                                    <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-377"><a href="#SymbolGeometry2D-377"><span class="linenos">377</span></a>                                    <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-378"><a href="#SymbolGeometry2D-378"><span class="linenos">378</span></a>                            <span class="k">if</span> <span class="n">minima</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-379"><a href="#SymbolGeometry2D-379"><span class="linenos">379</span></a>                                <span class="n">idx</span> <span class="o">=</span> <span class="n">minima</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-380"><a href="#SymbolGeometry2D-380"><span class="linenos">380</span></a>                                <span class="n">period</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-381"><a href="#SymbolGeometry2D-381"><span class="linenos">381</span></a>                                <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">distances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-382"><a href="#SymbolGeometry2D-382"><span class="linenos">382</span></a>                                    <span class="c1"># Compute action</span>
</span><span id="SymbolGeometry2D-383"><a href="#SymbolGeometry2D-383"><span class="linenos">383</span></a>                                    <span class="n">x_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-384"><a href="#SymbolGeometry2D-384"><span class="linenos">384</span></a>                                    <span class="n">y_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-385"><a href="#SymbolGeometry2D-385"><span class="linenos">385</span></a>                                    <span class="n">xi_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-386"><a href="#SymbolGeometry2D-386"><span class="linenos">386</span></a>                                    <span class="n">eta_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-387"><a href="#SymbolGeometry2D-387"><span class="linenos">387</span></a>                                    <span class="n">t_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-388"><a href="#SymbolGeometry2D-388"><span class="linenos">388</span></a>                                    <span class="n">dx_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_cyc</span><span class="p">,</span> <span class="n">t_cyc</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-389"><a href="#SymbolGeometry2D-389"><span class="linenos">389</span></a>                                    <span class="n">dy_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y_cyc</span><span class="p">,</span> <span class="n">t_cyc</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-390"><a href="#SymbolGeometry2D-390"><span class="linenos">390</span></a>                                    <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">xi_cyc</span> <span class="o">*</span> <span class="n">dx_dt</span> <span class="o">+</span> <span class="n">eta_cyc</span> <span class="o">*</span> <span class="n">dy_dt</span><span class="p">,</span> <span class="n">t_cyc</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-391"><a href="#SymbolGeometry2D-391"><span class="linenos">391</span></a>                                    <span class="c1"># Compute Maslov index (number of caustic crossings)</span>
</span><span id="SymbolGeometry2D-392"><a href="#SymbolGeometry2D-392"><span class="linenos">392</span></a>                                    <span class="n">maslov_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustic_indices</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">idx</span><span class="p">])</span>
</span><span id="SymbolGeometry2D-393"><a href="#SymbolGeometry2D-393"><span class="linenos">393</span></a>                                    <span class="c1"># Compute stability</span>
</span><span id="SymbolGeometry2D-394"><a href="#SymbolGeometry2D-394"><span class="linenos">394</span></a>                                    <span class="n">stab1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_stability_2d</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-395"><a href="#SymbolGeometry2D-395"><span class="linenos">395</span></a>                                    <span class="n">orbits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PeriodicOrbit2D</span><span class="p">(</span>
</span><span id="SymbolGeometry2D-396"><a href="#SymbolGeometry2D-396"><span class="linenos">396</span></a>                                        <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-397"><a href="#SymbolGeometry2D-397"><span class="linenos">397</span></a>                                        <span class="n">xi0</span><span class="o">=</span><span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="n">eta0_guess</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-398"><a href="#SymbolGeometry2D-398"><span class="linenos">398</span></a>                                        <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-399"><a href="#SymbolGeometry2D-399"><span class="linenos">399</span></a>                                        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-400"><a href="#SymbolGeometry2D-400"><span class="linenos">400</span></a>                                        <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-401"><a href="#SymbolGeometry2D-401"><span class="linenos">401</span></a>                                        <span class="n">stability_1</span><span class="o">=</span><span class="n">stab1</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-402"><a href="#SymbolGeometry2D-402"><span class="linenos">402</span></a>                                        <span class="n">stability_2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-403"><a href="#SymbolGeometry2D-403"><span class="linenos">403</span></a>                                        <span class="n">x_cycle</span><span class="o">=</span><span class="n">x_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-404"><a href="#SymbolGeometry2D-404"><span class="linenos">404</span></a>                                        <span class="n">y_cycle</span><span class="o">=</span><span class="n">y_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-405"><a href="#SymbolGeometry2D-405"><span class="linenos">405</span></a>                                        <span class="n">xi_cycle</span><span class="o">=</span><span class="n">xi_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-406"><a href="#SymbolGeometry2D-406"><span class="linenos">406</span></a>                                        <span class="n">eta_cycle</span><span class="o">=</span><span class="n">eta_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-407"><a href="#SymbolGeometry2D-407"><span class="linenos">407</span></a>                                        <span class="n">t_cycle</span><span class="o">=</span><span class="n">t_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-408"><a href="#SymbolGeometry2D-408"><span class="linenos">408</span></a>                                        <span class="n">maslov_index</span><span class="o">=</span><span class="n">maslov_index</span>
</span><span id="SymbolGeometry2D-409"><a href="#SymbolGeometry2D-409"><span class="linenos">409</span></a>                                    <span class="p">))</span>
</span><span id="SymbolGeometry2D-410"><a href="#SymbolGeometry2D-410"><span class="linenos">410</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-411"><a href="#SymbolGeometry2D-411"><span class="linenos">411</span></a>                            <span class="k">continue</span>
</span><span id="SymbolGeometry2D-412"><a href="#SymbolGeometry2D-412"><span class="linenos">412</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_duplicate_orbits_2d</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-413"><a href="#SymbolGeometry2D-413"><span class="linenos">413</span></a>    
</span><span id="SymbolGeometry2D-414"><a href="#SymbolGeometry2D-414"><span class="linenos">414</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_stability_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-415"><a href="#SymbolGeometry2D-415"><span class="linenos">415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the largest Lyapunov exponent&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-416"><a href="#SymbolGeometry2D-416"><span class="linenos">416</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">linearized</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-417"><a href="#SymbolGeometry2D-417"><span class="linenos">417</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dxi</span><span class="p">,</span> <span class="n">deta</span> <span class="o">=</span> <span class="n">z</span>
</span><span id="SymbolGeometry2D-418"><a href="#SymbolGeometry2D-418"><span class="linenos">418</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-419"><a href="#SymbolGeometry2D-419"><span class="linenos">419</span></a>                <span class="n">vx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-420"><a href="#SymbolGeometry2D-420"><span class="linenos">420</span></a>                <span class="n">vy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-421"><a href="#SymbolGeometry2D-421"><span class="linenos">421</span></a>                <span class="n">vxi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-422"><a href="#SymbolGeometry2D-422"><span class="linenos">422</span></a>                <span class="n">veta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-423"><a href="#SymbolGeometry2D-423"><span class="linenos">423</span></a>                <span class="c1"># Linearization (simplified)</span>
</span><span id="SymbolGeometry2D-424"><a href="#SymbolGeometry2D-424"><span class="linenos">424</span></a>                <span class="n">A13</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_derivs_funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-425"><a href="#SymbolGeometry2D-425"><span class="linenos">425</span></a>                <span class="n">A24</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_derivs_funcs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-426"><a href="#SymbolGeometry2D-426"><span class="linenos">426</span></a>                <span class="n">ddx</span> <span class="o">=</span> <span class="n">A13</span> <span class="o">*</span> <span class="n">dxi</span>
</span><span id="SymbolGeometry2D-427"><a href="#SymbolGeometry2D-427"><span class="linenos">427</span></a>                <span class="n">ddy</span> <span class="o">=</span> <span class="n">A24</span> <span class="o">*</span> <span class="n">deta</span>
</span><span id="SymbolGeometry2D-428"><a href="#SymbolGeometry2D-428"><span class="linenos">428</span></a>                <span class="n">ddxi</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SymbolGeometry2D-429"><a href="#SymbolGeometry2D-429"><span class="linenos">429</span></a>                <span class="n">ddeta</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SymbolGeometry2D-430"><a href="#SymbolGeometry2D-430"><span class="linenos">430</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vxi</span><span class="p">,</span> <span class="n">veta</span><span class="p">,</span> <span class="n">ddx</span><span class="p">,</span> <span class="n">ddy</span><span class="p">,</span> <span class="n">ddxi</span><span class="p">,</span> <span class="n">ddeta</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-431"><a href="#SymbolGeometry2D-431"><span class="linenos">431</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-432"><a href="#SymbolGeometry2D-432"><span class="linenos">432</span></a>                <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span>
</span><span id="SymbolGeometry2D-433"><a href="#SymbolGeometry2D-433"><span class="linenos">433</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="SymbolGeometry2D-434"><a href="#SymbolGeometry2D-434"><span class="linenos">434</span></a>        <span class="n">z0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-435"><a href="#SymbolGeometry2D-435"><span class="linenos">435</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">linearized</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;DOP853&#39;</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-436"><a href="#SymbolGeometry2D-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-437"><a href="#SymbolGeometry2D-437"><span class="linenos">437</span></a>            <span class="n">pert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-438"><a href="#SymbolGeometry2D-438"><span class="linenos">438</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pert</span> <span class="o">/</span> <span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="n">T</span>
</span><span id="SymbolGeometry2D-439"><a href="#SymbolGeometry2D-439"><span class="linenos">439</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="SymbolGeometry2D-440"><a href="#SymbolGeometry2D-440"><span class="linenos">440</span></a>    
</span><span id="SymbolGeometry2D-441"><a href="#SymbolGeometry2D-441"><span class="linenos">441</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_duplicate_orbits_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbits</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-442"><a href="#SymbolGeometry2D-442"><span class="linenos">442</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove duplicate periodic orbits&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-443"><a href="#SymbolGeometry2D-443"><span class="linenos">443</span></a>        <span class="n">unique</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-444"><a href="#SymbolGeometry2D-444"><span class="linenos">444</span></a>        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-445"><a href="#SymbolGeometry2D-445"><span class="linenos">445</span></a>            <span class="n">is_dup</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SymbolGeometry2D-446"><a href="#SymbolGeometry2D-446"><span class="linenos">446</span></a>            <span class="k">for</span> <span class="n">u_orb</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-447"><a href="#SymbolGeometry2D-447"><span class="linenos">447</span></a>                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="n">u_orb</span><span class="o">.</span><span class="n">period</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span> <span class="ow">and</span>
</span><span id="SymbolGeometry2D-448"><a href="#SymbolGeometry2D-448"><span class="linenos">448</span></a>                    <span class="nb">abs</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="o">-</span> <span class="n">u_orb</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-449"><a href="#SymbolGeometry2D-449"><span class="linenos">449</span></a>                    <span class="n">is_dup</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SymbolGeometry2D-450"><a href="#SymbolGeometry2D-450"><span class="linenos">450</span></a>                    <span class="k">break</span>
</span><span id="SymbolGeometry2D-451"><a href="#SymbolGeometry2D-451"><span class="linenos">451</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dup</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-452"><a href="#SymbolGeometry2D-452"><span class="linenos">452</span></a>                <span class="n">unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-453"><a href="#SymbolGeometry2D-453"><span class="linenos">453</span></a>        <span class="k">return</span> <span class="n">unique</span>
</span><span id="SymbolGeometry2D-454"><a href="#SymbolGeometry2D-454"><span class="linenos">454</span></a>    
</span><span id="SymbolGeometry2D-455"><a href="#SymbolGeometry2D-455"><span class="linenos">455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detect_caustic_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Geodesic2D</span><span class="p">],</span> 
</span><span id="SymbolGeometry2D-456"><a href="#SymbolGeometry2D-456"><span class="linenos">456</span></a>                                 <span class="n">t_fixed</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CausticStructure</span><span class="p">]:</span>
</span><span id="SymbolGeometry2D-457"><a href="#SymbolGeometry2D-457"><span class="linenos">457</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-458"><a href="#SymbolGeometry2D-458"><span class="linenos">458</span></a><span class="sd">        Advanced caustic structure detection with classification</span>
</span><span id="SymbolGeometry2D-459"><a href="#SymbolGeometry2D-459"><span class="linenos">459</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-460"><a href="#SymbolGeometry2D-460"><span class="linenos">460</span></a>        <span class="n">caustic_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-461"><a href="#SymbolGeometry2D-461"><span class="linenos">461</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-462"><a href="#SymbolGeometry2D-462"><span class="linenos">462</span></a>            <span class="c1"># Find closest time to t_fixed</span>
</span><span id="SymbolGeometry2D-463"><a href="#SymbolGeometry2D-463"><span class="linenos">463</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_fixed</span><span class="p">))</span>
</span><span id="SymbolGeometry2D-464"><a href="#SymbolGeometry2D-464"><span class="linenos">464</span></a>            <span class="c1"># Check if near a caustic</span>
</span><span id="SymbolGeometry2D-465"><a href="#SymbolGeometry2D-465"><span class="linenos">465</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">det_caustic</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-466"><a href="#SymbolGeometry2D-466"><span class="linenos">466</span></a>                <span class="c1"># Classify caustic type</span>
</span><span id="SymbolGeometry2D-467"><a href="#SymbolGeometry2D-467"><span class="linenos">467</span></a>                <span class="n">caustic_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_caustic</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-468"><a href="#SymbolGeometry2D-468"><span class="linenos">468</span></a>                <span class="c1"># Compute singularity strength</span>
</span><span id="SymbolGeometry2D-469"><a href="#SymbolGeometry2D-469"><span class="linenos">469</span></a>                <span class="n">strength</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">det_caustic</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-470"><a href="#SymbolGeometry2D-470"><span class="linenos">470</span></a>                <span class="n">caustic_points</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="SymbolGeometry2D-471"><a href="#SymbolGeometry2D-471"><span class="linenos">471</span></a>                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-472"><a href="#SymbolGeometry2D-472"><span class="linenos">472</span></a>                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-473"><a href="#SymbolGeometry2D-473"><span class="linenos">473</span></a>                    <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-474"><a href="#SymbolGeometry2D-474"><span class="linenos">474</span></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">caustic_type</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-475"><a href="#SymbolGeometry2D-475"><span class="linenos">475</span></a>                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">strength</span>
</span><span id="SymbolGeometry2D-476"><a href="#SymbolGeometry2D-476"><span class="linenos">476</span></a>                <span class="p">})</span>
</span><span id="SymbolGeometry2D-477"><a href="#SymbolGeometry2D-477"><span class="linenos">477</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caustic_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-478"><a href="#SymbolGeometry2D-478"><span class="linenos">478</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-479"><a href="#SymbolGeometry2D-479"><span class="linenos">479</span></a>        <span class="c1"># Cluster points into caustic structures</span>
</span><span id="SymbolGeometry2D-480"><a href="#SymbolGeometry2D-480"><span class="linenos">480</span></a>        <span class="n">caustic_structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_caustic_points</span><span class="p">(</span><span class="n">caustic_points</span><span class="p">,</span> <span class="n">t_fixed</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-481"><a href="#SymbolGeometry2D-481"><span class="linenos">481</span></a>        <span class="k">return</span> <span class="n">caustic_structures</span>
</span><span id="SymbolGeometry2D-482"><a href="#SymbolGeometry2D-482"><span class="linenos">482</span></a>    
</span><span id="SymbolGeometry2D-483"><a href="#SymbolGeometry2D-483"><span class="linenos">483</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_classify_caustic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geo</span><span class="p">:</span> <span class="n">Geodesic2D</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-484"><a href="#SymbolGeometry2D-484"><span class="linenos">484</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-485"><a href="#SymbolGeometry2D-485"><span class="linenos">485</span></a><span class="sd">        Caustic classification according to catastrophe theory</span>
</span><span id="SymbolGeometry2D-486"><a href="#SymbolGeometry2D-486"><span class="linenos">486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-487"><a href="#SymbolGeometry2D-487"><span class="linenos">487</span></a>        <span class="c1"># Compute curvature near caustic point</span>
</span><span id="SymbolGeometry2D-488"><a href="#SymbolGeometry2D-488"><span class="linenos">488</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="SymbolGeometry2D-489"><a href="#SymbolGeometry2D-489"><span class="linenos">489</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">window</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-490"><a href="#SymbolGeometry2D-490"><span class="linenos">490</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">),</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-491"><a href="#SymbolGeometry2D-491"><span class="linenos">491</span></a>        <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-492"><a href="#SymbolGeometry2D-492"><span class="linenos">492</span></a>            <span class="k">return</span> <span class="s1">&#39;fold&#39;</span>
</span><span id="SymbolGeometry2D-493"><a href="#SymbolGeometry2D-493"><span class="linenos">493</span></a>        <span class="c1"># Curvature approximation</span>
</span><span id="SymbolGeometry2D-494"><a href="#SymbolGeometry2D-494"><span class="linenos">494</span></a>        <span class="n">x_window</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-495"><a href="#SymbolGeometry2D-495"><span class="linenos">495</span></a>        <span class="n">y_window</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-496"><a href="#SymbolGeometry2D-496"><span class="linenos">496</span></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_window</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-497"><a href="#SymbolGeometry2D-497"><span class="linenos">497</span></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y_window</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-498"><a href="#SymbolGeometry2D-498"><span class="linenos">498</span></a>        <span class="n">ddx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-499"><a href="#SymbolGeometry2D-499"><span class="linenos">499</span></a>        <span class="n">ddy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-500"><a href="#SymbolGeometry2D-500"><span class="linenos">500</span></a>        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-501"><a href="#SymbolGeometry2D-501"><span class="linenos">501</span></a>            <span class="n">curvature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">ddy</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">ddx</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span>
</span><span id="SymbolGeometry2D-502"><a href="#SymbolGeometry2D-502"><span class="linenos">502</span></a>        <span class="n">curvature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">curvature</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-503"><a href="#SymbolGeometry2D-503"><span class="linenos">503</span></a>        <span class="c1"># Detect cusp points (high curvature)</span>
</span><span id="SymbolGeometry2D-504"><a href="#SymbolGeometry2D-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">curvature</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">curvature</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-505"><a href="#SymbolGeometry2D-505"><span class="linenos">505</span></a>            <span class="k">return</span> <span class="s1">&#39;cusp&#39;</span>
</span><span id="SymbolGeometry2D-506"><a href="#SymbolGeometry2D-506"><span class="linenos">506</span></a>        <span class="k">return</span> <span class="s1">&#39;fold&#39;</span>
</span><span id="SymbolGeometry2D-507"><a href="#SymbolGeometry2D-507"><span class="linenos">507</span></a>    
</span><span id="SymbolGeometry2D-508"><a href="#SymbolGeometry2D-508"><span class="linenos">508</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cluster_caustic_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">t_fixed</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CausticStructure</span><span class="p">]:</span>
</span><span id="SymbolGeometry2D-509"><a href="#SymbolGeometry2D-509"><span class="linenos">509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Group caustic points into coherent structures&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-510"><a href="#SymbolGeometry2D-510"><span class="linenos">510</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">points</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-511"><a href="#SymbolGeometry2D-511"><span class="linenos">511</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-512"><a href="#SymbolGeometry2D-512"><span class="linenos">512</span></a>        <span class="c1"># Extract coordinates</span>
</span><span id="SymbolGeometry2D-513"><a href="#SymbolGeometry2D-513"><span class="linenos">513</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
</span><span id="SymbolGeometry2D-514"><a href="#SymbolGeometry2D-514"><span class="linenos">514</span></a>        <span class="c1"># Simple proximity-based clustering</span>
</span><span id="SymbolGeometry2D-515"><a href="#SymbolGeometry2D-515"><span class="linenos">515</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D-516"><a href="#SymbolGeometry2D-516"><span class="linenos">516</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="SymbolGeometry2D-517"><a href="#SymbolGeometry2D-517"><span class="linenos">517</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-518"><a href="#SymbolGeometry2D-518"><span class="linenos">518</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-519"><a href="#SymbolGeometry2D-519"><span class="linenos">519</span></a>                <span class="k">continue</span>
</span><span id="SymbolGeometry2D-520"><a href="#SymbolGeometry2D-520"><span class="linenos">520</span></a>            <span class="c1"># New cluster</span>
</span><span id="SymbolGeometry2D-521"><a href="#SymbolGeometry2D-521"><span class="linenos">521</span></a>            <span class="n">cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-522"><a href="#SymbolGeometry2D-522"><span class="linenos">522</span></a>            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-523"><a href="#SymbolGeometry2D-523"><span class="linenos">523</span></a>            <span class="c1"># Find nearby points</span>
</span><span id="SymbolGeometry2D-524"><a href="#SymbolGeometry2D-524"><span class="linenos">524</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
</span><span id="SymbolGeometry2D-525"><a href="#SymbolGeometry2D-525"><span class="linenos">525</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-526"><a href="#SymbolGeometry2D-526"><span class="linenos">526</span></a>                    <span class="k">continue</span>
</span><span id="SymbolGeometry2D-527"><a href="#SymbolGeometry2D-527"><span class="linenos">527</span></a>                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-528"><a href="#SymbolGeometry2D-528"><span class="linenos">528</span></a>                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Distance threshold</span>
</span><span id="SymbolGeometry2D-529"><a href="#SymbolGeometry2D-529"><span class="linenos">529</span></a>                    <span class="n">cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-530"><a href="#SymbolGeometry2D-530"><span class="linenos">530</span></a>                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-531"><a href="#SymbolGeometry2D-531"><span class="linenos">531</span></a>            <span class="c1"># Create caustic structure</span>
</span><span id="SymbolGeometry2D-532"><a href="#SymbolGeometry2D-532"><span class="linenos">532</span></a>            <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">])</span>
</span><span id="SymbolGeometry2D-533"><a href="#SymbolGeometry2D-533"><span class="linenos">533</span></a>            <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">])</span>
</span><span id="SymbolGeometry2D-534"><a href="#SymbolGeometry2D-534"><span class="linenos">534</span></a>            <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-535"><a href="#SymbolGeometry2D-535"><span class="linenos">535</span></a>            <span class="n">strengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-536"><a href="#SymbolGeometry2D-536"><span class="linenos">536</span></a>            <span class="c1"># Majority type</span>
</span><span id="SymbolGeometry2D-537"><a href="#SymbolGeometry2D-537"><span class="linenos">537</span></a>            <span class="n">type_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SymbolGeometry2D-538"><a href="#SymbolGeometry2D-538"><span class="linenos">538</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-539"><a href="#SymbolGeometry2D-539"><span class="linenos">539</span></a>                <span class="n">type_counts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="SymbolGeometry2D-540"><a href="#SymbolGeometry2D-540"><span class="linenos">540</span></a>            <span class="n">dominant_type</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">type_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D-541"><a href="#SymbolGeometry2D-541"><span class="linenos">541</span></a>            <span class="c1"># Maslov index (approximation)</span>
</span><span id="SymbolGeometry2D-542"><a href="#SymbolGeometry2D-542"><span class="linenos">542</span></a>            <span class="n">maslov_index</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">dominant_type</span> <span class="o">==</span> <span class="s1">&#39;fold&#39;</span> <span class="k">else</span> <span class="mi">2</span>
</span><span id="SymbolGeometry2D-543"><a href="#SymbolGeometry2D-543"><span class="linenos">543</span></a>            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CausticStructure</span><span class="p">(</span>
</span><span id="SymbolGeometry2D-544"><a href="#SymbolGeometry2D-544"><span class="linenos">544</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-545"><a href="#SymbolGeometry2D-545"><span class="linenos">545</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">ys</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-546"><a href="#SymbolGeometry2D-546"><span class="linenos">546</span></a>                <span class="n">t</span><span class="o">=</span><span class="n">t_fixed</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-547"><a href="#SymbolGeometry2D-547"><span class="linenos">547</span></a>                <span class="n">energy</span><span class="o">=</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span>
</span><span id="SymbolGeometry2D-548"><a href="#SymbolGeometry2D-548"><span class="linenos">548</span></a>                <span class="nb">type</span><span class="o">=</span><span class="n">dominant_type</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-549"><a href="#SymbolGeometry2D-549"><span class="linenos">549</span></a>                <span class="n">maslov_index</span><span class="o">=</span><span class="n">maslov_index</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-550"><a href="#SymbolGeometry2D-550"><span class="linenos">550</span></a>                <span class="n">strength</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">strengths</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-551"><a href="#SymbolGeometry2D-551"><span class="linenos">551</span></a>            <span class="p">))</span>
</span><span id="SymbolGeometry2D-552"><a href="#SymbolGeometry2D-552"><span class="linenos">552</span></a>        <span class="k">return</span> <span class="n">clusters</span>
</span><span id="SymbolGeometry2D-553"><a href="#SymbolGeometry2D-553"><span class="linenos">553</span></a>    
</span><span id="SymbolGeometry2D-554"><a href="#SymbolGeometry2D-554"><span class="linenos">554</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_phase_space_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">y_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
</span><span id="SymbolGeometry2D-555"><a href="#SymbolGeometry2D-555"><span class="linenos">555</span></a>                                 <span class="n">xi_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> 
</span><span id="SymbolGeometry2D-556"><a href="#SymbolGeometry2D-556"><span class="linenos">556</span></a>                                 <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SymbolGeometry2D-557"><a href="#SymbolGeometry2D-557"><span class="linenos">557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Monte Carlo estimation of phase space volume for H ≤ E_max&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D-558"><a href="#SymbolGeometry2D-558"><span class="linenos">558</span></a>        <span class="c1"># Generate random samples</span>
</span><span id="SymbolGeometry2D-559"><a href="#SymbolGeometry2D-559"><span class="linenos">559</span></a>        <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-560"><a href="#SymbolGeometry2D-560"><span class="linenos">560</span></a>        <span class="n">y_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-561"><a href="#SymbolGeometry2D-561"><span class="linenos">561</span></a>        <span class="n">xi_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-562"><a href="#SymbolGeometry2D-562"><span class="linenos">562</span></a>        <span class="n">eta_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eta_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-563"><a href="#SymbolGeometry2D-563"><span class="linenos">563</span></a>        <span class="c1"># Evaluate Hamiltonian</span>
</span><span id="SymbolGeometry2D-564"><a href="#SymbolGeometry2D-564"><span class="linenos">564</span></a>        <span class="n">H_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x_samples</span><span class="p">,</span> <span class="n">y_samples</span><span class="p">,</span> <span class="n">xi_samples</span><span class="p">,</span> <span class="n">eta_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-565"><a href="#SymbolGeometry2D-565"><span class="linenos">565</span></a>        <span class="c1"># Count points where H ≤ E_max</span>
</span><span id="SymbolGeometry2D-566"><a href="#SymbolGeometry2D-566"><span class="linenos">566</span></a>        <span class="n">volume_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">H_vals</span> <span class="o">&lt;=</span> <span class="n">E_max</span><span class="p">)</span>
</span><span id="SymbolGeometry2D-567"><a href="#SymbolGeometry2D-567"><span class="linenos">567</span></a>        <span class="c1"># Total phase space volume</span>
</span><span id="SymbolGeometry2D-568"><a href="#SymbolGeometry2D-568"><span class="linenos">568</span></a>        <span class="n">total_volume</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> 
</span><span id="SymbolGeometry2D-569"><a href="#SymbolGeometry2D-569"><span class="linenos">569</span></a>                       <span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="SymbolGeometry2D-570"><a href="#SymbolGeometry2D-570"><span class="linenos">570</span></a>        <span class="k">return</span> <span class="n">volume_ratio</span> <span class="o">*</span> <span class="n">total_volume</span>
</span></pre></div>


            <div class="docstring"><p>Full geometric and semi-classical analysis of a 2D symbol
H(x, y, ξ, η) with 4D phase space and rigorous caustic treatment</p>
</div>


                            <div id="SymbolGeometry2D.__init__" class="classattr">
                                        <input id="SymbolGeometry2D.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SymbolGeometry2D</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">symbol</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expr</span>,</span><span class="param">	<span class="n">x_sym</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">y_sym</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">xi_sym</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">eta_sym</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span>)</span>

                <label class="view-source-button" for="SymbolGeometry2D.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry2D.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry2D.__init__-145"><a href="#SymbolGeometry2D.__init__-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> 
</span><span id="SymbolGeometry2D.__init__-146"><a href="#SymbolGeometry2D.__init__-146"><span class="linenos">146</span></a>                 <span class="n">x_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">y_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.__init__-147"><a href="#SymbolGeometry2D.__init__-147"><span class="linenos">147</span></a>                 <span class="n">xi_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">eta_sym</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.__init__-148"><a href="#SymbolGeometry2D.__init__-148"><span class="linenos">148</span></a>                 <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="SymbolGeometry2D.__init__-149"><a href="#SymbolGeometry2D.__init__-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.__init__-150"><a href="#SymbolGeometry2D.__init__-150"><span class="linenos">150</span></a><span class="sd">        Initialization with complete derivative computation for Jacobian evolution</span>
</span><span id="SymbolGeometry2D.__init__-151"><a href="#SymbolGeometry2D.__init__-151"><span class="linenos">151</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry2D.__init__-152"><a href="#SymbolGeometry2D.__init__-152"><span class="linenos">152</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry2D.__init__-153"><a href="#SymbolGeometry2D.__init__-153"><span class="linenos">153</span></a><span class="sd">        symbol : sympy expression</span>
</span><span id="SymbolGeometry2D.__init__-154"><a href="#SymbolGeometry2D.__init__-154"><span class="linenos">154</span></a><span class="sd">            Hamiltonian H(x, y, ξ, η)</span>
</span><span id="SymbolGeometry2D.__init__-155"><a href="#SymbolGeometry2D.__init__-155"><span class="linenos">155</span></a><span class="sd">        x_sym, y_sym : sympy symbols</span>
</span><span id="SymbolGeometry2D.__init__-156"><a href="#SymbolGeometry2D.__init__-156"><span class="linenos">156</span></a><span class="sd">            Position coordinates</span>
</span><span id="SymbolGeometry2D.__init__-157"><a href="#SymbolGeometry2D.__init__-157"><span class="linenos">157</span></a><span class="sd">        xi_sym, eta_sym : sympy symbols</span>
</span><span id="SymbolGeometry2D.__init__-158"><a href="#SymbolGeometry2D.__init__-158"><span class="linenos">158</span></a><span class="sd">            Momentum coordinates</span>
</span><span id="SymbolGeometry2D.__init__-159"><a href="#SymbolGeometry2D.__init__-159"><span class="linenos">159</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolGeometry2D.__init__-160"><a href="#SymbolGeometry2D.__init__-160"><span class="linenos">160</span></a><span class="sd">            Reduced Planck constant (for quantum aspects)</span>
</span><span id="SymbolGeometry2D.__init__-161"><a href="#SymbolGeometry2D.__init__-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.__init__-162"><a href="#SymbolGeometry2D.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="SymbolGeometry2D.__init__-163"><a href="#SymbolGeometry2D.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span> <span class="o">=</span> <span class="n">x_sym</span>
</span><span id="SymbolGeometry2D.__init__-164"><a href="#SymbolGeometry2D.__init__-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span> <span class="o">=</span> <span class="n">y_sym</span>
</span><span id="SymbolGeometry2D.__init__-165"><a href="#SymbolGeometry2D.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span> <span class="o">=</span> <span class="n">xi_sym</span>
</span><span id="SymbolGeometry2D.__init__-166"><a href="#SymbolGeometry2D.__init__-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span> <span class="o">=</span> <span class="n">eta_sym</span>
</span><span id="SymbolGeometry2D.__init__-167"><a href="#SymbolGeometry2D.__init__-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">=</span> <span class="n">hbar</span>
</span><span id="SymbolGeometry2D.__init__-168"><a href="#SymbolGeometry2D.__init__-168"><span class="linenos">168</span></a>            
</span><span id="SymbolGeometry2D.__init__-169"><a href="#SymbolGeometry2D.__init__-169"><span class="linenos">169</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing 2D geometry engine for H = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="si">}</span><span class="s2"> with ℏ = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hbar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-170"><a href="#SymbolGeometry2D.__init__-170"><span class="linenos">170</span></a>        <span class="c1"># --- First derivatives (Hamiltonian vector field) ---</span>
</span><span id="SymbolGeometry2D.__init__-171"><a href="#SymbolGeometry2D.__init__-171"><span class="linenos">171</span></a>        <span class="n">dH_x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-172"><a href="#SymbolGeometry2D.__init__-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_x</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-173"><a href="#SymbolGeometry2D.__init__-173"><span class="linenos">173</span></a>        <span class="n">dH_y</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-174"><a href="#SymbolGeometry2D.__init__-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_y</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-175"><a href="#SymbolGeometry2D.__init__-175"><span class="linenos">175</span></a>        <span class="n">dH_xi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-176"><a href="#SymbolGeometry2D.__init__-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_xi</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-177"><a href="#SymbolGeometry2D.__init__-177"><span class="linenos">177</span></a>        <span class="n">dH_eta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-178"><a href="#SymbolGeometry2D.__init__-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">dH_eta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-179"><a href="#SymbolGeometry2D.__init__-179"><span class="linenos">179</span></a>
</span><span id="SymbolGeometry2D.__init__-180"><a href="#SymbolGeometry2D.__init__-180"><span class="linenos">180</span></a>        <span class="c1"># --- Second derivatives for variational equations ---</span>
</span><span id="SymbolGeometry2D.__init__-181"><a href="#SymbolGeometry2D.__init__-181"><span class="linenos">181</span></a>        <span class="n">d2H_x2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-182"><a href="#SymbolGeometry2D.__init__-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dx2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_x2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-183"><a href="#SymbolGeometry2D.__init__-183"><span class="linenos">183</span></a>        <span class="n">d2H_y2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-184"><a href="#SymbolGeometry2D.__init__-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dy2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_y2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-185"><a href="#SymbolGeometry2D.__init__-185"><span class="linenos">185</span></a>        <span class="n">d2H_xi2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-186"><a href="#SymbolGeometry2D.__init__-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxi2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xi2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-187"><a href="#SymbolGeometry2D.__init__-187"><span class="linenos">187</span></a>        <span class="n">d2H_eta2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_deta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-188"><a href="#SymbolGeometry2D.__init__-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_deta2_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_eta2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-189"><a href="#SymbolGeometry2D.__init__-189"><span class="linenos">189</span></a>        <span class="n">d2H_xy</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-190"><a href="#SymbolGeometry2D.__init__-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdy_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xy</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-191"><a href="#SymbolGeometry2D.__init__-191"><span class="linenos">191</span></a>        <span class="n">d2H_xxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-192"><a href="#SymbolGeometry2D.__init__-192"><span class="linenos">192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xxi</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-193"><a href="#SymbolGeometry2D.__init__-193"><span class="linenos">193</span></a>        <span class="n">d2H_xeta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dx_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-194"><a href="#SymbolGeometry2D.__init__-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdeta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xeta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-195"><a href="#SymbolGeometry2D.__init__-195"><span class="linenos">195</span></a>        <span class="n">d2H_yxi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xi_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-196"><a href="#SymbolGeometry2D.__init__-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dydxi_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_yxi</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-197"><a href="#SymbolGeometry2D.__init__-197"><span class="linenos">197</span></a>        <span class="n">d2H_yeta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-198"><a href="#SymbolGeometry2D.__init__-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dyeta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_yeta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-199"><a href="#SymbolGeometry2D.__init__-199"><span class="linenos">199</span></a>        <span class="n">d2H_xieta</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dH_dxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_sym</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-200"><a href="#SymbolGeometry2D.__init__-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxideta_sym</span> <span class="o">=</span> <span class="n">_sanitize</span><span class="p">(</span><span class="n">d2H_xieta</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.__init__-201"><a href="#SymbolGeometry2D.__init__-201"><span class="linenos">201</span></a>        <span class="c1"># --- Hessian for variational equations ---</span>
</span><span id="SymbolGeometry2D.__init__-202"><a href="#SymbolGeometry2D.__init__-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hessian</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span>
</span><span id="SymbolGeometry2D.__init__-203"><a href="#SymbolGeometry2D.__init__-203"><span class="linenos">203</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dx2_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdeta_sym</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.__init__-204"><a href="#SymbolGeometry2D.__init__-204"><span class="linenos">204</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdy_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dy2_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dydxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dyeta_sym</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.__init__-205"><a href="#SymbolGeometry2D.__init__-205"><span class="linenos">205</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dydxi_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxi2_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxideta_sym</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.__init__-206"><a href="#SymbolGeometry2D.__init__-206"><span class="linenos">206</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxdeta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dyeta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_dxideta_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2H_deta2_sym</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.__init__-207"><a href="#SymbolGeometry2D.__init__-207"><span class="linenos">207</span></a>        <span class="p">])</span>
</span><span id="SymbolGeometry2D.__init__-208"><a href="#SymbolGeometry2D.__init__-208"><span class="linenos">208</span></a>
</span><span id="SymbolGeometry2D.__init__-209"><a href="#SymbolGeometry2D.__init__-209"><span class="linenos">209</span></a>        <span class="c1"># --- Convert to numerical functions ---</span>
</span><span id="SymbolGeometry2D.__init__-210"><a href="#SymbolGeometry2D.__init__-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lambdify_functions</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialization with complete derivative computation for Jacobian evolution</p>

<h2 id="parameters">Parameters</h2>

<p>symbol : sympy expression
    Hamiltonian H(x, y, ξ, η)
x_sym, y_sym : sympy symbols
    Position coordinates
xi_sym, eta_sym : sympy symbols
    Momentum coordinates
hbar : float
    Reduced Planck constant (for quantum aspects)</p>
</div>


                            </div>
                            <div id="SymbolGeometry2D.H_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">H_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.H_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.x_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">x_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.x_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.y_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">y_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.y_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.xi_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">xi_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.xi_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.eta_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">eta_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.eta_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.hbar" class="classattr">
                                <div class="attr variable">
            <span class="name">hbar</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.hbar"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.dH_dx_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">dH_dx_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.dH_dx_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.dH_dy_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">dH_dy_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.dH_dy_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.dH_dxi_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">dH_dxi_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.dH_dxi_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.dH_deta_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">dH_deta_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.dH_deta_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dx2_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dx2_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dx2_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dy2_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dy2_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dy2_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dxi2_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dxi2_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dxi2_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_deta2_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_deta2_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_deta2_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dxdy_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dxdy_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dxdy_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dxdxi_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dxdxi_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dxdxi_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dxdeta_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dxdeta_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dxdeta_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dydxi_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dydxi_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dydxi_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dyeta_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dyeta_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dyeta_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.d2H_dxideta_sym" class="classattr">
                                <div class="attr variable">
            <span class="name">d2H_dxideta_sym</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.d2H_dxideta_sym"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.Hessian" class="classattr">
                                <div class="attr variable">
            <span class="name">Hessian</span>

        
    </div>
    <a class="headerlink" href="#SymbolGeometry2D.Hessian"></a>
    
    

                            </div>
                            <div id="SymbolGeometry2D.compute_geodesic" class="classattr">
                                        <input id="SymbolGeometry2D.compute_geodesic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_geodesic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x0</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">y0</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">eta0</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span></span><span class="return-annotation">) -> <span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">Geodesic2D</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry2D.compute_geodesic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry2D.compute_geodesic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry2D.compute_geodesic-277"><a href="#SymbolGeometry2D.compute_geodesic-277"><span class="linenos">277</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_geodesic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="SymbolGeometry2D.compute_geodesic-278"><a href="#SymbolGeometry2D.compute_geodesic-278"><span class="linenos">278</span></a>                        <span class="n">xi0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-279"><a href="#SymbolGeometry2D.compute_geodesic-279"><span class="linenos">279</span></a>                        <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Geodesic2D</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.compute_geodesic-280"><a href="#SymbolGeometry2D.compute_geodesic-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.compute_geodesic-281"><a href="#SymbolGeometry2D.compute_geodesic-281"><span class="linenos">281</span></a><span class="sd">        Compute a geodesic with full Jacobian evolution for caustic detection</span>
</span><span id="SymbolGeometry2D.compute_geodesic-282"><a href="#SymbolGeometry2D.compute_geodesic-282"><span class="linenos">282</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolGeometry2D.compute_geodesic-283"><a href="#SymbolGeometry2D.compute_geodesic-283"><span class="linenos">283</span></a><span class="sd">        ----------</span>
</span><span id="SymbolGeometry2D.compute_geodesic-284"><a href="#SymbolGeometry2D.compute_geodesic-284"><span class="linenos">284</span></a><span class="sd">        x0, y0 : float</span>
</span><span id="SymbolGeometry2D.compute_geodesic-285"><a href="#SymbolGeometry2D.compute_geodesic-285"><span class="linenos">285</span></a><span class="sd">            Initial position</span>
</span><span id="SymbolGeometry2D.compute_geodesic-286"><a href="#SymbolGeometry2D.compute_geodesic-286"><span class="linenos">286</span></a><span class="sd">        xi0, eta0 : float</span>
</span><span id="SymbolGeometry2D.compute_geodesic-287"><a href="#SymbolGeometry2D.compute_geodesic-287"><span class="linenos">287</span></a><span class="sd">            Initial momentum</span>
</span><span id="SymbolGeometry2D.compute_geodesic-288"><a href="#SymbolGeometry2D.compute_geodesic-288"><span class="linenos">288</span></a><span class="sd">        t_max : float</span>
</span><span id="SymbolGeometry2D.compute_geodesic-289"><a href="#SymbolGeometry2D.compute_geodesic-289"><span class="linenos">289</span></a><span class="sd">            Final time</span>
</span><span id="SymbolGeometry2D.compute_geodesic-290"><a href="#SymbolGeometry2D.compute_geodesic-290"><span class="linenos">290</span></a><span class="sd">        n_points : int</span>
</span><span id="SymbolGeometry2D.compute_geodesic-291"><a href="#SymbolGeometry2D.compute_geodesic-291"><span class="linenos">291</span></a><span class="sd">            Number of sampling points</span>
</span><span id="SymbolGeometry2D.compute_geodesic-292"><a href="#SymbolGeometry2D.compute_geodesic-292"><span class="linenos">292</span></a><span class="sd">        Returns</span>
</span><span id="SymbolGeometry2D.compute_geodesic-293"><a href="#SymbolGeometry2D.compute_geodesic-293"><span class="linenos">293</span></a><span class="sd">        -------</span>
</span><span id="SymbolGeometry2D.compute_geodesic-294"><a href="#SymbolGeometry2D.compute_geodesic-294"><span class="linenos">294</span></a><span class="sd">        Geodesic2D</span>
</span><span id="SymbolGeometry2D.compute_geodesic-295"><a href="#SymbolGeometry2D.compute_geodesic-295"><span class="linenos">295</span></a><span class="sd">            Structure containing trajectory and caustic analysis</span>
</span><span id="SymbolGeometry2D.compute_geodesic-296"><a href="#SymbolGeometry2D.compute_geodesic-296"><span class="linenos">296</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.compute_geodesic-297"><a href="#SymbolGeometry2D.compute_geodesic-297"><span class="linenos">297</span></a>        <span class="c1"># Initial condition: position, momentum + identity Jacobian</span>
</span><span id="SymbolGeometry2D.compute_geodesic-298"><a href="#SymbolGeometry2D.compute_geodesic-298"><span class="linenos">298</span></a>        <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-299"><a href="#SymbolGeometry2D.compute_geodesic-299"><span class="linenos">299</span></a>        <span class="n">z0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-300"><a href="#SymbolGeometry2D.compute_geodesic-300"><span class="linenos">300</span></a>        <span class="n">z0</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="SymbolGeometry2D.compute_geodesic-301"><a href="#SymbolGeometry2D.compute_geodesic-301"><span class="linenos">301</span></a>        <span class="n">t_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-302"><a href="#SymbolGeometry2D.compute_geodesic-302"><span class="linenos">302</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
</span><span id="SymbolGeometry2D.compute_geodesic-303"><a href="#SymbolGeometry2D.compute_geodesic-303"><span class="linenos">303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_hamiltonian_system_augmented</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-304"><a href="#SymbolGeometry2D.compute_geodesic-304"><span class="linenos">304</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">t_eval</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-305"><a href="#SymbolGeometry2D.compute_geodesic-305"><span class="linenos">305</span></a>            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;DOP853&#39;</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span>
</span><span id="SymbolGeometry2D.compute_geodesic-306"><a href="#SymbolGeometry2D.compute_geodesic-306"><span class="linenos">306</span></a>        <span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-307"><a href="#SymbolGeometry2D.compute_geodesic-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.compute_geodesic-308"><a href="#SymbolGeometry2D.compute_geodesic-308"><span class="linenos">308</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Integration failed for (</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">xi0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">eta0</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-309"><a href="#SymbolGeometry2D.compute_geodesic-309"><span class="linenos">309</span></a>        <span class="c1"># Extract trajectory data</span>
</span><span id="SymbolGeometry2D.compute_geodesic-310"><a href="#SymbolGeometry2D.compute_geodesic-310"><span class="linenos">310</span></a>        <span class="n">x_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-311"><a href="#SymbolGeometry2D.compute_geodesic-311"><span class="linenos">311</span></a>        <span class="n">y_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-312"><a href="#SymbolGeometry2D.compute_geodesic-312"><span class="linenos">312</span></a>        <span class="n">xi_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-313"><a href="#SymbolGeometry2D.compute_geodesic-313"><span class="linenos">313</span></a>        <span class="n">eta_traj</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-314"><a href="#SymbolGeometry2D.compute_geodesic-314"><span class="linenos">314</span></a>        <span class="c1"># Evaluate energy</span>
</span><span id="SymbolGeometry2D.compute_geodesic-315"><a href="#SymbolGeometry2D.compute_geodesic-315"><span class="linenos">315</span></a>        <span class="n">H_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x_traj</span><span class="p">,</span> <span class="n">y_traj</span><span class="p">,</span> <span class="n">xi_traj</span><span class="p">,</span> <span class="n">eta_traj</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-316"><a href="#SymbolGeometry2D.compute_geodesic-316"><span class="linenos">316</span></a>        <span class="c1"># Extract and reshape Jacobian matrices</span>
</span><span id="SymbolGeometry2D.compute_geodesic-317"><a href="#SymbolGeometry2D.compute_geodesic-317"><span class="linenos">317</span></a>        <span class="n">J_mats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="SymbolGeometry2D.compute_geodesic-318"><a href="#SymbolGeometry2D.compute_geodesic-318"><span class="linenos">318</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
</span><span id="SymbolGeometry2D.compute_geodesic-319"><a href="#SymbolGeometry2D.compute_geodesic-319"><span class="linenos">319</span></a>            <span class="n">J_mats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="SymbolGeometry2D.compute_geodesic-320"><a href="#SymbolGeometry2D.compute_geodesic-320"><span class="linenos">320</span></a>        <span class="c1"># Submatrix for caustic detection: ∂(x,y)/∂(ξ₀,η₀)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-321"><a href="#SymbolGeometry2D.compute_geodesic-321"><span class="linenos">321</span></a>        <span class="n">caustic_matrix</span> <span class="o">=</span> <span class="n">J_mats</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-322"><a href="#SymbolGeometry2D.compute_geodesic-322"><span class="linenos">322</span></a>        <span class="c1"># Determinant for caustic detection</span>
</span><span id="SymbolGeometry2D.compute_geodesic-323"><a href="#SymbolGeometry2D.compute_geodesic-323"><span class="linenos">323</span></a>        <span class="n">det_caustic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-324"><a href="#SymbolGeometry2D.compute_geodesic-324"><span class="linenos">324</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
</span><span id="SymbolGeometry2D.compute_geodesic-325"><a href="#SymbolGeometry2D.compute_geodesic-325"><span class="linenos">325</span></a>            <span class="n">det_caustic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">caustic_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolGeometry2D.compute_geodesic-326"><a href="#SymbolGeometry2D.compute_geodesic-326"><span class="linenos">326</span></a>        <span class="c1"># Detect caustic indices (sign change)</span>
</span><span id="SymbolGeometry2D.compute_geodesic-327"><a href="#SymbolGeometry2D.compute_geodesic-327"><span class="linenos">327</span></a>        <span class="n">caustic_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">det_caustic</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.compute_geodesic-328"><a href="#SymbolGeometry2D.compute_geodesic-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="n">Geodesic2D</span><span class="p">(</span>
</span><span id="SymbolGeometry2D.compute_geodesic-329"><a href="#SymbolGeometry2D.compute_geodesic-329"><span class="linenos">329</span></a>            <span class="n">t</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-330"><a href="#SymbolGeometry2D.compute_geodesic-330"><span class="linenos">330</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">x_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-331"><a href="#SymbolGeometry2D.compute_geodesic-331"><span class="linenos">331</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">y_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-332"><a href="#SymbolGeometry2D.compute_geodesic-332"><span class="linenos">332</span></a>            <span class="n">xi</span><span class="o">=</span><span class="n">xi_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-333"><a href="#SymbolGeometry2D.compute_geodesic-333"><span class="linenos">333</span></a>            <span class="n">eta</span><span class="o">=</span><span class="n">eta_traj</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-334"><a href="#SymbolGeometry2D.compute_geodesic-334"><span class="linenos">334</span></a>            <span class="n">H</span><span class="o">=</span><span class="n">H_vals</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-335"><a href="#SymbolGeometry2D.compute_geodesic-335"><span class="linenos">335</span></a>            <span class="n">J_full</span><span class="o">=</span><span class="n">J_mats</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-336"><a href="#SymbolGeometry2D.compute_geodesic-336"><span class="linenos">336</span></a>            <span class="n">det_caustic</span><span class="o">=</span><span class="n">det_caustic</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_geodesic-337"><a href="#SymbolGeometry2D.compute_geodesic-337"><span class="linenos">337</span></a>            <span class="n">caustic_indices</span><span class="o">=</span><span class="n">caustic_indices</span>
</span><span id="SymbolGeometry2D.compute_geodesic-338"><a href="#SymbolGeometry2D.compute_geodesic-338"><span class="linenos">338</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute a geodesic with full Jacobian evolution for caustic detection</p>

<h2 id="parameters">Parameters</h2>

<p>x0, y0 : float
    Initial position
xi0, eta0 : float
    Initial momentum
t_max : float
    Final time
n_points : int
    Number of sampling points</p>

<h2 id="returns">Returns</h2>

<p>Geodesic2D
    Structure containing trajectory and caustic analysis</p>
</div>


                            </div>
                            <div id="SymbolGeometry2D.find_periodic_orbits_2d" class="classattr">
                                        <input id="SymbolGeometry2D.find_periodic_orbits_2d-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_periodic_orbits_2d</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">y_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">eta_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">PeriodicOrbit2D</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry2D.find_periodic_orbits_2d-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry2D.find_periodic_orbits_2d"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry2D.find_periodic_orbits_2d-340"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-340"><span class="linenos">340</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_periodic_orbits_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-341"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-341"><span class="linenos">341</span></a>                               <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-342"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-342"><span class="linenos">342</span></a>                               <span class="n">y_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-343"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-343"><span class="linenos">343</span></a>                               <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-344"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-344"><span class="linenos">344</span></a>                               <span class="n">eta_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-345"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-345"><span class="linenos">345</span></a>                               <span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit2D</span><span class="p">]:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-346"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-347"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-347"><span class="linenos">347</span></a><span class="sd">        Search for periodic orbits with Maslov index computation</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-348"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-349"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-349"><span class="linenos">349</span></a>        <span class="n">orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-350"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-350"><span class="linenos">350</span></a>        <span class="c1"># Sample configuration space</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-351"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-351"><span class="linenos">351</span></a>        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_attempts</span><span class="p">))</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-352"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-352"><span class="linenos">352</span></a>        <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-353"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-353"><span class="linenos">353</span></a>        <span class="n">y_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-354"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-354"><span class="linenos">354</span></a>        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">x_samples</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-355"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-355"><span class="linenos">355</span></a>            <span class="k">for</span> <span class="n">y0</span> <span class="ow">in</span> <span class="n">y_samples</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-356"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-356"><span class="linenos">356</span></a>                <span class="c1"># Test different momentum directions</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-357"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-357"><span class="linenos">357</span></a>                <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-358"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-358"><span class="linenos">358</span></a>                <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-359"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-359"><span class="linenos">359</span></a>                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-360"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-360"><span class="linenos">360</span></a>                        <span class="n">xi0_guess</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-361"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-361"><span class="linenos">361</span></a>                        <span class="n">eta0_guess</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-362"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-362"><span class="linenos">362</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-363"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-363"><span class="linenos">363</span></a>                            <span class="c1"># Energy check</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-364"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-364"><span class="linenos">364</span></a>                            <span class="n">E_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-365"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-365"><span class="linenos">365</span></a>                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">E_test</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-366"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-366"><span class="linenos">366</span></a>                                <span class="k">continue</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-367"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-367"><span class="linenos">367</span></a>                            <span class="c1"># Compute geodesic</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-368"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-368"><span class="linenos">368</span></a>                            <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-369"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-369"><span class="linenos">369</span></a>                            <span class="c1"># Search for return points</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-370"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-370"><span class="linenos">370</span></a>                            <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-371"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-371"><span class="linenos">371</span></a>                                              <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span> <span class="o">-</span> <span class="n">xi0_guess</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span> <span class="o">-</span> <span class="n">eta0_guess</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-372"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-372"><span class="linenos">372</span></a>                            <span class="n">minima</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-373"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-373"><span class="linenos">373</span></a>                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">):</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-374"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-374"><span class="linenos">374</span></a>                                <span class="k">if</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-375"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-375"><span class="linenos">375</span></a>                                    <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-376"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-376"><span class="linenos">376</span></a>                                    <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">):</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-377"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-377"><span class="linenos">377</span></a>                                    <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-378"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-378"><span class="linenos">378</span></a>                            <span class="k">if</span> <span class="n">minima</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-379"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-379"><span class="linenos">379</span></a>                                <span class="n">idx</span> <span class="o">=</span> <span class="n">minima</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-380"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-380"><span class="linenos">380</span></a>                                <span class="n">period</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-381"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-381"><span class="linenos">381</span></a>                                <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">distances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-382"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-382"><span class="linenos">382</span></a>                                    <span class="c1"># Compute action</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-383"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-383"><span class="linenos">383</span></a>                                    <span class="n">x_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-384"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-384"><span class="linenos">384</span></a>                                    <span class="n">y_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-385"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-385"><span class="linenos">385</span></a>                                    <span class="n">xi_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-386"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-386"><span class="linenos">386</span></a>                                    <span class="n">eta_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-387"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-387"><span class="linenos">387</span></a>                                    <span class="n">t_cyc</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-388"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-388"><span class="linenos">388</span></a>                                    <span class="n">dx_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x_cyc</span><span class="p">,</span> <span class="n">t_cyc</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-389"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-389"><span class="linenos">389</span></a>                                    <span class="n">dy_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y_cyc</span><span class="p">,</span> <span class="n">t_cyc</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-390"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-390"><span class="linenos">390</span></a>                                    <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">xi_cyc</span> <span class="o">*</span> <span class="n">dx_dt</span> <span class="o">+</span> <span class="n">eta_cyc</span> <span class="o">*</span> <span class="n">dy_dt</span><span class="p">,</span> <span class="n">t_cyc</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-391"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-391"><span class="linenos">391</span></a>                                    <span class="c1"># Compute Maslov index (number of caustic crossings)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-392"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-392"><span class="linenos">392</span></a>                                    <span class="n">maslov_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustic_indices</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">idx</span><span class="p">])</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-393"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-393"><span class="linenos">393</span></a>                                    <span class="c1"># Compute stability</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-394"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-394"><span class="linenos">394</span></a>                                    <span class="n">stab1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_stability_2d</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-395"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-395"><span class="linenos">395</span></a>                                    <span class="n">orbits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PeriodicOrbit2D</span><span class="p">(</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-396"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-396"><span class="linenos">396</span></a>                                        <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-397"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-397"><span class="linenos">397</span></a>                                        <span class="n">xi0</span><span class="o">=</span><span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="n">eta0_guess</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-398"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-398"><span class="linenos">398</span></a>                                        <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-399"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-399"><span class="linenos">399</span></a>                                        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-400"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-400"><span class="linenos">400</span></a>                                        <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-401"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-401"><span class="linenos">401</span></a>                                        <span class="n">stability_1</span><span class="o">=</span><span class="n">stab1</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-402"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-402"><span class="linenos">402</span></a>                                        <span class="n">stability_2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-403"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-403"><span class="linenos">403</span></a>                                        <span class="n">x_cycle</span><span class="o">=</span><span class="n">x_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-404"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-404"><span class="linenos">404</span></a>                                        <span class="n">y_cycle</span><span class="o">=</span><span class="n">y_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-405"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-405"><span class="linenos">405</span></a>                                        <span class="n">xi_cycle</span><span class="o">=</span><span class="n">xi_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-406"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-406"><span class="linenos">406</span></a>                                        <span class="n">eta_cycle</span><span class="o">=</span><span class="n">eta_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-407"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-407"><span class="linenos">407</span></a>                                        <span class="n">t_cycle</span><span class="o">=</span><span class="n">t_cyc</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-408"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-408"><span class="linenos">408</span></a>                                        <span class="n">maslov_index</span><span class="o">=</span><span class="n">maslov_index</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-409"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-409"><span class="linenos">409</span></a>                                    <span class="p">))</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-410"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-410"><span class="linenos">410</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-411"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-411"><span class="linenos">411</span></a>                            <span class="k">continue</span>
</span><span id="SymbolGeometry2D.find_periodic_orbits_2d-412"><a href="#SymbolGeometry2D.find_periodic_orbits_2d-412"><span class="linenos">412</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_duplicate_orbits_2d</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Search for periodic orbits with Maslov index computation</p>
</div>


                            </div>
                            <div id="SymbolGeometry2D.detect_caustic_structures" class="classattr">
                                        <input id="SymbolGeometry2D.detect_caustic_structures-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detect_caustic_structures</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">geodesics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">Geodesic2D</span><span class="p">]</span>,</span><span class="param">	<span class="n">t_fixed</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">CausticStructure</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry2D.detect_caustic_structures-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry2D.detect_caustic_structures"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry2D.detect_caustic_structures-455"><a href="#SymbolGeometry2D.detect_caustic_structures-455"><span class="linenos">455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detect_caustic_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Geodesic2D</span><span class="p">],</span> 
</span><span id="SymbolGeometry2D.detect_caustic_structures-456"><a href="#SymbolGeometry2D.detect_caustic_structures-456"><span class="linenos">456</span></a>                                 <span class="n">t_fixed</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CausticStructure</span><span class="p">]:</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-457"><a href="#SymbolGeometry2D.detect_caustic_structures-457"><span class="linenos">457</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-458"><a href="#SymbolGeometry2D.detect_caustic_structures-458"><span class="linenos">458</span></a><span class="sd">        Advanced caustic structure detection with classification</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-459"><a href="#SymbolGeometry2D.detect_caustic_structures-459"><span class="linenos">459</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-460"><a href="#SymbolGeometry2D.detect_caustic_structures-460"><span class="linenos">460</span></a>        <span class="n">caustic_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-461"><a href="#SymbolGeometry2D.detect_caustic_structures-461"><span class="linenos">461</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-462"><a href="#SymbolGeometry2D.detect_caustic_structures-462"><span class="linenos">462</span></a>            <span class="c1"># Find closest time to t_fixed</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-463"><a href="#SymbolGeometry2D.detect_caustic_structures-463"><span class="linenos">463</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_fixed</span><span class="p">))</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-464"><a href="#SymbolGeometry2D.detect_caustic_structures-464"><span class="linenos">464</span></a>            <span class="c1"># Check if near a caustic</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-465"><a href="#SymbolGeometry2D.detect_caustic_structures-465"><span class="linenos">465</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">det_caustic</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-466"><a href="#SymbolGeometry2D.detect_caustic_structures-466"><span class="linenos">466</span></a>                <span class="c1"># Classify caustic type</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-467"><a href="#SymbolGeometry2D.detect_caustic_structures-467"><span class="linenos">467</span></a>                <span class="n">caustic_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_caustic</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-468"><a href="#SymbolGeometry2D.detect_caustic_structures-468"><span class="linenos">468</span></a>                <span class="c1"># Compute singularity strength</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-469"><a href="#SymbolGeometry2D.detect_caustic_structures-469"><span class="linenos">469</span></a>                <span class="n">strength</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">det_caustic</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-470"><a href="#SymbolGeometry2D.detect_caustic_structures-470"><span class="linenos">470</span></a>                <span class="n">caustic_points</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-471"><a href="#SymbolGeometry2D.detect_caustic_structures-471"><span class="linenos">471</span></a>                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-472"><a href="#SymbolGeometry2D.detect_caustic_structures-472"><span class="linenos">472</span></a>                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-473"><a href="#SymbolGeometry2D.detect_caustic_structures-473"><span class="linenos">473</span></a>                    <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">geo</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-474"><a href="#SymbolGeometry2D.detect_caustic_structures-474"><span class="linenos">474</span></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">caustic_type</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-475"><a href="#SymbolGeometry2D.detect_caustic_structures-475"><span class="linenos">475</span></a>                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">strength</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-476"><a href="#SymbolGeometry2D.detect_caustic_structures-476"><span class="linenos">476</span></a>                <span class="p">})</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-477"><a href="#SymbolGeometry2D.detect_caustic_structures-477"><span class="linenos">477</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caustic_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-478"><a href="#SymbolGeometry2D.detect_caustic_structures-478"><span class="linenos">478</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-479"><a href="#SymbolGeometry2D.detect_caustic_structures-479"><span class="linenos">479</span></a>        <span class="c1"># Cluster points into caustic structures</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-480"><a href="#SymbolGeometry2D.detect_caustic_structures-480"><span class="linenos">480</span></a>        <span class="n">caustic_structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_caustic_points</span><span class="p">(</span><span class="n">caustic_points</span><span class="p">,</span> <span class="n">t_fixed</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.detect_caustic_structures-481"><a href="#SymbolGeometry2D.detect_caustic_structures-481"><span class="linenos">481</span></a>        <span class="k">return</span> <span class="n">caustic_structures</span>
</span></pre></div>


            <div class="docstring"><p>Advanced caustic structure detection with classification</p>
</div>


                            </div>
                            <div id="SymbolGeometry2D.compute_phase_space_volume" class="classattr">
                                        <input id="SymbolGeometry2D.compute_phase_space_volume-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_phase_space_volume</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">E_max</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">x_range</span><span class="p">:</span> <span class="nb">tuple</span>,</span><span class="param">	<span class="n">y_range</span><span class="p">:</span> <span class="nb">tuple</span>,</span><span class="param">	<span class="n">xi_range</span><span class="p">:</span> <span class="nb">tuple</span>,</span><span class="param">	<span class="n">eta_range</span><span class="p">:</span> <span class="nb">tuple</span>,</span><span class="param">	<span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200000</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="SymbolGeometry2D.compute_phase_space_volume-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolGeometry2D.compute_phase_space_volume"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolGeometry2D.compute_phase_space_volume-554"><a href="#SymbolGeometry2D.compute_phase_space_volume-554"><span class="linenos">554</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_phase_space_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">y_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-555"><a href="#SymbolGeometry2D.compute_phase_space_volume-555"><span class="linenos">555</span></a>                                 <span class="n">xi_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> 
</span><span id="SymbolGeometry2D.compute_phase_space_volume-556"><a href="#SymbolGeometry2D.compute_phase_space_volume-556"><span class="linenos">556</span></a>                                 <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-557"><a href="#SymbolGeometry2D.compute_phase_space_volume-557"><span class="linenos">557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Monte Carlo estimation of phase space volume for H ≤ E_max&quot;&quot;&quot;</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-558"><a href="#SymbolGeometry2D.compute_phase_space_volume-558"><span class="linenos">558</span></a>        <span class="c1"># Generate random samples</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-559"><a href="#SymbolGeometry2D.compute_phase_space_volume-559"><span class="linenos">559</span></a>        <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-560"><a href="#SymbolGeometry2D.compute_phase_space_volume-560"><span class="linenos">560</span></a>        <span class="n">y_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-561"><a href="#SymbolGeometry2D.compute_phase_space_volume-561"><span class="linenos">561</span></a>        <span class="n">xi_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-562"><a href="#SymbolGeometry2D.compute_phase_space_volume-562"><span class="linenos">562</span></a>        <span class="n">eta_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eta_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-563"><a href="#SymbolGeometry2D.compute_phase_space_volume-563"><span class="linenos">563</span></a>        <span class="c1"># Evaluate Hamiltonian</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-564"><a href="#SymbolGeometry2D.compute_phase_space_volume-564"><span class="linenos">564</span></a>        <span class="n">H_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x_samples</span><span class="p">,</span> <span class="n">y_samples</span><span class="p">,</span> <span class="n">xi_samples</span><span class="p">,</span> <span class="n">eta_samples</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-565"><a href="#SymbolGeometry2D.compute_phase_space_volume-565"><span class="linenos">565</span></a>        <span class="c1"># Count points where H ≤ E_max</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-566"><a href="#SymbolGeometry2D.compute_phase_space_volume-566"><span class="linenos">566</span></a>        <span class="n">volume_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">H_vals</span> <span class="o">&lt;=</span> <span class="n">E_max</span><span class="p">)</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-567"><a href="#SymbolGeometry2D.compute_phase_space_volume-567"><span class="linenos">567</span></a>        <span class="c1"># Total phase space volume</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-568"><a href="#SymbolGeometry2D.compute_phase_space_volume-568"><span class="linenos">568</span></a>        <span class="n">total_volume</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> 
</span><span id="SymbolGeometry2D.compute_phase_space_volume-569"><a href="#SymbolGeometry2D.compute_phase_space_volume-569"><span class="linenos">569</span></a>                       <span class="p">(</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xi_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">eta_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="SymbolGeometry2D.compute_phase_space_volume-570"><a href="#SymbolGeometry2D.compute_phase_space_volume-570"><span class="linenos">570</span></a>        <span class="k">return</span> <span class="n">volume_ratio</span> <span class="o">*</span> <span class="n">total_volume</span>
</span></pre></div>


            <div class="docstring"><p>Monte Carlo estimation of phase space volume for H ≤ E_max</p>
</div>


                            </div>
                </section>
                <section id="SymbolVisualizer2D">
                            <input id="SymbolVisualizer2D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SymbolVisualizer2D</span>:

                <label class="view-source-button" for="SymbolVisualizer2D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolVisualizer2D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolVisualizer2D-575"><a href="#SymbolVisualizer2D-575"><span class="linenos"> 575</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SymbolVisualizer2D</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-576"><a href="#SymbolVisualizer2D-576"><span class="linenos"> 576</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-577"><a href="#SymbolVisualizer2D-577"><span class="linenos"> 577</span></a><span class="sd">    Complete visualization combining geometric and physical aspects</span>
</span><span id="SymbolVisualizer2D-578"><a href="#SymbolVisualizer2D-578"><span class="linenos"> 578</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-579"><a href="#SymbolVisualizer2D-579"><span class="linenos"> 579</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">SymbolGeometry2D</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-580"><a href="#SymbolVisualizer2D-580"><span class="linenos"> 580</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">geometry</span>
</span><span id="SymbolVisualizer2D-581"><a href="#SymbolVisualizer2D-581"><span class="linenos"> 581</span></a>
</span><span id="SymbolVisualizer2D-582"><a href="#SymbolVisualizer2D-582"><span class="linenos"> 582</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-583"><a href="#SymbolVisualizer2D-583"><span class="linenos"> 583</span></a>                          <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D-584"><a href="#SymbolVisualizer2D-584"><span class="linenos"> 584</span></a>                          <span class="n">y_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D-585"><a href="#SymbolVisualizer2D-585"><span class="linenos"> 585</span></a>                          <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D-586"><a href="#SymbolVisualizer2D-586"><span class="linenos"> 586</span></a>                          <span class="n">eta_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D-587"><a href="#SymbolVisualizer2D-587"><span class="linenos"> 587</span></a>                          <span class="n">geodesics_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D-588"><a href="#SymbolVisualizer2D-588"><span class="linenos"> 588</span></a>                          <span class="n">E_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-589"><a href="#SymbolVisualizer2D-589"><span class="linenos"> 589</span></a>                          <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-590"><a href="#SymbolVisualizer2D-590"><span class="linenos"> 590</span></a>                          <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-591"><a href="#SymbolVisualizer2D-591"><span class="linenos"> 591</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-592"><a href="#SymbolVisualizer2D-592"><span class="linenos"> 592</span></a><span class="sd">        Create a complete 18-panel visualization combining geometry and physics</span>
</span><span id="SymbolVisualizer2D-593"><a href="#SymbolVisualizer2D-593"><span class="linenos"> 593</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolVisualizer2D-594"><a href="#SymbolVisualizer2D-594"><span class="linenos"> 594</span></a><span class="sd">        ----------</span>
</span><span id="SymbolVisualizer2D-595"><a href="#SymbolVisualizer2D-595"><span class="linenos"> 595</span></a><span class="sd">        x_range, y_range : tuple</span>
</span><span id="SymbolVisualizer2D-596"><a href="#SymbolVisualizer2D-596"><span class="linenos"> 596</span></a><span class="sd">            Configuration space domain</span>
</span><span id="SymbolVisualizer2D-597"><a href="#SymbolVisualizer2D-597"><span class="linenos"> 597</span></a><span class="sd">        xi_range, eta_range : tuple</span>
</span><span id="SymbolVisualizer2D-598"><a href="#SymbolVisualizer2D-598"><span class="linenos"> 598</span></a><span class="sd">            Momentum space domain</span>
</span><span id="SymbolVisualizer2D-599"><a href="#SymbolVisualizer2D-599"><span class="linenos"> 599</span></a><span class="sd">        geodesics_params : list</span>
</span><span id="SymbolVisualizer2D-600"><a href="#SymbolVisualizer2D-600"><span class="linenos"> 600</span></a><span class="sd">            Geodesic parameters: (x0, y0, xi0, eta0, t_max, color)</span>
</span><span id="SymbolVisualizer2D-601"><a href="#SymbolVisualizer2D-601"><span class="linenos"> 601</span></a><span class="sd">        E_range : tuple, optional</span>
</span><span id="SymbolVisualizer2D-602"><a href="#SymbolVisualizer2D-602"><span class="linenos"> 602</span></a><span class="sd">            Energy interval for spectral analysis</span>
</span><span id="SymbolVisualizer2D-603"><a href="#SymbolVisualizer2D-603"><span class="linenos"> 603</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolVisualizer2D-604"><a href="#SymbolVisualizer2D-604"><span class="linenos"> 604</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolVisualizer2D-605"><a href="#SymbolVisualizer2D-605"><span class="linenos"> 605</span></a><span class="sd">        resolution : int</span>
</span><span id="SymbolVisualizer2D-606"><a href="#SymbolVisualizer2D-606"><span class="linenos"> 606</span></a><span class="sd">            Grid resolution</span>
</span><span id="SymbolVisualizer2D-607"><a href="#SymbolVisualizer2D-607"><span class="linenos"> 607</span></a><span class="sd">        Returns</span>
</span><span id="SymbolVisualizer2D-608"><a href="#SymbolVisualizer2D-608"><span class="linenos"> 608</span></a><span class="sd">        -------</span>
</span><span id="SymbolVisualizer2D-609"><a href="#SymbolVisualizer2D-609"><span class="linenos"> 609</span></a><span class="sd">        fig, geodesics, periodic_orbits, caustics</span>
</span><span id="SymbolVisualizer2D-610"><a href="#SymbolVisualizer2D-610"><span class="linenos"> 610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-611"><a href="#SymbolVisualizer2D-611"><span class="linenos"> 611</span></a>        <span class="c1"># Compute geodesics with caustic detection</span>
</span><span id="SymbolVisualizer2D-612"><a href="#SymbolVisualizer2D-612"><span class="linenos"> 612</span></a>        <span class="n">geodesics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesics</span><span class="p">(</span><span class="n">geodesics_params</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-613"><a href="#SymbolVisualizer2D-613"><span class="linenos"> 613</span></a>        <span class="c1"># Search for periodic orbits</span>
</span><span id="SymbolVisualizer2D-614"><a href="#SymbolVisualizer2D-614"><span class="linenos"> 614</span></a>        <span class="n">periodic_orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-615"><a href="#SymbolVisualizer2D-615"><span class="linenos"> 615</span></a>        <span class="k">if</span> <span class="n">E_range</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-616"><a href="#SymbolVisualizer2D-616"><span class="linenos"> 616</span></a>            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-617"><a href="#SymbolVisualizer2D-617"><span class="linenos"> 617</span></a>            <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-618"><a href="#SymbolVisualizer2D-618"><span class="linenos"> 618</span></a>                <span class="n">orbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">find_periodic_orbits_2d</span><span class="p">(</span>
</span><span id="SymbolVisualizer2D-619"><a href="#SymbolVisualizer2D-619"><span class="linenos"> 619</span></a>                    <span class="n">E</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">,</span> <span class="n">n_attempts</span><span class="o">=</span><span class="mi">20</span>
</span><span id="SymbolVisualizer2D-620"><a href="#SymbolVisualizer2D-620"><span class="linenos"> 620</span></a>                <span class="p">)</span>
</span><span id="SymbolVisualizer2D-621"><a href="#SymbolVisualizer2D-621"><span class="linenos"> 621</span></a>                <span class="n">periodic_orbits</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-622"><a href="#SymbolVisualizer2D-622"><span class="linenos"> 622</span></a>        <span class="c1"># Detect caustic structures</span>
</span><span id="SymbolVisualizer2D-623"><a href="#SymbolVisualizer2D-623"><span class="linenos"> 623</span></a>        <span class="n">caustics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-624"><a href="#SymbolVisualizer2D-624"><span class="linenos"> 624</span></a>        <span class="k">if</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-625"><a href="#SymbolVisualizer2D-625"><span class="linenos"> 625</span></a>            <span class="n">t_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-626"><a href="#SymbolVisualizer2D-626"><span class="linenos"> 626</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_samples</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-627"><a href="#SymbolVisualizer2D-627"><span class="linenos"> 627</span></a>                <span class="n">caustics</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">detect_caustic_structures</span><span class="p">(</span><span class="n">geodesics</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-628"><a href="#SymbolVisualizer2D-628"><span class="linenos"> 628</span></a>        <span class="c1"># Create full figure</span>
</span><span id="SymbolVisualizer2D-629"><a href="#SymbolVisualizer2D-629"><span class="linenos"> 629</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_complete_figure</span><span class="p">(</span>
</span><span id="SymbolVisualizer2D-630"><a href="#SymbolVisualizer2D-630"><span class="linenos"> 630</span></a>            <span class="n">E_range</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-631"><a href="#SymbolVisualizer2D-631"><span class="linenos"> 631</span></a>            <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">caustics</span><span class="p">,</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">resolution</span>
</span><span id="SymbolVisualizer2D-632"><a href="#SymbolVisualizer2D-632"><span class="linenos"> 632</span></a>        <span class="p">)</span>
</span><span id="SymbolVisualizer2D-633"><a href="#SymbolVisualizer2D-633"><span class="linenos"> 633</span></a>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">caustics</span>
</span><span id="SymbolVisualizer2D-634"><a href="#SymbolVisualizer2D-634"><span class="linenos"> 634</span></a>    
</span><span id="SymbolVisualizer2D-635"><a href="#SymbolVisualizer2D-635"><span class="linenos"> 635</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_geodesics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-636"><a href="#SymbolVisualizer2D-636"><span class="linenos"> 636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute geodesics with caustic detection&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-637"><a href="#SymbolVisualizer2D-637"><span class="linenos"> 637</span></a>        <span class="n">geodesics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-638"><a href="#SymbolVisualizer2D-638"><span class="linenos"> 638</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-639"><a href="#SymbolVisualizer2D-639"><span class="linenos"> 639</span></a>            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-640"><a href="#SymbolVisualizer2D-640"><span class="linenos"> 640</span></a>            <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="n">eta0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-641"><a href="#SymbolVisualizer2D-641"><span class="linenos"> 641</span></a>            <span class="n">geo</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;blue&#39;</span>
</span><span id="SymbolVisualizer2D-642"><a href="#SymbolVisualizer2D-642"><span class="linenos"> 642</span></a>            <span class="n">geodesics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geo</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-643"><a href="#SymbolVisualizer2D-643"><span class="linenos"> 643</span></a>        <span class="k">return</span> <span class="n">geodesics</span>
</span><span id="SymbolVisualizer2D-644"><a href="#SymbolVisualizer2D-644"><span class="linenos"> 644</span></a>
</span><span id="SymbolVisualizer2D-645"><a href="#SymbolVisualizer2D-645"><span class="linenos"> 645</span></a>    
</span><span id="SymbolVisualizer2D-646"><a href="#SymbolVisualizer2D-646"><span class="linenos"> 646</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_complete_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E_range</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-647"><a href="#SymbolVisualizer2D-647"><span class="linenos"> 647</span></a>                               <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">caustics</span><span class="p">,</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-648"><a href="#SymbolVisualizer2D-648"><span class="linenos"> 648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an adaptive multi-panel figure: only relevant panels are displayed.&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-649"><a href="#SymbolVisualizer2D-649"><span class="linenos"> 649</span></a>        
</span><span id="SymbolVisualizer2D-650"><a href="#SymbolVisualizer2D-650"><span class="linenos"> 650</span></a>        <span class="c1"># --- List of panels with explicit call signatures ---</span>
</span><span id="SymbolVisualizer2D-651"><a href="#SymbolVisualizer2D-651"><span class="linenos"> 651</span></a>        <span class="n">panels_to_plot</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-652"><a href="#SymbolVisualizer2D-652"><span class="linenos"> 652</span></a>    
</span><span id="SymbolVisualizer2D-653"><a href="#SymbolVisualizer2D-653"><span class="linenos"> 653</span></a>        <span class="c1"># Always safe to plot if data exists</span>
</span><span id="SymbolVisualizer2D-654"><a href="#SymbolVisualizer2D-654"><span class="linenos"> 654</span></a>        <span class="k">if</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-655"><a href="#SymbolVisualizer2D-655"><span class="linenos"> 655</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_energy_surface_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">resolution</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-656"><a href="#SymbolVisualizer2D-656"><span class="linenos"> 656</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_configuration_space</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">caustics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-657"><a href="#SymbolVisualizer2D-657"><span class="linenos"> 657</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_phase_projection_x</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-658"><a href="#SymbolVisualizer2D-658"><span class="linenos"> 658</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_phase_projection_y</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-659"><a href="#SymbolVisualizer2D-659"><span class="linenos"> 659</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_momentum_space</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-660"><a href="#SymbolVisualizer2D-660"><span class="linenos"> 660</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_vector_field_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">resolution</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-661"><a href="#SymbolVisualizer2D-661"><span class="linenos"> 661</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_group_velocity_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">resolution</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-662"><a href="#SymbolVisualizer2D-662"><span class="linenos"> 662</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_caustic_curves_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">caustics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-663"><a href="#SymbolVisualizer2D-663"><span class="linenos"> 663</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_jacobian_evolution</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-664"><a href="#SymbolVisualizer2D-664"><span class="linenos"> 664</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_energy_conservation_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-665"><a href="#SymbolVisualizer2D-665"><span class="linenos"> 665</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_poincare_x</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-666"><a href="#SymbolVisualizer2D-666"><span class="linenos"> 666</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_poincare_y</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-667"><a href="#SymbolVisualizer2D-667"><span class="linenos"> 667</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_caustic_network</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-668"><a href="#SymbolVisualizer2D-668"><span class="linenos"> 668</span></a>    
</span><span id="SymbolVisualizer2D-669"><a href="#SymbolVisualizer2D-669"><span class="linenos"> 669</span></a>        <span class="k">if</span> <span class="n">geodesics</span> <span class="ow">and</span> <span class="n">caustics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-670"><a href="#SymbolVisualizer2D-670"><span class="linenos"> 670</span></a>            <span class="k">pass</span>  <span class="c1"># already handled above</span>
</span><span id="SymbolVisualizer2D-671"><a href="#SymbolVisualizer2D-671"><span class="linenos"> 671</span></a>    
</span><span id="SymbolVisualizer2D-672"><a href="#SymbolVisualizer2D-672"><span class="linenos"> 672</span></a>        <span class="k">if</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-673"><a href="#SymbolVisualizer2D-673"><span class="linenos"> 673</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_periodic_orbits_3d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-674"><a href="#SymbolVisualizer2D-674"><span class="linenos"> 674</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_action_energy_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-675"><a href="#SymbolVisualizer2D-675"><span class="linenos"> 675</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_torus_quantization</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">hbar</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-676"><a href="#SymbolVisualizer2D-676"><span class="linenos"> 676</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-677"><a href="#SymbolVisualizer2D-677"><span class="linenos"> 677</span></a>                <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_level_spacing_2d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-678"><a href="#SymbolVisualizer2D-678"><span class="linenos"> 678</span></a>    
</span><span id="SymbolVisualizer2D-679"><a href="#SymbolVisualizer2D-679"><span class="linenos"> 679</span></a>        <span class="k">if</span> <span class="n">periodic_orbits</span> <span class="ow">and</span> <span class="n">E_range</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-680"><a href="#SymbolVisualizer2D-680"><span class="linenos"> 680</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_spectral_density_with_caustics</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">E_range</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-681"><a href="#SymbolVisualizer2D-681"><span class="linenos"> 681</span></a>    
</span><span id="SymbolVisualizer2D-682"><a href="#SymbolVisualizer2D-682"><span class="linenos"> 682</span></a>        <span class="c1"># Always plot Maslov (demo)</span>
</span><span id="SymbolVisualizer2D-683"><a href="#SymbolVisualizer2D-683"><span class="linenos"> 683</span></a>        <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_maslov_index_phase_shifts</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">caustics</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-684"><a href="#SymbolVisualizer2D-684"><span class="linenos"> 684</span></a>    
</span><span id="SymbolVisualizer2D-685"><a href="#SymbolVisualizer2D-685"><span class="linenos"> 685</span></a>        <span class="k">if</span> <span class="n">E_range</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-686"><a href="#SymbolVisualizer2D-686"><span class="linenos"> 686</span></a>            <span class="n">panels_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax_spec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_phase_space_volume</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_spec</span><span class="p">,</span> <span class="n">E_range</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-687"><a href="#SymbolVisualizer2D-687"><span class="linenos"> 687</span></a>    
</span><span id="SymbolVisualizer2D-688"><a href="#SymbolVisualizer2D-688"><span class="linenos"> 688</span></a>        <span class="c1"># --- Handle empty case ---</span>
</span><span id="SymbolVisualizer2D-689"><a href="#SymbolVisualizer2D-689"><span class="linenos"> 689</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">panels_to_plot</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-690"><a href="#SymbolVisualizer2D-690"><span class="linenos"> 690</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-691"><a href="#SymbolVisualizer2D-691"><span class="linenos"> 691</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;No panels to display for this Hamiltonian.&quot;</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-692"><a href="#SymbolVisualizer2D-692"><span class="linenos"> 692</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-693"><a href="#SymbolVisualizer2D-693"><span class="linenos"> 693</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</span><span id="SymbolVisualizer2D-694"><a href="#SymbolVisualizer2D-694"><span class="linenos"> 694</span></a>            <span class="k">return</span> <span class="n">fig</span>
</span><span id="SymbolVisualizer2D-695"><a href="#SymbolVisualizer2D-695"><span class="linenos"> 695</span></a>    
</span><span id="SymbolVisualizer2D-696"><a href="#SymbolVisualizer2D-696"><span class="linenos"> 696</span></a>        <span class="c1"># --- Dynamic layout ---</span>
</span><span id="SymbolVisualizer2D-697"><a href="#SymbolVisualizer2D-697"><span class="linenos"> 697</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">panels_to_plot</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-698"><a href="#SymbolVisualizer2D-698"><span class="linenos"> 698</span></a>        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-699"><a href="#SymbolVisualizer2D-699"><span class="linenos"> 699</span></a>            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="SymbolVisualizer2D-700"><a href="#SymbolVisualizer2D-700"><span class="linenos"> 700</span></a>        <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-701"><a href="#SymbolVisualizer2D-701"><span class="linenos"> 701</span></a>            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span>
</span><span id="SymbolVisualizer2D-702"><a href="#SymbolVisualizer2D-702"><span class="linenos"> 702</span></a>        <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-703"><a href="#SymbolVisualizer2D-703"><span class="linenos"> 703</span></a>            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span>
</span><span id="SymbolVisualizer2D-704"><a href="#SymbolVisualizer2D-704"><span class="linenos"> 704</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-705"><a href="#SymbolVisualizer2D-705"><span class="linenos"> 705</span></a>            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="mi">5</span>
</span><span id="SymbolVisualizer2D-706"><a href="#SymbolVisualizer2D-706"><span class="linenos"> 706</span></a>    
</span><span id="SymbolVisualizer2D-707"><a href="#SymbolVisualizer2D-707"><span class="linenos"> 707</span></a>        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.8</span> <span class="o">*</span> <span class="n">cols</span><span class="p">,</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">rows</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-708"><a href="#SymbolVisualizer2D-708"><span class="linenos"> 708</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-709"><a href="#SymbolVisualizer2D-709"><span class="linenos"> 709</span></a>        <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-710"><a href="#SymbolVisualizer2D-710"><span class="linenos"> 710</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Geometric and Semiclassical Atlas: H = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">H_sym</span><span class="si">}</span><span class="s1"> (ℏ=</span><span class="si">{</span><span class="n">hbar</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-711"><a href="#SymbolVisualizer2D-711"><span class="linenos"> 711</span></a>                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-712"><a href="#SymbolVisualizer2D-712"><span class="linenos"> 712</span></a>    
</span><span id="SymbolVisualizer2D-713"><a href="#SymbolVisualizer2D-713"><span class="linenos"> 713</span></a>        <span class="c1"># --- Plot all panels ---</span>
</span><span id="SymbolVisualizer2D-714"><a href="#SymbolVisualizer2D-714"><span class="linenos"> 714</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plot_cmd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">panels_to_plot</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-715"><a href="#SymbolVisualizer2D-715"><span class="linenos"> 715</span></a>            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-716"><a href="#SymbolVisualizer2D-716"><span class="linenos"> 716</span></a>                <span class="k">break</span>
</span><span id="SymbolVisualizer2D-717"><a href="#SymbolVisualizer2D-717"><span class="linenos"> 717</span></a>            <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="n">cols</span>
</span><span id="SymbolVisualizer2D-718"><a href="#SymbolVisualizer2D-718"><span class="linenos"> 718</span></a>            <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">cols</span>
</span><span id="SymbolVisualizer2D-719"><a href="#SymbolVisualizer2D-719"><span class="linenos"> 719</span></a>            <span class="n">subplot_spec</span> <span class="o">=</span> <span class="n">gs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-720"><a href="#SymbolVisualizer2D-720"><span class="linenos"> 720</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-721"><a href="#SymbolVisualizer2D-721"><span class="linenos"> 721</span></a>                <span class="n">plot_cmd</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-722"><a href="#SymbolVisualizer2D-722"><span class="linenos"> 722</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-723"><a href="#SymbolVisualizer2D-723"><span class="linenos"> 723</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-724"><a href="#SymbolVisualizer2D-724"><span class="linenos"> 724</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[Error]</span><span class="se">\n</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-725"><a href="#SymbolVisualizer2D-725"><span class="linenos"> 725</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</span><span id="SymbolVisualizer2D-726"><a href="#SymbolVisualizer2D-726"><span class="linenos"> 726</span></a>    
</span><span id="SymbolVisualizer2D-727"><a href="#SymbolVisualizer2D-727"><span class="linenos"> 727</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-728"><a href="#SymbolVisualizer2D-728"><span class="linenos"> 728</span></a>        <span class="k">return</span> <span class="n">fig</span>
</span><span id="SymbolVisualizer2D-729"><a href="#SymbolVisualizer2D-729"><span class="linenos"> 729</span></a>
</span><span id="SymbolVisualizer2D-730"><a href="#SymbolVisualizer2D-730"><span class="linenos"> 730</span></a>    <span class="c1"># ======== DETAILED VISUALIZATION METHODS ========</span>
</span><span id="SymbolVisualizer2D-731"><a href="#SymbolVisualizer2D-731"><span class="linenos"> 731</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_energy_surface_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-732"><a href="#SymbolVisualizer2D-732"><span class="linenos"> 732</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy surface H(x,y) at fixed (ξ,η)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-733"><a href="#SymbolVisualizer2D-733"><span class="linenos"> 733</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-734"><a href="#SymbolVisualizer2D-734"><span class="linenos"> 734</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-735"><a href="#SymbolVisualizer2D-735"><span class="linenos"> 735</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-736"><a href="#SymbolVisualizer2D-736"><span class="linenos"> 736</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-737"><a href="#SymbolVisualizer2D-737"><span class="linenos"> 737</span></a>        <span class="c1"># Evaluate at reference momentum</span>
</span><span id="SymbolVisualizer2D-738"><a href="#SymbolVisualizer2D-738"><span class="linenos"> 738</span></a>        <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
</span><span id="SymbolVisualizer2D-739"><a href="#SymbolVisualizer2D-739"><span class="linenos"> 739</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-740"><a href="#SymbolVisualizer2D-740"><span class="linenos"> 740</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="SymbolVisualizer2D-741"><a href="#SymbolVisualizer2D-741"><span class="linenos"> 741</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="SymbolVisualizer2D-742"><a href="#SymbolVisualizer2D-742"><span class="linenos"> 742</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-743"><a href="#SymbolVisualizer2D-743"><span class="linenos"> 743</span></a>                    <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-744"><a href="#SymbolVisualizer2D-744"><span class="linenos"> 744</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-745"><a href="#SymbolVisualizer2D-745"><span class="linenos"> 745</span></a>                    <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="SymbolVisualizer2D-746"><a href="#SymbolVisualizer2D-746"><span class="linenos"> 746</span></a>        <span class="c1"># Surface with transparency to see geodesics</span>
</span><span id="SymbolVisualizer2D-747"><a href="#SymbolVisualizer2D-747"><span class="linenos"> 747</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-748"><a href="#SymbolVisualizer2D-748"><span class="linenos"> 748</span></a>        <span class="c1"># Geodesics on the surface</span>
</span><span id="SymbolVisualizer2D-749"><a href="#SymbolVisualizer2D-749"><span class="linenos"> 749</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
</span><span id="SymbolVisualizer2D-750"><a href="#SymbolVisualizer2D-750"><span class="linenos"> 750</span></a>            <span class="n">H_geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-751"><a href="#SymbolVisualizer2D-751"><span class="linenos"> 751</span></a>                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">))])</span>
</span><span id="SymbolVisualizer2D-752"><a href="#SymbolVisualizer2D-752"><span class="linenos"> 752</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-753"><a href="#SymbolVisualizer2D-753"><span class="linenos"> 753</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">H_geo</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-754"><a href="#SymbolVisualizer2D-754"><span class="linenos"> 754</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-755"><a href="#SymbolVisualizer2D-755"><span class="linenos"> 755</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-756"><a href="#SymbolVisualizer2D-756"><span class="linenos"> 756</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-757"><a href="#SymbolVisualizer2D-757"><span class="linenos"> 757</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Energy Surface</span><span class="se">\n</span><span class="s1">H(x,y,ξ₀,η₀)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-758"><a href="#SymbolVisualizer2D-758"><span class="linenos"> 758</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">azim</span><span class="o">=-</span><span class="mi">45</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-759"><a href="#SymbolVisualizer2D-759"><span class="linenos"> 759</span></a>    
</span><span id="SymbolVisualizer2D-760"><a href="#SymbolVisualizer2D-760"><span class="linenos"> 760</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_configuration_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">caustics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-761"><a href="#SymbolVisualizer2D-761"><span class="linenos"> 761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configuration space (x,y) with trajectories and caustics&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-762"><a href="#SymbolVisualizer2D-762"><span class="linenos"> 762</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-763"><a href="#SymbolVisualizer2D-763"><span class="linenos"> 763</span></a>        
</span><span id="SymbolVisualizer2D-764"><a href="#SymbolVisualizer2D-764"><span class="linenos"> 764</span></a>        <span class="c1"># Trajectories - use thinner lines and lighter colors for better visibility</span>
</span><span id="SymbolVisualizer2D-765"><a href="#SymbolVisualizer2D-765"><span class="linenos"> 765</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-766"><a href="#SymbolVisualizer2D-766"><span class="linenos"> 766</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-767"><a href="#SymbolVisualizer2D-767"><span class="linenos"> 767</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-768"><a href="#SymbolVisualizer2D-768"><span class="linenos"> 768</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-769"><a href="#SymbolVisualizer2D-769"><span class="linenos"> 769</span></a>                      <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-770"><a href="#SymbolVisualizer2D-770"><span class="linenos"> 770</span></a>        
</span><span id="SymbolVisualizer2D-771"><a href="#SymbolVisualizer2D-771"><span class="linenos"> 771</span></a>        <span class="c1"># Caustic points on trajectories - keep as stars but reduce size slightly</span>
</span><span id="SymbolVisualizer2D-772"><a href="#SymbolVisualizer2D-772"><span class="linenos"> 772</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-773"><a href="#SymbolVisualizer2D-773"><span class="linenos"> 773</span></a>            <span class="n">caust_x</span><span class="p">,</span> <span class="n">caust_y</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustic_points</span>
</span><span id="SymbolVisualizer2D-774"><a href="#SymbolVisualizer2D-774"><span class="linenos"> 774</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caust_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-775"><a href="#SymbolVisualizer2D-775"><span class="linenos"> 775</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">caust_x</span><span class="p">,</span> <span class="n">caust_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>  <span class="c1"># Reduced from 120</span>
</span><span id="SymbolVisualizer2D-776"><a href="#SymbolVisualizer2D-776"><span class="linenos"> 776</span></a>                          <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-777"><a href="#SymbolVisualizer2D-777"><span class="linenos"> 777</span></a>                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Caustic points&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-778"><a href="#SymbolVisualizer2D-778"><span class="linenos"> 778</span></a>        
</span><span id="SymbolVisualizer2D-779"><a href="#SymbolVisualizer2D-779"><span class="linenos"> 779</span></a>        <span class="c1"># Caustic structures - use smaller, more subtle markers</span>
</span><span id="SymbolVisualizer2D-780"><a href="#SymbolVisualizer2D-780"><span class="linenos"> 780</span></a>        <span class="k">for</span> <span class="n">caust</span> <span class="ow">in</span> <span class="n">caustics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-781"><a href="#SymbolVisualizer2D-781"><span class="linenos"> 781</span></a>            <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;cusp&#39;</span><span class="p">:</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;swallowtail&#39;</span><span class="p">:</span> <span class="s1">&#39;orange&#39;</span><span class="p">}</span>
</span><span id="SymbolVisualizer2D-782"><a href="#SymbolVisualizer2D-782"><span class="linenos"> 782</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">color_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">caust</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-783"><a href="#SymbolVisualizer2D-783"><span class="linenos"> 783</span></a>            <span class="c1"># Use a small circle or dot instead of a large X</span>
</span><span id="SymbolVisualizer2D-784"><a href="#SymbolVisualizer2D-784"><span class="linenos"> 784</span></a>            <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>  <span class="c1"># You can also try &#39;.&#39; for even smaller dots</span>
</span><span id="SymbolVisualizer2D-785"><a href="#SymbolVisualizer2D-785"><span class="linenos"> 785</span></a>            <span class="c1"># Reduce size significantly and increase transparency</span>
</span><span id="SymbolVisualizer2D-786"><a href="#SymbolVisualizer2D-786"><span class="linenos"> 786</span></a>            <span class="n">size</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Fixed size for clarity, or use: max(15, min(50, 80 * caust.strength / 2))</span>
</span><span id="SymbolVisualizer2D-787"><a href="#SymbolVisualizer2D-787"><span class="linenos"> 787</span></a>            <span class="n">alpha_val</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># More transparent to avoid obscuring trajectories</span>
</span><span id="SymbolVisualizer2D-788"><a href="#SymbolVisualizer2D-788"><span class="linenos"> 788</span></a>            
</span><span id="SymbolVisualizer2D-789"><a href="#SymbolVisualizer2D-789"><span class="linenos"> 789</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">caust</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">caust</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-790"><a href="#SymbolVisualizer2D-790"><span class="linenos"> 790</span></a>                      <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>  <span class="c1"># Remove edge for cleaner look</span>
</span><span id="SymbolVisualizer2D-791"><a href="#SymbolVisualizer2D-791"><span class="linenos"> 791</span></a>                      <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>  <span class="c1"># zorder between traj and points</span>
</span><span id="SymbolVisualizer2D-792"><a href="#SymbolVisualizer2D-792"><span class="linenos"> 792</span></a>                      <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Caustic </span><span class="si">{</span><span class="n">caust</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1"> (μ=</span><span class="si">{</span><span class="n">caust</span><span class="o">.</span><span class="n">maslov_index</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-793"><a href="#SymbolVisualizer2D-793"><span class="linenos"> 793</span></a>        
</span><span id="SymbolVisualizer2D-794"><a href="#SymbolVisualizer2D-794"><span class="linenos"> 794</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-795"><a href="#SymbolVisualizer2D-795"><span class="linenos"> 795</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-796"><a href="#SymbolVisualizer2D-796"><span class="linenos"> 796</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Configuration Space</span><span class="se">\n</span><span class="s1">★ = caustics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-797"><a href="#SymbolVisualizer2D-797"><span class="linenos"> 797</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-798"><a href="#SymbolVisualizer2D-798"><span class="linenos"> 798</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-799"><a href="#SymbolVisualizer2D-799"><span class="linenos"> 799</span></a>        
</span><span id="SymbolVisualizer2D-800"><a href="#SymbolVisualizer2D-800"><span class="linenos"> 800</span></a>        <span class="c1"># Legend without duplicates</span>
</span><span id="SymbolVisualizer2D-801"><a href="#SymbolVisualizer2D-801"><span class="linenos"> 801</span></a>        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
</span><span id="SymbolVisualizer2D-802"><a href="#SymbolVisualizer2D-802"><span class="linenos"> 802</span></a>        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-803"><a href="#SymbolVisualizer2D-803"><span class="linenos"> 803</span></a>        <span class="k">if</span> <span class="n">by_label</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-804"><a href="#SymbolVisualizer2D-804"><span class="linenos"> 804</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-805"><a href="#SymbolVisualizer2D-805"><span class="linenos"> 805</span></a>    
</span><span id="SymbolVisualizer2D-806"><a href="#SymbolVisualizer2D-806"><span class="linenos"> 806</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_jacobian_evolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-807"><a href="#SymbolVisualizer2D-807"><span class="linenos"> 807</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evolution of Jacobian determinant with caustic detection&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-808"><a href="#SymbolVisualizer2D-808"><span class="linenos"> 808</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-809"><a href="#SymbolVisualizer2D-809"><span class="linenos"> 809</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-810"><a href="#SymbolVisualizer2D-810"><span class="linenos"> 810</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-811"><a href="#SymbolVisualizer2D-811"><span class="linenos"> 811</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">det_caustic</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-812"><a href="#SymbolVisualizer2D-812"><span class="linenos"> 812</span></a>                   <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;E=</span><span class="si">{</span><span class="n">geo</span><span class="o">.</span><span class="n">energy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-813"><a href="#SymbolVisualizer2D-813"><span class="linenos"> 813</span></a>            <span class="c1"># Mark caustic points</span>
</span><span id="SymbolVisualizer2D-814"><a href="#SymbolVisualizer2D-814"><span class="linenos"> 814</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustic_indices</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-815"><a href="#SymbolVisualizer2D-815"><span class="linenos"> 815</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">geo</span><span class="o">.</span><span class="n">det_caustic</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-816"><a href="#SymbolVisualizer2D-816"><span class="linenos"> 816</span></a>                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-817"><a href="#SymbolVisualizer2D-817"><span class="linenos"> 817</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-818"><a href="#SymbolVisualizer2D-818"><span class="linenos"> 818</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-819"><a href="#SymbolVisualizer2D-819"><span class="linenos"> 819</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;det(∂(x,y)/∂(ξ₀,η₀))&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-820"><a href="#SymbolVisualizer2D-820"><span class="linenos"> 820</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Jacobian Determinant</span><span class="se">\n</span><span class="s1">Zeros = caustics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-821"><a href="#SymbolVisualizer2D-821"><span class="linenos"> 821</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-822"><a href="#SymbolVisualizer2D-822"><span class="linenos"> 822</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-823"><a href="#SymbolVisualizer2D-823"><span class="linenos"> 823</span></a>    
</span><span id="SymbolVisualizer2D-824"><a href="#SymbolVisualizer2D-824"><span class="linenos"> 824</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_maslov_index_phase_shifts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">caustics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-825"><a href="#SymbolVisualizer2D-825"><span class="linenos"> 825</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualization of phase shifts due to Maslov index&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-826"><a href="#SymbolVisualizer2D-826"><span class="linenos"> 826</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-827"><a href="#SymbolVisualizer2D-827"><span class="linenos"> 827</span></a>        <span class="c1"># Simulate wavefunction crossing caustics</span>
</span><span id="SymbolVisualizer2D-828"><a href="#SymbolVisualizer2D-828"><span class="linenos"> 828</span></a>        <span class="n">x_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-829"><a href="#SymbolVisualizer2D-829"><span class="linenos"> 829</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Wavenumber</span>
</span><span id="SymbolVisualizer2D-830"><a href="#SymbolVisualizer2D-830"><span class="linenos"> 830</span></a>        <span class="c1"># Free wavefunction (before caustic)</span>
</span><span id="SymbolVisualizer2D-831"><a href="#SymbolVisualizer2D-831"><span class="linenos"> 831</span></a>        <span class="n">psi_free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x_demo</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-832"><a href="#SymbolVisualizer2D-832"><span class="linenos"> 832</span></a>        <span class="c1"># Simulate phase shifts at caustics</span>
</span><span id="SymbolVisualizer2D-833"><a href="#SymbolVisualizer2D-833"><span class="linenos"> 833</span></a>        <span class="n">caustic_positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>  <span class="c1"># Caustic positions</span>
</span><span id="SymbolVisualizer2D-834"><a href="#SymbolVisualizer2D-834"><span class="linenos"> 834</span></a>        <span class="n">maslov_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Maslov index for each caustic</span>
</span><span id="SymbolVisualizer2D-835"><a href="#SymbolVisualizer2D-835"><span class="linenos"> 835</span></a>        <span class="n">psi_with_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">psi_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-836"><a href="#SymbolVisualizer2D-836"><span class="linenos"> 836</span></a>        <span class="n">current_phase</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SymbolVisualizer2D-837"><a href="#SymbolVisualizer2D-837"><span class="linenos"> 837</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_demo</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-838"><a href="#SymbolVisualizer2D-838"><span class="linenos"> 838</span></a>            <span class="c1"># Check if crossing a caustic</span>
</span><span id="SymbolVisualizer2D-839"><a href="#SymbolVisualizer2D-839"><span class="linenos"> 839</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">caust_x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">caustic_positions</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-840"><a href="#SymbolVisualizer2D-840"><span class="linenos"> 840</span></a>                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">caust_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-841"><a href="#SymbolVisualizer2D-841"><span class="linenos"> 841</span></a>                    <span class="n">current_phase</span> <span class="o">-=</span> <span class="n">maslov_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="SymbolVisualizer2D-842"><a href="#SymbolVisualizer2D-842"><span class="linenos"> 842</span></a>            <span class="n">psi_with_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">current_phase</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-843"><a href="#SymbolVisualizer2D-843"><span class="linenos"> 843</span></a>        <span class="c1"># Plot real parts</span>
</span><span id="SymbolVisualizer2D-844"><a href="#SymbolVisualizer2D-844"><span class="linenos"> 844</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">psi_free</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-845"><a href="#SymbolVisualizer2D-845"><span class="linenos"> 845</span></a>                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Re[ψ] before caustics&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-846"><a href="#SymbolVisualizer2D-846"><span class="linenos"> 846</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_demo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">psi_with_shifts</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-847"><a href="#SymbolVisualizer2D-847"><span class="linenos"> 847</span></a>                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Re[ψ] after caustics&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-848"><a href="#SymbolVisualizer2D-848"><span class="linenos"> 848</span></a>        <span class="c1"># Mark caustic positions</span>
</span><span id="SymbolVisualizer2D-849"><a href="#SymbolVisualizer2D-849"><span class="linenos"> 849</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">caust_x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">caustic_positions</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-850"><a href="#SymbolVisualizer2D-850"><span class="linenos"> 850</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">caust_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-851"><a href="#SymbolVisualizer2D-851"><span class="linenos"> 851</span></a>                      <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Caustic μ=</span><span class="si">{</span><span class="n">maslov_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-852"><a href="#SymbolVisualizer2D-852"><span class="linenos"> 852</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Position x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-853"><a href="#SymbolVisualizer2D-853"><span class="linenos"> 853</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Re[ψ(x)]&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-854"><a href="#SymbolVisualizer2D-854"><span class="linenos"> 854</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Maslov Index</span><span class="se">\n</span><span class="s1">Phase shifts at caustics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-855"><a href="#SymbolVisualizer2D-855"><span class="linenos"> 855</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-856"><a href="#SymbolVisualizer2D-856"><span class="linenos"> 856</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-857"><a href="#SymbolVisualizer2D-857"><span class="linenos"> 857</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-858"><a href="#SymbolVisualizer2D-858"><span class="linenos"> 858</span></a>    
</span><span id="SymbolVisualizer2D-859"><a href="#SymbolVisualizer2D-859"><span class="linenos"> 859</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_spectral_density_with_caustics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">E_range</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-860"><a href="#SymbolVisualizer2D-860"><span class="linenos"> 860</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spectral density with caustic corrections&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-861"><a href="#SymbolVisualizer2D-861"><span class="linenos"> 861</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-862"><a href="#SymbolVisualizer2D-862"><span class="linenos"> 862</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-863"><a href="#SymbolVisualizer2D-863"><span class="linenos"> 863</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No periodic orbits&#39;</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-864"><a href="#SymbolVisualizer2D-864"><span class="linenos"> 864</span></a>                   <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-865"><a href="#SymbolVisualizer2D-865"><span class="linenos"> 865</span></a>            <span class="k">return</span>
</span><span id="SymbolVisualizer2D-866"><a href="#SymbolVisualizer2D-866"><span class="linenos"> 866</span></a>        <span class="c1"># Sort orbits by energy</span>
</span><span id="SymbolVisualizer2D-867"><a href="#SymbolVisualizer2D-867"><span class="linenos"> 867</span></a>        <span class="n">orbits_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-868"><a href="#SymbolVisualizer2D-868"><span class="linenos"> 868</span></a>        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_sorted</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-869"><a href="#SymbolVisualizer2D-869"><span class="linenos"> 869</span></a>        <span class="n">periods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_sorted</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-870"><a href="#SymbolVisualizer2D-870"><span class="linenos"> 870</span></a>        <span class="c1"># Compute state density ρ(E) = T(E)/(2π) for integrable systems</span>
</span><span id="SymbolVisualizer2D-871"><a href="#SymbolVisualizer2D-871"><span class="linenos"> 871</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-872"><a href="#SymbolVisualizer2D-872"><span class="linenos"> 872</span></a>            <span class="n">dE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-873"><a href="#SymbolVisualizer2D-873"><span class="linenos"> 873</span></a>            <span class="n">dT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">periods</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-874"><a href="#SymbolVisualizer2D-874"><span class="linenos"> 874</span></a>            <span class="n">rho_E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-875"><a href="#SymbolVisualizer2D-875"><span class="linenos"> 875</span></a>            <span class="n">rho_E</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">periods</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">periods</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-876"><a href="#SymbolVisualizer2D-876"><span class="linenos"> 876</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rho_E</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-877"><a href="#SymbolVisualizer2D-877"><span class="linenos"> 877</span></a>                <span class="n">rho_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">periods</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">periods</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-878"><a href="#SymbolVisualizer2D-878"><span class="linenos"> 878</span></a>                <span class="n">rho_E</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">periods</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">periods</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-879"><a href="#SymbolVisualizer2D-879"><span class="linenos"> 879</span></a>            <span class="n">rho_E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rho_E</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Avoid negative values</span>
</span><span id="SymbolVisualizer2D-880"><a href="#SymbolVisualizer2D-880"><span class="linenos"> 880</span></a>            <span class="c1"># Caustic correction (oscillatory terms)</span>
</span><span id="SymbolVisualizer2D-881"><a href="#SymbolVisualizer2D-881"><span class="linenos"> 881</span></a>            <span class="n">rho_osc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rho_E</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-882"><a href="#SymbolVisualizer2D-882"><span class="linenos"> 882</span></a>            <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_sorted</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-883"><a href="#SymbolVisualizer2D-883"><span class="linenos"> 883</span></a>                <span class="c1"># Amplitude depending on Maslov index</span>
</span><span id="SymbolVisualizer2D-884"><a href="#SymbolVisualizer2D-884"><span class="linenos"> 884</span></a>                <span class="n">amp</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">orb</span><span class="o">.</span><span class="n">maslov_index</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">orb</span><span class="o">.</span><span class="n">period</span>
</span><span id="SymbolVisualizer2D-885"><a href="#SymbolVisualizer2D-885"><span class="linenos"> 885</span></a>                <span class="n">phase</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">hbar</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">orb</span><span class="o">.</span><span class="n">maslov_index</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="SymbolVisualizer2D-886"><a href="#SymbolVisualizer2D-886"><span class="linenos"> 886</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energies</span> <span class="o">-</span> <span class="n">orb</span><span class="o">.</span><span class="n">energy</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-887"><a href="#SymbolVisualizer2D-887"><span class="linenos"> 887</span></a>                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rho_osc</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-888"><a href="#SymbolVisualizer2D-888"><span class="linenos"> 888</span></a>                    <span class="n">rho_osc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-889"><a href="#SymbolVisualizer2D-889"><span class="linenos"> 889</span></a>            <span class="c1"># Smooth curve</span>
</span><span id="SymbolVisualizer2D-890"><a href="#SymbolVisualizer2D-890"><span class="linenos"> 890</span></a>            <span class="n">E_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">500</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-891"><a href="#SymbolVisualizer2D-891"><span class="linenos"> 891</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
</span><span id="SymbolVisualizer2D-892"><a href="#SymbolVisualizer2D-892"><span class="linenos"> 892</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-893"><a href="#SymbolVisualizer2D-893"><span class="linenos"> 893</span></a>                <span class="n">interp_rho</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">rho_E</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-894"><a href="#SymbolVisualizer2D-894"><span class="linenos"> 894</span></a>                <span class="n">interp_osc</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">rho_osc</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-895"><a href="#SymbolVisualizer2D-895"><span class="linenos"> 895</span></a>                <span class="n">rho_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">interp_rho</span><span class="p">(</span><span class="n">E_fine</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-896"><a href="#SymbolVisualizer2D-896"><span class="linenos"> 896</span></a>                <span class="n">rho_osc_smooth</span> <span class="o">=</span> <span class="n">interp_osc</span><span class="p">(</span><span class="n">E_fine</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-897"><a href="#SymbolVisualizer2D-897"><span class="linenos"> 897</span></a>                <span class="c1"># Plot components</span>
</span><span id="SymbolVisualizer2D-898"><a href="#SymbolVisualizer2D-898"><span class="linenos"> 898</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">rho_smooth</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-899"><a href="#SymbolVisualizer2D-899"><span class="linenos"> 899</span></a>                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Smooth (Weyl)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-900"><a href="#SymbolVisualizer2D-900"><span class="linenos"> 900</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">rho_smooth</span> <span class="o">+</span> <span class="n">rho_osc_smooth</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-901"><a href="#SymbolVisualizer2D-901"><span class="linenos"> 901</span></a>                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total with caustics&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-902"><a href="#SymbolVisualizer2D-902"><span class="linenos"> 902</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">rho_smooth</span><span class="p">,</span> <span class="n">rho_smooth</span> <span class="o">+</span> <span class="n">rho_osc_smooth</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-903"><a href="#SymbolVisualizer2D-903"><span class="linenos"> 903</span></a>                               <span class="n">where</span><span class="o">=</span><span class="n">rho_osc_smooth</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff9999&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-904"><a href="#SymbolVisualizer2D-904"><span class="linenos"> 904</span></a>                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Caustic corrections&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-905"><a href="#SymbolVisualizer2D-905"><span class="linenos"> 905</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-906"><a href="#SymbolVisualizer2D-906"><span class="linenos"> 906</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">rho_E</span><span class="p">,</span> <span class="s1">&#39;b-o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;State density ρ(E)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-907"><a href="#SymbolVisualizer2D-907"><span class="linenos"> 907</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-908"><a href="#SymbolVisualizer2D-908"><span class="linenos"> 908</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ρ(E)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-909"><a href="#SymbolVisualizer2D-909"><span class="linenos"> 909</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spectral Density</span><span class="se">\n</span><span class="s1">with caustic corrections&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-910"><a href="#SymbolVisualizer2D-910"><span class="linenos"> 910</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-911"><a href="#SymbolVisualizer2D-911"><span class="linenos"> 911</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-912"><a href="#SymbolVisualizer2D-912"><span class="linenos"> 912</span></a>    
</span><span id="SymbolVisualizer2D-913"><a href="#SymbolVisualizer2D-913"><span class="linenos"> 913</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_phase_space_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">E_range</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-914"><a href="#SymbolVisualizer2D-914"><span class="linenos"> 914</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Phase space volume via Monte Carlo&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-915"><a href="#SymbolVisualizer2D-915"><span class="linenos"> 915</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-916"><a href="#SymbolVisualizer2D-916"><span class="linenos"> 916</span></a>        <span class="c1"># Compute volume for different energies</span>
</span><span id="SymbolVisualizer2D-917"><a href="#SymbolVisualizer2D-917"><span class="linenos"> 917</span></a>        <span class="n">E_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-918"><a href="#SymbolVisualizer2D-918"><span class="linenos"> 918</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-919"><a href="#SymbolVisualizer2D-919"><span class="linenos"> 919</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing phase space volume (Monte Carlo)...&quot;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-920"><a href="#SymbolVisualizer2D-920"><span class="linenos"> 920</span></a>        <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="n">E_vals</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-921"><a href="#SymbolVisualizer2D-921"><span class="linenos"> 921</span></a>            <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">compute_phase_space_volume</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-922"><a href="#SymbolVisualizer2D-922"><span class="linenos"> 922</span></a>            <span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-923"><a href="#SymbolVisualizer2D-923"><span class="linenos"> 923</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  E=</span><span class="si">{</span><span class="n">E</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Volume=</span><span class="si">{</span><span class="n">vol</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-924"><a href="#SymbolVisualizer2D-924"><span class="linenos"> 924</span></a>        <span class="c1"># Weyl law: N(E) ~ Vol/(2πℏ)²</span>
</span><span id="SymbolVisualizer2D-925"><a href="#SymbolVisualizer2D-925"><span class="linenos"> 925</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Dimension</span>
</span><span id="SymbolVisualizer2D-926"><a href="#SymbolVisualizer2D-926"><span class="linenos"> 926</span></a>        <span class="n">weyl_constant</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">hbar</span><span class="p">)</span> <span class="o">**</span> <span class="n">d</span>
</span><span id="SymbolVisualizer2D-927"><a href="#SymbolVisualizer2D-927"><span class="linenos"> 927</span></a>        <span class="n">N_weyl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="o">/</span> <span class="n">weyl_constant</span>
</span><span id="SymbolVisualizer2D-928"><a href="#SymbolVisualizer2D-928"><span class="linenos"> 928</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_vals</span><span class="p">,</span> <span class="n">N_weyl</span><span class="p">,</span> <span class="s1">&#39;b-o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-929"><a href="#SymbolVisualizer2D-929"><span class="linenos"> 929</span></a>                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Weyl law: N(E) ~ Vol/(2πℏ)²&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-930"><a href="#SymbolVisualizer2D-930"><span class="linenos"> 930</span></a>        <span class="c1"># Conceptual caustic correction</span>
</span><span id="SymbolVisualizer2D-931"><a href="#SymbolVisualizer2D-931"><span class="linenos"> 931</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-932"><a href="#SymbolVisualizer2D-932"><span class="linenos"> 932</span></a>            <span class="n">oscillation_freq</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-933"><a href="#SymbolVisualizer2D-933"><span class="linenos"> 933</span></a>            <span class="n">correction</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">N_weyl</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">oscillation_freq</span> <span class="o">*</span> <span class="p">(</span><span class="n">E_vals</span> <span class="o">-</span> <span class="n">E_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-934"><a href="#SymbolVisualizer2D-934"><span class="linenos"> 934</span></a>            <span class="n">N_corrected</span> <span class="o">=</span> <span class="n">N_weyl</span> <span class="o">+</span> <span class="n">correction</span>
</span><span id="SymbolVisualizer2D-935"><a href="#SymbolVisualizer2D-935"><span class="linenos"> 935</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter1d</span>
</span><span id="SymbolVisualizer2D-936"><a href="#SymbolVisualizer2D-936"><span class="linenos"> 936</span></a>            <span class="n">N_corrected_smooth</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">N_corrected</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-937"><a href="#SymbolVisualizer2D-937"><span class="linenos"> 937</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_vals</span><span class="p">,</span> <span class="n">N_corrected_smooth</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-938"><a href="#SymbolVisualizer2D-938"><span class="linenos"> 938</span></a>                   <span class="n">label</span><span class="o">=</span><span class="s2">&quot;With caustic corrections&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-939"><a href="#SymbolVisualizer2D-939"><span class="linenos"> 939</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-940"><a href="#SymbolVisualizer2D-940"><span class="linenos"> 940</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;N(E) (Number of states)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-941"><a href="#SymbolVisualizer2D-941"><span class="linenos"> 941</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Phase Space Volume</span><span class="se">\n</span><span class="s1">(Monte Carlo)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-942"><a href="#SymbolVisualizer2D-942"><span class="linenos"> 942</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-943"><a href="#SymbolVisualizer2D-943"><span class="linenos"> 943</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-944"><a href="#SymbolVisualizer2D-944"><span class="linenos"> 944</span></a>    
</span><span id="SymbolVisualizer2D-945"><a href="#SymbolVisualizer2D-945"><span class="linenos"> 945</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_caustic_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-946"><a href="#SymbolVisualizer2D-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Caustic network with multiple initial conditions&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-947"><a href="#SymbolVisualizer2D-947"><span class="linenos"> 947</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-948"><a href="#SymbolVisualizer2D-948"><span class="linenos"> 948</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-949"><a href="#SymbolVisualizer2D-949"><span class="linenos"> 949</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No geodesics&#39;</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-950"><a href="#SymbolVisualizer2D-950"><span class="linenos"> 950</span></a>                   <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-951"><a href="#SymbolVisualizer2D-951"><span class="linenos"> 951</span></a>            <span class="k">return</span>
</span><span id="SymbolVisualizer2D-952"><a href="#SymbolVisualizer2D-952"><span class="linenos"> 952</span></a>        <span class="c1"># Use first geodesic as reference</span>
</span><span id="SymbolVisualizer2D-953"><a href="#SymbolVisualizer2D-953"><span class="linenos"> 953</span></a>        <span class="n">E_ref</span> <span class="o">=</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span>
</span><span id="SymbolVisualizer2D-954"><a href="#SymbolVisualizer2D-954"><span class="linenos"> 954</span></a>        <span class="n">t_max</span> <span class="o">=</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-955"><a href="#SymbolVisualizer2D-955"><span class="linenos"> 955</span></a>        <span class="c1"># Generate trajectory family</span>
</span><span id="SymbolVisualizer2D-956"><a href="#SymbolVisualizer2D-956"><span class="linenos"> 956</span></a>        <span class="n">n_family</span> <span class="o">=</span> <span class="mi">15</span>
</span><span id="SymbolVisualizer2D-957"><a href="#SymbolVisualizer2D-957"><span class="linenos"> 957</span></a>        <span class="n">x0_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_family</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-958"><a href="#SymbolVisualizer2D-958"><span class="linenos"> 958</span></a>        <span class="n">caustic_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-959"><a href="#SymbolVisualizer2D-959"><span class="linenos"> 959</span></a>        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">x0_vals</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-960"><a href="#SymbolVisualizer2D-960"><span class="linenos"> 960</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-961"><a href="#SymbolVisualizer2D-961"><span class="linenos"> 961</span></a>                <span class="c1"># Solve for y0, xi0, eta0 keeping energy constant</span>
</span><span id="SymbolVisualizer2D-962"><a href="#SymbolVisualizer2D-962"><span class="linenos"> 962</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">energy_eq</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-963"><a href="#SymbolVisualizer2D-963"><span class="linenos"> 963</span></a>                    <span class="n">y_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">,</span> <span class="n">eta_val</span> <span class="o">=</span> <span class="nb">vars</span>
</span><span id="SymbolVisualizer2D-964"><a href="#SymbolVisualizer2D-964"><span class="linenos"> 964</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">H_num</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">xi_val</span><span class="p">,</span> <span class="n">eta_val</span><span class="p">)</span> <span class="o">-</span> <span class="n">E_ref</span>
</span><span id="SymbolVisualizer2D-965"><a href="#SymbolVisualizer2D-965"><span class="linenos"> 965</span></a>                <span class="c1"># Use initial values of first geodesic as guess</span>
</span><span id="SymbolVisualizer2D-966"><a href="#SymbolVisualizer2D-966"><span class="linenos"> 966</span></a>                <span class="n">y0_guess</span> <span class="o">=</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-967"><a href="#SymbolVisualizer2D-967"><span class="linenos"> 967</span></a>                <span class="n">xi0_guess</span> <span class="o">=</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-968"><a href="#SymbolVisualizer2D-968"><span class="linenos"> 968</span></a>                <span class="n">eta0_guess</span> <span class="o">=</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-969"><a href="#SymbolVisualizer2D-969"><span class="linenos"> 969</span></a>                <span class="n">sol</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">energy_eq</span><span class="p">,</span> <span class="p">[</span><span class="n">y0_guess</span><span class="p">,</span> <span class="n">xi0_guess</span><span class="p">,</span> <span class="n">eta0_guess</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-970"><a href="#SymbolVisualizer2D-970"><span class="linenos"> 970</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sol</span><span class="p">)):</span>
</span><span id="SymbolVisualizer2D-971"><a href="#SymbolVisualizer2D-971"><span class="linenos"> 971</span></a>                    <span class="n">y0_new</span><span class="p">,</span> <span class="n">xi0_new</span><span class="p">,</span> <span class="n">eta0_new</span> <span class="o">=</span> <span class="n">sol</span>
</span><span id="SymbolVisualizer2D-972"><a href="#SymbolVisualizer2D-972"><span class="linenos"> 972</span></a>                    <span class="c1"># Compute trajectory</span>
</span><span id="SymbolVisualizer2D-973"><a href="#SymbolVisualizer2D-973"><span class="linenos"> 973</span></a>                    <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">compute_geodesic</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">xi0_new</span><span class="p">,</span> <span class="n">eta0_new</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-974"><a href="#SymbolVisualizer2D-974"><span class="linenos"> 974</span></a>                    <span class="c1"># Plot trajectory</span>
</span><span id="SymbolVisualizer2D-975"><a href="#SymbolVisualizer2D-975"><span class="linenos"> 975</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-976"><a href="#SymbolVisualizer2D-976"><span class="linenos"> 976</span></a>                    <span class="c1"># Collect caustic points</span>
</span><span id="SymbolVisualizer2D-977"><a href="#SymbolVisualizer2D-977"><span class="linenos"> 977</span></a>                    <span class="n">caust_x</span><span class="p">,</span> <span class="n">caust_y</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustic_points</span>
</span><span id="SymbolVisualizer2D-978"><a href="#SymbolVisualizer2D-978"><span class="linenos"> 978</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">caust_x</span><span class="p">)):</span>
</span><span id="SymbolVisualizer2D-979"><a href="#SymbolVisualizer2D-979"><span class="linenos"> 979</span></a>                        <span class="n">caustic_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">caust_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">caust_y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="SymbolVisualizer2D-980"><a href="#SymbolVisualizer2D-980"><span class="linenos"> 980</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-981"><a href="#SymbolVisualizer2D-981"><span class="linenos"> 981</span></a>                <span class="k">continue</span>
</span><span id="SymbolVisualizer2D-982"><a href="#SymbolVisualizer2D-982"><span class="linenos"> 982</span></a>        <span class="c1"># Plot caustic points</span>
</span><span id="SymbolVisualizer2D-983"><a href="#SymbolVisualizer2D-983"><span class="linenos"> 983</span></a>        <span class="k">if</span> <span class="n">caustic_points</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-984"><a href="#SymbolVisualizer2D-984"><span class="linenos"> 984</span></a>            <span class="n">caustic_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">caustic_points</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-985"><a href="#SymbolVisualizer2D-985"><span class="linenos"> 985</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">caustic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">caustic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> 
</span><span id="SymbolVisualizer2D-986"><a href="#SymbolVisualizer2D-986"><span class="linenos"> 986</span></a>                      <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-987"><a href="#SymbolVisualizer2D-987"><span class="linenos"> 987</span></a>                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Caustic points&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-988"><a href="#SymbolVisualizer2D-988"><span class="linenos"> 988</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-989"><a href="#SymbolVisualizer2D-989"><span class="linenos"> 989</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-990"><a href="#SymbolVisualizer2D-990"><span class="linenos"> 990</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Caustic Network</span><span class="se">\n</span><span class="s1">(Multiple initial conditions)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-991"><a href="#SymbolVisualizer2D-991"><span class="linenos"> 991</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-992"><a href="#SymbolVisualizer2D-992"><span class="linenos"> 992</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-993"><a href="#SymbolVisualizer2D-993"><span class="linenos"> 993</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-994"><a href="#SymbolVisualizer2D-994"><span class="linenos"> 994</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-995"><a href="#SymbolVisualizer2D-995"><span class="linenos"> 995</span></a>    
</span><span id="SymbolVisualizer2D-996"><a href="#SymbolVisualizer2D-996"><span class="linenos"> 996</span></a>    <span class="c1"># ======== STANDARD VISUALIZATION METHODS (similar to v1) ========</span>
</span><span id="SymbolVisualizer2D-997"><a href="#SymbolVisualizer2D-997"><span class="linenos"> 997</span></a>    <span class="c1"># Following methods are similar to v1 but enhanced</span>
</span><span id="SymbolVisualizer2D-998"><a href="#SymbolVisualizer2D-998"><span class="linenos"> 998</span></a>    <span class="c1"># to integrate caustics and new data structures</span>
</span><span id="SymbolVisualizer2D-999"><a href="#SymbolVisualizer2D-999"><span class="linenos"> 999</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_phase_projection_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1000"><a href="#SymbolVisualizer2D-1000"><span class="linenos">1000</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Phase space projection (x,ξ)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1001"><a href="#SymbolVisualizer2D-1001"><span class="linenos">1001</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1002"><a href="#SymbolVisualizer2D-1002"><span class="linenos">1002</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1003"><a href="#SymbolVisualizer2D-1003"><span class="linenos">1003</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1004"><a href="#SymbolVisualizer2D-1004"><span class="linenos">1004</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1005"><a href="#SymbolVisualizer2D-1005"><span class="linenos">1005</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1006"><a href="#SymbolVisualizer2D-1006"><span class="linenos">1006</span></a>                      <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1007"><a href="#SymbolVisualizer2D-1007"><span class="linenos">1007</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1008"><a href="#SymbolVisualizer2D-1008"><span class="linenos">1008</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1009"><a href="#SymbolVisualizer2D-1009"><span class="linenos">1009</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Phase Space (x,ξ)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1010"><a href="#SymbolVisualizer2D-1010"><span class="linenos">1010</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1011"><a href="#SymbolVisualizer2D-1011"><span class="linenos">1011</span></a>    
</span><span id="SymbolVisualizer2D-1012"><a href="#SymbolVisualizer2D-1012"><span class="linenos">1012</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_phase_projection_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1013"><a href="#SymbolVisualizer2D-1013"><span class="linenos">1013</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Phase space projection (y,η)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1014"><a href="#SymbolVisualizer2D-1014"><span class="linenos">1014</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1015"><a href="#SymbolVisualizer2D-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1016"><a href="#SymbolVisualizer2D-1016"><span class="linenos">1016</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1017"><a href="#SymbolVisualizer2D-1017"><span class="linenos">1017</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1018"><a href="#SymbolVisualizer2D-1018"><span class="linenos">1018</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1019"><a href="#SymbolVisualizer2D-1019"><span class="linenos">1019</span></a>                      <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1020"><a href="#SymbolVisualizer2D-1020"><span class="linenos">1020</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1021"><a href="#SymbolVisualizer2D-1021"><span class="linenos">1021</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1022"><a href="#SymbolVisualizer2D-1022"><span class="linenos">1022</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Phase Space (y,η)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1023"><a href="#SymbolVisualizer2D-1023"><span class="linenos">1023</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1024"><a href="#SymbolVisualizer2D-1024"><span class="linenos">1024</span></a>    
</span><span id="SymbolVisualizer2D-1025"><a href="#SymbolVisualizer2D-1025"><span class="linenos">1025</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_momentum_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1026"><a href="#SymbolVisualizer2D-1026"><span class="linenos">1026</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Momentum space (ξ,η)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1027"><a href="#SymbolVisualizer2D-1027"><span class="linenos">1027</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1028"><a href="#SymbolVisualizer2D-1028"><span class="linenos">1028</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1029"><a href="#SymbolVisualizer2D-1029"><span class="linenos">1029</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1030"><a href="#SymbolVisualizer2D-1030"><span class="linenos">1030</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1031"><a href="#SymbolVisualizer2D-1031"><span class="linenos">1031</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1032"><a href="#SymbolVisualizer2D-1032"><span class="linenos">1032</span></a>                      <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1033"><a href="#SymbolVisualizer2D-1033"><span class="linenos">1033</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1034"><a href="#SymbolVisualizer2D-1034"><span class="linenos">1034</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1035"><a href="#SymbolVisualizer2D-1035"><span class="linenos">1035</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Momentum Space</span><span class="se">\n</span><span class="s1">(ξ,η)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1036"><a href="#SymbolVisualizer2D-1036"><span class="linenos">1036</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1037"><a href="#SymbolVisualizer2D-1037"><span class="linenos">1037</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1038"><a href="#SymbolVisualizer2D-1038"><span class="linenos">1038</span></a>    
</span><span id="SymbolVisualizer2D-1039"><a href="#SymbolVisualizer2D-1039"><span class="linenos">1039</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_vector_field_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1040"><a href="#SymbolVisualizer2D-1040"><span class="linenos">1040</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vector field in configuration space&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1041"><a href="#SymbolVisualizer2D-1041"><span class="linenos">1041</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1042"><a href="#SymbolVisualizer2D-1042"><span class="linenos">1042</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1043"><a href="#SymbolVisualizer2D-1043"><span class="linenos">1043</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1044"><a href="#SymbolVisualizer2D-1044"><span class="linenos">1044</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1045"><a href="#SymbolVisualizer2D-1045"><span class="linenos">1045</span></a>        <span class="c1"># Evaluate vector field at reference momentum</span>
</span><span id="SymbolVisualizer2D-1046"><a href="#SymbolVisualizer2D-1046"><span class="linenos">1046</span></a>        <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
</span><span id="SymbolVisualizer2D-1047"><a href="#SymbolVisualizer2D-1047"><span class="linenos">1047</span></a>        <span class="n">VX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1048"><a href="#SymbolVisualizer2D-1048"><span class="linenos">1048</span></a>        <span class="n">VY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1049"><a href="#SymbolVisualizer2D-1049"><span class="linenos">1049</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="SymbolVisualizer2D-1050"><a href="#SymbolVisualizer2D-1050"><span class="linenos">1050</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="SymbolVisualizer2D-1051"><a href="#SymbolVisualizer2D-1051"><span class="linenos">1051</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1052"><a href="#SymbolVisualizer2D-1052"><span class="linenos">1052</span></a>                    <span class="n">VX</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">dH_dxi_num</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1053"><a href="#SymbolVisualizer2D-1053"><span class="linenos">1053</span></a>                    <span class="n">VY</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">dH_deta_num</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1054"><a href="#SymbolVisualizer2D-1054"><span class="linenos">1054</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1055"><a href="#SymbolVisualizer2D-1055"><span class="linenos">1055</span></a>                    <span class="n">VX</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">VY</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="SymbolVisualizer2D-1056"><a href="#SymbolVisualizer2D-1056"><span class="linenos">1056</span></a>        <span class="c1"># Magnitude for coloring</span>
</span><span id="SymbolVisualizer2D-1057"><a href="#SymbolVisualizer2D-1057"><span class="linenos">1057</span></a>        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VX</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">VY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1058"><a href="#SymbolVisualizer2D-1058"><span class="linenos">1058</span></a>        <span class="n">magnitude</span><span class="p">[</span><span class="n">magnitude</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SymbolVisualizer2D-1059"><a href="#SymbolVisualizer2D-1059"><span class="linenos">1059</span></a>        <span class="c1"># Normalized vector field</span>
</span><span id="SymbolVisualizer2D-1060"><a href="#SymbolVisualizer2D-1060"><span class="linenos">1060</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">VX</span><span class="o">/</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">VY</span><span class="o">/</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">magnitude</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-1061"><a href="#SymbolVisualizer2D-1061"><span class="linenos">1061</span></a>                 <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1062"><a href="#SymbolVisualizer2D-1062"><span class="linenos">1062</span></a>        <span class="c1"># Overlay geodesics</span>
</span><span id="SymbolVisualizer2D-1063"><a href="#SymbolVisualizer2D-1063"><span class="linenos">1063</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
</span><span id="SymbolVisualizer2D-1064"><a href="#SymbolVisualizer2D-1064"><span class="linenos">1064</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1065"><a href="#SymbolVisualizer2D-1065"><span class="linenos">1065</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1066"><a href="#SymbolVisualizer2D-1066"><span class="linenos">1066</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1067"><a href="#SymbolVisualizer2D-1067"><span class="linenos">1067</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1068"><a href="#SymbolVisualizer2D-1068"><span class="linenos">1068</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Vector Field</span><span class="se">\n</span><span class="s1">Flow in configuration space&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1069"><a href="#SymbolVisualizer2D-1069"><span class="linenos">1069</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1070"><a href="#SymbolVisualizer2D-1070"><span class="linenos">1070</span></a>    
</span><span id="SymbolVisualizer2D-1071"><a href="#SymbolVisualizer2D-1071"><span class="linenos">1071</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_group_velocity_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1072"><a href="#SymbolVisualizer2D-1072"><span class="linenos">1072</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Group velocity magnitude |∇_p H|&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1073"><a href="#SymbolVisualizer2D-1073"><span class="linenos">1073</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1074"><a href="#SymbolVisualizer2D-1074"><span class="linenos">1074</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1075"><a href="#SymbolVisualizer2D-1075"><span class="linenos">1075</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1076"><a href="#SymbolVisualizer2D-1076"><span class="linenos">1076</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1077"><a href="#SymbolVisualizer2D-1077"><span class="linenos">1077</span></a>        <span class="c1"># Group velocity at reference momentum</span>
</span><span id="SymbolVisualizer2D-1078"><a href="#SymbolVisualizer2D-1078"><span class="linenos">1078</span></a>        <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
</span><span id="SymbolVisualizer2D-1079"><a href="#SymbolVisualizer2D-1079"><span class="linenos">1079</span></a>        <span class="n">V_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1080"><a href="#SymbolVisualizer2D-1080"><span class="linenos">1080</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="SymbolVisualizer2D-1081"><a href="#SymbolVisualizer2D-1081"><span class="linenos">1081</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="SymbolVisualizer2D-1082"><a href="#SymbolVisualizer2D-1082"><span class="linenos">1082</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1083"><a href="#SymbolVisualizer2D-1083"><span class="linenos">1083</span></a>                    <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">dH_dxi_num</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1084"><a href="#SymbolVisualizer2D-1084"><span class="linenos">1084</span></a>                    <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">dH_deta_num</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">xi_ref</span><span class="p">,</span> <span class="n">eta_ref</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1085"><a href="#SymbolVisualizer2D-1085"><span class="linenos">1085</span></a>                    <span class="n">V_mag</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1086"><a href="#SymbolVisualizer2D-1086"><span class="linenos">1086</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1087"><a href="#SymbolVisualizer2D-1087"><span class="linenos">1087</span></a>                    <span class="n">V_mag</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="SymbolVisualizer2D-1088"><a href="#SymbolVisualizer2D-1088"><span class="linenos">1088</span></a>        <span class="c1"># Heatmap</span>
</span><span id="SymbolVisualizer2D-1089"><a href="#SymbolVisualizer2D-1089"><span class="linenos">1089</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V_mag</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1090"><a href="#SymbolVisualizer2D-1090"><span class="linenos">1090</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;|v_g|&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1091"><a href="#SymbolVisualizer2D-1091"><span class="linenos">1091</span></a>        <span class="c1"># Geodesics</span>
</span><span id="SymbolVisualizer2D-1092"><a href="#SymbolVisualizer2D-1092"><span class="linenos">1092</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
</span><span id="SymbolVisualizer2D-1093"><a href="#SymbolVisualizer2D-1093"><span class="linenos">1093</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1094"><a href="#SymbolVisualizer2D-1094"><span class="linenos">1094</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1095"><a href="#SymbolVisualizer2D-1095"><span class="linenos">1095</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1096"><a href="#SymbolVisualizer2D-1096"><span class="linenos">1096</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Group Velocity</span><span class="se">\n</span><span class="s1">|∇_p H|&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1097"><a href="#SymbolVisualizer2D-1097"><span class="linenos">1097</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1098"><a href="#SymbolVisualizer2D-1098"><span class="linenos">1098</span></a>    
</span><span id="SymbolVisualizer2D-1099"><a href="#SymbolVisualizer2D-1099"><span class="linenos">1099</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_caustic_curves_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">caustics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1100"><a href="#SymbolVisualizer2D-1100"><span class="linenos">1100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Caustic curves in (x,y) space&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1101"><a href="#SymbolVisualizer2D-1101"><span class="linenos">1101</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1102"><a href="#SymbolVisualizer2D-1102"><span class="linenos">1102</span></a>        <span class="c1"># All geodesics</span>
</span><span id="SymbolVisualizer2D-1103"><a href="#SymbolVisualizer2D-1103"><span class="linenos">1103</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1104"><a href="#SymbolVisualizer2D-1104"><span class="linenos">1104</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1105"><a href="#SymbolVisualizer2D-1105"><span class="linenos">1105</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1106"><a href="#SymbolVisualizer2D-1106"><span class="linenos">1106</span></a>            <span class="c1"># Caustic points on each geodesic</span>
</span><span id="SymbolVisualizer2D-1107"><a href="#SymbolVisualizer2D-1107"><span class="linenos">1107</span></a>            <span class="n">caust_x</span><span class="p">,</span> <span class="n">caust_y</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">caustic_points</span>
</span><span id="SymbolVisualizer2D-1108"><a href="#SymbolVisualizer2D-1108"><span class="linenos">1108</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caust_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1109"><a href="#SymbolVisualizer2D-1109"><span class="linenos">1109</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">caust_x</span><span class="p">,</span> <span class="n">caust_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-1110"><a href="#SymbolVisualizer2D-1110"><span class="linenos">1110</span></a>                          <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1111"><a href="#SymbolVisualizer2D-1111"><span class="linenos">1111</span></a>        <span class="c1"># Complete caustic structures</span>
</span><span id="SymbolVisualizer2D-1112"><a href="#SymbolVisualizer2D-1112"><span class="linenos">1112</span></a>        <span class="k">for</span> <span class="n">caust</span> <span class="ow">in</span> <span class="n">caustics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1113"><a href="#SymbolVisualizer2D-1113"><span class="linenos">1113</span></a>            <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;cusp&#39;</span><span class="p">:</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;swallowtail&#39;</span><span class="p">:</span> <span class="s1">&#39;orange&#39;</span><span class="p">}</span>
</span><span id="SymbolVisualizer2D-1114"><a href="#SymbolVisualizer2D-1114"><span class="linenos">1114</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">color_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">caust</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1115"><a href="#SymbolVisualizer2D-1115"><span class="linenos">1115</span></a>            <span class="c1"># If enough points, plot smoothed curve</span>
</span><span id="SymbolVisualizer2D-1116"><a href="#SymbolVisualizer2D-1116"><span class="linenos">1116</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caust</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1117"><a href="#SymbolVisualizer2D-1117"><span class="linenos">1117</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">caust</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">caust</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-1118"><a href="#SymbolVisualizer2D-1118"><span class="linenos">1118</span></a>                       <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Caustic </span><span class="si">{</span><span class="n">caust</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1"> (μ=</span><span class="si">{</span><span class="n">caust</span><span class="o">.</span><span class="n">maslov_index</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1119"><a href="#SymbolVisualizer2D-1119"><span class="linenos">1119</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1120"><a href="#SymbolVisualizer2D-1120"><span class="linenos">1120</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">caust</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">caust</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1121"><a href="#SymbolVisualizer2D-1121"><span class="linenos">1121</span></a>                          <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1122"><a href="#SymbolVisualizer2D-1122"><span class="linenos">1122</span></a>                          <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Caustic </span><span class="si">{</span><span class="n">caust</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1123"><a href="#SymbolVisualizer2D-1123"><span class="linenos">1123</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1124"><a href="#SymbolVisualizer2D-1124"><span class="linenos">1124</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1125"><a href="#SymbolVisualizer2D-1125"><span class="linenos">1125</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Caustic Curves</span><span class="se">\n</span><span class="s1">★ = points on geodesics&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1126"><a href="#SymbolVisualizer2D-1126"><span class="linenos">1126</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1127"><a href="#SymbolVisualizer2D-1127"><span class="linenos">1127</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1128"><a href="#SymbolVisualizer2D-1128"><span class="linenos">1128</span></a>        <span class="c1"># Legend without duplicates</span>
</span><span id="SymbolVisualizer2D-1129"><a href="#SymbolVisualizer2D-1129"><span class="linenos">1129</span></a>        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
</span><span id="SymbolVisualizer2D-1130"><a href="#SymbolVisualizer2D-1130"><span class="linenos">1130</span></a>        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-1131"><a href="#SymbolVisualizer2D-1131"><span class="linenos">1131</span></a>        <span class="k">if</span> <span class="n">by_label</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1132"><a href="#SymbolVisualizer2D-1132"><span class="linenos">1132</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1133"><a href="#SymbolVisualizer2D-1133"><span class="linenos">1133</span></a>    
</span><span id="SymbolVisualizer2D-1134"><a href="#SymbolVisualizer2D-1134"><span class="linenos">1134</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_energy_conservation_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1135"><a href="#SymbolVisualizer2D-1135"><span class="linenos">1135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy conservation verification&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1136"><a href="#SymbolVisualizer2D-1136"><span class="linenos">1136</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1137"><a href="#SymbolVisualizer2D-1137"><span class="linenos">1137</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1138"><a href="#SymbolVisualizer2D-1138"><span class="linenos">1138</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1139"><a href="#SymbolVisualizer2D-1139"><span class="linenos">1139</span></a>            <span class="n">H_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1140"><a href="#SymbolVisualizer2D-1140"><span class="linenos">1140</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">H_var</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1141"><a href="#SymbolVisualizer2D-1141"><span class="linenos">1141</span></a>                       <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;E=</span><span class="si">{</span><span class="n">geo</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1142"><a href="#SymbolVisualizer2D-1142"><span class="linenos">1142</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1143"><a href="#SymbolVisualizer2D-1143"><span class="linenos">1143</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|ΔH/H₀|&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1144"><a href="#SymbolVisualizer2D-1144"><span class="linenos">1144</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Energy Conservation</span><span class="se">\n</span><span class="s1">Numerical quality&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1145"><a href="#SymbolVisualizer2D-1145"><span class="linenos">1145</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1146"><a href="#SymbolVisualizer2D-1146"><span class="linenos">1146</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1147"><a href="#SymbolVisualizer2D-1147"><span class="linenos">1147</span></a>    
</span><span id="SymbolVisualizer2D-1148"><a href="#SymbolVisualizer2D-1148"><span class="linenos">1148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_poincare_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1149"><a href="#SymbolVisualizer2D-1149"><span class="linenos">1149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Poincaré section (x,ξ) at y=0&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1150"><a href="#SymbolVisualizer2D-1150"><span class="linenos">1150</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1151"><a href="#SymbolVisualizer2D-1151"><span class="linenos">1151</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1152"><a href="#SymbolVisualizer2D-1152"><span class="linenos">1152</span></a>            <span class="c1"># Find y=0 crossings</span>
</span><span id="SymbolVisualizer2D-1153"><a href="#SymbolVisualizer2D-1153"><span class="linenos">1153</span></a>            <span class="n">crossings_x</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-1154"><a href="#SymbolVisualizer2D-1154"><span class="linenos">1154</span></a>            <span class="n">crossings_xi</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-1155"><a href="#SymbolVisualizer2D-1155"><span class="linenos">1155</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1156"><a href="#SymbolVisualizer2D-1156"><span class="linenos">1156</span></a>                <span class="k">if</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Sign change</span>
</span><span id="SymbolVisualizer2D-1157"><a href="#SymbolVisualizer2D-1157"><span class="linenos">1157</span></a>                    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-1158"><a href="#SymbolVisualizer2D-1158"><span class="linenos">1158</span></a>                    <span class="n">x_cross</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-1159"><a href="#SymbolVisualizer2D-1159"><span class="linenos">1159</span></a>                    <span class="n">xi_cross</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-1160"><a href="#SymbolVisualizer2D-1160"><span class="linenos">1160</span></a>                    <span class="n">crossings_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_cross</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1161"><a href="#SymbolVisualizer2D-1161"><span class="linenos">1161</span></a>                    <span class="n">crossings_xi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi_cross</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1162"><a href="#SymbolVisualizer2D-1162"><span class="linenos">1162</span></a>            <span class="k">if</span> <span class="n">crossings_x</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1163"><a href="#SymbolVisualizer2D-1163"><span class="linenos">1163</span></a>                <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1164"><a href="#SymbolVisualizer2D-1164"><span class="linenos">1164</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">crossings_x</span><span class="p">,</span> <span class="n">crossings_xi</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1165"><a href="#SymbolVisualizer2D-1165"><span class="linenos">1165</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1166"><a href="#SymbolVisualizer2D-1166"><span class="linenos">1166</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ξ&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1167"><a href="#SymbolVisualizer2D-1167"><span class="linenos">1167</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poincaré Section</span><span class="se">\n</span><span class="s1">(x,ξ) at y=0&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1168"><a href="#SymbolVisualizer2D-1168"><span class="linenos">1168</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1169"><a href="#SymbolVisualizer2D-1169"><span class="linenos">1169</span></a>    
</span><span id="SymbolVisualizer2D-1170"><a href="#SymbolVisualizer2D-1170"><span class="linenos">1170</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_poincare_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1171"><a href="#SymbolVisualizer2D-1171"><span class="linenos">1171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Poincaré section (y,η) at x=0&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1172"><a href="#SymbolVisualizer2D-1172"><span class="linenos">1172</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1173"><a href="#SymbolVisualizer2D-1173"><span class="linenos">1173</span></a>        <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1174"><a href="#SymbolVisualizer2D-1174"><span class="linenos">1174</span></a>            <span class="c1"># Find x=0 crossings</span>
</span><span id="SymbolVisualizer2D-1175"><a href="#SymbolVisualizer2D-1175"><span class="linenos">1175</span></a>            <span class="n">crossings_y</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-1176"><a href="#SymbolVisualizer2D-1176"><span class="linenos">1176</span></a>            <span class="n">crossings_eta</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D-1177"><a href="#SymbolVisualizer2D-1177"><span class="linenos">1177</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1178"><a href="#SymbolVisualizer2D-1178"><span class="linenos">1178</span></a>                <span class="k">if</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1179"><a href="#SymbolVisualizer2D-1179"><span class="linenos">1179</span></a>                    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-1180"><a href="#SymbolVisualizer2D-1180"><span class="linenos">1180</span></a>                    <span class="n">y_cross</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-1181"><a href="#SymbolVisualizer2D-1181"><span class="linenos">1181</span></a>                    <span class="n">eta_cross</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="SymbolVisualizer2D-1182"><a href="#SymbolVisualizer2D-1182"><span class="linenos">1182</span></a>                    <span class="n">crossings_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_cross</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1183"><a href="#SymbolVisualizer2D-1183"><span class="linenos">1183</span></a>                    <span class="n">crossings_eta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eta_cross</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1184"><a href="#SymbolVisualizer2D-1184"><span class="linenos">1184</span></a>            <span class="k">if</span> <span class="n">crossings_y</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1185"><a href="#SymbolVisualizer2D-1185"><span class="linenos">1185</span></a>                <span class="n">color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1186"><a href="#SymbolVisualizer2D-1186"><span class="linenos">1186</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">crossings_y</span><span class="p">,</span> <span class="n">crossings_eta</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1187"><a href="#SymbolVisualizer2D-1187"><span class="linenos">1187</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1188"><a href="#SymbolVisualizer2D-1188"><span class="linenos">1188</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;η&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1189"><a href="#SymbolVisualizer2D-1189"><span class="linenos">1189</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poincaré Section</span><span class="se">\n</span><span class="s1">(y,η) at x=0&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1190"><a href="#SymbolVisualizer2D-1190"><span class="linenos">1190</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1191"><a href="#SymbolVisualizer2D-1191"><span class="linenos">1191</span></a>    
</span><span id="SymbolVisualizer2D-1192"><a href="#SymbolVisualizer2D-1192"><span class="linenos">1192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_periodic_orbits_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1193"><a href="#SymbolVisualizer2D-1193"><span class="linenos">1193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Periodic orbits in 3D (x,y,t)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1194"><a href="#SymbolVisualizer2D-1194"><span class="linenos">1194</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1195"><a href="#SymbolVisualizer2D-1195"><span class="linenos">1195</span></a>        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">))))</span>
</span><span id="SymbolVisualizer2D-1196"><a href="#SymbolVisualizer2D-1196"><span class="linenos">1196</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">orb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>  <span class="c1"># Limit for clarity</span>
</span><span id="SymbolVisualizer2D-1197"><a href="#SymbolVisualizer2D-1197"><span class="linenos">1197</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">x_cycle</span><span class="p">,</span> <span class="n">orb</span><span class="o">.</span><span class="n">y_cycle</span><span class="p">,</span> <span class="n">orb</span><span class="o">.</span><span class="n">t_cycle</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1198"><a href="#SymbolVisualizer2D-1198"><span class="linenos">1198</span></a>                   <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1199"><a href="#SymbolVisualizer2D-1199"><span class="linenos">1199</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">x0</span><span class="p">],</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">y0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D-1200"><a href="#SymbolVisualizer2D-1200"><span class="linenos">1200</span></a>                      <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1201"><a href="#SymbolVisualizer2D-1201"><span class="linenos">1201</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1202"><a href="#SymbolVisualizer2D-1202"><span class="linenos">1202</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1203"><a href="#SymbolVisualizer2D-1203"><span class="linenos">1203</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1204"><a href="#SymbolVisualizer2D-1204"><span class="linenos">1204</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Periodic Orbits</span><span class="se">\n</span><span class="s1">Space-time view&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1205"><a href="#SymbolVisualizer2D-1205"><span class="linenos">1205</span></a>    
</span><span id="SymbolVisualizer2D-1206"><a href="#SymbolVisualizer2D-1206"><span class="linenos">1206</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_action_energy_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1207"><a href="#SymbolVisualizer2D-1207"><span class="linenos">1207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Action vs Energy&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1208"><a href="#SymbolVisualizer2D-1208"><span class="linenos">1208</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1209"><a href="#SymbolVisualizer2D-1209"><span class="linenos">1209</span></a>        <span class="n">E_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-1210"><a href="#SymbolVisualizer2D-1210"><span class="linenos">1210</span></a>        <span class="n">S_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-1211"><a href="#SymbolVisualizer2D-1211"><span class="linenos">1211</span></a>        <span class="n">T_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-1212"><a href="#SymbolVisualizer2D-1212"><span class="linenos">1212</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_orb</span><span class="p">,</span> <span class="n">S_orb</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">T_orb</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1213"><a href="#SymbolVisualizer2D-1213"><span class="linenos">1213</span></a>                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1214"><a href="#SymbolVisualizer2D-1214"><span class="linenos">1214</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Period T&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1215"><a href="#SymbolVisualizer2D-1215"><span class="linenos">1215</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1216"><a href="#SymbolVisualizer2D-1216"><span class="linenos">1216</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Action S&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1217"><a href="#SymbolVisualizer2D-1217"><span class="linenos">1217</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Action-Energy</span><span class="se">\n</span><span class="s1">S(E)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1218"><a href="#SymbolVisualizer2D-1218"><span class="linenos">1218</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1219"><a href="#SymbolVisualizer2D-1219"><span class="linenos">1219</span></a>    
</span><span id="SymbolVisualizer2D-1220"><a href="#SymbolVisualizer2D-1220"><span class="linenos">1220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_torus_quantization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">hbar</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1221"><a href="#SymbolVisualizer2D-1221"><span class="linenos">1221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Torus quantization (KAM theory)&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1222"><a href="#SymbolVisualizer2D-1222"><span class="linenos">1222</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1223"><a href="#SymbolVisualizer2D-1223"><span class="linenos">1223</span></a>        <span class="n">E_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-1224"><a href="#SymbolVisualizer2D-1224"><span class="linenos">1224</span></a>        <span class="n">S_orb</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">]</span>
</span><span id="SymbolVisualizer2D-1225"><a href="#SymbolVisualizer2D-1225"><span class="linenos">1225</span></a>        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_orb</span><span class="p">,</span> <span class="n">S_orb</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1226"><a href="#SymbolVisualizer2D-1226"><span class="linenos">1226</span></a>                           <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Orbits&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1227"><a href="#SymbolVisualizer2D-1227"><span class="linenos">1227</span></a>        <span class="c1"># EBK quantization for 2D: S_i = 2πℏ(n_i + α_i)</span>
</span><span id="SymbolVisualizer2D-1228"><a href="#SymbolVisualizer2D-1228"><span class="linenos">1228</span></a>        <span class="c1"># Simplified for one dimension</span>
</span><span id="SymbolVisualizer2D-1229"><a href="#SymbolVisualizer2D-1229"><span class="linenos">1229</span></a>        <span class="n">E_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">E_orb</span><span class="p">)</span> <span class="k">if</span> <span class="n">E_orb</span> <span class="k">else</span> <span class="mi">10</span>
</span><span id="SymbolVisualizer2D-1230"><a href="#SymbolVisualizer2D-1230"><span class="linenos">1230</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1231"><a href="#SymbolVisualizer2D-1231"><span class="linenos">1231</span></a>            <span class="n">S_quant</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hbar</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1232"><a href="#SymbolVisualizer2D-1232"><span class="linenos">1232</span></a>            <span class="k">if</span> <span class="n">S_quant</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">S_orb</span><span class="p">)</span> <span class="k">if</span> <span class="n">S_orb</span> <span class="k">else</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1233"><a href="#SymbolVisualizer2D-1233"><span class="linenos">1233</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">S_quant</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1234"><a href="#SymbolVisualizer2D-1234"><span class="linenos">1234</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">E_orb</span><span class="p">)</span> <span class="k">if</span> <span class="n">E_orb</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S_quant</span><span class="p">,</span> 
</span><span id="SymbolVisualizer2D-1235"><a href="#SymbolVisualizer2D-1235"><span class="linenos">1235</span></a>                       <span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1236"><a href="#SymbolVisualizer2D-1236"><span class="linenos">1236</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy E&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1237"><a href="#SymbolVisualizer2D-1237"><span class="linenos">1237</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Action S&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1238"><a href="#SymbolVisualizer2D-1238"><span class="linenos">1238</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Torus Quantization</span><span class="se">\n</span><span class="s1">KAM theory&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1239"><a href="#SymbolVisualizer2D-1239"><span class="linenos">1239</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1240"><a href="#SymbolVisualizer2D-1240"><span class="linenos">1240</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1241"><a href="#SymbolVisualizer2D-1241"><span class="linenos">1241</span></a>    
</span><span id="SymbolVisualizer2D-1242"><a href="#SymbolVisualizer2D-1242"><span class="linenos">1242</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_level_spacing_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D-1243"><a href="#SymbolVisualizer2D-1243"><span class="linenos">1243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Level spacing distribution&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D-1244"><a href="#SymbolVisualizer2D-1244"><span class="linenos">1244</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">subplot_spec</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1245"><a href="#SymbolVisualizer2D-1245"><span class="linenos">1245</span></a>        <span class="c1"># Extract unique energies</span>
</span><span id="SymbolVisualizer2D-1246"><a href="#SymbolVisualizer2D-1246"><span class="linenos">1246</span></a>        <span class="n">energies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D-1247"><a href="#SymbolVisualizer2D-1247"><span class="linenos">1247</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D-1248"><a href="#SymbolVisualizer2D-1248"><span class="linenos">1248</span></a>            <span class="n">spacings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1249"><a href="#SymbolVisualizer2D-1249"><span class="linenos">1249</span></a>            <span class="c1"># Normalize</span>
</span><span id="SymbolVisualizer2D-1250"><a href="#SymbolVisualizer2D-1250"><span class="linenos">1250</span></a>            <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spacings</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1251"><a href="#SymbolVisualizer2D-1251"><span class="linenos">1251</span></a>            <span class="n">s_norm</span> <span class="o">=</span> <span class="n">spacings</span> <span class="o">/</span> <span class="n">s_mean</span>
</span><span id="SymbolVisualizer2D-1252"><a href="#SymbolVisualizer2D-1252"><span class="linenos">1252</span></a>            <span class="c1"># Histogram</span>
</span><span id="SymbolVisualizer2D-1253"><a href="#SymbolVisualizer2D-1253"><span class="linenos">1253</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">s_norm</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D-1254"><a href="#SymbolVisualizer2D-1254"><span class="linenos">1254</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1255"><a href="#SymbolVisualizer2D-1255"><span class="linenos">1255</span></a>            <span class="c1"># Theoretical curves</span>
</span><span id="SymbolVisualizer2D-1256"><a href="#SymbolVisualizer2D-1256"><span class="linenos">1256</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s_norm</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1257"><a href="#SymbolVisualizer2D-1257"><span class="linenos">1257</span></a>            <span class="c1"># Poisson (integrable systems)</span>
</span><span id="SymbolVisualizer2D-1258"><a href="#SymbolVisualizer2D-1258"><span class="linenos">1258</span></a>            <span class="n">poisson</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1259"><a href="#SymbolVisualizer2D-1259"><span class="linenos">1259</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">poisson</span><span class="p">,</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Poisson (Integrable)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1260"><a href="#SymbolVisualizer2D-1260"><span class="linenos">1260</span></a>            <span class="c1"># Wigner (chaotic systems)</span>
</span><span id="SymbolVisualizer2D-1261"><a href="#SymbolVisualizer2D-1261"><span class="linenos">1261</span></a>            <span class="n">wigner</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1262"><a href="#SymbolVisualizer2D-1262"><span class="linenos">1262</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">wigner</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wigner (Chaotic)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1263"><a href="#SymbolVisualizer2D-1263"><span class="linenos">1263</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Normalized spacing s&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1264"><a href="#SymbolVisualizer2D-1264"><span class="linenos">1264</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(s)&#39;</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1265"><a href="#SymbolVisualizer2D-1265"><span class="linenos">1265</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Level Spacing</span><span class="se">\n</span><span class="s1">Integrable vs Chaotic&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1266"><a href="#SymbolVisualizer2D-1266"><span class="linenos">1266</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D-1267"><a href="#SymbolVisualizer2D-1267"><span class="linenos">1267</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Complete visualization combining geometric and physical aspects</p>
</div>


                            <div id="SymbolVisualizer2D.__init__" class="classattr">
                                        <input id="SymbolVisualizer2D.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SymbolVisualizer2D</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">geometry</span><span class="p">:</span> <span class="n"><a href="#SymbolGeometry2D">SymbolGeometry2D</a></span></span>)</span>

                <label class="view-source-button" for="SymbolVisualizer2D.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolVisualizer2D.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolVisualizer2D.__init__-579"><a href="#SymbolVisualizer2D.__init__-579"><span class="linenos">579</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">SymbolGeometry2D</span><span class="p">):</span>
</span><span id="SymbolVisualizer2D.__init__-580"><a href="#SymbolVisualizer2D.__init__-580"><span class="linenos">580</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">geometry</span>
</span></pre></div>


    

                            </div>
                            <div id="SymbolVisualizer2D.geo" class="classattr">
                                <div class="attr variable">
            <span class="name">geo</span>

        
    </div>
    <a class="headerlink" href="#SymbolVisualizer2D.geo"></a>
    
    

                            </div>
                            <div id="SymbolVisualizer2D.visualize_complete" class="classattr">
                                        <input id="SymbolVisualizer2D.visualize_complete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_complete</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">y_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">eta_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">geodesics_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span>,</span><span class="param">	<span class="n">E_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span></span><span class="return-annotation">) -> <span class="n">Tuple</span>:</span></span>

                <label class="view-source-button" for="SymbolVisualizer2D.visualize_complete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SymbolVisualizer2D.visualize_complete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SymbolVisualizer2D.visualize_complete-582"><a href="#SymbolVisualizer2D.visualize_complete-582"><span class="linenos">582</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D.visualize_complete-583"><a href="#SymbolVisualizer2D.visualize_complete-583"><span class="linenos">583</span></a>                          <span class="n">x_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D.visualize_complete-584"><a href="#SymbolVisualizer2D.visualize_complete-584"><span class="linenos">584</span></a>                          <span class="n">y_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D.visualize_complete-585"><a href="#SymbolVisualizer2D.visualize_complete-585"><span class="linenos">585</span></a>                          <span class="n">xi_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D.visualize_complete-586"><a href="#SymbolVisualizer2D.visualize_complete-586"><span class="linenos">586</span></a>                          <span class="n">eta_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D.visualize_complete-587"><a href="#SymbolVisualizer2D.visualize_complete-587"><span class="linenos">587</span></a>                          <span class="n">geodesics_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span>
</span><span id="SymbolVisualizer2D.visualize_complete-588"><a href="#SymbolVisualizer2D.visualize_complete-588"><span class="linenos">588</span></a>                          <span class="n">E_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D.visualize_complete-589"><a href="#SymbolVisualizer2D.visualize_complete-589"><span class="linenos">589</span></a>                          <span class="n">hbar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D.visualize_complete-590"><a href="#SymbolVisualizer2D.visualize_complete-590"><span class="linenos">590</span></a>                          <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D.visualize_complete-591"><a href="#SymbolVisualizer2D.visualize_complete-591"><span class="linenos">591</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D.visualize_complete-592"><a href="#SymbolVisualizer2D.visualize_complete-592"><span class="linenos">592</span></a><span class="sd">        Create a complete 18-panel visualization combining geometry and physics</span>
</span><span id="SymbolVisualizer2D.visualize_complete-593"><a href="#SymbolVisualizer2D.visualize_complete-593"><span class="linenos">593</span></a><span class="sd">        Parameters</span>
</span><span id="SymbolVisualizer2D.visualize_complete-594"><a href="#SymbolVisualizer2D.visualize_complete-594"><span class="linenos">594</span></a><span class="sd">        ----------</span>
</span><span id="SymbolVisualizer2D.visualize_complete-595"><a href="#SymbolVisualizer2D.visualize_complete-595"><span class="linenos">595</span></a><span class="sd">        x_range, y_range : tuple</span>
</span><span id="SymbolVisualizer2D.visualize_complete-596"><a href="#SymbolVisualizer2D.visualize_complete-596"><span class="linenos">596</span></a><span class="sd">            Configuration space domain</span>
</span><span id="SymbolVisualizer2D.visualize_complete-597"><a href="#SymbolVisualizer2D.visualize_complete-597"><span class="linenos">597</span></a><span class="sd">        xi_range, eta_range : tuple</span>
</span><span id="SymbolVisualizer2D.visualize_complete-598"><a href="#SymbolVisualizer2D.visualize_complete-598"><span class="linenos">598</span></a><span class="sd">            Momentum space domain</span>
</span><span id="SymbolVisualizer2D.visualize_complete-599"><a href="#SymbolVisualizer2D.visualize_complete-599"><span class="linenos">599</span></a><span class="sd">        geodesics_params : list</span>
</span><span id="SymbolVisualizer2D.visualize_complete-600"><a href="#SymbolVisualizer2D.visualize_complete-600"><span class="linenos">600</span></a><span class="sd">            Geodesic parameters: (x0, y0, xi0, eta0, t_max, color)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-601"><a href="#SymbolVisualizer2D.visualize_complete-601"><span class="linenos">601</span></a><span class="sd">        E_range : tuple, optional</span>
</span><span id="SymbolVisualizer2D.visualize_complete-602"><a href="#SymbolVisualizer2D.visualize_complete-602"><span class="linenos">602</span></a><span class="sd">            Energy interval for spectral analysis</span>
</span><span id="SymbolVisualizer2D.visualize_complete-603"><a href="#SymbolVisualizer2D.visualize_complete-603"><span class="linenos">603</span></a><span class="sd">        hbar : float</span>
</span><span id="SymbolVisualizer2D.visualize_complete-604"><a href="#SymbolVisualizer2D.visualize_complete-604"><span class="linenos">604</span></a><span class="sd">            Reduced Planck constant</span>
</span><span id="SymbolVisualizer2D.visualize_complete-605"><a href="#SymbolVisualizer2D.visualize_complete-605"><span class="linenos">605</span></a><span class="sd">        resolution : int</span>
</span><span id="SymbolVisualizer2D.visualize_complete-606"><a href="#SymbolVisualizer2D.visualize_complete-606"><span class="linenos">606</span></a><span class="sd">            Grid resolution</span>
</span><span id="SymbolVisualizer2D.visualize_complete-607"><a href="#SymbolVisualizer2D.visualize_complete-607"><span class="linenos">607</span></a><span class="sd">        Returns</span>
</span><span id="SymbolVisualizer2D.visualize_complete-608"><a href="#SymbolVisualizer2D.visualize_complete-608"><span class="linenos">608</span></a><span class="sd">        -------</span>
</span><span id="SymbolVisualizer2D.visualize_complete-609"><a href="#SymbolVisualizer2D.visualize_complete-609"><span class="linenos">609</span></a><span class="sd">        fig, geodesics, periodic_orbits, caustics</span>
</span><span id="SymbolVisualizer2D.visualize_complete-610"><a href="#SymbolVisualizer2D.visualize_complete-610"><span class="linenos">610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SymbolVisualizer2D.visualize_complete-611"><a href="#SymbolVisualizer2D.visualize_complete-611"><span class="linenos">611</span></a>        <span class="c1"># Compute geodesics with caustic detection</span>
</span><span id="SymbolVisualizer2D.visualize_complete-612"><a href="#SymbolVisualizer2D.visualize_complete-612"><span class="linenos">612</span></a>        <span class="n">geodesics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesics</span><span class="p">(</span><span class="n">geodesics_params</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-613"><a href="#SymbolVisualizer2D.visualize_complete-613"><span class="linenos">613</span></a>        <span class="c1"># Search for periodic orbits</span>
</span><span id="SymbolVisualizer2D.visualize_complete-614"><a href="#SymbolVisualizer2D.visualize_complete-614"><span class="linenos">614</span></a>        <span class="n">periodic_orbits</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D.visualize_complete-615"><a href="#SymbolVisualizer2D.visualize_complete-615"><span class="linenos">615</span></a>        <span class="k">if</span> <span class="n">E_range</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D.visualize_complete-616"><a href="#SymbolVisualizer2D.visualize_complete-616"><span class="linenos">616</span></a>            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">E_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-617"><a href="#SymbolVisualizer2D.visualize_complete-617"><span class="linenos">617</span></a>            <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D.visualize_complete-618"><a href="#SymbolVisualizer2D.visualize_complete-618"><span class="linenos">618</span></a>                <span class="n">orbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">find_periodic_orbits_2d</span><span class="p">(</span>
</span><span id="SymbolVisualizer2D.visualize_complete-619"><a href="#SymbolVisualizer2D.visualize_complete-619"><span class="linenos">619</span></a>                    <span class="n">E</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">,</span> <span class="n">n_attempts</span><span class="o">=</span><span class="mi">20</span>
</span><span id="SymbolVisualizer2D.visualize_complete-620"><a href="#SymbolVisualizer2D.visualize_complete-620"><span class="linenos">620</span></a>                <span class="p">)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-621"><a href="#SymbolVisualizer2D.visualize_complete-621"><span class="linenos">621</span></a>                <span class="n">periodic_orbits</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orbits</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-622"><a href="#SymbolVisualizer2D.visualize_complete-622"><span class="linenos">622</span></a>        <span class="c1"># Detect caustic structures</span>
</span><span id="SymbolVisualizer2D.visualize_complete-623"><a href="#SymbolVisualizer2D.visualize_complete-623"><span class="linenos">623</span></a>        <span class="n">caustics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SymbolVisualizer2D.visualize_complete-624"><a href="#SymbolVisualizer2D.visualize_complete-624"><span class="linenos">624</span></a>        <span class="k">if</span> <span class="n">geodesics</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D.visualize_complete-625"><a href="#SymbolVisualizer2D.visualize_complete-625"><span class="linenos">625</span></a>            <span class="n">t_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-626"><a href="#SymbolVisualizer2D.visualize_complete-626"><span class="linenos">626</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_samples</span><span class="p">:</span>
</span><span id="SymbolVisualizer2D.visualize_complete-627"><a href="#SymbolVisualizer2D.visualize_complete-627"><span class="linenos">627</span></a>                <span class="n">caustics</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">detect_caustic_structures</span><span class="p">(</span><span class="n">geodesics</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span id="SymbolVisualizer2D.visualize_complete-628"><a href="#SymbolVisualizer2D.visualize_complete-628"><span class="linenos">628</span></a>        <span class="c1"># Create full figure</span>
</span><span id="SymbolVisualizer2D.visualize_complete-629"><a href="#SymbolVisualizer2D.visualize_complete-629"><span class="linenos">629</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_complete_figure</span><span class="p">(</span>
</span><span id="SymbolVisualizer2D.visualize_complete-630"><a href="#SymbolVisualizer2D.visualize_complete-630"><span class="linenos">630</span></a>            <span class="n">E_range</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">xi_range</span><span class="p">,</span> <span class="n">eta_range</span><span class="p">,</span>
</span><span id="SymbolVisualizer2D.visualize_complete-631"><a href="#SymbolVisualizer2D.visualize_complete-631"><span class="linenos">631</span></a>            <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">caustics</span><span class="p">,</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">resolution</span>
</span><span id="SymbolVisualizer2D.visualize_complete-632"><a href="#SymbolVisualizer2D.visualize_complete-632"><span class="linenos">632</span></a>        <span class="p">)</span>
</span><span id="SymbolVisualizer2D.visualize_complete-633"><a href="#SymbolVisualizer2D.visualize_complete-633"><span class="linenos">633</span></a>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">geodesics</span><span class="p">,</span> <span class="n">periodic_orbits</span><span class="p">,</span> <span class="n">caustics</span>
</span></pre></div>


            <div class="docstring"><p>Create a complete 18-panel visualization combining geometry and physics</p>

<h2 id="parameters">Parameters</h2>

<p>x_range, y_range : tuple
    Configuration space domain
xi_range, eta_range : tuple
    Momentum space domain
geodesics_params : list
    Geodesic parameters: (x0, y0, xi0, eta0, t_max, color)
E_range : tuple, optional
    Energy interval for spectral analysis
hbar : float
    Reduced Planck constant
resolution : int
    Grid resolution</p>

<h2 id="returns">Returns</h2>

<p>fig, geodesics, periodic_orbits, caustics</p>
</div>


                            </div>
                </section>
                <section id="Utilities2D">
                            <input id="Utilities2D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Utilities2D</span>:

                <label class="view-source-button" for="Utilities2D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Utilities2D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Utilities2D-1356"><a href="#Utilities2D-1356"><span class="linenos">1356</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Utilities2D</span><span class="p">:</span>
</span><span id="Utilities2D-1357"><a href="#Utilities2D-1357"><span class="linenos">1357</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Additional analysis tools for 2D systems&quot;&quot;&quot;</span>
</span><span id="Utilities2D-1358"><a href="#Utilities2D-1358"><span class="linenos">1358</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Utilities2D-1359"><a href="#Utilities2D-1359"><span class="linenos">1359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_winding_number</span><span class="p">(</span><span class="n">geo</span><span class="p">:</span> <span class="n">Geodesic2D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Utilities2D-1360"><a href="#Utilities2D-1360"><span class="linenos">1360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Utilities2D-1361"><a href="#Utilities2D-1361"><span class="linenos">1361</span></a><span class="sd">        Compute winding number around origin</span>
</span><span id="Utilities2D-1362"><a href="#Utilities2D-1362"><span class="linenos">1362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Utilities2D-1363"><a href="#Utilities2D-1363"><span class="linenos">1363</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Utilities2D-1364"><a href="#Utilities2D-1364"><span class="linenos">1364</span></a>        <span class="n">angles_unwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
</span><span id="Utilities2D-1365"><a href="#Utilities2D-1365"><span class="linenos">1365</span></a>        <span class="n">winding</span> <span class="o">=</span> <span class="p">(</span><span class="n">angles_unwrapped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">angles_unwrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="Utilities2D-1366"><a href="#Utilities2D-1366"><span class="linenos">1366</span></a>        <span class="k">return</span> <span class="n">winding</span>
</span><span id="Utilities2D-1367"><a href="#Utilities2D-1367"><span class="linenos">1367</span></a>
</span><span id="Utilities2D-1368"><a href="#Utilities2D-1368"><span class="linenos">1368</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Utilities2D-1369"><a href="#Utilities2D-1369"><span class="linenos">1369</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_rotation_numbers</span><span class="p">(</span><span class="n">geo</span><span class="p">:</span> <span class="n">Geodesic2D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Utilities2D-1370"><a href="#Utilities2D-1370"><span class="linenos">1370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Utilities2D-1371"><a href="#Utilities2D-1371"><span class="linenos">1371</span></a><span class="sd">        Compute rotation numbers (ω_x, ω_y)</span>
</span><span id="Utilities2D-1372"><a href="#Utilities2D-1372"><span class="linenos">1372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Utilities2D-1373"><a href="#Utilities2D-1373"><span class="linenos">1373</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Utilities2D-1374"><a href="#Utilities2D-1374"><span class="linenos">1374</span></a>        <span class="n">theta_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Utilities2D-1375"><a href="#Utilities2D-1375"><span class="linenos">1375</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">theta_x</span><span class="p">)</span>
</span><span id="Utilities2D-1376"><a href="#Utilities2D-1376"><span class="linenos">1376</span></a>        <span class="n">theta_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">theta_y</span><span class="p">)</span>
</span><span id="Utilities2D-1377"><a href="#Utilities2D-1377"><span class="linenos">1377</span></a>        <span class="n">omega_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Utilities2D-1378"><a href="#Utilities2D-1378"><span class="linenos">1378</span></a>        <span class="n">omega_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Utilities2D-1379"><a href="#Utilities2D-1379"><span class="linenos">1379</span></a>        <span class="k">return</span> <span class="n">omega_x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">omega_y</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="Utilities2D-1380"><a href="#Utilities2D-1380"><span class="linenos">1380</span></a>    
</span><span id="Utilities2D-1381"><a href="#Utilities2D-1381"><span class="linenos">1381</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Utilities2D-1382"><a href="#Utilities2D-1382"><span class="linenos">1382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detect_kam_tori</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit2D</span><span class="p">],</span>
</span><span id="Utilities2D-1383"><a href="#Utilities2D-1383"><span class="linenos">1383</span></a>                       <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Utilities2D-1384"><a href="#Utilities2D-1384"><span class="linenos">1384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Utilities2D-1385"><a href="#Utilities2D-1385"><span class="linenos">1385</span></a><span class="sd">        Detect KAM tori from periodic orbits</span>
</span><span id="Utilities2D-1386"><a href="#Utilities2D-1386"><span class="linenos">1386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Utilities2D-1387"><a href="#Utilities2D-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="Utilities2D-1388"><a href="#Utilities2D-1388"><span class="linenos">1388</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;n_tori&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;tori&#39;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="Utilities2D-1389"><a href="#Utilities2D-1389"><span class="linenos">1389</span></a>        <span class="n">actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">])</span>
</span><span id="Utilities2D-1390"><a href="#Utilities2D-1390"><span class="linenos">1390</span></a>        <span class="c1"># Cluster by action</span>
</span><span id="Utilities2D-1391"><a href="#Utilities2D-1391"><span class="linenos">1391</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Utilities2D-1392"><a href="#Utilities2D-1392"><span class="linenos">1392</span></a>            <span class="n">Z</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
</span><span id="Utilities2D-1393"><a href="#Utilities2D-1393"><span class="linenos">1393</span></a>            <span class="n">clusters</span> <span class="o">=</span> <span class="n">fcluster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
</span><span id="Utilities2D-1394"><a href="#Utilities2D-1394"><span class="linenos">1394</span></a>            <span class="n">n_tori</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>
</span><span id="Utilities2D-1395"><a href="#Utilities2D-1395"><span class="linenos">1395</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Utilities2D-1396"><a href="#Utilities2D-1396"><span class="linenos">1396</span></a>            <span class="n">n_tori</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Utilities2D-1397"><a href="#Utilities2D-1397"><span class="linenos">1397</span></a>            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Utilities2D-1398"><a href="#Utilities2D-1398"><span class="linenos">1398</span></a>        <span class="c1"># Analyze each torus</span>
</span><span id="Utilities2D-1399"><a href="#Utilities2D-1399"><span class="linenos">1399</span></a>        <span class="n">tori</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Utilities2D-1400"><a href="#Utilities2D-1400"><span class="linenos">1400</span></a>        <span class="k">for</span> <span class="n">torus_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
</span><span id="Utilities2D-1401"><a href="#Utilities2D-1401"><span class="linenos">1401</span></a>            <span class="n">orbits_in_torus</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">)</span> 
</span><span id="Utilities2D-1402"><a href="#Utilities2D-1402"><span class="linenos">1402</span></a>                              <span class="k">if</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">torus_id</span><span class="p">]</span>
</span><span id="Utilities2D-1403"><a href="#Utilities2D-1403"><span class="linenos">1403</span></a>            <span class="n">mean_action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">])</span>
</span><span id="Utilities2D-1404"><a href="#Utilities2D-1404"><span class="linenos">1404</span></a>            <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">])</span>
</span><span id="Utilities2D-1405"><a href="#Utilities2D-1405"><span class="linenos">1405</span></a>            <span class="n">mean_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">])</span>
</span><span id="Utilities2D-1406"><a href="#Utilities2D-1406"><span class="linenos">1406</span></a>            <span class="n">stabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">stability_1</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">]</span>
</span><span id="Utilities2D-1407"><a href="#Utilities2D-1407"><span class="linenos">1407</span></a>            <span class="n">is_stable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stabilities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="Utilities2D-1408"><a href="#Utilities2D-1408"><span class="linenos">1408</span></a>            <span class="n">tori</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Utilities2D-1409"><a href="#Utilities2D-1409"><span class="linenos">1409</span></a>                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">torus_id</span><span class="p">),</span>
</span><span id="Utilities2D-1410"><a href="#Utilities2D-1410"><span class="linenos">1410</span></a>                <span class="s1">&#39;n_orbits&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbits_in_torus</span><span class="p">),</span>
</span><span id="Utilities2D-1411"><a href="#Utilities2D-1411"><span class="linenos">1411</span></a>                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">mean_action</span><span class="p">,</span>
</span><span id="Utilities2D-1412"><a href="#Utilities2D-1412"><span class="linenos">1412</span></a>                <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">mean_energy</span><span class="p">,</span>
</span><span id="Utilities2D-1413"><a href="#Utilities2D-1413"><span class="linenos">1413</span></a>                <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">mean_period</span><span class="p">,</span>
</span><span id="Utilities2D-1414"><a href="#Utilities2D-1414"><span class="linenos">1414</span></a>                <span class="s1">&#39;stable&#39;</span><span class="p">:</span> <span class="n">is_stable</span>
</span><span id="Utilities2D-1415"><a href="#Utilities2D-1415"><span class="linenos">1415</span></a>            <span class="p">})</span>
</span><span id="Utilities2D-1416"><a href="#Utilities2D-1416"><span class="linenos">1416</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Utilities2D-1417"><a href="#Utilities2D-1417"><span class="linenos">1417</span></a>            <span class="s1">&#39;n_tori&#39;</span><span class="p">:</span> <span class="n">n_tori</span><span class="p">,</span>
</span><span id="Utilities2D-1418"><a href="#Utilities2D-1418"><span class="linenos">1418</span></a>            <span class="s1">&#39;tori&#39;</span><span class="p">:</span> <span class="n">tori</span>
</span><span id="Utilities2D-1419"><a href="#Utilities2D-1419"><span class="linenos">1419</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Additional analysis tools for 2D systems</p>
</div>


                            <div id="Utilities2D.compute_winding_number" class="classattr">
                                        <input id="Utilities2D.compute_winding_number-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_winding_number</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">geo</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">Geodesic2D</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Utilities2D.compute_winding_number-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Utilities2D.compute_winding_number"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Utilities2D.compute_winding_number-1358"><a href="#Utilities2D.compute_winding_number-1358"><span class="linenos">1358</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Utilities2D.compute_winding_number-1359"><a href="#Utilities2D.compute_winding_number-1359"><span class="linenos">1359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_winding_number</span><span class="p">(</span><span class="n">geo</span><span class="p">:</span> <span class="n">Geodesic2D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Utilities2D.compute_winding_number-1360"><a href="#Utilities2D.compute_winding_number-1360"><span class="linenos">1360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Utilities2D.compute_winding_number-1361"><a href="#Utilities2D.compute_winding_number-1361"><span class="linenos">1361</span></a><span class="sd">        Compute winding number around origin</span>
</span><span id="Utilities2D.compute_winding_number-1362"><a href="#Utilities2D.compute_winding_number-1362"><span class="linenos">1362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Utilities2D.compute_winding_number-1363"><a href="#Utilities2D.compute_winding_number-1363"><span class="linenos">1363</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Utilities2D.compute_winding_number-1364"><a href="#Utilities2D.compute_winding_number-1364"><span class="linenos">1364</span></a>        <span class="n">angles_unwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
</span><span id="Utilities2D.compute_winding_number-1365"><a href="#Utilities2D.compute_winding_number-1365"><span class="linenos">1365</span></a>        <span class="n">winding</span> <span class="o">=</span> <span class="p">(</span><span class="n">angles_unwrapped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">angles_unwrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="Utilities2D.compute_winding_number-1366"><a href="#Utilities2D.compute_winding_number-1366"><span class="linenos">1366</span></a>        <span class="k">return</span> <span class="n">winding</span>
</span></pre></div>


            <div class="docstring"><p>Compute winding number around origin</p>
</div>


                            </div>
                            <div id="Utilities2D.compute_rotation_numbers" class="classattr">
                                        <input id="Utilities2D.compute_rotation_numbers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_rotation_numbers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">geo</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">Geodesic2D</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Utilities2D.compute_rotation_numbers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Utilities2D.compute_rotation_numbers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Utilities2D.compute_rotation_numbers-1368"><a href="#Utilities2D.compute_rotation_numbers-1368"><span class="linenos">1368</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Utilities2D.compute_rotation_numbers-1369"><a href="#Utilities2D.compute_rotation_numbers-1369"><span class="linenos">1369</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_rotation_numbers</span><span class="p">(</span><span class="n">geo</span><span class="p">:</span> <span class="n">Geodesic2D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Utilities2D.compute_rotation_numbers-1370"><a href="#Utilities2D.compute_rotation_numbers-1370"><span class="linenos">1370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Utilities2D.compute_rotation_numbers-1371"><a href="#Utilities2D.compute_rotation_numbers-1371"><span class="linenos">1371</span></a><span class="sd">        Compute rotation numbers (ω_x, ω_y)</span>
</span><span id="Utilities2D.compute_rotation_numbers-1372"><a href="#Utilities2D.compute_rotation_numbers-1372"><span class="linenos">1372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Utilities2D.compute_rotation_numbers-1373"><a href="#Utilities2D.compute_rotation_numbers-1373"><span class="linenos">1373</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span id="Utilities2D.compute_rotation_numbers-1374"><a href="#Utilities2D.compute_rotation_numbers-1374"><span class="linenos">1374</span></a>        <span class="n">theta_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Utilities2D.compute_rotation_numbers-1375"><a href="#Utilities2D.compute_rotation_numbers-1375"><span class="linenos">1375</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">theta_x</span><span class="p">)</span>
</span><span id="Utilities2D.compute_rotation_numbers-1376"><a href="#Utilities2D.compute_rotation_numbers-1376"><span class="linenos">1376</span></a>        <span class="n">theta_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">theta_y</span><span class="p">)</span>
</span><span id="Utilities2D.compute_rotation_numbers-1377"><a href="#Utilities2D.compute_rotation_numbers-1377"><span class="linenos">1377</span></a>        <span class="n">omega_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Utilities2D.compute_rotation_numbers-1378"><a href="#Utilities2D.compute_rotation_numbers-1378"><span class="linenos">1378</span></a>        <span class="n">omega_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Utilities2D.compute_rotation_numbers-1379"><a href="#Utilities2D.compute_rotation_numbers-1379"><span class="linenos">1379</span></a>        <span class="k">return</span> <span class="n">omega_x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">omega_y</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute rotation numbers (ω_x, ω_y)</p>
</div>


                            </div>
                            <div id="Utilities2D.detect_kam_tori" class="classattr">
                                        <input id="Utilities2D.detect_kam_tori-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">detect_kam_tori</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">geometry_2d</span><span class="o">.</span><span class="n">PeriodicOrbit2D</span><span class="p">]</span>,</span><span class="param">	<span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="Utilities2D.detect_kam_tori-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Utilities2D.detect_kam_tori"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Utilities2D.detect_kam_tori-1381"><a href="#Utilities2D.detect_kam_tori-1381"><span class="linenos">1381</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Utilities2D.detect_kam_tori-1382"><a href="#Utilities2D.detect_kam_tori-1382"><span class="linenos">1382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detect_kam_tori</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PeriodicOrbit2D</span><span class="p">],</span>
</span><span id="Utilities2D.detect_kam_tori-1383"><a href="#Utilities2D.detect_kam_tori-1383"><span class="linenos">1383</span></a>                       <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Utilities2D.detect_kam_tori-1384"><a href="#Utilities2D.detect_kam_tori-1384"><span class="linenos">1384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Utilities2D.detect_kam_tori-1385"><a href="#Utilities2D.detect_kam_tori-1385"><span class="linenos">1385</span></a><span class="sd">        Detect KAM tori from periodic orbits</span>
</span><span id="Utilities2D.detect_kam_tori-1386"><a href="#Utilities2D.detect_kam_tori-1386"><span class="linenos">1386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Utilities2D.detect_kam_tori-1387"><a href="#Utilities2D.detect_kam_tori-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">periodic_orbits</span><span class="p">:</span>
</span><span id="Utilities2D.detect_kam_tori-1388"><a href="#Utilities2D.detect_kam_tori-1388"><span class="linenos">1388</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;n_tori&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;tori&#39;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="Utilities2D.detect_kam_tori-1389"><a href="#Utilities2D.detect_kam_tori-1389"><span class="linenos">1389</span></a>        <span class="n">actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">periodic_orbits</span><span class="p">])</span>
</span><span id="Utilities2D.detect_kam_tori-1390"><a href="#Utilities2D.detect_kam_tori-1390"><span class="linenos">1390</span></a>        <span class="c1"># Cluster by action</span>
</span><span id="Utilities2D.detect_kam_tori-1391"><a href="#Utilities2D.detect_kam_tori-1391"><span class="linenos">1391</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Utilities2D.detect_kam_tori-1392"><a href="#Utilities2D.detect_kam_tori-1392"><span class="linenos">1392</span></a>            <span class="n">Z</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
</span><span id="Utilities2D.detect_kam_tori-1393"><a href="#Utilities2D.detect_kam_tori-1393"><span class="linenos">1393</span></a>            <span class="n">clusters</span> <span class="o">=</span> <span class="n">fcluster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
</span><span id="Utilities2D.detect_kam_tori-1394"><a href="#Utilities2D.detect_kam_tori-1394"><span class="linenos">1394</span></a>            <span class="n">n_tori</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>
</span><span id="Utilities2D.detect_kam_tori-1395"><a href="#Utilities2D.detect_kam_tori-1395"><span class="linenos">1395</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Utilities2D.detect_kam_tori-1396"><a href="#Utilities2D.detect_kam_tori-1396"><span class="linenos">1396</span></a>            <span class="n">n_tori</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Utilities2D.detect_kam_tori-1397"><a href="#Utilities2D.detect_kam_tori-1397"><span class="linenos">1397</span></a>            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Utilities2D.detect_kam_tori-1398"><a href="#Utilities2D.detect_kam_tori-1398"><span class="linenos">1398</span></a>        <span class="c1"># Analyze each torus</span>
</span><span id="Utilities2D.detect_kam_tori-1399"><a href="#Utilities2D.detect_kam_tori-1399"><span class="linenos">1399</span></a>        <span class="n">tori</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Utilities2D.detect_kam_tori-1400"><a href="#Utilities2D.detect_kam_tori-1400"><span class="linenos">1400</span></a>        <span class="k">for</span> <span class="n">torus_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
</span><span id="Utilities2D.detect_kam_tori-1401"><a href="#Utilities2D.detect_kam_tori-1401"><span class="linenos">1401</span></a>            <span class="n">orbits_in_torus</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">periodic_orbits</span><span class="p">)</span> 
</span><span id="Utilities2D.detect_kam_tori-1402"><a href="#Utilities2D.detect_kam_tori-1402"><span class="linenos">1402</span></a>                              <span class="k">if</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">torus_id</span><span class="p">]</span>
</span><span id="Utilities2D.detect_kam_tori-1403"><a href="#Utilities2D.detect_kam_tori-1403"><span class="linenos">1403</span></a>            <span class="n">mean_action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">action</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">])</span>
</span><span id="Utilities2D.detect_kam_tori-1404"><a href="#Utilities2D.detect_kam_tori-1404"><span class="linenos">1404</span></a>            <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">])</span>
</span><span id="Utilities2D.detect_kam_tori-1405"><a href="#Utilities2D.detect_kam_tori-1405"><span class="linenos">1405</span></a>            <span class="n">mean_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">orb</span><span class="o">.</span><span class="n">period</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">])</span>
</span><span id="Utilities2D.detect_kam_tori-1406"><a href="#Utilities2D.detect_kam_tori-1406"><span class="linenos">1406</span></a>            <span class="n">stabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span><span class="o">.</span><span class="n">stability_1</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbits_in_torus</span><span class="p">]</span>
</span><span id="Utilities2D.detect_kam_tori-1407"><a href="#Utilities2D.detect_kam_tori-1407"><span class="linenos">1407</span></a>            <span class="n">is_stable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stabilities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="Utilities2D.detect_kam_tori-1408"><a href="#Utilities2D.detect_kam_tori-1408"><span class="linenos">1408</span></a>            <span class="n">tori</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Utilities2D.detect_kam_tori-1409"><a href="#Utilities2D.detect_kam_tori-1409"><span class="linenos">1409</span></a>                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">torus_id</span><span class="p">),</span>
</span><span id="Utilities2D.detect_kam_tori-1410"><a href="#Utilities2D.detect_kam_tori-1410"><span class="linenos">1410</span></a>                <span class="s1">&#39;n_orbits&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbits_in_torus</span><span class="p">),</span>
</span><span id="Utilities2D.detect_kam_tori-1411"><a href="#Utilities2D.detect_kam_tori-1411"><span class="linenos">1411</span></a>                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">mean_action</span><span class="p">,</span>
</span><span id="Utilities2D.detect_kam_tori-1412"><a href="#Utilities2D.detect_kam_tori-1412"><span class="linenos">1412</span></a>                <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">mean_energy</span><span class="p">,</span>
</span><span id="Utilities2D.detect_kam_tori-1413"><a href="#Utilities2D.detect_kam_tori-1413"><span class="linenos">1413</span></a>                <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">mean_period</span><span class="p">,</span>
</span><span id="Utilities2D.detect_kam_tori-1414"><a href="#Utilities2D.detect_kam_tori-1414"><span class="linenos">1414</span></a>                <span class="s1">&#39;stable&#39;</span><span class="p">:</span> <span class="n">is_stable</span>
</span><span id="Utilities2D.detect_kam_tori-1415"><a href="#Utilities2D.detect_kam_tori-1415"><span class="linenos">1415</span></a>            <span class="p">})</span>
</span><span id="Utilities2D.detect_kam_tori-1416"><a href="#Utilities2D.detect_kam_tori-1416"><span class="linenos">1416</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Utilities2D.detect_kam_tori-1417"><a href="#Utilities2D.detect_kam_tori-1417"><span class="linenos">1417</span></a>            <span class="s1">&#39;n_tori&#39;</span><span class="p">:</span> <span class="n">n_tori</span><span class="p">,</span>
</span><span id="Utilities2D.detect_kam_tori-1418"><a href="#Utilities2D.detect_kam_tori-1418"><span class="linenos">1418</span></a>            <span class="s1">&#39;tori&#39;</span><span class="p">:</span> <span class="n">tori</span>
</span><span id="Utilities2D.detect_kam_tori-1419"><a href="#Utilities2D.detect_kam_tori-1419"><span class="linenos">1419</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Detect KAM tori from periodic orbits</p>
</div>


                            </div>
                </section>
    </main>
</body>
</html>